{% extends "admin_base.html" %}

{% block title %}ç”¨æˆ·ç®¡ç†{% endblock %}

{% block head %}
<style>
    .container { background:#fff; padding:24px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
    h1 { font-size: 22px; margin: 0; }
    .toolbar { display:flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
    .toolbar-left { display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }
    .toolbar-right { display:flex; align-items:center; gap: 8px; flex-wrap: wrap; }
    input[type="text"], input[type="password"], select { padding: 8px 10px; border:1px solid var(--border-color); border-radius:6px; font-size:14px; }
    
    /* æœç´¢æ¡†ä¼˜åŒ– */
    .search-box {
        position: relative;
        display: inline-block;
    }
    .search-box input {
        padding-left: 32px;
        width: 200px;
        transition: width 0.3s, border-color 0.3s;
    }
    .search-box input:focus {
        width: 250px;
        border-color: #0b61d8;
        outline: none;
    }
    .search-icon {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        pointer-events: none;
    }
    
    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-cards {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    .stat-card {
        flex: 1;
        min-width: 150px;
        padding: 12px 16px;
        border-radius: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .stat-card.online {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    .stat-card.admin {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    .stat-card.locked {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    .stat-card-label {
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 4px;
    }
    .stat-card-value {
        font-size: 24px;
        font-weight: bold;
    }
    
    /* è¡¨æ ¼ä¼˜åŒ– */
    table { width:100%; border-collapse:collapse; }
    th, td { padding: 12px; border-bottom:1px solid var(--border-color); text-align:left; }
    thead th { 
        background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
        font-weight:600;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    tbody tr {
        transition: background-color 0.2s;
    }
    tbody tr:hover {
        background-color: #f8f9fa;
    }
    .actions { display:flex; gap: 6px; flex-wrap: wrap; align-items: center; }
    .muted { color:#666; font-size: 12px; }
    .tag { display:inline-block; padding:3px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .tag-admin { background:#e7f1ff; color:#0b61d8; border: 1px solid #b3d9ff; }
    .tag-locked { background:#fde2e1; color:#c62828; border: 1px solid #f5c6cb; }
    .tag-user { background:#e8f5e9; color:#2e7d32; border: 1px solid #c8e6c9; }
    
    /* åœ¨çº¿çŠ¶æ€æ ·å¼ä¼˜åŒ– */
    .online-status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 12px;
        border-radius: 14px;
        font-size: 12px;
        font-weight: 600;
    }
    .online-status.online {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .online-status.offline {
        background: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }
    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }
    .status-dot.online {
        background: #28a745;
        box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
        animation: pulse 2s ease-in-out infinite;
    }
    .status-dot.offline {
        background: #6c757d;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(0.95); }
    }
    .last-active {
        font-size: 11px;
        color: #6c757d;
        margin-top: 2px;
    }
    
    /* æŒ‰é’®ä¼˜åŒ– */
    .btn-sm {
        padding: 4px 10px;
        font-size: 12px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-sm:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn-view { background: #e3f2fd; color: #1976d2; }
    .btn-view:hover { background: #bbdefb; }
    .btn-edit { background: #fff3e0; color: #f57c00; }
    .btn-edit:hover { background: #ffe0b2; }
    .btn-lock { background: #fce4ec; color: #c2185b; }
    .btn-lock:hover { background: #f8bbd0; }
    .btn-unlock { background: #e8f5e9; color: #388e3c; }
    .btn-unlock:hover { background: #c8e6c9; }
    .btn-admin { background: #f3e5f5; color: #7b1fa2; }
    .btn-admin:hover { background: #e1bee7; }
    .btn-logout { background: #fff9c4; color: #f57f17; }
    .btn-logout:hover { background: #fff59d; }
    .btn-delete { background: #ffebee; color: #c62828; }
    .btn-delete:hover { background: #ffcdd2; }
    
    /* å¼¹çª—ä¼˜åŒ– */
    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.2s;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .modal-content {
        background: #fff;
        padding: 24px;
        border-radius: 12px;
        width: 400px;
        max-width: 90vw;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        animation: slideUp 0.3s;
    }
    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .modal-content h3 {
        margin: 0 0 16px;
        font-size: 18px;
        color: #333;
    }
    .form-group {
        margin-bottom: 12px;
    }
    .form-group label {
        display: block;
        margin-bottom: 4px;
        font-size: 13px;
        color: #555;
        font-weight: 500;
    }
    .form-group input[type="text"],
    .form-group input[type="password"] {
        width: 100%;
        box-sizing: border-box;
    }
    .form-actions {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    /* ç­›é€‰å™¨æ ·å¼ */
    .filter-group {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    .filter-label {
        font-size: 13px;
        color: #666;
        font-weight: 500;
    }
    
    /* åˆ†é¡µä¼˜åŒ– */
    .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
    }
    .page-jump {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    .page-jump input {
        width: 60px;
        text-align: center;
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .loading {
        text-align: center;
        padding: 40px;
        color: #999;
    }
    .loading::after {
        content: '...';
        animation: dots 1.5s steps(4, end) infinite;
    }
    @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60%, 100% { content: '...'; }
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }
    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <!-- ç»Ÿè®¡å¡ç‰‡ -->
  <div class="stats-cards">
    <div class="stat-card">
      <div class="stat-card-label">æ€»ç”¨æˆ·æ•°</div>
      <div class="stat-card-value" id="statTotal">-</div>
    </div>
    <div class="stat-card online">
      <div class="stat-card-label">åœ¨çº¿ç”¨æˆ·</div>
      <div class="stat-card-value" id="statOnline">-</div>
    </div>
    <div class="stat-card admin">
      <div class="stat-card-label">ç®¡ç†å‘˜</div>
      <div class="stat-card-value" id="statAdmin">-</div>
    </div>
    <div class="stat-card locked">
      <div class="stat-card-label">å·²é”å®š</div>
      <div class="stat-card-value" id="statLocked">-</div>
    </div>
  </div>

  <div class="toolbar">
    <div class="toolbar-left">
      <h1>ç”¨æˆ·ç®¡ç†</h1>
    </div>
    <div class="toolbar-right">
      <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input id="search" type="text" placeholder="æœç´¢ç”¨æˆ·å" onkeydown="if(event.key==='Enter') loadUsers(1)">
      </div>
      <div class="filter-group">
        <span class="filter-label">æ’åº:</span>
        <select id="sort" onchange="loadUsers(1)">
          <option value="created_at:desc">åˆ›å»ºæ—¶é—´â†“</option>
          <option value="created_at:asc">åˆ›å»ºæ—¶é—´â†‘</option>
          <option value="username:asc">ç”¨æˆ·åA-Z</option>
          <option value="username:desc">ç”¨æˆ·åZ-A</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">æ˜¾ç¤º:</span>
        <select id="size" onchange="loadUsers(1)">
          <option value="10">10/é¡µ</option>
          <option value="20">20/é¡µ</option>
          <option value="50">50/é¡µ</option>
          <option value="100">100/é¡µ</option>
        </select>
      </div>
      <button class="btn-outline" onclick="loadUsers(curPage)" title="åˆ·æ–°åœ¨çº¿çŠ¶æ€">ğŸ”„ åˆ·æ–°</button>
      <button class="btn-primary" onclick="openCreate()">â• æ–°å»ºç”¨æˆ·</button>
      <a class="btn-outline" href="/admin/users/export" target="_blank">ğŸ“¥ å¯¼å‡ºCSV</a>
    </div>
  </div>

  <div id="tableContainer">
    <table>
      <thead>
        <tr>
          <th style="width:60px;">åºå·</th>
          <th>ç”¨æˆ·å</th>
          <th style="width:150px;">åœ¨çº¿çŠ¶æ€</th>
          <th style="width:100px;">èº«ä»½</th>
          <th style="width:90px;">çŠ¶æ€</th>
          <th style="width:160px;">åˆ›å»ºæ—¶é—´</th>
          <th style="width:360px;">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr>
          <td colspan="7" class="loading">åŠ è½½ä¸­</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="pagination">
    <div class="muted" id="pageInfo">ç¬¬ - / - é¡µ</div>
    <div class="page-jump">
      <button class="btn-outline" onclick="gotoPage(curPage-1)" id="btnPrev">ä¸Šä¸€é¡µ</button>
      <span class="muted">è·³è½¬åˆ°</span>
      <input type="text" id="jumpPage" placeholder="é¡µç " onkeydown="if(event.key==='Enter') jumpToPage()">
      <button class="btn-outline" onclick="jumpToPage()">GO</button>
      <button class="btn-outline" onclick="gotoPage(curPage+1)" id="btnNext">ä¸‹ä¸€é¡µ</button>
    </div>
  </div>
</div>

<!-- æ–°å»ºç”¨æˆ·å¼¹çª— -->
<div id="dlgCreate" class="modal-overlay">
  <div class="modal-content">
    <h3>â• æ–°å»ºç”¨æˆ·</h3>
    <div class="form-group">
      <label>ç”¨æˆ·å *</label>
      <input id="cu_name" type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
    </div>
    <div class="form-group">
      <label>åˆå§‹å¯†ç  *</label>
      <input id="cu_pwd" type="password" placeholder="è‡³å°‘8ä½ï¼Œå«å­—æ¯å’Œæ•°å­—">
    </div>
    <div class="form-group">
      <label style="display: flex; align-items: center; cursor: pointer;">
        <input id="cu_admin" type="checkbox" style="margin-right: 8px;">
        <span>è®¾ä¸ºç®¡ç†å‘˜</span>
      </label>
    </div>
    <div class="form-actions">
      <button class="btn-outline" onclick="closeCreate()">å–æ¶ˆ</button>
      <button class="btn-primary" onclick="doCreate()">åˆ›å»º</button>
    </div>
  </div>
</div>

<!-- é‡ç½®å¯†ç å¼¹çª— -->
<div id="dlgReset" class="modal-overlay">
  <div class="modal-content">
    <h3>ğŸ”‘ é‡ç½®å¯†ç </h3>
    <div class="form-group">
      <label>æ–°å¯†ç  *</label>
      <input id="rp_pwd" type="password" placeholder="è‡³å°‘8ä½ï¼Œå«å­—æ¯å’Œæ•°å­—">
    </div>
    <div class="form-group">
      <label>ç¡®è®¤å¯†ç  *</label>
      <input id="rp_pwd_confirm" type="password" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
    </div>
    <div class="form-actions">
      <button class="btn-outline" onclick="closeReset()">å–æ¶ˆ</button>
      <button class="btn-primary" onclick="doReset()">ç¡®è®¤é‡ç½®</button>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  let curPage = 1; 
  let pageSize = 10; 
  let curSort = 'created_at:desc'; 
  let curSearch = '';
  const CURRENT_UID = {{ user_id if user_id else 'null' }};
  let resetUserId = null;
  let allStats = { total: 0, online: 0, admin: 0, locked: 0 };

  function getVal(id){ return document.getElementById(id).value.trim(); }
  function qs(sel){ return document.querySelector(sel); }

  async function loadUsers(p){
    curPage = p || curPage;
    curSearch = getVal('search');
    pageSize = parseInt(getVal('size')||'10');
    curSort = getVal('sort');
    const [sort, order] = curSort.split(':');
    const url = `/admin/api/users?search=${encodeURIComponent(curSearch)}&page=${curPage}&size=${pageSize}&sort=${sort}&order=${order}`;
    
    try {
      const res = await fetch(url);
      const js = await res.json();
      if(!res.ok || js.status!=='success'){ 
        showError(js.message||'åŠ è½½å¤±è´¥'); 
        return; 
      }
      const rows = js.data || []; 
      const total = js.total || 0;
      
      // ç»Ÿè®¡æ•°æ®
      const onlineCount = rows.filter(u => u.is_online).length;
      const adminCount = rows.filter(u => u.is_admin).length;
      const lockedCount = rows.filter(u => u.is_locked).length;
      
      allStats = { total, online: onlineCount, admin: adminCount, locked: lockedCount };
      
      updateStats();
      renderTable(rows);
      renderPager(total);
    } catch (error) {
      showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
      console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
    }
  }

  function updateStats() {
    qs('#statTotal').textContent = allStats.total;
    qs('#statOnline').textContent = allStats.online;
    qs('#statAdmin').textContent = allStats.admin;
    qs('#statLocked').textContent = allStats.locked;
  }

  function renderTable(rows){
    const tb = document.getElementById('tbody');
    
    if (rows.length === 0) {
      tb.innerHTML = `
        <tr>
          <td colspan="7" class="empty-state">
            <div class="empty-state-icon">ğŸ‘¤</div>
            <div>æš‚æ— ç”¨æˆ·æ•°æ®</div>
          </td>
        </tr>
      `;
      return;
    }
    
    tb.innerHTML = rows.map((u,i)=>{
      const adminTag = u.is_admin 
        ? '<span class="tag tag-admin">ğŸ‘‘ ç®¡ç†å‘˜</span>' 
        : '<span class="tag tag-user">ğŸ‘¤ æ™®é€šç”¨æˆ·</span>';
      const lockTag = u.is_locked 
        ? '<span class="tag tag-locked">ğŸ”’ å·²é”å®š</span>' 
        : '<span class="tag" style="background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9;">ğŸ”“ æ­£å¸¸</span>';
      
      // åœ¨çº¿çŠ¶æ€
      let onlineHtml = '';
      if (u.is_online) {
        onlineHtml = `
          <div class="online-status online">
            <span class="status-dot online"></span>
            <span>åœ¨çº¿</span>
          </div>
        `;
      } else {
        const lastActiveText = u.last_active ? formatLastActive(u.last_active) : '';
        onlineHtml = `
          <div class="online-status offline">
            <span class="status-dot offline"></span>
            <span>ç¦»çº¿</span>
          </div>
          ${lastActiveText ? `<div class="last-active">${lastActiveText}</div>` : ''}
        `;
      }
      
      // æ“ä½œæŒ‰é’®
      let actionsHtml = '';
      if (u.id === CURRENT_UID) {
        actionsHtml = '<span class="muted">ğŸ‘¤ å½“å‰ç”¨æˆ·</span>';
      } else {
        actionsHtml = `
          <button class="btn-sm btn-view" onclick="window.location.href='/admin/users/${u.id}'" title="æŸ¥çœ‹è¯¦æƒ…">ğŸ‘ï¸ æŸ¥çœ‹</button>
          <button class="btn-sm btn-edit" onclick="openReset(${u.id})" title="é‡ç½®å¯†ç ">ğŸ”‘ æ”¹å¯†</button>
          <button class="btn-sm ${u.is_locked ? 'btn-unlock' : 'btn-lock'}" onclick="toggleLock(${u.id})" title="${u.is_locked ? 'è§£é”ç”¨æˆ·' : 'é”å®šç”¨æˆ·'}">
            ${u.is_locked ? 'ğŸ”“ è§£é”' : 'ğŸ”’ é”å®š'}
          </button>
          <button class="btn-sm btn-admin" onclick="toggleAdmin(${u.id})" title="${u.is_admin ? 'å–æ¶ˆç®¡ç†å‘˜' : 'è®¾ä¸ºç®¡ç†å‘˜'}">
            ${u.is_admin ? 'ğŸ‘¤ é™çº§' : 'ğŸ‘‘ å‡çº§'}
          </button>
          ${u.is_online ? `<button class="btn-sm btn-logout" onclick="forceLogout(${u.id})" title="å¼ºåˆ¶ä¸‹çº¿">âš¡ ä¸‹çº¿</button>` : ''}
          <button class="btn-sm btn-delete" onclick="delUser(${u.id})" title="åˆ é™¤ç”¨æˆ·">ğŸ—‘ï¸ åˆ é™¤</button>
        `;
      }
      
      return `<tr>
        <td style="text-align:center;">${(curPage-1)*pageSize + i + 1}</td>
        <td><a href="/admin/users/${u.id}" class="link" style="font-weight:500;">${escapeHtml(u.username)}</a></td>
        <td>${onlineHtml}</td>
        <td>${adminTag}</td>
        <td>${lockTag}</td>
        <td style="font-size:12px; color:#666;">${formatDateTime(u.created_at)}</td>
        <td class="actions">${actionsHtml}</td>
      </tr>`;
    }).join('');
  }
  
  // HTMLè½¬ä¹‰
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
  function formatDateTime(dateStr) {
    if (!dateStr) return '-';
    try {
      const date = new Date(dateStr.replace(' ', 'T'));
      return date.toLocaleString('zh-CN', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch (e) {
      return dateStr;
    }
  }
  
  // æ ¼å¼åŒ–ç¦»çº¿æ—¶é•¿
  function formatLastActive(lastActive) {
    if (!lastActive) return '';

    try {
      const lastActiveUTC = lastActive.includes('Z') ? lastActive : lastActive.replace(' ', 'T') + 'Z';
      const now = new Date();
      const last = new Date(lastActiveUTC);
      const diffMs = now - last;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'åˆšåˆšç¦»çº¿';
      if (diffMins < 60) return `${diffMins}åˆ†é’Ÿå‰`;
      if (diffHours < 24) return `${diffHours}å°æ—¶å‰`;
      if (diffDays < 7) return `${diffDays}å¤©å‰`;
      
      return last.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
    } catch (e) {
      return lastActive;
    }
  }

  function renderPager(total){
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    qs('#pageInfo').innerText = `ç¬¬ ${curPage} / ${totalPages} é¡µ (å…± ${total} æ¡)`;
    qs('#btnPrev').disabled = curPage<=1;
    qs('#btnNext').disabled = curPage>=totalPages;
  }
  
  function gotoPage(p){ 
    const totalPages = Math.max(1, Math.ceil(allStats.total / pageSize));
    if(p < 1 || p > totalPages) return; 
    loadUsers(p); 
  }
  
  function jumpToPage() {
    const page = parseInt(getVal('jumpPage'));
    if (isNaN(page) || page < 1) {
      showError('è¯·è¾“å…¥æœ‰æ•ˆçš„é¡µç ');
      return;
    }
    gotoPage(page);
    qs('#jumpPage').value = '';
  }

  async function toggleAdmin(id){
    if (!confirm('ç¡®å®šè¦åˆ‡æ¢è¯¥ç”¨æˆ·çš„ç®¡ç†å‘˜æƒé™å—ï¼Ÿ')) return;
    try {
      const res = await fetch(`/admin/users/${id}/toggle_admin`, { method:'POST' });
      const js = await res.json(); 
      showMessage(js.message||'æ“ä½œå®Œæˆ', js.status==='success'); 
      if(js.status==='success') loadUsers(curPage);
    } catch (error) {
      showError('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
  }
  
  async function toggleLock(id){
    if (!confirm('ç¡®å®šè¦åˆ‡æ¢è¯¥ç”¨æˆ·çš„é”å®šçŠ¶æ€å—ï¼Ÿ')) return;
    try {
      const res = await fetch(`/admin/users/${id}/toggle_lock`, { method:'POST' });
      const js = await res.json(); 
      showMessage(js.message||'æ“ä½œå®Œæˆ', js.status==='success'); 
      if(js.status==='success') loadUsers(curPage);
    } catch (error) {
      showError('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
  }
  
  function openCreate(){ 
    qs('#cu_name').value = '';
    qs('#cu_pwd').value = '';
    qs('#cu_admin').checked = false;
    qs('#dlgCreate').style.display='flex'; 
  }
  
  function closeCreate(){ qs('#dlgCreate').style.display='none'; }
  
  async function doCreate(){
    const name = getVal('cu_name'); 
    const pwd = getVal('cu_pwd'); 
    const isAdmin = qs('#cu_admin').checked;
    
    if(!name || !pwd){ 
      showError('è¯·è¾“å…¥ç”¨æˆ·åå’Œåˆå§‹å¯†ç '); 
      return; 
    }
    
    if(pwd.length < 8 || !(/[a-z]/i.test(pwd) && /\d/.test(pwd))) {
      showError('å¯†ç è‡³å°‘8ä½ä¸”åŒ…å«å­—æ¯å’Œæ•°å­—');
      return;
    }
    
    try {
      const res = await fetch('/admin/users/create', { 
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({ username:name, password:pwd, is_admin: isAdmin?1:0 }) 
      });
      const js = await res.json(); 
      showMessage(js.message||'å®Œæˆ', js.status==='success'); 
      if(js.status==='success'){ 
        closeCreate(); 
        loadUsers(1); 
      }
    } catch (error) {
      showError('åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
  }
  
  function openReset(id){ 
    resetUserId = id; 
    qs('#rp_pwd').value = '';
    qs('#rp_pwd_confirm').value = '';
    qs('#dlgReset').style.display='flex'; 
  }
  
  function closeReset(){ qs('#dlgReset').style.display='none'; }
  
  async function doReset(){
    const pwd = getVal('rp_pwd');
    const confirmPwd = getVal('rp_pwd_confirm');
    
    if(!pwd || !confirmPwd) {
      showError('è¯·è¾“å…¥æ–°å¯†ç å¹¶ç¡®è®¤');
      return;
    }
    
    if(pwd !== confirmPwd) {
      showError('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
      return;
    }
    
    if(pwd.length<8 || !( /[a-z]/i.test(pwd) && /\d/.test(pwd) )){ 
      showError('æ–°å¯†ç è‡³å°‘8ä½ä¸”åŒ…å«å­—æ¯å’Œæ•°å­—'); 
      return; 
    }
    
    try {
      const res = await fetch(`/admin/users/${resetUserId}/reset_password`, { 
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({ new_password: pwd }) 
      });
      const js = await res.json(); 
      showMessage(js.message||'å®Œæˆ', js.status==='success'); 
      if(js.status==='success'){ 
        closeReset(); 
        loadUsers(curPage);
      }
    } catch (error) {
      showError('é‡ç½®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
  }
  
  async function forceLogout(id){
    if (!confirm('ç¡®å®šè¦å¼ºåˆ¶è¯¥ç”¨æˆ·ä¸‹çº¿å—ï¼Ÿ')) return;
    try {
      const res = await fetch(`/admin/users/${id}/force_logout`, { method:'POST' });
      const js = await res.json(); 
      showMessage(js.message||'æ“ä½œå®Œæˆ', js.status==='success');
      if(js.status==='success') loadUsers(curPage);
    } catch (error) {
      showError('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
  }
  
  async function delUser(id){
    if(!confirm('âš ï¸ ç¡®å®šåˆ é™¤è¯¥ç”¨æˆ·ï¼Ÿ\n\nè¯¥æ“ä½œå°†ï¼š\nâ€¢ åˆ é™¤ç”¨æˆ·è´¦å·\nâ€¢ æ¸…é™¤æ‰€æœ‰ç›¸å…³æ•°æ®\nâ€¢ æ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
    
    try {
      const res = await fetch(`/admin/users/${id}`, { method:'DELETE' });
      const js = await res.json(); 
      showMessage(js.message||'å·²å¤„ç†', js.status==='success'); 
      if(js.status==='success') loadUsers(curPage);
    } catch (error) {
      showError('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
  }
  
  // æ¶ˆæ¯æç¤º
  function showMessage(msg, isSuccess = true) {
    alert((isSuccess ? 'âœ… ' : 'âŒ ') + msg);
  }
  
  function showError(msg) {
    alert('âŒ ' + msg);
  }

  // åˆå§‹åŒ–
  (function init(){
    document.getElementById('search').value = '';
    document.getElementById('size').value = '10';
    document.getElementById('sort').value = 'created_at:desc';
    loadUsers(1);
    
    // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡ç”¨æˆ·åˆ—è¡¨ï¼ˆæ›´æ–°åœ¨çº¿çŠ¶æ€ï¼‰
    setInterval(() => {
      loadUsers(curPage);
    }, 30000);
    
    // ESCé”®å…³é—­å¼¹çª—
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeCreate();
        closeReset();
      }
    });
    
    // ç‚¹å‡»é®ç½©å±‚å…³é—­å¼¹çª—
    qs('#dlgCreate').addEventListener('click', (e) => {
      if (e.target === qs('#dlgCreate')) closeCreate();
    });
    qs('#dlgReset').addEventListener('click', (e) => {
      if (e.target === qs('#dlgReset')) closeReset();
    });
  })();
</script>
{% endblock %}
