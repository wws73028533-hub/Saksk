{% extends "admin_base.html" %}

{% block title %}ç”¨æˆ·è¯¦æƒ… - {{ user.username }}{% endblock %}

{% block head %}
<style>
  /* å®¹å™¨æ ·å¼ */
  .container { 
    background:#fff; 
    padding:32px; 
    border-radius:12px; 
    box-shadow:0 4px 16px rgba(0,0,0,0.06);
    max-width: 1400px;
    margin: 0 auto;
  }
  
  /* é¡¶éƒ¨å¯¼èˆªæ  */
  .topbar { 
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    margin-bottom:24px; 
    gap:16px; 
    flex-wrap:wrap;
    padding-bottom:20px;
    border-bottom:2px solid #f1f3f5;
  }
  
  .topbar h1 { 
    margin:0; 
    font-size:28px; 
    font-weight:700;
    color:#212529;
    display:flex;
    align-items:center;
    gap:12px;
  }
  
  .topbar h1::before {
    content:'ğŸ‘¤';
    font-size:32px;
  }
  
  .ops { 
    display:flex; 
    gap:10px; 
    flex-wrap:wrap;
    align-items:center;
  }
  
  /* ç”¨æˆ·èµ„æ–™å¡ç‰‡ */
  .profile-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius:12px;
    padding:24px;
    margin-bottom:24px;
    color:#fff;
    box-shadow:0 8px 24px rgba(102,126,234,0.25);
  }
  
  .profile-section { 
    display:flex; 
    gap:24px; 
    align-items:flex-start;
  }
  
  .avatar-box { 
    flex-shrink:0;
    position:relative;
  }
  
  .avatar-img { 
    width:140px; 
    height:140px; 
    border-radius:12px; 
    object-fit:cover; 
    border:4px solid rgba(255,255,255,0.3);
    box-shadow:0 8px 16px rgba(0,0,0,0.2);
    transition: transform 0.3s ease;
  }
  
  .avatar-img:hover {
    transform: scale(1.05);
  }
  
  .avatar-placeholder { 
    width:140px; 
    height:140px; 
    border-radius:12px; 
    background:rgba(255,255,255,0.2); 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    font-size:64px; 
    border:4px solid rgba(255,255,255,0.3);
    backdrop-filter: blur(10px);
  }
  
  .profile-info { 
    flex:1;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  
  .profile-username {
    font-size:32px;
    font-weight:700;
    margin:0 0 8px 0;
    text-shadow:0 2px 4px rgba(0,0,0,0.1);
  }
  
  .info-row { 
    display:flex; 
    gap:12px; 
    align-items:center;
    background:rgba(255,255,255,0.15);
    padding:10px 16px;
    border-radius:8px;
    backdrop-filter: blur(10px);
  }
  
  .info-icon {
    font-size:20px;
    width:24px;
    text-align:center;
  }
  
  .info-label { 
    color:rgba(255,255,255,0.9); 
    font-size:14px; 
    font-weight:600;
    min-width:80px;
  }
  
  .info-value { 
    font-size:15px; 
    color:#fff;
    font-weight:500;
  }
  
  /* ç»Ÿè®¡å¡ç‰‡ç½‘æ ¼ */
  .stats-grid { 
    display:grid; 
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
    gap:16px; 
    margin-bottom:24px;
  }
  
  .stat-card { 
    background:#fff;
    border:1px solid #e9ecef; 
    border-radius:12px; 
    padding:20px;
    transition: all 0.3s ease;
    position:relative;
    overflow:hidden;
  }
  
  .stat-card::before {
    content:'';
    position:absolute;
    top:0;
    left:0;
    width:4px;
    height:100%;
    background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
  }
  
  .stat-card:hover { 
    transform: translateY(-4px);
    box-shadow:0 8px 24px rgba(0,0,0,0.12);
    border-color:#667eea;
  }
  
  .stat-label { 
    color:#6c757d; 
    font-size:13px; 
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.5px;
    margin-bottom:8px;
  }
  
  .stat-value { 
    font-size:32px; 
    font-weight:700; 
    color:#212529;
    line-height:1;
  }
  
  .stat-icon {
    position:absolute;
    right:16px;
    top:16px;
    font-size:32px;
    opacity:0.2;
  }
  
  /* æ ‡ç­¾æ ·å¼ */
  .tag { 
    display:inline-flex;
    align-items:center;
    gap:4px;
    padding:4px 12px; 
    border-radius:12px; 
    font-size:13px;
    font-weight:600;
  }
  
  .tag-admin { 
    background:#e7f1ff; 
    color:#0b61d8;
  }
  
  .tag-locked { 
    background:#fde2e1; 
    color:#c62828;
  }
  
  .tag-normal {
    background:#d4edda;
    color:#155724;
  }
  
  /* è¡¨æ ¼æ ·å¼ */
  .section-card {
    background:#fff;
    border:1px solid #e9ecef;
    border-radius:12px;
    padding:24px;
    margin-top:24px;
  }
  
  .section-header {
    display:flex;
    align-items:center;
    gap:12px;
    margin:0 0 20px;
    font-size:20px;
    font-weight:700;
    color:#212529;
  }
  
  .section-header::before {
    content:'ğŸ“Š';
    font-size:24px;
  }
  
  table { 
    width:100%; 
    border-collapse:collapse;
  }
  
  th, td { 
    padding:14px 16px; 
    border-bottom:1px solid #e9ecef; 
    text-align:left;
  }
  
  thead th { 
    background:#f8f9fa; 
    font-weight:700;
    color:#495057;
    font-size:13px;
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  
  tbody tr {
    transition: background 0.2s ease;
  }
  
  tbody tr:hover { 
    background:#f8f9fa;
  }
  
  tbody tr:last-child td {
    border-bottom:none;
  }
  
  .empty-state {
    text-align:center;
    padding:40px 20px;
    color:#6c757d;
  }
  
  .empty-state-icon {
    font-size:48px;
    margin-bottom:12px;
    opacity:0.5;
  }
  
  /* å¼¹çª—æ ·å¼ */
  .modal-overlay {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.5);
    align-items:center;
    justify-content:center;
    z-index:1000;
    backdrop-filter: blur(4px);
    animation: fadeIn 0.2s ease;
  }
  
  @keyframes fadeIn {
    from { opacity:0; }
    to { opacity:1; }
  }
  
  .modal-content {
    background:#fff;
    padding:28px;
    border-radius:12px;
    width:400px;
    max-width:90vw;
    box-shadow:0 20px 60px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease;
  }
  
  @keyframes slideUp {
    from { transform: translateY(20px); opacity:0; }
    to { transform: translateY(0); opacity:1; }
  }
  
  .modal-header {
    margin:0 0 20px;
    font-size:22px;
    font-weight:700;
    color:#212529;
    display:flex;
    align-items:center;
    gap:10px;
  }
  
  .modal-body {
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  
  .modal-body input {
    padding:12px 16px;
    border:2px solid #e9ecef;
    border-radius:8px;
    font-size:14px;
    transition: border-color 0.2s ease;
  }
  
  .modal-body input:focus {
    outline:none;
    border-color:#667eea;
  }
  
  .modal-footer {
    margin-top:24px;
    display:flex;
    gap:12px;
    justify-content:flex-end;
  }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 900px) { 
    .container {
      padding:20px;
    }
    
    .stats-grid { 
      grid-template-columns: repeat(2, 1fr);
    }
    
    .profile-section { 
      flex-direction:column;
      align-items:center;
      text-align:center;
    }
    
    .topbar {
      flex-direction:column;
      align-items:stretch;
    }
    
    .topbar h1 {
      font-size:24px;
    }
    
    .ops {
      justify-content:center;
    }
  }
  
  @media (max-width: 600px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <div class="topbar">
    <h1>{{ user.username }}</h1>
    <div class="ops">
      {% if user.id != user_id %}
      <button class="btn-primary" onclick="toggleAdmin()">
        {{ 'ğŸ”½ æ’¤é”€ç®¡ç†å‘˜' if user.is_admin else 'â¬†ï¸ è®¾ä¸ºç®¡ç†å‘˜' }}
      </button>
      <button class="btn-secondary" onclick="toggleLock()">
        {{ 'ğŸ”“ è§£é”è´¦æˆ·' if user.is_locked else 'ğŸ”’ é”å®šè´¦æˆ·' }}
      </button>
      <button class="btn-outline" onclick="openReset()">ğŸ”‘ é‡ç½®å¯†ç </button>
      <button class="btn-danger" onclick="forceLogout()">âš ï¸ å¼ºåˆ¶ä¸‹çº¿</button>
      {% else %}
      <span style="color:#6c757d; font-size:14px;">âš ï¸ å½“å‰ç®¡ç†å‘˜è´¦æˆ·ï¼Œå·²éšè—è‡ªæˆ‘æ“ä½œ</span>
      {% endif %}
      <a class="btn-outline" href="/admin/users">â† è¿”å›åˆ—è¡¨</a>
    </div>
  </div>

  <!-- ç”¨æˆ·èµ„æ–™å¡ç‰‡ -->
  <div class="profile-card">
    <div class="profile-section">
      <div class="avatar-box">
        {% if user.avatar %}
          <img src="{{ user.avatar }}" alt="ç”¨æˆ·å¤´åƒ" class="avatar-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div class="avatar-placeholder" style="display:none;">ğŸ‘¤</div>
        {% else %}
          <div class="avatar-placeholder">ğŸ‘¤</div>
        {% endif %}
      </div>
      <div class="profile-info">
        <h2 class="profile-username">{{ user.username }}</h2>
        <div class="info-row">
          <span class="info-icon">ğŸ†”</span>
          <span class="info-label">ç”¨æˆ·ID</span>
          <span class="info-value">#{{ user.id }}</span>
        </div>
        <div class="info-row">
          <span class="info-icon">ğŸ“</span>
          <span class="info-label">è”ç³»æ–¹å¼</span>
          <span class="info-value">{{ user.contact or 'æœªè®¾ç½®' }}</span>
        </div>
        <div class="info-row">
          <span class="info-icon">ğŸ«</span>
          <span class="info-label">å­¦é™¢</span>
          <span class="info-value">{{ user.college or 'æœªè®¾ç½®' }}</span>
        </div>
        <div class="info-row">
          <span class="info-icon">ğŸ‘¤</span>
          <span class="info-label">èº«ä»½</span>
          <span class="info-value">
            {% if user.is_admin %}
              <span class="tag tag-admin">ğŸ‘‘ ç®¡ç†å‘˜</span>
            {% else %}
              æ™®é€šç”¨æˆ·
            {% endif %}
          </span>
        </div>
        <div class="info-row">
          <span class="info-icon">ğŸ”</span>
          <span class="info-label">çŠ¶æ€</span>
          <span class="info-value">
            {% if user.is_locked %}
              <span class="tag tag-locked">ğŸ”’ å·²é”å®š</span>
            {% else %}
              <span class="tag tag-normal">âœ… æ­£å¸¸</span>
            {% endif %}
          </span>
        </div>
        <div class="info-row">
          <span class="info-icon">ğŸ“…</span>
          <span class="info-label">æ³¨å†Œæ—¶é—´</span>
          <span class="info-value">{{ user.created_at or '-' }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ç»Ÿè®¡æ•°æ® -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">ğŸ“š</div>
      <div class="stat-label">æ”¶è—é¢˜ç›®</div>
      <div class="stat-value">{{ stats.favorites }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">âŒ</div>
      <div class="stat-label">é”™é¢˜æ•°é‡</div>
      <div class="stat-value">{{ stats.mistakes }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">âœï¸</div>
      <div class="stat-label">ç´¯è®¡ç­”é¢˜</div>
      <div class="stat-value">{{ stats.total_answers }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">ğŸ“ˆ</div>
      <div class="stat-label">æ­£ç¡®ç‡</div>
      <div class="stat-value">{{ stats.accuracy }}%</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">â³</div>
      <div class="stat-label">è¿›è¡Œä¸­è€ƒè¯•</div>
      <div class="stat-value">{{ stats.exams_ongoing }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">âœ…</div>
      <div class="stat-label">å·²æäº¤è€ƒè¯•</div>
      <div class="stat-value">{{ stats.exams_submitted }}</div>
    </div>
  </div>

  <!-- æœ€è¿‘è€ƒè¯•è®°å½• -->
  <div class="section-card">
    <h3 class="section-header">æœ€è¿‘è€ƒè¯•è®°å½•</h3>
    {% if recent_exams %}
    <table>
      <thead>
        <tr>
          <th>è€ƒè¯•ID</th>
          <th>ç§‘ç›®</th>
          <th>æ€»åˆ†</th>
          <th>å¼€å§‹æ—¶é—´</th>
          <th>æäº¤æ—¶é—´</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {% for e in recent_exams %}
        <tr>
          <td><strong>#{{ e.id }}</strong></td>
          <td>{{ e.subject or 'å…¨éƒ¨ç§‘ç›®' }}</td>
          <td><strong style="color:#667eea;">{{ e.total_score }} åˆ†</strong></td>
          <td>{{ e.started_at }}</td>
          <td>{{ e.submitted_at }}</td>
          <td>
            <a class="btn-outline" href="/exams/{{ e.id }}" style="font-size:12px; padding:6px 12px;">æŸ¥çœ‹æˆç»©</a>
            <a class="btn-outline" href="/quiz?mode=exam&exam_id={{ e.id }}" style="font-size:12px; padding:6px 12px;">å›é¡¾é¢˜ç›®</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">ğŸ“­</div>
      <p>æš‚æ— è€ƒè¯•è®°å½•</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- é‡ç½®å¯†ç å¼¹çª— -->
<div id="dlgReset" class="modal-overlay" onclick="if(event.target === this) closeReset()">
  <div class="modal-content">
    <h3 class="modal-header">ğŸ”‘ é‡ç½®å¯†ç </h3>
    <div class="modal-body">
      <input id="rp_pwd" type="password" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼Œå«å­—æ¯å’Œæ•°å­—ï¼‰">
      <p style="color:#6c757d; font-size:13px; margin:0;">å¯†ç è¦æ±‚ï¼šè‡³å°‘8ä¸ªå­—ç¬¦ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—</p>
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closeReset()">å–æ¶ˆ</button>
      <button class="btn-primary" onclick="doReset()">ç¡®è®¤é‡ç½®</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const UID = {{ user.id }};
  
  // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      background: ${type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : '#d1ecf1'};
      color: ${type === 'success' ? '#155724' : type === 'error' ? '#721c24' : '#0c5460'};
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      font-weight: 500;
      animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }
  
  // æ·»åŠ åŠ¨ç”»æ ·å¼
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(400px); opacity: 0; }
    }
  `;
  document.head.appendChild(style);
  
  // åˆ‡æ¢ç®¡ç†å‘˜æƒé™
  async function toggleAdmin() {
    const isAdmin = {{ 'true' if user.is_admin else 'false' }};
    const action = isAdmin ? 'æ’¤é”€ç®¡ç†å‘˜æƒé™' : 'è®¾ä¸ºç®¡ç†å‘˜';
    
    if (!confirm(`ç¡®å®šè¦${action}å—ï¼Ÿæ­¤æ“ä½œå°†ç«‹å³ç”Ÿæ•ˆã€‚`)) return;
    
    const btn = event.target;
    btn.disabled = true;
    btn.setAttribute('data-loading', 'true');
    
    try {
      const res = await fetch(`/admin/users/${UID}/toggle_admin`, { method: 'POST' });
      const js = await res.json();
      
      if (js.status === 'success') {
        showNotification(js.message || 'æ“ä½œæˆåŠŸ', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        showNotification(js.message || 'æ“ä½œå¤±è´¥', 'error');
        btn.disabled = false;
        btn.removeAttribute('data-loading');
      }
    } catch (error) {
      showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
      btn.disabled = false;
      btn.removeAttribute('data-loading');
    }
  }
  
  // åˆ‡æ¢é”å®šçŠ¶æ€
  async function toggleLock() {
    const isLocked = {{ 'true' if user.is_locked else 'false' }};
    const action = isLocked ? 'è§£é”' : 'é”å®š';
    
    if (!confirm(`ç¡®å®šè¦${action}è¯¥ç”¨æˆ·å—ï¼Ÿ${isLocked ? '' : 'é”å®šåç”¨æˆ·å°†æ— æ³•ç™»å½•ã€‚'}`)) return;
    
    const btn = event.target;
    btn.disabled = true;
    btn.setAttribute('data-loading', 'true');
    
    try {
      const res = await fetch(`/admin/users/${UID}/toggle_lock`, { method: 'POST' });
      const js = await res.json();
      
      if (js.status === 'success') {
        showNotification(js.message || 'æ“ä½œæˆåŠŸ', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        showNotification(js.message || 'æ“ä½œå¤±è´¥', 'error');
        btn.disabled = false;
        btn.removeAttribute('data-loading');
      }
    } catch (error) {
      showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
      btn.disabled = false;
      btn.removeAttribute('data-loading');
    }
  }
  
  // æ‰“å¼€é‡ç½®å¯†ç å¼¹çª—
  function openReset() {
    document.getElementById('dlgReset').style.display = 'flex';
    document.getElementById('rp_pwd').value = '';
    document.getElementById('rp_pwd').focus();
  }
  
  // å…³é—­é‡ç½®å¯†ç å¼¹çª—
  function closeReset() {
    document.getElementById('dlgReset').style.display = 'none';
  }
  
  // æ‰§è¡Œå¯†ç é‡ç½®
  async function doReset() {
    const pwd = document.getElementById('rp_pwd').value.trim();
    
    if (pwd.length < 8) {
      showNotification('å¯†ç é•¿åº¦è‡³å°‘ä¸º8ä½', 'error');
      return;
    }
    
    if (!(/[a-z]/i.test(pwd) && /\d/.test(pwd))) {
      showNotification('å¯†ç å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—', 'error');
      return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.setAttribute('data-loading', 'true');
    
    try {
      const res = await fetch(`/admin/users/${UID}/reset_password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ new_password: pwd })
      });
      const js = await res.json();
      
      if (js.status === 'success') {
        showNotification(js.message || 'å¯†ç é‡ç½®æˆåŠŸ', 'success');
        closeReset();
      } else {
        showNotification(js.message || 'å¯†ç é‡ç½®å¤±è´¥', 'error');
      }
    } catch (error) {
      showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
    } finally {
      btn.disabled = false;
      btn.removeAttribute('data-loading');
    }
  }
  
  // å¼ºåˆ¶ç”¨æˆ·ä¸‹çº¿
  async function forceLogout() {
    if (!confirm('ç¡®å®šè¦å¼ºåˆ¶è¯¥ç”¨æˆ·ä¸‹çº¿å—ï¼Ÿç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•ã€‚')) return;
    
    const btn = event.target;
    btn.disabled = true;
    btn.setAttribute('data-loading', 'true');
    
    try {
      const res = await fetch(`/admin/users/${UID}/force_logout`, { method: 'POST' });
      const js = await res.json();
      
      if (js.status === 'success') {
        showNotification(js.message || 'æ“ä½œæˆåŠŸ', 'success');
      } else {
        showNotification(js.message || 'æ“ä½œå¤±è´¥', 'error');
      }
    } catch (error) {
      showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
    } finally {
      btn.disabled = false;
      btn.removeAttribute('data-loading');
    }
  }
  
  // é”®ç›˜å¿«æ·é”®æ”¯æŒ
  document.addEventListener('keydown', (e) => {
    // ESC å…³é—­å¼¹çª—
    if (e.key === 'Escape') {
      closeReset();
    }
    // Enter åœ¨å¼¹çª—ä¸­æäº¤
    if (e.key === 'Enter' && document.getElementById('dlgReset').style.display === 'flex') {
      doReset();
    }
  });
</script>
{% endblock %}
