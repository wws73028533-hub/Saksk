{% extends "admin_base.html" %}

{% block title %}ç§‘ç›®ç®¡ç†{% endblock %}

{% block head %}
<style>
    .container {
        background: #fff;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    /* é¡µé¢æ ‡é¢˜ */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e9ecef;
    }
    .page-title {
        font-size: 28px;
        font-weight: bold;
        color: #333;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .page-title-icon {
        font-size: 32px;
    }
    
    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-row {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }
    .stat-card {
        flex: 1;
        min-width: 200px;
        padding: 20px;
        border-radius: 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s, box-shadow 0.3s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .stat-card.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-card.questions { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .stat-card.avg { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card-label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 10px;
        font-weight: 500;
    }
    .stat-card-value {
        font-size: 36px;
        font-weight: bold;
        margin-bottom: 4px;
    }
    .stat-card-desc {
        font-size: 12px;
        opacity: 0.8;
    }
    
    /* å·¥å…·æ  */
    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        gap: 16px;
        flex-wrap: wrap;
    }
    .toolbar-left, .toolbar-right {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    /* æ·»åŠ ç§‘ç›®è¡¨å• */
    .add-subject-form {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 16px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .add-subject-form input {
        flex: 1;
        min-width: 250px;
    }
    
    /* æœç´¢æ¡† */
    .search-box {
        position: relative;
        display: inline-block;
    }
    .search-box input {
        padding-left: 36px;
        width: 250px;
        transition: width 0.3s, border-color 0.3s;
    }
    .search-box input:focus {
        width: 320px;
        border-color: #667eea;
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        pointer-events: none;
        font-size: 16px;
    }
    
    /* è¾“å…¥æ¡†ä¼˜åŒ– */
    input[type="text"] {
        padding: 10px 14px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    input[type="text"]:focus {
        border-color: #667eea;
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* è¡¨æ ¼ä¼˜åŒ– */
    .table-wrapper {
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }
    th, td {
        border-bottom: 1px solid var(--border-color);
        padding: 16px;
        text-align: left;
        vertical-align: middle;
    }
    thead th {
        background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 2px solid var(--border-color);
        font-weight: 600;
        color: #495057;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    tbody tr {
        transition: all 0.2s;
    }
    tbody tr:hover {
        background-color: #f8f9fa;
        transform: scale(1.01);
    }
    tbody tr:last-child td {
        border-bottom: none;
    }
    
    /* ç§‘ç›®åç§°æ ·å¼ */
    .subject-name {
        font-size: 16px;
        font-weight: 500;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .subject-icon {
        font-size: 20px;
    }
    
    /* é¢˜ç›®æ•°é‡å¾½ç«  */
    .question-count {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
    }
    .question-count.empty {
        background: linear-gradient(135deg, #adb5bd 0%, #6c757d 100%);
    }
    
    /* æ“ä½œæŒ‰é’®ä¼˜åŒ– */
    .action-btns {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .btn-sm {
        padding: 6px 14px;
        font-size: 13px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        font-weight: 500;
    }
    .btn-sm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .btn-manage {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .btn-manage:hover {
        background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
    }
    .btn-edit {
        background: #fff3e0;
        color: #f57c00;
        border: 1px solid #ffe0b2;
    }
    .btn-edit:hover {
        background: #ffe0b2;
    }
    .btn-delete {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
    }
    .btn-delete:hover {
        background: #ffcdd2;
    }
    
    /* æ¨¡æ€æ¡† */
    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s;
    }
    .modal-overlay.show {
        display: flex;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .modal-content {
        background: white;
        padding: 28px;
        border-radius: 12px;
        width: 450px;
        max-width: 90vw;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        animation: slideUp 0.3s;
    }
    @keyframes slideUp {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .modal-header {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .modal-body {
        margin-bottom: 24px;
    }
    .form-group {
        margin-bottom: 16px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 500;
        color: #495057;
    }
    .form-group input {
        width: 100%;
        box-sizing: border-box;
    }
    .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: #6c757d;
    }
    .empty-state-icon {
        font-size: 80px;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    .empty-state-text {
        font-size: 18px;
        margin-bottom: 10px;
        font-weight: 500;
    }
    .empty-state-hint {
        font-size: 14px;
        color: #adb5bd;
        margin-bottom: 24px;
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }
    .loading-spinner {
        display: inline-block;
    }

    /* å¯¼å…¥ç»“æœæ ·å¼ */
    #importResult {
        padding: 16px;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.6;
        margin-top: 16px;
        border: 1px solid transparent;
    }
    #importResult.success {
        background-color: #e6ffed;
        border-color: #b7ebc0;
        color: #257942;
    }
    #importResult.warning {
        background-color: #fff8e1;
        border-color: #ffecb3;
        color: #6d4c41;
    }
    #importResult.error {
        background-color: #ffebee;
        border-color: #ffcdd2;
        color: #c62828;
    }
    #importResult ul {
        margin-top: 10px;
        padding-left: 20px;
        max-height: 200px;
        overflow-y: auto;
        background: rgba(0,0,0,0.02);
        padding-top: 10px;
        padding-bottom: 10px;
        border-radius: 4px;
    }
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header">
        <div class="page-title">
            <span class="page-title-icon">ğŸ“š</span>
            <span>ç§‘ç›®ç®¡ç†</span>
        </div>
        <button class="btn-secondary" onclick="window.location.href='/admin/dashboard'">â† è¿”å›ä»ªè¡¨æ¿</button>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-row">
        <div class="stat-card total">
            <div class="stat-card-label">æ€»ç§‘ç›®æ•°</div>
            <div class="stat-card-value" id="statTotal">0</div>
            <div class="stat-card-desc">ç³»ç»Ÿä¸­çš„æ‰€æœ‰ç§‘ç›®</div>
        </div>
        <div class="stat-card questions">
            <div class="stat-card-label">æ€»é¢˜ç›®æ•°</div>
            <div class="stat-card-value" id="statQuestions">0</div>
            <div class="stat-card-desc">æ‰€æœ‰ç§‘ç›®çš„é¢˜ç›®æ€»å’Œ</div>
        </div>
        <div class="stat-card avg">
            <div class="stat-card-label">å¹³å‡é¢˜ç›®æ•°</div>
            <div class="stat-card-value" id="statAvg">0</div>
            <div class="stat-card-desc">æ¯ä¸ªç§‘ç›®çš„å¹³å‡é¢˜ç›®æ•°</div>
        </div>
    </div>

    <!-- æ·»åŠ ç§‘ç›®è¡¨å• -->
    <div class="add-subject-form">
        <span style="font-weight: 500; color: #495057;">â• æ·»åŠ æ–°ç§‘ç›®ï¼š</span>
        <input type="text" id="subjectName" placeholder="è¯·è¾“å…¥ç§‘ç›®åç§°ï¼Œä¾‹å¦‚ï¼šè®¡ç®—æœºç½‘ç»œ" onkeydown="if(event.key==='Enter') addSubject()">
        <button class="btn-primary" onclick="addSubject()">âœ¨ ç«‹å³æ·»åŠ </button>
    </div>

    <!-- é¢˜åº“å¯¼å…¥ -->
    <div class="add-subject-form" style="flex-direction: column; align-items: flex-start; background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);">
        <div style="font-weight: 500; color: #495057; font-size: 16px; margin-bottom: 12px;">ğŸš€ æ‰¹é‡å¯¼å…¥é¢˜åº“</div>
        <div style="display: flex; gap: 10px; align-items: center; width: 100%;">
            <input type="file" id="importFile" accept=".xlsx" style="flex: 1; background: white;">
            <button class="btn-primary" onclick="importFromExcel()" id="importBtn">ğŸ“¤ å¼€å§‹å¯¼å…¥</button>
        </div>
        <div style="margin-top: 10px; font-size: 12px;">
            <span>ä¸çŸ¥é“æ ¼å¼ï¼Ÿ</span>
            <a href="/admin/download_template" style="color: #1e3a8a; font-weight: 500;">ä¸‹è½½Excelæ¨¡æ¿æ–‡ä»¶</a>
        </div>
        <div id="importResult" style="width: 100%; display: none;"></div>
    </div>

    <!-- å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-left">
            <span style="font-size: 16px; font-weight: 500; color: #495057;">ç§‘ç›®åˆ—è¡¨</span>
        </div>
        <div class="toolbar-right">
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="searchInput" placeholder="      æœç´¢ç§‘ç›®åç§°..." oninput="filterSubjects()">
            </div>
        </div>
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th style="width: 80px;">åºå·</th>
                    <th>ç§‘ç›®åç§°</th>
                    <th style="width: 150px;">é¢˜ç›®æ•°é‡</th>
                    <th style="width: 280px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="subjectTableBody">
                <tr>
                    <td colspan="4" class="loading-state">
                        <div class="loading-spinner"></div>
                        <div>åŠ è½½ä¸­...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ç¼–è¾‘ç§‘ç›®æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="editModal" onclick="if(event.target===this) closeEditModal()">
    <div class="modal-content">
        <div class="modal-header">
            <span>âœï¸ ç¼–è¾‘ç§‘ç›®</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>ç§‘ç›®åç§° *</label>
                <input type="text" id="editSubjectName" placeholder="è¯·è¾“å…¥æ–°çš„ç§‘ç›®åç§°">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button class="btn-primary" onclick="confirmEdit()">ä¿å­˜ä¿®æ”¹</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allSubjects = [];
    let editingSubjectId = null;
    
    const subjectIcons = {
        'è®¡ç®—æœº': 'ğŸ’»',
        'ç½‘ç»œ': 'ğŸŒ',
        'æ•°å­¦': 'ğŸ”¢',
        'è‹±è¯­': 'ğŸ”¤',
        'ç‰©ç†': 'âš›ï¸',
        'åŒ–å­¦': 'ğŸ§ª',
        'ç”Ÿç‰©': 'ğŸ§¬',
        'å†å²': 'ğŸ“œ',
        'åœ°ç†': 'ğŸŒ',
        'æ”¿æ²»': 'ğŸ›ï¸',
        'è¯­æ–‡': 'ğŸ“–',
        'é»˜è®¤': 'ğŸ“š'
    };
    
    function getSubjectIcon(name) {
        for (const [key, icon] of Object.entries(subjectIcons)) {
            if (name.includes(key)) return icon;
        }
        return subjectIcons['é»˜è®¤'];
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    async function loadSubjects() {
        try {
            const res = await fetch('/admin/api/subjects');
            if (!res.ok) throw new Error('ç½‘ç»œé”™è¯¯');
            allSubjects = await res.json();
            updateStats();
            renderSubjects();
        } catch (e) {
            console.error('åŠ è½½ç§‘ç›®å¤±è´¥:', e);
            showError('åŠ è½½ç§‘ç›®å¤±è´¥: ' + e.message);
        }
    }
    
    function updateStats() {
        const total = allSubjects.length;
        const totalQuestions = allSubjects.reduce((sum, s) => sum + (s.question_count || 0), 0);
        const avg = total > 0 ? Math.round(totalQuestions / total) : 0;
        
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statQuestions').textContent = totalQuestions;
        document.getElementById('statAvg').textContent = avg;
    }
    
    function renderSubjects(filtered = null) {
        const subjects = filtered || allSubjects;
        const tbody = document.getElementById('subjectTableBody');
        tbody.innerHTML = '';
        
        if (subjects.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="empty-state">
                        <div class="empty-state-icon">ğŸ“š</div>
                        <div class="empty-state-text">æš‚æ— ç§‘ç›®æ•°æ®</div>
                        <div class="empty-state-hint">ç‚¹å‡»ä¸Šæ–¹"ç«‹å³æ·»åŠ "æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªç§‘ç›®</div>
                        <button class="btn-primary" onclick="document.getElementById('subjectName').focus()">
                            â• ç«‹å³æ·»åŠ ç§‘ç›®
                        </button>
                    </td>
                </tr>
            `;
            return;
        }
        
        subjects.forEach((sub, idx) => {
            const tr = document.createElement('tr');
            const icon = getSubjectIcon(sub.name);
            const count = sub.question_count || 0;
            const countClass = count === 0 ? 'empty' : '';
            
            tr.innerHTML = `
                <td style="text-align: center; font-weight: 500; color: #6c757d;">${idx + 1}</td>
                <td>
                    <div class="subject-name">
                        <span class="subject-icon">${icon}</span>
                        <span>${escapeHtml(sub.name)}</span>
                    </div>
                </td>
                <td>
                    <span class="question-count ${countClass}">
                        ğŸ“ ${count} é“é¢˜
                    </span>
                </td>
                <td>
                    <div class="action-btns">
                        <button class="btn-sm btn-manage" onclick="gotoQuestions(${sub.id})">ğŸ“š é¢˜é›†ç®¡ç†</button>
                        <button class="btn-sm btn-edit" onclick="openEditModal(${sub.id})">âœï¸ ç¼–è¾‘</button>
                        <button class="btn-sm btn-delete" onclick="deleteSubject(${sub.id})">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }
    
    function filterSubjects() {
        const keyword = document.getElementById('searchInput').value.toLowerCase().trim();
        if (!keyword) {
            renderSubjects();
            return;
        }
        const filtered = allSubjects.filter(s => s.name.toLowerCase().includes(keyword));
        renderSubjects(filtered);
    }
    
    async function addSubject() {
        const nameInput = document.getElementById('subjectName');
        const name = nameInput.value.trim();
        
        if (!name) {
            showError('è¯·è¾“å…¥ç§‘ç›®åç§°');
            nameInput.focus();
            return;
        }
        
        if (allSubjects.some(s => s.name === name)) {
            showError('è¯¥ç§‘ç›®å·²å­˜åœ¨');
            return;
        }
        
        try {
            const res = await fetch('/admin/api/subjects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            const result = await res.json();
            
            if (result.status === 'success') {
                showSuccess(result.message || 'ç§‘ç›®æ·»åŠ æˆåŠŸ');
                nameInput.value = '';
                loadSubjects();
            } else {
                showError(result.message || 'æ·»åŠ å¤±è´¥');
            }
        } catch (e) {
            console.error('æ·»åŠ ç§‘ç›®å¤±è´¥:', e);
            showError('æ·»åŠ å¤±è´¥: ' + e.message);
        }
    }
    
    function openEditModal(id) {
        const subject = allSubjects.find(s => s.id === id);
        if (!subject) return;
        
        editingSubjectId = id;
        document.getElementById('editSubjectName').value = subject.name;
        document.getElementById('editModal').classList.add('show');
        document.body.style.overflow = 'hidden';
        
        setTimeout(() => {
            const input = document.getElementById('editSubjectName');
            input.focus();
            input.select();
        }, 100);
    }
    
    function closeEditModal() {
        document.getElementById('editModal').classList.remove('show');
        document.body.style.overflow = '';
        editingSubjectId = null;
    }
    
    async function confirmEdit() {
        if (!editingSubjectId) return;
        
        const newName = document.getElementById('editSubjectName').value.trim();
        const oldSubject = allSubjects.find(s => s.id === editingSubjectId);
        
        if (!newName) {
            showError('è¯·è¾“å…¥ç§‘ç›®åç§°');
            return;
        }
        
        if (newName === oldSubject.name) {
            closeEditModal();
            return;
        }
        
        if (allSubjects.some(s => s.id !== editingSubjectId && s.name === newName)) {
            showError('è¯¥ç§‘ç›®åç§°å·²å­˜åœ¨');
            return;
        }
        
        try {
            const res = await fetch(`/admin/api/subjects/${editingSubjectId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName })
            });
            const result = await res.json();
            
            if (result.status === 'success') {
                showSuccess(result.message || 'ç§‘ç›®ä¿®æ”¹æˆåŠŸ');
                closeEditModal();
                loadSubjects();
            } else {
                showError(result.message || 'ä¿®æ”¹å¤±è´¥');
            }
        } catch (e) {
            console.error('ä¿®æ”¹ç§‘ç›®å¤±è´¥:', e);
            showError('ä¿®æ”¹å¤±è´¥: ' + e.message);
        }
    }

    async function deleteSubject(id) {
        const subject = allSubjects.find(s => s.id === id);
        if (!subject) return;
        
        const count = subject.question_count || 0;
        let confirmMsg = `âš ï¸ ç¡®å®šè¦åˆ é™¤ç§‘ç›®"${subject.name}"å—ï¼Ÿ`;
        if (count > 0) {
            confirmMsg += `\n\nè¯¥ç§‘ç›®ä¸‹æœ‰ ${count} é“é¢˜ç›®ã€‚`;
        }
        confirmMsg += '\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼';
        
        if (!confirm(confirmMsg)) return;
        
        try {
            let res = await fetch(`/admin/api/subjects/${id}`, { method: 'DELETE' });
            let result = await res.json();
            
            if (res.ok && result.status === 'success') {
                showSuccess(result.message || 'ç§‘ç›®åˆ é™¤æˆåŠŸ');
                loadSubjects();
                return;
            }
            
            if (res.status === 400 && /æ— æ³•ç›´æ¥åˆ é™¤/.test(result.message || '')) {
                if (confirm(`${result.message}\n\nâš ï¸ æ˜¯å¦å¼ºåˆ¶åˆ é™¤è¯¥ç§‘ç›®åŠå…¶ä¸‹æ‰€æœ‰ ${count} é“é¢˜ç›®ï¼Ÿ\n\næ­¤æ“ä½œå°†ï¼š\nâ€¢ åˆ é™¤ç§‘ç›®"${subject.name}"\nâ€¢ åˆ é™¤è¯¥ç§‘ç›®ä¸‹çš„æ‰€æœ‰é¢˜ç›®\nâ€¢ æ¸…é™¤ç›¸å…³çš„æ”¶è—å’Œé”™é¢˜è®°å½•\nâ€¢ æ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                    res = await fetch(`/admin/api/subjects/${id}?force=1`, { method: 'DELETE' });
                    result = await res.json();
                    
                    if (result.status === 'success') {
                        showSuccess(result.message || 'ç§‘ç›®åŠé¢˜ç›®å·²å…¨éƒ¨åˆ é™¤');
                        loadSubjects();
                    } else {
                        showError(result.message || 'å¼ºåˆ¶åˆ é™¤å¤±è´¥');
                    }
                }
                return;
            }
            
            showError(result.message || 'åˆ é™¤å¤±è´¥');
        } catch (e) {
            console.error('åˆ é™¤ç§‘ç›®å¤±è´¥:', e);
            showError('åˆ é™¤å¤±è´¥: ' + e.message);
        }
    }

    function gotoQuestions(id) {
        window.location.href = `/admin/subjects/${id}/questions`;
    }
    
    function showSuccess(message) {
        alert('âœ… ' + message);
    }
    
    function showError(message) {
        alert('âŒ ' + message);
    }

    async function importFromExcel() {
        const fileInput = document.getElementById('importFile');
        const importBtn = document.getElementById('importBtn');
        const resultDiv = document.getElementById('importResult');

        if (fileInput.files.length === 0) {
            showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ª .xlsx æ–‡ä»¶');
            return;
        }

        const file = fileInput.files[0];
        if (!file.name.endsWith('.xlsx')) {
            showError('åªå…è®¸ä¸Šä¼  .xlsx æ–‡ä»¶');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        importBtn.disabled = true;
        importBtn.textContent = 'å¯¼å…¥ä¸­...';
        resultDiv.style.display = 'none';
        resultDiv.className = '';

        try {
            const res = await fetch('/admin/api/questions/import/excel', {
                method: 'POST',
                body: formData
            });
            const result = await res.json();

            resultDiv.style.display = 'block';
            resultDiv.className = result.status; // 'success', 'warning', or 'error'

            let html = `<strong>${escapeHtml(result.message)}</strong>`;
            if (result.errors && result.errors.length > 0) {
                html += '<ul>';
                result.errors.forEach(err => {
                    html += `<li>${escapeHtml(err)}</li>`;
                });
                html += '</ul>';
            }
            resultDiv.innerHTML = html;

            if (result.status !== 'error') {
                // å¯¼å…¥æˆåŠŸæˆ–éƒ¨åˆ†æˆåŠŸåï¼Œåˆ·æ–°ç§‘ç›®åˆ—è¡¨
                loadSubjects();
            }

        } catch (e) {
            resultDiv.style.display = 'block';
            resultDiv.className = 'error';
            resultDiv.innerHTML = `<strong>å¯¼å…¥å¤±è´¥:</strong> ${escapeHtml(e.message)}`;
        } finally {
            importBtn.disabled = false;
            importBtn.textContent = 'ğŸ“¤ å¼€å§‹å¯¼å…¥';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadSubjects();
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeEditModal();
            }
        });
        
        document.getElementById('editSubjectName').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                confirmEdit();
            }
        });
    });
</script>
{% endblock %}
