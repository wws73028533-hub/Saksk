<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>历史通知 - 全能刷题库</title>
  <style>
    :root{--bg:#f5f5f7;--card:#fff;--text:#1d1d1f;--sub:#6e6e73;--primary:#007aff;--border:rgba(0,0,0,.08)}

    /* 全局滚动条样式 - 极简风格 */
    * { scrollbar-width: thin; scrollbar-color: transparent transparent; }
    *:hover { scrollbar-color: rgba(128, 128, 128, 0.3) transparent; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: transparent; border-radius: 3px; }
    *:hover::-webkit-scrollbar-thumb { background: rgba(128, 128, 128, 0.3); }
    ::-webkit-scrollbar-thumb:hover { background: rgba(128, 128, 128, 0.5); }

    body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','Helvetica Neue',Arial,sans-serif;background:var(--bg);margin:0;color:var(--text)}
    a{text-decoration:none;color:var(--primary)}
    .wrap{max-width:920px;margin:0 auto;padding:28px 16px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .top .title{font-size:20px;font-weight:700}
    .pill{display:inline-flex;gap:8px;align-items:center;background:rgba(0,122,255,.08);padding:8px 12px;border-radius:999px;color:var(--primary);font-size:13px;font-weight:650}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.06)}
    .list{margin-top:14px}
    .item{padding:14px 14px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;gap:10px;align-items:flex-start}
    .item:last-child{border-bottom:none}
    .dot{width:10px;height:10px;border-radius:50%;margin-top:6px;flex:0 0 auto;background:#c7c7cc}
    .dot.unread{background:#ff3b30}
    .meta{flex:1 1 auto;min-width:0}
    .t{font-weight:700;font-size:15px;line-height:1.4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .c{color:var(--sub);font-size:13px;line-height:1.5;margin-top:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .r{flex:0 0 auto;text-align:right;color:var(--sub);font-size:12px;line-height:1.4}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:650;margin-top:6px}
    .tag.info{background:#e8f2ff;color:#0b5fff}
    .tag.announcement{background:#e6fffb;color:#007a7a}
    .tag.reminder{background:#fff4e5;color:#b15a00}
    .tag.warning{background:#ffecec;color:#b00020}

    .empty{padding:46px 16px;text-align:center;color:var(--sub)}

    /* modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:999}
    .modal{width:min(760px, 100%);max-height:min(80vh, 760px);overflow:auto;background:#fff;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.08)}
    .modal-hd{padding:14px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;position:sticky;top:0;background:#fff}
    .modal-hd .mh{font-weight:800}
    .btn{border:none;background:rgba(0,0,0,.06);padding:8px 10px;border-radius:10px;cursor:pointer}
    .modal-bd{padding:14px 14px}
    .modal-bd .mc{white-space:pre-wrap;line-height:1.75;color:#1d1d1f;font-size:14px}
    .modal-ft{padding:14px 14px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px}
    .btn-primary{background:var(--primary);color:#fff}

    @media (max-width: 520px){
      .t{white-space:normal;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <a href="/user_hub">← 返回功能中心</a>
        <div class="title" style="margin-top:10px;">历史通知</div>
      </div>
      <div class="pill" id="unreadPill" style="display:none;">未读 <span id="unreadNum">0</span></div>
    </div>

    <div class="list card" id="listBox" style="margin-top:14px;"></div>
  </div>

  <div class="overlay" id="overlay" onclick="onOverlayClick(event)">
    <div class="modal">
      <div class="modal-hd">
        <div>
          <div class="mh" id="mTitle">通知详情</div>
          <div style="margin-top:6px; color: var(--sub); font-size:12px;" id="mMeta"></div>
        </div>
        <button class="btn" onclick="closeModal()">关闭</button>
      </div>
      <div class="modal-bd">
        <div class="mc" id="mContent"></div>
      </div>
      <div class="modal-ft">
        <button class="btn" onclick="closeModal()">取消</button>
        <button class="btn btn-primary" id="btnMarkRead" onclick="markReadAndClose()" style="display:none;">标记为已读</button>
      </div>
    </div>
  </div>

  <script>
    const TYPE_LABEL = {info:'信息',announcement:'公告',reminder:'提醒',warning:'警告'};

    let listData = [];
    let currentModalId = 0;
    let currentModalUnread = false;

    function esc(s){
      const d=document.createElement('div');
      d.textContent = s || '';
      return d.innerHTML;
    }

    function fmtTime(s){
      if(!s) return '';
      try{
        // 兼容 SQLite CURRENT_TIMESTAMP: "YYYY-MM-DD HH:mm:ss"（当作 UTC）
        const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})(?::(\d{2}))?$/);
        let d;
        if(m){
          d = new Date(Date.UTC(+m[1], +m[2]-1, +m[3], +m[4], +m[5], +(m[6]||0)));
        }else{
          d = new Date(s);
        }
        return d.toLocaleString('zh-CN', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      }catch(e){
        return String(s);
      }
    }

    function render(){
      const box = document.getElementById('listBox');
      if(!box) return;
      if(!listData || listData.length === 0){
        box.innerHTML = `<div class="empty">暂无通知</div>`;
        updateUnreadPill(0);
        return;
      }

      const unreadCnt = listData.filter(x=>!x.is_read).length;
      updateUnreadPill(unreadCnt);

      box.innerHTML = listData.map(n=>{
        const type = n.n_type || 'info';
        const dotCls = n.is_read ? '' : 'unread';
        const tagCls = `tag ${type}`;
        const tagText = TYPE_LABEL[type] || type;
        return `
          <div class="item" onclick="openDetail(${n.id})" data-id="${n.id}">
            <div class="dot ${dotCls}"></div>
            <div class="meta">
              <div class="t">${esc(n.title)}</div>
              <div class="c">${esc(n.content)}</div>
              <div class="${tagCls}">${esc(tagText)}</div>
            </div>
            <div class="r">
              <div>${esc(fmtTime(n.created_at))}</div>
              ${n.is_read ? '<div style="margin-top:6px;">已读</div>' : '<div style="margin-top:6px; color:#ff3b30; font-weight:700;">未读</div>'}
            </div>
          </div>
        `;
      }).join('');
    }

    function updateUnreadPill(cnt){
      const pill = document.getElementById('unreadPill');
      const num = document.getElementById('unreadNum');
      if(!pill || !num) return;
      if(cnt > 0){
        pill.style.display = 'inline-flex';
        num.textContent = String(cnt);
      }else{
        pill.style.display = 'none';
      }
    }

    async function loadList(){
      const res = await fetch('/api/notifications?include_dismissed=1');
      const js = await res.json();
      if(!res.ok || js.status !== 'success'){
        throw new Error(js.message || '加载失败');
      }
      listData = js.data || [];
      render();
    }

    function showModal(show){
      const ov = document.getElementById('overlay');
      if(!ov) return;
      ov.style.display = show ? 'flex' : 'none';
    }

    function onOverlayClick(e){
      if(e.target && e.target.id === 'overlay') closeModal();
    }

    async function openDetail(id){
      currentModalId = Number(id||0);
      if(!currentModalId) return;
      const res = await fetch('/api/notifications/' + encodeURIComponent(currentModalId));
      const js = await res.json();
      if(!res.ok || js.status !== 'success'){
        alert(js.message || '加载详情失败');
        return;
      }
      const n = js.data;
      currentModalUnread = !n.is_read;

      document.getElementById('mTitle').textContent = n.title || '通知详情';
      document.getElementById('mMeta').textContent = `${TYPE_LABEL[n.n_type] || n.n_type || '信息'} · ${fmtTime(n.created_at)}`;
      document.getElementById('mContent').textContent = n.content || '';

      const btn = document.getElementById('btnMarkRead');
      if(btn){
        btn.style.display = currentModalUnread ? 'inline-flex' : 'none';
      }

      showModal(true);
    }

    function closeModal(){
      showModal(false);
      currentModalId = 0;
      currentModalUnread = false;
    }

    async function markReadAndClose(){
      if(!currentModalId) return;
      try{
        const res = await fetch('/api/notifications/' + encodeURIComponent(currentModalId) + '/read', { method:'POST' });
        const js = await res.json();
        if(!res.ok || js.status !== 'success'){
          alert(js.message || '标记失败');
          return;
        }
        // 更新本地状态
        const it = listData.find(x=>Number(x.id)===Number(currentModalId));
        if(it) it.is_read = true;
        render();
        closeModal();
      }catch(e){
        console.error(e);
        alert('网络异常');
      }
    }

    (async function init(){
      try{
        await loadList();
      }catch(e){
        console.error(e);
        const box = document.getElementById('listBox');
        if(box) box.innerHTML = `<div class="empty">加载失败：${esc(e.message || '未知错误')}</div>`;
      }
    })();
  </script>
</body>
</html>


