{% extends "admin_base.html" %}

{% block title %}é¢˜é›†ç®¡ç†{% endblock %}

{% block head %}
<style>
    .container {
        background: #fff;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    /* é¡µé¢æ ‡é¢˜ */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e9ecef;
    }
    .page-title {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .page-title-icon {
        font-size: 28px;
    }
    .subject-badge {
        display: inline-block;
        padding: 6px 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
    }
    
    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-row {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .stat-card {
        flex: 1;
        min-width: 140px;
        padding: 16px;
        border-radius: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
    }
    .stat-card.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-card.choice { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .stat-card.blank { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card.judge { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .stat-card-label {
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 8px;
    }
    .stat-card-value {
        font-size: 28px;
        font-weight: bold;
    }
    
    /* å·¥å…·æ ä¼˜åŒ– */
    .toolbar { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 16px; 
        gap: 12px;
        flex-wrap: wrap;
    }
    .toolbar-left, .toolbar-right { 
        display: flex; 
        gap: 8px; 
        align-items: center; 
        flex-wrap: wrap;
    }
    
    /* æœç´¢æ¡†ä¼˜åŒ– */
    .search-box {
        position: relative;
        display: inline-block;
    }
    .search-box input {
        padding-left: 36px;
        width: 220px;
        transition: width 0.3s, border-color 0.3s;
    }
    .search-box input:focus {
        width: 280px;
        border-color: #667eea;
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        pointer-events: none;
        font-size: 16px;
    }
    
    /* ä¸‹æ‹‰èœå•ä¼˜åŒ– */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-menu { 
        display: none; 
        position: absolute; 
        left: 0; 
        top: 100%; 
        margin-top: 8px; 
        background: #fff; 
        border: 1px solid var(--border-color); 
        border-radius: 8px; 
        padding: 8px; 
        z-index: 10;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideDown 0.2s ease;
    }
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    #batch-menu { min-width: auto; white-space: nowrap; width: max-content; height: auto; }
    .dropdown-menu.open { display: block; }
    #batch-menu.open { 
        display: flex; 
        flex-wrap: nowrap; 
        align-items: center; 
        gap: 8px; 
        white-space: nowrap; 
    }
    #batch-menu[style*="display: block"] { 
        display: flex !important; 
        flex-wrap: nowrap; 
        align-items: center; 
        gap: 8px; 
        white-space: nowrap; 
    }
    #batch-menu .btn { 
        display: inline-flex; 
        width: auto; 
        white-space: nowrap;
        padding: 6px 12px;
        font-size: 13px;
    }
    .dropdown-menu label { 
        display: block; 
        margin-bottom: 8px; 
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
    }
    .dropdown-menu label:hover {
        background: #f8f9fa;
    }
    .dropdown-menu label input {
        margin-right: 8px;
    }
    
    /* è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†ä¼˜åŒ– */
    input[type="text"], 
    input[type="number"],
    select { 
        padding: 8px 12px; 
        border: 1px solid var(--border-color); 
        border-radius: 6px; 
        font-size: 14px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
        border-color: #667eea;
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* è¡¨æ ¼ä¼˜åŒ– */
    .table-wrapper { 
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }
    table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-top: 0;
    }
    th, td { 
        border-bottom: 1px solid var(--border-color); 
        padding: 12px; 
        text-align: left; 
        white-space: nowrap; 
        vertical-align: middle; 
    }
    thead { 
        position: sticky; 
        top: 0; 
        background: #fff; 
        z-index: 5; 
    }
    th { 
        background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
        font-weight: 600;
        color: #495057;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    tbody tr {
        transition: background-color 0.2s;
    }
    tbody tr:hover { 
        background-color: #f8f9fa;
    }
    .col-content { 
        min-width: 300px; 
        max-width: 500px;
        white-space: normal; 
        line-height: 1.6;
    }
    
    /* é¢˜å‹æ ‡ç­¾ */
    .type-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    .type-badge.choice { background: #d4edda; color: #155724; }
    .type-badge.blank { background: #fff3cd; color: #856404; }
    .type-badge.judge { background: #cce5ff; color: #004085; }
    .type-badge.other { background: #f8d7da; color: #721c24; }
    
    /* éš¾åº¦æ˜¾ç¤º */
    .difficulty-stars {
        color: #ffc107;
        font-size: 14px;
    }
    
    /* æ ‡ç­¾æ˜¾ç¤º */
    .tag-list {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
    }
    .tag-item {
        display: inline-block;
        padding: 2px 8px;
        background: #e7f1ff;
        color: #0b61d8;
        border-radius: 10px;
        font-size: 11px;
    }
    
    /* æ“ä½œæŒ‰é’®ä¼˜åŒ– */
    .action-btns {
        display: flex;
        gap: 6px;
        flex-wrap: nowrap;
    }
    .btn-sm {
        padding: 5px 12px;
        font-size: 12px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }
    .btn-sm:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn-edit { background: #fff3e0; color: #f57c00; }
    .btn-edit:hover { background: #ffe0b2; }
    .btn-delete { background: #ffebee; color: #c62828; }
    .btn-delete:hover { background: #ffcdd2; }

    /* æŠ½å±‰ä¼˜åŒ– */
    .drawer { 
        position: fixed; 
        top: 0; 
        right: -520px; 
        width: 500px; 
        height: 100%; 
        background: #fff; 
        box-shadow: -5px 0 20px rgba(0,0,0,0.2); 
        transition: right .3s ease; 
        z-index: 100; 
        display: flex; 
        flex-direction: column; 
    }
    .drawer.open { right: 0; }
    .drawer-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 99;
        display: none;
        animation: fadeIn 0.3s;
    }
    .drawer-overlay.show {
        display: block;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .drawer-header { 
        padding: 20px 24px; 
        border-bottom: 1px solid var(--border-color); 
        font-size: 20px; 
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .drawer-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
    }
    .drawer-close:hover {
        background: rgba(255,255,255,0.2);
    }
    .drawer-body { 
        flex: 1; 
        padding: 24px; 
        overflow-y: auto; 
    }
    .form-group { 
        margin-bottom: 16px; 
    }
    .form-group label { 
        display: block; 
        margin-bottom: 6px; 
        font-size: 14px;
        font-weight: 500;
        color: #495057;
    }
    .form-group input, 
    .form-group select, 
    .form-group textarea { 
        width: 100%; 
        padding: 10px 12px; 
        border: 1px solid #ced4da; 
        border-radius: 6px; 
        box-sizing: border-box;
        font-size: 14px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        border-color: #667eea;
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .drawer-footer { 
        padding: 16px 24px; 
        border-top: 1px solid var(--border-color); 
        text-align: right;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    /* é¢„è§ˆæ¡†ä¼˜åŒ– */
    .preview-box { 
        margin-top: 20px; 
        padding: 20px; 
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 12px;
        border: 1px solid #dee2e6;
    }
    .preview-box h4 {
        margin: 0 0 16px 0;
        color: #495057;
        font-size: 16px;
    }
    .preview-box .q-content { 
        font-size: 15px; 
        font-weight: 500; 
        margin-bottom: 16px;
        color: #212529;
        line-height: 1.6;
    }
    .preview-box .options label { 
        display: block; 
        padding: 12px 16px; 
        margin-bottom: 10px; 
        background: white;
        border: 2px solid #dee2e6; 
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .preview-box .options label:hover {
        border-color: #667eea;
        background: #f8f9fa;
    }
    
    /* æ¨¡æ€æ¡†ä¼˜åŒ– */
    .modal-drawer {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 101;
        display: none;
        max-width: 90vw;
        max-height: 90vh;
        overflow: hidden;
        animation: modalSlideIn 0.3s ease;
    }
    @keyframes modalSlideIn {
        from { opacity: 0; transform: translate(-50%, -45%); }
        to { opacity: 1; transform: translate(-50%, -50%); }
    }
    .modal-drawer.show {
        display: flex;
        flex-direction: column;
    }
    
    /* å¯¼å…¥é¢„è§ˆ */
    #importPreview {
        max-height: 300px;
        overflow: auto;
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }
    #importPreview > div {
        padding: 8px;
        border-bottom: 1px solid #dee2e6;
        font-size: 13px;
    }
    #importPreview > div:last-child {
        border-bottom: none;
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }
    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    .empty-state-text {
        font-size: 16px;
        margin-bottom: 8px;
    }
    .empty-state-hint {
        font-size: 14px;
        color: #adb5bd;
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading-row {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header">
        <div class="page-title">
            <span class="page-title-icon">ğŸ“š</span>
            <span>é¢˜ç›®ç®¡ç†</span>
            <span class="subject-badge" id="subjectName">{{ subject.name if subject else 'ç§‘ç›®' }}</span>
        </div>
        <button class="btn-secondary" onclick="window.location.href='/admin/subjects'">â† è¿”å›ç§‘ç›®åˆ—è¡¨</button>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-row">
        <div class="stat-card total">
            <div class="stat-card-label">æ€»é¢˜ç›®æ•°</div>
            <div class="stat-card-value" id="statTotal">0</div>
        </div>
        <div class="stat-card choice">
            <div class="stat-card-label">é€‰æ‹©é¢˜</div>
            <div class="stat-card-value" id="statChoice">0</div>
        </div>
        <div class="stat-card blank">
            <div class="stat-card-label">å¡«ç©ºé¢˜</div>
            <div class="stat-card-value" id="statBlank">0</div>
        </div>
        <div class="stat-card judge">
            <div class="stat-card-label">åˆ¤æ–­é¢˜</div>
            <div class="stat-card-value" id="statJudge">0</div>
        </div>
    </div>

    <!-- å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-left">
            <button class="btn-primary" onclick="openDrawer()">â• æ–°å¢é¢˜ç›®</button>
            <button class="btn-danger" id="batchDeleteBtn" onclick="batchDeleteQuestions()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
            <div class="dropdown">
                <button class="btn-outline" onclick="toggleDropdown('batch-menu')">âš™ï¸ æ‰¹é‡æ“ä½œ â–¾</button>
                <div id="batch-menu" class="dropdown-menu">
                    <button class="btn" onclick="openBatchMove()">ğŸ“¦ ç§»åŠ¨ç§‘ç›®</button>
                    <button class="btn" onclick="openBatchDifficulty()">â­ è®¾ç½®éš¾åº¦</button>
                    <button class="btn" onclick="openBatchTags('add')">â• æ·»åŠ æ ‡ç­¾</button>
                    <button class="btn" onclick="openBatchTags('remove')">â– ç§»é™¤æ ‡ç­¾</button>
                    <button class="btn" onclick="openBatchTags('set')">ğŸ”„ è¦†ç›–æ ‡ç­¾</button>
                </div>
            </div>
        </div>
        <div class="toolbar-right">
            <button class="btn-outline" onclick="openImportModal()">ğŸ“¥ å¯¼å…¥é¢˜åº“</button>
            <button class="btn-outline" onclick="exportSubject()">ğŸ“¤ å¯¼å‡ºæœ¬ç§‘ç›®</button>
            <select id="typeFilter" onchange="loadQuestions()">
                <option value="all">ğŸ“‹ å…¨éƒ¨é¢˜å‹</option>
            </select>
            <div class="dropdown">
                <button class="btn-outline" onclick="toggleDropdown('col-menu')">ğŸ‘ï¸ æ˜¾ç¤ºåˆ— â–¾</button>
                <div id="col-menu" class="dropdown-menu"></div>
            </div>
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="searchInput" placeholder="      æœç´¢é¢˜å¹²å†…å®¹..." oninput="searchQuestions()">
            </div>
        </div>
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th style="width:50px;"><input type="checkbox" id="selectAll"></th>
                    <th data-col="id" style="width:80px;">åºå·</th>
                    <th data-col="q_type" style="width:100px;">é¢˜å‹</th>
                    <th data-col="content" class="col-content">é¢˜å¹²</th>
                    <th data-col="difficulty" style="width:100px;">éš¾åº¦</th>
                    <th data-col="tags" style="width:150px;">æ ‡ç­¾</th>
                    <th data-col="created_by" style="width:100px;">åˆ›å»ºè€…</th>
                    <th data-col="updated_at" style="width:160px;">æ›´æ–°æ—¶é—´</th>
                    <th data-col="actions" style="width:180px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="questionTableBody">
                <tr>
                    <td colspan="9" class="loading-row">
                        <span class="loading-spinner"></span>
                        <span>åŠ è½½ä¸­...</span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- æŠ½å±‰é®ç½© -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

<!-- Batch Modals -->
<div id="modalMove" class="drawer" style="right:auto; left:50%; transform: translateX(-50%); width: 420px; height:auto; top: 15%; display:none;">
  <div class="drawer-header">æ‰¹é‡ç§»åŠ¨åˆ°ç§‘ç›®</div>
  <div class="drawer-body">
    <div class="form-group"><label>ç›®æ ‡ç§‘ç›®</label><select id="moveTarget"></select></div>
    <div class="form-group"><small>å°†æŠŠå·²å‹¾é€‰çš„é¢˜ç›®ç§»åŠ¨åˆ°æ‰€é€‰ç§‘ç›®ã€‚</small></div>
  </div>
  <div class="drawer-footer">
    <button class="btn-secondary" onclick="closeModal('modalMove')">å–æ¶ˆ</button>
    <button class="btn-primary" onclick="doBatchMove()">ç¡®å®š</button>
  </div>
</div>

<div id="modalDifficulty" class="drawer" style="right:auto; left:50%; transform: translateX(-50%); width: 420px; height:auto; top: 20%; display:none;">
  <div class="drawer-header">æ‰¹é‡è®¾ç½®éš¾åº¦</div>
  <div class="drawer-body">
    <div class="form-group"><label>éš¾åº¦ (1-5)</label><input type="number" id="diffValue" min="1" max="5" value="1"></div>
  </div>
  <div class="drawer-footer">
    <button class="btn-secondary" onclick="closeModal('modalDifficulty')">å–æ¶ˆ</button>
    <button class="btn-primary" onclick="doBatchDifficulty()">ç¡®å®š</button>
  </div>
</div>

<div id="modalTags" class="drawer" style="right:auto; left:50%; transform: translateX(-50%); width: 420px; height:auto; top: 20%; display:none;">
  <div class="drawer-header" id="tagsTitle">æ‰¹é‡æ ‡ç­¾</div>
  <div class="drawer-body">
    <div class="form-group"><label>æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label><input type="text" id="tagsInput" placeholder="ä¾‹å¦‚ï¼šç½‘ç»œ, è·¯ç”±"></div>
  </div>
  <div class="drawer-footer">
    <button class="btn-secondary" onclick="closeModal('modalTags')">å–æ¶ˆ</button>
    <button class="btn-primary" onclick="doBatchTags()">ç¡®å®š</button>
  </div>
</div>

<div id="modalImport" class="drawer" style="right:auto; left:50%; transform: translateX(-50%); width: 620px; height: 70%; top: 10%; display:none;">
  <div class="drawer-header">å¯¼å…¥é¢˜åº“ï¼ˆé¢„è§ˆï¼‰</div>
  <div class="drawer-body">
    <div class="form-group"><label>ç²˜è´´JSONæ•°ç»„</label><textarea id="importText" rows="8" placeholder='[{"é¢˜å‹":"é€‰æ‹©é¢˜","é¢˜å¹²":"...","é€‰é¡¹":["A","B"],"ç­”æ¡ˆ":"A","è§£æ":"..."}]'></textarea></div>
    <div class="form-group"><label>æˆ– é€‰æ‹©JSONæ–‡ä»¶</label><input type="file" id="importFile" accept="application/json"></div>
    <div class="form-group"><button class="btn-outline" onclick="renderImportPreview()">é¢„è§ˆ</button></div>
    <div class="form-group"><div id="importPreview" style="max-height:220px; overflow:auto; background:#f8f9fa; padding:10px; border-radius:6px; border:1px solid var(--border-color);"></div></div>
  </div>
  <div class="drawer-footer">
    <button class="btn-secondary" onclick="closeModal('modalImport')">å–æ¶ˆ</button>
    <button class="btn-primary" onclick="confirmImport()">ç¡®è®¤å¯¼å…¥</button>
  </div>
</div>

<!-- Edit/Add Drawer -->
<div id="drawer" class="drawer">
    <div class="drawer-header">
        <span id="drawer-title">æ–°å¢é¢˜ç›®</span>
        <button class="drawer-close" onclick="closeDrawer()">Ã—</button>
    </div>
    <div class="drawer-body">
        <input type="hidden" id="editingId">
        <div class="form-group"><label>é¢˜å‹</label><select id="qType"></select></div>
        <div class="form-group"><label>éš¾åº¦ (1-5)</label><input type="number" id="qDifficulty" min="1" max="5" value="1"></div>
        <div class="form-group"><label>æ ‡ç­¾ (é€—å·åˆ†éš”)</label><input type="text" id="qTags" placeholder="ä¾‹å¦‚: è®¡ç®—æœºç½‘ç»œ, TCP/IP"></div>
        <div class="form-group"><label>é¢˜å¹²</label><textarea id="qContent" rows="5" oninput="updatePreview()"></textarea></div>
        <div class="form-group"><label>é€‰é¡¹ (æ¯è¡Œä¸€ä¸ª)</label><textarea id="qOptions" rows="4" oninput="updatePreview()"></textarea></div>
        <div class="form-group"><label>ç­”æ¡ˆ</label><input type="text" id="qAnswer" placeholder="ä¾‹å¦‚: A, æˆ– ABC"></div>
        <div class="form-group"><label>è§£æ</label><textarea id="qExplanation" rows="3"></textarea></div>
        <div class="preview-box">
            <h4>é¢„è§ˆ</h4>
            <div id="previewContent" class="q-content"></div>
            <div id="previewOptions" class="options"></div>
        </div>
    </div>
    <div class="drawer-footer">
        <button class="btn-secondary" onclick="closeDrawer()">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="saveQuestion()">ä¿å­˜</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const subjectId = {{ subject_id|int }};
    let allQuestions = [];
    const visibleCols = new Set(['id', 'q_type', 'content', 'actions']);

    document.addEventListener('DOMContentLoaded', () => {
        initColMenu();
        loadQuestionTypes();
        loadQuestions();
        document.getElementById('selectAll').addEventListener('change', (e) => {
            document.querySelectorAll('.questionSelect').forEach(cb => cb.checked = e.target.checked);
        });
    });

    function toggleDropdown(id) {
        const menu = document.getElementById(id);
        const isOpen = menu.classList.contains('open') || menu.style.display === 'block' || menu.style.display === 'flex';
        // å…ˆå…³é—­å…¶å®ƒèœå•
        document.querySelectorAll('.dropdown-menu').forEach(m => { m.classList.remove('open'); m.style.display = 'none'; });
        if (!isOpen) {
            menu.classList.add('open');
            if (id === 'batch-menu') {
                // å¼ºåˆ¶ä¸€è¡Œæ˜¾ç¤º
                menu.style.display = 'flex';
                menu.style.flexWrap = 'nowrap';
                menu.style.alignItems = 'center';
                menu.style.whiteSpace = 'nowrap';
                menu.style.gap = '8px';
            } else {
                menu.style.display = 'block';
            }
        }
    }

    function initColMenu() {
        const menu = document.getElementById('col-menu');
        const headers = document.querySelectorAll('th[data-col]');
        headers.forEach(h => {
            const col = h.dataset.col;
            if (col === 'actions') return;
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = visibleCols.has(col);
            checkbox.onchange = () => toggleColumn(col);
            label.appendChild(checkbox);
            label.append(` ${h.textContent}`);
            menu.appendChild(label);
        });
    }

    function toggleColumn(col) {
        if (visibleCols.has(col)) visibleCols.delete(col); else visibleCols.add(col);
        renderTable();
    }

    async function loadQuestionTypes() {
        const res = await fetch('/admin/types');
        const types = await res.json();
        const typeFilter = document.getElementById('typeFilter');
        const qTypeSelect = document.getElementById('qType');
        types.forEach(t => {
            typeFilter.add(new Option(t, t));
            qTypeSelect.add(new Option(t, t));
        });
    }

    async function loadQuestions() {
        const type = document.getElementById('typeFilter').value;
        try {
            const res = await fetch(`/admin/questions?subject_id=${subjectId}&type=${type}`);
            allQuestions = await res.json();
            updateStats();
            renderTable();
        } catch (error) {
            console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', error);
            showError('åŠ è½½é¢˜ç›®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
    }

    function updateStats() {
        const total = allQuestions.length;
        const choice = allQuestions.filter(q => q.q_type === 'é€‰æ‹©é¢˜').length;
        const blank = allQuestions.filter(q => q.q_type === 'å¡«ç©ºé¢˜').length;
        const judge = allQuestions.filter(q => q.q_type === 'åˆ¤æ–­é¢˜').length;
        
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statChoice').textContent = choice;
        document.getElementById('statBlank').textContent = blank;
        document.getElementById('statJudge').textContent = judge;
    }

    function getTypeBadgeClass(type) {
        if (type === 'é€‰æ‹©é¢˜') return 'choice';
        if (type === 'å¡«ç©ºé¢˜') return 'blank';
        if (type === 'åˆ¤æ–­é¢˜') return 'judge';
        return 'other';
    }

    function renderDifficulty(level) {
        const stars = 'â˜…'.repeat(level) + 'â˜†'.repeat(5 - level);
        return `<span class="difficulty-stars" title="éš¾åº¦: ${level}/5">${stars}</span>`;
    }

    function renderTags(tagsStr) {
        if (!tagsStr) return '';
        const tags = tagsStr.split(',').map(t => t.trim()).filter(Boolean);
        return `<div class="tag-list">${tags.map(t => `<span class="tag-item">${escapeHtml(t)}</span>`).join('')}</div>`;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function renderTable() {
        const tbody = document.getElementById('questionTableBody');
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        tbody.innerHTML = '';
        
        document.querySelectorAll('th[data-col]').forEach(th => {
            th.style.display = visibleCols.has(th.dataset.col) || th.dataset.col === 'actions' ? '' : 'none';
        });
        
        const filtered = allQuestions.filter(q => q.content.toLowerCase().includes(keyword));
        
        if (filtered.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div class="empty-state-text">æš‚æ— é¢˜ç›®æ•°æ®</div>
                        <div class="empty-state-hint">ç‚¹å‡»"æ–°å¢é¢˜ç›®"æŒ‰é’®æ·»åŠ ç¬¬ä¸€é“é¢˜ç›®</div>
                    </td>
                </tr>
            `;
            return;
        }
        
        filtered.forEach((q, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox" class="questionSelect" data-id="${q.id}"></td>
                <td style="display: ${visibleCols.has('id') ? '' : 'none'}; text-align: center;">${index + 1}</td>
                <td style="display: ${visibleCols.has('q_type') ? '' : 'none'}">
                    <span class="type-badge ${getTypeBadgeClass(q.q_type)}">${q.q_type}</span>
                </td>
                <td class="col-content" style="display: ${visibleCols.has('content') ? '' : 'none'}">${escapeHtml(q.content)}</td>
                <td style="display: ${visibleCols.has('difficulty') ? '' : 'none'}">${renderDifficulty(q.difficulty || 1)}</td>
                <td style="display: ${visibleCols.has('tags') ? '' : 'none'}">${renderTags(q.tags)}</td>
                <td style="display: ${visibleCols.has('created_by') ? '' : 'none'}; font-size: 13px;">${escapeHtml(q.created_by || '-')}</td>
                <td style="display: ${visibleCols.has('updated_at') ? '' : 'none'}; font-size: 12px; color: #6c757d;">
                    ${q.updated_at ? new Date(q.updated_at).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '-'}
                </td>
                <td>
                    <div class="action-btns">
                        <button class="btn-sm btn-edit" onclick="openDrawer(${q.id})" title="ç¼–è¾‘é¢˜ç›®">âœï¸ ç¼–è¾‘</button>
                        <button class="btn-sm btn-delete" onclick="deleteQuestion(${q.id})" title="åˆ é™¤é¢˜ç›®">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function showError(message) {
        alert('âŒ ' + message);
    }

    function showSuccess(message) {
        alert('âœ… ' + message);
    }

    function searchQuestions() { renderTable(); }

    function openDrawer(id = null) {
        document.getElementById('editingId').value = id;
        if (id) {
            document.getElementById('drawer-title').textContent = 'âœï¸ ä¿®æ”¹é¢˜ç›®';
            fetch(`/admin/questions/${id}`).then(r=>r.json()).then(full_q => {
                document.getElementById('qType').value = full_q.q_type;
                document.getElementById('qDifficulty').value = full_q.difficulty || 1;
                document.getElementById('qTags').value = full_q.tags || '';
                document.getElementById('qContent').value = full_q.content;
                document.getElementById('qOptions').value = (full_q.options && JSON.parse(full_q.options).join('\n')) || '';
                document.getElementById('qAnswer').value = full_q.answer;
                document.getElementById('qExplanation').value = full_q.explanation || '';
                updatePreview();
            });
        } else {
            document.getElementById('drawer-title').textContent = 'â• æ–°å¢é¢˜ç›®';
            ['qDifficulty', 'qTags', 'qContent', 'qOptions', 'qAnswer', 'qExplanation'].forEach(el => document.getElementById(el).value = '');
            document.getElementById('qDifficulty').value = 1;
            updatePreview();
        }
        document.getElementById('drawer').classList.add('open');
        document.getElementById('drawerOverlay').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeDrawer() { 
        document.getElementById('drawer').classList.remove('open');
        document.getElementById('drawerOverlay').classList.remove('show');
        document.body.style.overflow = '';
    }

    async function saveQuestion() {
        const id = document.getElementById('editingId').value;
        const content = document.getElementById('qContent').value.trim();
        const answer = document.getElementById('qAnswer').value.trim();
        
        if (!content) {
            showError('è¯·è¾“å…¥é¢˜å¹²å†…å®¹');
            return;
        }
        if (!answer) {
            showError('è¯·è¾“å…¥ç­”æ¡ˆ');
            return;
        }
        
        const options = document.getElementById('qOptions').value.trim().split('\n').filter(Boolean);
        const payload = {
            subject_id: subjectId,
            q_type: document.getElementById('qType').value,
            difficulty: parseInt(document.getElementById('qDifficulty').value) || 1,
            tags: document.getElementById('qTags').value.trim(),
            content: content,
            options: JSON.stringify(options),
            answer: answer,
            explanation: document.getElementById('qExplanation').value.trim(),
        };
        
        try {
            const url = id ? `/admin/questions/${id}` : '/admin/questions';
            const method = id ? 'PUT' : 'POST';
            const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await res.json();
            
            if (result.status === 'success') {
                showSuccess(result.message || (id ? 'é¢˜ç›®ä¿®æ”¹æˆåŠŸ' : 'é¢˜ç›®æ·»åŠ æˆåŠŸ'));
                closeDrawer();
                loadQuestions();
            } else {
                showError(result.message || 'æ“ä½œå¤±è´¥');
            }
        } catch (error) {
            console.error('ä¿å­˜é¢˜ç›®å¤±è´¥:', error);
            showError('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    async function deleteQuestion(id) {
        if (!confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤è¯¥é¢˜ç›®å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
        
        try {
            const res = await fetch(`/admin/questions/${id}`, { method: 'DELETE' });
            const result = await res.json();
            
            if (result.status === 'success') {
                showSuccess(result.message || 'é¢˜ç›®åˆ é™¤æˆåŠŸ');
                loadQuestions();
            } else {
                showError(result.message || 'åˆ é™¤å¤±è´¥');
            }
        } catch (error) {
            console.error('åˆ é™¤é¢˜ç›®å¤±è´¥:', error);
            showError('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    async function batchDeleteQuestions() {
        const ids = Array.from(document.querySelectorAll('.questionSelect:checked')).map(cb => cb.dataset.id);
        if (!ids.length) {
            showError('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¢˜ç›®');
            return;
        }
        
        if (!confirm(`âš ï¸ ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${ids.length} é“é¢˜ç›®å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
        
        try {
            const res = await fetch('/admin/questions/batch_delete', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ ids }) 
            });
            const result = await res.json();
            
            if (result.status === 'success') {
                showSuccess(result.message || `æˆåŠŸåˆ é™¤ ${ids.length} é“é¢˜ç›®`);
                loadQuestions();
            } else {
                showError(result.message || 'æ‰¹é‡åˆ é™¤å¤±è´¥');
            }
        } catch (error) {
            console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
            showError('æ‰¹é‡åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    function updatePreview() {
        document.getElementById('previewContent').innerHTML = document.getElementById('qContent').value.replace(/\n/g, '<br>');
        const opts = document.getElementById('qOptions').value.trim().split('\n').filter(Boolean);
        const optsHtml = opts.map(o => `<label>${o}</label>`).join('');
        document.getElementById('previewOptions').innerHTML = optsHtml;
    }

    // ======= æ‰¹é‡æ“ä½œ =======
    function getSelectedIds(){
        return Array.from(document.querySelectorAll('.questionSelect:checked')).map(cb => cb.dataset.id);
    }
    function openBatchMove(){
        fetch('/admin/api/subjects').then(r=>r.json()).then(list=>{
            const sel = document.getElementById('moveTarget');
            sel.innerHTML = '';
            list.forEach(s=> sel.add(new Option(`${s.name} (${s.question_count||0})`, s.id)) );
            openModal('modalMove');
        });
    }
    function openBatchDifficulty(){ openModal('modalDifficulty'); }
    let tagsAction = 'add';
    function openBatchTags(action){ tagsAction = action; document.getElementById('tagsTitle').innerText = `æ‰¹é‡æ ‡ç­¾ï¼ˆ${action==='add'?'æ·»åŠ ':action==='remove'?'ç§»é™¤':'è¦†ç›–'}ï¼‰`; openModal('modalTags'); }

    function openModal(id){ const m=document.getElementById(id); if(m){ m.style.display='block'; } }
    function closeModal(id){ const m=document.getElementById(id); if(m){ m.style.display='none'; } }

    async function doBatchMove(){
        const ids = getSelectedIds();
        if(!ids.length) return alert('è¯·å…ˆå‹¾é€‰é¢˜ç›®');
        const target = document.getElementById('moveTarget').value;
        const res = await fetch('/admin/questions/batch_move_subject', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids, target_subject_id: target })});
        const ret = await res.json(); alert(ret.message||'');
        if(ret.status==='success'){ closeModal('modalMove'); loadQuestions(); }
    }
    async function doBatchDifficulty(){
        const ids = getSelectedIds();
        if(!ids.length) return alert('è¯·å…ˆå‹¾é€‰é¢˜ç›®');
        const difficulty = parseInt(document.getElementById('diffValue').value)||1;
        const res = await fetch('/admin/questions/batch_set_difficulty', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids, difficulty })});
        const ret = await res.json(); alert(ret.message||'');
        if(ret.status==='success'){ closeModal('modalDifficulty'); loadQuestions(); }
    }
    async function doBatchTags(){
        const ids = getSelectedIds();
        if(!ids.length) return alert('è¯·å…ˆå‹¾é€‰é¢˜ç›®');
        const tags = document.getElementById('tagsInput').value.trim();
        if(!tags) return alert('è¯·è¾“å…¥æ ‡ç­¾');
        const res = await fetch('/admin/questions/batch_tags', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids, action: tagsAction, tags })});
        const ret = await res.json(); alert(ret.message||'');
        if(ret.status==='success'){ closeModal('modalTags'); loadQuestions(); }
    }

    // ======= å¯¼å…¥/å¯¼å‡º =======
    function openImportModal(){ openModal('modalImport'); document.getElementById('importPreview').innerHTML=''; }
    function renderImportPreview(){
        const txt = document.getElementById('importText').value.trim();
        const file = document.getElementById('importFile').files[0];
        if(txt){
            try{ const data = JSON.parse(txt); window.__importData = data; showImportPreview(data); }catch(e){ alert('ç²˜è´´å†…å®¹ä¸æ˜¯æœ‰æ•ˆJSON'); }
            return;
        }
        if(file){
            const fr = new FileReader();
            fr.onload = () => { try{ const data = JSON.parse(fr.result); window.__importData = data; showImportPreview(data);}catch(e){ alert('æ–‡ä»¶å†…å®¹ä¸æ˜¯æœ‰æ•ˆJSON'); } };
            fr.readAsText(file);
            return;
        }
        alert('è¯·ç²˜è´´JSONæˆ–é€‰æ‹©æ–‡ä»¶');
    }
    function showImportPreview(list){
        if(!Array.isArray(list)) { alert('JSONå¿…é¡»æ˜¯æ•°ç»„'); return; }
        const box = document.getElementById('importPreview');
        let ok=0, bad=0, html='';
        list.forEach((it, i)=>{
            const valid = it['é¢˜å‹'] && it['é¢˜å¹²']!==undefined && it['ç­”æ¡ˆ']!==undefined;
            if(valid) ok++; else bad++;
            html += `<div style="padding:6px; border-bottom:1px solid var(--border-color); ${valid?'':'background:#fff3cd'}">#${i+1} ${it['é¢˜å‹']||'(ç¼ºå°‘é¢˜å‹)'} - ${String(it['é¢˜å¹²']||'').slice(0,60)}</div>`;
        });
        box.innerHTML = `<div style="margin-bottom:6px;">å…± ${list.length} æ¡ï¼›æœ‰æ•ˆ ${ok}ï¼Œé—®é¢˜ ${bad}</div>` + html;
    }
    async function confirmImport(){
        const data = window.__importData;
        if(!Array.isArray(data) || !data.length) return alert('æš‚æ— å¯å¯¼å…¥æ•°æ®');
        const res = await fetch('/admin/questions/import', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ subject_id: subjectId, questions: data })});
        const ret = await res.json(); alert(ret.message||'');
        if(ret.status==='success'){ closeModal('modalImport'); loadQuestions(); }
    }
    function exportSubject(){ window.open(`/admin/questions/export?subject_id=${subjectId}`, '_blank'); }
    function exportAll(){ window.open('/admin/questions/export', '_blank'); }
</script>
{% endblock %}
