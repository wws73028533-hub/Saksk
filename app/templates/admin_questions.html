{% extends "admin_base.html" %}

{% block title %}é¢˜é›†ç®¡ç†{% endblock %}

{% block head %}
<style>
    body {
        background-color: #f8f9fa; /* Apple-like light gray background */
    }
    .container {
        background: #fff;
        padding: 28px;
        border-radius: 12px; /* Softer corners */
        box-shadow: 0 4px 12px rgba(0,0,0,0.06); /* More subtle shadow */
        border: 1px solid #e5e5e5;
    }
    
    /* é¡µé¢æ ‡é¢˜ */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 0;
        border-bottom: none;
    }
    .page-title {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .page-title-icon {
        font-size: 28px;
    }
    .subject-badge {
        display: inline-block;
        padding: 6px 14px;
        background-color: #e9ecef; /* Light gray, neutral background */
        color: #495057; /* Darker text for contrast */
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
    }
    
    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-row {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: nowrap; /* Ensure single line */
    }
    .stat-card {
        flex: 1;
        padding: 20px;
        border-radius: 12px;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        color: #333;
        box-shadow: none;
        transition: border-color 0.2s, background-color 0.2s;
        text-align: center;
    }
    .stat-card:hover {
        border-color: #ced4da;
        background-color: #f1f3f5;
    }
    .stat-card-label {
        font-size: 13px;
        color: #6c757d;
        margin-bottom: 8px;
    }
    .stat-card-value {
        font-size: 32px;
        font-weight: 600;
        line-height: 1.2;
        color: #212529;
    }
    
    /* å·¥å…·æ å’ŒæŒ‰é’® */
    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        gap: 12px;
        flex-wrap: wrap;
    }
    .toolbar-left, .toolbar-right {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .btn, .btn-primary, .btn-secondary, .btn-danger, .btn-outline {
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 8px;
        border: 1px solid transparent; /* Use border for consistent sizing */
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .btn-primary {
        background-color: #007aff; /* Apple Blue */
        color: white;
    }
    .btn-primary:hover {
        background-color: #005ecb;
    }

    .btn-danger {
        background-color: #ff3b30; /* Apple Red */
        color: white;
    }
    .btn-danger:hover {
        background-color: #d92c23;
    }

    .btn-secondary, .btn-outline {
        background-color: #f8f9fa;
        color: #333;
        border-color: #dee2e6;
    }
    .btn-secondary:hover, .btn-outline:hover {
        background-color: #e9ecef;
        border-color: #ced4da;
    }
    
    /* æœç´¢æ¡†ä¼˜åŒ– */
    .search-box {
        position: relative;
        display: inline-block;
    }
    .search-box input {
        padding-left: 36px;
        width: 220px;
        transition: width 0.3s, border-color 0.3s;
    }
    .search-box input:focus {
        width: 280px;
        border-color: #667eea;
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        pointer-events: none;
        font-size: 16px;
    }
    
    /* ä¸‹æ‹‰èœå•ä¼˜åŒ– */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-menu { 
        display: none; 
        position: absolute; 
        left: 0; 
        top: 100%; 
        margin-top: 8px; 
        background: #fff; 
        border: 1px solid var(--border-color); 
        border-radius: 8px; 
        padding: 8px; 
        z-index: 10;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideDown 0.2s ease;
    }
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    #batch-menu { min-width: auto; white-space: nowrap; width: max-content; height: auto; }
    .dropdown-menu.open { display: block; }
    #batch-menu.open { 
        display: flex; 
        flex-wrap: nowrap; 
        align-items: center; 
        gap: 8px; 
        white-space: nowrap; 
    }
    #batch-menu[style*="display: block"] { 
        display: flex !important; 
        flex-wrap: nowrap; 
        align-items: center; 
        gap: 8px; 
        white-space: nowrap; 
    }
    #batch-menu .btn { 
        display: inline-flex; 
        width: auto; 
        white-space: nowrap;
        padding: 6px 12px;
        font-size: 13px;
    }
    .dropdown-menu label { 
        display: block; 
        margin-bottom: 8px; 
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s;
    }
    .dropdown-menu label:hover {
        background: #f8f9fa;
    }
    .dropdown-menu label input {
        margin-right: 8px;
    }
    
    /* è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†ä¼˜åŒ– */
    input[type="text"], 
    input[type="number"],
    select { 
        padding: 8px 12px; 
        border: 1px solid var(--border-color); 
        border-radius: 6px; 
        font-size: 14px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
        border-color: #667eea;
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* è¡¨æ ¼ä¼˜åŒ– */
    .table-wrapper { 
        overflow-x: auto;
        border-radius: 12px;
        border: 1px solid #e5e5e5;
        background-color: #fff;
    }
    table { 
        width: 100%; 
        border-collapse: collapse; 
    }
    th, td { 
        border-bottom: 1px solid #e5e5e5; 
        padding: 16px;
        text-align: left; 
        white-space: nowrap; 
        vertical-align: middle; 
    }
    tbody tr:last-child td {
        border-bottom: none; /* Remove border from last row */
    }
    thead { 
        position: sticky; 
        top: 0; 
        z-index: 5; 
    }
    th { 
        background-color: #f8f9fa;
        font-weight: 500;
        color: #6c757d;
        font-size: 13px;
        text-transform: none;
        letter-spacing: 0;
    }
    tbody tr {
        transition: background-color 0.15s ease-in-out;
    }
    tbody tr:hover { 
        background-color: #f8f9fa;
    }
    .col-content { 
        min-width: 300px; 
        max-width: 500px;
        white-space: normal; 
        line-height: 1.6;
    }
    
    /* é¢˜å‹æ ‡ç­¾ */
    .type-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    .type-badge.choice { background: #d4edda; color: #155724; }
    .type-badge.blank { background: #fff3cd; color: #856404; }
    .type-badge.judge { background: #cce5ff; color: #004085; }
    .type-badge.other { background: #f8d7da; color: #721c24; }
    
    /* éš¾åº¦æ˜¾ç¤º */
    .difficulty-stars {
        color: #ffc107;
        font-size: 14px;
    }
    
    /* æ ‡ç­¾æ˜¾ç¤º */
    .tag-list {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
    }
    .tag-item {
        display: inline-block;
        padding: 2px 8px;
        background: #e7f1ff;
        color: #0b61d8;
        border-radius: 10px;
        font-size: 11px;
    }
    
    /* æ“ä½œæŒ‰é’®ä¼˜åŒ– */
    .action-btns {
        display: flex;
        gap: 8px;
        flex-wrap: nowrap;
    }
    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: 6px;
        border: 1px solid transparent;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        white-space: nowrap;
    }
    .btn-sm:hover {
        transform: none;
        box-shadow: none;
    }
    .btn-edit {
        background-color: #e9ecef;
        color: #343a40;
    }
    .btn-edit:hover {
        background-color: #dee2e6;
    }
    .btn-delete {
        background-color: #ffeef0;
        color: #ff3b30;
    }
    .btn-delete:hover {
        background-color: #ffdcdf;
    }

    /* æŠ½å±‰ä¼˜åŒ– */
    .drawer {
        position: fixed;
        top: 0;
        right: 0;
        width: 520px;
        height: 100%;
        background: #f8f9fa; /* Lighter background */
        box-shadow: -4px 0 25px rgba(0,0,0,0.1);
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        z-index: 100;
        display: flex;
        flex-direction: column;
    }
    .drawer.open {
        transform: translateX(0);
    }
    .drawer-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.4);
        z-index: 99;
        display: none;
        opacity: 0;
        transition: opacity 0.4s ease;
    }
    .drawer-overlay.show {
        display: block;
        opacity: 1;
    }
    .drawer-header {
        padding: 16px 24px;
        border-bottom: 1px solid #e5e5e5;
        font-size: 18px;
        font-weight: 600;
        background-color: #fff;
        color: #212529;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }
    .drawer-close {
        background: #e9ecef;
        border: none;
        color: #6c757d;
        font-size: 20px;
        font-weight: bold;
        cursor: pointer;
        padding: 0;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background-color 0.2s, color 0.2s;
    }
    .drawer-close:hover {
        background: #dee2e6;
        color: #212529;
    }
    .drawer-body {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        background-color: #fff;
    }
    .form-group {
        margin-bottom: 20px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 500;
        color: #495057;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #ced4da;
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 14px;
        background-color: #fff;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        border-color: #007aff;
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
    }
    .drawer-footer {
        padding: 16px 24px;
        border-top: 1px solid #e5e5e5;
        text-align: right;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        background-color: #f8f9fa;
        flex-shrink: 0;
    }

    /* é¢„è§ˆæ¡†ä¼˜åŒ– */
    .preview-box { 
        margin-top: 20px; 
        padding: 20px; 
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 12px;
        border: 1px solid #dee2e6;
    }
    .preview-box h4 {
        margin: 0 0 16px 0;
        color: #495057;
        font-size: 16px;
    }
    .preview-box .q-content { 
        font-size: 15px; 
        font-weight: 500; 
        margin-bottom: 16px;
        color: #212529;
        line-height: 1.6;
    }
    .preview-box .options label { 
        display: block; 
        padding: 12px 16px; 
        margin-bottom: 10px; 
        background: white;
        border: 2px solid #dee2e6; 
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .preview-box .options label:hover {
        border-color: #667eea;
        background: #f8f9fa;
    }
    
    /* æ¨¡æ€æ¡†ä¼˜åŒ– */
    .modal-drawer {
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 101;
        display: none;
        max-width: 90vw;
        max-height: 90vh;
        overflow: hidden;
        animation: modalSlideIn 0.3s ease;
    }
    @keyframes modalSlideIn {
        from { opacity: 0; transform: translate(-50%, -45%); }
        to { opacity: 1; transform: translate(-50%, -50%); }
    }
    .modal-drawer.show {
        display: flex;
        flex-direction: column;
    }
    
    /* å¯¼å…¥é¢„è§ˆ */
    #importPreview {
        max-height: 300px;
        overflow: auto;
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }
    #importPreview > div {
        padding: 8px;
        border-bottom: 1px solid #dee2e6;
        font-size: 13px;
    }
    #importPreview > div:last-child {
        border-bottom: none;
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }
    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    .empty-state-text {
        font-size: 16px;
        margin-bottom: 8px;
    }
    .empty-state-hint {
        font-size: 14px;
        color: #adb5bd;
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading-row {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header">
        <div class="page-title">
            <span class="page-title-icon">ğŸ“š</span>
            <span>é¢˜ç›®ç®¡ç†</span>
            <span class="subject-badge" id="subjectName">{{ subject.name if subject else 'ç§‘ç›®' }}</span>
        </div>
        <button class="btn-secondary" onclick="window.location.href='/admin/subjects'">â† è¿”å›ç§‘ç›®åˆ—è¡¨</button>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-row">
        <div class="stat-card total">
            <div class="stat-card-label">æ€»é¢˜ç›®æ•°</div>
            <div class="stat-card-value" id="statTotal">0</div>
        </div>
        <div class="stat-card choice">
            <div class="stat-card-label">é€‰æ‹©é¢˜</div>
            <div class="stat-card-value" id="statChoice">0</div>
        </div>
        <div class="stat-card blank">
            <div class="stat-card-label">å¡«ç©ºé¢˜</div>
            <div class="stat-card-value" id="statBlank">0</div>
        </div>
        <div class="stat-card judge">
            <div class="stat-card-label">åˆ¤æ–­é¢˜</div>
            <div class="stat-card-value" id="statJudge">0</div>
        </div>
    </div>

    <!-- å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-left">
            <button class="btn-primary" onclick="openDrawer()">â• æ–°å¢é¢˜ç›®</button>
            <button class="btn-danger" id="batchDeleteBtn" onclick="batchDeleteQuestions()">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤</button>
            <div class="dropdown">
                <button class="btn-outline" onclick="toggleDropdown('batch-menu')">âš™ï¸ æ‰¹é‡æ“ä½œ â–¾</button>
                <div id="batch-menu" class="dropdown-menu">
                    <button class="btn" onclick="openBatchMove()">ğŸ“¦ ç§»åŠ¨ç§‘ç›®</button>
                    <button class="btn" onclick="openBatchTypeChange()">ğŸ”„ ä¿®æ”¹é¢˜å‹</button>
                    <button class="btn" onclick="openBatchDifficulty()">â­ è®¾ç½®éš¾åº¦</button>
                    <button class="btn" onclick="openBatchTags()">ğŸ·ï¸ ä¿®æ”¹æ ‡ç­¾</button>
                </div>
            </div>
        </div>
        <div class="toolbar-right">
            <button class="btn-outline" onclick="openImportModal()">ğŸ“¥ å¯¼å…¥é¢˜åº“</button>
            <button class="btn-outline" onclick="exportSubject()">ğŸ“¤ å¯¼å‡ºæœ¬ç§‘ç›®</button>
            <button class="btn-primary" onclick="exportPackage()">ğŸ“¦ å¯¼å‡ºé¢˜ç›®åŒ…</button>
            <button class="btn-primary" onclick="document.getElementById('importPackageFile').click()">ğŸ“¥ å¯¼å…¥é¢˜ç›®åŒ…</button>
            <input type="file" id="importPackageFile" style="display: none;" accept=".zip" onchange="uploadPackage()">
            <select id="typeFilter" onchange="loadQuestions()">
                <option value="all">ğŸ“‹ å…¨éƒ¨é¢˜å‹</option>
            </select>
            <div class="dropdown">
                <button class="btn-outline" onclick="toggleDropdown('col-menu')">ğŸ‘ï¸ æ˜¾ç¤ºåˆ— â–¾</button>
                <div id="col-menu" class="dropdown-menu"></div>
            </div>
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="searchInput" placeholder="      æœç´¢é¢˜å¹²å†…å®¹..." oninput="searchQuestions()">
            </div>
        </div>
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th style="width:50px;"><input type="checkbox" id="selectAll"></th>
                    <th data-col="id" style="width:80px;">åºå·</th>
                    <th data-col="q_type" style="width:100px;">é¢˜å‹</th>
                    <th data-col="content" class="col-content">é¢˜å¹²</th>
                    <th data-col="difficulty" style="width:100px;">éš¾åº¦</th>
                    <th data-col="tags" style="width:150px;">æ ‡ç­¾</th>
                    <th data-col="created_by" style="width:100px;">åˆ›å»ºè€…</th>
                    <th data-col="updated_at" style="width:160px;">æ›´æ–°æ—¶é—´</th>
                    <th data-col="actions" style="width:180px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="questionTableBody">
                <tr>
                    <td colspan="9" class="loading-row">
                        <span class="loading-spinner"></span>
                        <span>åŠ è½½ä¸­...</span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- æŠ½å±‰é®ç½© -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

<!-- Batch Modals -->
<div id="modalMove" class="drawer" style="right:auto; left:50%; transform: translateX(-50%); width: 420px; height:auto; top: 15%; display:none;">
  <div class="drawer-header">æ‰¹é‡ç§»åŠ¨åˆ°ç§‘ç›®</div>
  <div class="drawer-body">
    <div class="form-group"><label>ç›®æ ‡ç§‘ç›®</label><select id="moveTarget"></select></div>
    <div class="form-group"><small>å°†æŠŠå·²å‹¾é€‰çš„é¢˜ç›®ç§»åŠ¨åˆ°æ‰€é€‰ç§‘ç›®ã€‚</small></div>
  </div>
  <div class="drawer-footer">
    <button class="btn-secondary" onclick="closeModal('modalMove')">å–æ¶ˆ</button>
    <button class="btn-primary" onclick="doBatchMove()">ç¡®å®š</button>
  </div>
</div>

<div id="modalTypeChange" class="drawer" style="right:auto; left:50%; transform: translateX(-50%); width: 420px; height:auto; top: 15%; display:none;">
  <div class="drawer-header">æ‰¹é‡ä¿®æ”¹é¢˜å‹</div>
  <div class="drawer-body">
    <div class="form-group"><label>ç›®æ ‡é¢˜å‹</label><select id="typeChangeTarget"></select></div>
    <div class="form-group"><small>å°†æŠŠå·²å‹¾é€‰çš„é¢˜ç›®ä¿®æ”¹ä¸ºæ‰€é€‰é¢˜å‹ã€‚</small></div>
  </div>
  <div class="drawer-footer">
    <button class="btn-secondary" onclick="closeModal('modalTypeChange')">å–æ¶ˆ</button>
    <button class="btn-primary" onclick="doBatchTypeChange()">ç¡®å®š</button>
  </div>
</div>

<div id="modalDifficulty" class="drawer" style="right:auto; left:50%; transform: translateX(-50%); width: 420px; height:auto; top: 20%; display:none;">
  <div class="drawer-header">æ‰¹é‡è®¾ç½®éš¾åº¦</div>
  <div class="drawer-body">
    <div class="form-group"><label>éš¾åº¦ (1-5)</label><input type="number" id="diffValue" min="1" max="5" value="1"></div>
  </div>
  <div class="drawer-footer">
    <button class="btn-secondary" onclick="closeModal('modalDifficulty')">å–æ¶ˆ</button>
    <button class="btn-primary" onclick="doBatchDifficulty()">ç¡®å®š</button>
  </div>
</div>

<div id="modalTags" class="drawer" style="right:auto; left:50%; transform: translateX(-50%); width: 420px; height:auto; top: 20%; display:none;">
  <div class="drawer-header" id="tagsTitle">æ‰¹é‡æ ‡ç­¾</div>
  <div class="drawer-body">
    <div class="form-group"><label>æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label><input type="text" id="tagsInput" placeholder="ä¾‹å¦‚ï¼šç½‘ç»œ, è·¯ç”±"></div>
  </div>
  <div class="drawer-footer">
    <button class="btn-secondary" onclick="closeModal('modalTags')">å–æ¶ˆ</button>
    <button class="btn-primary" onclick="doBatchTags()">ç¡®å®š</button>
  </div>
</div>

<div id="modalImport" class="drawer" style="right:auto; left:50%; transform: translateX(-50%); width: 620px; height: 70%; top: 10%; display:none;">
  <div class="drawer-header">å¯¼å…¥é¢˜åº“ï¼ˆé¢„è§ˆï¼‰</div>
  <div class="drawer-body">
    <div class="form-group"><label>ç²˜è´´JSONæ•°ç»„</label><textarea id="importText" rows="8" placeholder='[{"é¢˜å‹":"é€‰æ‹©é¢˜","é¢˜å¹²":"...","é€‰é¡¹":["A","B"],"ç­”æ¡ˆ":"A","è§£æ":"..."}]'></textarea></div>
    <div class="form-group"><label>æˆ– é€‰æ‹©JSONæ–‡ä»¶</label><input type="file" id="importFile" accept="application/json"></div>
    <div class="form-group"><button class="btn-outline" onclick="renderImportPreview()">é¢„è§ˆ</button></div>
    <div class="form-group"><div id="importPreview" style="max-height:220px; overflow:auto; background:#f8f9fa; padding:10px; border-radius:6px; border:1px solid var(--border-color);"></div></div>
  </div>
  <div class="drawer-footer">
    <button class="btn-secondary" onclick="closeModal('modalImport')">å–æ¶ˆ</button>
    <button class="btn-primary" onclick="confirmImport()">ç¡®è®¤å¯¼å…¥</button>
  </div>
</div>

<!-- Edit/Add Drawer -->
<div id="drawer" class="drawer">
    <div class="drawer-header">
        <span id="drawer-title">æ–°å¢é¢˜ç›®</span>
        <button class="drawer-close" onclick="closeDrawer()">Ã—</button>
    </div>
    <div class="drawer-body">
        <input type="hidden" id="editingId">
        <div class="form-group"><label>é¢˜å‹</label><select id="qType"></select></div>
        <div class="form-group"><label>éš¾åº¦ (1-5)</label><input type="number" id="qDifficulty" min="1" max="5" value="1"></div>
        <div class="form-group"><label>æ ‡ç­¾ (é€—å·åˆ†éš”)</label><input type="text" id="qTags" placeholder="ä¾‹å¦‚: è®¡ç®—æœºç½‘ç»œ, TCP/IP"></div>
        <div class="form-group"><label>é¢˜å¹²</label><textarea id="qContent" rows="5" oninput="updatePreview()"></textarea></div>
        <div class="form-group"><label>é€‰é¡¹ (æ¯è¡Œä¸€ä¸ª)</label><textarea id="qOptions" rows="4" oninput="updatePreview()"></textarea></div>
                <div class="form-group">
            <label>ç­”æ¡ˆ</label>
            <div id="answer-container">
                <!-- ç­”æ¡ˆè¾“å…¥æ§ä»¶å°†åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
        </div>
        <div class="form-group"><label>è§£æ</label><textarea id="qExplanation" rows="3"></textarea></div>
        <div class="form-group">
            <label>é¢˜ç›®å›¾ç‰‡</label>
            <input type="file" id="qImageFile" accept="image/*" onchange="uploadImage()" multiple>
            <input type="hidden" id="qImagePaths">
            <div id="imagePreviewContainer" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;">
                <!-- Image previews will be generated here -->
            </div>
        </div>
        <div class="preview-box">
            <h4>é¢„è§ˆ</h4>
            <div id="previewContent" class="q-content"></div>
            <div id="previewOptions" class="options"></div>
        </div>
    </div>
    <div class="drawer-footer">
        <button class="btn-secondary" onclick="closeDrawer()">å–æ¶ˆ</button>
        <button class="btn-primary" onclick="saveQuestion()">ä¿å­˜</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const subjectId = {{ subject_id|int }};
    let allQuestions = [];
    const visibleCols = new Set(['id', 'q_type', 'content', 'actions']);

    document.addEventListener('DOMContentLoaded', () => {
        initColMenu();
        loadQuestionTypes();
        loadQuestions();
        document.getElementById('selectAll').addEventListener('change', (e) => {
            document.querySelectorAll('.questionSelect').forEach(cb => cb.checked = e.target.checked);
        });
    });

    function toggleDropdown(id) {
        const menu = document.getElementById(id);
        const isOpen = menu.classList.contains('open') || menu.style.display === 'block' || menu.style.display === 'flex';
        // å…ˆå…³é—­å…¶å®ƒèœå•
        document.querySelectorAll('.dropdown-menu').forEach(m => { m.classList.remove('open'); m.style.display = 'none'; });
        if (!isOpen) {
            menu.classList.add('open');
            if (id === 'batch-menu') {
                // å¼ºåˆ¶ä¸€è¡Œæ˜¾ç¤º
                menu.style.display = 'flex';
                menu.style.flexWrap = 'nowrap';
                menu.style.alignItems = 'center';
                menu.style.whiteSpace = 'nowrap';
                menu.style.gap = '8px';
            } else {
                menu.style.display = 'block';
            }
        }
    }

    function initColMenu() {
        const menu = document.getElementById('col-menu');
        const headers = document.querySelectorAll('th[data-col]');
        headers.forEach(h => {
            const col = h.dataset.col;
            if (col === 'actions') return;
            const label = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = visibleCols.has(col);
            checkbox.onchange = () => toggleColumn(col);
            label.appendChild(checkbox);
            label.append(` ${h.textContent}`);
            menu.appendChild(label);
        });
    }

    function toggleColumn(col) {
        if (visibleCols.has(col)) visibleCols.delete(col); else visibleCols.add(col);
        renderTable();
    }

    async function loadQuestionTypes() {
        const res = await fetch('/admin/types');
        const types = await res.json();
        const typeFilter = document.getElementById('typeFilter');
        const qTypeSelect = document.getElementById('qType');
        types.forEach(t => {
            typeFilter.add(new Option(t, t));
            qTypeSelect.add(new Option(t, t));
        });
    }

    async function loadQuestions() {
        const type = document.getElementById('typeFilter').value;
        try {
            const res = await fetch(`/admin/questions?subject_id=${subjectId}&type=${type}`);
            allQuestions = await res.json();
            updateStats();
            renderTable();
        } catch (error) {
            console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', error);
            showError('åŠ è½½é¢˜ç›®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
    }

    function updateStats() {
        const total = allQuestions.length;
        const choice = allQuestions.filter(q => q.q_type === 'é€‰æ‹©é¢˜').length;
        const blank = allQuestions.filter(q => q.q_type === 'å¡«ç©ºé¢˜').length;
        const judge = allQuestions.filter(q => q.q_type === 'åˆ¤æ–­é¢˜').length;
        
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statChoice').textContent = choice;
        document.getElementById('statBlank').textContent = blank;
        document.getElementById('statJudge').textContent = judge;
    }

    function getTypeBadgeClass(type) {
        if (type === 'é€‰æ‹©é¢˜') return 'choice';
        if (type === 'å¡«ç©ºé¢˜') return 'blank';
        if (type === 'åˆ¤æ–­é¢˜') return 'judge';
        return 'other';
    }

    function renderDifficulty(level) {
        const stars = 'â˜…'.repeat(level) + 'â˜†'.repeat(5 - level);
        return `<span class="difficulty-stars" title="éš¾åº¦: ${level}/5">${stars}</span>`;
    }

    function renderTags(tagsStr) {
        if (!tagsStr) return '';
        const tags = tagsStr.split(',').map(t => t.trim()).filter(Boolean);
        return `<div class="tag-list">${tags.map(t => `<span class="tag-item">${escapeHtml(t)}</span>`).join('')}</div>`;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function renderTable() {
        const tbody = document.getElementById('questionTableBody');
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        tbody.innerHTML = '';
        
        document.querySelectorAll('th[data-col]').forEach(th => {
            th.style.display = visibleCols.has(th.dataset.col) || th.dataset.col === 'actions' ? '' : 'none';
        });
        
        const filtered = allQuestions.filter(q => q.content.toLowerCase().includes(keyword));
        
        if (filtered.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div class="empty-state-text">æš‚æ— é¢˜ç›®æ•°æ®</div>
                        <div class="empty-state-hint">ç‚¹å‡»"æ–°å¢é¢˜ç›®"æŒ‰é’®æ·»åŠ ç¬¬ä¸€é“é¢˜ç›®</div>
                    </td>
                </tr>
            `;
            return;
        }
        
        filtered.forEach((q, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox" class="questionSelect" data-id="${q.id}"></td>
                <td style="display: ${visibleCols.has('id') ? '' : 'none'}; text-align: center;">${index + 1}</td>
                <td style="display: ${visibleCols.has('q_type') ? '' : 'none'}">
                    <span class="type-badge ${getTypeBadgeClass(q.q_type)}">${q.q_type}</span>
                </td>
                <td class="col-content" style="display: ${visibleCols.has('content') ? '' : 'none'}">${escapeHtml(q.content)}</td>
                <td style="display: ${visibleCols.has('difficulty') ? '' : 'none'}">${renderDifficulty(q.difficulty || 1)}</td>
                <td style="display: ${visibleCols.has('tags') ? '' : 'none'}">${renderTags(q.tags)}</td>
                <td style="display: ${visibleCols.has('created_by') ? '' : 'none'}; font-size: 13px;">${escapeHtml(q.created_by || '-')}</td>
                <td style="display: ${visibleCols.has('updated_at') ? '' : 'none'}; font-size: 12px; color: #6c757d;">
                    ${q.updated_at ? new Date(q.updated_at).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '-'}
                </td>
                <td>
                    <div class="action-btns">
                        <button class="btn-sm btn-edit" onclick="openDrawer(${q.id})" title="ç¼–è¾‘é¢˜ç›®">âœï¸ ç¼–è¾‘</button>
                        <button class="btn-sm btn-delete" onclick="deleteQuestion(${q.id})" title="åˆ é™¤é¢˜ç›®">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function showError(message) {
        alert('âŒ ' + message);
    }

    function showSuccess(message) {
        alert('âœ… ' + message);
    }

    function searchQuestions() { renderTable(); }

    function rebuildAnswerInput(defaultValue = '') {
        const qType = document.getElementById('qType').value;
        const container = document.getElementById('answer-container');
        container.innerHTML = ''; // Clear previous input

        let inputElement;

        if (qType === 'åˆ¤æ–­é¢˜') {
            inputElement = document.createElement('select');
            inputElement.id = 'qAnswer';
            
            const optionTrue = new Option('æ­£ç¡®', 'æ­£ç¡®');
            const optionFalse = new Option('é”™è¯¯', 'é”™è¯¯');
            
            inputElement.add(optionTrue);
            inputElement.add(optionFalse);
            
            if (defaultValue) {
                inputElement.value = defaultValue;
            }

        } else if (['é—®ç­”é¢˜', 'è®¡ç®—é¢˜', 'ç®€ç­”é¢˜'].includes(qType)) {
            inputElement = document.createElement('textarea');
            inputElement.id = 'qAnswer';
            inputElement.rows = 4;
            inputElement.placeholder = 'è¯·è¾“å…¥è¯¦ç»†ç­”æ¡ˆ';
            inputElement.value = defaultValue;

        } else { // For 'é€‰æ‹©é¢˜', 'å¤šé€‰é¢˜', 'å¡«ç©ºé¢˜' etc.
            inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.id = 'qAnswer';
            if (qType === 'é€‰æ‹©é¢˜' || qType === 'å¤šé€‰é¢˜') {
                 inputElement.placeholder = 'ä¾‹å¦‚: A, æˆ– ABC';
            } else if (qType === 'å¡«ç©ºé¢˜') {
                // å¡«ç©ºé¢˜ï¼šç»“æ„åŒ–å¤šç©º/å¤šç­”æ¡ˆç¼–è¾‘å™¨ï¼ˆä¿å­˜æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆ answer å­—ç¬¦ä¸²ï¼‰
                container.innerHTML = `
                  <div id="blank-editor" style="border:1px solid #e9ecef; background:#fbfbfd; border-radius:12px; padding:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; margin-bottom:10px;">
                      <div>
                        <div style="font-weight:700;">ç»“æ„åŒ–ç­”æ¡ˆï¼ˆæ¨èï¼‰</div>
                        <div style="font-size:12px; color:#6c757d; margin-top:2px;">è§„åˆ™ï¼šä¸åŒç©ºç”¨ <b>;;</b> åˆ†éš”ä¿å­˜ï¼›åŒä¸€ç©ºå¤šç­”æ¡ˆç”¨ <b>;</b> åˆ†éš”ä¿å­˜ã€‚</div>
                      </div>
                      <div style="display:flex; gap:8px; align-items:center;">
                        <button type="button" class="btn-sm" style="padding:6px 10px; border:1px solid #dee2e6; background:#fff; border-radius:8px; cursor:pointer;" onclick="blankEditorAddBlank()">+ å¢åŠ ä¸€ç©º</button>
                        <button type="button" class="btn-sm" style="padding:6px 10px; border:1px solid #dee2e6; background:#fff; border-radius:8px; cursor:pointer;" onclick="blankEditorToggleRaw(true)">æ‰‹å†™æ¨¡å¼</button>
                      </div>
                    </div>

                    <div id="blank-groups" style="display:flex; flex-direction:column; gap:10px;"></div>

                    <div id="blank-raw" style="display:none; margin-top:10px;">
                      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px;">
                        <div style="font-weight:600;">æ‰‹å†™ç­”æ¡ˆ</div>
                        <button type="button" class="btn-sm" style="padding:6px 10px; border:1px solid #dee2e6; background:#fff; border-radius:8px; cursor:pointer;" onclick="blankEditorToggleRaw(false)">è¿”å›ç»“æ„åŒ–</button>
                      </div>
                      <input id="blank-raw-input" type="text" style="width:100%; padding:10px 14px; border:1px solid #ced4da; border-radius:8px; font-size:14px;" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬;åŒ—å¹³;;ä¸Šæµ·;æ²ª" />
                      <div style="font-size:12px; color:#6c757d; margin-top:6px;">æç¤ºï¼šä½ ä»å¯ç›´æ¥æ‰‹å†™ï¼›åˆ‡å›ç»“æ„åŒ–ä¼šå°è¯•è‡ªåŠ¨è§£æã€‚</div>
                    </div>

                    <!-- æœ€ç»ˆæäº¤ç»™åç«¯çš„ answer å­—æ®µ -->
                    <input type="hidden" id="qAnswer" value="" />
                  </div>
                `;

                // åˆå§‹åŒ–ï¼šåŸºäºé¢˜å¹² __ æ•°é‡ + é»˜è®¤ç­”æ¡ˆ defaultValue
                blankEditorInitFromContentAndAnswer(document.getElementById('qContent')?.value || '', defaultValue);

                return;
            }
            else {
                inputElement.placeholder = 'è¯·è¾“å…¥ç­”æ¡ˆ';
            }
            inputElement.value = defaultValue;
        }
        
        // Common properties for all inputs
        inputElement.style.width = '100%';
        inputElement.style.padding = '10px 14px';
        inputElement.style.border = '1px solid #ced4da';
        inputElement.style.borderRadius = '8px';
        inputElement.style.fontSize = '14px';

        container.appendChild(inputElement);
    }

    function handleQuestionTypeChange() {
        rebuildAnswerInput(); // Rebuild based on new type
        const optionsGroup = document.getElementById('qOptions').parentElement;
        const qType = document.getElementById('qType').value;
        if (qType === 'é€‰æ‹©é¢˜' || qType === 'å¤šé€‰é¢˜') {
            optionsGroup.style.display = 'block';
        } else {
            optionsGroup.style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('qType').addEventListener('change', handleQuestionTypeChange);
    });

    function openDrawer(id = null) {
        document.getElementById('editingId').value = id;
        if (id) {
            document.getElementById('drawer-title').textContent = 'âœï¸ ä¿®æ”¹é¢˜ç›®';
            fetch(`/admin/questions/${id}`).then(r=>r.json()).then(full_q => {
                document.getElementById('qType').value = full_q.q_type;
                // Manually trigger change to rebuild UI elements for the correct type
                handleQuestionTypeChange();
                
                document.getElementById('qDifficulty').value = full_q.difficulty || 1;
                document.getElementById('qTags').value = full_q.tags || '';
                document.getElementById('qContent').value = full_q.content;
                document.getElementById('qOptions').value = (full_q.options && JSON.parse(full_q.options).join('\n')) || '';
                
                // Set answer value on the newly created element
                // å¡«ç©ºé¢˜ï¼šç”¨ç»“æ„åŒ–ç¼–è¾‘å™¨å›å¡«
                if (full_q.q_type === 'å¡«ç©ºé¢˜') {
                    blankEditorInitFromContentAndAnswer(full_q.content || '', full_q.answer || '');
                } else {
                    const answerInput = document.getElementById('qAnswer');
                    if(answerInput) answerInput.value = full_q.answer;
                }

                document.getElementById('qExplanation').value = full_q.explanation || '';

                // New image handling
                try {
                    const imagePaths = JSON.parse(full_q.image_path || '[]');
                    setImagePaths(imagePaths);
                } catch (e) {
                    setImagePaths([]); // Clear on parse error
                }

                updatePreview();
            });
        } else {
            document.getElementById('drawer-title').textContent = 'â• æ–°å¢é¢˜ç›®';
            // Reset all fields
            ['qDifficulty', 'qTags', 'qContent', 'qOptions', 'qExplanation'].forEach(elId => document.getElementById(elId).value = '');
            document.getElementById('qDifficulty').value = 1;
            document.getElementById('qType').selectedIndex = 0; // Reset to first type
            handleQuestionTypeChange(); // Build UI for default type
            setImagePaths([]); // Clear image previews for new question
            updatePreview();
        }
        document.getElementById('drawer').classList.add('open');
        document.getElementById('drawerOverlay').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeDrawer() { 
        document.getElementById('drawer').classList.remove('open');
        document.getElementById('drawerOverlay').classList.remove('show');
        document.body.style.overflow = '';
    }

    async function saveQuestion() {
        const id = document.getElementById('editingId').value;
        const content = document.getElementById('qContent').value.trim();
        const answerInput = document.getElementById('qAnswer');
        const answer = answerInput ? answerInput.value.trim() : '';
        
        if (!content) {
            showError('è¯·è¾“å…¥é¢˜å¹²å†…å®¹');
            return;
        }
        if (!answer) {
            showError('è¯·è¾“å…¥ç­”æ¡ˆ');
            return;
        }
        
        const options = document.getElementById('qOptions').value.trim().split('\n').filter(Boolean);
        const payload = {
            subject_id: subjectId,
            q_type: document.getElementById('qType').value,
            difficulty: parseInt(document.getElementById('qDifficulty').value) || 1,
            tags: document.getElementById('qTags').value.trim(),
            content: content,
            options: JSON.stringify(options),
            answer: answer,
            explanation: document.getElementById('qExplanation').value.trim(),
            image_path: document.getElementById('qImagePaths').value,
        };
        
        try {
            const url = id ? `/admin/questions/${id}` : '/admin/questions';
            const method = id ? 'PUT' : 'POST';
            const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            const result = await res.json();
            
            if (result.status === 'success') {
                showSuccess(result.message || (id ? 'é¢˜ç›®ä¿®æ”¹æˆåŠŸ' : 'é¢˜ç›®æ·»åŠ æˆåŠŸ'));
                closeDrawer();
                loadQuestions();
            } else {
                showError(result.message || 'æ“ä½œå¤±è´¥');
            }
        } catch (error) {
            console.error('ä¿å­˜é¢˜ç›®å¤±è´¥:', error);
            showError('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    async function deleteQuestion(id) {
        if (!confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤è¯¥é¢˜ç›®å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
        
        try {
            const res = await fetch(`/admin/questions/${id}`, { method: 'DELETE' });
            const result = await res.json();
            
            if (result.status === 'success') {
                showSuccess(result.message || 'é¢˜ç›®åˆ é™¤æˆåŠŸ');
                loadQuestions();
            } else {
                showError(result.message || 'åˆ é™¤å¤±è´¥');
            }
        } catch (error) {
            console.error('åˆ é™¤é¢˜ç›®å¤±è´¥:', error);
            showError('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    async function batchDeleteQuestions() {
        const ids = Array.from(document.querySelectorAll('.questionSelect:checked')).map(cb => cb.dataset.id);
        if (!ids.length) {
            showError('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¢˜ç›®');
            return;
        }
        
        if (!confirm(`âš ï¸ ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${ids.length} é“é¢˜ç›®å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
        
        try {
            const res = await fetch('/admin/questions/batch_delete', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ ids }) 
            });
            const result = await res.json();
            
            if (result.status === 'success') {
                showSuccess(result.message || `æˆåŠŸåˆ é™¤ ${ids.length} é“é¢˜ç›®`);
                loadQuestions();
            } else {
                showError(result.message || 'æ‰¹é‡åˆ é™¤å¤±è´¥');
            }
        } catch (error) {
            console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
            showError('æ‰¹é‡åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }

    function updatePreview() {
        document.getElementById('previewContent').innerHTML = document.getElementById('qContent').value.replace(/\n/g, '<br>');
        const opts = document.getElementById('qOptions').value.trim().split('\n').filter(Boolean);
        const optsHtml = opts.map(o => `<label>${o}</label>`).join('');
        document.getElementById('previewOptions').innerHTML = optsHtml;
    }

    // ======= æ‰¹é‡æ“ä½œ =======
    function getSelectedIds(){
        return Array.from(document.querySelectorAll('.questionSelect:checked')).map(cb => cb.dataset.id);
    }
    function openBatchTypeChange(){
        const sel = document.getElementById('typeChangeTarget');
        sel.innerHTML = '';
        // Reuse the types from the main filter dropdown
        document.querySelectorAll('#typeFilter option').forEach(opt => {
            if (opt.value !== 'all') {
                sel.add(new Option(opt.text, opt.value));
            }
        });
        openModal('modalTypeChange');
    }

    async function doBatchTypeChange(){
        const ids = getSelectedIds();
        if(!ids.length) return alert('è¯·å…ˆå‹¾é€‰é¢˜ç›®');
        const targetType = document.getElementById('typeChangeTarget').value;
        if (!targetType) return alert('è¯·é€‰æ‹©ä¸€ä¸ªç›®æ ‡é¢˜å‹');

        const res = await fetch('/admin/questions/batch_change_type', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids, target_type: targetType })});
        const ret = await res.json();
        alert(ret.message || 'æ“ä½œå¤±è´¥');
        if(ret.status === 'success'){
            closeModal('modalTypeChange');
            loadQuestions();
        }
    }

    function openBatchMove(){
        fetch('/admin/api/subjects').then(r=>r.json()).then(list=>{
            const sel = document.getElementById('moveTarget');
            sel.innerHTML = '';
            list.forEach(s=> sel.add(new Option(`${s.name} (${s.question_count||0})`, s.id)) );
            openModal('modalMove');
        });
    }
    function openBatchDifficulty(){ openModal('modalDifficulty'); }
    function openBatchTags(){
        document.getElementById('tagsTitle').innerText = 'æ‰¹é‡ä¿®æ”¹æ ‡ç­¾';
        openModal('modalTags');
    }

    function openModal(id){ const m=document.getElementById(id); if(m){ m.style.display='block'; } }
    function closeModal(id){ const m=document.getElementById(id); if(m){ m.style.display='none'; } }

    async function doBatchMove(){
        const ids = getSelectedIds();
        if(!ids.length) return alert('è¯·å…ˆå‹¾é€‰é¢˜ç›®');
        const target = document.getElementById('moveTarget').value;
        const res = await fetch('/admin/questions/batch_move_subject', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids, target_subject_id: target })});
        const ret = await res.json(); alert(ret.message||'');
        if(ret.status==='success'){ closeModal('modalMove'); loadQuestions(); }
    }
    async function doBatchDifficulty(){
        const ids = getSelectedIds();
        if(!ids.length) return alert('è¯·å…ˆå‹¾é€‰é¢˜ç›®');
        const difficulty = parseInt(document.getElementById('diffValue').value)||1;
        const res = await fetch('/admin/questions/batch_set_difficulty', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids, difficulty })});
        const ret = await res.json(); alert(ret.message||'');
        if(ret.status==='success'){ closeModal('modalDifficulty'); loadQuestions(); }
    }
    async function doBatchTags(){
        const ids = getSelectedIds();
        if(!ids.length) return alert('è¯·å…ˆå‹¾é€‰é¢˜ç›®');
        const tags = document.getElementById('tagsInput').value.trim();
        if(!tags) return alert('è¯·è¾“å…¥æ ‡ç­¾');
        const res = await fetch('/admin/questions/batch_tags', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ids, action: 'set', tags })});
        const ret = await res.json(); alert(ret.message||'');
        if(ret.status==='success'){ closeModal('modalTags'); loadQuestions(); }
    }

    // ======= å¯¼å…¥/å¯¼å‡º =======
    function openImportModal(){ openModal('modalImport'); document.getElementById('importPreview').innerHTML=''; }
    function renderImportPreview(){
        const txt = document.getElementById('importText').value.trim();
        const file = document.getElementById('importFile').files[0];
        if(txt){
            try{ const data = JSON.parse(txt); window.__importData = data; showImportPreview(data); }catch(e){ alert('ç²˜è´´å†…å®¹ä¸æ˜¯æœ‰æ•ˆJSON'); }
            return;
        }
        if(file){
            const fr = new FileReader();
            fr.onload = () => { try{ const data = JSON.parse(fr.result); window.__importData = data; showImportPreview(data);}catch(e){ alert('æ–‡ä»¶å†…å®¹ä¸æ˜¯æœ‰æ•ˆJSON'); } };
            fr.readAsText(file);
            return;
        }
        alert('è¯·ç²˜è´´JSONæˆ–é€‰æ‹©æ–‡ä»¶');
    }
    function showImportPreview(list){
        if(!Array.isArray(list)) { alert('JSONå¿…é¡»æ˜¯æ•°ç»„'); return; }
        const box = document.getElementById('importPreview');
        let ok=0, bad=0, html='';
        list.forEach((it, i)=>{
            const valid = it['é¢˜å‹'] && it['é¢˜å¹²']!==undefined && it['ç­”æ¡ˆ']!==undefined;
            if(valid) ok++; else bad++;
            html += `<div style="padding:6px; border-bottom:1px solid var(--border-color); ${valid?'':'background:#fff3cd'}">#${i+1} ${it['é¢˜å‹']||'(ç¼ºå°‘é¢˜å‹)'} - ${String(it['é¢˜å¹²']||'').slice(0,60)}</div>`;
        });
        box.innerHTML = `<div style="margin-bottom:6px;">å…± ${list.length} æ¡ï¼›æœ‰æ•ˆ ${ok}ï¼Œé—®é¢˜ ${bad}</div>` + html;
    }
    async function confirmImport(){
        const data = window.__importData;
        if(!Array.isArray(data) || !data.length) return alert('æš‚æ— å¯å¯¼å…¥æ•°æ®');
        const res = await fetch('/admin/questions/import', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ subject_id: subjectId, questions: data })});
        const ret = await res.json(); alert(ret.message||'');
        if(ret.status==='success'){ closeModal('modalImport'); loadQuestions(); }
    }
    function exportSubject(){ window.open(`/admin/questions/export?subject_id=${subjectId}`, '_blank'); }
    function exportAll(){ window.open('/admin/questions/export', '_blank'); }

    function exportPackage() {
        const type = document.getElementById('typeFilter').value;
        let url = `/admin/questions/export_package?subject_id=${subjectId}`;
        if (type && type !== 'all') {
            url += `&type=${type}`;
        }
        window.open(url, '_blank');
    }

    async function uploadPackage() {
        const fileInput = document.getElementById('importPackageFile');
        if (fileInput.files.length === 0) return;

        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);

        showSuccess('æ­£åœ¨ä¸Šä¼ å¹¶å¯¼å…¥é¢˜ç›®åŒ…ï¼Œè¯·ç¨å€™...');

        try {
            const res = await fetch('/admin/questions/import_package', {
                method: 'POST',
                body: formData
            });
            const result = await res.json();

            if (result.status === 'success' || result.status === 'warning') {
                let message = result.message || 'å¯¼å…¥å®Œæˆ';
                if (result.errors && result.errors.length > 0) {
                    message += '\n\né‡åˆ°çš„é—®é¢˜:\n' + result.errors.join('\n');
                }
                alert('âœ… ' + message);
                loadQuestions(); // Refresh the list
            } else {
                showError(result.message || 'å¯¼å…¥å¤±è´¥');
            }
        } catch (e) {
            showError('å¯¼å…¥å¤±è´¥: ' + e.message);
        } finally {
            // Reset file input so the same file can be selected again
            fileInput.value = '';
        }
    }

    // Helper to get image paths as an array
    function getImagePaths() {
        const pathsInput = document.getElementById('qImagePaths');
        try {
            return JSON.parse(pathsInput.value || '[]');
        } catch (e) {
            return [];
        }
    }

    // Helper to set image paths from an array
    function setImagePaths(paths) {
        const pathsInput = document.getElementById('qImagePaths');
        pathsInput.value = JSON.stringify(paths);
        renderImagePreviews();
    }

    // Renders the preview images based on the hidden input
    function renderImagePreviews() {
        const container = document.getElementById('imagePreviewContainer');
        const paths = getImagePaths();
        container.innerHTML = ''; // Clear existing previews

        paths.forEach(path => {
            const previewWrapper = document.createElement('div');
            previewWrapper.style.position = 'relative';

            const img = document.createElement('img');
            img.src = `{{ url_for('main.serve_upload', filename='') }}${path}`;
            img.style.width = '100px';
            img.style.height = '100px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '8px';

            const removeBtn = document.createElement('button');
            removeBtn.innerText = 'Ã—';
            removeBtn.style.position = 'absolute';
            removeBtn.style.top = '2px';
            removeBtn.style.right = '2px';
            removeBtn.style.background = 'rgba(0,0,0,0.6)';
            removeBtn.style.color = 'white';
            removeBtn.style.border = 'none';
            removeBtn.style.borderRadius = '50%';
            removeBtn.style.width = '20px';
            removeBtn.style.height = '20px';
            removeBtn.style.cursor = 'pointer';
            removeBtn.style.lineHeight = '20px';
            removeBtn.style.textAlign = 'center';
            removeBtn.style.padding = '0';
            removeBtn.onclick = () => removeImage(path);

            previewWrapper.appendChild(img);
            previewWrapper.appendChild(removeBtn);
            container.appendChild(previewWrapper);
        });
    }

    // New uploadImage function for multiple files
    async function uploadImage() {
        const fileInput = document.getElementById('qImageFile');
        if (fileInput.files.length === 0) return;

        const files = Array.from(fileInput.files);
        let currentPaths = getImagePaths();

        // Show a temporary loading state if needed

        for (const file of files) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/admin/api/questions/upload_image', {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();

                if (result.status === 'success') {
                    if (!currentPaths.includes(result.path)) {
                        currentPaths.push(result.path);
                    }
                } else {
                    showError(`å›¾ç‰‡ ${file.name} ä¸Šä¼ å¤±è´¥: ${result.message}`);
                }
            } catch (e) {
                showError(`å›¾ç‰‡ ${file.name} ä¸Šä¼ å¤±è´¥: ${e.message}`);
            }
        }
        
        fileInput.value = ''; // Clear the file input after processing all files
        setImagePaths(currentPaths);
    }

    // New removeImage function
    function removeImage(pathToRemove) {
        let currentPaths = getImagePaths();
        const updatedPaths = currentPaths.filter(path => path !== pathToRemove);
        setImagePaths(updatedPaths);
    }

    /* =============================
     * å¡«ç©ºé¢˜ç»“æ„åŒ–ç­”æ¡ˆç¼–è¾‘å™¨
     * æ ¼å¼çº¦å®šï¼šä¸åŒç©ºç”¨ ";;" åˆ†éš”ï¼›åŒä¸€ç©ºå¤šç­”æ¡ˆç”¨ ";" åˆ†éš”
     * ç¤ºä¾‹ï¼šåŒ—äº¬;åŒ—å¹³;;ä¸Šæµ·;æ²ª
     * ============================= */

    function blankEditorCountBlanksFromContent(content) {
        try {
            const c = (content || '').toString();
            const n = (c.match(/__/g) || []).length;
            return Math.max(1, n);
        } catch (e) {
            return 1;
        }
    }

    function blankEditorParseAnswer(answerStr) {
        const s = (answerStr || '').toString().trim();
        if (!s) return [];
        // ç©ºä¹‹é—´ï¼š;;
        // åŒç©ºå€™é€‰ï¼š;
        return s.split(';;').map(group => {
            const g = (group || '').trim();
            if (!g) return [''];
            const arr = g.split(';').map(x => x.trim()).filter(Boolean);
            return arr.length ? arr : [''];
        });
    }

    function blankEditorSerialize(groups) {
        const safeGroups = (groups || []).map(opts => {
            const cleaned = (opts || []).map(x => (x || '').toString().trim()).filter(Boolean);
            return cleaned.join(';');
        });
        return safeGroups.join(';;');
    }

    function blankEditorGetGroupsFromDOM() {
        const wrap = document.getElementById('blank-groups');
        if (!wrap) return [];
        const groups = [];
        wrap.querySelectorAll('[data-blank-group]').forEach(groupEl => {
            const opts = [];
            groupEl.querySelectorAll('input[data-blank-opt]').forEach(inp => {
                opts.push((inp.value || '').trim());
            });
            groups.push(opts);
        });
        return groups;
    }

    function blankEditorSyncHiddenAnswer() {
        const hidden = document.getElementById('qAnswer');
        if (!hidden) return;
        const rawBox = document.getElementById('blank-raw');
        const isRaw = rawBox && rawBox.style.display !== 'none';
        if (isRaw) {
            const rawInput = document.getElementById('blank-raw-input');
            hidden.value = rawInput ? (rawInput.value || '').trim() : '';
            return;
        }
        const groups = blankEditorGetGroupsFromDOM();
        hidden.value = blankEditorSerialize(groups);
    }

    function blankEditorRender(groups) {
        const wrap = document.getElementById('blank-groups');
        if (!wrap) return;
        wrap.innerHTML = '';

        (groups || []).forEach((opts, idx) => {
            const group = document.createElement('div');
            group.setAttribute('data-blank-group', '1');
            group.style.border = '1px solid #e9ecef';
            group.style.borderRadius = '12px';
            group.style.padding = '10px';
            group.style.background = '#fff';

            const header = document.createElement('div');
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.alignItems = 'center';
            header.style.gap = '10px';
            header.style.marginBottom = '8px';
            header.innerHTML = `
              <div style="font-weight:700;">ç©º ${idx + 1}</div>
              <div style="display:flex; gap:8px;">
                <button type="button" class="btn-sm" style="padding:6px 10px; border:1px solid #dee2e6; background:#fff; border-radius:8px; cursor:pointer;" data-add-opt>+ å¢åŠ ç­”æ¡ˆ</button>
                <button type="button" class="btn-sm" style="padding:6px 10px; border:1px solid #f1c0bc; background:rgba(255,59,48,0.06); color:#b42318; border-radius:8px; cursor:pointer;" data-del-blank>åˆ é™¤æ­¤ç©º</button>
              </div>
            `;

            const list = document.createElement('div');
            list.style.display = 'flex';
            list.style.flexDirection = 'column';
            list.style.gap = '8px';

            const normOpts = (opts && opts.length) ? opts : [''];
            normOpts.forEach((val) => {
                list.appendChild(blankEditorCreateOptRow(val));
            });

            group.appendChild(header);
            group.appendChild(list);
            wrap.appendChild(group);

            // events
            header.querySelector('[data-add-opt]').onclick = () => {
                list.appendChild(blankEditorCreateOptRow(''));
                blankEditorSyncHiddenAnswer();
            };
            header.querySelector('[data-del-blank]').onclick = () => {
                // è‡³å°‘ä¿ç•™ 1 ç©º
                const all = wrap.querySelectorAll('[data-blank-group]');
                if (all.length <= 1) {
                    showError('è‡³å°‘éœ€è¦ä¿ç•™ 1 ä¸ªç©º');
                    return;
                }
                group.remove();
                // é‡æ–°ç¼–å·
                wrap.querySelectorAll('[data-blank-group]').forEach((g, i) => {
                    const t = g.querySelector('div[style*="font-weight:700"]');
                    if (t) t.textContent = `ç©º ${i + 1}`;
                });
                blankEditorSyncHiddenAnswer();
            };
        });

        blankEditorSyncHiddenAnswer();
    }

    function blankEditorCreateOptRow(val) {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.gap = '8px';
        row.style.alignItems = 'center';

        const inp = document.createElement('input');
        inp.type = 'text';
        inp.setAttribute('data-blank-opt', '1');
        inp.value = (val || '').toString();
        inp.placeholder = 'å¯æ¥å—ç­”æ¡ˆï¼ˆä¾‹å¦‚ï¼šåŒ—äº¬ï¼‰';
        inp.style.flex = '1';
        inp.style.padding = '10px 12px';
        inp.style.border = '1px solid #ced4da';
        inp.style.borderRadius = '10px';
        inp.style.fontSize = '14px';
        inp.oninput = () => blankEditorSyncHiddenAnswer();

        const del = document.createElement('button');
        del.type = 'button';
        del.textContent = 'åˆ é™¤';
        del.className = 'btn-sm';
        del.style.padding = '8px 10px';
        del.style.border = '1px solid #dee2e6';
        del.style.background = '#fff';
        del.style.borderRadius = '10px';
        del.style.cursor = 'pointer';
        del.onclick = () => {
            const parent = row.parentElement;
            row.remove();
            // æ¯ç©ºè‡³å°‘ä¿ç•™ 1 ä¸ªè¾“å…¥
            if (parent && parent.querySelectorAll('input[data-blank-opt]').length === 0) {
                parent.appendChild(blankEditorCreateOptRow(''));
            }
            blankEditorSyncHiddenAnswer();
        };

        row.appendChild(inp);
        row.appendChild(del);
        return row;
    }

    function blankEditorInitFromContentAndAnswer(content, answerStr) {
        const blankCount = blankEditorCountBlanksFromContent(content);
        const parsed = blankEditorParseAnswer(answerStr);

        // ä»¥é¢˜å¹²ç©ºæ•°ä¸ºå‡†ï¼šä¸è¶³è¡¥é½ï¼Œè¶…å‡ºæˆªæ–­
        const groups = [];
        for (let i = 0; i < blankCount; i++) {
            groups.push(parsed[i] ? parsed[i] : ['']);
        }

        blankEditorRender(groups);

        // raw input åŒæ­¥
        const rawInput = document.getElementById('blank-raw-input');
        if (rawInput) {
            rawInput.value = blankEditorSerialize(groups);
            rawInput.oninput = () => blankEditorSyncHiddenAnswer();
        }
    }

    function blankEditorAddBlank() {
        const wrap = document.getElementById('blank-groups');
        if (!wrap) return;
        const groups = blankEditorGetGroupsFromDOM();
        groups.push(['']);
        blankEditorRender(groups);

        const rawInput = document.getElementById('blank-raw-input');
        if (rawInput) rawInput.value = blankEditorSerialize(groups);
    }

    function blankEditorToggleRaw(toRaw) {
        const rawBox = document.getElementById('blank-raw');
        const rawInput = document.getElementById('blank-raw-input');
        const wrap = document.getElementById('blank-groups');
        if (!rawBox || !wrap) return;

        if (toRaw) {
            // åˆ‡åˆ°æ‰‹å†™ï¼šç”¨å½“å‰ç»“æ„åŒ–ç»“æœå¡«å……
            const groups = blankEditorGetGroupsFromDOM();
            if (rawInput) rawInput.value = blankEditorSerialize(groups);
            rawBox.style.display = 'block';
            wrap.style.display = 'none';
        } else {
            // åˆ‡å›ç»“æ„åŒ–ï¼šå°è¯•è§£ææ‰‹å†™
            const parsed = blankEditorParseAnswer(rawInput ? rawInput.value : '');
            const blankCount = blankEditorCountBlanksFromContent(document.getElementById('qContent')?.value || '');
            const groups = [];
            for (let i = 0; i < blankCount; i++) groups.push(parsed[i] ? parsed[i] : ['']);
            rawBox.style.display = 'none';
            wrap.style.display = 'flex';
            blankEditorRender(groups);
        }
        blankEditorSyncHiddenAnswer();
    }

    // é¢˜å¹²å˜åŒ–æ—¶ï¼šå¦‚æœå½“å‰æ˜¯å¡«ç©ºé¢˜ï¼Œè‡ªåŠ¨æ ¹æ® __ æ•°é‡è°ƒæ•´ç©ºæ•°
    function blankEditorOnContentChanged() {
        const qType = document.getElementById('qType')?.value;
        if (qType !== 'å¡«ç©ºé¢˜') return;
        const wrap = document.getElementById('blank-groups');
        if (!wrap) return;
        const blankCount = blankEditorCountBlanksFromContent(document.getElementById('qContent')?.value || '');
        const current = blankEditorGetGroupsFromDOM();
        const groups = [];
        for (let i = 0; i < blankCount; i++) groups.push(current[i] ? current[i] : ['']);
        blankEditorRender(groups);

        const rawInput = document.getElementById('blank-raw-input');
        if (rawInput) rawInput.value = blankEditorSerialize(groups);
    }

    // æŒ‚åˆ° windowï¼Œç¡®ä¿ onclick å¯ç”¨
    window.blankEditorInitFromContentAndAnswer = blankEditorInitFromContentAndAnswer;
    window.blankEditorAddBlank = blankEditorAddBlank;
    window.blankEditorToggleRaw = blankEditorToggleRaw;

    // ç›‘å¬é¢˜å¹²è¾“å…¥
    document.addEventListener('DOMContentLoaded', () => {
        const c = document.getElementById('qContent');
        if (c) c.addEventListener('input', () => {
            // é˜²æŠ–ï¼ˆå¾ˆè½»é‡ï¼‰
            clearTimeout(window.__blankEditorTimer);
            window.__blankEditorTimer = setTimeout(blankEditorOnContentChanged, 120);
        });
    });
</script>
{% endblock %}
