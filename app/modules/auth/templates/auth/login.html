<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>{{ 'ç”¨æˆ·ç™»å½•' if mode=='login' else 'ç”¨æˆ·æ³¨å†Œ' }}</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%23007bff'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='88' fill='white'%3E%F0%9F%93%98%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%23007bff'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='88' fill='white'%3E%F0%9F%93%98%3C/text%3E%3C/svg%3E">
  <meta name="theme-color" content="#f5f5f7">
  <style>
    :root { 
      --bg-color: #f5f5f7;
      --card-bg: rgba(255, 255, 255, 0.7);
      --card-bg-solid: #ffffff;
      --text-color: #1d1d1f;
      --text-sub: #86868b;
      --border-color: rgba(255, 255, 255, 0.6);
      --primary: #007aff;
      --primary-light: rgba(0, 122, 255, 0.15);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
      --danger: #ff3b30;
      --blur: blur(40px) saturate(180%);
      --glow: 0 0 20px rgba(255, 255, 255, 0.5);
    }

    /* å…¨å±€æ»šåŠ¨æ¡æ ·å¼ - æç®€é£æ ¼ */
    * { scrollbar-width: thin; scrollbar-color: transparent transparent; }
    *:hover { scrollbar-color: rgba(128, 128, 128, 0.3) transparent; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: transparent; border-radius: 3px; }
    *:hover::-webkit-scrollbar-thumb { background: rgba(128, 128, 128, 0.3); }
    ::-webkit-scrollbar-thumb:hover { background: rgba(128, 128, 128, 0.5); }

    body { 
      margin:0; 
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-color);
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(0, 122, 255, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(0, 122, 255, 0.03) 0%, transparent 50%);
      color: var(--text-color);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding: 20px;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 1;
      opacity: 0.4;
      mix-blend-mode: overlay;
    }
    .card { 
      width: 92%; 
      max-width: 420px; 
      background: var(--card-bg);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border-radius: 24px; 
      box-shadow: var(--shadow);
      border: 0.5px solid var(--border-color);
      padding: 40px 32px;
      animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      isolation: isolate;
      background-image: 
        url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.4'/%3E%3C/svg%3E"),
        var(--card-bg);
      background-blend-mode: overlay;
    }
    .card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 24px;
      padding: 0.5px;
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.8) 0%,
        rgba(255, 255, 255, 0.4) 25%,
        rgba(255, 255, 255, 0.1) 50%,
        rgba(255, 255, 255, 0.4) 75%,
        rgba(255, 255, 255, 0.8) 100%
      );
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0.6;
      pointer-events: none;
      z-index: 1;
    }
    .card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 30%;
      background: linear-gradient(180deg, 
        rgba(255, 255, 255, 0.3) 0%,
        rgba(255, 255, 255, 0.1) 50%,
        transparent 100%
      );
      border-radius: 24px 24px 0 0;
      pointer-events: none;
      z-index: 2;
    }
    .card > * {
      position: relative;
      z-index: 3;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    h1 { 
      margin: 0 0 8px; 
      font-size: 32px; 
      font-weight: 600;
      letter-spacing: -0.5px;
    }
    p { 
      margin: 0 0 32px; 
      color: var(--text-sub); 
      font-size: 15px; 
      line-height: 1.5;
    }
    .field { margin-bottom: 20px; }
    label { 
      display:block; 
      margin-bottom: 8px; 
      font-size: 13px; 
      color: var(--text-sub);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    input { 
      width:100%; 
      padding: 14px 18px; 
      border: 0.5px solid var(--border-color); 
      border-radius: 12px; 
      font-size: 17px; 
      box-sizing: border-box;
      background: var(--card-bg-solid);
      color: var(--text-color);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-appearance: none;
    }

    /* è®© checkbox äº¤äº’æ›´æ˜æ˜¾ï¼ˆé¿å…è¢« input é€šç”¨æ ·å¼å½±å“ï¼‰ */
    input[type="checkbox"]{
      width: 18px !important;
      height: 18px !important;
      padding: 0 !important;
      border-radius: 6px !important;
      border: 1.5px solid rgba(0,0,0,.25) !important;
      background: rgba(255,255,255,.9) !important;
      cursor: pointer;
      display: inline-grid;
      place-content: center;
      transition: all .15s ease;
    }
    input[type="checkbox"]:hover{
      border-color: rgba(0,122,255,.6) !important;
      box-shadow: 0 0 0 4px rgba(0,122,255,.12);
    }
    input[type="checkbox"]:focus{
      outline: none;
      box-shadow: 0 0 0 4px rgba(0,122,255,.18);
    }
    input[type="checkbox"]:checked{
      background: var(--primary) !important;
      border-color: var(--primary) !important;
    }
    input[type="checkbox"]:checked::after{
      content: "";
      width: 9px;
      height: 5px;
      border: 2px solid #fff;
      border-top: 0;
      border-right: 0;
      transform: rotate(-45deg);
      margin-top: -1px;
    }
    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-light);
    }
    .btn { 
      width:100%; 
      margin-top: 8px; 
      padding: 14px; 
      background: var(--primary); 
      color:#fff; 
      border:none; 
      border-radius: 12px; 
      cursor:pointer; 
      font-size: 17px;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover { 
      transform: translateY(-1px); 
      box-shadow: 0 4px 16px rgba(0, 122, 255, 0.4);
    }
    .btn:active {
      transform: scale(0.98);
    }
    .btn[disabled], .btn[data-loading="true"] { 
      opacity:0.5; 
      cursor:not-allowed; 
      pointer-events:none; 
    }
    .btn[data-loading="true"] { 
      position: relative; 
      color: transparent; 
    }
    .btn[data-loading="true"]::after { 
      content: ""; 
      position:absolute; 
      top:50%; 
      left:50%; 
      width:18px; 
      height:18px; 
      margin:-9px 0 0 -9px; 
      border-radius:50%; 
      border:2px solid rgba(255,255,255,.9); 
      border-right-color: transparent; 
      animation: spin .8s linear infinite; 
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .link { 
      display:block; 
      text-align:center; 
      margin-top: 16px; 
      font-size: 15px; 
      color: var(--primary); 
      text-decoration:none;
      transition: opacity 0.2s;
    }
    .link:hover {
      opacity: 0.7;
    }
    .err { 
      color: var(--danger); 
      font-size: 13px; 
      margin-top: 8px; 
      min-height: 18px;
      font-weight: 500;
    }
    /* ç™»å½•æ–¹å¼åˆ‡æ¢æ ‡ç­¾ */
    .login-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 12px;
      padding: 4px;
    }
    .login-tab {
      flex: 1;
      padding: 10px 16px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      color: var(--text-sub);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: transparent;
      border: none;
    }
    .login-tab.active {
      background: var(--card-bg-solid);
      color: var(--primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .login-form {
      display: none;
    }
    .login-form.active {
      display: block;
    }
    /* éªŒè¯ç è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’® */
    .code-field {
      display: flex;
      gap: 8px;
    }
    .code-field input {
      flex: 1;
    }
    .code-send-btn {
      padding: 14px 20px;
      background: var(--primary-light);
      color: var(--primary);
      border: 1px solid var(--primary);
      border-radius: 12px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-tap-highlight-color: transparent;
    }
    .code-send-btn:hover:not(:disabled) {
      background: var(--primary);
      color: #fff;
    }
    .code-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    /* æç¤ºæ–‡æœ¬ */
    .hint-text {
      font-size: 13px;
      color: var(--text-sub);
      margin-top: 4px;
      line-height: 1.4;
    }
    /* åè®®é“¾æ¥æ ·å¼ */
    a[href="/terms"],
    a[href="/privacy"] {
      transition: opacity 0.2s;
    }
    a[href="/terms"]:hover,
    a[href="/privacy"]:hover {
      opacity: 0.7;
      text-decoration: underline;
    }
    /* å¿˜è®°å¯†ç æ¨¡æ€æ¡†æ ·å¼ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-content {
      background: var(--card-bg);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border-radius: 24px;
      box-shadow: var(--shadow);
      border: 0.5px solid var(--border-color);
      padding: 32px;
      width: 90%;
      max-width: 420px;
      position: relative;
      animation: slideUp 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 24px;
      color: var(--text-sub);
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .modal-close:hover {
      background: rgba(0, 0, 0, 0.05);
      color: var(--text-color);
    }
    .modal-title {
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 8px 0;
    }
    .modal-subtitle {
      color: var(--text-sub);
      font-size: 14px;
      margin: 0 0 24px 0;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="card">
    {% if mode=='login' %}
      <h1>æ¬¢è¿å›æ¥</h1>
      {% if tip_message %}
        <p style="color: #007bff; font-weight: 500;">{{ tip_message }}</p>
      {% else %}
        <p>ç™»å½•åå¯ç‹¬ç«‹ä¿å­˜æ”¶è—ä¸é”™é¢˜è®°å½•</p>
      {% endif %}
      
      <!-- ç™»å½•æ–¹å¼åˆ‡æ¢ -->
      <div class="login-tabs">
        <button class="login-tab active" onclick="switchLoginMode('password')">å¯†ç ç™»å½•</button>
        <button class="login-tab" onclick="switchLoginMode('code')">éªŒè¯ç ç™»å½•</button>
      </div>

      <!-- å¯†ç ç™»å½•è¡¨å• -->
      <div id="password-form" class="login-form active">
        <div class="field">
          <label>ç”¨æˆ·å / é‚®ç®±</label>
          <input id="username" placeholder="æ”¯æŒç”¨æˆ·åæˆ–é‚®ç®±" autocomplete="username" />
          <div class="hint-text">å¯ä»¥ä½¿ç”¨ç”¨æˆ·åæˆ–å·²ç»‘å®šçš„é‚®ç®±ç™»å½•</div>
        </div>
        <div class="field">
          <label>å¯†ç </label>
          <input id="password" type="password" autocomplete="current-password" />
          <div style="text-align: right; margin-top: 8px;">
            <a href="#" onclick="event.preventDefault(); showForgotPasswordModal();" style="font-size: 13px; color: var(--primary); text-decoration: none;">å¿˜è®°å¯†ç ï¼Ÿ</a>
          </div>
        </div>
        <div class="field" style="margin-top: 6px; margin-bottom: 12px;">
          <label style="text-transform:none; letter-spacing:0; display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none;">
            <input id="remember" type="checkbox" />
            <span style="font-size: 14px; color: var(--text-sub);">è®°ä½å¯†ç  / ä¿æŒç™»å½•</span>
          </label>
        </div>
        <div class="field" style="margin-top: 6px; margin-bottom: 12px;">
          <label style="text-transform:none; letter-spacing:0; display:flex; align-items:flex-start; gap:10px; cursor:pointer; user-select:none;">
            <input id="agreeTerms" type="checkbox" required />
            <span style="font-size: 13px; color: var(--text-sub); line-height: 1.5;">
              æˆ‘å·²é˜…è¯»å¹¶åŒæ„
              <a href="/terms" target="_blank" style="color: var(--primary); text-decoration: none;">ã€ŠæœåŠ¡åè®®ã€‹</a>
              å’Œ
              <a href="/privacy" target="_blank" style="color: var(--primary); text-decoration: none;">ã€Šéšç§ä¿æŠ¤åè®®ã€‹</a>
            </span>
          </label>
        </div>
        <div class="err" id="err-password"></div>
        <button class="btn" onclick="doLogin(this)">ç™»å½•</button>
      </div>

      <!-- éªŒè¯ç ç™»å½•è¡¨å• -->
      <div id="code-form" class="login-form">
        <div class="field">
          <label>é‚®ç®±</label>
          <input id="email" type="email" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" autocomplete="email" />
          <div class="hint-text">è¾“å…¥é‚®ç®±åœ°å€ï¼Œæœªæ³¨å†Œå°†è‡ªåŠ¨åˆ›å»ºè´¦æˆ·</div>
        </div>
        <div class="field">
          <label>éªŒè¯ç </label>
          <div class="code-field">
            <input id="code" type="text" placeholder="6ä½æ•°å­—éªŒè¯ç " maxlength="6" autocomplete="one-time-code" />
            <button class="code-send-btn" id="send-code-btn" onclick="sendLoginCode()">å‘é€éªŒè¯ç </button>
          </div>
          <div class="hint-text" id="code-hint">éªŒè¯ç å°†å‘é€åˆ°æ‚¨çš„é‚®ç®±ï¼Œæœ‰æ•ˆæœŸ10åˆ†é’Ÿã€‚æœªæ³¨å†Œé‚®ç®±å°†è‡ªåŠ¨åˆ›å»ºè´¦æˆ·</div>
        </div>
        <div class="field" style="margin-top: 6px; margin-bottom: 12px;">
          <label style="text-transform:none; letter-spacing:0; display:flex; align-items:flex-start; gap:10px; cursor:pointer; user-select:none;">
            <input id="agreeTermsCode" type="checkbox" required />
            <span style="font-size: 13px; color: var(--text-sub); line-height: 1.5;">
              æˆ‘å·²é˜…è¯»å¹¶åŒæ„
              <a href="/terms" target="_blank" style="color: var(--primary); text-decoration: none;">ã€ŠæœåŠ¡åè®®ã€‹</a>
              å’Œ
              <a href="/privacy" target="_blank" style="color: var(--primary); text-decoration: none;">ã€Šéšç§ä¿æŠ¤åè®®ã€‹</a>
            </span>
          </label>
        </div>
        <div class="err" id="err-code"></div>
        <button class="btn" onclick="doEmailLogin(this)">ç™»å½•</button>
      </div>

      <div style="text-align: center; margin-top: 16px; padding: 12px; background: rgba(0, 122, 255, 0.08); border-radius: 12px; font-size: 14px; color: var(--text-sub); line-height: 1.6;">
        <div style="font-weight: 500; color: var(--primary); margin-bottom: 4px;">ğŸ’¡ æ–°ç”¨æˆ·æç¤º</div>
        <div>ä½¿ç”¨<strong style="color: var(--primary);">éªŒè¯ç ç™»å½•</strong>ï¼Œå¦‚æœé‚®ç®±æœªæ³¨å†Œï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨åˆ›å»ºè´¦æˆ·</div>
      </div>
    {% endif %}

    <a class="link" href="/">è¿”å›é¦–é¡µ</a>
  </div>

  <!-- å¿˜è®°å¯†ç æ¨¡æ€æ¡† -->
  <div id="forgot-password-modal" class="modal-overlay" onclick="if(event.target === this) closeForgotPasswordModal()">
    <div class="modal-content">
      <button class="modal-close" onclick="closeForgotPasswordModal()">Ã—</button>
      <h2 class="modal-title">å¿˜è®°å¯†ç </h2>
      <p class="modal-subtitle">è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€ï¼Œæˆ‘ä»¬å°†å‘é€éªŒè¯ç åˆ°æ‚¨çš„é‚®ç®±</p>
      
      <div class="field">
        <label>é‚®ç®±åœ°å€</label>
        <input id="forgot-email" type="email" placeholder="è¯·è¾“å…¥å·²ç»‘å®šçš„é‚®ç®±" autocomplete="email" />
        <div class="hint-text">è¯·è¾“å…¥æ‚¨è´¦æˆ·ç»‘å®šçš„é‚®ç®±åœ°å€</div>
      </div>
      
      <div class="field">
        <label>éªŒè¯ç </label>
        <div class="code-field">
          <input id="forgot-code" type="text" placeholder="6ä½æ•°å­—éªŒè¯ç " maxlength="6" autocomplete="one-time-code" />
          <button class="code-send-btn" id="forgot-send-code-btn" onclick="sendForgotPasswordCode()">å‘é€éªŒè¯ç </button>
        </div>
        <div class="hint-text" id="forgot-code-hint">éªŒè¯ç å°†å‘é€åˆ°æ‚¨çš„é‚®ç®±ï¼Œæœ‰æ•ˆæœŸ10åˆ†é’Ÿ</div>
      </div>
      
      <div class="field">
        <label>æ–°å¯†ç </label>
        <input id="forgot-password" type="password" placeholder="è¯·è¾“å…¥æ–°å¯†ç " autocomplete="new-password" />
        <div class="hint-text">å¯†ç é•¿åº¦è‡³å°‘8ä½ï¼Œå»ºè®®åŒ…å«å­—æ¯å’Œæ•°å­—</div>
      </div>
      
      <div class="field">
        <label>ç¡®è®¤å¯†ç </label>
        <input id="forgot-password-confirm" type="password" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " autocomplete="new-password" />
      </div>
      
      <div class="err" id="err-forgot"></div>
      <button class="btn" onclick="resetPassword(this)">é‡ç½®å¯†ç </button>
    </div>
  </div>

  <script>
    function setErr(msg, formType = ''){ 
      const errId = formType ? `err-${formType}` : 'err';
      const errEl = document.getElementById(errId);
      if(errEl) errEl.innerText = msg || ''; 
    }
    function val(id){ 
      const el = document.getElementById(id);
      return el ? el.value.trim() : ''; 
    }

    // åˆ‡æ¢ç™»å½•æ–¹å¼
    function switchLoginMode(mode) {
      // æ›´æ–°æ ‡ç­¾çŠ¶æ€
      document.querySelectorAll('.login-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // åˆ‡æ¢è¡¨å•æ˜¾ç¤º
      document.getElementById('password-form').classList.toggle('active', mode === 'password');
      document.getElementById('code-form').classList.toggle('active', mode === 'code');
      
      // æ¸…ç©ºé”™è¯¯ä¿¡æ¯
      setErr('', 'password');
      setErr('', 'code');
    }

    // å¯†ç ç™»å½•
    async function doLogin(btn){
      setErr('', 'password');
      const username = val('username');
      const password = val('password');
      
      // æ£€æŸ¥æ˜¯å¦åŒæ„åè®®
      const agreeTerms = document.getElementById('agreeTerms');
      if (!agreeTerms || !agreeTerms.checked) {
        setErr('è¯·å…ˆé˜…è¯»å¹¶åŒæ„ã€ŠæœåŠ¡åè®®ã€‹å’Œã€Šéšç§ä¿æŠ¤åè®®ã€‹', 'password');
        return;
      }
      
      if(!username || !password) {
        setErr('è¯·è¾“å…¥ç”¨æˆ·å/é‚®ç®±å’Œå¯†ç ', 'password');
        return;
      }
      
      btn.setAttribute('data-loading', 'true');
      const redirectUrl = new URLSearchParams(window.location.search).get('redirect') || '/';
      
      try {
        const res = await fetch('/api/login', { 
          method:'POST', 
          headers:{'Content-Type':'application/json'}, 
          body: JSON.stringify({ 
            username: username, 
            password: password,
            remember: document.getElementById('remember') ? document.getElementById('remember').checked : false,
            redirect: redirectUrl
          }) 
        });
        const data = await res.json();
        
        if(!res.ok || data.status!=='success') {
          setErr(data.message || 'ç™»å½•å¤±è´¥', 'password');
          return;
        }
        
        // å¦‚æœç”¨æˆ·éœ€è¦è®¾ç½®å¯†ç ï¼Œä¿å­˜æ ‡è®°åˆ°sessionStorage
        if (data.needs_password_set) {
          sessionStorage.setItem('needs_password_set', 'true');
          sessionStorage.removeItem('password_set_modal_shown'); // æ¸…é™¤å·²æ˜¾ç¤ºæ ‡è®°ï¼Œç¡®ä¿æ˜¾ç¤ºå¼¹çª—
        }
        
        // ç™»å½•æˆåŠŸåè·³è½¬
        location.href = data.redirect || redirectUrl || '/';
      } catch(error) {
        setErr('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'password');
      } finally {
        btn.removeAttribute('data-loading');
      }
    }

    // å‘é€ç™»å½•éªŒè¯ç 
    let codeCountdown = 0;
    let codeTimer = null;
    
    async function sendLoginCode(){
      const email = val('email');
      if(!email) {
        setErr('è¯·è¾“å…¥é‚®ç®±åœ°å€', 'code');
        return;
      }
      
      // ç®€å•çš„é‚®ç®±æ ¼å¼éªŒè¯
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if(!emailRegex.test(email)) {
        setErr('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'code');
        return;
      }
      
      const btn = document.getElementById('send-code-btn');
      if(codeCountdown > 0) return; // å€’è®¡æ—¶ä¸­ä¸å…è®¸é‡å¤å‘é€
      
      btn.setAttribute('data-loading', 'true');
      setErr('', 'code');
      
      try {
        const res = await fetch('/api/email/send-login-code', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ email: email })
        });
        const data = await res.json();
        
        if(data.status === 'success') {
          // å¼€å§‹å€’è®¡æ—¶
          codeCountdown = 60;
          startCodeCountdown();
          setErr('éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶é‚®ä»¶', 'code');
          document.getElementById('code-hint').textContent = 'éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶é‚®ä»¶ï¼ˆ60ç§’åå¯é‡æ–°å‘é€ï¼‰ã€‚æœªæ³¨å†Œé‚®ç®±å°†è‡ªåŠ¨åˆ›å»ºè´¦æˆ·';
        } else {
          setErr(data.message || 'å‘é€éªŒè¯ç å¤±è´¥', 'code');
        }
      } catch(error) {
        setErr('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'code');
      } finally {
        btn.removeAttribute('data-loading');
      }
    }
    
    // éªŒè¯ç å€’è®¡æ—¶
    function startCodeCountdown() {
      const btn = document.getElementById('send-code-btn');
      const hint = document.getElementById('code-hint');
      
      if(codeTimer) clearInterval(codeTimer);
      
      codeTimer = setInterval(() => {
        codeCountdown--;
        if(codeCountdown > 0) {
          btn.disabled = true;
          btn.textContent = `${codeCountdown}ç§’åé‡å‘`;
          hint.textContent = `éªŒè¯ç å·²å‘é€ï¼Œ${codeCountdown}ç§’åå¯é‡æ–°å‘é€`;
        } else {
          btn.disabled = false;
          btn.textContent = 'å‘é€éªŒè¯ç ';
          hint.textContent = 'éªŒè¯ç å°†å‘é€åˆ°æ‚¨çš„é‚®ç®±ï¼Œæœ‰æ•ˆæœŸ10åˆ†é’Ÿ';
          clearInterval(codeTimer);
          codeTimer = null;
        }
      }, 1000);
    }

    // æ˜¾ç¤ºå¿˜è®°å¯†ç æ¨¡æ€æ¡†
    function showForgotPasswordModal() {
      document.getElementById('forgot-password-modal').classList.add('active');
      // æ¸…ç©ºè¡¨å•
      document.getElementById('forgot-email').value = '';
      document.getElementById('forgot-code').value = '';
      document.getElementById('forgot-password').value = '';
      document.getElementById('forgot-password-confirm').value = '';
      setErr('', 'forgot');
      // é‡ç½®å‘é€éªŒè¯ç æŒ‰é’®
      const btn = document.getElementById('forgot-send-code-btn');
      btn.disabled = false;
      btn.textContent = 'å‘é€éªŒè¯ç ';
      if(forgotCodeTimer) {
        clearInterval(forgotCodeTimer);
        forgotCodeTimer = null;
      }
      forgotCodeCountdown = 0;
    }
    
    // å…³é—­å¿˜è®°å¯†ç æ¨¡æ€æ¡†
    function closeForgotPasswordModal() {
      document.getElementById('forgot-password-modal').classList.remove('active');
    }
    
    // å¿˜è®°å¯†ç éªŒè¯ç å€’è®¡æ—¶
    let forgotCodeCountdown = 0;
    let forgotCodeTimer = null;
    
    // å‘é€å¿˜è®°å¯†ç éªŒè¯ç 
    async function sendForgotPasswordCode() {
      const email = document.getElementById('forgot-email').value.trim();
      if(!email) {
        setErr('è¯·è¾“å…¥é‚®ç®±åœ°å€', 'forgot');
        return;
      }
      
      // ç®€å•çš„é‚®ç®±æ ¼å¼éªŒè¯
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if(!emailRegex.test(email)) {
        setErr('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'forgot');
        return;
      }
      
      const btn = document.getElementById('forgot-send-code-btn');
      if(forgotCodeCountdown > 0) return; // å€’è®¡æ—¶ä¸­ä¸å…è®¸é‡å¤å‘é€
      
      btn.setAttribute('data-loading', 'true');
      setErr('', 'forgot');
      
      try {
        const res = await fetch('/api/forgot-password/send-code', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ email: email })
        });
        const data = await res.json();
        
        if(data.status === 'success') {
          // å¼€å§‹å€’è®¡æ—¶
          forgotCodeCountdown = 60;
          startForgotCodeCountdown();
          setErr('éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶é‚®ä»¶', 'forgot');
          document.getElementById('forgot-code-hint').textContent = 'éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶é‚®ä»¶ï¼ˆ60ç§’åå¯é‡æ–°å‘é€ï¼‰';
        } else {
          setErr(data.message || 'å‘é€éªŒè¯ç å¤±è´¥', 'forgot');
        }
      } catch(error) {
        setErr('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'forgot');
      } finally {
        btn.removeAttribute('data-loading');
      }
    }
    
    // å¿˜è®°å¯†ç éªŒè¯ç å€’è®¡æ—¶
    function startForgotCodeCountdown() {
      const btn = document.getElementById('forgot-send-code-btn');
      const hint = document.getElementById('forgot-code-hint');
      
      if(forgotCodeTimer) clearInterval(forgotCodeTimer);
      
      forgotCodeTimer = setInterval(() => {
        forgotCodeCountdown--;
        if(forgotCodeCountdown > 0) {
          btn.disabled = true;
          btn.textContent = `${forgotCodeCountdown}ç§’åé‡å‘`;
          hint.textContent = `éªŒè¯ç å·²å‘é€ï¼Œ${forgotCodeCountdown}ç§’åå¯é‡æ–°å‘é€`;
        } else {
          btn.disabled = false;
          btn.textContent = 'å‘é€éªŒè¯ç ';
          hint.textContent = 'éªŒè¯ç å°†å‘é€åˆ°æ‚¨çš„é‚®ç®±ï¼Œæœ‰æ•ˆæœŸ10åˆ†é’Ÿ';
          clearInterval(forgotCodeTimer);
          forgotCodeTimer = null;
        }
      }, 1000);
    }
    
    // é‡ç½®å¯†ç 
    async function resetPassword(btn) {
      setErr('', 'forgot');
      const email = document.getElementById('forgot-email').value.trim();
      const code = document.getElementById('forgot-code').value.trim();
      const password = document.getElementById('forgot-password').value;
      const passwordConfirm = document.getElementById('forgot-password-confirm').value;
      
      if(!email) {
        setErr('è¯·è¾“å…¥é‚®ç®±åœ°å€', 'forgot');
        return;
      }
      if(!code) {
        setErr('è¯·è¾“å…¥éªŒè¯ç ', 'forgot');
        return;
      }
      if(code.length !== 6 || !/^\d{6}$/.test(code)) {
        setErr('éªŒè¯ç ä¸º6ä½æ•°å­—', 'forgot');
        return;
      }
      if(!password) {
        setErr('è¯·è¾“å…¥æ–°å¯†ç ', 'forgot');
        return;
      }
      if(password.length < 8) {
        setErr('å¯†ç é•¿åº¦è‡³å°‘8ä½', 'forgot');
        return;
      }
      if(password !== passwordConfirm) {
        setErr('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'forgot');
        return;
      }
      
      btn.setAttribute('data-loading', 'true');
      
      try {
        const res = await fetch('/api/forgot-password/reset', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ 
            email: email, 
            code: code,
            new_password: password
          })
        });
        const data = await res.json();
        
        if(!res.ok || data.status !== 'success') {
          setErr(data.message || 'é‡ç½®å¯†ç å¤±è´¥', 'forgot');
          return;
        }
        
        // é‡ç½®å¯†ç æˆåŠŸ
        setErr('å¯†ç é‡ç½®æˆåŠŸï¼Œè¯·ä½¿ç”¨æ–°å¯†ç ç™»å½•', 'forgot');
        setTimeout(() => {
          closeForgotPasswordModal();
          // åˆ‡æ¢åˆ°å¯†ç ç™»å½•è¡¨å•
          switchLoginMode('password');
          // è‡ªåŠ¨å¡«å……é‚®ç®±
          document.getElementById('username').value = email;
        }, 1500);
      } catch(error) {
        setErr('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'forgot');
      } finally {
        btn.removeAttribute('data-loading');
      }
    }

    // éªŒè¯ç ç™»å½•
    async function doEmailLogin(btn){
      setErr('', 'code');
      const email = val('email');
      const code = val('code');
      
      // æ£€æŸ¥æ˜¯å¦åŒæ„åè®®
      const agreeTermsCode = document.getElementById('agreeTermsCode');
      if (!agreeTermsCode || !agreeTermsCode.checked) {
        setErr('è¯·å…ˆé˜…è¯»å¹¶åŒæ„ã€ŠæœåŠ¡åè®®ã€‹å’Œã€Šéšç§ä¿æŠ¤åè®®ã€‹', 'code');
        return;
      }
      
      if(!email) {
        setErr('è¯·è¾“å…¥é‚®ç®±åœ°å€', 'code');
        return;
      }
      if(!code) {
        setErr('è¯·è¾“å…¥éªŒè¯ç ', 'code');
        return;
      }
      if(code.length !== 6 || !/^\d{6}$/.test(code)) {
        setErr('éªŒè¯ç ä¸º6ä½æ•°å­—', 'code');
        return;
      }
      
      btn.setAttribute('data-loading', 'true');
      const redirectUrl = new URLSearchParams(window.location.search).get('redirect') || '/';
      
      try {
        const res = await fetch('/api/email/login', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ 
            email: email, 
            code: code,
            redirect: redirectUrl
          })
        });
        const data = await res.json();
        
        if(!res.ok || data.status !== 'success') {
          setErr(data.message || 'ç™»å½•å¤±è´¥', 'code');
          return;
        }
        
        // å¦‚æœç”¨æˆ·éœ€è¦è®¾ç½®å¯†ç ï¼Œä¿å­˜æ ‡è®°åˆ°sessionStorage
        if (data.needs_password_set) {
          sessionStorage.setItem('needs_password_set', 'true');
          sessionStorage.removeItem('password_set_modal_shown'); // æ¸…é™¤å·²æ˜¾ç¤ºæ ‡è®°ï¼Œç¡®ä¿æ˜¾ç¤ºå¼¹çª—
        }
        
        // ç™»å½•æˆåŠŸåè·³è½¬
        location.href = data.redirect || redirectUrl || '/';
      } catch(error) {
        setErr('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'code');
      } finally {
        btn.removeAttribute('data-loading');
      }
    }

    
    // å›è½¦é”®ç™»å½•
    document.addEventListener('DOMContentLoaded', function() {
      // å¯†ç ç™»å½•è¡¨å•å›è½¦
      const passwordForm = document.getElementById('password-form');
      if(passwordForm) {
        ['username', 'password'].forEach(id => {
          const el = document.getElementById(id);
          if(el) {
            el.addEventListener('keypress', function(e) {
              if(e.key === 'Enter') {
                document.querySelector('#password-form .btn').click();
              }
            });
          }
        });
      }
      
      // éªŒè¯ç ç™»å½•è¡¨å•å›è½¦
      const codeForm = document.getElementById('code-form');
      if(codeForm) {
        ['email', 'code'].forEach(id => {
          const el = document.getElementById(id);
          if(el) {
            el.addEventListener('keypress', function(e) {
              if(e.key === 'Enter') {
                if(id === 'email') {
                  document.getElementById('send-code-btn').click();
                } else {
                  document.querySelector('#code-form .btn').click();
                }
              }
            });
          }
        });
      }
    });
  </script>
</body>
</html>

