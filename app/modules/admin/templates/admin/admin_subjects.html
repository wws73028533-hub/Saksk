{% extends "admin/admin_base.html" %}

{% block title %}ç§‘ç›®ç®¡ç†{% endblock %}

{% block head %}
<style>
    .container {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        padding: 40px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-soft);
        border: 0.5px solid var(--border-color);
    }
    
    /* é¡µé¢æ ‡é¢˜ */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--border-color);
    }
    .page-title {
        font-size: 28px;
        font-weight: bold;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .page-title-icon {
        display: none;
    }
    
    /* ç»Ÿè®¡å¡ç‰‡ - iOS 18é£æ ¼ï¼ˆä¼˜åŒ–å¤§å°ï¼‰ */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
    }
    .stat-card {
        padding: 20px;
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        color: var(--text-color);
        box-shadow: var(--shadow-soft);
        border: 0.5px solid var(--border-color);
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
        border-color: var(--border-color);
    }
    .stat-card.total, .stat-card.questions, .stat-card.avg {
        background: rgba(255, 255, 255, 0.7);
    }
    .stat-card-label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 10px;
        font-weight: 500;
    }
    .stat-card-value {
        font-size: 32px;
        font-weight: 600;
        margin-bottom: 0;
        letter-spacing: -0.5px;
    }
    
    /* å·¥å…·æ  */
    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        gap: 16px;
        flex-wrap: wrap;
    }
    .toolbar-left, .toolbar-right {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    /* è¡¨å•å®¹å™¨ - åŒä¸€è¡Œæ˜¾ç¤ºï¼Œç»Ÿä¸€å®½é«˜ */
    .forms-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 24px;
        align-items: stretch;
    }
    
    @media (max-width: 1200px) {
        .forms-row {
            grid-template-columns: 1fr;
        }
    }
    
    /* æ·»åŠ ç§‘ç›®è¡¨å• - iOS 18é£æ ¼ï¼Œç»Ÿä¸€é«˜åº¦ */
    .add-subject-form {
        display: flex;
        gap: 12px;
        align-items: center;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-soft);
        border: 0.5px solid var(--border-color);
        box-sizing: border-box;
    }
    .add-subject-form.import-form {
        flex-direction: column;
        align-items: flex-start;
        justify-content: flex-start;
        padding: 12px 14px;
    }
    .add-subject-form.import-form input[type="file"] {
        width: 100%;
        padding: 8px 12px;
        border: 0.5px solid var(--border-color);
        border-radius: var(--radius-md);
        background: var(--card-bg-solid);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        box-sizing: border-box;
    }
    .add-subject-form.import-form input[type="file"]:hover {
        border-color: var(--border-color);
    }
    .add-subject-form.import-form input[type="file"]:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    .add-subject-form.import-form input[type="file"]::-webkit-file-upload-button {
        padding: 8px 16px;
        border: 0.5px solid var(--border-color);
        border-radius: var(--radius-md);
        background: rgba(142, 142, 147, 0.1);
        color: var(--text-color);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        margin-right: 12px;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .add-subject-form.import-form input[type="file"]::-webkit-file-upload-button:hover {
        background: rgba(142, 142, 147, 0.15);
    }
    .add-subject-form.import-form input[type="file"]::file-selector-button {
        padding: 8px 16px;
        border: 0.5px solid var(--border-color);
        border-radius: var(--radius-md);
        background: rgba(142, 142, 147, 0.1);
        color: var(--text-color);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        margin-right: 12px;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .add-subject-form.import-form input[type="file"]::file-selector-button:hover {
        background: rgba(142, 142, 147, 0.15);
    }
    .add-subject-form input {
        flex: 1;
        min-width: 200px;
    }
    
    /* æœç´¢æ¡† */
    .search-box {
        position: relative;
        display: inline-block;
    }
    .search-box input {
        padding-left: 14px;
        width: 250px;
        transition: width 0.3s, border-color 0.3s;
    }
    .search-box input:focus {
        width: 320px;
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    .search-icon {
        display: none;
    }
    
    /* è¾“å…¥æ¡†ä¼˜åŒ– */
    input[type="text"] {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    input[type="text"]:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px var(--primary-light);
    }
    
    /* è¡¨æ ¼ä¼˜åŒ– - iOS 18é£æ ¼ */
    .table-wrapper {
        border-radius: var(--radius-lg);
        overflow: visible; /* æ”¹ä¸ºvisibleï¼Œè®©ä¸‹æ‹‰èœå•å¯ä»¥æ˜¾ç¤ºåœ¨è¡¨æ ¼å¤–éƒ¨ */
        border: 0.5px solid var(--border-color);
        box-shadow: var(--shadow-soft);
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }
    th, td {
        border-bottom: 1px solid var(--border-color);
        padding: 16px;
        text-align: left;
        vertical-align: middle;
    }
    thead th {
        background: rgba(142, 142, 147, 0.06);
        border-bottom: 0.5px solid var(--border-color);
        font-weight: 600;
        color: var(--text-color);
        font-size: 13px;
        text-transform: none;
        letter-spacing: -0.01em;
    }
    tbody tr {
        transition: all 0.2s;
    }
    tbody tr:hover {
        background-color: rgba(142, 142, 147, 0.08);
        transform: scale(1.01);
    }
    tbody tr:last-child td {
        border-bottom: none;
    }
    
    /* ç§‘ç›®åç§°æ ·å¼ */
    .subject-name {
        font-size: 16px;
        font-weight: 500;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .subject-icon {
        display: none;
    }
    
    /* é¢˜ç›®æ•°é‡å¾½ç«  - iOS 18é£æ ¼ */
    .question-count {
        display: inline-flex;
        align-items: center;
        gap: 0;
        padding: 6px 12px;
        background: rgba(142, 142, 147, 0.1);
        color: var(--text-color);
        border-radius: var(--radius-sm);
        font-size: 13px;
        font-weight: 500;
        border: 0.5px solid var(--border-color);
    }
    .question-count.empty {
        background: rgba(142, 142, 147, 0.1);
        color: var(--text-sub);
        border-color: var(--border-color);
    }
    
    /* æ“ä½œæŒ‰é’®ä¼˜åŒ– - ä¸‹æ‹‰èœå•æ ·å¼ */
    .action-dropdown {
        position: relative;
        display: inline-block;
    }
    .btn-action {
        background: rgba(142, 142, 147, 0.1);
        color: var(--text-color);
        border: 0.5px solid var(--border-color);
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .btn-action:hover {
        background: rgba(142, 142, 147, 0.15);
    }
    .action-menu {
        display: none;
        position: absolute;
        left: 100%; /* å®šä½åˆ°æŒ‰é’®å³ä¾§ */
        top: 0; /* ä¸æŒ‰é’®é¡¶éƒ¨å¯¹é½ */
        margin-left: 8px; /* ä¸æŒ‰é’®çš„é—´è· */
        min-width: 160px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 0.5px solid var(--border-color);
        border-radius: var(--radius-md);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        padding: 4px 0;
        z-index: 1000; /* æé«˜z-indexï¼Œç¡®ä¿èœå•æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚ */
        animation: slideRight 0.2s ease; /* æ”¹ä¸ºä»å·¦ä¾§æ»‘å…¥ */
    }
    [data-theme="dark"] .action-menu {
        background: rgba(28, 28, 30, 0.95);
        border-color: rgba(255, 255, 255, 0.15);
    }
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideRight {
        from { opacity: 0; transform: translateX(-10px); }
        to { opacity: 1; transform: translateX(0); }
    }
    .action-menu.open {
        display: block;
    }
    .action-item {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 10px 16px;
        background: none;
        border: none;
        text-align: left;
        cursor: pointer;
        font-size: 14px;
        color: var(--text-color);
        transition: background 0.2s;
        font-weight: 400;
    }
    .action-item:hover {
        background: rgba(142, 142, 147, 0.1);
    }
    .action-item:active {
        background: rgba(142, 142, 147, 0.15);
    }
    .action-icon {
        font-size: 16px;
        width: 20px;
        text-align: center;
    }
    .action-text {
        flex: 1;
    }
    .action-item.action-danger {
        color: var(--danger);
    }
    .action-item.action-danger:hover {
        background: rgba(255, 59, 48, 0.1);
    }
    .action-item.action-warning {
        color: var(--warning);
    }
    .action-item.action-warning:hover {
        background: rgba(255, 149, 0, 0.1);
    }
    .action-item.action-success {
        color: var(--success);
    }
    .action-item.action-success:hover {
        background: rgba(52, 199, 89, 0.1);
    }
    .action-divider {
        height: 0.5px;
        background: var(--border-color);
        margin: 4px 0;
    }
    .btn-sm {
        padding: 8px 16px;
        min-height: 36px;
        font-size: 14px;
        border-radius: var(--radius-md);
        border: none;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        white-space: nowrap;
        font-weight: 500;
    }
    .btn-sm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .btn-manage {
        background: var(--primary);
        color: white;
    }
    .btn-manage:hover {
        background: var(--primary);
        opacity: 0.9;
    }
    .btn-edit {
        background: rgba(142, 142, 147, 0.1);
        color: var(--text-color);
        border: 0.5px solid var(--border-color);
    }
    .btn-edit:hover {
        background: rgba(142, 142, 147, 0.15);
    }
    .btn-delete {
        background: rgba(255, 59, 48, 0.1);
        color: var(--danger);
        border: 0.5px solid rgba(255, 59, 48, 0.2);
    }
    .btn-delete:hover {
        background: rgba(255, 59, 48, 0.15);
    }
    .btn-warning {
        background: rgba(255, 149, 0, 0.7);
        backdrop-filter: blur(20px);
        color: white;
        border: 0.5px solid rgba(255, 149, 0, 0.3);
    }
    .btn-warning:hover {
        background: rgba(255, 149, 0, 0.85);
        transform: translateY(-1px);
        box-shadow: var(--shadow-soft);
    }
    .btn-success {
        background: rgba(52, 199, 89, 0.7);
        backdrop-filter: blur(20px);
        color: white;
        border: 0.5px solid rgba(52, 199, 89, 0.3);
    }
    .btn-success:hover {
        background: rgba(52, 199, 89, 0.85);
        transform: translateY(-1px);
        box-shadow: var(--shadow-soft);
    }
    
    /* æ¨¡æ€æ¡† */
    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s;
    }
    .modal-overlay.show {
        display: flex;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .modal-content {
        background: var(--card-bg);
        backdrop-filter: blur(40px) saturate(180%);
        -webkit-backdrop-filter: blur(40px) saturate(180%);
        padding: 32px;
        border-radius: var(--radius-xl);
        width: 450px;
        max-width: 90vw;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        border: 0.5px solid var(--border-color);
        animation: slideUp 0.3s;
    }
    @keyframes slideUp {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .modal-header {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 20px;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .modal-body {
        margin-bottom: 24px;
    }
    .form-group {
        margin-bottom: 16px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-color);
    }
    .form-group input {
        width: 100%;
        box-sizing: border-box;
    }
    .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: var(--text-sub);
    }
    .empty-state-icon {
        display: none;
    }
    .empty-state-text {
        font-size: 18px;
        margin-bottom: 10px;
        font-weight: 500;
        color: var(--text-color);
    }
    .empty-state-hint {
        font-size: 14px;
        color: var(--text-sub);
        margin-bottom: 24px;
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-sub);
    }
    .loading-spinner {
        display: inline-block;
    }

    /* å¯¼å…¥ç»“æœæ ·å¼ */
    #importResult {
        padding: 16px;
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.6;
        margin-top: 16px;
        border: 1px solid transparent;
    }
    #importResult.success {
        background-color: rgba(52, 199, 89, 0.15);
        border-color: rgba(52, 199, 89, 0.3);
        color: var(--success);
    }
    #importResult.warning {
        background-color: rgba(255, 149, 0, 0.15);
        border-color: rgba(255, 149, 0, 0.3);
        color: var(--warning);
    }
    #importResult.error {
        background-color: rgba(255, 59, 48, 0.15);
        border-color: rgba(255, 59, 48, 0.3);
        color: var(--danger);
    }
    #importResult ul {
        margin-top: 10px;
        padding-left: 20px;
        max-height: 200px;
        overflow-y: auto;
        background: rgba(142, 142, 147, 0.05);
        padding-top: 10px;
        padding-bottom: 10px;
        border-radius: 4px;
    }
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-header">
        <div class="page-title">
            <span>ç§‘ç›®ç®¡ç†</span>
        </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-row">
        <div class="stat-card total">
            <div class="stat-card-label">æ€»ç§‘ç›®æ•°</div>
            <div class="stat-card-value" id="statTotal">0</div>
        </div>
        <div class="stat-card questions">
            <div class="stat-card-label">æ€»é¢˜ç›®æ•°</div>
            <div class="stat-card-value" id="statQuestions">0</div>
        </div>
        <div class="stat-card avg">
            <div class="stat-card-label">å¹³å‡é¢˜ç›®æ•°</div>
            <div class="stat-card-value" id="statAvg">0</div>
        </div>
    </div>

    <!-- è¡¨å•å®¹å™¨ - åŒä¸€è¡Œæ˜¾ç¤º -->
    <div class="forms-row">
        <!-- æ·»åŠ ç§‘ç›®è¡¨å• -->
        <div class="add-subject-form">
            <div style="display: flex; gap: 12px; align-items: center; width: 100%;">
                <span style="font-weight: 500; color: var(--text-color); white-space: nowrap;">æ·»åŠ æ–°ç§‘ç›®ï¼š</span>
                <input type="text" id="subjectName" placeholder="è¯·è¾“å…¥ç§‘ç›®åç§°ï¼Œä¾‹å¦‚ï¼šè®¡ç®—æœºç½‘ç»œ" onkeydown="if(event.key==='Enter') addSubject()" style="flex: 1; min-width: 0;">
                <button class="btn-primary" onclick="addSubject()">ç«‹å³æ·»åŠ </button>
            </div>
        </div>

        <!-- é¢˜åº“å¯¼å…¥ -->
        <div class="add-subject-form import-form">
            <div style="font-weight: 500; color: var(--text-color); font-size: 14px; margin-bottom: 8px;">æ‰¹é‡å¯¼å…¥é¢˜åº“</div>
            <div style="display: flex; gap: 12px; align-items: flex-start; width: 100%; margin-bottom: 6px;">
                <div style="flex: 1; min-width: 0;">
                    <input type="file" id="importFile" accept=".xlsx" style="width: 100%;">
                </div>
                <button class="btn-primary" onclick="importFromExcel()" id="importBtn" style="flex-shrink: 0; margin-top: 0;">å¼€å§‹å¯¼å…¥</button>
            </div>
            <div style="font-size: 12px; color: var(--text-sub); line-height: 1.4;">
                <a href="/admin/download_template" style="color: var(--primary); font-weight: 500; text-decoration: none;">ä¸‹è½½Excelæ¨¡æ¿æ–‡ä»¶</a>
            </div>
            <div id="importResult" style="width: 100%; display: none; margin-top: 8px;"></div>
        </div>
    </div>

    <!-- å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-left">
            <span style="font-size: 16px; font-weight: 500; color: var(--text-color);">ç§‘ç›®åˆ—è¡¨</span>
        </div>
        <div class="toolbar-right">
            <div class="search-box">
                <span class="search-icon"></span>
                <input type="text" id="searchInput" placeholder="æœç´¢ç§‘ç›®åç§°..." oninput="filterSubjects()">
            </div>
        </div>
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th style="width: 80px;">åºå·</th>
                    <th>ç§‘ç›®åç§°</th>
                    <th style="width: 150px;">é¢˜ç›®æ•°é‡</th>
                    <th style="width: 100px;">çŠ¶æ€</th>
                    <th style="width: 120px;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="subjectTableBody">
                <tr>
                    <td colspan="5" class="loading-state">
                        <div class="loading-spinner"></div>
                        <div>åŠ è½½ä¸­...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ç¼–è¾‘ç§‘ç›®æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="editModal" onclick="if(event.target===this) closeEditModal()">
    <div class="modal-content">
        <div class="modal-header">
            <span>ç¼–è¾‘ç§‘ç›®</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>ç§‘ç›®åç§° *</label>
                <input type="text" id="editSubjectName" placeholder="è¯·è¾“å…¥æ–°çš„ç§‘ç›®åç§°">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
            <button class="btn-primary" onclick="confirmEdit()">ä¿å­˜ä¿®æ”¹</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allSubjects = [];
    let editingSubjectId = null;
    
    const subjectIcons = {
        'è®¡ç®—æœº': 'ğŸ’»',
        'ç½‘ç»œ': 'ğŸŒ',
        'æ•°å­¦': 'ğŸ”¢',
        'è‹±è¯­': 'ğŸ”¤',
        'ç‰©ç†': 'âš›ï¸',
        'åŒ–å­¦': 'ğŸ§ª',
        'ç”Ÿç‰©': 'ğŸ§¬',
        'å†å²': 'ğŸ“œ',
        'åœ°ç†': 'ğŸŒ',
        'æ”¿æ²»': 'ğŸ›ï¸',
        'è¯­æ–‡': 'ğŸ“–',
        'é»˜è®¤': 'ğŸ“š'
    };
    
    function getSubjectIcon(name) {
        for (const [key, icon] of Object.entries(subjectIcons)) {
            if (name.includes(key)) return icon;
        }
        return subjectIcons['é»˜è®¤'];
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    async function loadSubjects() {
        try {
            const res = await fetch('/admin/api/subjects');
            if (!res.ok) throw new Error('ç½‘ç»œé”™è¯¯');
            allSubjects = await res.json();
            updateStats();
            renderSubjects();
        } catch (e) {
            console.error('åŠ è½½ç§‘ç›®å¤±è´¥:', e);
            showError('åŠ è½½ç§‘ç›®å¤±è´¥: ' + e.message);
        }
    }
    
    function updateStats() {
        const total = allSubjects.length;
        const totalQuestions = allSubjects.reduce((sum, s) => sum + (s.question_count || 0), 0);
        const avg = total > 0 ? Math.round(totalQuestions / total) : 0;
        
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statQuestions').textContent = totalQuestions;
        document.getElementById('statAvg').textContent = avg;
    }
    
    function renderSubjects(filtered = null) {
        const subjects = filtered || allSubjects;
        const tbody = document.getElementById('subjectTableBody');
        tbody.innerHTML = '';
        
        if (subjects.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="empty-state">
                        <div class="empty-state-text">æš‚æ— ç§‘ç›®æ•°æ®</div>
                        <div class="empty-state-hint">ç‚¹å‡»ä¸Šæ–¹"ç«‹å³æ·»åŠ "æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªç§‘ç›®</div>
                        <button class="btn-primary" onclick="document.getElementById('subjectName').focus()">
                            ç«‹å³æ·»åŠ ç§‘ç›®
                        </button>
                    </td>
                </tr>
            `;
            return;
        }
        
        subjects.forEach((sub, idx) => {
            const tr = document.createElement('tr');
            const icon = getSubjectIcon(sub.name);
            const count = sub.question_count || 0;
            const countClass = count === 0 ? 'empty' : '';
            const isLocked = sub.is_locked === 1;
            const lockStatus = isLocked ? '<span style="color: var(--danger, #ff3b30); font-weight: 500;">ğŸ”’ å·²é”å®š</span>' : '<span style="color: var(--success, #34c759); font-weight: 500;">âœ“ æ­£å¸¸</span>';
            
            tr.innerHTML = `
                <td style="text-align: center; font-weight: 500; color: var(--text-sub);">${idx + 1}</td>
                <td>
                    <div class="subject-name">
                        <span>${escapeHtml(sub.name)}</span>
                    </div>
                </td>
                <td>
                    <span class="question-count ${countClass}">
                        ${count} é“é¢˜
                    </span>
                </td>
                <td style="text-align: center;">
                    ${lockStatus}
                </td>
                <td>
                    <div class="dropdown action-dropdown">
                        <button class="btn-sm btn-action" onclick="toggleActionMenu(${sub.id}, event)">
                            <span>æ“ä½œ</span>
                            <span style="margin-left: 4px; font-size: 12px;">â–¼</span>
                        </button>
                        <div id="action-menu-${sub.id}" class="action-menu dropdown-menu">
                            <button class="action-item" onclick="gotoQuestions(${sub.id}); closeActionMenu(${sub.id});">
                                <span class="action-text">é¢˜é›†ç®¡ç†</span>
                            </button>
                            <button class="action-item" onclick="openEditModal(${sub.id}); closeActionMenu(${sub.id});">
                                <span class="action-text">ç¼–è¾‘</span>
                            </button>
                            ${isLocked 
                                ? `<button class="action-item action-success" onclick="unlockSubject(${sub.id}); closeActionMenu(${sub.id});">
                                    <span class="action-text">è§£é”</span>
                                </button>`
                                : `<button class="action-item action-warning" onclick="lockSubject(${sub.id}); closeActionMenu(${sub.id});">
                                    <span class="action-text">é”å®š</span>
                                </button>`
                            }
                            <div class="action-divider"></div>
                            <button class="action-item action-danger" onclick="deleteSubject(${sub.id}); closeActionMenu(${sub.id});">
                                <span class="action-text">åˆ é™¤</span>
                            </button>
                        </div>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }
    
    function filterSubjects() {
        const keyword = document.getElementById('searchInput').value.toLowerCase().trim();
        if (!keyword) {
            renderSubjects();
            return;
        }
        const filtered = allSubjects.filter(s => s.name.toLowerCase().includes(keyword));
        renderSubjects(filtered);
    }
    
    async function addSubject() {
        const nameInput = document.getElementById('subjectName');
        const name = nameInput.value.trim();
        
        if (!name) {
            showError('è¯·è¾“å…¥ç§‘ç›®åç§°');
            nameInput.focus();
            return;
        }
        
        if (allSubjects.some(s => s.name === name)) {
            showError('è¯¥ç§‘ç›®å·²å­˜åœ¨');
            return;
        }
        
        try {
            const res = await fetch('/admin/api/subjects', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            const result = await res.json();
            
            if (result.status === 'success') {
                showSuccess(result.message || 'ç§‘ç›®æ·»åŠ æˆåŠŸ');
                nameInput.value = '';
                loadSubjects();
            } else {
                showError(result.message || 'æ·»åŠ å¤±è´¥');
            }
        } catch (e) {
            console.error('æ·»åŠ ç§‘ç›®å¤±è´¥:', e);
            showError('æ·»åŠ å¤±è´¥: ' + e.message);
        }
    }
    
    function openEditModal(id) {
        const subject = allSubjects.find(s => s.id === id);
        if (!subject) return;
        
        editingSubjectId = id;
        document.getElementById('editSubjectName').value = subject.name;
        document.getElementById('editModal').classList.add('show');
        document.body.style.overflow = 'hidden';
        
        setTimeout(() => {
            const input = document.getElementById('editSubjectName');
            input.focus();
            input.select();
        }, 100);
    }
    
    function closeEditModal() {
        document.getElementById('editModal').classList.remove('show');
        document.body.style.overflow = '';
        editingSubjectId = null;
    }
    
    async function confirmEdit() {
        if (!editingSubjectId) return;
        
        const newName = document.getElementById('editSubjectName').value.trim();
        const oldSubject = allSubjects.find(s => s.id === editingSubjectId);
        
        if (!newName) {
            showError('è¯·è¾“å…¥ç§‘ç›®åç§°');
            return;
        }
        
        if (newName === oldSubject.name) {
            closeEditModal();
            return;
        }
        
        if (allSubjects.some(s => s.id !== editingSubjectId && s.name === newName)) {
            showError('è¯¥ç§‘ç›®åç§°å·²å­˜åœ¨');
            return;
        }
        
        try {
            const res = await fetch(`/admin/api/subjects/${editingSubjectId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName })
            });
            const result = await res.json();
            
            if (result.status === 'success') {
                showSuccess(result.message || 'ç§‘ç›®ä¿®æ”¹æˆåŠŸ');
                closeEditModal();
                loadSubjects();
            } else {
                showError(result.message || 'ä¿®æ”¹å¤±è´¥');
            }
        } catch (e) {
            console.error('ä¿®æ”¹ç§‘ç›®å¤±è´¥:', e);
            showError('ä¿®æ”¹å¤±è´¥: ' + e.message);
        }
    }

    async function deleteSubject(id) {
        const subject = allSubjects.find(s => s.id === id);
        if (!subject) return;
        
        const count = subject.question_count || 0;
        let confirmMsg = `âš ï¸ ç¡®å®šè¦åˆ é™¤ç§‘ç›®"${subject.name}"å—ï¼Ÿ`;
        if (count > 0) {
            confirmMsg += `\n\nè¯¥ç§‘ç›®ä¸‹æœ‰ ${count} é“é¢˜ç›®ã€‚`;
        }
        confirmMsg += '\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼';
        
        if (!confirm(confirmMsg)) return;
        
        try {
            let res = await fetch(`/admin/api/subjects/${id}`, { method: 'DELETE' });
            let result = await res.json();
            
            if (res.ok && result.status === 'success') {
                showSuccess(result.message || 'ç§‘ç›®åˆ é™¤æˆåŠŸ');
                loadSubjects();
                return;
            }
            
            if (res.status === 400 && /æ— æ³•ç›´æ¥åˆ é™¤/.test(result.message || '')) {
                if (confirm(`${result.message}\n\nâš ï¸ æ˜¯å¦å¼ºåˆ¶åˆ é™¤è¯¥ç§‘ç›®åŠå…¶ä¸‹æ‰€æœ‰ ${count} é“é¢˜ç›®ï¼Ÿ\n\næ­¤æ“ä½œå°†ï¼š\nâ€¢ åˆ é™¤ç§‘ç›®"${subject.name}"\nâ€¢ åˆ é™¤è¯¥ç§‘ç›®ä¸‹çš„æ‰€æœ‰é¢˜ç›®\nâ€¢ æ¸…é™¤ç›¸å…³çš„æ”¶è—å’Œé”™é¢˜è®°å½•\nâ€¢ æ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                    res = await fetch(`/admin/api/subjects/${id}?force=1`, { method: 'DELETE' });
                    result = await res.json();
                    
                    if (result.status === 'success') {
                        showSuccess(result.message || 'ç§‘ç›®åŠé¢˜ç›®å·²å…¨éƒ¨åˆ é™¤');
                        loadSubjects();
                    } else {
                        showError(result.message || 'å¼ºåˆ¶åˆ é™¤å¤±è´¥');
                    }
                }
                return;
            }
            
            showError(result.message || 'åˆ é™¤å¤±è´¥');
        } catch (e) {
            console.error('åˆ é™¤ç§‘ç›®å¤±è´¥:', e);
            showError('åˆ é™¤å¤±è´¥: ' + e.message);
        }
    }

    async function lockSubject(id) {
        const subject = allSubjects.find(s => s.id === id);
        if (!subject) return;
        
        if (!confirm(`ç¡®å®šè¦é”å®šç§‘ç›®"${subject.name}"å—ï¼Ÿ\n\né”å®šåï¼Œç”¨æˆ·å°†æ— æ³•æŸ¥çœ‹å’Œä½¿ç”¨è¯¥ç§‘ç›®ï¼Œå‰å°ä¹Ÿä¸ä¼šæ˜¾ç¤ºè¯¥ç§‘ç›®ã€‚`)) {
            return;
        }
        
        try {
            const res = await fetch(`/admin/api/subjects/${id}/lock`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const result = await res.json();
            
            if (res.ok && result.status === 'success') {
                showSuccess(result.message || 'ç§‘ç›®å·²é”å®š');
                loadSubjects();
            } else {
                showError(result.message || 'é”å®šå¤±è´¥');
            }
        } catch (e) {
            console.error('é”å®šç§‘ç›®å¤±è´¥:', e);
            showError('é”å®šå¤±è´¥: ' + e.message);
        }
    }
    
    async function unlockSubject(id) {
        const subject = allSubjects.find(s => s.id === id);
        if (!subject) return;
        
        try {
            const res = await fetch(`/admin/api/subjects/${id}/unlock`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const result = await res.json();
            
            if (res.ok && result.status === 'success') {
                showSuccess(result.message || 'ç§‘ç›®å·²è§£é”');
                loadSubjects();
            } else {
                showError(result.message || 'è§£é”å¤±è´¥');
            }
        } catch (e) {
            console.error('è§£é”ç§‘ç›®å¤±è´¥:', e);
            showError('è§£é”å¤±è´¥: ' + e.message);
        }
    }
    
    function toggleActionMenu(subjectId, event) {
        event.stopPropagation();
        const menuId = `action-menu-${subjectId}`;
        const menu = document.getElementById(menuId);
        const isOpen = menu.classList.contains('open') || menu.style.display === 'block';
        
        // å…ˆå…³é—­æ‰€æœ‰å…¶ä»–èœå•
        document.querySelectorAll('.action-menu').forEach(m => {
            m.classList.remove('open');
            m.style.display = 'none';
        });
        
        if (!isOpen) {
            menu.classList.add('open');
            menu.style.display = 'block';
        }
    }
    
    function closeActionMenu(subjectId) {
        const menuId = `action-menu-${subjectId}`;
        const menu = document.getElementById(menuId);
        if (menu) {
            menu.classList.remove('open');
            menu.style.display = 'none';
        }
    }
    
    function gotoQuestions(id) {
        window.location.href = `/admin/subjects/${id}/questions`;
    }
    
    function showSuccess(message) {
        alert('âœ… ' + message);
    }
    
    function showError(message) {
        alert('âŒ ' + message);
    }

    async function importFromExcel() {
        const fileInput = document.getElementById('importFile');
        const importBtn = document.getElementById('importBtn');
        const resultDiv = document.getElementById('importResult');

        if (fileInput.files.length === 0) {
            showError('è¯·å…ˆé€‰æ‹©ä¸€ä¸ª .xlsx æ–‡ä»¶');
            return;
        }

        const file = fileInput.files[0];
        if (!file.name.endsWith('.xlsx')) {
            showError('åªå…è®¸ä¸Šä¼  .xlsx æ–‡ä»¶');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        importBtn.disabled = true;
        importBtn.textContent = 'å¯¼å…¥ä¸­...';
        resultDiv.style.display = 'none';
        resultDiv.className = '';

        let importResult = null;
        try {
            const res = await fetch('/admin/api/questions/import/excel', {
                method: 'POST',
                body: formData
            });
            importResult = await res.json();

            resultDiv.style.display = 'block';
            resultDiv.className = importResult.status; // 'success', 'warning', or 'error'

            let html = `<strong>${escapeHtml(importResult.message)}</strong>`;
            if (importResult.errors && importResult.errors.length > 0) {
                html += '<ul>';
                importResult.errors.forEach(err => {
                    html += `<li>${escapeHtml(err)}</li>`;
                });
                html += '</ul>';
            }
            resultDiv.innerHTML = html;

            if (importResult.status !== 'error') {
                // å¯¼å…¥æˆåŠŸæˆ–éƒ¨åˆ†æˆåŠŸåï¼Œåˆ·æ–°ç§‘ç›®åˆ—è¡¨
                loadSubjects();
            }

        } catch (e) {
            resultDiv.style.display = 'block';
            resultDiv.className = 'error';
            resultDiv.innerHTML = `<strong>å¯¼å…¥å¤±è´¥:</strong> ${escapeHtml(e.message)}`;
        } finally {
            importBtn.disabled = false;
            importBtn.textContent = 'å¼€å§‹å¯¼å…¥';
            // å¯¼å…¥å®Œæˆåæ¸…ç©ºæ–‡ä»¶é€‰æ‹©
            if (importResult && (importResult.status === 'success' || importResult.status === 'warning')) {
                fileInput.value = '';
            }
        }
    }

    // ç‚¹å‡»å¤–éƒ¨å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.action-dropdown')) {
            document.querySelectorAll('.action-menu').forEach(m => {
                m.classList.remove('open');
                m.style.display = 'none';
            });
        }
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        loadSubjects();
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeEditModal();
                // å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
                document.querySelectorAll('.action-menu').forEach(m => {
                    m.classList.remove('open');
                    m.style.display = 'none';
                });
            }
        });
        
        document.getElementById('editSubjectName').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                confirmEdit();
            }
        });
    });
</script>
{% endblock %}
