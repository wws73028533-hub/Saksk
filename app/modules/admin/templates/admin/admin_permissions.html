{% extends "admin/admin_base.html" %}

{% block title %}æƒé™ç®¡ç†{% endblock %}

{% block head %}
<style>
    .container { 
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        padding: 40px; 
        border-radius: var(--radius-lg); 
        box-shadow: var(--shadow-soft);
        border: 0.5px solid var(--border-color);
    }
    h1 { font-size: 22px; margin: 0; }
    .toolbar { 
        display:flex; 
        justify-content: space-between; 
        align-items: center; 
        gap: 12px; 
        margin-bottom: 24px; 
        flex-wrap: wrap; 
    }
    .toolbar-left { display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }
    .toolbar-right { display:flex; align-items:center; gap: 8px; flex-wrap: wrap; }
    
    /* æœç´¢æ¡† */
    .search-box {
        position: relative;
        display: inline-block;
    }
    .search-box input {
        padding: 10px 12px;
        padding-left: 36px;
        width: 250px;
        border: 0.5px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 14px;
        background: rgba(255, 255, 255, 0.8);
        transition: all 0.25s;
    }
    .search-box input:focus {
        width: 300px;
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-sub);
        font-size: 14px;
    }
    
    /* æ‰¹é‡æ“ä½œæ  */
    .batch-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        background: rgba(0, 122, 255, 0.05);
        border-radius: var(--radius-md);
        border: 0.5px solid rgba(0, 122, 255, 0.15);
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .batch-actions.hidden {
        display: none;
    }
    .selected-count {
        font-weight: 600;
        color: var(--primary);
    }
    .permission-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .permission-btn {
        padding: 8px 16px;
        border-radius: var(--radius-md);
        border: 0.5px solid var(--border-color);
        background: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.25s;
    }
    .permission-btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-soft);
    }
    .permission-btn.subject-admin {
        border-color: rgba(255, 149, 0, 0.3);
        color: var(--warning);
        background: rgba(255, 149, 0, 0.08);
    }
    .permission-btn.subject-admin:hover {
        background: rgba(255, 149, 0, 0.12);
    }
    .permission-btn.notification-admin {
        border-color: rgba(0, 122, 255, 0.3);
        color: var(--primary);
        background: rgba(0, 122, 255, 0.08);
    }
    .permission-btn.notification-admin:hover {
        background: rgba(0, 122, 255, 0.12);
    }
    .permission-btn.remove {
        border-color: rgba(255, 59, 48, 0.3);
        color: var(--danger);
        background: rgba(255, 59, 48, 0.08);
    }
    .permission-btn.remove:hover {
        background: rgba(255, 59, 48, 0.12);
    }
    
    /* è¡¨æ ¼æ ·å¼ */
    .table-wrapper {
        border-radius: var(--radius-lg);
        overflow: hidden;
        border: 0.5px solid var(--border-color);
        box-shadow: var(--shadow-soft);
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
    }
    table { 
        width:100%; 
        border-collapse:collapse;
        table-layout: fixed;
    }
    th, td { 
        padding: 14px 16px; 
        border-bottom:0.5px solid var(--border-color); 
        text-align:left; 
    }
    thead th { 
        background: rgba(142, 142, 147, 0.06);
        font-weight:600;
        position: sticky;
        top: 0;
        z-index: 10;
        color: var(--text-color);
        font-size: 13px;
        letter-spacing: -0.01em;
    }
    tbody tr {
        transition: background-color 0.2s;
        height: 60px;
    }
    tbody tr:hover { 
        background: rgba(142, 142, 147, 0.08); 
    }
    tbody tr:last-child td {
        border-bottom: none;
    }
    tbody td {
        vertical-align: middle;
    }
    
    /* å¤é€‰æ¡†æ ·å¼ */
    .checkbox-cell {
        width: 50px;
        text-align: center;
    }
    input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--primary);
    }
    
    /* æƒé™æ ‡ç­¾ */
    .permission-tags {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }
    .permission-tag {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        white-space: nowrap;
    }
    .permission-tag.admin {
        background: rgba(255, 59, 48, 0.1);
        color: var(--danger);
        border: 0.5px solid rgba(255, 59, 48, 0.2);
    }
    .permission-tag.subject-admin {
        background: rgba(255, 149, 0, 0.1);
        color: var(--warning);
        border: 0.5px solid rgba(255, 149, 0, 0.2);
    }
    .permission-tag.notification-admin {
        background: rgba(0, 122, 255, 0.1);
        color: var(--primary);
        border: 0.5px solid rgba(0, 122, 255, 0.2);
    }
    .permission-tag.none {
        background: rgba(142, 142, 147, 0.1);
        color: var(--text-sub);
        border: 0.5px solid var(--border-color);
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-sub);
    }
    .empty-state-text {
        font-size: 16px;
        margin-bottom: 8px;
    }
    .empty-state-hint {
        font-size: 14px;
        opacity: 0.7;
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-sub);
    }
    .loading-spinner {
        width: 24px;
        height: 24px;
        border: 3px solid var(--border-color);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 12px;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* åˆ†é¡µ */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin-top: 24px;
        flex-wrap: wrap;
    }
    .pagination button {
        padding: 8px 16px;
        border: 0.5px solid var(--border-color);
        border-radius: var(--radius-md);
        background: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        font-size: 14px;
        transition: all 0.25s;
    }
    .pagination button:hover:not(:disabled) {
        background: rgba(142, 142, 147, 0.1);
        transform: translateY(-1px);
    }
    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .page-info {
        font-size: 14px;
        color: var(--text-sub);
    }
    
    /* ç»Ÿè®¡å¡ç‰‡ - iOS 18é£æ ¼ */
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
    }
    .stat-card {
        padding: 20px;
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        color: var(--text-color);
        box-shadow: var(--shadow-soft);
        border: 0.5px solid var(--border-color);
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
        border-color: var(--border-color);
    }
    .stat-card.subject-admin {
        background: rgba(255, 149, 0, 0.08);
        border-color: rgba(255, 149, 0, 0.15);
    }
    .stat-card.notification-admin {
        background: rgba(0, 122, 255, 0.08);
        border-color: rgba(0, 122, 255, 0.15);
    }
    .stat-card-label {
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 4px;
        color: var(--text-sub);
        font-weight: 500;
    }
    .stat-card-value {
        font-size: 28px;
        font-weight: 600;
        letter-spacing: -0.5px;
        color: var(--text-color);
    }
    
    /* æ“ä½œæŒ‰é’®æ ·å¼ */
    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
        border-radius: var(--radius-md);
        border: 0.5px solid var(--border-color);
        cursor: pointer;
        transition: all 0.25s;
        font-weight: 500;
    }
    .btn-action {
        background: rgba(255, 255, 255, 0.8);
        color: var(--text-color);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
    }
    .btn-action:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-soft);
    }
    
    /* é»‘å¤œæ¨¡å¼ - æ“ä½œæŒ‰é’® */
    [data-theme="dark"] .btn-action {
        background: rgba(28, 28, 30, 0.8);
        color: var(--text-color);
        border-color: rgba(255, 255, 255, 0.15);
    }
    [data-theme="dark"] .btn-action:hover {
        background: rgba(28, 28, 30, 0.9);
        border-color: rgba(255, 255, 255, 0.2);
    }
    
    /* æ¿€æ´»çŠ¶æ€çš„æŒ‰é’®æ ·å¼ */
    .btn-action-active.btn-action-subject {
        background: rgba(255, 149, 0, 0.1);
        color: var(--warning);
        border-color: rgba(255, 149, 0, 0.2);
    }
    .btn-action-active.btn-action-subject:hover {
        background: rgba(255, 149, 0, 0.15);
        border-color: rgba(255, 149, 0, 0.3);
    }
    
    .btn-action-active.btn-action-notification {
        background: rgba(0, 122, 255, 0.1);
        color: var(--primary);
        border-color: rgba(0, 122, 255, 0.2);
    }
    .btn-action-active.btn-action-notification:hover {
        background: rgba(0, 122, 255, 0.15);
        border-color: rgba(0, 122, 255, 0.3);
    }
    
    /* é»‘å¤œæ¨¡å¼ - æ¿€æ´»çŠ¶æ€çš„æŒ‰é’®æ ·å¼ */
    [data-theme="dark"] .btn-action-active.btn-action-subject {
        background: rgba(255, 149, 0, 0.15) !important;
        color: var(--warning) !important;
        border-color: rgba(255, 149, 0, 0.3) !important;
    }
    [data-theme="dark"] .btn-action-active.btn-action-subject:hover {
        background: rgba(255, 149, 0, 0.2) !important;
        border-color: rgba(255, 149, 0, 0.4) !important;
    }
    
    [data-theme="dark"] .btn-action-active.btn-action-notification {
        background: rgba(10, 132, 255, 0.15) !important;
        color: var(--primary) !important;
        border-color: rgba(10, 132, 255, 0.3) !important;
    }
    [data-theme="dark"] .btn-action-active.btn-action-notification:hover {
        background: rgba(10, 132, 255, 0.2) !important;
        border-color: rgba(10, 132, 255, 0.4) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="toolbar">
        <div class="toolbar-left">
            <h1>æƒé™ç®¡ç†</h1>
        </div>
        <div class="toolbar-right">
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" id="searchInput" placeholder="æœç´¢ç”¨æˆ·å" onkeydown="if(event.key==='Enter') loadUsers(1)" oninput="handleSearch()">
            </div>
            <button class="btn-outline" onclick="loadUsers(curPage)">åˆ·æ–°</button>
        </div>
    </div>
    
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-cards" id="statsCards">
        <div class="stat-card">
            <div class="stat-card-label">æ€»ç”¨æˆ·æ•°</div>
            <div class="stat-card-value" id="statTotal">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-label">åœ¨çº¿ç”¨æˆ·</div>
            <div class="stat-card-value" id="statOnline">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-label">ç®¡ç†å‘˜</div>
            <div class="stat-card-value" id="statAdmin">0</div>
        </div>
        <div class="stat-card subject-admin">
            <div class="stat-card-label">ç§‘ç›®ç®¡ç†å‘˜</div>
            <div class="stat-card-value" id="statSubjectAdmin">0</div>
        </div>

        <div class="stat-card notification-admin">
            <div class="stat-card-label">é€šçŸ¥ç®¡ç†å‘˜</div>
            <div class="stat-card-value" id="statNotificationAdmin">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-label">å·²é”å®š</div>
            <div class="stat-card-value" id="statLocked">0</div>
        </div>
    </div>
    
    <!-- æ‰¹é‡æ“ä½œæ  -->
    <div class="batch-actions hidden" id="batchActions">
        <span class="selected-count" id="selectedCount">å·²é€‰æ‹© 0 ä¸ªç”¨æˆ·</span>
        <div class="permission-buttons">
            <button class="permission-btn subject-admin" onclick="batchSetPermission('subject_admin', true)">è®¾ä¸ºç§‘ç›®ç®¡ç†å‘˜</button>
            <button class="permission-btn notification-admin" onclick="batchSetPermission('notification_admin', true)">è®¾ä¸ºé€šçŸ¥ç®¡ç†å‘˜</button>
            <button class="permission-btn subject-admin" onclick="batchSetPermission('subject_admin', false)">å–æ¶ˆç§‘ç›®ç®¡ç†å‘˜</button>
            <button class="permission-btn notification-admin" onclick="batchSetPermission('notification_admin', false)">å–æ¶ˆé€šçŸ¥ç®¡ç†å‘˜</button>
            <button class="permission-btn remove" onclick="clearSelection()">æ¸…é™¤é€‰æ‹©</button>
        </div>
    </div>
    
    <!-- è¡¨æ ¼ -->
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th style="width:50px;" class="checkbox-cell">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    </th>
                    <th style="width:6%;">ID</th>
                    <th style="width:15%;">ç”¨æˆ·å</th>
                    <th style="width:25%;">å½“å‰æƒé™</th>
                    <th style="width:18%;">åˆ›å»ºæ—¶é—´</th>
                    <th style="width:26%;">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tbody">
                <tr>
                    <td colspan="6" class="loading">
                        <div class="loading-spinner"></div>
                        <div style="margin-top: 12px;">åŠ è½½ä¸­...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- åˆ†é¡µ -->
    <div class="pagination">
        <button onclick="changePage('first')" id="btnFirst">é¦–é¡µ</button>
        <button onclick="changePage('prev')" id="btnPrev">ä¸Šä¸€é¡µ</button>
        <span class="page-info" id="pageInfo">ç¬¬ 1 é¡µ / å…± 1 é¡µ</span>
        <button onclick="changePage('next')" id="btnNext">ä¸‹ä¸€é¡µ</button>
        <button onclick="changePage('last')" id="btnLast">æœ«é¡µ</button>
    </div>
</div>

<script>
    let allUsers = [];
    let filteredUsers = [];
    let selectedUserIds = new Set();
    let curPage = 1;
    const pageSize = 20;
    let searchKeyword = '';
    let totalUsers = 0; // ä¿å­˜æ€»ç”¨æˆ·æ•°ï¼ˆç”¨äºåˆ†é¡µè®¡ç®—ï¼‰
    let allStats = { 
        total: 0, 
        online: 0, 
        admin: 0, 
        subject_admin: 0,
        notification_admin: 0,
        locked: 0 
    };
    
    function qs(sel) { return document.querySelector(sel); }
    function getVal(id) { return document.getElementById(id).value.trim(); }
    
    // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
    function updateStats() {
        document.getElementById('statTotal').textContent = allStats.total;
        document.getElementById('statOnline').textContent = allStats.online;
        document.getElementById('statAdmin').textContent = allStats.admin;
        document.getElementById('statSubjectAdmin').textContent = allStats.subject_admin || 0;
        document.getElementById('statNotificationAdmin').textContent = allStats.notification_admin || 0;
        document.getElementById('statLocked').textContent = allStats.locked;
    }
    
    // åŠ è½½ç”¨æˆ·åˆ—è¡¨
    async function loadUsers(page) {
        curPage = page || curPage;
        searchKeyword = getVal('searchInput');
        
        try {
            const url = `/admin/api/users?search=${encodeURIComponent(searchKeyword)}&page=${curPage}&size=${pageSize}&sort=created_at&order=desc&priority_sort=true`;
            const res = await fetch(url);
            const js = await res.json();
            
            if (!res.ok || js.status !== 'success') {
                showError(js.message || 'åŠ è½½å¤±è´¥');
                return;
            }
            
            allUsers = js.data || [];
            filteredUsers = allUsers;
            totalUsers = js.total || 0; // ä¿å­˜æ€»ç”¨æˆ·æ•°
            
            // ä½¿ç”¨åç«¯è¿”å›çš„å…¨å±€ç»Ÿè®¡æ•°æ®
            const stats = js.stats || {};
            allStats = { 
                total: js.total || 0, 
                online: stats.online || 0, 
                admin: stats.admin || 0, 
                subject_admin: stats.subject_admin || 0,
                notification_admin: stats.notification_admin || 0,
                locked: stats.locked || 0 
            };
            
            updateStats();
            renderTable();
            renderPager(totalUsers);
        } catch (error) {
            console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
            showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        }
    }
    
    // æ¸²æŸ“è¡¨æ ¼
    function renderTable() {
        const tb = document.getElementById('tbody');
        
        if (filteredUsers.length === 0) {
            tb.innerHTML = `<tr><td colspan="6" class="empty-state">
                <div class="empty-state-text">æš‚æ— ç”¨æˆ·</div>
                <div class="empty-state-hint">${searchKeyword ? 'æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·' : 'ç³»ç»Ÿä¸­è¿˜æ²¡æœ‰ç”¨æˆ·'}</div>
            </td></tr>`;
            return;
        }
        
        tb.innerHTML = filteredUsers.map(u => {
            const isSelected = selectedUserIds.has(u.id);
            const isCurrentUser = u.id === CURRENT_UID;
            
            // æ„å»ºæƒé™æ ‡ç­¾
            let permissionTags = [];
            if (u.is_admin) {
                permissionTags.push('<span class="permission-tag admin">ç®¡ç†å‘˜</span>');
            }
            if (u.is_subject_admin) {
                permissionTags.push('<span class="permission-tag subject-admin">ç§‘ç›®ç®¡ç†å‘˜</span>');
            }
            if (u.is_notification_admin) {
                permissionTags.push('<span class="permission-tag notification-admin">é€šçŸ¥ç®¡ç†å‘˜</span>');
            }
            if (permissionTags.length === 0) {
                permissionTags.push('<span class="permission-tag none">æ™®é€šç”¨æˆ·</span>');
            }
            
            // æ“ä½œæŒ‰é’®
            let actionButtons = '';
            if (!isCurrentUser) {
                const subjectAdminClass = u.is_subject_admin ? 'btn-action-active btn-action-subject' : '';
                const notificationAdminClass = u.is_notification_admin ? 'btn-action-active btn-action-notification' : '';
                actionButtons = `
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        <button class="btn-sm btn-action ${subjectAdminClass}" onclick="togglePermission(${u.id}, 'subject_admin')">
                            ${u.is_subject_admin ? 'å–æ¶ˆç§‘ç›®ç®¡ç†å‘˜' : 'è®¾ä¸ºç§‘ç›®ç®¡ç†å‘˜'}
                        </button>
                        <button class="btn-sm btn-action ${notificationAdminClass}" onclick="togglePermission(${u.id}, 'notification_admin')">
                            ${u.is_notification_admin ? 'å–æ¶ˆé€šçŸ¥ç®¡ç†å‘˜' : 'è®¾ä¸ºé€šçŸ¥ç®¡ç†å‘˜'}
                        </button>
                    </div>
                `;
            } else {
                actionButtons = '<span class="muted">å½“å‰ç”¨æˆ·</span>';
            }
            
            return `<tr>
                <td class="checkbox-cell">
                    ${!isCurrentUser ? `<input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelection(${u.id})">` : ''}
                </td>
                <td>${u.id}</td>
                <td>${u.username}</td>
                <td>
                    <div class="permission-tags">${permissionTags.join('')}</div>
                </td>
                <td>${formatDate(u.created_at)}</td>
                <td>${actionButtons}</td>
            </tr>`;
        }).join('');
        
        updateBatchActions();
    }
    
    // åˆ‡æ¢é€‰æ‹©
    function toggleSelection(userId) {
        if (selectedUserIds.has(userId)) {
            selectedUserIds.delete(userId);
        } else {
            selectedUserIds.add(userId);
        }
        updateBatchActions();
        renderTable();
    }
    
    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll').checked;
        const currentUserIds = filteredUsers
            .filter(u => u.id !== CURRENT_UID)
            .map(u => u.id);
        
        if (selectAll) {
            currentUserIds.forEach(id => selectedUserIds.add(id));
        } else {
            currentUserIds.forEach(id => selectedUserIds.delete(id));
        }
        
        updateBatchActions();
        renderTable();
    }
    
    // æ¸…é™¤é€‰æ‹©
    function clearSelection() {
        selectedUserIds.clear();
        document.getElementById('selectAll').checked = false;
        updateBatchActions();
        renderTable();
    }
    
    // æ›´æ–°æ‰¹é‡æ“ä½œæ 
    function updateBatchActions() {
        const batchActions = document.getElementById('batchActions');
        const selectedCount = document.getElementById('selectedCount');
        const count = selectedUserIds.size;
        
        if (count > 0) {
            batchActions.classList.remove('hidden');
            selectedCount.textContent = `å·²é€‰æ‹© ${count} ä¸ªç”¨æˆ·`;
        } else {
            batchActions.classList.add('hidden');
        }
        
        // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
        const allSelected = filteredUsers
            .filter(u => u.id !== CURRENT_UID)
            .every(u => selectedUserIds.has(u.id));
        document.getElementById('selectAll').checked = allSelected && filteredUsers.filter(u => u.id !== CURRENT_UID).length > 0;
    }
    
    // æ‰¹é‡è®¾ç½®æƒé™
    async function batchSetPermission(permissionType, enable) {
        if (selectedUserIds.size === 0) {
            showError('è¯·å…ˆé€‰æ‹©ç”¨æˆ·');
            return;
        }
        
        const action = enable ? 'è®¾ä¸º' : 'å–æ¶ˆ';
        const permissionName = permissionType === 'subject_admin' ? 'ç§‘ç›®ç®¡ç†å‘˜' : 'é€šçŸ¥ç®¡ç†å‘˜';
        
        if (!confirm(`ç¡®å®šè¦${action}${permissionName}å—ï¼Ÿ\nå°†å½±å“ ${selectedUserIds.size} ä¸ªç”¨æˆ·`)) {
            return;
        }
        
        try {
            const userIds = Array.from(selectedUserIds);
            const res = await fetch('/admin/api/permissions/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_ids: userIds,
                    permission_type: permissionType,
                    enable: enable
                })
            });
            
            const js = await res.json();
            if (res.ok && js.status === 'success') {
                showMessage(`${action}${permissionName}æˆåŠŸ`, true);
                clearSelection();
                loadUsers(curPage);
            } else {
                showError(js.message || 'æ“ä½œå¤±è´¥');
            }
        } catch (error) {
            console.error('æ‰¹é‡è®¾ç½®æƒé™å¤±è´¥:', error);
            showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        }
    }
    
    // åˆ‡æ¢å•ä¸ªç”¨æˆ·æƒé™
    async function togglePermission(userId, permissionType) {
        const user = allUsers.find(u => u.id === userId);
        if (!user) return;
        
        const currentValue = permissionType === 'subject_admin' ? user.is_subject_admin : user.is_notification_admin;
        const enable = !currentValue;
        const action = enable ? 'è®¾ä¸º' : 'å–æ¶ˆ';
        const permissionName = permissionType === 'subject_admin' ? 'ç§‘ç›®ç®¡ç†å‘˜' : 'é€šçŸ¥ç®¡ç†å‘˜';
        
        if (!confirm(`ç¡®å®šè¦${action}${permissionName}å—ï¼Ÿ`)) {
            return;
        }
        
        try {
            const res = await fetch('/admin/api/permissions/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_ids: [userId],
                    permission_type: permissionType,
                    enable: enable
                })
            });
            
            const js = await res.json();
            if (res.ok && js.status === 'success') {
                showMessage(`${action}${permissionName}æˆåŠŸ`, true);
                loadUsers(curPage);
            } else {
                showError(js.message || 'æ“ä½œå¤±è´¥');
            }
        } catch (error) {
            console.error('è®¾ç½®æƒé™å¤±è´¥:', error);
            showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
        }
    }
    
    // æœç´¢å¤„ç†
    function handleSearch() {
        searchKeyword = getVal('searchInput').toLowerCase();
        filteredUsers = allUsers.filter(u => 
            u.username.toLowerCase().includes(searchKeyword)
        );
        renderTable();
    }
    
    // åˆ†é¡µ
    function renderPager(total) {
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        document.getElementById('pageInfo').textContent = `ç¬¬ ${curPage} / ${totalPages} é¡µ (å…± ${total} æ¡)`;
        document.getElementById('btnFirst').disabled = curPage <= 1;
        document.getElementById('btnPrev').disabled = curPage <= 1;
        document.getElementById('btnNext').disabled = curPage >= totalPages;
        document.getElementById('btnLast').disabled = curPage >= totalPages;
    }
    
    function changePage(action) {
        const totalPages = Math.max(1, Math.ceil(totalUsers / pageSize));
        let newPage = curPage;
        
        switch(action) {
            case 'first': newPage = 1; break;
            case 'prev': newPage = Math.max(1, curPage - 1); break;
            case 'next': newPage = Math.min(totalPages, curPage + 1); break;
            case 'last': newPage = totalPages; break;
        }
        
        if (newPage !== curPage) {
            loadUsers(newPage);
        }
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateStr) {
        if (!dateStr) return '-';
        try {
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            return dateStr;
        }
    }
    
    // æ¶ˆæ¯æç¤º
    function showMessage(msg, success) {
        // ä½¿ç”¨ç°æœ‰çš„æ¶ˆæ¯æç¤ºç³»ç»Ÿ
        if (typeof showToast === 'function') {
            showToast(msg, success ? 'success' : 'error');
        } else {
            alert(msg);
        }
    }
    
    function showError(msg) {
        showMessage(msg, false);
    }
    
    // è·å–å½“å‰ç”¨æˆ·IDï¼ˆä»å…¨å±€ä¸Šä¸‹æ–‡å¤„ç†å™¨è·å–ï¼‰
    const CURRENT_UID = {{ user_id if user_id else 0 }};
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers(1);
    });
</script>
{% endblock %}

