{% extends "admin/admin_base.html" %}

{% block title %}é‚®ä»¶é…ç½® - ç³»ç»Ÿè®¾ç½®{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div class="header-left">
            <a href="/admin/settings" class="back-link">â† è¿”å›ç³»ç»Ÿè®¾ç½®</a>
            <h1>é‚®ä»¶é…ç½®</h1>
            <p class="page-description">é…ç½®ç³»ç»Ÿå‘é€éªŒè¯ç å’Œé€šçŸ¥çš„é‚®ç®±æœåŠ¡</p>
        </div>
    </div>

    <div class="settings-form-container">
        <form id="mailConfigForm" class="settings-form">
            <div class="form-section">
                <h3 class="section-title">SMTP æœåŠ¡å™¨é…ç½®</h3>
                
                <div class="form-group">
                    <label for="mail_server">SMTP æœåŠ¡å™¨åœ°å€ <span class="required">*</span></label>
                    <input type="text" id="mail_server" name="mail_server" 
                           value="{{ mail_config.get('mail_server', '') }}" 
                           placeholder="ä¾‹å¦‚: smtp.qq.com" required>
                    <div class="form-hint">QQé‚®ç®±: smtp.qq.com | 163é‚®ç®±: smtp.163.com | Gmail: smtp.gmail.com</div>
                </div>

                <div class="form-group">
                    <label for="mail_port">SMTP ç«¯å£ <span class="required">*</span></label>
                    <input type="number" id="mail_port" name="mail_port" 
                           value="{{ mail_config.get('mail_port', '587') }}" 
                           placeholder="587" min="1" max="65535" required>
                    <div class="form-hint">é€šå¸¸ä¸º 587 (TLS) æˆ– 465 (SSL)</div>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="mail_use_tls" name="mail_use_tls" 
                               {% if mail_config.get('mail_use_tls', 'true') == 'true' %}checked{% endif %}>
                        <span>ä½¿ç”¨ TLS åŠ å¯†</span>
                    </label>
                    <div class="form-hint">æ¨èå¼€å¯ï¼Œä½¿ç”¨ 587 ç«¯å£æ—¶é€šå¸¸éœ€è¦å¼€å¯</div>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="mail_use_ssl" name="mail_use_ssl" 
                               {% if mail_config.get('mail_use_ssl', 'false') == 'true' %}checked{% endif %}>
                        <span>ä½¿ç”¨ SSL åŠ å¯†</span>
                    </label>
                    <div class="form-hint">ä½¿ç”¨ 465 ç«¯å£æ—¶é€šå¸¸éœ€è¦å¼€å¯</div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title">é‚®ç®±è´¦æˆ·é…ç½®</h3>
                
                <div class="form-group">
                    <label for="mail_username">é‚®ç®±ç”¨æˆ·å <span class="required">*</span></label>
                    <input type="email" id="mail_username" name="mail_username" 
                           value="{{ mail_config.get('mail_username', '') }}" 
                           placeholder="your_email@example.com" required>
                    <div class="form-hint">ç”¨äºç™»å½• SMTP æœåŠ¡å™¨çš„é‚®ç®±åœ°å€</div>
                </div>

                <div class="form-group">
                    <label for="mail_password">é‚®ç®±æˆæƒç  <span class="required">*</span></label>
                    <input type="password" id="mail_password" name="mail_password" 
                           value="" 
                           placeholder="{% if mail_config.get('mail_password') == '***' %}å·²è®¾ç½®ï¼ˆè¾“å…¥æ–°å€¼ä»¥æ›´æ–°ï¼‰{% else %}è¯·è¾“å…¥é‚®ç®±æˆæƒç ï¼ˆä¸æ˜¯ç™»å½•å¯†ç ï¼‰{% endif %}" 
                           minlength="6" required>
                    {% if mail_config.get('mail_password') == '***' %}
                    <div class="form-hint" style="color: var(--text-sub); font-size: 12px; margin-top: 4px;">
                        âœ“ å·²ä¿å­˜æˆæƒç ï¼ˆè¾“å…¥æ–°å€¼ä»¥æ›´æ–°ï¼‰
                    </div>
                    {% endif %}
                    <div class="form-hint">
                        <strong>æ³¨æ„ï¼š</strong>è¿™æ˜¯é‚®ç®±çš„æˆæƒç ï¼Œä¸æ˜¯ç™»å½•å¯†ç ï¼æˆæƒç é€šå¸¸ä¸º16ä½æˆ–æ›´é•¿ã€‚
                        <br>QQé‚®ç®±ï¼šè®¾ç½® â†’ è´¦æˆ· â†’ å¼€å¯SMTPæœåŠ¡ â†’ ç”Ÿæˆæˆæƒç 
                        <br>163é‚®ç®±ï¼šè®¾ç½® â†’ POP3/SMTP/IMAP â†’ å¼€å¯æœåŠ¡ â†’ è®¾ç½®æˆæƒç 
                        <br><strong style="color: var(--danger);">å¦‚æœæˆæƒç å°‘äº6ä½ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æ­£ç¡®å¤åˆ¶å®Œæ•´</strong>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title">å‘ä»¶äººä¿¡æ¯</h3>
                
                <div class="form-group">
                    <label for="mail_default_sender">é»˜è®¤å‘ä»¶äººåœ°å€ <span class="required">*</span></label>
                    <input type="email" id="mail_default_sender" name="mail_default_sender" 
                           value="{{ mail_config.get('mail_default_sender', '') }}" 
                           placeholder="your_email@example.com" required>
                    <div class="form-hint">ç³»ç»Ÿå‘é€é‚®ä»¶æ—¶ä½¿ç”¨çš„å‘ä»¶äººé‚®ç®±åœ°å€</div>
                </div>

                <div class="form-group">
                    <label for="mail_default_sender_name">é»˜è®¤å‘ä»¶äººåç§°</label>
                    <input type="text" id="mail_default_sender_name" name="mail_default_sender_name" 
                           value="{{ mail_config.get('mail_default_sender_name', 'ç³»ç»Ÿé€šçŸ¥') }}" 
                           placeholder="ç³»ç»Ÿé€šçŸ¥">
                    <div class="form-hint">æ”¶ä»¶äººçœ‹åˆ°çš„å‘ä»¶äººåç§°</div>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title">æœåŠ¡å¼€å…³</h3>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="mail_enabled" name="mail_enabled" 
                               {% if mail_config.get('mail_enabled', 'true') == 'true' %}checked{% endif %}>
                        <span>å¯ç”¨é‚®ä»¶æœåŠ¡</span>
                    </label>
                    <div class="form-hint">å…³é—­åç³»ç»Ÿå°†ä¸ä¼šå‘é€ä»»ä½•é‚®ä»¶</div>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="mail_console_output" name="mail_console_output" 
                               {% if mail_config.get('mail_console_output', 'false') == 'true' %}checked{% endif %}>
                        <span>æ§åˆ¶å°è¾“å‡ºæ¨¡å¼ï¼ˆå¼€å‘æ¨¡å¼ï¼‰</span>
                    </label>
                    <div class="form-hint">
                        <strong>æ³¨æ„ï¼š</strong>å‹¾é€‰åéªŒè¯ç å°†åªåœ¨æ§åˆ¶å°è¾“å‡ºï¼Œä¸ä¼šå‘é€çœŸå®é‚®ä»¶ã€‚
                        <br>å–æ¶ˆå‹¾é€‰åæ‰ä¼šå‘é€çœŸå®é‚®ä»¶åˆ°ç”¨æˆ·é‚®ç®±ã€‚
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="testBtn">æµ‹è¯•é…ç½®</button>
                <button type="submit" class="btn btn-primary">ä¿å­˜é…ç½®</button>
            </div>

            <div class="form-message" id="formMessage"></div>
        </form>
    </div>

    <!-- é‚®ä»¶æ¨¡æ¿é¢„è§ˆåŒºåŸŸ -->
    <div class="template-preview-container">
        <div class="template-preview-header">
            <h2>é‚®ä»¶æ¨¡æ¿é¢„è§ˆ</h2>
            <p class="template-preview-description">é¢„è§ˆä¸åŒé‚®ä»¶ç±»å‹çš„æ¨¡æ¿æ•ˆæœ</p>
        </div>

        <div class="template-selector">
            <button class="template-tab active" data-template="bind_code">
                <span class="template-icon" style="color: #34c759;">ğŸ“§</span>
                <span>é‚®ç®±ç»‘å®š</span>
            </button>
            <button class="template-tab" data-template="login_code">
                <span class="template-icon" style="color: #007aff;">ğŸ”</span>
                <span>ç™»å½•éªŒè¯</span>
            </button>
            <button class="template-tab" data-template="reset_password">
                <span class="template-icon" style="color: #ff3b30;">ğŸ”’</span>
                <span>å¯†ç é‡ç½®</span>
            </button>
        </div>

        <div class="template-preview-wrapper">
            <div class="preview-controls">
                <div class="preview-email-input">
                    <label for="previewEmail">é¢„è§ˆé‚®ç®±åœ°å€ï¼š</label>
                    <input type="email" id="previewEmail" value="user@example.com" placeholder="user@example.com">
                </div>
                <button class="btn btn-secondary btn-sm" id="refreshPreviewBtn">åˆ·æ–°é¢„è§ˆ</button>
            </div>
            
            <div class="preview-loading" id="previewLoading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>åŠ è½½ä¸­...</p>
            </div>
            
            <div class="preview-iframe-container" id="previewContainer">
                <iframe id="templatePreview" frameborder="0" scrolling="no"></iframe>
            </div>
        </div>
    </div>
</div>

<style>
.page-container {
    padding: 40px;
    max-width: 900px;
    margin: 0 auto;
}

.page-header {
    margin-bottom: 32px;
}

.back-link {
    display: inline-block;
    color: var(--text-sub);
    text-decoration: none;
    font-size: 14px;
    margin-bottom: 12px;
    transition: color 0.2s;
}

.back-link:hover {
    color: var(--primary);
}

.page-header h1 {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 8px;
    letter-spacing: -0.5px;
}

.page-description {
    color: var(--text-sub);
    font-size: 15px;
}

.settings-form-container {
    background: var(--card-bg);
    backdrop-filter: var(--blur);
    -webkit-backdrop-filter: var(--blur);
    border: 0.5px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 32px;
    box-shadow: var(--shadow);
}

.settings-form {
    display: flex;
    flex-direction: column;
    gap: 32px;
}

.form-section {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.section-title {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 8px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border-color);
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-color);
}

.required {
    color: var(--danger);
}

.form-group input[type="text"],
.form-group input[type="email"],
.form-group input[type="number"],
.form-group input[type="password"] {
    padding: 12px 16px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    background: var(--card-bg-solid);
    color: var(--text-color);
    font-size: 15px;
    transition: all 0.2s;
}

.form-group input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    user-select: none;
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.form-hint {
    font-size: 13px;
    color: var(--text-sub);
    line-height: 1.6;
}

.form-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    padding-top: 8px;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
}

.btn-secondary {
    background: var(--card-bg-solid);
    color: var(--text-color);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: rgba(142, 142, 147, 0.12);
}

.form-message {
    margin-top: 16px;
    padding: 12px 16px;
    border-radius: var(--radius-sm);
    font-size: 14px;
    display: none;
}

.form-message.success {
    display: block;
    background: rgba(52, 199, 89, 0.15);
    color: var(--success);
    border: 1px solid rgba(52, 199, 89, 0.3);
}

.form-message.error {
    display: block;
    background: rgba(255, 59, 48, 0.15);
    color: var(--danger);
    border: 1px solid rgba(255, 59, 48, 0.3);
}

/* æ¨¡æ¿é¢„è§ˆåŒºåŸŸæ ·å¼ */
.template-preview-container {
    margin-top: 40px;
    background: var(--card-bg);
    backdrop-filter: var(--blur);
    -webkit-backdrop-filter: var(--blur);
    border: 0.5px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 32px;
    box-shadow: var(--shadow);
}

.template-preview-header {
    margin-bottom: 24px;
}

.template-preview-header h2 {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 8px;
    letter-spacing: -0.3px;
}

.template-preview-description {
    color: var(--text-sub);
    font-size: 14px;
}

.template-selector {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    flex-wrap: wrap;
}

.template-tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: var(--card-bg-solid);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-weight: 500;
    color: var(--text-color);
    cursor: pointer;
    transition: all 0.2s;
}

.template-tab:hover {
    background: rgba(142, 142, 147, 0.12);
    border-color: var(--primary);
}

.template-tab.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.template-tab.active .template-icon {
    filter: brightness(0) invert(1);
}

.template-icon {
    font-size: 18px;
    display: inline-block;
}

.template-preview-wrapper {
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    background: #f5f7fa;
    padding: 20px;
    min-height: 500px;
}

.preview-controls {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
    flex-wrap: wrap;
}

.preview-email-input {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    min-width: 200px;
}

.preview-email-input label {
    font-size: 14px;
    color: var(--text-color);
    white-space: nowrap;
}

.preview-email-input input {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    background: var(--card-bg-solid);
    color: var(--text-color);
    font-size: 14px;
    min-width: 200px;
}

.preview-email-input input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
}

.btn-sm {
    padding: 8px 16px;
    font-size: 14px;
}

.preview-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    color: var(--text-sub);
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(0, 122, 255, 0.2);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-bottom: 16px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.preview-iframe-container {
    background: white;
    border-radius: var(--radius-sm);
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    min-height: 500px;
}

#templatePreview {
    width: 100%;
    min-height: 500px;
    border: none;
    display: block;
}

@media only screen and (max-width: 768px) {
    .template-selector {
        flex-direction: column;
    }
    
    .template-tab {
        width: 100%;
        justify-content: center;
    }
    
    .preview-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .preview-email-input {
        flex-direction: column;
        align-items: stretch;
    }
    
    .preview-email-input input {
        width: 100%;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('mailConfigForm');
    const testBtn = document.getElementById('testBtn');
    const messageDiv = document.getElementById('formMessage');

    function showMessage(text, type) {
        messageDiv.textContent = text;
        messageDiv.className = `form-message ${type}`;
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    }

    // ä¿å­˜é…ç½®
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // éªŒè¯æˆæƒç é•¿åº¦
        const passwordInput = document.getElementById('mail_password');
        const passwordValue = passwordInput.value.trim();
        if (passwordValue && passwordValue !== '***' && passwordValue.length < 6) {
            showMessage('é‚®ç®±æˆæƒç é•¿åº¦è‡³å°‘éœ€è¦6ä½ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æ­£ç¡®è¾“å…¥å®Œæ•´ã€‚é€šå¸¸é‚®ç®±æˆæƒç ä¸º16ä½æˆ–æ›´é•¿ã€‚', 'error');
            passwordInput.focus();
            return;
        }
        
        const formData = {
            mail_server: document.getElementById('mail_server').value,
            mail_port: document.getElementById('mail_port').value,
            mail_use_tls: document.getElementById('mail_use_tls').checked,
            mail_use_ssl: document.getElementById('mail_use_ssl').checked,
            mail_username: document.getElementById('mail_username').value,
            mail_password: passwordValue,
            mail_default_sender: document.getElementById('mail_default_sender').value,
            mail_default_sender_name: document.getElementById('mail_default_sender_name').value,
            mail_enabled: document.getElementById('mail_enabled').checked,
            mail_console_output: document.getElementById('mail_console_output').checked,
        };

        try {
            const response = await fetch('/admin/api/settings/mail', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();
            
            if (data.status === 'success') {
                showMessage(data.message || 'é…ç½®ä¿å­˜æˆåŠŸ', 'success');
            } else {
                showMessage(data.message || 'ä¿å­˜å¤±è´¥', 'error');
            }
        } catch (error) {
            showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
        }
    });

    // æµ‹è¯•é…ç½®
    testBtn.addEventListener('click', async function() {
        const testEmail = prompt('è¯·è¾“å…¥æµ‹è¯•é‚®ç®±åœ°å€:');
        if (!testEmail) return;

        const formData = {
            email: testEmail,
            mail_server: document.getElementById('mail_server').value,
            mail_port: document.getElementById('mail_port').value,
            mail_use_tls: document.getElementById('mail_use_tls').checked,
            mail_use_ssl: document.getElementById('mail_use_ssl').checked,
            mail_username: document.getElementById('mail_username').value,
            mail_password: document.getElementById('mail_password').value,
            mail_default_sender: document.getElementById('mail_default_sender').value,
            mail_default_sender_name: document.getElementById('mail_default_sender_name').value,
            mail_enabled: document.getElementById('mail_enabled').checked,
            mail_console_output: false, // æµ‹è¯•æ—¶å¼ºåˆ¶å‘é€çœŸå®é‚®ä»¶
        };

        try {
            testBtn.disabled = true;
            testBtn.textContent = 'å‘é€ä¸­...';
            
            const response = await fetch('/admin/api/settings/mail/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            let data;
            try {
                data = await response.json();
            } catch (e) {
                // å¦‚æœå“åº”ä¸æ˜¯JSONï¼Œå°è¯•è¯»å–æ–‡æœ¬
                const text = await response.text();
                showMessage(`æœåŠ¡å™¨é”™è¯¯ (${response.status}): ${text || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                console.error('æµ‹è¯•é‚®ä»¶å¤±è´¥ - éJSONå“åº”:', text);
                return;
            }
            
            if (data.status === 'success') {
                showMessage(data.message || 'æµ‹è¯•é‚®ä»¶å‘é€æˆåŠŸ', 'success');
            } else {
                // æ£€æŸ¥æ˜¯å¦æ˜¯é™æµé”™è¯¯
                let errorMsg = data.message || `æµ‹è¯•å¤±è´¥ (${response.status})ï¼Œè¯·æ£€æŸ¥é…ç½®`;
                if (response.status === 429 || errorMsg.includes('per') || errorMsg.includes('minute')) {
                    errorMsg = 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•ï¼ˆæ¯åˆ†é’Ÿæœ€å¤š5æ¬¡ï¼‰';
                }
                showMessage(errorMsg, 'error');
                console.error('æµ‹è¯•é‚®ä»¶å¤±è´¥:', {
                    status: response.status,
                    statusText: response.statusText,
                    data: data
                });
            }
        } catch (error) {
            showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            console.error('æµ‹è¯•é‚®ä»¶ç½‘ç»œé”™è¯¯:', error);
        } finally {
            testBtn.disabled = false;
            testBtn.textContent = 'æµ‹è¯•é…ç½®';
        }
    });

    // é‚®ä»¶æ¨¡æ¿é¢„è§ˆåŠŸèƒ½
    const templateTabs = document.querySelectorAll('.template-tab');
    const previewContainer = document.getElementById('templatePreview');
    const previewLoading = document.getElementById('previewLoading');
    const previewEmailInput = document.getElementById('previewEmail');
    const refreshPreviewBtn = document.getElementById('refreshPreviewBtn');
    let currentTemplateType = 'bind_code';

    // åˆ‡æ¢æ¨¡æ¿ç±»å‹
    templateTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            templateTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            currentTemplateType = this.dataset.template;
            loadTemplatePreview();
        });
    });

    // åŠ è½½æ¨¡æ¿é¢„è§ˆ
    async function loadTemplatePreview() {
        const email = previewEmailInput.value.trim() || 'user@example.com';
        
        previewLoading.style.display = 'flex';
        previewContainer.style.display = 'none';
        
        try {
            const response = await fetch('/admin/api/settings/mail/template-preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    template_type: currentTemplateType,
                    email: email
                })
            });

            let data;
            try {
                data = await response.json();
            } catch (e) {
                const text = await response.text();
                throw new Error(`æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯ (${response.status}): ${text || 'æœªçŸ¥é”™è¯¯'}`);
            }
            
            if (!response.ok) {
                throw new Error(data.message || `è¯·æ±‚å¤±è´¥ (${response.status})`);
            }
            
            if (data.status === 'success') {
                // å°†HTMLå†…å®¹å†™å…¥iframe
                const iframe = previewContainer;
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                if (!iframeDoc) {
                    throw new Error('æ— æ³•è®¿é—®iframeæ–‡æ¡£ï¼Œå¯èƒ½æ˜¯è·¨åŸŸé—®é¢˜');
                }
                
                iframeDoc.open();
                iframeDoc.write(data.html);
                iframeDoc.close();
                
                // ç­‰å¾…å†…å®¹åŠ è½½åè°ƒæ•´é«˜åº¦
                setTimeout(() => {
                    try {
                        const height = Math.max(
                            iframeDoc.body.scrollHeight,
                            iframeDoc.body.offsetHeight,
                            iframeDoc.documentElement.clientHeight,
                            iframeDoc.documentElement.scrollHeight,
                            iframeDoc.documentElement.offsetHeight
                        );
                        iframe.style.height = Math.max(height + 20, 500) + 'px';
                    } catch (e) {
                        console.warn('è°ƒæ•´iframeé«˜åº¦å¤±è´¥:', e);
                        iframe.style.height = '600px';
                    }
                }, 200);
                
                previewContainer.style.display = 'block';
            } else {
                throw new Error(data.message || 'åŠ è½½é¢„è§ˆå¤±è´¥');
            }
        } catch (error) {
            console.error('æ¨¡æ¿é¢„è§ˆé”™è¯¯:', error);
            showMessage('åŠ è½½é¢„è§ˆå¤±è´¥: ' + error.message, 'error');
            previewContainer.style.display = 'none';
        } finally {
            previewLoading.style.display = 'none';
        }
    }

    // åˆ·æ–°é¢„è§ˆ
    refreshPreviewBtn.addEventListener('click', loadTemplatePreview);

    // é‚®ç®±è¾“å…¥æ¡†å›è½¦åˆ·æ–°
    previewEmailInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            loadTemplatePreview();
        }
    });

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½ç¬¬ä¸€ä¸ªæ¨¡æ¿é¢„è§ˆ
    loadTemplatePreview();
});
</script>
{% endblock %}

