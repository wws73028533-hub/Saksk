{% extends "admin/admin_base.html" %}

{% block title %}ç”¨æˆ·è¯¦æƒ… - {{ user.username }}{% endblock %}

{% block head %}
<style>
  /* å®¹å™¨æ ·å¼ - iOS 18é£æ ¼ */
  .container { 
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(30px) saturate(180%);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    padding: 40px; 
    border-radius: var(--radius-lg); 
    box-shadow: var(--shadow-soft);
    border: 0.5px solid var(--border-color);
    max-width: 1400px;
    margin: 0 auto;
  }
  
  /* é¡¶éƒ¨å¯¼èˆªæ  */
  .topbar { 
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    margin-bottom: 32px; 
    gap:16px; 
    flex-wrap:wrap;
    padding-bottom: 20px;
    border-bottom: 0.5px solid var(--border-color);
  }
  
  .topbar h1 { 
    margin:0; 
    font-size: 28px; 
    font-weight: 600;
    color: var(--text-color);
    display:flex;
    align-items:center;
    gap:12px;
    letter-spacing: -0.3px;
  }
  
  .topbar h1::before {
    display: none;
  }
  
  .ops { 
    display:flex; 
    gap:10px; 
    flex-wrap:wrap;
    align-items:center;
  }
  
  /* ç”¨æˆ·èµ„æ–™å¡ç‰‡ - iOS 18é£æ ¼ */
  .profile-card {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(30px) saturate(180%);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    border-radius: var(--radius-lg);
    padding: 32px;
    margin-bottom: 32px;
    color: var(--text-color);
    box-shadow: var(--shadow-soft);
    border: 0.5px solid var(--border-color);
  }
  
  .profile-section { 
    display:flex; 
    gap:24px; 
    align-items:flex-start;
  }
  
  .avatar-box { 
    flex-shrink:0;
    position:relative;
  }
  
  .avatar-img { 
    width:140px; 
    height:140px; 
    border-radius:12px; 
    object-fit:cover; 
    border:4px solid rgba(255,255,255,0.3);
    box-shadow:0 8px 16px rgba(0,0,0,0.2);
    transition: transform 0.3s ease;
  }
  
  .avatar-img:hover {
    transform: scale(1.05);
  }
  
  .avatar-placeholder { 
    width:140px; 
    height:140px; 
    border-radius: var(--radius-md); 
    background: rgba(142, 142, 147, 0.1); 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    border: 0.5px solid var(--border-color);
  }
  
  .avatar-placeholder::before {
    content: '';
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(142, 142, 147, 0.3);
  }
  
  .profile-info { 
    flex:1;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  
  .profile-username {
    font-size: 32px;
    font-weight: 600;
    margin: 0 0 12px 0;
    color: var(--text-color);
    letter-spacing: -0.5px;
  }
  
  .info-row { 
    display:flex; 
    gap:12px; 
    align-items:center;
    background: rgba(142, 142, 147, 0.08);
    padding: 12px 16px;
    border-radius: var(--radius-md);
    border: 0.5px solid var(--border-color);
  }
  
  .info-icon {
    display: none;
  }
  
  .info-label { 
    color: var(--text-sub); 
    font-size: 14px; 
    font-weight: 500;
    min-width: 80px;
  }
  
  .info-value { 
    font-size: 15px; 
    color: var(--text-color);
    font-weight: 500;
  }
  
  /* ç»Ÿè®¡å¡ç‰‡ç½‘æ ¼ */
  .stats-grid { 
    display:grid; 
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
    gap:16px; 
    margin-bottom:24px;
  }
  
  .stat-card { 
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(30px) saturate(180%);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    border: 0.5px solid var(--border-color); 
    border-radius: var(--radius-lg); 
    padding: 24px;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    position:relative;
    overflow:hidden;
    box-shadow: var(--shadow-soft);
  }
  
  .stat-card::before {
    content:'';
    position:absolute;
    top:0;
    left:0;
    right:0;
    height:3px;
    background: rgba(142, 142, 147, 0.2);
  }
  
  .stat-card:hover { 
    transform: translateY(-2px);
    box-shadow: var(--shadow);
    border-color: var(--border-color);
  }
  
  .stat-label { 
    color: var(--text-sub); 
    font-size: 13px; 
    font-weight: 500;
    margin-bottom: 12px;
    letter-spacing: -0.01em;
  }
  
  .stat-value { 
    font-size: 32px; 
    font-weight: 600; 
    color: var(--text-color);
    line-height: 1;
    letter-spacing: -0.5px;
  }
  
  .stat-icon {
    display: none;
  }
  
  /* æ ‡ç­¾æ ·å¼ */
  .tag { 
    display:inline-flex;
    align-items:center;
    gap:4px;
    padding:4px 12px; 
    border-radius:12px; 
    font-size:13px;
    font-weight:600;
  }
  
  .tag-admin { 
    background: var(--primary-light); 
    color: var(--primary);
  }
  
  .tag-locked { 
    background: rgba(255, 59, 48, 0.15); 
    color: var(--danger);
  }
  
  .tag-normal {
    background: rgba(52, 199, 89, 0.15);
    color: var(--success);
  }
  
  /* è¡¨æ ¼æ ·å¼ - iOS 18é£æ ¼ */
  .section-card {
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(30px) saturate(180%);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    border: 0.5px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 32px;
    margin-top: 32px;
    box-shadow: var(--shadow-soft);
  }
  
  .section-header {
    display:flex;
    align-items:center;
    gap:12px;
    margin:0 0 24px;
    font-size: 20px;
    font-weight: 600;
    color: var(--text-color);
    letter-spacing: -0.3px;
  }
  
  .section-header::before {
    display: none;
  }
  
  table { 
    width:100%; 
    border-collapse:collapse;
  }
  
  th, td { 
    padding: 16px; 
    border-bottom: 0.5px solid var(--border-color); 
    text-align:left;
  }
  
  thead th { 
    background: rgba(142, 142, 147, 0.06); 
    font-weight: 600;
    color: var(--text-color);
    font-size: 13px;
    letter-spacing: -0.01em;
  }
  
  tbody tr {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  tbody tr:hover { 
    background: rgba(142, 142, 147, 0.08);
  }
  
  tbody tr:last-child td {
    border-bottom:none;
  }
  
  .empty-state {
    text-align:center;
    padding: 60px 20px;
    color: var(--text-sub);
  }
  
  .empty-state-icon {
    display: none;
  }
  
  /* å¼¹çª—æ ·å¼ */
  .modal-overlay {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.5);
    align-items:center;
    justify-content:center;
    z-index:1000;
    backdrop-filter: blur(4px);
    animation: fadeIn 0.2s ease;
  }
  
  @keyframes fadeIn {
    from { opacity:0; }
    to { opacity:1; }
  }
  
  .modal-content {
    background: var(--card-bg);
    backdrop-filter: blur(40px) saturate(180%);
    -webkit-backdrop-filter: blur(40px) saturate(180%);
    padding: 32px;
    border-radius: var(--radius-xl);
    width:400px;
    max-width:90vw;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    border: 0.5px solid var(--border-color);
    animation: slideUp 0.3s ease;
  }
  
  @keyframes slideUp {
    from { transform: translateY(20px); opacity:0; }
    to { transform: translateY(0); opacity:1; }
  }
  
  .modal-header {
    margin:0 0 24px;
    font-size: 20px;
    font-weight: 600;
    color: var(--text-color);
    display:flex;
    align-items:center;
    gap:10px;
    letter-spacing: -0.3px;
  }
  
  .modal-body {
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  
  .modal-body input {
    padding: 12px 16px;
    border: 0.5px solid var(--border-color);
    border-radius: var(--radius-md);
    font-size: 14px;
    background: var(--card-bg-solid);
    color: var(--text-color);
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .modal-body input:focus {
    outline:none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
  }
  
  .modal-footer {
    margin-top:24px;
    display:flex;
    gap:12px;
    justify-content:flex-end;
  }
  
  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 900px) { 
    .container {
      padding:20px;
    }
    
    .stats-grid { 
      grid-template-columns: repeat(2, 1fr);
    }
    
    .profile-section { 
      flex-direction:column;
      align-items:center;
      text-align:center;
    }
    
    .topbar {
      flex-direction:column;
      align-items:stretch;
    }
    
    .topbar h1 {
      font-size:24px;
    }
    
    .ops {
      justify-content:center;
    }
  }
  
  @media (max-width: 600px) {
    .stats-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <div class="topbar">
    <h1>{{ user.username }}</h1>
    <div class="ops">
      {% if user.id != user_id %}
      <button class="btn-primary btn-sm" onclick="toggleAdmin()">
        {{ 'æ’¤é”€ç®¡ç†å‘˜' if user.is_admin else 'è®¾ä¸ºç®¡ç†å‘˜' }}
      </button>
      <button class="btn-secondary btn-sm" onclick="toggleLock()">
        {{ 'è§£é”è´¦æˆ·' if user.is_locked else 'é”å®šè´¦æˆ·' }}
      </button>
      <button class="btn-outline btn-sm" onclick="openReset()">é‡ç½®å¯†ç </button>
      <button class="btn-danger btn-sm" onclick="forceLogout()">å¼ºåˆ¶ä¸‹çº¿</button>
      {% else %}
      <span style="color: var(--text-sub); font-size: 14px;">å½“å‰ç®¡ç†å‘˜è´¦æˆ·ï¼Œå·²éšè—è‡ªæˆ‘æ“ä½œ</span>
      {% endif %}
      <a class="btn-outline" href="/admin/users">â† è¿”å›åˆ—è¡¨</a>
    </div>
  </div>

  <!-- ç”¨æˆ·èµ„æ–™å¡ç‰‡ -->
  <div class="profile-card">
    <div class="profile-section">
      <div class="avatar-box">
        {% if user.avatar %}
          <img src="{{ user.avatar }}" alt="ç”¨æˆ·å¤´åƒ" class="avatar-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div class="avatar-placeholder" style="display:none;">ğŸ‘¤</div>
        {% else %}
          <div class="avatar-placeholder"></div>
        {% endif %}
      </div>
      <div class="profile-info">
        <h2 class="profile-username">{{ user.username }}</h2>
        <div class="info-row">
          <span class="info-label">ç”¨æˆ·ID</span>
          <span class="info-value">#{{ user.id }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">è”ç³»æ–¹å¼</span>
          <span class="info-value">{{ user.contact or 'æœªè®¾ç½®' }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">å­¦é™¢</span>
          <span class="info-value">{{ user.college or 'æœªè®¾ç½®' }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">èº«ä»½</span>
          <span class="info-value">
            {% if user.is_admin %}
              <span class="tag tag-admin">ç®¡ç†å‘˜</span>
            {% else %}
              æ™®é€šç”¨æˆ·
            {% endif %}
          </span>
        </div>
        <div class="info-row">
          <span class="info-label">çŠ¶æ€</span>
          <span class="info-value">
            {% if user.is_locked %}
              <span class="tag tag-locked">å·²é”å®š</span>
            {% else %}
              <span class="tag tag-normal">æ­£å¸¸</span>
            {% endif %}
          </span>
        </div>
        <div class="info-row">
          <span class="info-label">æ³¨å†Œæ—¶é—´</span>
          <span class="info-value">{{ user.created_at or '-' }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ç»Ÿè®¡æ•°æ® -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">æ”¶è—é¢˜ç›®</div>
      <div class="stat-value">{{ stats.favorites }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">é”™é¢˜æ•°é‡</div>
      <div class="stat-value">{{ stats.mistakes }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">ç´¯è®¡ç­”é¢˜</div>
      <div class="stat-value">{{ stats.total_answers }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">æ­£ç¡®ç‡</div>
      <div class="stat-value">{{ stats.accuracy }}%</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">è¿›è¡Œä¸­è€ƒè¯•</div>
      <div class="stat-value">{{ stats.exams_ongoing }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">å·²æäº¤è€ƒè¯•</div>
      <div class="stat-value">{{ stats.exams_submitted }}</div>
    </div>
  </div>

  <!-- ç§‘ç›®æƒé™ç®¡ç†å¡ç‰‡ -->
  <div class="section-card">
    <h3 class="section-header">ç§‘ç›®æƒé™ç®¡ç†</h3>
    <div id="subject-permission-card">
      <div class="permission-stats" style="margin-bottom: 16px; padding: 16px; background: rgba(142, 142, 147, 0.06); border-radius: var(--radius-md);">
        <span style="color: var(--text-sub); font-size: 14px;">è¢«é™åˆ¶ç§‘ç›®: <strong id="restricted-count" style="color: var(--text-color);">0</strong>/<span id="total-count" style="color: var(--text-color);">0</span></span>
      </div>
      <div id="restricted-subjects-list" class="subjects-tags" style="margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 8px;">
        <!-- åŠ¨æ€åŠ è½½ -->
      </div>
      <button class="btn-primary" onclick="openSubjectPermissionModal()">ç®¡ç†ç§‘ç›®æƒé™</button>
    </div>
  </div>

  <!-- æœ€è¿‘è€ƒè¯•è®°å½• -->
  <div class="section-card">
    <h3 class="section-header">æœ€è¿‘è€ƒè¯•è®°å½•</h3>
    {% if recent_exams %}
    <table>
      <thead>
        <tr>
          <th>è€ƒè¯•ID</th>
          <th>ç§‘ç›®</th>
          <th>æ€»åˆ†</th>
          <th>å¼€å§‹æ—¶é—´</th>
          <th>æäº¤æ—¶é—´</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {% for e in recent_exams %}
        <tr>
          <td><strong>#{{ e.id }}</strong></td>
          <td>{{ e.subject or 'å…¨éƒ¨ç§‘ç›®' }}</td>
          <td><strong style="color: var(--primary);">{{ e.total_score }} åˆ†</strong></td>
          <td>{{ e.started_at }}</td>
          <td>{{ e.submitted_at }}</td>
          <td>
            <a class="btn-outline" href="/exams/{{ e.id }}" style="font-size:12px; padding:6px 12px;">æŸ¥çœ‹æˆç»©</a>
            <a class="btn-outline" href="/quiz?mode=exam&exam_id={{ e.id }}" style="font-size:12px; padding:6px 12px;">å›é¡¾é¢˜ç›®</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty-state">
      <p>æš‚æ— è€ƒè¯•è®°å½•</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- ç§‘ç›®æƒé™ç®¡ç†å¼¹çª— -->
<div id="subject-permission-modal" class="modal-overlay" onclick="if(event.target === this) closeSubjectPermissionModal()">
  <div class="modal-content" style="max-width: 600px;">
    <h3 class="modal-header">ç®¡ç†ç§‘ç›®æƒé™</h3>
    <div class="modal-body">
      <div class="search-box" style="margin-bottom: 16px;">
        <input type="text" id="subject-search" placeholder="æœç´¢ç§‘ç›®..." oninput="filterSubjects()" style="width: 100%;">
      </div>
      <div class="subjects-checkbox-list" id="subjects-checkbox-list" style="max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;">
        <!-- åŠ¨æ€åŠ è½½ -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closeSubjectPermissionModal()">å–æ¶ˆ</button>
      <button class="btn-secondary" onclick="selectAllSubjects()">å…¨é€‰</button>
      <button class="btn-secondary" onclick="unselectAllSubjects()">å…¨ä¸é€‰</button>
      <button class="btn-primary" onclick="saveSubjectPermissions()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- é‡ç½®å¯†ç å¼¹çª— -->
<div id="dlgReset" class="modal-overlay" onclick="if(event.target === this) closeReset()">
  <div class="modal-content">
    <h3 class="modal-header">é‡ç½®å¯†ç </h3>
    <div class="modal-body">
      <input id="rp_pwd" type="password" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘8ä½ï¼Œå«å­—æ¯å’Œæ•°å­—ï¼‰">
      <p style="color: var(--text-sub); font-size: 13px; margin:0;">å¯†ç è¦æ±‚ï¼šè‡³å°‘8ä¸ªå­—ç¬¦ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—</p>
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closeReset()">å–æ¶ˆ</button>
      <button class="btn-primary" onclick="doReset()">ç¡®è®¤é‡ç½®</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const UID = {{ user.id }};
  
  // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      background: ${type === 'success' ? 'rgba(52, 199, 89, 0.15)' : type === 'error' ? 'rgba(255, 59, 48, 0.15)' : 'var(--primary-light)'};
      color: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--primary)'};
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      font-weight: 500;
      animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }
  
  // æ·»åŠ åŠ¨ç”»æ ·å¼
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(400px); opacity: 0; }
    }
  `;
  document.head.appendChild(style);
  
  // åˆ‡æ¢ç®¡ç†å‘˜æƒé™
  async function toggleAdmin() {
    const isAdmin = {{ 'true' if user.is_admin else 'false' }};
    const action = isAdmin ? 'æ’¤é”€ç®¡ç†å‘˜æƒé™' : 'è®¾ä¸ºç®¡ç†å‘˜';
    
    if (!confirm(`ç¡®å®šè¦${action}å—ï¼Ÿæ­¤æ“ä½œå°†ç«‹å³ç”Ÿæ•ˆã€‚`)) return;
    
    const btn = event.target;
    btn.disabled = true;
    btn.setAttribute('data-loading', 'true');
    
    try {
      const res = await fetch(`/admin/users/${UID}/toggle_admin`, { method: 'POST' });
      const js = await res.json();
      
      if (js.status === 'success') {
        showNotification(js.message || 'æ“ä½œæˆåŠŸ', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        showNotification(js.message || 'æ“ä½œå¤±è´¥', 'error');
        btn.disabled = false;
        btn.removeAttribute('data-loading');
      }
    } catch (error) {
      showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
      btn.disabled = false;
      btn.removeAttribute('data-loading');
    }
  }
  
  // åˆ‡æ¢é”å®šçŠ¶æ€
  async function toggleLock() {
    const isLocked = {{ 'true' if user.is_locked else 'false' }};
    const action = isLocked ? 'è§£é”' : 'é”å®š';
    
    if (!confirm(`ç¡®å®šè¦${action}è¯¥ç”¨æˆ·å—ï¼Ÿ${isLocked ? '' : 'é”å®šåç”¨æˆ·å°†æ— æ³•ç™»å½•ã€‚'}`)) return;
    
    const btn = event.target;
    btn.disabled = true;
    btn.setAttribute('data-loading', 'true');
    
    try {
      const res = await fetch(`/admin/users/${UID}/toggle_lock`, { method: 'POST' });
      const js = await res.json();
      
      if (js.status === 'success') {
        showNotification(js.message || 'æ“ä½œæˆåŠŸ', 'success');
        setTimeout(() => location.reload(), 1000);
      } else {
        showNotification(js.message || 'æ“ä½œå¤±è´¥', 'error');
        btn.disabled = false;
        btn.removeAttribute('data-loading');
      }
    } catch (error) {
      showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
      btn.disabled = false;
      btn.removeAttribute('data-loading');
    }
  }
  
  // æ‰“å¼€é‡ç½®å¯†ç å¼¹çª—
  function openReset() {
    document.getElementById('dlgReset').style.display = 'flex';
    document.getElementById('rp_pwd').value = '';
    document.getElementById('rp_pwd').focus();
  }
  
  // å…³é—­é‡ç½®å¯†ç å¼¹çª—
  function closeReset() {
    document.getElementById('dlgReset').style.display = 'none';
  }
  
  // æ‰§è¡Œå¯†ç é‡ç½®
  async function doReset() {
    const pwd = document.getElementById('rp_pwd').value.trim();
    
    if (pwd.length < 8) {
      showNotification('å¯†ç é•¿åº¦è‡³å°‘ä¸º8ä½', 'error');
      return;
    }
    
    if (!(/[a-z]/i.test(pwd) && /\d/.test(pwd))) {
      showNotification('å¯†ç å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—', 'error');
      return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.setAttribute('data-loading', 'true');
    
    try {
      const res = await fetch(`/admin/users/${UID}/reset_password`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ new_password: pwd })
      });
      const js = await res.json();
      
      if (js.status === 'success') {
        showNotification(js.message || 'å¯†ç é‡ç½®æˆåŠŸ', 'success');
        closeReset();
      } else {
        showNotification(js.message || 'å¯†ç é‡ç½®å¤±è´¥', 'error');
      }
    } catch (error) {
      showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
    } finally {
      btn.disabled = false;
      btn.removeAttribute('data-loading');
    }
  }
  
  // å¼ºåˆ¶ç”¨æˆ·ä¸‹çº¿
  async function forceLogout() {
    if (!confirm('ç¡®å®šè¦å¼ºåˆ¶è¯¥ç”¨æˆ·ä¸‹çº¿å—ï¼Ÿç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•ã€‚')) return;
    
    const btn = event.target;
    btn.disabled = true;
    btn.setAttribute('data-loading', 'true');
    
    try {
      const res = await fetch(`/admin/users/${UID}/force_logout`, { method: 'POST' });
      const js = await res.json();
      
      if (js.status === 'success') {
        showNotification(js.message || 'æ“ä½œæˆåŠŸ', 'success');
      } else {
        showNotification(js.message || 'æ“ä½œå¤±è´¥', 'error');
      }
    } catch (error) {
      showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
    } finally {
      btn.disabled = false;
      btn.removeAttribute('data-loading');
    }
  }
  
  // ç§‘ç›®æƒé™ç®¡ç†ç›¸å…³å˜é‡
  let allSubjectsData = [];
  let restrictedSubjectIds = new Set();
  
  // åŠ è½½ç”¨æˆ·ç§‘ç›®æƒé™ä¿¡æ¯
  async function loadSubjectPermissions() {
    try {
      const res = await fetch(`/admin/api/users/${UID}/subjects`);
      const result = await res.json();
      
      if (result.status === 'success') {
        const data = result.data;
        allSubjectsData = data.all_subjects || [];
        restrictedSubjectIds = new Set(
          allSubjectsData
            .filter(s => s.is_restricted)
            .map(s => s.id)
        );
        
        // æ›´æ–°ç»Ÿè®¡
        document.getElementById('restricted-count').textContent = data.restricted_count || 0;
        document.getElementById('total-count').textContent = data.total_count || 0;
        
        // æ›´æ–°è¢«é™åˆ¶ç§‘ç›®æ ‡ç­¾
        updateRestrictedSubjectsList();
        
        // æ›´æ–°å¼¹çª—ä¸­çš„ç§‘ç›®åˆ—è¡¨
        updateSubjectsCheckboxList();
      }
    } catch (error) {
      console.error('åŠ è½½ç§‘ç›®æƒé™å¤±è´¥:', error);
    }
  }
  
  // æ›´æ–°è¢«é™åˆ¶ç§‘ç›®æ ‡ç­¾åˆ—è¡¨
  function updateRestrictedSubjectsList() {
    const container = document.getElementById('restricted-subjects-list');
    container.innerHTML = '';
    
    const restricted = allSubjectsData.filter(s => restrictedSubjectIds.has(s.id));
    
    if (restricted.length === 0) {
      container.innerHTML = '<span style="color: var(--text-sub); font-size: 14px;">æš‚æ— è¢«é™åˆ¶çš„ç§‘ç›®</span>';
      return;
    }
    
    restricted.forEach(subject => {
      const tag = document.createElement('span');
      tag.className = 'tag tag-locked';
      tag.style.cssText = 'cursor: pointer;';
      tag.textContent = subject.name;
      tag.title = 'ç‚¹å‡»å–æ¶ˆé™åˆ¶';
      tag.onclick = () => removeSubjectRestriction(subject.id);
      container.appendChild(tag);
    });
  }
  
  // æ›´æ–°å¼¹çª—ä¸­çš„ç§‘ç›®å¤é€‰æ¡†åˆ—è¡¨
  function updateSubjectsCheckboxList() {
    const container = document.getElementById('subjects-checkbox-list');
    container.innerHTML = '';
    
    allSubjectsData.forEach(subject => {
      const item = document.createElement('label');
      item.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(142, 142, 147, 0.06); border-radius: var(--radius-md); cursor: pointer; transition: background 0.2s;';
      item.onmouseover = () => item.style.background = 'rgba(142, 142, 147, 0.1)';
      item.onmouseout = () => item.style.background = 'rgba(142, 142, 147, 0.06)';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = restrictedSubjectIds.has(subject.id);
      checkbox.value = subject.id;
      checkbox.style.cssText = 'width: 18px; height: 18px; cursor: pointer;';
      
      const info = document.createElement('div');
      info.style.cssText = 'flex: 1;';
      
      const name = document.createElement('div');
      name.textContent = subject.name;
      name.style.cssText = 'font-weight: 500; color: var(--text-color); margin-bottom: 4px;';
      
      const count = document.createElement('div');
      count.textContent = `${subject.question_count || 0} é¢˜`;
      count.style.cssText = 'font-size: 12px; color: var(--text-sub);';
      
      info.appendChild(name);
      info.appendChild(count);
      item.appendChild(checkbox);
      item.appendChild(info);
      container.appendChild(item);
    });
  }
  
  // æ‰“å¼€ç§‘ç›®æƒé™ç®¡ç†å¼¹çª—
  function openSubjectPermissionModal() {
    document.getElementById('subject-permission-modal').style.display = 'flex';
    document.getElementById('subject-search').value = '';
    filterSubjects();
  }
  
  // å…³é—­ç§‘ç›®æƒé™ç®¡ç†å¼¹çª—
  function closeSubjectPermissionModal() {
    document.getElementById('subject-permission-modal').style.display = 'none';
  }
  
  // è¿‡æ»¤ç§‘ç›®
  function filterSubjects() {
    const search = document.getElementById('subject-search').value.toLowerCase();
    const items = document.getElementById('subjects-checkbox-list').children;
    
    for (let item of items) {
      const name = item.querySelector('div > div').textContent.toLowerCase();
      item.style.display = name.includes(search) ? 'flex' : 'none';
    }
  }
  
  // å…¨é€‰ç§‘ç›®
  function selectAllSubjects() {
    const checkboxes = document.querySelectorAll('#subjects-checkbox-list input[type="checkbox"]');
    checkboxes.forEach(cb => {
      cb.checked = true;
      restrictedSubjectIds.add(parseInt(cb.value));
    });
  }
  
  // å…¨ä¸é€‰ç§‘ç›®
  function unselectAllSubjects() {
    const checkboxes = document.querySelectorAll('#subjects-checkbox-list input[type="checkbox"]');
    checkboxes.forEach(cb => {
      cb.checked = false;
      restrictedSubjectIds.delete(parseInt(cb.value));
    });
  }
  
  // ç§»é™¤ç§‘ç›®é™åˆ¶ï¼ˆä»æ ‡ç­¾ç‚¹å‡»ï¼‰
  async function removeSubjectRestriction(subjectId) {
    if (!confirm('ç¡®å®šè¦å–æ¶ˆè¯¥ç§‘ç›®çš„é™åˆ¶å—ï¼Ÿ')) return;
    
    try {
      const res = await fetch(`/admin/api/users/${UID}/subjects/${subjectId}`, {
        method: 'DELETE'
      });
      const result = await res.json();
      
      if (result.status === 'success') {
        showNotification('å·²å–æ¶ˆç§‘ç›®é™åˆ¶', 'success');
        restrictedSubjectIds.delete(subjectId);
        loadSubjectPermissions();
      } else {
        showNotification(result.message || 'æ“ä½œå¤±è´¥', 'error');
      }
    } catch (error) {
      showNotification('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
    }
  }
  
  // ä¿å­˜ç§‘ç›®æƒé™
  async function saveSubjectPermissions() {
    const checkboxes = document.querySelectorAll('#subjects-checkbox-list input[type="checkbox"]:checked');
    const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    // ç¡®å®šæ˜¯é™åˆ¶è¿˜æ˜¯å–æ¶ˆé™åˆ¶ï¼ˆæ¯”è¾ƒå½“å‰é€‰ä¸­çš„å’Œä¹‹å‰é™åˆ¶çš„ï¼‰
    const toRestrict = selectedIds.filter(id => !restrictedSubjectIds.has(id));
    const toUnrestrict = Array.from(restrictedSubjectIds).filter(id => !selectedIds.includes(id));
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'ä¿å­˜ä¸­...';
    
    try {
      // å…ˆæ‰§è¡Œå–æ¶ˆé™åˆ¶
      if (toUnrestrict.length > 0) {
        for (const subjectId of toUnrestrict) {
          await fetch(`/admin/api/users/${UID}/subjects/${subjectId}`, { method: 'DELETE' });
        }
      }
      
      // å†æ‰§è¡Œé™åˆ¶
      if (toRestrict.length > 0) {
        const res = await fetch(`/admin/api/users/${UID}/subjects`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subject_ids: toRestrict })
        });
        const result = await res.json();
        
        if (result.status !== 'success') {
          throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
        }
      }
      
      showNotification('ç§‘ç›®æƒé™ä¿å­˜æˆåŠŸ', 'success');
      closeSubjectPermissionModal();
      loadSubjectPermissions();
    } catch (error) {
      showNotification(error.message || 'ä¿å­˜å¤±è´¥', 'error');
    } finally {
      btn.disabled = false;
      btn.textContent = 'ä¿å­˜';
    }
  }
  
  // é¡µé¢åŠ è½½æ—¶åŠ è½½ç§‘ç›®æƒé™
  document.addEventListener('DOMContentLoaded', () => {
    loadSubjectPermissions();
  });
  
  // é”®ç›˜å¿«æ·é”®æ”¯æŒ
  document.addEventListener('keydown', (e) => {
    // ESC å…³é—­å¼¹çª—
    if (e.key === 'Escape') {
      closeReset();
      closeSubjectPermissionModal();
    }
    // Enter åœ¨å¼¹çª—ä¸­æäº¤
    if (e.key === 'Enter' && document.getElementById('dlgReset').style.display === 'flex') {
      doReset();
    }
  });
</script>
{% endblock %}
