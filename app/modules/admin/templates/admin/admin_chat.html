{% extends "admin/admin_base.html" %}

{% block title %}èŠå¤©ç®¡ç†{% endblock %}

{% block head %}
<style>
    .container { 
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        padding: 40px; 
        border-radius: var(--radius-lg); 
        box-shadow: var(--shadow-soft);
        border: 0.5px solid var(--border-color);
    }
    h1 { font-size: 22px; margin: 0 0 32px 0; }
    
    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
    }
    .stat-card {
        padding: 20px;
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        color: var(--text-color);
        box-shadow: var(--shadow-soft);
        border: 0.5px solid var(--border-color);
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }
    .stat-card-label {
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 4px;
        color: var(--text-sub);
    }
    .stat-card-value {
        font-size: 28px;
        font-weight: 600;
        letter-spacing: -0.5px;
    }
    
    /* å·¥å…·æ  */
    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }
    .toolbar-left {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }
    .toolbar-right {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    /* æœç´¢æ¡† */
    .search-box {
        position: relative;
        display: inline-block;
    }
    .search-box input {
        padding: 10px 16px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        font-size: 14px;
        width: 250px;
        transition: width 0.3s, border-color 0.3s;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
    }
    .search-box input:focus {
        width: 300px;
        border-color: var(--primary);
        outline: none;
    }
    
    /* è¡¨æ ¼ */
    .table-wrapper {
        border-radius: var(--radius-lg);
        overflow: hidden;
        border: 0.5px solid var(--border-color);
        box-shadow: var(--shadow-soft);
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        padding: 16px;
        border-bottom: 0.5px solid var(--border-color);
        text-align: left;
    }
    thead th {
        background: rgba(142, 142, 147, 0.06);
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
        color: var(--text-color);
        font-size: 13px;
        letter-spacing: -0.01em;
    }
    tbody tr {
        transition: background-color 0.2s;
    }
    tbody tr:hover {
        background-color: rgba(142, 142, 147, 0.06);
    }
    tbody tr:last-child td {
        border-bottom: none;
    }
    
    /* æŒ‰é’® */
    .btn-primary, .btn-danger, .btn-outline {
        padding: 10px 20px;
        border-radius: var(--radius-md);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        background: rgba(0, 122, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        color: #ffffff;
        min-width: 100px;
    }
    .btn-primary:hover {
        background: rgba(0, 122, 255, 0.85);
        transform: translateY(-1px);
        box-shadow: var(--shadow);
    }
    .btn-danger {
        background: rgba(255, 59, 48, 0.7);
    }
    .btn-danger:hover {
        background: rgba(255, 59, 48, 0.85);
    }
    .btn-outline {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-color);
    }
    .btn-outline:hover {
        background: rgba(142, 142, 147, 0.1);
    }
    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
        min-width: auto;
    }
    
    /* åˆ†é¡µ */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 24px;
    }
    .pagination button {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        color: var(--text-color);
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
    }
    .pagination button:hover:not(:disabled) {
        background: rgba(142, 142, 147, 0.1);
        border-color: var(--primary);
    }
    .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .pagination .page-info {
        padding: 8px 16px;
        color: var(--text-sub);
        font-size: 14px;
    }
    
    /* æ¶ˆæ¯ç±»å‹æ ‡ç­¾ */
    .content-type-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 500;
        background: rgba(142, 142, 147, 0.1);
        color: var(--text-color);
    }
    .content-type-badge.text {
        background: rgba(0, 122, 255, 0.1);
        color: var(--primary);
    }
    .content-type-badge.image {
        background: rgba(52, 199, 89, 0.1);
        color: var(--success);
    }
    .content-type-badge.audio {
        background: rgba(255, 149, 0, 0.1);
        color: var(--warning);
    }
    .content-type-badge.question {
        background: rgba(142, 142, 147, 0.1);
        color: var(--text-color);
    }
    
    /* ä¼šè¯ç±»å‹ */
    .conv-type {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 500;
        background: rgba(0, 122, 255, 0.1);
        color: var(--primary);
    }
    
    /* æ¶ˆæ¯é¢„è§ˆå¼¹å±‚ */
    .message-drawer {
        position: fixed;
        top: 0;
        right: -600px;
        width: 600px;
        height: 100vh;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(40px) saturate(180%);
        -webkit-backdrop-filter: blur(40px) saturate(180%);
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
        transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
        display: flex;
        flex-direction: column;
    }
    .message-drawer.open {
        right: 0;
    }
    .drawer-header {
        padding: 24px;
        border-bottom: 0.5px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .drawer-header h2 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
    }
    .drawer-close {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-color);
        border-radius: 50%;
        transition: background 0.2s;
    }
    .drawer-close:hover {
        background: rgba(142, 142, 147, 0.1);
    }
    .drawer-body {
        flex: 1;
        overflow-y: auto;
        padding: 24px;
    }
    .message-item {
        padding: 16px;
        border-bottom: 0.5px solid var(--border-color);
        margin-bottom: 12px;
    }
    .message-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .message-sender {
        font-weight: 600;
        font-size: 14px;
    }
    .message-time {
        font-size: 12px;
        color: var(--text-sub);
    }
    .message-content {
        font-size: 14px;
        line-height: 1.5;
        word-break: break-word;
        margin-bottom: 8px;
    }
    .message-meta {
        display: flex;
        gap: 8px;
        align-items: center;
        font-size: 12px;
        color: var(--text-sub);
    }
    
    /* å›¾ç‰‡æ¶ˆæ¯æ ·å¼ */
    .message-image {
        max-width: 300px;
        max-height: 300px;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: var(--shadow-soft);
    }
    .message-image:hover {
        transform: scale(1.02);
        box-shadow: var(--shadow);
    }
    
    /* è¯­éŸ³æ¶ˆæ¯æ ·å¼ */
    .message-audio {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        background: rgba(142, 142, 147, 0.08);
        border-radius: var(--radius-md);
        border: 0.5px solid var(--border-color);
    }
    .audio-play-btn {
        width: 40px;
        height: 36px;
        border: 0.5px solid var(--border-color);
        border-radius: var(--radius-sm);
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        padding: 0;
        color: var(--text-color);
    }
    .audio-play-btn:hover {
        background: rgba(142, 142, 147, 0.12);
        transform: scale(1.05);
    }
    .audio-play-btn svg {
        width: 18px;
        height: 18px;
        fill: currentColor;
    }
    .audio-duration {
        font-size: 13px;
        color: var(--text-color);
        font-weight: 500;
    }
    
    /* é¢˜ç›®æ¶ˆæ¯æ ·å¼ */
    .message-question {
        padding: 12px 16px;
        background: rgba(142, 142, 147, 0.06);
        border: 0.5px solid var(--border-color);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: background 0.2s;
    }
    .message-question:hover {
        background: rgba(142, 142, 147, 0.1);
    }
    .question-title {
        font-weight: 600;
        font-size: 13px;
        margin-bottom: 8px;
        color: var(--text-color);
    }
    .question-content {
        font-size: 14px;
        line-height: 1.5;
        color: var(--text-color);
        margin-bottom: 6px;
    }
    .question-meta {
        font-size: 12px;
        color: var(--text-sub);
        margin-top: 6px;
    }
    
    /* å›¾ç‰‡é¢„è§ˆå¼¹å±‚ */
    .img-modal {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 2000;
        background: rgba(0, 0, 0, 0.75);
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    .img-modal.show {
        display: flex;
    }
    .img-modal img {
        max-width: min(92vw, 980px);
        max-height: 86vh;
        border-radius: var(--radius-lg);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }
    .img-modal .close {
        position: fixed;
        top: 16px;
        right: 16px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid rgba(255, 255, 255, 0.25);
        color: #fff;
        background: rgba(0, 0, 0, 0.35);
        cursor: pointer;
        font-size: 22px;
        line-height: 36px;
        text-align: center;
        transition: background 0.2s;
    }
    .img-modal .close:hover {
        background: rgba(0, 0, 0, 0.5);
    }
    .img-modal .hint {
        position: fixed;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        color: rgba(255, 255, 255, 0.85);
        font-size: 12px;
        background: rgba(0, 0, 0, 0.35);
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 999px;
        padding: 6px 10px;
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-sub);
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-sub);
    }
    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>èŠå¤©ç®¡ç†</h1>
    
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-cards" id="statsCards">
        <div class="stat-card">
            <div class="stat-card-label">ä¼šè¯æ€»æ•°</div>
            <div class="stat-card-value" id="statConvCount">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-label">æ¶ˆæ¯æ€»æ•°</div>
            <div class="stat-card-value" id="statMsgCount">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-label">ä»Šæ—¥æ¶ˆæ¯</div>
            <div class="stat-card-value" id="statTodayMsg">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-card-label">æ´»è·ƒä¼šè¯ï¼ˆ7å¤©ï¼‰</div>
            <div class="stat-card-value" id="statActiveConv">-</div>
        </div>
    </div>
    
    <!-- å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-left">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœç´¢ä¼šè¯..." />
            </div>
        </div>
    </div>
    
    <!-- ä¼šè¯åˆ—è¡¨ -->
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ç±»å‹</th>
                    <th>æ ‡é¢˜/å‚ä¸è€…</th>
                    <th>æˆå‘˜æ•°</th>
                    <th>æ¶ˆæ¯æ•°</th>
                    <th>æœ€åæ¶ˆæ¯æ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="conversationsTableBody">
                <tr>
                    <td colspan="7" class="loading">åŠ è½½ä¸­...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- åˆ†é¡µ -->
    <div class="pagination" id="pagination"></div>
</div>

<!-- æ¶ˆæ¯æŸ¥çœ‹æŠ½å±‰ -->
<div class="message-drawer" id="messageDrawer">
    <div class="drawer-header">
        <h2 id="drawerTitle">ä¼šè¯æ¶ˆæ¯</h2>
        <button class="drawer-close" onclick="closeMessageDrawer()">Ã—</button>
    </div>
    <div class="drawer-body" id="drawerBody">
        <div class="loading">åŠ è½½ä¸­...</div>
    </div>
</div>

<!-- å›¾ç‰‡é¢„è§ˆå¼¹å±‚ -->
<div class="img-modal" id="imgModal" onclick="closeImgModal(event)">
    <button class="close" onclick="closeImgModal(event)">Ã—</button>
    <img id="imgModalImg" src="" alt="é¢„è§ˆ" />
    <div class="hint">Esc å…³é—­ Â· ç‚¹å‡»èƒŒæ™¯å…³é—­</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let currentConversationId = null;
    let searchKeyword = '';
    let searchTimeout = null;
    
    // åŠ è½½ç»Ÿè®¡æ•°æ®
    async function loadStats() {
        try {
            const res = await fetch('/admin/api/chat/stats');
            const result = await res.json();
            if (result.status === 'success') {
                const data = result.data;
                document.getElementById('statConvCount').textContent = data.conv_count || 0;
                document.getElementById('statMsgCount').textContent = data.msg_count || 0;
                document.getElementById('statTodayMsg').textContent = data.today_msg_count || 0;
                document.getElementById('statActiveConv').textContent = data.active_conv_count || 0;
            }
        } catch (error) {
            console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        }
    }
    
    // åŠ è½½ä¼šè¯åˆ—è¡¨
    async function loadConversations() {
        try {
            const params = new URLSearchParams({
                page: currentPage,
                per_page: 20
            });
            if (searchKeyword) {
                params.append('keyword', searchKeyword);
            }
            
            const res = await fetch(`/admin/api/chat/conversations?${params}`);
            const result = await res.json();
            const tbody = document.getElementById('conversationsTableBody');
            
            if (result.status === 'success') {
                const conversations = result.data.conversations;
                const total = result.data.total;
                
                if (conversations.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">ğŸ’¬</div>
                                <div>æš‚æ— ä¼šè¯</div>
                            </td>
                        </tr>
                    `;
                    document.getElementById('pagination').innerHTML = '';
                    return;
                }
                
                tbody.innerHTML = conversations.map(conv => {
                    const lastMessageTime = conv.last_message_time 
                        ? new Date(conv.last_message_time).toLocaleString('zh-CN')
                        : '-';
                    
                    let titleOrMembers = conv.title || '-';
                    if (conv.c_type === 'direct' && conv.members && conv.members.length > 0) {
                        titleOrMembers = conv.members.map(m => m.username || `ç”¨æˆ·${m.id}`).join(', ');
                    }
                    
                    return `
                        <tr>
                            <td>${conv.id}</td>
                            <td><span class="conv-type">${conv.c_type === 'direct' ? 'ç§èŠ' : conv.c_type}</span></td>
                            <td>${titleOrMembers}</td>
                            <td>${conv.member_count || 0}</td>
                            <td>${conv.message_count || 0}</td>
                            <td>${lastMessageTime}</td>
                            <td>
                                <button class="btn-primary btn-sm" onclick="viewMessages(${conv.id})">æŸ¥çœ‹æ¶ˆæ¯</button>
                                <button class="btn-danger btn-sm" onclick="deleteConversation(${conv.id})">åˆ é™¤</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // æ¸²æŸ“åˆ†é¡µ
                renderPagination(result.data.total, result.data.per_page);
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div>åŠ è½½å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}</div>
                        </td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
            document.getElementById('conversationsTableBody').innerHTML = `
                <tr>
                    <td colspan="7" class="empty-state">
                        <div>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>
                    </td>
                </tr>
            `;
        }
    }
    
    // æ¸²æŸ“åˆ†é¡µ
    function renderPagination(total, perPage) {
        const totalPages = Math.ceil(total / perPage);
        const pagination = document.getElementById('pagination');
        
        if (totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }
        
        let html = '';
        html += `<button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
        html += `<span class="page-info">ç¬¬ ${currentPage} / ${totalPages} é¡µï¼Œå…± ${total} æ¡</span>`;
        html += `<button onclick="goToPage(${currentPage + 1})" ${currentPage >= totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;
        
        pagination.innerHTML = html;
    }
    
    // è·³è½¬é¡µé¢
    function goToPage(page) {
        if (page < 1) return;
        currentPage = page;
        loadConversations();
    }
    
    // æŸ¥çœ‹æ¶ˆæ¯
    async function viewMessages(conversationId) {
        currentConversationId = conversationId;
        const drawer = document.getElementById('messageDrawer');
        const drawerBody = document.getElementById('drawerBody');
        const drawerTitle = document.getElementById('drawerTitle');
        
        drawer.classList.add('open');
        drawerBody.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
        drawerTitle.textContent = `ä¼šè¯ #${conversationId} çš„æ¶ˆæ¯`;
        
        try {
            const res = await fetch(`/admin/api/chat/conversations/${conversationId}/messages?page=1&per_page=100`);
            const result = await res.json();
            
            if (result.status === 'success') {
                const messages = result.data.messages;
                
                if (messages.length === 0) {
                    drawerBody.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ’¬</div>
                            <div>æš‚æ— æ¶ˆæ¯</div>
                        </div>
                    `;
                    return;
                }
                
                // å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                messages.reverse();
                
                drawerBody.innerHTML = messages.map(msg => {
                    const time = new Date(msg.created_at).toLocaleString('zh-CN');
                    const contentTypeClass = msg.content_type || 'text';
                    const msgId = msg.id;
                    
                    // æ ¹æ®ä¸åŒç±»å‹æ¸²æŸ“å†…å®¹
                    let contentHtml = '';
                    
                    if (msg.content_type === 'image') {
                        const imgInfo = parseImageContent(msg.content);
                        const thumbUrl = imgInfo.thumb || imgInfo.url;
                        const fullUrl = imgInfo.url || thumbUrl;
                        
                        if (thumbUrl) {
                            contentHtml = `
                                <img src="${escapeHtml(thumbUrl)}" 
                                     alt="å›¾ç‰‡" 
                                     class="message-image" 
                                     onclick="openImgModal('${escapeHtml(fullUrl)}')"
                                     loading="lazy" />
                            `;
                        } else {
                            contentHtml = '<span style="color: var(--text-sub);">[å›¾ç‰‡] æ— æ•ˆçš„å›¾ç‰‡é“¾æ¥</span>';
                        }
                    } else if (msg.content_type === 'audio') {
                        const audioInfo = parseAudioContent(msg.content);
                        const audioUrl = audioInfo.url_m4a || audioInfo.url || audioInfo.url_raw;
                        const duration = audioInfo.duration;
                        
                        contentHtml = `
                            <div class="message-audio">
                                <button class="audio-play-btn" 
                                        data-msg-id="${msgId}"
                                        data-audio-url="${escapeHtml(audioUrl)}"
                                        onclick="toggleAudioPlay(this)"
                                        aria-label="æ’­æ”¾è¯­éŸ³">
                                    <svg viewBox="0 0 24 24" aria-hidden="true">
                                        <path d="M8 5v14l11-7z"></path>
                                    </svg>
                                </button>
                                ${duration ? `<span class="audio-duration">${duration}ç§’</span>` : ''}
                                <audio data-msg-id="${msgId}" style="display: none;"></audio>
                            </div>
                        `;
                    } else if (msg.content_type === 'question') {
                        const questionInfo = parseQuestionContent(msg.content);
                        const qType = questionInfo.type || '';
                        const qContent = questionInfo.content || '';
                        const qSubject = questionInfo.subject || '';
                        
                        contentHtml = `
                            <div class="message-question">
                                <div class="question-title">[é¢˜ç›®]${qType ? ' ' + escapeHtml(qType) : ''}</div>
                                <div class="question-content">${escapeHtml(qContent.length > 100 ? qContent.slice(0, 100) + '...' : qContent)}</div>
                                ${qSubject ? `<div class="question-meta">${escapeHtml(qSubject)}</div>` : ''}
                            </div>
                        `;
                    } else {
                        // æ™®é€šæ–‡æœ¬æ¶ˆæ¯
                        contentHtml = `<div class="message-content">${escapeHtml(msg.content || '')}</div>`;
                    }
                    
                    return `
                        <div class="message-item">
                            <div class="message-header">
                                <span class="message-sender">${escapeHtml(msg.sender_username || `ç”¨æˆ·${msg.sender_id}`)}</span>
                                <span class="message-time">${time}</span>
                            </div>
                            ${contentHtml}
                            <div class="message-meta">
                                <span class="content-type-badge ${contentTypeClass}">${msg.content_type || 'text'}</span>
                                <button class="btn-danger btn-sm" onclick="deleteMessage(${msgId})">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // åˆå§‹åŒ–æ‰€æœ‰éŸ³é¢‘å…ƒç´ 
                initializeAudioElements();
            } else {
                drawerBody.innerHTML = `
                    <div class="empty-state">
                        <div>åŠ è½½å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}</div>
                    </div>
                `;
            }
        } catch (error) {
            console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
            drawerBody.innerHTML = `
                <div class="empty-state">
                    <div>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>
                </div>
            `;
        }
    }
    
    // å…³é—­æ¶ˆæ¯æŠ½å±‰
    function closeMessageDrawer() {
        document.getElementById('messageDrawer').classList.remove('open');
        currentConversationId = null;
    }
    
    // åˆ é™¤ä¼šè¯
    async function deleteConversation(conversationId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä¼šè¯å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç›¸å…³æ¶ˆæ¯ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
            return;
        }
        
        try {
            const res = await fetch(`/admin/api/chat/conversations/${conversationId}`, {
                method: 'DELETE'
            });
            const result = await res.json();
            
            if (result.status === 'success') {
                alert('âœ… ä¼šè¯å·²åˆ é™¤');
                loadConversations();
                loadStats();
            } else {
                alert('âŒ åˆ é™¤å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', error);
            alert('âŒ åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }
    
    // åˆ é™¤æ¶ˆæ¯
    async function deleteMessage(messageId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ¶ˆæ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
            return;
        }
        
        try {
            const res = await fetch(`/admin/api/chat/messages/${messageId}`, {
                method: 'DELETE'
            });
            const result = await res.json();
            
            if (result.status === 'success') {
                alert('âœ… æ¶ˆæ¯å·²åˆ é™¤');
                if (currentConversationId) {
                    viewMessages(currentConversationId);
                }
                loadStats();
            } else {
                alert('âŒ åˆ é™¤å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            console.error('åˆ é™¤æ¶ˆæ¯å¤±è´¥:', error);
            alert('âŒ åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        }
    }
    
    // HTMLè½¬ä¹‰
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // è§£æå›¾ç‰‡å†…å®¹
    function parseImageContent(content) {
        if (!content) return { url: '', thumb: '' };
        if (typeof content !== 'string') return { url: '', thumb: '' };
        const s = content.trim();
        if (!s) return { url: '', thumb: '' };
        if (s.startsWith('{') && s.endsWith('}')) {
            try {
                const obj = JSON.parse(s);
                return {
                    url: obj.url || obj.u || '',
                    thumb: obj.thumb || obj.t || '',
                    w: obj.w || null,
                    h: obj.h || null
                };
            } catch(e) {
                return { url: s, thumb: '' };
            }
        }
        return { url: s, thumb: '' };
    }
    
    // è§£æè¯­éŸ³å†…å®¹
    function parseAudioContent(content) {
        if (!content) return { url: '', url_raw: '', url_m4a: '', duration: null };
        if (typeof content !== 'string') return { url: '', url_raw: '', url_m4a: '', duration: null };
        const s = content.trim();
        if (!s) return { url: '', url_raw: '', url_m4a: '', duration: null };
        if (s.startsWith('{') && s.endsWith('}')) {
            try {
                const obj = JSON.parse(s);
                const url_m4a = obj.url_m4a || '';
                const url_raw = obj.url_raw || '';
                const url = obj.url || url_m4a || url_raw || '';
                return {
                    url,
                    url_raw,
                    url_m4a,
                    duration: (obj.duration != null ? obj.duration : null)
                };
            } catch(e) {
                return { url: s, url_raw: '', url_m4a: '', duration: null };
            }
        }
        return { url: s, url_raw: '', url_m4a: '', duration: null };
    }
    
    // è§£æé¢˜ç›®å†…å®¹
    function parseQuestionContent(content) {
        if (!content) return {};
        if (typeof content !== 'string') return {};
        const s = content.trim();
        if (!s) return {};
        if (s.startsWith('{') && s.endsWith('}')) {
            try {
                return JSON.parse(s);
            } catch(e) {
                return { content: s };
            }
        }
        return { content: s };
    }
    
    // æ‰“å¼€å›¾ç‰‡é¢„è§ˆ
    function openImgModal(url) {
        const modal = document.getElementById('imgModal');
        const img = document.getElementById('imgModalImg');
        if (!modal || !img) return;
        img.src = url;
        modal.classList.add('show');
    }
    
    // å…³é—­å›¾ç‰‡é¢„è§ˆ
    function closeImgModal(e) {
        const modal = document.getElementById('imgModal');
        if (!modal) return;
        if (e && e.target && (e.target.id === 'imgModal' || e.target.classList.contains('close'))) {
            modal.classList.remove('show');
            const img = document.getElementById('imgModalImg');
            if (img) img.src = '';
        }
    }
    
    // å½“å‰æ’­æ”¾çš„éŸ³é¢‘
    let currentPlayingAudio = null;
    let currentPlayingBtn = null;
    
    // åˆå§‹åŒ–éŸ³é¢‘å…ƒç´ 
    function initializeAudioElements() {
        // ä¸ºæ‰€æœ‰éŸ³é¢‘å…ƒç´ è®¾ç½®src
        document.querySelectorAll('audio[data-msg-id]').forEach(audioEl => {
            const msgId = audioEl.getAttribute('data-msg-id');
            const btn = document.querySelector(`.audio-play-btn[data-msg-id="${msgId}"]`);
            if (!btn) return;
            
            const audioUrl = btn.getAttribute('data-audio-url');
            if (audioUrl) {
                audioEl.src = audioUrl;
            }
        });
    }
    
    // åˆ‡æ¢éŸ³é¢‘æ’­æ”¾
    function toggleAudioPlay(btn) {
        const msgId = btn.getAttribute('data-msg-id');
        const audioEl = document.querySelector(`audio[data-msg-id="${msgId}"]`);
        if (!audioEl) return;
        
        // å¦‚æœå·²æœ‰å…¶ä»–éŸ³é¢‘åœ¨æ’­æ”¾ï¼Œå…ˆåœæ­¢
        if (currentPlayingAudio && currentPlayingAudio !== audioEl) {
            try {
                currentPlayingAudio.pause();
                currentPlayingAudio.currentTime = 0;
                if (currentPlayingBtn) {
                    setAudioPlayButtonState(currentPlayingBtn, false);
                }
            } catch(e) {}
        }
        
        if (audioEl.paused) {
            // æ’­æ”¾
            audioEl.play().then(() => {
                currentPlayingAudio = audioEl;
                currentPlayingBtn = btn;
                setAudioPlayButtonState(btn, true);
            }).catch(e => {
                console.error('æ’­æ”¾å¤±è´¥:', e);
                alert('æ— æ³•æ’­æ”¾è¯­éŸ³');
            });
        } else {
            // æš‚åœ
            audioEl.pause();
            setAudioPlayButtonState(btn, false);
            if (currentPlayingAudio === audioEl) {
                currentPlayingAudio = null;
                currentPlayingBtn = null;
            }
        }
        
        // ç›‘å¬æ’­æ”¾ç»“æŸ
        audioEl.onended = () => {
            setAudioPlayButtonState(btn, false);
            if (currentPlayingAudio === audioEl) {
                currentPlayingAudio = null;
                currentPlayingBtn = null;
            }
        };
        
        audioEl.onpause = () => {
            setAudioPlayButtonState(btn, false);
            if (currentPlayingAudio === audioEl) {
                currentPlayingAudio = null;
                currentPlayingBtn = null;
            }
        };
    }
    
    // è®¾ç½®éŸ³é¢‘æ’­æ”¾æŒ‰é’®çŠ¶æ€
    function setAudioPlayButtonState(btn, playing) {
        const svg = btn.querySelector('svg');
        if (!svg) return;
        
        if (playing) {
            svg.innerHTML = `
                <path d="M6 5h4v14H6z"></path>
                <path d="M14 5h4v14h-4z"></path>
            `;
            btn.setAttribute('aria-label', 'æš‚åœè¯­éŸ³');
        } else {
            svg.innerHTML = `<path d="M8 5v14l11-7z"></path>`;
            btn.setAttribute('aria-label', 'æ’­æ”¾è¯­éŸ³');
        }
    }
    
    // æœç´¢è¾“å…¥ç›‘å¬
    document.getElementById('searchInput').addEventListener('input', (e) => {
        searchKeyword = e.target.value.trim();
        
        // é˜²æŠ–
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentPage = 1;
            loadConversations();
        }, 300);
    });
    
    // ç‚¹å‡»æŠ½å±‰å¤–éƒ¨å…³é—­
    document.getElementById('messageDrawer').addEventListener('click', (e) => {
        if (e.target.id === 'messageDrawer') {
            closeMessageDrawer();
        }
    });
    
    // ESCé”®å…³é—­æŠ½å±‰æˆ–å›¾ç‰‡é¢„è§ˆ
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const imgModal = document.getElementById('imgModal');
            if (imgModal && imgModal.classList.contains('show')) {
                closeImgModal({ target: imgModal });
            } else {
                closeMessageDrawer();
            }
        }
    });
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        loadStats();
        loadConversations();
    });
</script>
{% endblock %}

