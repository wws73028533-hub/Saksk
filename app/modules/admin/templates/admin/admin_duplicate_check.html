{% extends "admin/admin_base.html" %}

{% block title %}题目查重去重{% endblock %}

{% block head %}
<style>
    body {
        background-color: var(--bg-color);
    }
    .container {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        padding: 40px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-soft);
        border: 0.5px solid var(--border-color);
    }
    
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
    }
    
    /* 页面标题区域按钮统一样式 */
    .page-header .btn {
        min-width: 100px;
        height: 44px;
        padding: 10px 20px;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
    }
    
    /* 确保按钮在隐藏状态下仍保持尺寸 */
    .page-header #recheckBtn[style*="display: none"] {
        display: none !important;
    }
    
    .page-header #recheckBtn:not([style*="display: none"]) {
        display: inline-flex !important;
    }
    
    .page-title {
        font-size: 24px;
        font-weight: bold;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .subject-badge {
        display: inline-block;
        padding: 6px 14px;
        background-color: var(--primary-light);
        color: var(--text-color);
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
    }
    
    .filter-bar {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 24px;
        padding: 16px;
        background: rgba(255, 255, 255, 0.5);
        backdrop-filter: blur(20px);
        border-radius: var(--radius-md);
        border: 0.5px solid var(--border-color);
        flex-wrap: wrap;
    }
    
    /* 确保filter-bar只出现一次 */
    #similarityFilterBar {
        display: flex !important;
    }
    
    /* 防止重复渲染 */
    .filter-bar:not(#similarityFilterBar) {
        display: none !important;
    }
    
    .filter-bar label {
        font-size: 14px;
        color: var(--text-color);
        font-weight: 500;
    }
    
    .filter-bar input[type="range"],
    .filter-bar input[type="number"] {
        width: 120px;
    }
    
    .filter-bar .similarity-display {
        font-size: 14px;
        color: var(--primary);
        font-weight: 600;
        min-width: 80px;
    }
    
    .stats-bar {
        display: flex;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }
    
    .stat-card {
        padding: 16px 20px;
        border-radius: var(--radius-md);
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px);
        border: 0.5px solid var(--border-color);
        box-shadow: var(--shadow-soft);
        flex: 1;
        min-width: 150px;
    }
    
    .stat-label {
        font-size: 13px;
        color: var(--text-sub);
        margin-bottom: 8px;
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: 600;
        color: var(--text-color);
    }
    
    .duplicate-pairs {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .duplicate-pair {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        padding: 20px;
        box-shadow: var(--shadow-soft);
    }
    
    .pair-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .similarity-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
    }
    
    .similarity-high {
        background-color: rgba(255, 59, 48, 0.15);
        color: #ff3b30;
    }
    
    .similarity-medium {
        background-color: rgba(255, 149, 0, 0.15);
        color: #ff9500;
    }
    
    .similarity-low {
        background-color: rgba(52, 199, 89, 0.15);
        color: #34c759;
    }
    
    .pair-actions {
        display: flex;
        gap: 8px;
    }
    
    .questions-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    
    .question-card {
        padding: 16px;
        background: rgba(248, 249, 250, 0.7);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-color);
    }
    
    .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .question-id {
        font-size: 12px;
        color: var(--text-sub);
        font-weight: 500;
    }
    
    .question-content {
        font-size: 15px;
        line-height: 1.6;
        color: var(--text-color);
        margin-bottom: 12px;
    }
    
    .question-meta {
        display: flex;
        gap: 12px;
        font-size: 12px;
        color: var(--text-sub);
        flex-wrap: wrap;
    }
    
    .question-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
    }
    
    .btn {
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 500;
        border-radius: 8px;
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .btn-primary {
        background-color: rgba(0, 122, 255, 0.1);
        color: var(--primary);
        border-color: rgba(0, 122, 255, 0.3);
    }
    
    .btn-primary:hover {
        background-color: rgba(0, 122, 255, 0.2);
        border-color: rgba(0, 122, 255, 0.5);
    }
    
    .btn-danger {
        background-color: rgba(255, 59, 48, 0.1);
        color: var(--danger);
        border-color: rgba(255, 59, 48, 0.3);
    }
    
    .btn-danger:hover {
        background-color: rgba(255, 59, 48, 0.2);
        border-color: rgba(255, 59, 48, 0.5);
    }
    
    .btn-secondary {
        background-color: rgba(142, 142, 147, 0.1);
        color: var(--text-color);
        border-color: rgba(142, 142, 147, 0.3);
    }
    
    .btn-secondary:hover {
        background-color: rgba(142, 142, 147, 0.2);
        border-color: rgba(142, 142, 147, 0.5);
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-sub);
    }
    
    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
    }
    
    .empty-state-text {
        font-size: 16px;
        margin-bottom: 8px;
    }
    
    .empty-state-hint {
        font-size: 14px;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-sub);
    }
    
    [data-theme="dark"] .filter-bar {
        background: rgba(28, 28, 30, 0.5);
    }
    
    [data-theme="dark"] .stat-card {
        background: rgba(28, 28, 30, 0.7);
    }
    
    [data-theme="dark"] .duplicate-pair {
        background: rgba(28, 28, 30, 0.7);
    }
    
    [data-theme="dark"] .question-card {
        background: rgba(28, 28, 30, 0.5);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- 页面标题 -->
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <span>题目查重去重</span>
                <span class="subject-badge">{{ subject.name }}</span>
            </h1>
            <div id="recordInfo" style="margin-top: 8px; font-size: 13px; color: var(--text-sub);"></div>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button class="btn btn-primary" onclick="recheckDuplicates()" id="recheckBtn" style="display: none;">
                重新查重
            </button>
            <a href="/admin/subjects/{{ subject_id }}/questions" class="btn btn-secondary">
                ← 返回题集
            </a>
        </div>
    </div>
    
    <!-- 统计信息 -->
    <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-label">总重复对数</div>
            <div class="stat-value" id="totalPairs">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">当前显示</div>
            <div class="stat-value" id="displayedPairs">-</div>
        </div>
    </div>
    
    <!-- 相似度筛选 -->
    <div class="filter-bar" id="similarityFilterBar">
        <label for="similarityThreshold">最小相似度阈值：</label>
        <input type="range" id="similarityThreshold" min="0" max="100" value="80" step="5" aria-label="相似度阈值">
        <span class="similarity-display" id="similarityDisplay" aria-live="polite">80%</span>
        <button class="btn btn-primary" onclick="applyFilter()" type="button">应用</button>
        <button class="btn btn-secondary" onclick="resetFilter()" type="button">重置</button>
    </div>
    
    <!-- 重复题目对列表 -->
    <div id="duplicatePairsContainer" class="duplicate-pairs">
        <div class="loading">正在加载查重结果...</div>
    </div>
</div>

<!-- 题目详情模态框 -->
<div id="questionDetailModal" onclick="handleModalBackdropClick(event)" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; cursor: pointer;">
    <div onclick="event.stopPropagation()" style="background: var(--card-bg-solid); border-radius: var(--radius-lg); padding: 24px; max-width: 800px; max-height: 90vh; overflow-y: auto; margin: 20px; cursor: default;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">题目详情</h2>
            <button onclick="closeQuestionDetail()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-color);" title="关闭">&times;</button>
        </div>
        <div id="questionDetailContent"></div>
    </div>
</div>

<script>
const subjectId = {{ subject_id }};
let allDuplicates = [];
let filteredDuplicates = [];

// 加载查重结果（优先显示历史记录）
async function loadDuplicateCheckResults(forceNew = false) {
    try {
        const url = `/admin/api/questions/duplicate-check/results?subject_id=${subjectId}` + 
                    (forceNew ? '&force_new=true' : '');
        const res = await fetch(url);
        const result = await res.json();
        
        if (result.status === 'success') {
            const data = result.data;
            allDuplicates = data.duplicates || [];
            filteredDuplicates = [...allDuplicates];
            
            // 更新记录信息显示
            updateRecordInfo(data);
            
            // 显示重新查重按钮
            document.getElementById('recheckBtn').style.display = 'inline-flex';
            
            updateStats();
            renderDuplicatePairs();
        } else {
            document.getElementById('duplicatePairsContainer').innerHTML = 
                '<div class="empty-state"><div class="empty-state-icon">❌</div><div class="empty-state-text">加载失败</div><div class="empty-state-hint">' + (result.message || '未知错误') + '</div></div>';
        }
    } catch (error) {
        console.error('加载查重结果失败:', error);
        document.getElementById('duplicatePairsContainer').innerHTML = 
            '<div class="empty-state"><div class="empty-state-icon">❌</div><div class="empty-state-text">加载失败</div><div class="empty-state-hint">请刷新页面重试</div></div>';
    }
}

// 更新记录信息显示
function updateRecordInfo(data) {
    const recordInfo = document.getElementById('recordInfo');
    if (data.is_new) {
        recordInfo.textContent = '本次查重结果（已保存）';
        recordInfo.style.color = 'var(--success)';
    } else if (data.created_at) {
        const date = new Date(data.created_at);
        const dateStr = date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        recordInfo.textContent = `历史查重记录（${dateStr}）`;
        recordInfo.style.color = 'var(--text-sub)';
    } else {
        recordInfo.textContent = '';
    }
}

// 重新查重
async function recheckDuplicates() {
    if (!confirm('确定要重新查重吗？这将重新计算所有题目的相似度，可能需要一些时间。')) {
        return;
    }
    
    // 禁用按钮，显示加载状态
    const btn = document.getElementById('recheckBtn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = '⏳ 查重中...';
    document.getElementById('duplicatePairsContainer').innerHTML = 
        '<div class="loading">正在重新查重，请稍候...</div>';
    
    try {
        // 强制重新查重
        await loadDuplicateCheckResults(true);
        alert('查重完成！');
    } catch (error) {
        console.error('重新查重失败:', error);
        alert('重新查重失败，请重试');
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

// 更新统计信息
function updateStats() {
    document.getElementById('totalPairs').textContent = allDuplicates.length;
    document.getElementById('displayedPairs').textContent = filteredDuplicates.length;
}

// 渲染重复题目对
function renderDuplicatePairs() {
    const container = document.getElementById('duplicatePairsContainer');
    
    if (filteredDuplicates.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">✅</div>
                <div class="empty-state-text">未发现重复题目</div>
                <div class="empty-state-hint">该科目下的题目没有重复</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = filteredDuplicates.map(pair => {
        const q1 = pair.question1;
        const q2 = pair.question2;
        const similarity = pair.similarity_percent;
        
        let similarityClass = 'similarity-low';
        if (similarity >= 90) {
            similarityClass = 'similarity-high';
        } else if (similarity >= 80) {
            similarityClass = 'similarity-medium';
        }
        
        return `
            <div class="duplicate-pair">
                <div class="pair-header">
                    <div>
                        <span class="similarity-badge ${similarityClass}">
                            <span>相似度: ${similarity}%</span>
                        </span>
                    </div>
                </div>
                <div class="questions-comparison">
                    <div class="question-card">
                        <div class="question-header">
                            <span class="question-id">题目 #${q1.id}</span>
                        </div>
                        <div class="question-content">${escapeHtml(q1.content || '')}</div>
                        <div class="question-meta">
                            <span>题型: ${q1.q_type || '-'}</span>
                            <span>难度: ${'★'.repeat(q1.difficulty || 1)}</span>
                        </div>
                        <div class="question-actions">
                            <button class="btn btn-primary" onclick="viewQuestionDetail(${q1.id})">查看详情</button>
                            <button class="btn btn-danger" onclick="deleteQuestion(${q1.id})">删除</button>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question-header">
                            <span class="question-id">题目 #${q2.id}</span>
                        </div>
                        <div class="question-content">${escapeHtml(q2.content || '')}</div>
                        <div class="question-meta">
                            <span>题型: ${q2.q_type || '-'}</span>
                            <span>难度: ${'★'.repeat(q2.difficulty || 1)}</span>
                        </div>
                        <div class="question-actions">
                            <button class="btn btn-primary" onclick="viewQuestionDetail(${q2.id})">查看详情</button>
                            <button class="btn btn-danger" onclick="deleteQuestion(${q2.id})">删除</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// 应用相似度筛选（前端筛选，更快）
function applyFilter() {
    const threshold = parseInt(document.getElementById('similarityThreshold').value) / 100;
    
    filteredDuplicates = allDuplicates.filter(pair => {
        const sim = pair.similarity;
        return sim >= threshold;
    });
    
    updateStats();
    renderDuplicatePairs();
}

// 重置筛选
function resetFilter() {
    document.getElementById('similarityThreshold').value = 80;
    updateSimilarityDisplay();
    filteredDuplicates = [...allDuplicates];
    updateStats();
    renderDuplicatePairs();
}

// 更新相似度显示
function updateSimilarityDisplay() {
    const threshold = document.getElementById('similarityThreshold').value;
    document.getElementById('similarityDisplay').textContent = threshold + '%';
}

// 查看题目详情
async function viewQuestionDetail(questionId) {
    try {
        const res = await fetch(`/admin/api/questions/${questionId}`);
        const question = await res.json();
        
        let optionsHtml = '';
        if (question.options) {
            try {
                const options = typeof question.options === 'string' ? JSON.parse(question.options) : question.options;
                if (Array.isArray(options)) {
                    optionsHtml = '<div style="margin-top: 12px;"><strong>选项：</strong><ul>';
                    options.forEach((opt, idx) => {
                        const optText = typeof opt === 'object' ? (opt.text || opt.value || JSON.stringify(opt)) : opt;
                        optionsHtml += `<li>${escapeHtml(optText)}</li>`;
                    });
                    optionsHtml += '</ul></div>';
                }
            } catch (e) {
                // 解析失败，忽略
            }
        }
        
        const detailHtml = `
            <div>
                <p><strong>题目ID：</strong>${question.id}</p>
                <p><strong>题型：</strong>${question.q_type || '-'}</p>
                <p><strong>难度：</strong>${'★'.repeat(question.difficulty || 1)}</p>
                <p><strong>题干：</strong></p>
                <div style="padding: 12px; background: var(--card-bg); border-radius: 8px; margin-bottom: 12px;">
                    ${escapeHtml(question.content || '')}
                </div>
                ${optionsHtml}
                <p style="margin-top: 12px;"><strong>答案：</strong>${escapeHtml(question.answer || '-')}</p>
                ${question.explanation ? `<p><strong>解析：</strong>${escapeHtml(question.explanation)}</p>` : ''}
            </div>
        `;
        
        document.getElementById('questionDetailContent').innerHTML = detailHtml;
        document.getElementById('questionDetailModal').style.display = 'flex';
    } catch (error) {
        console.error('加载题目详情失败:', error);
        alert('加载题目详情失败');
    }
}

// 关闭题目详情
function closeQuestionDetail() {
    document.getElementById('questionDetailModal').style.display = 'none';
}

// 处理模态框背景点击（点击外围关闭）
function handleModalBackdropClick(event) {
    // 如果点击的是模态框背景（不是内容区域），则关闭模态框
    if (event.target.id === 'questionDetailModal') {
        closeQuestionDetail();
    }
}

// 删除题目
async function deleteQuestion(questionId) {
    if (!confirm('确定要删除这道题目吗？此操作不可恢复。')) {
        return;
    }
    
    try {
        const res = await fetch(`/admin/api/questions/${questionId}`, {
            method: 'DELETE'
        });
        const result = await res.json();
        
        if (result.status === 'success') {
            // 从列表中移除包含该题目的重复对
            allDuplicates = allDuplicates.filter(pair => 
                pair.question1.id !== questionId && pair.question2.id !== questionId
            );
            
            // 重新应用当前筛选
            applyFilter();
            alert('删除成功');
        } else {
            alert('删除失败：' + (result.message || '未知错误'));
        }
    } catch (error) {
        console.error('删除题目失败:', error);
        alert('删除失败，请重试');
    }
}

// 转义HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 初始化
document.addEventListener('DOMContentLoaded', () => {
    // 确保筛选栏只出现一次（移除可能的重复元素）
    const filterBars = document.querySelectorAll('#similarityFilterBar');
    if (filterBars.length > 1) {
        // 保留第一个，移除其他的
        for (let i = 1; i < filterBars.length; i++) {
            filterBars[i].remove();
        }
    }
    
    // 确保滑块元素只出现一次
    const sliders = document.querySelectorAll('#similarityThreshold');
    if (sliders.length > 1) {
        for (let i = 1; i < sliders.length; i++) {
            sliders[i].remove();
        }
    }
    
    // 检查并获取滑块元素
    const slider = document.getElementById('similarityThreshold');
    
    if (slider) {
        // 监听相似度滑块变化
        slider.addEventListener('input', updateSimilarityDisplay);
    } else {
        console.error('无法找到滑块元素');
    }
    
    // 加载查重结果
    loadDuplicateCheckResults();
});
</script>
{% endblock %}

