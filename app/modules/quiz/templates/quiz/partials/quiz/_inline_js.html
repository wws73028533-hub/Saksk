const mode = '{{ mode }}';
const source = '{{ source or "" }}';
const LOGGED_IN = {{ 'true' if logged_in else 'false' }};
const USER_KEY = "{{ user_id if logged_in else 'guest' }}"; // ç”¨ user_id ä½œä¸ºè¿›åº¦éš”ç¦»é”®

// ä¼˜åŒ–åçš„è¿›åº¦é”®ç”Ÿæˆå‡½æ•° - æ ‡å‡†åŒ–å‚æ•°é¡ºåº,é¿å…é‡å¤è¿›åº¦
// é‡è¦ï¼šå¿…é¡»ä¸åç«¯ quiz.py ä¸­çš„ key ç”Ÿæˆé€»è¾‘ä¿æŒä¸€è‡´ï¼
function progressKey(){
    const params = new URLSearchParams(window.location.search);
    const subject = params.get('subject') || 'all';
    const type = params.get('type') || 'all';
    const currentMode = params.get('mode') || mode || 'quiz';
    
    // è€ƒè¯•æ¨¡å¼ä½¿ç”¨exam_idä½œä¸ºå”¯ä¸€æ ‡è¯†
    if (currentMode === 'exam') {
        const examId = params.get('exam_id');
        if (examId) {
            return `quiz_progress_${USER_KEY}_exam_${examId}`;
        }
    }
    
    // è®¡ç®— data_scopeï¼ˆä¸åç«¯ quiz.py ä¿æŒä¸€è‡´ï¼‰
    // åç«¯é€»è¾‘ï¼šdata_scope = target if target in ('favorites', 'mistakes') else 'all'
    // target = source if source in ('favorites', 'mistakes') else mode
    const sourceParam = params.get('source') || '';
    let dataScope = 'all';
    if (sourceParam === 'favorites' || sourceParam === 'mistakes') {
        dataScope = sourceParam;
    }
    
    // å…¶ä»–æ¨¡å¼ä½¿ç”¨æ ‡å‡†åŒ–çš„ç§‘ç›®+é¢˜å‹+æ¨¡å¼+data_scope+æ‰“ä¹±è®¾ç½®
    const shuffleQ = params.get('shuffle_questions') === '1' ? '1' : '0';
    const shuffleO = params.get('shuffle_options') === '1' ? '1' : '0';
    return `quiz_progress_${USER_KEY}_${currentMode}_${subject}_${type}_${dataScope}_q${shuffleQ}_o${shuffleO}`;
}
let questions = document.querySelectorAll('.question-box');
const EXAM_ID = (function(){ const el = document.getElementById('mainCard'); return el ? (el.dataset.examId || '') : ''; })();
const EXAM_SUBMITTED = {{ 'true' if submitted else 'false' }};
const USER_ANSWERS = {{ user_answers_json|safe if user_answers_json else '{}' }};
let listItems = document.querySelectorAll('.q-item');

// ===== é¢˜ç›®è½¬å‘ï¼ˆå‘é€åˆ°ç«™å†…èŠå¤©ï¼‰ =====
const forwardBtn = document.getElementById('forward-question-btn');
if (forwardBtn) {
    forwardBtn.addEventListener('click', ()=>{
        if (!LOGGED_IN) { showToast('è¯·å…ˆç™»å½•åå†è½¬å‘'); return; }
        openForwardModal();
    });
}

function closeForwardModal(e){
    if (e) {
        // ç‚¹å‡»é®ç½©å…³é—­
        if (e.target && e.target.id !== 'forwardOverlay') return;
    }
    const ov = document.getElementById('forwardOverlay');
    if (ov) ov.style.display = 'none';
    const list = document.getElementById('forwardUserList');
    if (list) list.innerHTML = '';
}

function openForwardModal(){
    const ov = document.getElementById('forwardOverlay');
    if (!ov) return;
    ov.style.display = 'flex';

    // é¢„è§ˆå½“å‰é¢˜ç›®
    try {
        const q = questions[currentIndex];
        const qid = q ? (q.getAttribute('data-id') || '') : '';
        const qtype = q ? (q.getAttribute('data-type') || '') : '';
        const meta = document.getElementById('forwardQMeta');
        const content = document.getElementById('forwardQContent');
        if (meta) meta.textContent = `ID: ${qid} Â· é¢˜å‹: ${qtype} Â· ç¬¬ ${currentIndex+1} é¢˜ / ${totalQuestions}`;
        if (content) {
            const el = q ? q.querySelector('.q-content') : null;
            content.textContent = el ? (el.innerText || '').trim() : '';
        }
    } catch(err) {}

    // é»˜è®¤æ‹‰ä¸€æ¬¡ç”¨æˆ·åˆ—è¡¨
    fetchForwardUsers();

    // èšç„¦æœç´¢æ¡†
    try { const inp = document.getElementById('forwardUserSearch'); if (inp) inp.focus(); } catch(e) {}
}

function onForwardUserSearchKey(e){
    if (e.key === 'Enter') {
        e.preventDefault();
        fetchForwardUsers();
    }
}

function escapeHtml(s){
    const div = document.createElement('div');
    div.textContent = s || '';
    return div.innerHTML;
}

async function fetchForwardUsers(){
    const inp = document.getElementById('forwardUserSearch');
    const kw = (inp && inp.value) ? inp.value.trim() : '';
    const res = await fetch(`/api/chat/users?q=${encodeURIComponent(kw)}`);
    const js = await res.json();
    if (!res.ok || js.status !== 'success') {
        showToast(js.message || 'æœç´¢ç”¨æˆ·å¤±è´¥');
        return;
    }
    renderForwardUserList(js.data || []);
}

function renderForwardUserList(users){
    const list = document.getElementById('forwardUserList');
    if (!list) return;
    if (!users.length) {
        list.innerHTML = `<div style="padding:10px 6px; color:var(--text-sub);">æ²¡æœ‰åŒ¹é…çš„ç”¨æˆ·</div>`;
        return;
    }

    list.innerHTML = users.slice(0, 50).map(u=>{
        const name = u.username || 'ç”¨æˆ·';
        const avatar = u.avatar || '';
        const initial = (name || 'U').slice(0,1).toUpperCase();
        const avHtml = avatar
          ? (()=>{
                const safeUrl = String(avatar||'')
                    .replace(/'/g, '%27')
                    .replace(/\)/g, '%29');
                return '<div style="width:38px;height:38px;border-radius:999px;background-image:url(&quot;' + safeUrl + '&quot;);background-size:cover;background-position:center;"></div>';
            })()
          : `<div style="width:38px;height:38px;border-radius:999px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;">${escapeHtml(initial)}</div>`;

        return `
          <div style="display:flex; align-items:center; gap:10px; padding:10px 10px; border-radius:14px; border:1px solid var(--border-color); cursor:pointer;" onclick="forwardToUser(${Number(u.id||0)})">
            ${avHtml}
            <div style="flex:1; min-width:0;">
              <div style="font-weight:700;">${escapeHtml(name)}</div>
              <div style="font-size:12px; color:var(--text-sub);">ID: ${escapeHtml(String(u.id||''))}</div>
            </div>
            <div style="color:var(--primary); font-weight:700;">å‘é€</div>
          </div>
        `;
    }).join('');
}

async function forwardToUser(peerUserId){
    if (!peerUserId) return;
    const q = questions[currentIndex];
    const qid = q ? (q.getAttribute('data-id') || '') : '';
    if (!qid) { showToast('é¢˜ç›®IDè·å–å¤±è´¥'); return; }

    try {
        // 1) åˆ›å»º/å¤ç”¨ä¼šè¯
        const cRes = await fetch('/api/chat/conversations/create', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ peer_user_id: peerUserId })
        });
        const cJs = await cRes.json();
        if (!cRes.ok || cJs.status !== 'success') { showToast(cJs.message || 'åˆ›å»ºä¼šè¯å¤±è´¥'); return; }
        const cid = cJs.conversation_id;

        // 2) å‘é€â€œé¢˜ç›®å¡ç‰‡â€æ¶ˆæ¯
        const sRes = await fetch('/api/chat/messages/send_question', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ conversation_id: cid, question_id: Number(qid) })
        });
        const sJs = await sRes.json();
        if (!sRes.ok || sJs.status !== 'success') { showToast(sJs.message || 'è½¬å‘å¤±è´¥'); return; }

        showToast('å·²è½¬å‘');
        closeForwardModal();
    } catch(e) {
        showToast('è½¬å‘å¤±è´¥');
    }
}

const totalQuestions = {{ questions|length }};
let currentIndex = 0;
let isWholeView = false;
let isSubmitted = false; // æ ‡è®°æ˜¯å¦å·²äº¤å·

let timerSeconds = {{ duration * 60 if duration else 0 }};
let timerInterval;
let cachedOrder = null; // ç¼“å­˜é¢˜ç›®é¡ºåºï¼Œä¿å­˜è¿›åº¦æ—¶éœ€è¦ä¿ç•™

// ===== æ‚¬æµ®çƒï¼ˆFabï¼‰+ åœ†ç¯èœå• + å¯æ‹–åŠ¨ =====
const FAB_ENABLED_KEY = 'quiz_fab_enabled_v1';
const FAB_AUTO_NEXT_KEY = 'quiz_fab_auto_next';
const FAB_POS_KEY = 'quiz_fab_pos_v1';
let fabOpen = false;

function isFabEnabled(){
    // é»˜è®¤å¼€å¯ï¼›ç”¨æˆ·åœ¨é¢˜åº“è®¾ç½®é¡µå…³é—­åå†™å…¥ '0'
    return localStorage.getItem(FAB_ENABLED_KEY) !== '0';
}

function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

function getFabSize(){
    // ä¸ CSS .quiz-fab width/height ä¿æŒä¸€è‡´
    return 56;
}

function isFabAutoNextEnabled(){
    // å¦‚æœæ‚¬æµ®çƒè¢«ç¦ç”¨ï¼Œæ‰€æœ‰æ‚¬æµ®çƒç›¸å…³åŠŸèƒ½ï¼ˆåŒ…æ‹¬è‡ªåŠ¨åˆ‡é¢˜ï¼‰ä¹Ÿåº”è¯¥ç¦ç”¨
    if (!isFabEnabled()) return false;
    return localStorage.getItem(FAB_AUTO_NEXT_KEY) === '1';
}
function setFabAutoNextEnabled(on){
    localStorage.setItem(FAB_AUTO_NEXT_KEY, on ? '1' : '0');
}

function saveFabPos(left, top){
    try { localStorage.setItem(FAB_POS_KEY, JSON.stringify({ left, top })); } catch(e) {}
}
function loadFabPos(){
    try {
        const raw = localStorage.getItem(FAB_POS_KEY);
        if (!raw) return null;
        const js = JSON.parse(raw);
        if (!js || typeof js.left !== 'number' || typeof js.top !== 'number') return null;
        return js;
    } catch(e) { return null; }
}

function calcDefaultFabPos(){
    const size = getFabSize();
    const rightGap = 14;
    const bottomGap = 84;
    const left = Math.max(8, window.innerWidth - rightGap - size);
    const top = Math.max(8, window.innerHeight - bottomGap - size);
    return { left, top };
}

function normalizeFabPos(pos){
    const size = getFabSize();
    const margin = 8;
    const maxLeft = window.innerWidth - size - margin;
    const maxTop = window.innerHeight - size - margin;
    return {
        left: clamp(pos.left, margin, Math.max(margin, maxLeft)),
        top: clamp(pos.top, margin, Math.max(margin, maxTop))
    };
}

function applyFabPos(left, top){
    const fab = document.getElementById('quizFab');
    const menu = document.getElementById('quizFabMenu');
    if (!fab || !menu) return;

    fab.style.left = `${left}px`;
    fab.style.top = `${top}px`;
    fab.style.right = 'auto';
    fab.style.bottom = 'auto';

    menu.style.left = `${left}px`;
    menu.style.top = `${top}px`;
    menu.style.right = 'auto';
    menu.style.bottom = 'auto';
}

function updateFabUI(){
    const fab = document.getElementById('quizFab');
    const menu = document.getElementById('quizFabMenu');
    if (!fab || !menu) return;

    fab.classList.toggle('open', fabOpen);
    menu.classList.toggle('open', fabOpen);
    menu.setAttribute('aria-hidden', fabOpen ? 'false' : 'true');

    const btnAuto = menu.querySelector('.quiz-fab-item[data-action="autoNext"] .quiz-fab-icon');
    if (btnAuto) btnAuto.textContent = isFabAutoNextEnabled() ? 'âœ“âœ“' : 'âœ“';

    // æ ¹æ®è´´è¾¹æ–¹å‘è°ƒæ•´èœå•å±•å¼€æ–¹å‘ï¼ˆè´´å·¦â†’å‘å³å±•å¼€ï¼›è´´å³â†’å‘å·¦å±•å¼€ï¼‰
    try {
        const rect = fab.getBoundingClientRect();
        const size = getFabSize();
        const centerX = rect.left + size / 2;
        const isLeft = centerX < (window.innerWidth / 2);
        menu.classList.toggle('edge-left', isLeft);
    } catch(e) {}

    // ç¡®ä¿èœå•å§‹ç»ˆè·Ÿéšæ‚¬æµ®çƒ
    try {
        const rect = fab.getBoundingClientRect();
        const pos = normalizeFabPos({ left: rect.left, top: rect.top });
        applyFabPos(pos.left, pos.top);
    } catch(e) {}
}

function toggleFab(open){
    fabOpen = typeof open === 'boolean' ? open : !fabOpen;
    updateFabUI();
}

async function toggleCurrentFavorite(){
    if (!LOGGED_IN) { showToast('è¯·å…ˆç™»å½•'); return; }
    const q = questions[currentIndex];
    const favBtn = q ? q.querySelector('.fav-btn') : null;
    if (favBtn && typeof favBtn.click === 'function') {
        favBtn.click();
        return;
    }
    showToast('æ”¶è—æŒ‰é’®ä¸å¯ç”¨');
}

async function openAIExplain(){
    if (!LOGGED_IN) { showToast('è¯·å…ˆç™»å½•'); return; }
    const q = questions[currentIndex];
    if (!q) return;
    const qid = q.getAttribute('data-id') || '';
    const qtype = q.getAttribute('data-type') || '';
    const contentEl = q.querySelector('.q-content');
    const content = contentEl ? (contentEl.innerText || '').trim() : '';

    let options = [];
    try {
        const optNodes = q.querySelectorAll('.option');
        if (optNodes && optNodes.length) {
            options = Array.from(optNodes).map(node => {
                const key = (node.querySelector('.opt-key') || {}).innerText || '';
                const val = (node.querySelector('.opt-text') || {}).innerText || node.innerText || '';
                return { key: key.trim(), value: val.trim() };
            });
        }
    } catch(e) {}

    try {
        const explainCard = document.getElementById('aiExplainCard') || document.getElementById('explainCard');
        if (explainCard) {
            explainCard.style.display = 'block';
            explainCard.innerHTML = `
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                    <div style="font-weight:800;">AI è§£æ</div>
                    <div style="font-size:12px; color:var(--text-sub);">ç”Ÿæˆä¸­â€¦</div>
                </div>
                <div style="margin-top:10px; color:var(--text-sub); font-size:14px; line-height:1.6;">è¯·ç¨å€™</div>
            `;
        }
    } catch(e) {}

    try {
        const res = await fetch('/api/ai/explain', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ question_id: qid ? Number(qid) : null, q_type: qtype, content, options })
        });
        const js = await res.json();
        if (!res.ok || !js || js.status !== 'success') {
            showToast(js.message || 'AI è§£æå¤±è´¥');
            return;
        }
        const explain = (js.data && js.data.explain) ? js.data.explain : '';
        const explainCard = document.getElementById('aiExplainCard') || document.getElementById('explainCard');
        if (explainCard) {
            explainCard.style.display = 'block';
            explainCard.innerHTML = `
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                    <div style="font-weight:800;">AI è§£æ</div>
                    <button class="btn" style="padding:6px 10px; font-size:12px;" id="aiExplainCopyBtn">å¤åˆ¶</button>
                </div>
                <pre style="margin:10px 0 0 0; white-space:pre-wrap; font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', Arial; font-size:14px; line-height:1.6; color:var(--text-color);">${escapeHtml(explain)}</pre>
            `;
            const btn = document.getElementById('aiExplainCopyBtn');
            if (btn) {
                btn.onclick = async function(){
                    try { await navigator.clipboard.writeText(explain || ''); showToast('å·²å¤åˆ¶'); }
                    catch(e) { showToast('å¤åˆ¶å¤±è´¥'); }
                };
            }
        }
    } catch(e) {
        showToast('AI è§£æå¤±è´¥');
    }
}

function bindFab(){
    const fab = document.getElementById('quizFab');
    const menu = document.getElementById('quizFabMenu');
    if (!fab || !menu) return;

    // åˆå§‹ä½ç½®ï¼ˆä¼˜å…ˆè¯»å–å·²ä¿å­˜çš„ä½ç½®ï¼‰
    const saved = loadFabPos();
    const initial = normalizeFabPos(saved || calcDefaultFabPos());
    applyFabPos(initial.left, initial.top);

    // æ‹–æ‹½ï¼ˆpointer eventsï¼‰
    let dragging = false;
    let moved = false;
    let startX = 0;
    let startY = 0;
    let startLeft = 0;
    let startTop = 0;

    fab.addEventListener('pointerdown', (e)=>{
        dragging = true;
        moved = false;
        startX = e.clientX;
        startY = e.clientY;
        const rect = fab.getBoundingClientRect();
        startLeft = rect.left;
        startTop = rect.top;

        // æ‹–åŠ¨æ—¶å…³é—­èœå•
        if (fabOpen) toggleFab(false);

        try { fab.setPointerCapture(e.pointerId); } catch(err) {}
    });

    fab.addEventListener('pointermove', (e)=>{
        if (!dragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        if (Math.abs(dx) + Math.abs(dy) > 6) moved = true;
        const next = normalizeFabPos({ left: startLeft + dx, top: startTop + dy });
        applyFabPos(next.left, next.top);
    });

    const endDrag = (e)=>{
        if (!dragging) return;
        dragging = false;
        const rect = fab.getBoundingClientRect();
        let next = normalizeFabPos({ left: rect.left, top: rect.top });

        // è‡ªåŠ¨å¸è¾¹ï¼ˆå·¦å³è´´è¾¹ï¼‰+ å¹³æ»‘åŠ¨ç”»ï¼ˆä»…å¸é™„æ—¶ç”Ÿæ•ˆï¼‰
        const size = getFabSize();
        const margin = 8;
        const maxLeft = window.innerWidth - size - margin;
        const snapLeft = margin;
        const snapRight = Math.max(margin, maxLeft);
        const centerX = next.left + size / 2;
        next.left = (centerX < window.innerWidth / 2) ? snapLeft : snapRight;

        // åªåœ¨å¸é™„æ—¶å¼€å¯ transitionï¼Œé¿å…æ‹–åŠ¨è¿‡ç¨‹æœ‰å»¶è¿Ÿ
        try {
            fab.style.transition = 'left .16s ease, top .16s ease, transform .22s ease, box-shadow .22s ease, background-color .22s ease';
            const menu = document.getElementById('quizFabMenu');
            if (menu) menu.style.transition = 'left .16s ease, top .16s ease';
        } catch(e) {}

        applyFabPos(next.left, next.top);
        saveFabPos(next.left, next.top);

        // åŠ¨ç”»ç»“æŸåæ¢å¤é»˜è®¤ï¼ˆé˜²æ­¢æ‹–åŠ¨æ—¶â€œç²˜æ»â€ï¼‰
        setTimeout(()=>{
            try {
                fab.style.transition = '';
                const menu = document.getElementById('quizFabMenu');
                if (menu) menu.style.transition = '';
            } catch(e) {}
        }, 220);

        // å¦‚æœæ˜¯æ‹–åŠ¨å¯¼è‡´çš„ pointerupï¼Œé˜»æ­¢éšå click æ‰“å¼€èœå•
        if (moved) {
            fab._suppressClickOnce = true;
            setTimeout(()=>{ fab._suppressClickOnce = false; }, 0);
        }

        try { fab.releasePointerCapture(e.pointerId); } catch(err) {}
    };

    fab.addEventListener('pointerup', endDrag);
    fab.addEventListener('pointercancel', endDrag);

    // ç‚¹å‡»æ‰“å¼€/å…³é—­èœå•
    fab.addEventListener('click', (e)=>{
        if (fab._suppressClickOnce) return;
        e.preventDefault();
        e.stopPropagation();
        toggleFab();
    });

    // èœå•æŒ‰é’®
    menu.querySelectorAll('.quiz-fab-item').forEach(btn => {
        btn.addEventListener('click', async (e)=>{
            e.preventDefault();
            e.stopPropagation();
            const action = btn.dataset.action;
            if (!action) return;

            if (action === 'autoNext') {
                // è€ƒè¯•å›é¡¾ï¼ˆå·²äº¤å·ï¼‰ç¦ç”¨
                if (mode === 'exam' && EXAM_SUBMITTED) {
                    showToast('å›é¡¾æ¨¡å¼ï¼šè¯¥åŠŸèƒ½ä¸å¯ç”¨');
                    toggleFab(false);
                    return;
                }
                const next = !isFabAutoNextEnabled();
                setFabAutoNextEnabled(next);
                updateFabUI();
                showToast(next ? 'å·²å¼€å¯ï¼šç­”å¯¹è‡ªåŠ¨åˆ‡é¢˜' : 'å·²å…³é—­ï¼šç­”å¯¹è‡ªåŠ¨åˆ‡é¢˜');
                return;
            }

            if (action === 'aiExplain') {
                // å†æ¬¡ç‚¹å‡»ï¼šå…³é—­ AI è§£æï¼ˆä½œä¸ºä¸€ä¸ª toggleï¼‰
                const explainCard = document.getElementById('aiExplainCard') || document.getElementById('explainCard');
                const isOpen = !!(explainCard && explainCard.style.display !== 'none');
                if (isOpen) {
                    // åªå…³é—­ AI è§£æï¼Œä¸å½±å“é¢˜ç›®è‡ªèº«â€œè§£æ/ç­”æ¡ˆâ€dock
                    try { explainCard.style.display = 'none'; explainCard.innerHTML = ''; explainCard.classList.remove('show'); } catch(e) {}
                    // å¦‚æœå³ä¾§/ä¸‹æ–¹ dock éœ€è¦æ ¹æ®ç©ºçŠ¶æ€è‡ªé€‚åº”ï¼Œè¿™é‡Œé¡ºä¾¿åˆ·æ–°
                    try { updateDockEmptyState(); } catch(e) {}
                } else {
                    await openAIExplain();
                }
                toggleFab(false);
                return;
            }

            if (action === 'bookmark') {
                await toggleCurrentFavorite();
                toggleFab(false);
                return;
            }

            if (action === 'focus') {
                document.body.classList.toggle('quiz-focus-mode');
                showToast(document.body.classList.contains('quiz-focus-mode') ? 'å·²å¼€å¯ä¸“æ³¨æ¨¡å¼' : 'å·²é€€å‡ºä¸“æ³¨æ¨¡å¼');
                toggleFab(false);
                return;
            }

            if (action === 'clearCurrent') {
                const q = questions[currentIndex];
                if (!q) { showToast('æœªæ‰¾åˆ°å½“å‰é¢˜ç›®'); toggleFab(false); return; }

                const type = q.getAttribute('data-type') || '';

                // è€ƒè¯•å›é¡¾ï¼ˆå·²äº¤å·ï¼‰ç¦ç”¨
                if (mode === 'exam' && EXAM_SUBMITTED) {
                    showToast('å›é¡¾æ¨¡å¼ï¼šæ— æ³•æ¸…é™¤æœ¬é¢˜');
                    toggleFab(false);
                    return;
                }
                // è€ƒè¯•è¿›è¡Œä¸­ï¼šä¹Ÿä¸å…è®¸æ¸…é™¤ï¼ˆé¿å…å½±å“è€ƒè¯•ä½œç­”æµç¨‹ï¼‰
                if (mode === 'exam' && isSubmitted) {
                    showToast('è€ƒè¯•ä¸­ï¼šæ— æ³•æ¸…é™¤æœ¬é¢˜');
                    toggleFab(false);
                    return;
                }

                // 1) æ¸…é™¤è¾“å…¥
                try {
                    if (type === 'é€‰æ‹©é¢˜' || type === 'åˆ¤æ–­é¢˜' || type === 'å¤šé€‰é¢˜') {
                        q.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(inp => {
                            inp.checked = false;
                            const lab = inp.closest('label');
                            if (lab) lab.classList.remove('selected');
                        });
                    } else if (type === 'å¡«ç©ºé¢˜') {
                        q.querySelectorAll('.main-input').forEach(inp => {
                            inp.value = '';
                            inp.classList.remove('input-correct', 'input-wrong');
                        });
                    } else if (type === 'é—®ç­”é¢˜') {
                        const ta = q.querySelector('textarea');
                        if (ta) ta.value = '';
                    } else if (type === 'è®¡ç®—é¢˜') {
                        // è®¡ç®—é¢˜å¦‚æœä¹Ÿæ˜¯ textarea/è¾“å…¥æ¡†ï¼Œå°½é‡æ¸…ç©º
                        const ta = q.querySelector('textarea');
                        if (ta) ta.value = '';
                        q.querySelectorAll('input[type="text"], .main-input').forEach(inp => { inp.value = ''; });
                    }
                } catch(e) {}

                // 2) æ¢å¤å¯ç¼–è¾‘çŠ¶æ€ï¼ˆè‹¥ä¹‹å‰å·²åˆ¤é¢˜/ç¦ç”¨ï¼‰
                try {
                    q.classList.remove('checked-mode');
                    q.querySelectorAll('input, textarea').forEach(el => {
                        el.disabled = false;
                    });
                    // ç§»é™¤é€‰é¡¹/è¾“å…¥é«˜äº®
                    q.querySelectorAll('.correct-opt, .wrong-opt, .input-correct, .input-wrong').forEach(el => {
                        el.classList.remove('correct-opt', 'wrong-opt', 'input-correct', 'input-wrong');
                    });
                } catch(e) {}

                // 3) æ¸…é™¤ä¾§è¾¹æ è¯¥é¢˜çŠ¶æ€
                try {
                    const idx = q.getAttribute('data-index');
                    const li = document.getElementById(`list-item-${idx !== null ? idx : currentIndex}`);
                    if (li) li.classList.remove('done-correct', 'done-wrong', 'answered');
                } catch(e) {}

                // 4) æ¸…æ‰ dockï¼ˆç­”æ¡ˆ/è§£æ/AIï¼‰å’Œå¾½æ ‡
                try { hideAnswerExplainDock(); } catch(e) {}

                // 5) æ¢å¤åº•éƒ¨æŒ‰é’®æ˜¾ç¤ºé€»è¾‘ï¼ˆå°½é‡ä¸ showQuestion çš„è§„åˆ™ä¸€è‡´ï¼‰
                try {
                    if (mode !== 'exam') {
                        const btnCheck = document.getElementById('btn-check');
                        const btnNext = document.getElementById('btn-next');
                        const isAutoTypes = (type === 'é€‰æ‹©é¢˜' || type === 'åˆ¤æ–­é¢˜');
                        if (btnCheck) btnCheck.style.display = isAutoTypes ? 'none' : 'block';
                        if (btnNext) btnNext.style.display = isAutoTypes ? 'block' : 'none';
                    }
                } catch(e) {}

                // 6) ä¿å­˜è¿›åº¦ï¼ˆä¼šå†™æœ¬åœ°/ç™»å½•åˆ™åŒæ­¥ï¼‰
                try {
                    if (mode !== 'exam' || (mode === 'exam' && !isSubmitted)) {
                        saveState(true);
                    }
                } catch(e) {}

                // 7) é‡æ–°è®¡ç®—â€œå·²ç­”â€æ ‡è®°ï¼ˆè€ƒè¯•æ¨¡å¼ä¾§è¾¹æ ï¼‰
                try {
                    if (mode === 'exam') markAnswered(currentIndex);
                } catch(e) {}

                showToast('å·²æ¸…é™¤æœ¬é¢˜è¿›åº¦');
                toggleFab(false);
                return;
            }
        });
    });

    document.addEventListener('click', ()=>{ if (fabOpen) toggleFab(false); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && fabOpen) toggleFab(false); });

    // resize æ—¶ä¿è¯æ‚¬æµ®çƒä¸å‡ºç•Œ + ä¿æŒå¸è¾¹
    window.addEventListener('resize', ()=>{
        const cur = loadFabPos() || calcDefaultFabPos();
        let n = normalizeFabPos(cur);
        const size = getFabSize();
        const margin = 8;
        const maxLeft = window.innerWidth - size - margin;
        // è‹¥å½“å‰æ›´é å·¦/å³ï¼Œåˆ™å¸é™„åˆ°å¯¹åº”è¾¹
        const centerX = n.left + size / 2;
        n.left = (centerX < window.innerWidth / 2) ? margin : Math.max(margin, maxLeft);
        applyFabPos(n.left, n.top);
        saveFabPos(n.left, n.top);
    });

    updateFabUI();
}

async function init() {
    if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

    // æ‚¬æµ®çƒå¼€å…³ï¼šé¢˜åº“è®¾ç½®é¡µå¯å…³é—­/å¼€å¯ã€‚
    // è§„åˆ™ï¼š
    // - ç”¨æˆ·å…³é—­ï¼šä»»ä½•æ¨¡å¼éƒ½ä¸æ˜¾ç¤º
    // - è€ƒè¯•è¿›è¡Œä¸­ï¼šè‡ªåŠ¨éšè—ï¼ˆæ— è§†å¼€å…³ï¼‰
    // - è€ƒè¯•å›é¡¾ï¼ˆå·²äº¤å·ï¼‰ï¼šå…è®¸æ˜¾ç¤ºï¼ˆå‰ææ˜¯ç”¨æˆ·æ²¡å…³é—­ï¼‰
    const shouldShowFab = isFabEnabled() && (mode !== 'exam' || (mode === 'exam' && EXAM_SUBMITTED));
    if (shouldShowFab) {
        bindFab();
    } else {
        try {
            const fab = document.getElementById('quizFab');
            const menu = document.getElementById('quizFabMenu');
            if (fab) fab.style.display = 'none';
            if (menu) menu.style.display = 'none';
        } catch(e) {}
    }
    // è¿›åº¦åŠ è½½ï¼šè€ƒè¯•æ¨¡å¼ï¼ˆæœªäº¤å·ï¼‰ä¹Ÿå¯ç”¨ï¼Œä¸åˆ·é¢˜/èƒŒé¢˜ä¸€è‡´ï¼ˆlocalStorage + /api/progressï¼‰
    if (mode !== 'exam' || (mode === 'exam' && !EXAM_SUBMITTED)) {
        await preloadProgress();
    }
    
    // å¦‚æœæ˜¯ä¹±åºæ¨¡å¼ä¸” cachedOrder è¿˜æ²¡æœ‰è¢«è®¾ç½®ï¼Œä»å½“å‰ DOM ä¸­æ”¶é›†é¢˜ç›®é¡ºåº
    // è¿™ç¡®ä¿äº†å³ä½¿æœåŠ¡å™¨è·å–å¤±è´¥ï¼Œä¹Ÿèƒ½æ­£ç¡®ä¿å­˜é¡ºåº
    const params = new URLSearchParams(window.location.search);
    const isShuffleMode = params.get('shuffle_questions') === '1';
    if (isShuffleMode && !cachedOrder && questions.length > 0) {
        cachedOrder = Array.from(questions).map(q => parseInt(q.getAttribute('data-id')));
        console.log('[è¿›åº¦åˆå§‹åŒ–] ä» DOM æ”¶é›†é¢˜ç›®é¡ºåº:', cachedOrder.length, 'é¢˜');
    }

    if (mode === 'exam') {
        if (EXAM_SUBMITTED) {
            isSubmitted = true;
            // å›é¡¾æ¨¡å¼ï¼šé¢„å¡«ç­”æ¡ˆå¹¶å±•ç¤ºè§£æ
            applyReviewFromServer();
            const btnSubmit = document.getElementById('btn-submit-exam');
            if (btnSubmit) btnSubmit.style.display = 'none';
            const timerEl = document.getElementById('timer');
            if (timerEl) timerEl.style.display = 'none';
            const btnNext = document.getElementById('btn-next-exam');
            if (btnNext) btnNext.style.display = 'block';
        } else {
            // è¿›è¡Œä¸­è€ƒè¯•ï¼šæ¢å¤æœåŠ¡å™¨è‰ç¨¿å¹¶å¯åŠ¨è‡ªåŠ¨ä¿å­˜
            // æ³¨æ„ï¼špreloadProgress()/loadState() å·²ç»å…ˆæ‰§è¡Œè¿‡ï¼Œä¼šæ¢å¤ currentIndex/æœ¬åœ°ç­”é¢˜è¾“å…¥ã€‚
            // è¿™é‡Œå†ç”¨æœåŠ¡ç«¯è‰ç¨¿è¡¥é½ï¼ˆè‹¥æœ¬åœ°ä¸ºç©ºï¼‰ï¼Œä½†ä¸è¦†ç›–æœ¬åœ°å·²è¾“å…¥çš„å†…å®¹ã€‚
            applyDraftFromServer();
            startTimer();
            const btnNext = document.getElementById('btn-next-exam');
            if (btnNext) btnNext.style.display = 'block';
            scheduleAutoSave();
        }
    }

    showQuestion(currentIndex);
}

async function preloadProgress(){
    const key = progressKey();
    console.log('[è¿›åº¦åŠ è½½] å½“å‰æ¨¡å¼:', mode, 'è¿›åº¦é”®:', key);

    // ç™»å½•ç”¨æˆ·ä¼˜å…ˆä»æœåŠ¡å™¨æ‹‰å–è¿›åº¦
    if (LOGGED_IN) {
        try {
            const encodedKey = encodeURIComponent(key);
            console.log('[è¿›åº¦åŠ è½½] ä»æœåŠ¡å™¨è·å–è¿›åº¦...');
            const res = await fetch(`/api/progress?key=${encodedKey}`);
            if (res.ok) {
                const js = await res.json();
                console.log('[è¿›åº¦åŠ è½½] æœåŠ¡å™¨å“åº”:', js.status, js.data ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®');
                if (js.status === 'success' && js.data) {
                    // æ¯”è¾ƒæ—¶é—´æˆ³,ä½¿ç”¨æœ€æ–°çš„è¿›åº¦
                    const serverData = js.data;
                    const localDataStr = localStorage.getItem(key);

                    // ç¼“å­˜æœåŠ¡å™¨çš„é¢˜ç›®é¡ºåºï¼ˆå¦‚æœæœ‰ï¼‰
                    if (serverData.order && Array.isArray(serverData.order)) {
                        cachedOrder = serverData.order;
                    }

                    if (localDataStr) {
                        try {
                            const localData = JSON.parse(localDataStr);
                            const serverTime = serverData.timestamp || 0;
                            const localTime = localData.timestamp || 0;

                            // ä½¿ç”¨æ—¶é—´æˆ³è¾ƒæ–°çš„æ•°æ®ï¼Œä½†å§‹ç»ˆä¿ç•™orderå­—æ®µ
                            if (serverTime > localTime) {
                                localStorage.setItem(key, JSON.stringify(serverData));
                                console.log('[è¿›åº¦åŠ è½½] ä½¿ç”¨æœåŠ¡å™¨è¿›åº¦(æ›´æ–°)');
                            } else {
                                console.log('[è¿›åº¦åŠ è½½] ä½¿ç”¨æœ¬åœ°è¿›åº¦(æ›´æ–°)');
                                // æœ¬åœ°æ›´æ–°,åŒæ­¥åˆ°æœåŠ¡å™¨ï¼Œä½†ä¿ç•™æœåŠ¡å™¨çš„order
                                if (localTime > serverTime) {
                                    // åˆå¹¶ï¼šä¿ç•™æœåŠ¡å™¨çš„orderåˆ°æœ¬åœ°æ•°æ®
                                    if (cachedOrder && !localData.order) {
                                        localData.order = cachedOrder;
                                        localStorage.setItem(key, JSON.stringify(localData));
                                    }
                                    syncToServer(localData);
                                }
                            }
                        } catch(e) {
                            // è§£æå¤±è´¥,ä½¿ç”¨æœåŠ¡å™¨æ•°æ®
                            localStorage.setItem(key, JSON.stringify(serverData));
                        }
                    } else {
                        // æœ¬åœ°æ— æ•°æ®,ä½¿ç”¨æœåŠ¡å™¨æ•°æ®
                        localStorage.setItem(key, JSON.stringify(serverData));
                        console.log('[è¿›åº¦åŠ è½½] ä»æœåŠ¡å™¨åŠ è½½è¿›åº¦');
                    }
                } else {
                    console.log('[è¿›åº¦åŠ è½½] æœåŠ¡å™¨æ— è¿›åº¦æ•°æ®');
                }
            }
        } catch(e) {
            console.error('[è¿›åº¦åŠ è½½] åŠ è½½æœåŠ¡å™¨è¿›åº¦å¤±è´¥:', e);
        }
    }
    loadState();
}

function startTimer() {
    const timerEl = document.getElementById('timer');
    timerInterval = setInterval(() => {
        timerSeconds--;
        if (timerSeconds <= 0) {
            clearInterval(timerInterval);
            alert('è€ƒè¯•æ—¶é—´åˆ°ï¼ç³»ç»Ÿå°†è‡ªåŠ¨äº¤å·ã€‚');
            submitExam(true); 
            return;
        }
        const h = Math.floor(timerSeconds / 3600).toString().padStart(2,'0');
        const m = Math.floor((timerSeconds % 3600) / 60).toString().padStart(2,'0');
        const s = (timerSeconds % 60).toString().padStart(2,'0');
        timerEl.innerText = `${h}:${m}:${s}`;
    }, 1000);
}

function markAnswered(index) {
    // è€ƒè¯•æ¨¡å¼ï¼šé¢˜ç›®åˆ—è¡¨æ ‡æ³¨â€œå·²ç­”/æœªç­”â€
    // å…¼å®¹ï¼šä¸è¦å¼ºä¾èµ–é¢˜ç›®å®¹å™¨ id = q-{index}ï¼ˆå¯èƒ½è¢«é‡æ’/åˆ†é¡µå¯¼è‡´ä¸ä¸€è‡´ï¼‰
    try {
        // 1) ä¼˜å…ˆä»äº‹ä»¶æº input åæŸ¥æ‰€å±é¢˜ç›®ï¼ˆæœ€ç¨³ï¼‰
        let q = null;
        const ev = (typeof window !== 'undefined') ? window.event : null;
        const target = ev && ev.target ? ev.target : null;
        if (target && target.closest) {
            q = target.closest('.question-box');
        }

        // 2) å›é€€ï¼šæŒ‰æ—§é€»è¾‘é€šè¿‡ id æŸ¥æ‰¾
        if (!q) q = document.getElementById(`q-${index}`);
        if (!q) return;

        // 3) ä»¥é¢˜ç›® DOM è‡ªå¸¦ data-index ä¸ºå‡†ï¼ˆè‹¥ä¸å­˜åœ¨åˆ™ç”¨å…¥å‚ indexï¼‰
        const realIndexStr = q.getAttribute('data-index');
        const realIndex = (realIndexStr !== null && realIndexStr !== '') ? Number(realIndexStr) : index;

        const item = document.getElementById(`list-item-${realIndex}`);
        if (!item) return;

        const type = q.getAttribute('data-type');
        if (hasAnswered(q, type)) {
            item.classList.add('answered');
        } else {
            item.classList.remove('answered');
        }
    } catch(e) {
        // å…œåº•ï¼šä¸è¦æŠ›é”™å½±å“è€ƒè¯•æµç¨‹
        try {
            const item = document.getElementById(`list-item-${index}`);
            if (item) item.classList.add('answered');
        } catch(_) {}
    }
}

function toggleWholeView() {
    isWholeView = !isWholeView;
    const container = document.getElementById('mainCard');
    const btn = document.getElementById('btn-whole-view');
    
    if (isWholeView) {
        container.classList.add('whole-view');
        btn.innerText = "â†© è¿”å›å•é¢˜";
        window.scrollTo(0, 0); // æ»šå›é¡¶éƒ¨
        
        if(mode === 'exam' && !isSubmitted) { // åªæœ‰æ²¡äº¤å·æ—¶æ‰æ˜¾ç¤ºäº¤å·æŒ‰é’®
            let tempSubmit = document.getElementById('temp-submit');
            if(!tempSubmit) {
                tempSubmit = document.createElement('button');
                tempSubmit.id = 'temp-submit';
                tempSubmit.className = 'btn btn-submit';
                tempSubmit.style.display = 'block';
                tempSubmit.style.margin = '20px auto';
                tempSubmit.innerText = 'ğŸ“¤ äº¤å·';
                tempSubmit.onclick = () => submitExam();
                container.appendChild(tempSubmit);
            } else {
                tempSubmit.style.display = 'block';
            }
        }
    } else {
        container.classList.remove('whole-view');
        btn.innerText = "æ•´å·é¢„è§ˆ";
        const tempSubmit = document.getElementById('temp-submit');
        if(tempSubmit) tempSubmit.style.display = 'none';
        showQuestion(currentIndex);
    }
}

function jumpTo(index) {
    if (isWholeView) {
        const el = document.getElementById('q-' + index);
        if(el) {
            el.scrollIntoView({behavior: 'smooth', block: 'center'});
            el.style.transition = 'background 0.3s';
            el.style.background = 'rgba(0,123,255,0.1)';
            setTimeout(() => el.style.background = 'transparent', 500);
        }
    } else {
        showQuestion(index);
    }
    toggleSidebar(); 
}

function showQuestion(index) {
    if (isWholeView) return; 

    questions.forEach(q => q.classList.remove('active'));
    questions[index].classList.add('active');
    
    listItems.forEach(item => item.classList.remove('active'));
    if(listItems[index]) {
        listItems[index].classList.add('active');
        listItems[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // å…ˆæ›´æ–°å½“å‰ç´¢å¼•ï¼Œé¿å…å›é¡¾æ¨¡å¼ä¸‹æ— æ³•ç¿»é¡µ
    currentIndex = index;

    const currentQ = questions[index];
    const type = currentQ.getAttribute('data-type');
    const answer = currentQ.getAttribute('data-answer');

    // ä»…é—®ç­”é¢˜/è®¡ç®—é¢˜ï¼šæŠŠç­”æ¡ˆ/è§£æ dock æ”¾åˆ°ä¸»å¡å³ä¾§ï¼ˆæ¡Œé¢ç«¯ï¼‰ã€‚
    // å…¶å®ƒé¢˜å‹ä¿æŒåŸå¸ƒå±€ï¼ˆdock åœ¨ä¸»å¡ä¸‹æ–¹ï¼‰ã€‚
    const mainArea = document.querySelector('.main-area');
    if (mainArea) {
        const isRightDockTypes = (type === 'é—®ç­”é¢˜' || type === 'è®¡ç®—é¢˜');
        mainArea.classList.toggle('with-right-dock', isRightDockTypes);
        // åˆå§‹å¸ƒå±€ï¼šåœ¨ç­”æ¡ˆ/è§£æè¿˜æ²¡å±•ç¤ºå‰ï¼Œè®©ä¸»å¡ç‰‡å±…ä¸­
        updateDockEmptyState();
    }

    // ç­”æ¡ˆ/è§£ææ¸²æŸ“ï¼šç”± renderAnswerExplainFromQuestion æ§åˆ¶
    setupImageGallery(currentQ);

    // è‡ªåŠ¨èšç„¦å¡«ç©ºé¢˜/é—®ç­”é¢˜è¾“å…¥æ¡†
    const qType = currentQ.getAttribute('data-type');
    if (qType === 'å¡«ç©ºé¢˜' || qType === 'é—®ç­”é¢˜') {
        const inputField = currentQ.querySelector('.main-input, textarea');
        if (inputField && !inputField.disabled) {
            // åŠ¨ç”»ç»“æŸåèšç„¦ï¼Œä»¥ç¡®ä¿å…ƒç´ å¯è§
            setTimeout(() => inputField.focus(), 400); 
        }
    }

    const btnPrev = document.getElementById('btn-prev');
    btnPrev.disabled = (index === 0);

    if (mode === 'exam') {
        const btnNextExam = document.getElementById('btn-next-exam');
        const btnSubmitExam = document.getElementById('btn-submit-exam');
        
        // å¦‚æœå·²äº¤å·ï¼šå›é¡¾æ¨¡å¼ï¼ˆæ˜¾ç¤ºç­”æ¡ˆ/è§£æï¼Œç¦ç”¨ä½œç­”ï¼‰ï¼ŒåŒæ—¶æ›´æ–°è¿›åº¦æ¡
        if (isSubmitted) {
            renderAnswerExplainFromQuestion(currentQ);

            if (btnNextExam) {
                btnNextExam.style.display = (index === totalQuestions - 1) ? 'none' : 'block';
            }
            if (btnSubmitExam) btnSubmitExam.style.display = 'none';

            // å›é¡¾æ—¶çš„ç»“æœå¾½æ ‡ï¼šé—®ç­”é¢˜/è®¡ç®—é¢˜ä¸åˆ¤å¯¹é”™ï¼Œæ˜¾ç¤ºâ€œå¾…æ ¸å¯¹â€
            if (type === 'é—®ç­”é¢˜' || type === 'è®¡ç®—é¢˜') {
                setAnswerResultBadge('pending');
            } else {
                // å…¶å®ƒé¢˜å‹æ­£å¸¸åˆ¤å¯¹é”™ï¼ˆè‹¥æ— æ³•åˆ¤æ–­åˆ™ä¸æ˜¾ç¤ºï¼‰
                try {
                    const inferredCorrect = judgeQuestion(currentQ, type, answer);
                    setAnswerResultBadge(inferredCorrect);
                } catch(e) {
                    setAnswerResultBadge(null);
                }
            }

            const plabel = document.getElementById('progress-label');
            if (plabel) plabel.innerText = `${currentIndex + 1} / ${totalQuestions}`;
            const pf = document.getElementById('progress-fill');
            if (pf) pf.style.width = ((currentIndex + 1) / totalQuestions * 100) + '%';
            return;
        }

        if (index === totalQuestions - 1) {
            btnNextExam.style.display = 'none';
            btnSubmitExam.style.display = 'block';
        } else {
            btnNextExam.style.display = 'block';
            btnSubmitExam.style.display = 'none';
        }
    } else {
        const btnCheck = document.getElementById('btn-check');
        const btnNext = document.getElementById('btn-next');
        
        if (mode === 'memo') {
            renderAnswerExplainFromQuestion(currentQ);
            btnCheck.style.display = 'none';
            btnNext.style.display = 'block';
            fillAnswer(currentQ, type, answer);
            disableInputs(currentQ); 
        } else {
            // æ–¹æ¡ˆAï¼šé€‰æ‹©é¢˜/åˆ¤æ–­é¢˜ä¸æ˜¾ç¤ºâ€œæŸ¥çœ‹ç»“æœâ€ï¼ˆä¼šè‡ªåŠ¨å‡ºç»“æœï¼‰
            const isAutoTypes = (type === 'é€‰æ‹©é¢˜' || type === 'åˆ¤æ–­é¢˜');

            // é»˜è®¤ï¼šåˆ‡é¢˜å…ˆéšè—ï¼›è‹¥è¯¥é¢˜å·²åšè¿‡ï¼ˆæ­£ç¡®/é”™è¯¯ï¼‰ï¼Œè‡ªåŠ¨å±•ç¤ºç­”æ¡ˆ/è§£æï¼ˆä½ é€‰çš„ B æ–¹æ¡ˆï¼‰
            hideAnswerExplainDock();
            const li = listItems[index];
            const hasResult = li && (li.classList.contains('done-correct') || li.classList.contains('done-wrong'));
            if (hasResult) {
                renderAnswerExplainFromQuestion(currentQ);
                // æ ¹æ®ä¾§è¾¹æ çŠ¶æ€æ¨æ–­å¯¹é”™ï¼Œæ˜¾ç¤ºå¾½æ ‡
                const inferredCorrect = li.classList.contains('done-correct') ? true : (li.classList.contains('done-wrong') ? false : null);
                setAnswerResultBadge(inferredCorrect);
                btnCheck.style.display = 'none';
                btnNext.style.display = 'block';
            } else {
                btnCheck.style.display = isAutoTypes ? 'none' : 'block';
                btnNext.style.display = isAutoTypes ? 'block' : 'none';
            }

            if (index === totalQuestions - 1) {
                btnNext.innerText = "å®Œæˆåˆ·é¢˜";
                btnNext.classList.remove('btn-next-green');
                btnNext.style.backgroundColor = '#6610f2';
                btnNext.onclick = finishQuiz;
            } else {
                btnNext.innerText = "ä¸‹ä¸€é¢˜ â†’";
                btnNext.classList.add('btn-next-green');
                btnNext.style.backgroundColor = '';
                btnNext.onclick = nextQuestion;
            }
        }
    }

    currentIndex = index;
    const plabel = document.getElementById('progress-label');
    if (plabel) plabel.innerText = `${currentIndex + 1} / ${totalQuestions}`;
    document.getElementById('progress-fill').style.width = ((currentIndex + 1) / totalQuestions * 100) + '%';
    
    // ä¿å­˜è¿›åº¦ï¼šè€ƒè¯•æ¨¡å¼ï¼ˆæœªäº¤å·ï¼‰ä¹Ÿä¿å­˜ï¼Œå·²äº¤å·ä¸å†å†™è¿›åº¦
    if (mode !== 'exam' || (mode === 'exam' && !isSubmitted)) saveState();
}

function fillAnswer(q, type, answer) {
    if (type === 'é€‰æ‹©é¢˜' || type === 'åˆ¤æ–­é¢˜' || type === 'å¤šé€‰é¢˜') {
        q.querySelectorAll('input').forEach(input => {
            const label = input.parentElement;
            label.classList.remove('correct-opt');
            // For choice questions, the value is the key ('A', 'B', etc.)
            // For judgment questions, the value is 'æ­£ç¡®' or 'é”™è¯¯'
            if (answer.includes(input.value)) {
                label.classList.add('correct-opt');
                input.checked = true;
            }
        });
    } else if (type === 'å¡«ç©ºé¢˜') {
        const inputs = q.querySelectorAll('.main-input');
        const correctBlanks = answer.split(';;').map(a => a.trim());

        inputs.forEach((input, i) => {
            // é»˜è®¤å¡«å……æ¯ä¸ªç©ºçš„ç¬¬ä¸€ä¸ªæ­£ç¡®ç­”æ¡ˆ
            const firstCorrectAnswer = (correctBlanks[i] || '').split(';')[0].trim();
            input.value = firstCorrectAnswer;
            input.classList.add('input-correct');
        });
    }
}

function disableInputs(q) {
    q.classList.add('checked-mode');
    q.querySelectorAll('input, textarea').forEach(el => el.disabled = true);
}

function autoCheck() {
    // æ–¹æ¡ˆAï¼šé€‰æ‹©é¢˜/åˆ¤æ–­é¢˜è‡ªåŠ¨å‡ºç»“æœï¼›å¤šé€‰é¢˜/å¡«ç©º/é—®ç­”ä¿ç•™"æŸ¥çœ‹ç»“æœ"æŒ‰é’®
    const currentQ = questions[currentIndex];
    if (!currentQ) return;
    const type = currentQ.getAttribute('data-type');
    if (type === 'é€‰æ‹©é¢˜' || type === 'åˆ¤æ–­é¢˜') {
        checkAnswer(false);
    }
    // å¤šé€‰é¢˜ä¸è‡ªåŠ¨æ£€æŸ¥ï¼Œéœ€è¦ç”¨æˆ·ç‚¹å‡»"æŸ¥çœ‹ç»“æœ"æŒ‰é’®
}

// åˆ¤æ–­é¢˜ï¼šéšè—åŸç”Ÿ radio åï¼Œç”¨æ•´è¡Œé«˜äº®æ¥è¡¨ç°é€‰ä¸­æ€
document.addEventListener('change', function(e){
    const t = e.target;
    if (!(t instanceof HTMLInputElement)) return;

    // åˆ¤æ–­é¢˜ï¼ˆradioï¼‰ï¼šä»…å¤„ç†åˆ¤æ–­é¢˜å®¹å™¨
    if (t.type === 'radio') {
        const wrap = t.closest('.tf-options');
        if (!wrap) return;
        const name = t.name;
        wrap.querySelectorAll(`input[type="radio"][name="${CSS.escape(name)}"]`).forEach(r => {
            const lab = r.closest('label');
            if (lab) lab.classList.toggle('selected', r.checked);
        });
        return;
    }

    // é€‰æ‹©é¢˜ï¼ˆcheckboxï¼‰ï¼šç»Ÿä¸€æˆåˆ¤æ–­é¢˜åŒæ¬¾â€œæ•´è¡Œé«˜äº® + å·¦ä¾§æ ‡è®°â€
    if (t.type === 'checkbox') {
        const wrap = t.closest('.options');
        if (!wrap) return;
        if (wrap.classList.contains('tf-options')) return;
        const lab = t.closest('label');
        if (lab) lab.classList.toggle('selected', t.checked);
        return;
    }
});

// æ›´æ–°ç­”æ¡ˆå¡ç‰‡å³ä¾§å¾½æ ‡ï¼ˆç­”å¯¹/ç­”é”™ï¼‰
function setAnswerResultBadge(state) {
    // state: true(ç­”å¯¹) / false(ç­”é”™) / 'pending'(å¾…æ ¸å¯¹) / null(éšè—)
    const host = document.getElementById('answerCard');
    if (!host) return;

    const isCorrect = (state === true);
    const isWrong = (state === false);
    const isPending = (state === 'pending');

    host.classList.toggle('result-correct', isCorrect);
    host.classList.toggle('result-wrong', isWrong);
    host.classList.toggle('result-pending', isPending);

    const badge = host.querySelector('.result-badge');
    if (!badge) return;

    if (isCorrect) {
        badge.textContent = 'ç­”å¯¹';
        badge.setAttribute('data-state', 'correct');
    } else if (isWrong) {
        badge.textContent = 'ç­”é”™';
        badge.setAttribute('data-state', 'wrong');
    } else if (isPending) {
        badge.textContent = 'å¾…æ ¸å¯¹';
        badge.setAttribute('data-state', 'pending');
    } else {
        badge.textContent = '';
        badge.setAttribute('data-state', '');
    }
}

// å°†â€œå½“å‰é¢˜â€çš„ç­”æ¡ˆ/è§£æå†…å®¹æ¸²æŸ“åˆ° mainCard å¤–éƒ¨çš„ç‹¬ç«‹å¡ç‰‡å®¹å™¨
function formatFillBlankAnswerForDock(raw, blankCountHint) {
    // raw æ ¼å¼çº¦å®šï¼ˆå†å²å…¼å®¹ï¼‰ï¼š
    // - å¤šç©ºï¼šç”¨ ';;' åˆ†éš”æ¯ä¸€ç©º
    // - ä¸€ç©ºå¤šç­”æ¡ˆï¼šåŒä¸€ç©ºå†…ç”¨ ';' åˆ†éš”å¤‡é€‰
    // ç¤ºä¾‹ï¼š"1;ä¸€;;2;äºŒ;;3;ä¸‰" => 3 ç©ºï¼Œæ¯ç©ºæœ‰ 2 ä¸ªå¤‡é€‰
    const text = (raw || '').toString().trim();
    if (!text) return '';

    const blanks = text.split(';;').map(s => s.trim()).filter(Boolean);
    const isMultiBlank = blanks.length > 1 || (blankCountHint && blankCountHint > 1);

    // å•ç©ºï¼šå±•ç¤ºä¸ºâ€œå¯æ¥å—ç­”æ¡ˆï¼šA / B / Câ€
    if (!isMultiBlank) {
        const alts = text.split(';').map(s => s.trim()).filter(Boolean);
        if (alts.length <= 1) {
            return `<div class="blank-ans one"><span class="label">ç­”æ¡ˆ</span><span class="val">${escapeHtmlLocal(alts[0] || text)}</span></div>`;
        }
        return `<div class="blank-ans one"><span class="label">å¯æ¥å—ç­”æ¡ˆ</span><span class="val">${alts.map(a => `<span class="pill">${escapeHtmlLocal(a)}</span>`).join('')}</span></div>`;
    }

    // å¤šç©ºï¼šæŒ‰â€œç©º1/ç©º2...â€åˆ—å‡ºï¼Œæ¯ç©ºå†…ç”¨ pill å±•ç¤ºå¤‡é€‰
    const rows = blanks.map((b, i) => {
        const alts = b.split(';').map(s => s.trim()).filter(Boolean);
        const valHtml = (alts.length <= 1)
            ? `<span class="text">${escapeHtmlLocal(alts[0] || '')}</span>`
            : alts.map(a => `<span class="pill">${escapeHtml(a)}</span>`).join('');
        return `<div class="blank-ans-row"><span class="blank-no">ç©º ${i + 1}</span><span class="blank-val">${valHtml}</span></div>`;
    }).join('');

    return `<div class="blank-ans multi">${rows}</div>`;
}

function escapeHtml(str){
    return (str ?? '').toString()
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
}

function escapeHtmlLocal(str){
    return (str ?? '').toString()
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
}

function updateDockEmptyState(){
    // ä»…å½±å“å¸ƒå±€ï¼šå³ä¾§ dock æ˜¯å¦â€œæœ‰å†…å®¹â€
    const mainArea = document.querySelector('.main-area');
    if (!mainArea) return;
    const a = document.getElementById('answerCard');
    const e = document.getElementById('explainCard');
    const ai = document.getElementById('aiExplainCard');
    const aShown = a && a.style.display !== 'none' && a.innerHTML.trim().length > 0;
    const eShown = e && e.style.display !== 'none' && e.innerHTML.trim().length > 0;
    const aiShown = ai && ai.style.display !== 'none' && ai.innerHTML.trim().length > 0;
    mainArea.classList.toggle('dock-empty', !(aShown || eShown || aiShown));
}

function renderAnswerExplainFromQuestion(qEl) {
    const answerHost = document.getElementById('answerCard');
    const explainHost = document.getElementById('explainCard');
    if (!answerHost || !explainHost) return;

    // æ¸…ç©ºæ—§å†…å®¹
    answerHost.classList.remove('show');
    explainHost.classList.remove('show');
    answerHost.innerHTML = '';
    explainHost.innerHTML = '';

    if (!qEl) {
        answerHost.style.display = 'none';
        explainHost.style.display = 'none';
        setAnswerResultBadge(null);
        updateDockEmptyState();
        return;
    }

    const answer = qEl.querySelector('.quiz-card.card-answer');
    const explain = qEl.querySelector('.quiz-card.card-explain');

    // ä¸ç§»åŠ¨åŸèŠ‚ç‚¹ï¼Œé¿å…åˆ‡é¢˜/é‡æ’åæ‰¾ä¸åˆ°ï¼›ä»…å¤åˆ¶å†…å®¹åˆ° dock
    if (answer) {
        // æ³¨å…¥ç»Ÿä¸€çš„å¤´éƒ¨ï¼ˆæ ‡é¢˜ + ç»“æœå¾½æ ‡ï¼‰ï¼Œå†æ”¾å…¥å†…å®¹
        const bodyClone = answer.cloneNode(true);
        // ç§»é™¤é¢˜å†…å¡ç‰‡è‡ªå¸¦æ ‡é¢˜ï¼ˆé¿å…é‡å¤ï¼‰
        const titleEl = bodyClone.querySelector('.analysis-title');
        if (titleEl) titleEl.remove();
        // ç§»é™¤â€œæ­£ç¡®ç­”æ¡ˆâ€ç­‰å†—ä½™æ ‡ç­¾ï¼Œä»…ä¿ç•™ç­”æ¡ˆå†…å®¹
        bodyClone.querySelectorAll('strong').forEach(s => {
            const t = (s.textContent || '').trim();
            if (t === 'æ­£ç¡®ç­”æ¡ˆ' || t === 'å‚è€ƒç­”æ¡ˆ' || t === 'æ ‡å‡†ç­”æ¡ˆ') s.remove();
        });

        // åªå– .answer çš„å†…å®¹ï¼›å¡«ç©ºé¢˜ç­”æ¡ˆåšç»“æ„åŒ–å±•ç¤ºï¼ˆåŒºåˆ†ï¼šä¸€ç©ºå¤šç­”æ¡ˆ / å¤šç©ºå¤šç­”æ¡ˆï¼‰
        const answerSpan = bodyClone.querySelector('.answer');
        let compactHtml = answerSpan ? answerSpan.outerHTML : bodyClone.innerHTML;

        const qType = qEl.getAttribute('data-type');
        if (qType === 'å¡«ç©ºé¢˜') {
            const raw = (qEl.getAttribute('data-answer') || '').toString();
            const blankCountHint = (qEl.querySelectorAll('.blank-item').length) || null;
            const formatted = formatFillBlankAnswerForDock(raw, blankCountHint);
            if (formatted) compactHtml = formatted;
        }

        answerHost.innerHTML = `
            <div class="dock-head">
                <div class="analysis-title">
                    <span class="dot" aria-hidden="true"></span>
                    <strong>ç­”æ¡ˆ</strong>
                </div>
                <span class="result-badge" data-state=""></span>
            </div>
            <div class="dock-body">${compactHtml}</div>
        `;
        answerHost.style.display = 'block';
    } else {
        answerHost.style.display = 'none';
    }

    if (explain) {
        const bodyClone = explain.cloneNode(true);
        const titleEl = bodyClone.querySelector('.analysis-title');
        if (titleEl) titleEl.remove();

        explainHost.innerHTML = `
            <div class="dock-head">
                <div class="analysis-title">
                    <span class="dot" aria-hidden="true"></span>
                    <strong>è§£æ</strong>
                </div>
            </div>
            <div class="dock-body">${bodyClone.innerHTML}</div>
        `;
        explainHost.style.display = 'block';
    } else {
        explainHost.style.display = 'none';
    }

    requestAnimationFrame(() => {
        if (answerHost.style.display !== 'none') answerHost.classList.add('show');
        if (explainHost.style.display !== 'none') explainHost.classList.add('show');
        updateDockEmptyState();
    });
}

function hideAnswerExplainDock() {
    const answerHost = document.getElementById('answerCard');
    const explainHost = document.getElementById('explainCard');
    const aiHost = document.getElementById('aiExplainCard');
    if (answerHost) { answerHost.style.display = 'none'; answerHost.innerHTML = ''; answerHost.classList.remove('show'); }
    if (explainHost) { explainHost.style.display = 'none'; explainHost.innerHTML = ''; explainHost.classList.remove('show'); }
    // AI è§£æç‹¬ç«‹å¡ç‰‡ä¸€å¹¶éšè—
    if (aiHost) { aiHost.style.display = 'none'; aiHost.innerHTML = ''; aiHost.classList.remove('show'); }
    setAnswerResultBadge(null);
    updateDockEmptyState();
}

function checkAnswer(isManualClick) {
    if (mode === 'exam') return;

    const currentQ = questions[currentIndex];
    const type = currentQ.getAttribute('data-type');
    const answer = currentQ.getAttribute('data-answer');
    const qId = currentQ.getAttribute('data-id');
    
    if (!hasAnswered(currentQ, type)) {
        if (isManualClick) showToast("è¯·å…ˆä½œç­”ï¼");
        return;
    }

    // æ¸²æŸ“â€œç­”æ¡ˆ/è§£æâ€åˆ° mainCard å¤–éƒ¨çš„ç‹¬ç«‹å¡ç‰‡
    renderAnswerExplainFromQuestion(currentQ);
    
    document.getElementById('btn-check').style.display = 'none';
    document.getElementById('btn-next').style.display = 'block';
    
    let isCorrect = judgeQuestion(currentQ, type, answer);
    styleFeedback(currentQ, type, answer, isCorrect);
    setAnswerResultBadge(isCorrect);
    
    disableInputs(currentQ);

    const listItem = document.getElementById(`list-item-${currentIndex}`);
    if (isCorrect) {
        listItem.classList.add('done-correct');
        listItem.classList.remove('done-wrong');
    } else {
        listItem.classList.add('done-wrong');
        listItem.classList.remove('done-correct');
    }

    if (LOGGED_IN) {
    fetch('/api/record_result', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ question_id: qId, is_correct: isCorrect })
    });
    } else {
        // æœªç™»å½•ä¸å†™å…¥é”™é¢˜æœ¬ï¼Œåªåœ¨æœ¬åœ°ä¿ç•™æ•ˆæœ
        showToast('æœªç™»å½•ï¼šé”™é¢˜ä¸ä¼šä¿å­˜åˆ°æœåŠ¡å™¨');
    }

    saveState(true); // ç­”é¢˜åç«‹å³åŒæ­¥åˆ°æœåŠ¡å™¨

    // ===== ç­”å¯¹è‡ªåŠ¨ä¸‹ä¸€é¢˜ï¼ˆæ‚¬æµ®çƒ âœ“âœ“ï¼‰ =====
    // ä»…åœ¨åˆ·é¢˜/èƒŒé¢˜ç­‰éè€ƒè¯•æ¨¡å¼ç”Ÿæ•ˆï¼ˆæœ¬å‡½æ•°å¼€å¤´å·²æ‹¦æˆª examï¼‰ã€‚
    // è§¦å‘æ—¶æœºï¼šåˆ¤é¢˜å¹¶æ¸²æŸ“åé¦ˆå®Œæˆä¹‹åã€‚
    try {
        if (isCorrect && isFabAutoNextEnabled()) {
            // æœ€åä¸€é¢˜ä¸è‡ªåŠ¨åˆ‡ï¼Œé¿å…é—ªåŠ¨
            if (currentIndex < totalQuestions - 1) {
                // ç»™ç”¨æˆ·ä¸€ä¸ªå¾ˆçŸ­çš„åé¦ˆåœç•™æ—¶é—´
                setTimeout(() => {
                    // è‹¥ç”¨æˆ·åœ¨ç­‰å¾…æœŸé—´å·²æ‰‹åŠ¨åˆ‡é¢˜/æ”¹å˜ç´¢å¼•ï¼Œåˆ™ä¸å¼ºè¡Œè¦†ç›–
                    if (questions[currentIndex] === currentQ) {
                        nextQuestion();
                    }
                }, 350);
            }
        }
    } catch (e) {}
}

function finishQuiz() {
    let correctCount = 0;
    let gridHtml = '';
    
    listItems.forEach((item, index) => {
        const isRight = item.classList.contains('done-correct');
        const isWrong = item.classList.contains('done-wrong');
        
        if (isRight) correctCount++;
        
        if (isRight) {
            gridHtml += `<div class="score-item s-correct" onclick="reviewJump(${index})">${index+1}</div>`;
        } else if (isWrong) {
            gridHtml += `<div class="score-item s-wrong" onclick="reviewJump(${index})">${index+1}</div>`;
        } else {
            gridHtml += `<div class="score-item" onclick="reviewJump(${index})">${index+1}</div>`;
        }
    });

    document.getElementById('scoreTitle').innerText = "åˆ·é¢˜æŠ¥å‘Š";
    document.getElementById('finalLabel').innerText = "å‡†ç¡®ç‡";
    document.getElementById('finalScore').innerText = Math.round((correctCount / totalQuestions) * 100) + "%";
    document.getElementById('scoreDetail').innerText = `ç­”å¯¹ ${correctCount} / ${totalQuestions} é¢˜`;
    document.getElementById('scoreGrid').innerHTML = gridHtml;
    document.getElementById('scoreOverlay').style.display = 'flex';
    
    document.getElementById('scoreCircle').style.borderColor = '#007bff';
    document.getElementById('scoreCircle').style.color = '#007bff';
}

function submitExam(force = false) {
    // æœåŠ¡ç«¯æäº¤è€ƒè¯•ç­”æ¡ˆï¼ˆè‹¥å­˜åœ¨ exam_idï¼‰
    try { sendExamAnswers(); } catch(e) {}
    if (isSubmitted) return; // ã€ä¿®å¤ã€‘å¦‚æœå·²äº¤å·ï¼Œç›´æ¥é˜»æ–­

    if (!force) {
        let unAnsweredIndices = [];
        questions.forEach((q, i) => {
            const type = q.getAttribute('data-type');
            if (!hasAnswered(q, type)) {
                unAnsweredIndices.push(i + 1);
            }
        });

        if (unAnsweredIndices.length > 0) {
            alert(`è¿˜æœ‰ ${unAnsweredIndices.length} é“é¢˜æœªä½œç­”ï¼\né¢˜å·ï¼š${unAnsweredIndices.join(', ')}`);
            if (!isWholeView) showQuestion(unAnsweredIndices[0] - 1);
            return;
        }
        
        if (!confirm("ç¡®å®šè¦äº¤å·å—ï¼Ÿäº¤å·åå°†æ˜¾ç¤ºæˆç»©ã€‚")) return;
    }

    // ã€ä¿®å¤ã€‘ç«‹å³æ›´æ–°çŠ¶æ€å¹¶éšè—æ‰€æœ‰äº¤å·æŒ‰é’®
    isSubmitted = true;
    const mainSubmitBtn = document.getElementById('btn-submit-exam');
    const tempSubmitBtn = document.getElementById('temp-submit');
    if(mainSubmitBtn) mainSubmitBtn.style.display = 'none';
    if(tempSubmitBtn) tempSubmitBtn.remove();
    
    clearInterval(timerInterval);
    let totalScore = 0;
    let correctCount = 0;
    let gridHtml = '';

    questions.forEach((q, index) => {
        const type = q.getAttribute('data-type');
        const answer = q.getAttribute('data-answer');
        const scoreVal = parseFloat(q.getAttribute('data-score'));
        
        const isCorrect = judgeQuestion(q, type, answer);
        styleFeedback(q, type, answer, isCorrect);
        // è€ƒè¯•äº¤å·åï¼šä¸åœ¨é¢˜å†…å±•å¼€è§£æï¼Œç­”æ¡ˆ/è§£æåœ¨å›é¡¾è·³é¢˜æ—¶æ¸²æŸ“åˆ°ç‹¬ç«‹å¡ç‰‡
        disableInputs(q);

        if (isCorrect) {
            totalScore += scoreVal;
            correctCount++;
            gridHtml += `<div class="score-item s-correct" onclick='reviewJump(${index})'>${index+1}</div>`;
        } else {
            gridHtml += `<div class="score-item s-wrong" onclick='reviewJump(${index})'>${index+1}</div>`;
        }
    });

    document.getElementById('finalScore').innerText = totalScore;
    document.getElementById('scoreDetail').innerText = `ç­”å¯¹ ${correctCount} / ${totalQuestions} é¢˜`;
    document.getElementById('scoreGrid').innerHTML = gridHtml;
    document.getElementById('scoreOverlay').style.display = 'flex';
}

function reviewExam() {
    document.getElementById('scoreOverlay').style.display = 'none';
    
    // è€ƒè¯•æ¨¡å¼ä¸‹ï¼Œå›é¡¾æ—¶ä¸å†æ˜¾ç¤ºäº¤å·æŒ‰é’®ï¼Œç¡®ä¿åªèƒ½ä¸‹ä¸€é¢˜æŸ¥çœ‹
    if (mode === 'exam') {
        const btnSubmit = document.getElementById('btn-submit-exam');
        if(btnSubmit) btnSubmit.style.display = 'none';
        
        const btnNext = document.getElementById('btn-next-exam');
        if(btnNext) btnNext.style.display = 'block';
    }
    
    if (!isWholeView) {
        currentIndex = 0;
        showQuestion(0);
    }
    
    const tempSubmit = document.getElementById('temp-submit');
    if(tempSubmit) tempSubmit.remove();
}

function reviewJump(index) {
    reviewExam();
    if (isWholeView) {
        jumpTo(index); 
    } else {
        showQuestion(index);
    }
}

function judgeQuestion(q, type, answer) {
    if (type === 'é€‰æ‹©é¢˜' || type === 'åˆ¤æ–­é¢˜' || type === 'å¤šé€‰é¢˜') {
        const inputs = q.querySelectorAll('input');
        let userVals = [];
        inputs.forEach(i => { if(i.checked) userVals.push(i.value) });
        return userVals.sort().join("") === answer;
    } else if (type === 'å¡«ç©ºé¢˜') {
        const inputs = q.querySelectorAll('.main-input');
        const correctBlanks = answer.split(';;').map(a => a.trim());

        if (inputs.length === 0) return false; // æ²¡æœ‰æ‰¾åˆ°è¾“å…¥æ¡†

        let allCorrect = true;
        for (let i = 0; i < inputs.length; i++) {
            const userInput = inputs[i].value.trim();
            const correctAnswersForBlank = (correctBlanks[i] || '').split(';').map(a => a.trim());
            if (!correctAnswersForBlank.includes(userInput)) {
                allCorrect = false;
                break;
            }
        }
        return allCorrect;
    } else if (type === 'é—®ç­”é¢˜') {
        return !!q.querySelector('textarea').value.trim();
    }
    return false;
}

function hasAnswered(q, type) {
    if (type === 'é€‰æ‹©é¢˜' || type === 'åˆ¤æ–­é¢˜' || type === 'å¤šé€‰é¢˜') return !!q.querySelector('input:checked');

    if (type === 'å¡«ç©ºé¢˜') {
        // å¤šç©ºæ—¶ï¼šå¿…é¡»æ‰€æœ‰è¾“å…¥æ¡†éƒ½éç©ºæ‰ç®—â€œå·²ä½œç­”â€
        const inputs = q.querySelectorAll('.main-input');
        if (inputs.length > 1) {
            return Array.from(inputs).every(i => (i.value || '').trim().length > 0);
        }
        // å•ç©ºï¼šä¼˜å…ˆæ‰¾å¡«ç©ºé¢˜çš„ text inputï¼ˆé¿å…è¯¯é€‰åˆ°éšè—/å…¶å®ƒç±»å‹çš„ inputï¼‰
        const one = q.querySelector('input.main-input[type="text"], input[type="text"].main-input, input[type="text"]');
        return !!(one && (one.value || '').trim());
    }

    if (type === 'é—®ç­”é¢˜') {
        const ta = q.querySelector('textarea');
        return !!(ta && ta.value && ta.value.trim());
    }
    return false;
}

function styleFeedback(q, type, answer, isCorrect) {
    if (type === 'é€‰æ‹©é¢˜' || type === 'åˆ¤æ–­é¢˜' || type === 'å¤šé€‰é¢˜') {
        q.querySelectorAll('input').forEach(input => {
            const label = input.parentElement;
            label.classList.remove('correct-opt', 'wrong-opt');
            if (isCorrect) {
                // åšå¯¹æ—¶ï¼Œç”¨æˆ·é€‰ä¸­çš„éƒ½ç»¿è‰²
                if (input.checked) label.classList.add('correct-opt');
            } else {
                // åšé”™æ—¶ï¼Œç”¨æˆ·é€‰ä¸­çš„é”™è¯¯é€‰é¡¹æ ‡çº¢
                if (input.checked && !answer.includes(input.value)) {
                    label.classList.add('wrong-opt');
                }
                // æ€»æ˜¯é«˜äº®æ­£ç¡®ç­”æ¡ˆ
                if (answer.includes(input.value)) {
                    label.classList.add('correct-opt');
                }
            }
        });
    } else if (type === 'å¡«ç©ºé¢˜') {
        const inputs = q.querySelectorAll('.main-input');
        const correctBlanks = answer.split(';;').map(a => a.trim());

        inputs.forEach((input, i) => {
            input.classList.remove('input-correct', 'input-wrong');
            const userInput = input.value.trim();
            const correctAnswersForBlank = (correctBlanks[i] || '').split(';').map(a => a.trim());
            
            if (correctAnswersForBlank.includes(userInput)) {
                input.classList.add('input-correct');
            } else {
                input.classList.add('input-wrong');
            }
        });
    }
    // åˆ·é¢˜æ¨¡å¼ä¸‹ï¼Œé¢˜ç›®åˆ—è¡¨é«˜äº®
    if (mode !== 'exam') {
        const idx = q.getAttribute('data-index');
        const item = document.getElementById(`list-item-${idx}`);
        if (item) {
            item.classList.remove('done-correct', 'done-wrong');
            if (isCorrect) {
                item.classList.add('done-correct');
            } else {
                item.classList.add('done-wrong');
            }
        }
    }
}

// é˜²æŠ–å®šæ—¶å™¨
let saveStateTimer = null;
let lastSavedPayload = null;
let syncPending = false; // æ ‡è®°æ˜¯å¦æœ‰å¾…åŒæ­¥çš„æ•°æ®

// ä¿ç•™åšé¢˜ç—•è¿¹æ ·å¼ - å¸¦é˜²æŠ–æœºåˆ¶
function saveState(immediate = false) {
    let statusMap = {};
    let answerMap = {};
    listItems.forEach((item, index) => {
        if (item.classList.contains('done-correct')) statusMap[index] = 'correct';
        if (item.classList.contains('done-wrong')) statusMap[index] = 'wrong';
        // ä¿å­˜ç”¨æˆ·é€‰é¡¹/ç­”æ¡ˆ
        const q = document.getElementById(`q-${index}`);
        if (q) {
            const type = q.getAttribute('data-type');
            if (type === 'é€‰æ‹©é¢˜' || type === 'åˆ¤æ–­é¢˜' || type === 'å¤šé€‰é¢˜') {
                const checked = Array.from(q.querySelectorAll('input:checked')).map(i => i.value);
                answerMap[index] = checked;
            } else if (type === 'å¡«ç©ºé¢˜') {
                const inputs = q.querySelectorAll('.main-input');
                answerMap[index] = Array.from(inputs).map(input => input.value);

            } else if (type === 'é—®ç­”é¢˜') {
                answerMap[index] = q.querySelector('textarea').value;
            }
        }
    });
    const payload = { index: currentIndex, status: statusMap, answers: answerMap, timestamp: Date.now() };
    // ä¿ç•™é¢˜ç›®é¡ºåºï¼Œé˜²æ­¢è¦†ç›–æœåŠ¡ç«¯ä¿å­˜çš„æ‰“ä¹±é¡ºåº
    if (cachedOrder) {
        payload.order = cachedOrder;
    }

    // ç«‹å³ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem(progressKey(), JSON.stringify(payload));
    lastSavedPayload = payload;
    syncPending = true;

    // ç™»å½•ç”¨æˆ·åŒæ­¥åˆ°æœåŠ¡å™¨
    if (LOGGED_IN) {
        if (immediate) {
            // ç«‹å³åŒæ­¥ï¼ˆç­”é¢˜åç­‰é‡è¦æ“ä½œï¼‰
            if (saveStateTimer) clearTimeout(saveStateTimer);
            syncToServer(payload);
        } else {
            // é˜²æŠ–ä¿å­˜ï¼ˆ200mså†…å¤šæ¬¡è°ƒç”¨åªæ‰§è¡Œæœ€åä¸€æ¬¡ï¼‰
            if (saveStateTimer) clearTimeout(saveStateTimer);
            saveStateTimer = setTimeout(() => {
                syncToServer(payload);
            }, 200);
        }
    }
}

// åŒæ­¥åˆ°æœåŠ¡å™¨
async function syncToServer(payload) {
    if (!LOGGED_IN) return;
    try {
        const key = progressKey();
        console.log('[è¿›åº¦åŒæ­¥] ä¿å­˜ä¸­...', key);
        const res = await fetch('/api/progress', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key: key, data: payload })
        });
        if (res.ok) {
            syncPending = false;
            console.log('[è¿›åº¦åŒæ­¥] æˆåŠŸ');
        } else {
            console.error('[è¿›åº¦åŒæ­¥] æœåŠ¡å™¨é”™è¯¯:', res.status);
        }
    } catch(e) {
        console.error('[è¿›åº¦åŒæ­¥] å¤±è´¥:', e);
    }
}

// é¡µé¢å¸è½½æ—¶å¼ºåˆ¶åŒæ­¥
window.addEventListener('beforeunload', function(e) {
    if (LOGGED_IN && syncPending && lastSavedPayload) {
        try {
            const key = progressKey();
            const data = JSON.stringify({ key: key, data: lastSavedPayload });
            // ä½¿ç”¨ sendBeacon ç¡®ä¿æ•°æ®å‘é€
            if (navigator.sendBeacon) {
                const blob = new Blob([data], {type: 'application/json'});
                navigator.sendBeacon('/api/progress', blob);
                console.log('[è¿›åº¦åŒæ­¥] beforeunload å‘é€æˆåŠŸ');
            }
        } catch(err) {
            console.error('[è¿›åº¦åŒæ­¥] beforeunload å‘é€å¤±è´¥:', err);
        }
    }
});

// é¡µé¢éšè—æ—¶ä¹Ÿå°è¯•åŒæ­¥ï¼ˆåˆ‡æ¢æ ‡ç­¾é¡µç­‰ï¼‰
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'hidden' && LOGGED_IN && syncPending && lastSavedPayload) {
        syncToServer(lastSavedPayload);
    }
});

function refreshAnsweredMarkersFromInputs(){
    // ç”¨å½“å‰è¾“å…¥å†…å®¹é‡å»ºâ€œå·²ç­”â€æ ‡è®°ï¼ˆè€ƒè¯•æ¨¡å¼ä¾§è¾¹æ ï¼‰
    try {
        questions.forEach((q, idx) => {
            const it = document.getElementById(`list-item-${idx}`);
            if (!it) return;
            const type = q.getAttribute('data-type');
            if (hasAnswered(q, type)) it.classList.add('answered');
            else it.classList.remove('answered');
        });
    } catch(e) {}
}

function loadState() {
    try {
        const data = JSON.parse(localStorage.getItem(progressKey()));
        if (data) {
            // ç¼“å­˜é¢˜ç›®é¡ºåºï¼Œä¿å­˜æ—¶éœ€è¦ä¿ç•™
            if (data.order && Array.isArray(data.order)) {
                cachedOrder = data.order;
            }
            if (data.status) {
                for (const [idx, status] of Object.entries(data.status)) {
                    const item = document.getElementById(`list-item-${idx}`);
                    if (item) {
                        if (status === 'correct') item.classList.add('done-correct');
                        if (status === 'wrong') item.classList.add('done-wrong');
                    }
                    const q = document.getElementById(`q-${idx}`);
                    if (q && (status === 'correct' || status === 'wrong')) {
                        const type = q.getAttribute('data-type');
                        const answer = q.getAttribute('data-answer');
                        const isCorrect = status === 'correct';

                        // 1. æ¢å¤ç”¨æˆ·çš„é€‰æ‹© (å¿…é¡»åœ¨ styleFeedback ä¹‹å‰)
                        if (data.answers && data.answers[idx]) {
                            const userAnswer = data.answers[idx];
                            if ((type === 'é€‰æ‹©é¢˜' || type === 'åˆ¤æ–­é¢˜' || type === 'å¤šé€‰é¢˜') && Array.isArray(userAnswer)) {
                                q.querySelectorAll('input').forEach(i => { i.checked = userAnswer.includes(i.value); });
                            } else if (type === 'å¡«ç©ºé¢˜') {
                                // å¡«ç©ºé¢˜ï¼šè¿™é‡Œä¿å­˜çš„æ˜¯æ•°ç»„ï¼ˆæ¯ç©ºä¸€ä¸ªå€¼ï¼‰ï¼Œéœ€è¦é€ä¸ªæ¢å¤
                                if (Array.isArray(userAnswer)) {
                                    const inputs = q.querySelectorAll('.main-input');
                                    inputs.forEach((input, i) => {
                                        if (typeof userAnswer[i] !== 'undefined') input.value = userAnswer[i] || '';
                                    });
                                } else {
                                    const inp = q.querySelector('input[type="text"], .main-input');
                                    if (inp) inp.value = userAnswer;
                                }
                            } else if (type === 'é—®ç­”é¢˜') {
                                q.querySelector('textarea').value = userAnswer;
                            }
                        }

                        // 2. æ¢å¤é«˜äº®æ•ˆæœ
                        styleFeedback(q, type, answer, isCorrect);

                        // 3. å·²ä½œç­”é¢˜ï¼šéœ€è¦èƒ½åœ¨å›é¡¾æ—¶å±•ç¤ºâ€œç­”æ¡ˆ/è§£æâ€
                        // æ³¨æ„ï¼šæ­¤å¤„åªæ˜¯æ¢å¤çŠ¶æ€ï¼Œå…·ä½“æ˜¾ç¤ºåœ¨ showQuestion / checkAnswer æ—¶æ¸²æŸ“åˆ°ç‹¬ç«‹å¡ç‰‡
                        disableInputs(q);
                    }
                }
            }
            if (data.answers) {
                for (const [idx, val] of Object.entries(data.answers)) {
                    const q = document.getElementById(`q-${idx}`);
                    if (q) {
                        const type = q.getAttribute('data-type');
                        if ((type === 'é€‰æ‹©é¢˜' || type === 'åˆ¤æ–­é¢˜' || type === 'å¤šé€‰é¢˜') && Array.isArray(val)) {
                            q.querySelectorAll('input').forEach(i => { i.checked = val.includes(i.value); });
                        } else if (type === 'å¡«ç©ºé¢˜' && Array.isArray(val)) {
                            const inputs = q.querySelectorAll('.main-input');
                            inputs.forEach((input, i) => {
                                if (val[i]) {
                                    input.value = val[i];
                                }
                            });
                        } else if (type === 'é—®ç­”é¢˜') {
                            q.querySelector('textarea').value = val;
                        }
                    }
                }
            }
            if (data.index) currentIndex = data.index;
        }

        // è€ƒè¯•æ¨¡å¼ä¹Ÿéœ€è¦æ ¹æ®æ¢å¤çš„è¾“å…¥æ¥é‡å»ºâ€œå·²ç­”â€æ ‡è®°
        if (mode === 'exam') {
            refreshAnsweredMarkersFromInputs();
        }
    } catch(e) {}
}

function resetQuizUI(){
    // æ¸…ç©ºåˆ—è¡¨çŠ¶æ€
    document.querySelectorAll('.q-item').forEach(item=>{
        item.classList.remove('done-correct','done-wrong','answered');
    });
    // æ¸…ç©ºé¢˜ç›®çŠ¶æ€
    questions.forEach((q)=>{
        q.classList.remove('checked-mode');
        // å–æ¶ˆé€‰ä¸­å’Œç¦ç”¨
        q.querySelectorAll('input, textarea').forEach(el=>{
            el.disabled=false;
            if(el.type==='checkbox' || el.type==='radio') el.checked=false;
            else el.value='';
        });
        // å»æ‰é«˜äº®
        q.querySelectorAll('.correct-opt, .wrong-opt, .input-correct, .input-wrong').forEach(el=>{
            el.classList.remove('correct-opt','wrong-opt','input-correct','input-wrong');
        });
        // æ¸…ç†ç‹¬ç«‹ç­”æ¡ˆ/è§£æå¡ç‰‡
        hideAnswerExplainDock();
    });
    // é‡ç½®æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
    const btnCheck=document.getElementById('btn-check');
    const btnNext=document.getElementById('btn-next');
    if(btnCheck) btnCheck.style.display='block';
    if(btnNext) btnNext.style.display='none';

    currentIndex=0;
    showQuestion(0);
}

async function clearProgress(confirmMsg = "ç¡®å®šè¦æ¸…é™¤å½“å‰æ¨¡å¼çš„åšé¢˜è¿›åº¦å—ï¼Ÿ") {
    if(confirm(confirmMsg)) {
        localStorage.removeItem(progressKey());
        if (LOGGED_IN) {
            try { await fetch(`/api/progress?key=${encodeURIComponent(progressKey())}`, { method: 'DELETE' }); } catch(e) {}
        }
        resetQuizUI(); // Reset the UI to its initial state
        showToast('è¿›åº¦å·²æ¸…é™¤');
        return true; // Indicates data was cleared
    }
    return false; // User cancelled
}

async function reshuffle() {
    const confirmed = confirm("é‡æ–°æ‰“ä¹±å°†æ¸…ç©ºå½“å‰è¿›åº¦ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ");
    if (confirmed) {
        // 1. Clear progress data without reloading
        localStorage.removeItem(progressKey());
        if (LOGGED_IN) {
            try { await fetch(`/api/progress?key=${encodeURIComponent(progressKey())}`, { method: 'DELETE' }); } catch(e) {}
        }

        // 2. Get all question elements
        const mainCard = document.getElementById('mainCard');
        const questionBoxes = Array.from(mainCard.querySelectorAll('.question-box'));
        const sidebarList = document.getElementById('question-list');
        const listItemsElements = Array.from(sidebarList.querySelectorAll('.q-item'));

        // 3. Create a mapping from original DOM index to elements
        const questionMap = {};
        questionBoxes.forEach((box, i) => {
            questionMap[i] = { box: box, item: listItemsElements[i] };
        });

        // 4. Shuffle the indices
        let indices = Object.keys(questionMap).map(Number);
        for (let i = indices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [indices[i], indices[j]] = [indices[j], indices[i]];
        }

        // 5. Re-append elements in the new order and update attributes
        const footer = mainCard.querySelector('.footer');
        questionBoxes.forEach(box => box.remove());
        listItemsElements.forEach(item => item.remove());

        indices.forEach((originalIndex, newIndex) => {
            const pair = questionMap[originalIndex];
            const box = pair.box;
            const item = pair.item;

            // Update question box
            box.id = `q-${newIndex}`;
            box.dataset.index = newIndex;
            mainCard.insertBefore(box, footer);

            // Update list item
            item.id = `list-item-${newIndex}`;
            item.querySelector('span:first-child').textContent = newIndex + 1;
            item.setAttribute('onclick', `jumpTo(${newIndex})`);
            sidebarList.appendChild(item);
        });

        // 6. Reset UI state - é‡æ–°è·å– DOM å…ƒç´ ï¼ˆæ³¨æ„ï¼šè¿™é‡Œç›´æ¥èµ‹å€¼ç»™æ¨¡å—çº§å˜é‡ï¼Œä¸æ˜¯ window å±æ€§ï¼‰
        questions = document.querySelectorAll('.question-box');
        listItems = document.querySelectorAll('.q-item');
        
        questions.forEach((q, index) => {
            q.classList.remove('checked-mode');
            q.querySelectorAll('input, textarea').forEach(el => {
                el.disabled = false;
                if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
                else el.value = '';
            });
            q.querySelectorAll('.correct-opt, .wrong-opt, .input-correct, .input-wrong').forEach(el => {
                el.classList.remove('correct-opt', 'wrong-opt', 'input-correct', 'input-wrong');
            });
            // ç‹¬ç«‹ç­”æ¡ˆ/è§£æå¡ç‰‡ç”± showQuestion/checkAnswer æ§åˆ¶ï¼Œè¿™é‡Œåªéœ€æ¸…ç† dock
            hideAnswerExplainDock();
        });
        listItems.forEach(item => {
            item.classList.remove('done-correct', 'done-wrong', 'answered');
        });

        // 7. æ”¶é›†æ–°çš„é¢˜ç›®é¡ºåºå¹¶æ›´æ–° cachedOrderï¼Œç„¶ååŒæ­¥åˆ°æœåŠ¡å™¨
        const newOrder = Array.from(questions).map(q => parseInt(q.getAttribute('data-id')));
        cachedOrder = newOrder;
        
        // 8. Show the first question
        currentIndex = 0;
        showQuestion(0);
        
        // 9. ç«‹å³ä¿å­˜æ–°é¡ºåºåˆ°æœåŠ¡å™¨ï¼ˆé‡è¦ï¼šå¿…é¡»åœ¨ showQuestion ä¹‹åï¼Œå› ä¸º showQuestion ä¹Ÿä¼šè°ƒç”¨ saveStateï¼‰
        saveState(true);
        
        showToast('é¢˜ç›®å·²é‡æ–°æ’åº');
    }
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg;
    t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 2000);
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.getElementById('overlay').classList.toggle('show');
}

function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
}

function toggleStar(btn, id) {
     fetch('/api/favorite', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ question_id: id })
    }).then(res => res.json()).then(data => {
        if(data.status === 'success') {
            btn.classList.toggle('active');
        }
    });
}

function applyReviewFromServer() {
    try {
        const uaMap = USER_ANSWERS || {};
        questions.forEach(q => {
            const qid = parseInt(q.getAttribute('data-id'));
            const type = q.getAttribute('data-type');
            const stdAns = q.getAttribute('data-answer');
            const ua = uaMap[qid] || '';
            // å¡«å……ç”¨æˆ·ç­”æ¡ˆ
            if (type === 'é€‰æ‹©é¢˜' || type === 'å¤šé€‰é¢˜') {
                const chosen = new Set((ua || '').split(''));
                q.querySelectorAll('input[type="checkbox"]').forEach(i => { i.checked = chosen.has(i.value); });
            } else if (type === 'åˆ¤æ–­é¢˜') {
                q.querySelectorAll('input[type="radio"]').forEach(i => { i.checked = (i.value === ua); });
            } else if (type === 'å¡«ç©ºé¢˜') {
                // ua å¯èƒ½æ˜¯å•ç©ºå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯èƒ½æ˜¯å¤šç©º JSON æ•°ç»„å­—ç¬¦ä¸²
                let uaList = null;
                try {
                    const tmp = JSON.parse(ua);
                    if (Array.isArray(tmp)) uaList = tmp;
                } catch(e) { uaList = null; }
                const inputs = q.querySelectorAll('input[type="text"]');
                if (inputs && inputs.length > 1 && uaList) {
                    inputs.forEach((input, i) => { if (typeof uaList[i] !== 'undefined') input.value = uaList[i] || ''; });
                } else {
                    const inp = q.querySelector('input[type="text"]'); if (inp) inp.value = ua;
                }
            } else {
                const ta = q.querySelector('textarea'); if (ta) ta.value = ua;
            }
            // å±•ç¤ºè§£æä¸é«˜äº®
            const isCorrect = (function(){
                if (type === 'é€‰æ‹©é¢˜' || type === 'å¤šé€‰é¢˜') return (ua.split('').sort().join('') === (stdAns||'').split('').sort().join('')) && ua !== '';
                if (type === 'åˆ¤æ–­é¢˜') return ua === stdAns && ua !== '';
                if (type === 'å¡«ç©ºé¢˜') {
                    // æ ‡å‡†ç­”æ¡ˆï¼šä¸åŒç©ºç”¨ ";;" åˆ†éš”ï¼›æ¯ç©ºå¤šç­”æ¡ˆç”¨ ";" åˆ†éš”
                    // ä¾‹ï¼šåŒ—äº¬;åŒ—å¹³;;ä¸Šæµ·;æ²ª
                    const std = (stdAns||'').trim();
                    const stdBlanks = std ? std.split(';;').map(s=>s.trim()) : [''];

                    // ç”¨æˆ·ç­”æ¡ˆï¼šå¤šç©ºç”¨ JSON æ•°ç»„å­—ç¬¦ä¸²æäº¤ï¼Œå¦åˆ™ä¸ºå•ç©ºå­—ç¬¦ä¸²
                    let uaList = null;
                    try {
                        const tmp = JSON.parse(ua);
                        if (Array.isArray(tmp)) uaList = tmp.map(x => (x||'').toString().trim());
                    } catch(e) { uaList = null; }

                    function matchOne(userOne, stdOne){
                        const u = (userOne||'').toString().trim();
                        if(!u) return false;
                        const cands = (stdOne||'').split(';').map(x=>x.trim()).filter(Boolean);
                        const arr = cands.length ? cands : [(stdOne||'').trim()];
                        return arr.some(x=>x===u);
                    }

                    if (uaList) {
                        if (uaList.length !== stdBlanks.length) return false;
                        return stdBlanks.every((s, i) => matchOne(uaList[i], s));
                    }

                    // å•ç©º
                    if (stdBlanks.length > 1) return false;
                    return matchOne(ua, stdBlanks[0]);
                }
                return !!ua;
            })();
            styleFeedback(q, type, stdAns, isCorrect);
            // å›é¡¾æ¨¡å¼ä¸‹ï¼Œç­”æ¡ˆ/è§£æåœ¨ showQuestion æ—¶æ¸²æŸ“åˆ°ç‹¬ç«‹å¡ç‰‡
            disableInputs(q);
        });
        // åˆå§‹åŒ–è¿›åº¦æ¡
        const plabel = document.getElementById('progress-label');
        if (plabel) plabel.innerText = `1 / ${questions.length}`;
        const pf = document.getElementById('progress-fill');
        if (pf) pf.style.width = (questions.length? (1/questions.length*100):0)+'%';
    } catch(e) {}
}

function collectExamAnswers() {
    const arr = [];
    questions.forEach(q => {
        const qid = parseInt(q.getAttribute('data-id'));
        const type = q.getAttribute('data-type');
        let ua = '';
        if (type === 'é€‰æ‹©é¢˜') {
            ua = Array.from(q.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value).join('');
        } else if (type === 'åˆ¤æ–­é¢˜') {
            const r = q.querySelector('input[type="radio"]:checked');
            ua = r ? r.value : '';
        } else if (type === 'å¡«ç©ºé¢˜') {
            const inputs = q.querySelectorAll('input[type="text"]');
            if (inputs && inputs.length > 1) {
                ua = JSON.stringify(Array.from(inputs).map(x => (x.value || '').trim()));
            } else {
                const i = q.querySelector('input[type="text"]');
                ua = i ? (i.value || '') : '';
            }
        } else {
            const t = q.querySelector('textarea');
            ua = t ? (t.value || '') : '';
        }
        arr.push({ question_id: qid, user_answer: ua });
    });
    return arr;
}
async function sendExamAnswers() {
    if (!EXAM_ID) return;
    try {
        const answers = collectExamAnswers();
        const res = await fetch('/api/exams/submit', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ exam_id: EXAM_ID, answers }) });
        const js = await res.json();
        if (res.ok && js.status === 'success') {
            // ä»¥æœåŠ¡ç«¯ç»“æœä¸ºå‡†æ›´æ–°åˆ†æ•°ä¸ç»Ÿè®¡
            if (typeof js.total_score !== 'undefined') {
                const fs = document.getElementById('finalScore');
                if (fs) fs.innerText = js.total_score;
            }
            if (typeof js.total !== 'undefined' && typeof js.correct !== 'undefined') {
                const sd = document.getElementById('scoreDetail');
                if (sd) sd.innerText = `ç­”å¯¹ ${js.correct} / ${js.total} é¢˜`;
            }
        }
    } catch(e) { /* å¿½ç•¥ç½‘ç»œé”™è¯¯ */ }
}

function applyDraftFromServer(){
    try {
        const uaMap = USER_ANSWERS || {};
        questions.forEach(q => {
            const qid = parseInt(q.getAttribute('data-id'));
            const type = q.getAttribute('data-type');
            const ua = uaMap[qid] || '';
            if (!ua) return;

            // è‹¥æœ¬åœ°/é¡µé¢ä¸Šå·²ç»æœ‰è¾“å…¥ï¼Œåˆ™ä¸è¦†ç›–ï¼ˆé¿å… loadState åè¢«æœåŠ¡ç«¯è‰ç¨¿å†²æ‰ï¼‰
            if (type === 'é€‰æ‹©é¢˜') {
                const existed = Array.from(q.querySelectorAll('input[type="checkbox"]')).some(i => i.checked);
                if (existed) return;
                const chosen = new Set((ua || '').split(''));
                q.querySelectorAll('input[type="checkbox"]').forEach(i => { i.checked = chosen.has(i.value); });
            } else if (type === 'åˆ¤æ–­é¢˜') {
                const existed = !!q.querySelector('input[type="radio"]:checked');
                if (existed) return;
                q.querySelectorAll('input[type="radio"]').forEach(i => { i.checked = (i.value === ua); });
            } else if (type === 'å¡«ç©ºé¢˜') {
                const inputs = q.querySelectorAll('input[type="text"].main-input, input[type="text"]');
                const existed = Array.from(inputs).some(i => (i.value || '').trim().length > 0);
                if (existed) return;

                // ua å¯èƒ½æ˜¯å•ç©ºå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯èƒ½æ˜¯å¤šç©º JSON æ•°ç»„å­—ç¬¦ä¸²
                let uaList = null;
                try {
                    const tmp = JSON.parse(ua);
                    if (Array.isArray(tmp)) uaList = tmp;
                } catch(e) { uaList = null; }

                if (inputs.length > 1 && uaList) {
                    inputs.forEach((input, i) => { if (typeof uaList[i] !== 'undefined') input.value = uaList[i] || ''; });
                } else {
                    const inp = q.querySelector('input[type="text"].main-input, input[type="text"]');
                    if (inp) inp.value = ua;
                }
            } else {
                const ta = q.querySelector('textarea');
                const existed = !!(ta && (ta.value || '').trim().length > 0);
                if (existed) return;
                if (ta) ta.value = ua;
            }
        });

        // è¡¥é½å®Œè‰ç¨¿åï¼Œåˆ·æ–°ä¸€æ¬¡â€œå·²ç­”â€æ ‡è®°ï¼ˆè€ƒè¯•ä¾§è¾¹æ ï¼‰
        try {
            questions.forEach((q, idx) => { if (hasAnswered(q, q.getAttribute('data-type'))) { const it=document.getElementById(`list-item-${idx}`); if(it) it.classList.add('answered'); } });
        } catch(e) {}
    } catch(e) {}
}
let autoSaveTimer = null;
function scheduleAutoSave(){
    if (!EXAM_ID) return;
    try {
        window.addEventListener('beforeunload', function(){
            try {
                const payload = JSON.stringify({ exam_id: EXAM_ID, answers: collectExamAnswers() });
                if (navigator.sendBeacon) {
                    const blob = new Blob([payload], {type: 'application/json'});
                    navigator.sendBeacon('/api/exams/save_draft', blob);
                }
            } catch(e){}
        });
    } catch(e){}
    autoSaveTimer = setInterval(async ()=>{
        try {
            const answers = collectExamAnswers();
            await fetch('/api/exams/save_draft', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ exam_id: EXAM_ID, answers }) });
        } catch(e) {}
    }, 5000);
}

// Mobile swipe gesture for next/prev question
const mainCard = document.getElementById('mainCard');
if (mainCard) {
    let touchStartX = 0;
    let touchStartY = 0;

    mainCard.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
    }, { passive: true });

    mainCard.addEventListener('touchend', e => {
        const touchEndX = e.changedTouches[0].screenX;
        const touchEndY = e.changedTouches[0].screenY;
        handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
    }, { passive: true });
}

function handleSwipe(startX, startY, endX, endY) {
    const diffX = endX - startX;
    const diffY = endY - startY;

    // Only trigger if horizontal swipe is significant and vertical swipe is not
    if (Math.abs(diffX) > 200 && Math.abs(diffY) < 200) {
        if (diffX < 0) {
            // Swiped left
            nextQuestion();
        } else {
            // Swiped right
            prevQuestion();
        }
    }
}

init();

function getQuizHotkeys(){
    const DEFAULT_QUIZ_HOTKEYS = {
        prev_question: 'ArrowLeft',
        next_question: 'ArrowRight',
        toggle_favorite: 'KeyF',
        choose_option_1: 'Digit1',
        choose_option_2: 'Digit2',
        choose_option_3: 'Digit3',
        choose_option_4: 'Digit4',
        blank_prev: 'ArrowUp',
        blank_next: 'ArrowDown',
        submit_or_next: 'Enter'
    };
    try {
        const js = JSON.parse(localStorage.getItem('quiz_hotkeys_v1') || 'null');
        if (!js || typeof js !== 'object') return { ...DEFAULT_QUIZ_HOTKEYS };
        return { ...DEFAULT_QUIZ_HOTKEYS, ...js };
    } catch(e) {
        return { ...DEFAULT_QUIZ_HOTKEYS };
    }
}

function normalizeEventToken(e){
    const mods = [];
    if (e.ctrlKey) mods.push('Ctrl');
    if (e.altKey) mods.push('Alt');
    if (e.shiftKey) mods.push('Shift');
    if (e.metaKey) mods.push('Meta');

    const code = e.code || '';
    const isModifierOnly = ['ShiftLeft','ShiftRight','ControlLeft','ControlRight','AltLeft','AltRight','MetaLeft','MetaRight'].includes(code);
    if (isModifierOnly) return '';

    const keyCode = (code === 'Space') ? ' ' : (code || e.key || '');
    if (!keyCode) return '';
    return mods.length ? `${mods.join('+')}+${keyCode}` : keyCode;
}

document.addEventListener('keydown', function(e) {
    const isInputFocused = document.activeElement.tagName === 'INPUT';
    const isTextareaFocused = document.activeElement.tagName === 'TEXTAREA';

    // å¦‚æœæˆç»©å¼¹çª—æ˜¾ç¤ºï¼Œåˆ™ç¦ç”¨æ‰€æœ‰å¿«æ·é”®
    if (document.getElementById('scoreOverlay').style.display === 'flex') {
        return;
    }

    const HK = getQuizHotkeys();
    const token = normalizeEventToken(e);

    // æäº¤/æŸ¥çœ‹ç»“æœ/ä¸‹ä¸€é¢˜ï¼ˆå¯è‡ªå®šä¹‰ï¼Œé»˜è®¤ Enterï¼‰
    if ((HK.submit_or_next && token === HK.submit_or_next) || (!HK.submit_or_next && e.key === 'Enter')) {
        // å½“ç„¦ç‚¹åœ¨é—®ç­”é¢˜çš„æ–‡æœ¬åŸŸæ—¶ï¼Œå…è®¸é»˜è®¤çš„æ¢è¡Œè¡Œä¸º
        if (isTextareaFocused) {
            return;
        }
        // é˜»æ­¢å…¶ä»–æ‰€æœ‰ Enter çš„é»˜è®¤è¡Œä¸ºï¼ˆæ¯”å¦‚è¡¨å•æäº¤ï¼‰
        e.preventDefault();

        // ä¼˜å…ˆç‚¹å‡»â€œä¸‹ä¸€é¢˜â€æŒ‰é’®ï¼ˆåŒ…æ‹¬æ™®é€šæ¨¡å¼å’Œè€ƒè¯•æ¨¡å¼ï¼‰
        const btnNext = document.getElementById('btn-next');
        if (btnNext && btnNext.style.display !== 'none') {
            btnNext.click();
            return;
        }
        const btnNextExam = document.getElementById('btn-next-exam');
        if (btnNextExam && btnNextExam.style.display !== 'none') {
            btnNextExam.click();
            return;
        }
        
        // å…¶æ¬¡ï¼Œç‚¹å‡»â€œæŸ¥çœ‹ç»“æœâ€æŒ‰é’®
        const btnCheck = document.getElementById('btn-check');
        if (btnCheck && btnCheck.style.display !== 'none') {
            btnCheck.click();
            return;
        }
        return; // Enter é”®é€»è¾‘å¤„ç†å®Œæ¯•
    }

    // å¡«ç©ºé¢˜ä¸­ï¼Œä½¿ç”¨è‡ªå®šä¹‰å¿«æ·é”®åˆ‡æ¢è¾“å…¥æ¡†ï¼ˆå½“ input èšç„¦æ—¶ï¼‰
    if (isInputFocused && ((HK.blank_prev && token === HK.blank_prev) || (HK.blank_next && token === HK.blank_next) || e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
        const isPrev = (HK.blank_prev && token === HK.blank_prev) || (!HK.blank_prev && e.key === 'ArrowUp') || e.key === 'ArrowUp';
        const isNext = (HK.blank_next && token === HK.blank_next) || (!HK.blank_next && e.key === 'ArrowDown') || e.key === 'ArrowDown';
        const arrowKey = isNext ? 'ArrowDown' : 'ArrowUp';
        const currentQ = questions[currentIndex];
        if (currentQ && currentQ.dataset.type === 'å¡«ç©ºé¢˜') {
            const inputs = Array.from(currentQ.querySelectorAll('.main-input'));
            if (inputs.length > 1) {
                const focusedIndex = inputs.indexOf(document.activeElement);
                if (focusedIndex !== -1) {
                    e.preventDefault(); // é˜»æ­¢å…‰æ ‡ç§»åŠ¨åˆ°è¡Œé¦–/è¡Œå°¾
                    let nextIndex;
                    if (arrowKey === 'ArrowDown') {
                        nextIndex = (focusedIndex + 1) % inputs.length;
                    } else { // ArrowUp
                        nextIndex = (focusedIndex - 1 + inputs.length) % inputs.length;
                    }
                    inputs[nextIndex].focus();
                    return; // åŠŸèƒ½å·²å¤„ç†ï¼Œé€€å‡º
                }
            }
        }
    }

    // å¦‚æœç„¦ç‚¹åœ¨ä»»ä½•è¾“å…¥æ¡†æˆ–æ–‡æœ¬åŸŸä¸­ï¼Œåˆ™ä¸è§¦å‘ä»¥ä¸‹çš„å¿«æ·é”®
    if (isInputFocused || isTextareaFocused) {
        return;
    }

    const currentQ = questions[currentIndex];
    if (!currentQ) return;
    const options = currentQ.querySelectorAll('.options label');

    // é€‰é¡¹é€‰æ‹©ï¼ˆé€‰æ‹©é¢˜/åˆ¤æ–­é¢˜ï¼‰
    const chooseMap = {
        [HK.choose_option_1 || 'Digit1']: 0,
        [HK.choose_option_2 || 'Digit2']: 1,
        [HK.choose_option_3 || 'Digit3']: 2,
        [HK.choose_option_4 || 'Digit4']: 3,
        // å…¼å®¹åŸå…ˆçš„ e.key æ•°å­—è¾“å…¥
        'Digit1': 0,
        'Digit2': 1,
        'Digit3': 2,
        'Digit4': 3
    };
    if (token in chooseMap) {
        e.preventDefault();
        const optionIndex = chooseMap[token];
        if (options[optionIndex]) {
            const optInp = options[optionIndex].querySelector('input');
            if (optInp) optInp.click();
        }
        return;
    }

    // ä¸Š/ä¸‹ä¸€é¢˜
    if ((HK.prev_question && token === HK.prev_question) || e.key === 'ArrowLeft') {
        e.preventDefault();
        prevQuestion();
        return;
    }
    if ((HK.next_question && token === HK.next_question) || e.key === 'ArrowRight') {
        e.preventDefault();
        nextQuestion();
        return;
    }

    // æ”¶è—
    if ((HK.toggle_favorite && token === HK.toggle_favorite) || e.key === 'f' || e.key === 'F') {
        e.preventDefault();
        const favBtn = currentQ.querySelector('.fav-btn');
        if (favBtn) favBtn.click();
        return;
    }
});

function nextQuestion() {
    if (typeof currentIndex === 'undefined') currentIndex = 0;
    if (currentIndex < totalQuestions - 1) {
        showQuestion(currentIndex + 1);
    }
}
function prevQuestion() {
    if (typeof currentIndex === 'undefined') currentIndex = 0;
    if (currentIndex > 0) {
        showQuestion(currentIndex - 1);
    }
}

function setupImageGallery(questionElement) {
    const gallery = questionElement.querySelector('.question-image-gallery');
    if (!gallery) return;

    let images = [];
    try {
        const imageData = gallery.dataset.images;
        // Compatibility for both JSON string and plain string
        if (imageData.startsWith('[')) {
            images = JSON.parse(imageData);
        } else if (imageData) {
            images = [imageData];
        }
    } catch (e) {
        console.error('Failed to parse image data:', e);
        images = [];
    }

    if (images.length === 0) {
        gallery.style.display = 'none';
        return;
    }

    gallery.style.display = 'block';
    const imageWrapper = gallery.querySelector('.gallery-main-image-wrapper');
    const controls = gallery.querySelector('.gallery-controls');
    const counter = gallery.querySelector('.gallery-counter');
    const prevBtn = gallery.querySelector('.gallery-prev');
    const nextBtn = gallery.querySelector('.gallery-next');

    let currentImageIndex = 0;

    function showImage(index) {
        imageWrapper.innerHTML = `<img src="{{ url_for('main.main_pages.serve_upload', filename='') }}${images[index]}" alt="é¢˜ç›®å›¾ç‰‡ ${index + 1}" style="max-width: 100%; max-height: 400px; border-radius: 12px; border: 1px solid var(--border-color);">`;
        if (images.length > 1) {
            counter.textContent = `${index + 1} / ${images.length}`;
        }
    }

    if (images.length > 1) {
        controls.style.display = 'flex';
        prevBtn.onclick = () => {
            currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
            showImage(currentImageIndex);
        };
        nextBtn.onclick = () => {
            currentImageIndex = (currentImageIndex + 1) % images.length;
            showImage(currentImageIndex);
        };
    } else {
        controls.style.display = 'none';
    }

    showImage(0);
}

function gotoPage(p){
    const url = new URL(window.location.href);
    url.searchParams.set('page', p);
    const szSel = document.getElementById('pageSize');
    if (szSel) url.searchParams.set('size', szSel.value);
    window.location.href = url.toString();
}
function changeSize(sz){
    const url = new URL(window.location.href);
    url.searchParams.set('size', sz);
    url.searchParams.set('page', 1);
    window.location.href = url.toString();
}
