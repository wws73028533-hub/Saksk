{% extends "user_bank/base.html" %}

{% block title %}我的题库{% endblock %}

{% block head %}
<style>
    .container {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        padding: 40px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-soft);
        border: 0.5px solid var(--border-color);
    }

    /* 页面标题 */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--border-color);
    }
    .page-title {
        font-size: 28px;
        font-weight: bold;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .page-title-icon {
        display: none;
    }

    /* 统计卡片 - iOS 18风格（优化大小） */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
    }
    .stat-card {
        padding: 20px;
        border-radius: var(--radius-lg);
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        color: var(--text-color);
        box-shadow: var(--shadow-soft);
        border: 0.5px solid var(--border-color);
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
        border-color: var(--border-color);
    }
    .stat-card.total, .stat-card.questions, .stat-card.avg, .stat-card.shares {
        background: rgba(255, 255, 255, 0.7);
    }
    .stat-card-label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 10px;
        font-weight: 500;
    }
    .stat-card-value {
        font-size: 32px;
        font-weight: 600;
        margin-bottom: 0;
        letter-spacing: -0.5px;
    }

    /* 工具栏 */
    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        gap: 16px;
        flex-wrap: wrap;
    }
    .toolbar-left, .toolbar-right {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    /* 表单容器 - 同一行显示，统一宽高 */
    .forms-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 24px;
        align-items: stretch;
    }

    @media (max-width: 1200px) {
        .forms-row {
            grid-template-columns: 1fr;
        }
    }

    /* 添加题库表单 - iOS 18风格，统一高度 */
    .add-bank-form {
        display: flex;
        gap: 12px;
        align-items: center;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-soft);
        border: 0.5px solid var(--border-color);
        box-sizing: border-box;
    }
    .add-bank-form.quick-links {
        flex-direction: column;
        align-items: flex-start;
        justify-content: flex-start;
        padding: 12px 14px;
    }
    .add-bank-form input {
        flex: 1;
        min-width: 200px;
    }

    /* 快捷链接 */
    .quick-link-list {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        width: 100%;
    }
    .quick-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: rgba(142, 142, 147, 0.08);
        border: 0.5px solid var(--border-color);
        border-radius: var(--radius-md);
        color: var(--text-color);
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .quick-link:hover {
        background: rgba(142, 142, 147, 0.12);
        transform: translateY(-1px);
    }

    /* 搜索框 */
    .search-box {
        position: relative;
        display: inline-block;
    }
    .search-box input {
        padding-left: 14px;
        width: 250px;
        transition: width 0.3s, border-color 0.3s;
    }
    .search-box input:focus {
        width: 320px;
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    .search-icon {
        display: none;
    }

    /* 输入框优化 */
    input[type="text"], select {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s, box-shadow 0.2s;
        background: var(--card-bg-solid);
    }
    input[type="text"]:focus, select:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 3px var(--primary-light);
    }

    /* 表格优化 - iOS 18风格 */
    .table-wrapper {
        border-radius: var(--radius-lg);
        overflow: visible;
        border: 0.5px solid var(--border-color);
        box-shadow: var(--shadow-soft);
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }
    th, td {
        border-bottom: 1px solid var(--border-color);
        padding: 16px;
        text-align: left;
        vertical-align: middle;
    }
    thead th {
        background: rgba(142, 142, 147, 0.06);
        border-bottom: 0.5px solid var(--border-color);
        font-weight: 600;
        color: var(--text-color);
        font-size: 13px;
        text-transform: none;
        letter-spacing: -0.01em;
    }
    tbody tr {
        transition: all 0.2s;
    }
    tbody tr:hover {
        background-color: rgba(142, 142, 147, 0.08);
        transform: scale(1.01);
    }
    tbody tr:last-child td {
        border-bottom: none;
    }

    /* 题库名称样式 */
    .bank-name {
        font-size: 16px;
        font-weight: 500;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .bank-desc {
        font-size: 12px;
        color: var(--text-sub);
        margin-top: 4px;
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* 题目数量徽章 - iOS 18风格 */
    .question-count {
        display: inline-flex;
        align-items: center;
        gap: 0;
        padding: 6px 12px;
        background: rgba(142, 142, 147, 0.1);
        color: var(--text-color);
        border-radius: var(--radius-sm);
        font-size: 13px;
        font-weight: 500;
        border: 0.5px solid var(--border-color);
    }
    .question-count.empty {
        background: rgba(142, 142, 147, 0.1);
        color: var(--text-sub);
        border-color: var(--border-color);
    }

    /* 操作按钮优化 - 下拉菜单样式 */
    .action-dropdown {
        position: relative;
        display: inline-block;
    }
    .btn-action {
        background: rgba(142, 142, 147, 0.1);
        color: var(--text-color);
        border: 0.5px solid var(--border-color);
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .btn-action:hover {
        background: rgba(142, 142, 147, 0.15);
    }
    .action-menu {
        display: none;
        position: absolute;
        left: 100%;
        top: 0;
        margin-left: 8px;
        min-width: 100px;
        max-width: 140px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 0.5px solid var(--border-color);
        border-radius: var(--radius-md);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        padding: 4px 0;
        z-index: 1000;
        animation: slideRight 0.2s ease;
    }
    [data-theme="dark"] .action-menu {
        background: rgba(28, 28, 30, 0.95);
        border-color: rgba(255, 255, 255, 0.15);
    }
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideRight {
        from { opacity: 0; transform: translateX(-10px); }
        to { opacity: 1; transform: translateX(0); }
    }
    .action-menu.open {
        display: block;
    }
    .action-item {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 8px 12px;
        background: none;
        border: none;
        text-align: left;
        cursor: pointer;
        font-size: 13px;
        color: var(--text-color);
        transition: background 0.2s;
        font-weight: 400;
        text-decoration: none;
    }
    .action-item:hover {
        background: rgba(142, 142, 147, 0.1);
    }
    .action-item:active {
        background: rgba(142, 142, 147, 0.15);
    }
    .action-icon {
        font-size: 16px;
        width: 20px;
        text-align: center;
    }
    .action-text {
        flex: 1;
    }
    .action-item.action-danger {
        color: var(--danger);
    }
    .action-item.action-danger:hover {
        background: rgba(255, 59, 48, 0.1);
    }
    .action-item.action-warning {
        color: var(--warning);
    }
    .action-item.action-warning:hover {
        background: rgba(255, 149, 0, 0.1);
    }
    .action-item.action-success {
        color: var(--success);
    }
    .action-item.action-success:hover {
        background: rgba(52, 199, 89, 0.1);
    }
    .action-divider {
        height: 0.5px;
        background: var(--border-color);
        margin: 4px 0;
    }
    .btn-sm {
        padding: 8px 16px;
        min-height: 36px;
        font-size: 14px;
        border-radius: var(--radius-md);
        border: none;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        white-space: nowrap;
        font-weight: 500;
    }
    .btn-sm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .btn-manage {
        background: var(--primary);
        color: white;
    }
    .btn-manage:hover {
        background: var(--primary);
        opacity: 0.9;
    }
    .btn-edit {
        background: rgba(142, 142, 147, 0.1);
        color: var(--text-color);
        border: 0.5px solid var(--border-color);
    }
    .btn-edit:hover {
        background: rgba(142, 142, 147, 0.15);
    }
    .btn-delete {
        background: rgba(255, 59, 48, 0.1);
        color: var(--danger);
        border: 0.5px solid rgba(255, 59, 48, 0.2);
    }
    .btn-delete:hover {
        background: rgba(255, 59, 48, 0.15);
    }
    .btn-warning {
        background: rgba(255, 149, 0, 0.7);
        backdrop-filter: blur(20px);
        color: white;
        border: 0.5px solid rgba(255, 149, 0, 0.3);
    }
    .btn-warning:hover {
        background: rgba(255, 149, 0, 0.85);
        transform: translateY(-1px);
        box-shadow: var(--shadow-soft);
    }
    .btn-success {
        background: rgba(52, 199, 89, 0.7);
        backdrop-filter: blur(20px);
        color: white;
        border: 0.5px solid rgba(52, 199, 89, 0.3);
    }
    .btn-success:hover {
        background: rgba(52, 199, 89, 0.85);
        transform: translateY(-1px);
        box-shadow: var(--shadow-soft);
    }

    /* 模态框 */
    .modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s;
    }
    .modal-overlay.show {
        display: flex;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .modal-content {
        background: var(--card-bg);
        backdrop-filter: blur(40px) saturate(180%);
        -webkit-backdrop-filter: blur(40px) saturate(180%);
        padding: 32px;
        border-radius: var(--radius-xl);
        width: 450px;
        max-width: 90vw;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        border: 0.5px solid var(--border-color);
        animation: slideUp 0.3s;
    }
    @keyframes slideUp {
        from { transform: translateY(30px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .modal-header {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 20px;
        color: var(--text-color);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .modal-body {
        margin-bottom: 24px;
    }
    .form-group {
        margin-bottom: 16px;
    }
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-color);
    }
    .form-group input, .form-group select, .form-group textarea {
        width: 100%;
        box-sizing: border-box;
    }
    .form-group textarea {
        min-height: 80px;
        resize: vertical;
    }
    .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    /* 空状态 */
    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: var(--text-sub);
    }
    .empty-state-icon {
        display: none;
    }
    .empty-state-text {
        font-size: 18px;
        margin-bottom: 10px;
        font-weight: 500;
        color: var(--text-color);
    }
    .empty-state-hint {
        font-size: 14px;
        color: var(--text-sub);
        margin-bottom: 24px;
    }

    /* 加载状态 */
    .loading-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-sub);
    }
    .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* 状态徽章 */
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    .status-badge.public {
        background: rgba(52, 199, 89, 0.15);
        color: var(--success);
    }
    .status-badge.private {
        background: rgba(0, 122, 255, 0.1);
        color: var(--primary);
    }

    /* 分类徽章 */
    .category-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        background: rgba(255, 149, 0, 0.15);
        color: var(--warning);
    }

    /* 筛选器 */
    .filter-select {
        min-width: 120px;
    }

    /* ========== 黑夜模式适配 ========== */

    /* 容器 */
    [data-theme="dark"] .container {
        background: rgba(28, 28, 30, 0.7);
    }

    /* 统计卡片 */
    [data-theme="dark"] .stat-card,
    [data-theme="dark"] .stat-card.total,
    [data-theme="dark"] .stat-card.questions,
    [data-theme="dark"] .stat-card.avg,
    [data-theme="dark"] .stat-card.shares {
        background: rgba(28, 28, 30, 0.7);
    }

    /* 表单容器 */
    [data-theme="dark"] .add-bank-form {
        background: rgba(28, 28, 30, 0.7);
    }

    /* 快捷链接 */
    [data-theme="dark"] .quick-link {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.15);
    }
    [data-theme="dark"] .quick-link:hover {
        background: rgba(255, 255, 255, 0.15);
    }

    /* 输入框和选择框 */
    [data-theme="dark"] input[type="text"],
    [data-theme="dark"] select,
    [data-theme="dark"] textarea {
        background: rgba(28, 28, 30, 0.8);
        color: var(--text-color);
        border-color: rgba(255, 255, 255, 0.15);
    }
    [data-theme="dark"] input[type="text"]:focus,
    [data-theme="dark"] select:focus,
    [data-theme="dark"] textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);
    }
    [data-theme="dark"] input[type="text"]::placeholder,
    [data-theme="dark"] textarea::placeholder {
        color: var(--text-sub);
        opacity: 0.6;
    }
    [data-theme="dark"] select option {
        background: rgba(28, 28, 30, 0.95);
        color: var(--text-color);
    }

    /* 表格 */
    [data-theme="dark"] .table-wrapper {
        background: rgba(28, 28, 30, 0.7);
    }
    [data-theme="dark"] thead th {
        background: rgba(255, 255, 255, 0.05);
    }
    [data-theme="dark"] tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
    [data-theme="dark"] th,
    [data-theme="dark"] td {
        border-bottom-color: rgba(255, 255, 255, 0.1);
    }

    /* 主要按钮 */
    [data-theme="dark"] .btn-primary {
        background-color: rgba(0, 122, 255, 0.35);
        border: 1.5px solid rgba(0, 122, 255, 0.6);
        color: white;
        box-shadow: 0 0 0 1px rgba(0, 122, 255, 0.3) inset,
                    0 2px 8px rgba(0, 122, 255, 0.25),
                    0 0 20px rgba(0, 122, 255, 0.2);
    }
    [data-theme="dark"] .btn-primary:hover {
        background-color: rgba(0, 122, 255, 0.45);
        border-color: rgba(0, 122, 255, 0.8);
        box-shadow: 0 0 0 1px rgba(0, 122, 255, 0.4) inset,
                    0 4px 16px rgba(0, 122, 255, 0.35),
                    0 0 30px rgba(0, 122, 255, 0.3);
    }

    /* 次要按钮 */
    [data-theme="dark"] .btn-secondary {
        background-color: rgba(255, 255, 255, 0.1);
        color: var(--text-color);
        border-color: rgba(255, 255, 255, 0.15);
    }
    [data-theme="dark"] .btn-secondary:hover {
        background-color: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.2);
    }

    /* 操作按钮 */
    [data-theme="dark"] .btn-action {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.15);
    }
    [data-theme="dark"] .btn-action:hover {
        background: rgba(255, 255, 255, 0.15);
    }

    /* 编辑按钮 */
    [data-theme="dark"] .btn-edit {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.15);
    }
    [data-theme="dark"] .btn-edit:hover {
        background: rgba(255, 255, 255, 0.15);
    }

    /* 删除按钮 */
    [data-theme="dark"] .btn-delete {
        background: rgba(255, 59, 48, 0.15);
        color: #ff6b6b;
        border-color: rgba(255, 59, 48, 0.25);
    }
    [data-theme="dark"] .btn-delete:hover {
        background: rgba(255, 59, 48, 0.22);
    }

    /* 模态框 */
    [data-theme="dark"] .modal-overlay {
        background: rgba(0, 0, 0, 0.7);
    }
    [data-theme="dark"] .modal-content {
        background: rgba(28, 28, 30, 0.95);
        border-color: rgba(255, 255, 255, 0.15);
    }

    /* 表单组 */
    [data-theme="dark"] .form-group label {
        color: var(--text-color);
    }
    [data-theme="dark"] .form-group input,
    [data-theme="dark"] .form-group select,
    [data-theme="dark"] .form-group textarea {
        background: rgba(28, 28, 30, 0.8);
        color: var(--text-color);
        border-color: rgba(255, 255, 255, 0.15);
    }
    [data-theme="dark"] .form-group input:focus,
    [data-theme="dark"] .form-group select:focus,
    [data-theme="dark"] .form-group textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);
    }

    /* 加载状态 */
    [data-theme="dark"] .loading-state {
        color: var(--text-sub);
    }
    [data-theme="dark"] .loading-spinner {
        border-color: rgba(255, 255, 255, 0.1);
        border-top-color: var(--primary);
    }

    /* 空状态 */
    [data-theme="dark"] .empty-state {
        color: var(--text-sub);
    }
    [data-theme="dark"] .empty-state-text {
        color: var(--text-color);
    }
    [data-theme="dark"] .empty-state-hint {
        color: var(--text-sub);
    }

    /* 操作菜单项悬停 */
    [data-theme="dark"] .action-item:hover {
        background: rgba(255, 255, 255, 0.1);
    }
    [data-theme="dark"] .action-item:active {
        background: rgba(255, 255, 255, 0.15);
    }
    [data-theme="dark"] .action-item.action-danger:hover {
        background: rgba(255, 59, 48, 0.15);
    }
    [data-theme="dark"] .action-item.action-warning:hover {
        background: rgba(255, 149, 0, 0.15);
    }
    [data-theme="dark"] .action-item.action-success:hover {
        background: rgba(52, 199, 89, 0.15);
    }
    [data-theme="dark"] .action-divider {
        background: rgba(255, 255, 255, 0.1);
    }

    /* 题目数量徽章 */
    [data-theme="dark"] .question-count {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.15);
    }
    [data-theme="dark"] .question-count.empty {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
    }

    /* 状态徽章 */
    [data-theme="dark"] .status-badge.public {
        background: rgba(52, 199, 89, 0.2);
        color: #30d158;
    }
    [data-theme="dark"] .status-badge.private {
        background: rgba(10, 132, 255, 0.2);
        color: #0a84ff;
    }

    /* 分类徽章 */
    [data-theme="dark"] .category-badge {
        background: rgba(255, 149, 0, 0.2);
        color: #ff9f0a;
    }
</style>
{% endblock %}

{% block page_content %}
<div class="container">
    <!-- 统计卡片 -->
    <div class="stats-row">
        <div class="stat-card total">
            <div class="stat-card-label">我的题库</div>
            <div class="stat-card-value" id="statTotal">0</div>
        </div>
        <div class="stat-card questions">
            <div class="stat-card-label">总题目数</div>
            <div class="stat-card-value" id="statQuestions">0</div>
        </div>
        <div class="stat-card avg">
            <div class="stat-card-label">已公开</div>
            <div class="stat-card-value" id="statPublic">0</div>
        </div>
        <div class="stat-card shares">
            <div class="stat-card-label">分享次数</div>
            <div class="stat-card-value" id="statShares">0</div>
        </div>
    </div>

    <!-- 表单容器 - 同一行显示 -->
    <div class="forms-row">
        <!-- 添加题库表单 -->
        <div class="add-bank-form">
            <div style="display: flex; gap: 12px; align-items: center; width: 100%;">
                <span style="font-weight: 500; color: var(--text-color); white-space: nowrap;">快速创建：</span>
                <input type="text" id="bankName" placeholder="请输入题库名称，例如：高等数学期末复习" onkeydown="if(event.key==='Enter') addBank()" style="flex: 1; min-width: 0;">
                <button class="btn-primary" onclick="addBank()">立即创建</button>
            </div>
        </div>

        <!-- 快捷入口 -->
        <div class="add-bank-form quick-links">
            <div style="font-weight: 500; color: var(--text-color); font-size: 14px; margin-bottom: 8px;">快捷入口</div>
            <div class="quick-link-list">
                <a href="/public/banks" class="quick-link">题库广场</a>
                <a href="/user/banks/shared" class="quick-link">收到的分享</a>
                <a href="/user/banks/manage/shares" class="quick-link">分享管理</a>
                <a href="/user/banks/add" class="quick-link">完整创建</a>
            </div>
        </div>
    </div>

    <!-- 工具栏 -->
    <div class="toolbar">
        <div class="toolbar-left">
            <span style="font-size: 16px; font-weight: 500; color: var(--text-color);">题库列表</span>
            <select id="publicFilter" class="filter-select" title="状态筛选">
                <option value="">全部状态</option>
                <option value="0">私密</option>
                <option value="1">公开</option>
            </select>
        </div>
        <div class="toolbar-right">
            <div class="search-box">
                <span class="search-icon"></span>
                <input type="text" id="searchInput" placeholder="搜索题库名称..." oninput="filterBanks()">
            </div>
        </div>
    </div>

    <!-- 表格 -->
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th style="width: 60px;">序号</th>
                    <th>题库名称</th>
                    <th style="width: 100px;">题目数量</th>
                    <th style="width: 80px;">分享</th>
                    <th style="width: 80px;">状态</th>
                    <th style="width: 120px;">操作</th>
                </tr>
            </thead>
            <tbody id="bankTableBody">
                <tr>
                    <td colspan="6" class="loading-state">
                        <div class="loading-spinner"></div>
                        <div>加载中...</div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- 编辑题库模态框 -->
<div class="modal-overlay" id="editModal" onclick="if(event.target===this) closeEditModal()">
    <div class="modal-content">
        <div class="modal-header">
            <span>编辑题库</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>题库名称 *</label>
                <input type="text" id="editBankName" placeholder="请输入题库名称">
            </div>
            <div class="form-group">
                <label>题库描述</label>
                <textarea id="editBankDesc" placeholder="请输入题库描述（选填）"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeEditModal()">取消</button>
            <button class="btn-primary" onclick="confirmEdit()">保存修改</button>
        </div>
    </div>
</div>

<!-- 公开设置模态框 -->
<div class="modal-overlay" id="publicModal" onclick="if(event.target===this) closePublicModal()">
    <div class="modal-content">
        <div class="modal-header">
            <span>公开设置</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="isPublic">
                    <span>公开此题库</span>
                </label>
                <p class="form-hint">公开后，所有用户都可在题库广场看到并使用此题库</p>
            </div>
            <div id="publicSettings" style="display: none;">
                <div class="form-group">
                    <label>公开描述</label>
                    <textarea id="publicDescription" placeholder="公开展示的描述（可与私人描述不同）"></textarea>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="allowCopy" checked>
                        <span>允许其他用户复制题目</span>
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closePublicModal()">取消</button>
            <button class="btn-primary" onclick="confirmPublicSetting()">保存设置</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allBanks = [];
    let editingBankId = null;
    let publicBankId = null;

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function loadBanks() {
        try {
            const isPublic = document.getElementById('publicFilter').value;

            let url = '/user/banks/api/list?';
            if (isPublic !== '') url += `is_public=${isPublic}&`;

            const res = await api(url);
            allBanks = res.data.banks || [];
            updateStats();
            renderBanks();
        } catch (e) {
            console.error('加载题库失败:', e);
            showToast('加载题库失败: ' + e.message, 'error');
        }
    }

    function updateStats() {
        const total = allBanks.length;
        const totalQuestions = allBanks.reduce((sum, b) => sum + (b.question_count || 0), 0);
        const publicCount = allBanks.filter(b => b.is_public).length;
        const shareCount = allBanks.reduce((sum, b) => sum + (b.share_count || 0), 0);

        document.getElementById('statTotal').textContent = total;
        document.getElementById('statQuestions').textContent = totalQuestions;
        document.getElementById('statPublic').textContent = publicCount;
        document.getElementById('statShares').textContent = shareCount;
    }

    function renderBanks(filtered = null) {
        const banks = filtered || allBanks;
        const tbody = document.getElementById('bankTableBody');
        tbody.innerHTML = '';

        if (banks.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state">
                        <div class="empty-state-text">暂无题库数据</div>
                        <div class="empty-state-hint">点击上方"立即创建"按钮创建第一个题库</div>
                        <button class="btn-primary" onclick="document.getElementById('bankName').focus()">
                            立即创建题库
                        </button>
                    </td>
                </tr>
            `;
            return;
        }

        banks.forEach((bank, idx) => {
            const tr = document.createElement('tr');
            const count = bank.question_count || 0;
            const countClass = count === 0 ? 'empty' : '';
            const isPublic = bank.is_public === 1 || bank.is_public === true;
            const statusHtml = isPublic
                ? '<span class="status-badge public">公开</span>'
                : '<span class="status-badge private">私密</span>';

            tr.innerHTML = `
                <td style="text-align: center; font-weight: 500; color: var(--text-sub);">${idx + 1}</td>
                <td>
                    <div class="bank-name">
                        <span>${escapeHtml(bank.name)}</span>
                    </div>
                    ${bank.description ? `<div class="bank-desc">${escapeHtml(bank.description)}</div>` : ''}
                </td>
                <td>
                    <span class="question-count ${countClass}">
                        ${count} 道题
                    </span>
                </td>
                <td style="text-align: center;">
                    ${bank.share_count || 0}
                </td>
                <td style="text-align: center;">
                    ${statusHtml}
                </td>
                <td>
                    <div class="dropdown action-dropdown">
                        <button class="btn-sm btn-action" onclick="toggleActionMenu(${bank.id}, event)">
                            <span>操作</span>
                            <span style="margin-left: 4px; font-size: 12px;">▼</span>
                        </button>
                        <div id="action-menu-${bank.id}" class="action-menu dropdown-menu">
                            <a href="/user/banks/${bank.id}" class="action-item">
                                <span class="action-text">题目管理</span>
                            </a>
                            <a href="/quiz?bank_id=${bank.id}" class="action-item">
                                <span class="action-text">开始刷题</span>
                            </a>
                            <a href="/user/banks/${bank.id}/shares" class="action-item">
                                <span class="action-text">分享管理</span>
                            </a>
                            <button class="action-item ${isPublic ? 'action-success' : ''}" onclick="openPublicModal(${bank.id}); closeActionMenu(${bank.id});">
                                <span class="action-text">${isPublic ? '已公开' : '公开设置'}</span>
                            </button>
                            <button class="action-item" onclick="openEditModal(${bank.id}); closeActionMenu(${bank.id});">
                                <span class="action-text">编辑</span>
                            </button>
                            <div class="action-divider"></div>
                            <button class="action-item action-danger" onclick="deleteBank(${bank.id}); closeActionMenu(${bank.id});">
                                <span class="action-text">删除</span>
                            </button>
                        </div>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function filterBanks() {
        const keyword = document.getElementById('searchInput').value.toLowerCase().trim();
        if (!keyword) {
            renderBanks();
            return;
        }
        const filtered = allBanks.filter(b => b.name.toLowerCase().includes(keyword));
        renderBanks(filtered);
    }

    async function addBank() {
        const nameInput = document.getElementById('bankName');
        const name = nameInput.value.trim();

        if (!name) {
            showToast('请输入题库名称', 'error');
            nameInput.focus();
            return;
        }

        if (name.length < 2 || name.length > 50) {
            showToast('题库名称需要2-50个字符', 'error');
            return;
        }

        try {
            const res = await api('/user/banks/api', {
                method: 'POST',
                body: JSON.stringify({ name })
            });

            showToast('题库创建成功');
            nameInput.value = '';
            loadBanks();
        } catch (e) {
            console.error('创建题库失败:', e);
            showToast(e.message || '创建失败', 'error');
        }
    }

    function openEditModal(id) {
        const bank = allBanks.find(b => b.id === id);
        if (!bank) return;

        editingBankId = id;
        document.getElementById('editBankName').value = bank.name;
        document.getElementById('editBankDesc').value = bank.description || '';
        document.getElementById('editModal').classList.add('show');
        document.body.style.overflow = 'hidden';

        setTimeout(() => {
            const input = document.getElementById('editBankName');
            input.focus();
            input.select();
        }, 100);
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.remove('show');
        document.body.style.overflow = '';
        editingBankId = null;
    }

    async function confirmEdit() {
        if (!editingBankId) return;

        const name = document.getElementById('editBankName').value.trim();
        const description = document.getElementById('editBankDesc').value.trim();

        if (!name) {
            showToast('请输入题库名称', 'error');
            return;
        }

        if (name.length < 2 || name.length > 50) {
            showToast('题库名称需要2-50个字符', 'error');
            return;
        }

        try {
            await api(`/user/banks/api/${editingBankId}`, {
                method: 'PUT',
                body: JSON.stringify({ name, description })
            });

            showToast('修改成功');
            closeEditModal();
            loadBanks();
        } catch (e) {
            console.error('修改题库失败:', e);
            showToast(e.message || '修改失败', 'error');
        }
    }

    // 公开设置
    function openPublicModal(id) {
        const bank = allBanks.find(b => b.id === id);
        if (!bank) return;

        publicBankId = id;
        const isPublic = bank.is_public === 1 || bank.is_public === true;
        document.getElementById('isPublic').checked = isPublic;
        document.getElementById('publicDescription').value = bank.public_description || '';
        document.getElementById('allowCopy').checked = bank.allow_copy !== 0;
        document.getElementById('publicSettings').style.display = isPublic ? 'block' : 'none';
        document.getElementById('publicModal').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closePublicModal() {
        document.getElementById('publicModal').classList.remove('show');
        document.body.style.overflow = '';
        publicBankId = null;
    }

    async function confirmPublicSetting() {
        if (!publicBankId) return;

        const isPublic = document.getElementById('isPublic').checked;
        const publicDescription = document.getElementById('publicDescription').value.trim();
        const allowCopy = document.getElementById('allowCopy').checked;

        try {
            await api(`/user/banks/api/${publicBankId}/public`, {
                method: 'POST',
                body: JSON.stringify({
                    is_public: isPublic,
                    public_description: publicDescription,
                    allow_copy: allowCopy
                })
            });

            showToast(isPublic ? '题库已公开' : '题库已设为私密');
            closePublicModal();
            loadBanks();
        } catch (e) {
            console.error('设置公开状态失败:', e);
            showToast(e.message || '设置失败', 'error');
        }
    }

    // 监听公开复选框变化
    document.getElementById('isPublic').addEventListener('change', function() {
        document.getElementById('publicSettings').style.display = this.checked ? 'block' : 'none';
    });

    async function deleteBank(id) {
        const bank = allBanks.find(b => b.id === id);
        if (!bank) return;

        const count = bank.question_count || 0;
        let confirmMsg = `确定要删除题库「${bank.name}」吗？`;
        if (count > 0) {
            confirmMsg += `\n\n该题库下有 ${count} 道题目，将一并删除。`;
        }
        confirmMsg += '\n\n此操作不可恢复！';

        if (!confirmAction(confirmMsg)) return;

        try {
            await api(`/user/banks/api/${id}`, { method: 'DELETE' });
            showToast('删除成功');
            loadBanks();
        } catch (e) {
            console.error('删除题库失败:', e);
            showToast(e.message || '删除失败', 'error');
        }
    }

    function toggleActionMenu(bankId, event) {
        event.stopPropagation();
        const menuId = `action-menu-${bankId}`;
        const menu = document.getElementById(menuId);
        const isOpen = menu.classList.contains('open') || menu.style.display === 'block';

        // 先关闭所有其他菜单
        document.querySelectorAll('.action-menu').forEach(m => {
            m.classList.remove('open');
            m.style.display = 'none';
        });

        if (!isOpen) {
            menu.classList.add('open');
            menu.style.display = 'block';
        }
    }

    function closeActionMenu(bankId) {
        const menuId = `action-menu-${bankId}`;
        const menu = document.getElementById(menuId);
        if (menu) {
            menu.classList.remove('open');
            menu.style.display = 'none';
        }
    }

    // 点击外部关闭所有下拉菜单
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.action-dropdown')) {
            document.querySelectorAll('.action-menu').forEach(m => {
                m.classList.remove('open');
                m.style.display = 'none';
            });
        }
    });

    // 筛选器事件
    document.getElementById('publicFilter').addEventListener('change', loadBanks);

    document.addEventListener('DOMContentLoaded', () => {
        loadBanks();

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeEditModal();
                closePublicModal();
                // 关闭所有下拉菜单
                document.querySelectorAll('.action-menu').forEach(m => {
                    m.classList.remove('open');
                    m.style.display = 'none';
                });
            }
        });

        document.getElementById('editBankName').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                confirmEdit();
            }
        });
    });
</script>
{% endblock %}
