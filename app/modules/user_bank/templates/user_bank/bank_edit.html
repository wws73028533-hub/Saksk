{% extends "user_bank/base.html" %}

{% block title %}{% if mode == 'add' %}创建题库{% else %}编辑题库{% endif %}{% endblock %}

{% block content %}
<a href="/user/banks" class="nav-back">← 返回我的题库</a>

<div class="page-header">
    <h1 class="page-title">{% if mode == 'add' %}创建题库{% else %}编辑题库{% endif %}</h1>
</div>

<div class="card form-card">
    <form id="bankForm">
        <div class="form-group">
            <label class="form-label">题库名称 *</label>
            <input type="text" id="name" class="form-input" placeholder="请输入题库名称（2-50字符）" required maxlength="50">
        </div>

        <div class="form-group">
            <label class="form-label">题库描述</label>
            <textarea id="description" class="form-input form-textarea" placeholder="请输入题库描述（最多200字符）" maxlength="200"></textarea>
        </div>

        {% if mode == 'edit' %}
        <div class="form-section">
            <div class="form-section-title">公开设置</div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="is_public">
                    <span class="checkbox-text">公开此题库</span>
                </label>
                <p class="form-hint">公开后，所有用户都可在题库广场看到并使用此题库</p>
            </div>

            <div id="publicSettings" class="public-settings">
                <div class="form-group">
                    <label class="form-label">公开描述</label>
                    <textarea id="public_description" class="form-input form-textarea" placeholder="公开展示的描述（可与私人描述不同）"></textarea>
                </div>
                <label class="checkbox-label">
                    <input type="checkbox" id="allow_copy" checked>
                    <span class="checkbox-text">允许其他用户复制题目</span>
                </label>
            </div>
        </div>
        {% endif %}

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">{% if mode == 'add' %}创建题库{% else %}保存修改{% endif %}</button>
            <a href="/user/banks" class="btn btn-secondary">取消</a>
        </div>
    </form>
</div>
{% endblock %}

{% block head %}
<style>
    .form-card {
        max-width: 600px;
    }

    .form-section {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid var(--border-color);
    }

    .form-section-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 16px;
        color: var(--text-color);
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        -webkit-user-select: none;
        user-select: none;
    }

    .checkbox-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--primary);
        cursor: pointer;
    }

    .checkbox-text {
        font-size: 15px;
        color: var(--text-color);
    }

    .form-hint {
        font-size: 12px;
        color: var(--text-sub);
        margin-top: 6px;
        margin-left: 26px;
    }

    .public-settings {
        display: none;
        padding: 16px;
        background: rgba(142, 142, 147, 0.06);
        border-radius: var(--radius-md);
        margin-top: 16px;
        border: 0.5px solid var(--border-color);
    }

    .public-settings.show {
        display: block;
    }

    .public-settings .form-group {
        margin-bottom: 16px;
    }

    .form-actions {
        display: flex;
        gap: 12px;
        margin-top: 32px;
        padding-top: 24px;
        border-top: 1px solid var(--border-color);
    }

    /* ========== 黑夜模式适配 ========== */
    [data-theme="dark"] .form-section {
        border-top-color: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .public-settings {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .form-actions {
        border-top-color: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .form-hint {
        color: rgba(255, 255, 255, 0.5);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const mode = '{{ mode }}';
    const bankId = {{ bank_id if bank_id else 'null' }};

    async function loadBank() {
        if (!bankId) return;

        try {
            const res = await api(`/user/banks/api/${bankId}`);
            const bank = res.data;
            document.getElementById('name').value = bank.name || '';
            document.getElementById('description').value = bank.description || '';

            if (document.getElementById('is_public')) {
                document.getElementById('is_public').checked = bank.is_public;
                document.getElementById('public_description').value = bank.public_description || '';
                document.getElementById('allow_copy').checked = bank.allow_copy !== 0;
                togglePublicSettings();
            }
        } catch (e) {
            showToast(e.message, 'error');
        }
    }

    function togglePublicSettings() {
        const isPublic = document.getElementById('is_public').checked;
        const settings = document.getElementById('publicSettings');
        if (settings) {
            settings.classList.toggle('show', isPublic);
        }
    }

    document.getElementById('bankForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const data = {
            name: document.getElementById('name').value.trim(),
            description: document.getElementById('description').value.trim()
        };

        if (!data.name || data.name.length < 2 || data.name.length > 50) {
            showToast('题库名称需要2-50个字符', 'error');
            return;
        }

        try {
            if (mode === 'add') {
                await api('/user/banks/api', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                showToast('创建成功');
            } else {
                await api(`/user/banks/api/${bankId}`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });

                // 更新公开设置
                if (document.getElementById('is_public')) {
                    await api(`/user/banks/api/${bankId}/public`, {
                        method: 'POST',
                        body: JSON.stringify({
                            is_public: document.getElementById('is_public').checked,
                            public_description: document.getElementById('public_description').value.trim(),
                            allow_copy: document.getElementById('allow_copy').checked
                        })
                    });
                }

                showToast('保存成功');
            }

            setTimeout(() => {
                window.location.href = '/user/banks';
            }, 1000);
        } catch (e) {
            showToast(e.message, 'error');
        }
    });

    if (document.getElementById('is_public')) {
        document.getElementById('is_public').addEventListener('change', togglePublicSettings);
    }

    // 初始化
    loadBank();
</script>
{% endblock %}
