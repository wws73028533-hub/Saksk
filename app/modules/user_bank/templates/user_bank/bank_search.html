{% extends "main/app_shell.html" %}
{% block title %}{{ bank_name }} · 题库内搜索{% endblock %}
{% block page_title %}题库内搜索{% endblock %}
{% block head_extra %}
  <style>
    :root {
      --bg: #f5f5f7;
      --card: rgba(255, 255, 255, 0.78);
      --card-solid: rgba(255, 255, 255, 0.96);
      --text: #1d1d1f;
      --muted: #6e6e73;
      --border: rgba(0, 0, 0, 0.08);
      --shadow: 0 12px 40px rgba(0, 0, 0, 0.06);
      --shadow2: 0 6px 18px rgba(0, 0, 0, 0.05);
      --blur: blur(24px) saturate(180%);
      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 12px;
      --focus: 0 0 0 3px rgba(0, 0, 0, 0.12);
    }
    body.dark-mode {
      --bg: #000000;
      --card: rgba(28, 28, 30, 0.72);
      --card-solid: rgba(28, 28, 30, 0.96);
      --text: #f5f5f7;
      --muted: #a1a1a6;
      --border: rgba(255, 255, 255, 0.14);
      --shadow: 0 18px 60px rgba(0, 0, 0, 0.6);
      --shadow2: 0 10px 30px rgba(0, 0, 0, 0.45);
      --focus: 0 0 0 3px rgba(255, 255, 255, 0.16);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a { color: inherit; text-decoration: none; }
    button, input, select { font-family: inherit; }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      padding: calc(env(safe-area-inset-top) + 10px) 12px 10px;
      background: color-mix(in srgb, var(--bg) 70%, transparent);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      border-bottom: 0.5px solid var(--border);
    }
    .topbar-inner {
      max-width: 980px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      min-width: 0;
    }
    .left { display: flex; align-items: center; gap: 10px; min-width: 0; }
    .back {
      height: 36px;
      padding: 0 12px;
      border-radius: 999px;
      border: 0.5px solid var(--border);
      background: var(--card);
      box-shadow: var(--shadow2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 900;
      cursor: pointer;
    }
    .title {
      font-size: 16px;
      font-weight: 900;
      letter-spacing: -0.3px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 0;
    }
    .nav {
      display: flex;
      align-items: center;
      gap: 8px;
      overflow: auto hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .nav::-webkit-scrollbar { height: 0; }
    .pill, .icon-btn {
      height: 36px;
      padding: 0 12px;
      border-radius: 999px;
      border: 0.5px solid var(--border);
      background: var(--card);
      box-shadow: var(--shadow2);
      font-size: 14px;
      font-weight: 900;
      white-space: nowrap;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      flex: 0 0 auto;
    }
    .pill:hover, .icon-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
    .pill:active, .icon-btn:active { transform: translateY(0); }
    .icon-btn { width: 36px; padding: 0; }
    .icon-btn img { width: 18px; height: 18px; opacity: 0.9; }
    body.dark-mode .icon-btn img { filter: invert(1); opacity: 0.85; }

    .container { max-width: 980px; margin: 0 auto; padding: 14px 12px 34px; }
    .card {
      border-radius: var(--radius-xl);
      background: var(--card);
      border: 0.5px solid var(--border);
      box-shadow: var(--shadow2);
      backdrop-filter: var(--blur);
      -webkit-backdrop-filter: var(--blur);
      padding: 16px;
      margin-top: 12px;
      min-width: 0;
    }
    .card h2 { margin: 0 0 10px; font-size: 16px; font-weight: 900; letter-spacing: -0.2px; }
    .sub { color: var(--muted); font-size: 12px; }

    .search {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }
    .search input {
      height: 42px;
      padding: 0 14px;
      border-radius: var(--radius-md);
      border: 0.5px solid var(--border);
      background: var(--card-solid);
      color: var(--text);
      font-size: 14px;
      outline: none;
      min-width: 0;
    }
    .search input:focus { box-shadow: var(--focus); }
    .btn {
      height: 42px;
      padding: 0 16px;
      border-radius: var(--radius-md);
      border: 0.5px solid var(--border);
      background: rgba(142, 142, 147, 0.12);
      color: var(--text);
      font-size: 14px;
      font-weight: 900;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      white-space: nowrap;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow2); background: rgba(142, 142, 147, 0.18); }
    .btn:active { transform: translateY(0); }
    .btn.primary { background: var(--text); color: var(--bg); border-color: color-mix(in srgb, var(--text) 80%, transparent); }
    body.dark-mode .btn.primary { background: rgba(245, 245, 247, 0.92); color: #000; border-color: rgba(255,255,255,0.18); }

    .filters {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 520px) {
      .filters { grid-template-columns: 1fr; }
    }
    .select {
      height: 42px;
      padding: 0 12px;
      border-radius: var(--radius-md);
      border: 0.5px solid var(--border);
      background: var(--card-solid);
      color: var(--text);
      font-size: 14px;
      outline: none;
      min-width: 0;
    }
    .select:focus { box-shadow: var(--focus); }

    .list { display: grid; gap: 10px; margin-top: 10px; }
    .item {
      border-radius: var(--radius-xl);
      border: 0.5px solid var(--border);
      background: rgba(142, 142, 147, 0.10);
      padding: 14px;
      min-width: 0;
    }
    .item-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      min-width: 0;
    }
    .qtype {
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      flex: 0 0 auto;
    }
    .qid {
      font-size: 12px;
      font-weight: 900;
      color: var(--muted);
      flex: 0 0 auto;
    }
    .content {
      margin-top: 10px;
      font-size: 14px;
      line-height: 1.7;
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-word;
    }
    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .link {
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      border: 0.5px solid var(--border);
      background: rgba(142, 142, 147, 0.10);
      font-size: 13px;
      font-weight: 900;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.15s ease, background 0.15s ease;
      color: var(--text);
    }
    .link:hover { transform: translateY(-1px); background: rgba(142, 142, 147, 0.14); }
    .link:active { transform: translateY(0); }
    .link.primary { background: var(--text); color: var(--bg); border-color: color-mix(in srgb, var(--text) 80%, transparent); }
    body.dark-mode .link.primary { background: rgba(245, 245, 247, 0.92); color: #000; border-color: rgba(255,255,255,0.18); }

    .pager {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 12px;
    }
    .pager .info { font-size: 12px; color: var(--muted); }

    .empty {
      padding: 12px;
      border-radius: var(--radius-lg);
      border: 0.5px dashed var(--border);
      color: var(--muted);
      background: rgba(142, 142, 147, 0.06);
      font-size: 13px;
    }

    .footer {
      margin-top: 20px;
      padding-bottom: env(safe-area-inset-bottom);
      color: var(--muted);
      font-size: 12px;
      text-align: center;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="container">
    <section class="card" aria-label="搜索条件">
      <h2>题库内搜索</h2>
      <div class="sub">范围限定在当前题库，可按题型筛选。</div>

      <div class="search">
        <input id="kw" type="text" value="{{ keyword }}" placeholder="搜索题干/答案/解析/关键词…" autocomplete="off"
               onkeydown="if(event.key==='Enter'){doSearch();}" />
        <button class="btn primary" type="button" onclick="doSearch()">搜索</button>
      </div>

      <div class="filters">
        <select id="typeSel" class="select" onchange="doSearch()">
          <option value="all">全部题型</option>
          {% for t in available_types %}
            <option value="{{ t }}" {% if type_filter == t %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
        <button class="btn" type="button" onclick="goPractice()">回到练习设置</button>
      </div>
    </section>

    <section class="card" aria-label="搜索结果">
      <h2>结果</h2>
      {% if not keyword %}
        <div class="empty">请输入关键词开始搜索。</div>
      {% else %}
        {% if questions and questions|length > 0 %}
          <div class="sub">第 {{ page }} / {{ total_pages }} 页</div>
          <div class="list">
            {% for q in questions %}
              <div class="item">
                <div class="item-head">
                  <div class="qtype">{{ q.q_type }}</div>
                  <div class="qid">#{{ q.id }}</div>
                </div>
                <div class="content">{{ q.content }}</div>
                <div class="actions">
                  <a class="link primary" href="/quiz?bank_id={{ bank_id }}&mode=quiz&type={{ q.q_type|urlencode }}">刷该题型</a>
                  <a class="link" href="/user/banks/{{ bank_id }}/questions/{{ q.id }}/edit">编辑该题</a>
                </div>
              </div>
            {% endfor %}
          </div>

          <div class="pager">
            <div class="info">关键词：{{ keyword }} · 题型：{{ '全部' if type_filter == 'all' else type_filter }}</div>
            <div class="actions">
              {% if page > 1 %}
                <a class="link" href="/user/banks/{{ bank_id }}/search?keyword={{ keyword|urlencode }}&type={{ type_filter|urlencode }}&page={{ page - 1 }}">上一页</a>
              {% endif %}
              {% if page < total_pages %}
                <a class="link" href="/user/banks/{{ bank_id }}/search?keyword={{ keyword|urlencode }}&type={{ type_filter|urlencode }}&page={{ page + 1 }}">下一页</a>
              {% endif %}
            </div>
          </div>
        {% else %}
          <div class="empty">未找到匹配结果，请换个关键词试试。</div>
        {% endif %}
      {% endif %}
    </section>

    <footer class="footer">By: Saksk</footer>
  </div>
{% endblock %}

{% block body_end %}
  <script>
    function applyThemeFromStorage(){
      const saved = localStorage.getItem('theme') || '';
      const preferDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const dark = saved === 'dark' || (!saved && preferDark);
      document.body.classList.toggle('dark-mode', !!dark);
      document.querySelector('meta[name=\"theme-color\"]')?.setAttribute('content', dark ? '#000000' : '#f5f5f7');
    }
    function toggleTheme(){
      const isDark = document.body.classList.toggle('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      document.querySelector('meta[name=\"theme-color\"]')?.setAttribute('content', isDark ? '#000000' : '#f5f5f7');
    }
    applyThemeFromStorage();

    function doSearch(){
      const kw = (document.getElementById('kw')?.value || '').trim();
      const type = (document.getElementById('typeSel')?.value || 'all').trim();
      const params = new URLSearchParams();
      if (kw) params.set('keyword', kw);
      if (type && type !== 'all') params.set('type', type);
      window.location.href = `/user/banks/{{ bank_id }}/search?` + params.toString();
    }
    function goPractice(){
      window.location.href = `/user/banks/{{ bank_id }}/practice`;
    }
  </script>
{% endblock %}
