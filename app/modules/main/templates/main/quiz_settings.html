{% extends "main/app_shell.html" %}
{% block title %}题库设置{% endblock %}
{% block page_title %}设置{% endblock %}
{% block head_extra %}
    <style>
        :root {
            --bg-color: #f5f5f7;
            --card-bg: rgba(255, 255, 255, 0.78);
            --text-color: #111113;
            --text-sub: rgba(17, 17, 19, 0.62);
            --border-color: rgba(0, 0, 0, 0.08);
            --shadow: 0 10px 34px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 16px 46px rgba(0, 0, 0, 0.10);
            --radius-xl: 22px;
            --radius-lg: 16px;
            --radius-md: 14px;
            --radius-sm: 12px;
            --blur: blur(26px) saturate(180%);

            --btn-primary-bg: #111113;
            --btn-primary-fg: #ffffff;
            --btn-primary-border: rgba(17, 17, 19, 0.22);
            --btn-secondary-bg: rgba(255, 255, 255, 0.62);
            --btn-secondary-fg: var(--text-color);
            --btn-secondary-border: var(--border-color);
            --btn-quiet-bg: rgba(0, 0, 0, 0.04);
            --btn-quiet-border: rgba(0, 0, 0, 0.08);

            --switch-off: rgba(0, 0, 0, 0.12);
            --switch-on: rgba(17, 17, 19, 0.86);
            --switch-thumb: rgba(255, 255, 255, 0.95);
        }

        body.dark-mode {
            --bg-color: #000000;
            --card-bg: rgba(28, 28, 30, 0.6);
            --text-color: #f5f5f7;
            --text-sub: rgba(245, 245, 247, 0.64);
            --border-color: rgba(255, 255, 255, 0.14);
            --shadow: 0 18px 52px rgba(0, 0, 0, 0.55);
            --shadow-hover: 0 22px 68px rgba(0, 0, 0, 0.60);

            --btn-primary-bg: rgba(245, 245, 247, 0.92);
            --btn-primary-fg: rgba(0, 0, 0, 0.92);
            --btn-primary-border: rgba(255, 255, 255, 0.24);
            --btn-secondary-bg: rgba(28, 28, 30, 0.72);
            --btn-quiet-bg: rgba(255, 255, 255, 0.06);
            --btn-quiet-border: rgba(255, 255, 255, 0.12);

            --switch-off: rgba(255, 255, 255, 0.18);
            --switch-on: rgba(245, 245, 247, 0.86);
            --switch-thumb: rgba(0, 0, 0, 0.92);
        }

        /* 全局滚动条样式 - 极简风格 */
        * { scrollbar-width: thin; scrollbar-color: transparent transparent; }
        *:hover { scrollbar-color: rgba(128, 128, 128, 0.3) transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: transparent; border-radius: 3px; }
        *:hover::-webkit-scrollbar-thumb { background: rgba(128, 128, 128, 0.3); }
        ::-webkit-scrollbar-thumb:hover { background: rgba(128, 128, 128, 0.5); }
        body.dark-mode ::-webkit-scrollbar-thumb { background: transparent; }
        body.dark-mode *:hover::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); }
        body.dark-mode ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.25); }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            transition: background 0.3s cubic-bezier(0.4, 0, 0.2, 1), color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .main-container {
            max-width: 920px;
            margin: 0 auto;
            padding: 10px 6px 24px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 0 6px;
        }

        .header-title {
            font-size: 20px;
            font-weight: 750;
            letter-spacing: -0.2px;
        }

        .header-sub {
            margin-top: 4px;
            font-size: 13px;
            color: var(--text-sub);
            line-height: 1.5;
        }

        .card {
            background: var(--card-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow);
            padding: 24px;
            min-width: 0;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            margin: 0 0 12px 0;
            letter-spacing: -0.2px;
        }

        .section-sub {
            margin: 0 0 18px 0;
            color: var(--text-sub);
            font-size: 14px;
            line-height: 1.5;
        }

        .setting-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 16px;
            align-items: center;
            padding: 14px 0;
            border-top: 1px solid var(--border-color);
        }

        .setting-row:first-of-type { border-top: none; }

        .setting-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .setting-desc {
            font-size: 13px;
            color: var(--text-sub);
            line-height: 1.4;
        }

        .switch {
            appearance: none;
            -webkit-appearance: none;
            width: 48px;
            height: 28px;
            border-radius: 999px;
            background: var(--switch-off);
            position: relative;
            outline: none;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--switch-thumb);
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
            transition: transform 0.2s ease;
        }

        .switch:checked {
            background: var(--switch-on);
        }

        .switch:checked::after {
            transform: translateX(20px);
        }

        .btn-row {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 18px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            min-width: 90px;
            height: 42px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            border: 1px solid var(--btn-secondary-border);
            background: var(--btn-secondary-bg);
            color: var(--btn-secondary-fg);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            line-height: 1;
            box-sizing: border-box;
            transition: transform 0.15s ease, background 0.15s ease, box-shadow 0.15s ease;
        }

        .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-hover); }
        .btn:active { transform: translateY(0); }

        .btn-primary {
            background: var(--btn-primary-bg);
            border-color: var(--btn-primary-border);
            color: var(--btn-primary-fg);
        }

        .btn-danger {
            background: var(--btn-quiet-bg);
            border-color: var(--btn-quiet-border);
            color: var(--text-color);
        }

        select.btn {
            -webkit-appearance: none;
            appearance: none;
            padding-right: 36px;
            background-image: linear-gradient(45deg, transparent 50%, currentColor 50%), linear-gradient(135deg, currentColor 50%, transparent 50%);
            background-position: calc(100% - 18px) 50%, calc(100% - 13px) 50%;
            background-size: 6px 6px, 6px 6px;
            background-repeat: no-repeat;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.52);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
            padding: 16px;
        }

        .modal-card {
            width: 100%;
            max-height: 80vh;
            overflow: auto;
        }

        .modal-card.modal-card--wide { max-width: 760px; overflow-x: hidden; }
        .modal-card.modal-card--mid { max-width: 720px; }

        .modal-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
        }

        .modal-actions {
            margin-top: 16px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .setting-row.setting-row--wide {
            grid-template-columns: 1fr minmax(200px, 320px);
            gap: 10px;
        }

        .toast {
            position: fixed;
            left: 50%;
            bottom: 18px;
            transform: translateX(-50%);
            background: rgba(17, 17, 19, 0.88);
            color: #fff;
            padding: 10px 14px;
            border-radius: 999px;
            font-size: 13px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-4px);
        }

        @media (max-width: 768px) {
            .main-container { padding: 24px 16px; }
            .header-title { font-size: 18px; }
            .card { padding: 18px; }
            .cards-grid { grid-template-columns: 1fr; }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="main-container">
        <header class="page-header">
            <div>
                <div class="header-title">题库设置</div>
                <div class="header-sub">这些设置会作为默认值应用到首页“开始练习”的选项中。</div>
            </div>
            <a class="btn" href="/user_hub">返回</a>
        </header>

        <div class="cards-grid">
            <section class="card" aria-labelledby="qsSubjectTitle">
                <div class="section-title" id="qsSubjectTitle">题库与科目</div>
                <div class="section-sub">决定首页“选择科目”区域显示哪些科目。</div>

                <div class="setting-row">
                    <div>
                        <div class="setting-name">主页科目显示方式</div>
                        <div class="setting-desc">自定义显示范围，减少无关科目干扰。</div>
                    </div>
                    <button class="btn" onclick="openSubjectModal()">选择</button>
                </div>

                <div class="setting-row">
                    <div>
                        <div class="setting-name">当前显示</div>
                        <div class="setting-desc" id="subjectSummary">全部科目</div>
                    </div>
                    <button class="btn" onclick="clearSubjectFilter()">显示全部</button>
                </div>
            </section>

            <section class="card" aria-labelledby="qsExperienceTitle">
                <div class="section-title" id="qsExperienceTitle">答题体验</div>
                <div class="section-sub">这些选项会影响刷题与考试页面的交互与布局。</div>

                <div class="setting-row">
                    <div>
                        <div class="setting-name">答题悬浮球</div>
                        <div class="setting-desc">在刷题/背题页面显示快捷菜单（可拖动）。考试进行中会自动隐藏。</div>
                    </div>
                    <input type="checkbox" class="switch" id="toggleQuizFab" />
                </div>

                <div class="setting-row">
                    <div>
                        <div class="setting-name">答题布局主题</div>
                        <div class="setting-desc">传统布局更紧凑；卡片布局更清晰。</div>
                    </div>
                    <select class="btn" id="quizLayoutTheme" style="min-width: 140px;">
                        <option value="traditional">传统布局</option>
                        <option value="card">卡片布局</option>
                    </select>
                </div>
            </section>

            <section class="card" aria-labelledby="qsHotkeyTitle">
                <div class="section-title" id="qsHotkeyTitle">快捷键</div>
                <div class="section-sub">为键盘刷题/考试配置常用操作，提高效率。</div>

                <div class="setting-row">
                    <div>
                        <div class="setting-name">答题界面键盘快捷键</div>
                        <div class="setting-desc">支持组合键：上一题/下一题、收藏、选项选择、填空挖空切换、提交。</div>
                    </div>
                    <button class="btn btn-primary" onclick="openHotkeyModal()">配置</button>
                </div>
            </section>

            <section class="card" aria-labelledby="qsActionsTitle">
                <div class="section-title" id="qsActionsTitle">同步与操作</div>
                <div class="section-sub">切换会立即生效；保存可触发云端同步（已登录）。</div>

                <div class="btn-row" style="margin-top: 4px;">
                    <button class="btn btn-danger" onclick="resetDefaults()">恢复默认</button>
                    <button class="btn btn-primary" onclick="saveSettings()">保存设置</button>
                </div>
            </section>
        </div>
    </div>

    <!-- 快捷键设置弹层 -->
    <div class="modal-overlay" id="hotkeyModal" role="dialog" aria-modal="true" aria-labelledby="hotkeyModalTitle">
        <div class="card modal-card modal-card--wide" role="document">
            <div class="modal-header">
                <div>
                    <div class="section-title" id="hotkeyModalTitle" style="margin:0;">答题界面键盘快捷键</div>
                    <div class="section-sub" style="margin:8px 0 0 0;">点击输入框后按下组合键（如 Ctrl+Shift+N）。按 Backspace/Delete 清空。与浏览器/系统冲突的组合键可能无法生效。</div>
                </div>
                <button class="btn" onclick="closeHotkeyModal()">关闭</button>
            </div>

            <div class="modal-actions">
                <button class="btn" onclick="resetHotkeysToDefault()">恢复默认</button>
                <button class="btn btn-primary" onclick="applyHotkeys()">应用</button>
            </div>

            <div id="hotkeyList" style="margin-top:12px;"></div>
        </div>
    </div>

    <!-- 科目选择弹层 -->
    <div class="modal-overlay" id="subjectModal" role="dialog" aria-modal="true" aria-labelledby="subjectModalTitle">
        <div class="card modal-card modal-card--mid" role="document">
            <div class="modal-header">
                <div>
                    <div class="section-title" id="subjectModalTitle" style="margin:0;">选择首页显示科目</div>
                    <div class="section-sub" style="margin:8px 0 0 0;">不选任何项等同于“显示全部”。</div>
                </div>
                <button class="btn" onclick="closeSubjectModal()">关闭</button>
            </div>

            <div class="modal-actions">
                <button class="btn" onclick="selectAllSubjectsInModal()">全选</button>
                <button class="btn" onclick="clearAllSubjectsInModal()">全不选</button>
                <button class="btn btn-primary" onclick="applySubjectSelection()">应用</button>
            </div>

            <div id="subjectList" style="margin-top:16px;"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

{% endblock %}

{% block body_end %}
    <script>
        const HOME_VISIBLE_SUBJECTS_KEY = 'home_visible_subjects';
        const SETTINGS_SYNC_KEY = 'user_settings_v1';

        function showToast(text){
            const t = document.getElementById('toast');
            if (!t) return;
            t.textContent = text;
            t.classList.add('show');
            clearTimeout(t._timer);
            t._timer = setTimeout(()=>t.classList.remove('show'), 1600);
        }

        function getVisibleSubjects(){
            try {
                const arr = JSON.parse(localStorage.getItem(HOME_VISIBLE_SUBJECTS_KEY) || '[]');
                return Array.isArray(arr) ? arr : [];
            } catch(e) { return []; }
        }

        function setVisibleSubjects(arr){
            localStorage.setItem(HOME_VISIBLE_SUBJECTS_KEY, JSON.stringify(Array.isArray(arr) ? arr : []));
        }

        function updateSubjectSummary(){
            const el = document.getElementById('subjectSummary');
            if (!el) return;
            const arr = getVisibleSubjects();
            if (!arr.length) {
                el.textContent = '全部科目';
                return;
            }
            el.textContent = arr.length <= 6 ? arr.join('、') : `${arr.slice(0, 6).join('、')} 等 ${arr.length} 个科目`;
        }

        async function fetchAllSubjects(){
            try {
                const res = await fetch('/api/subjects');
                const js = await res.json();
                if (res.ok && js && js.status === 'success') return js.subjects || [];
            } catch(e) {}
            return [];
        }

        async function openSubjectModal(){
            const modal = document.getElementById('subjectModal');
            const list = document.getElementById('subjectList');
            if (!modal || !list) return;

            const all = await fetchAllSubjects();
            const selected = new Set(getVisibleSubjects());

            if (!all.length) {
                showToast('未找到科目');
                return;
            }

            list.innerHTML = all.map(name => {
                const checked = selected.has(name) ? 'checked' : '';
                return `
                    <label style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0; border-top:0.5px solid var(--border-color);">
                        <span style="font-weight:600;">${escapeHtml(name)}</span>
                        <input type="checkbox" class="switch" style="transform: scale(0.9);" data-subject="${escapeHtmlAttr(name)}" ${checked} />
                    </label>
                `;
            }).join('');

            modal.style.display = 'flex';
        }

        function closeSubjectModal(){
            const modal = document.getElementById('subjectModal');
            if (modal) modal.style.display = 'none';
        }

        function selectAllSubjectsInModal(){
            document.querySelectorAll('#subjectList input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function clearAllSubjectsInModal(){
            document.querySelectorAll('#subjectList input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        async function applySubjectSelection(){
            const checked = Array.from(document.querySelectorAll('#subjectList input[type="checkbox"]'))
                .filter(cb => cb.checked)
                .map(cb => cb.dataset.subject)
                .filter(Boolean);
            setVisibleSubjects(checked);

            const ts = Date.now();
            localStorage.setItem('settings_updated_at', String(ts));

            updateSubjectSummary();
            closeSubjectModal();

            await syncSettingsToServer();
            showToast('已应用');
        }

        async function clearSubjectFilter(){
            if (!confirm('确定要显示全部科目吗？')) return;
            setVisibleSubjects([]);

            const ts = Date.now();
            localStorage.setItem('settings_updated_at', String(ts));

            updateSubjectSummary();
            await syncSettingsToServer();
            showToast('已设置为显示全部');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        function escapeHtmlAttr(text){
            return String(text || '').replaceAll('&','&amp;').replaceAll('"','&quot;').replaceAll("'",'&#39;').replaceAll('<','&lt;').replaceAll('>','&gt;');
        }

        const QUIZ_HOTKEYS_KEY = 'quiz_hotkeys_v1';
        const QUIZ_FAB_ENABLED_KEY = 'quiz_fab_enabled_v1';
        const QUIZ_LAYOUT_THEME_KEY = 'quiz_layout_theme_v1';

        const DEFAULT_QUIZ_HOTKEYS = {
            // 导航
            prev_question: 'ArrowLeft',
            next_question: 'ArrowRight',
            // 收藏
            toggle_favorite: 'KeyF',
            // 选项选择（选择/判断）
            choose_option_1: 'Digit1',
            choose_option_2: 'Digit2',
            choose_option_3: 'Digit3',
            choose_option_4: 'Digit4',
            // 填空题：切换挖空（当 input 聚焦时）
            blank_prev: 'ArrowUp',
            blank_next: 'ArrowDown',
            // 提交/查看结果/下一题（原 Enter 行为）
            submit_or_next: 'Enter'
        };

        function normalizeHotkeyString(str){
            return String(str || '').trim();
        }

        function getHotkeys(){
            try {
                const js = JSON.parse(localStorage.getItem(QUIZ_HOTKEYS_KEY) || 'null');
                if (!js || typeof js !== 'object') return { ...DEFAULT_QUIZ_HOTKEYS };
                
                // 合并用户设置，但保留空字符串（表示用户清空了该快捷键，应该禁用）
                const result = { ...DEFAULT_QUIZ_HOTKEYS };
                for (const key in js) {
                    if (key in DEFAULT_QUIZ_HOTKEYS) {
                        // 如果用户设置的值是空字符串，保留空字符串（禁用该快捷键）
                        // 如果用户设置了有效值，使用用户的值
                        // 如果用户没有设置（undefined），使用默认值
                        if (js[key] !== undefined) {
                            result[key] = js[key];
                        }
                    }
                }
                return result;
            } catch(e) {
                return { ...DEFAULT_QUIZ_HOTKEYS };
            }
        }

        function setHotkeys(obj){
            // 合并用户设置，保留空字符串（表示用户清空了该快捷键，应该禁用）
            const merged = { ...DEFAULT_QUIZ_HOTKEYS };
            if (obj && typeof obj === 'object') {
                for (const key in obj) {
                    if (key in DEFAULT_QUIZ_HOTKEYS) {
                        // 保留用户设置的值（包括空字符串），这样可以在答题页面区分"未设置"和"已清空"
                        merged[key] = obj[key];
                    }
                }
            }
            localStorage.setItem(QUIZ_HOTKEYS_KEY, JSON.stringify(merged));
        }

        function isMac(){
            return /Mac|iPhone|iPad|iPod/i.test(navigator.platform);
        }

        function hotkeyToDisplay(hk){
            const s = normalizeHotkeyString(hk);
            if (!s) return '';
            // 兼容我们存储的格式："Ctrl+Shift+KeyN" 或 "KeyF"/"ArrowLeft"/"Enter"
            const parts = s.split('+').filter(Boolean);
            const pretty = parts.map(p => {
                if (p === 'Meta') return isMac() ? '⌘' : 'Win';
                if (p === 'Ctrl') return isMac() ? '⌃' : 'Ctrl';
                if (p === 'Alt') return isMac() ? '⌥' : 'Alt';
                if (p === 'Shift') return isMac() ? '⇧' : 'Shift';
                if (p === ' ') return 'Space';
                if (p.startsWith('Key')) return p.slice(3).toUpperCase();
                if (p.startsWith('Digit')) return p.slice(5);
                if (p === 'ArrowLeft') return '←';
                if (p === 'ArrowRight') return '→';
                if (p === 'ArrowUp') return '↑';
                if (p === 'ArrowDown') return '↓';
                return p;
            });
            return pretty.join('+');
        }

        function buildHotkeyToken(e){
            const mods = [];
            if (e.ctrlKey) mods.push('Ctrl');
            if (e.altKey) mods.push('Alt');
            if (e.shiftKey) mods.push('Shift');
            if (e.metaKey) mods.push('Meta');

            // 只按修饰键不记录
            const code = e.code || '';
            const isModifierOnly = ['ShiftLeft','ShiftRight','ControlLeft','ControlRight','AltLeft','AltRight','MetaLeft','MetaRight'].includes(code);
            if (isModifierOnly) return '';

            // Space 特殊处理
            const keyCode = (code === 'Space') ? ' ' : code;
            if (!keyCode) return '';

            return mods.length ? `${mods.join('+')}+${keyCode}` : keyCode;
        }

        const HOTKEY_DEFS = [
            { key: 'prev_question', label: '上一题', desc: '切换到上一题' },
            { key: 'next_question', label: '下一题', desc: '切换到下一题' },
            { key: 'toggle_favorite', label: '收藏/取消收藏', desc: '切换题目收藏状态' },
            { key: 'choose_option_1', label: '选择选项 1', desc: '选择题/判断题：选第 1 个选项（A/对）' },
            { key: 'choose_option_2', label: '选择选项 2', desc: '选择题：选第 2 个选项（B/错）' },
            { key: 'choose_option_3', label: '选择选项 3', desc: '选择题：选第 3 个选项（C）' },
            { key: 'choose_option_4', label: '选择选项 4', desc: '选择题：选第 4 个选项（D）' },
            { key: 'blank_prev', label: '填空上一个挖空', desc: '填空题输入框：聚焦时切到上一个空' },
            { key: 'blank_next', label: '填空下一个挖空', desc: '填空题输入框：聚焦时切到下一个空' },
            { key: 'submit_or_next', label: '提交/查看结果/下一题', desc: '等同原 Enter 行为（避免与输入换行冲突）' }
        ];

        function openHotkeyModal(){
            const modal = document.getElementById('hotkeyModal');
            const list = document.getElementById('hotkeyList');
            if (!modal || !list) return;

            const hk = getHotkeys();
            list.innerHTML = HOTKEY_DEFS.map(def => {
                const value = hk[def.key] || '';
                return `
                    <div class="setting-row setting-row--wide">
                        <div>
                            <div class="setting-name">${escapeHtml(def.label)}</div>
                            <div class="setting-desc">${escapeHtml(def.desc)}</div>
                        </div>
                        <input
                            class="btn"
                            style="width:100%; text-align:left; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"
                            data-hotkey-key="${escapeHtmlAttr(def.key)}"
                            value="${escapeHtmlAttr(hotkeyToDisplay(value) || '点击录入')}"
                            readonly
                            onclick="this.focus()"
                            aria-label="设置 ${escapeHtmlAttr(def.label)} 快捷键"
                        />
                    </div>
                `;
            }).join('');

            // 绑定录入
            list.querySelectorAll('input[data-hotkey-key]').forEach(inp => {
                inp.addEventListener('keydown', (e)=>{
                    e.preventDefault();
                    e.stopPropagation();

                    const k = inp.dataset.hotkeyKey;
                    if (!k) return;

                    if (e.key === 'Backspace' || e.key === 'Delete') {
                        inp.dataset.hotkeyValue = '';
                        inp.value = '已清空（点此重新录入）';
                        return;
                    }

                    const token = buildHotkeyToken(e);
                    if (!token) return;

                    inp.dataset.hotkeyValue = token;
                    inp.value = hotkeyToDisplay(token);
                });

                // 初始化 dataset（保存原始 token）
                inp.dataset.hotkeyValue = hk[inp.dataset.hotkeyKey] || '';
            });

            modal.style.display = 'flex';
            // 滚动到设置区（用户要求点击后进入键盘快捷键设置区）
            setTimeout(()=>{ modal.querySelector('.card')?.scrollTo({ top: 0, behavior: 'smooth' }); }, 0);
        }

        function closeHotkeyModal(){
            const modal = document.getElementById('hotkeyModal');
            if (modal) modal.style.display = 'none';
        }

        function applyHotkeys(){
            const list = document.getElementById('hotkeyList');
            if (!list) return;
            const obj = {};
            list.querySelectorAll('input[data-hotkey-key]').forEach(inp => {
                const k = inp.dataset.hotkeyKey;
                obj[k] = normalizeHotkeyString(inp.dataset.hotkeyValue || '');
            });
            setHotkeys(obj);

            const ts = Date.now();
            localStorage.setItem('settings_updated_at', String(ts));
            syncSettingsToServer();
            showToast('快捷键已应用');
            closeHotkeyModal();
        }

        function resetHotkeysToDefault(){
            if (!confirm('确定要恢复默认快捷键吗？')) return;
            setHotkeys({ ...DEFAULT_QUIZ_HOTKEYS });
            openHotkeyModal();
        }

        // 点击遮罩关闭（快捷键弹层）
        (function(){
            const modal = document.getElementById('hotkeyModal');
            if (modal) {
                modal.addEventListener('click', function(e){
                    if (e.target === modal) closeHotkeyModal();
                });
            }
        })();

        function isQuizFabEnabled(){
            return localStorage.getItem(QUIZ_FAB_ENABLED_KEY) !== '0';
        }
        function setQuizFabEnabled(on){
            localStorage.setItem(QUIZ_FAB_ENABLED_KEY, on ? '1' : '0');
        }
        
        function getQuizLayoutTheme(){
            return localStorage.getItem(QUIZ_LAYOUT_THEME_KEY) || 'traditional';
        }
        function setQuizLayoutTheme(theme){
            localStorage.setItem(QUIZ_LAYOUT_THEME_KEY, theme);
        }

        function collectSettings(){
            return {
                version: 1,
                home_visible_subjects: getVisibleSubjects(),
                quiz_hotkeys_v1: getHotkeys(),
                quiz_fab_enabled_v1: isQuizFabEnabled(),
                quiz_layout_theme_v1: getQuizLayoutTheme(),
                updated_at: Date.now()
            };
        }

        function applySettingsToUI(){
            updateSubjectSummary();

            // 悬浮球开关
            const fabToggle = document.getElementById('toggleQuizFab');
            if (fabToggle) {
                fabToggle.checked = isQuizFabEnabled();
                fabToggle.onchange = async function(){
                    setQuizFabEnabled(!!fabToggle.checked);
                    const ts = Date.now();
                    localStorage.setItem('settings_updated_at', String(ts));
                    await syncSettingsToServer();
                    showToast(fabToggle.checked ? '已开启悬浮球' : '已关闭悬浮球');
                };
            }
            
            // 布局主题选择
            const layoutThemeSelect = document.getElementById('quizLayoutTheme');
            if (layoutThemeSelect) {
                layoutThemeSelect.value = getQuizLayoutTheme();
                layoutThemeSelect.onchange = async function(){
                    setQuizLayoutTheme(layoutThemeSelect.value);
                    const ts = Date.now();
                    localStorage.setItem('settings_updated_at', String(ts));
                    await syncSettingsToServer();
                    showToast(layoutThemeSelect.value === 'card' ? '已切换到卡片布局' : '已切换到传统布局');
                };
            }
        }

        function loadSettings(){
            applySettingsToUI();
        }

        async function syncSettingsToServer(){
            try {
                const payload = collectSettings();
                await fetch('/api/progress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key: SETTINGS_SYNC_KEY, data: payload })
                });
            } catch(e) {
                // 忽略网络错误，保持本地可用
            }
        }

        async function loadSettingsFromServerAndMerge(){
            try {
                const res = await fetch(`/api/progress?key=${encodeURIComponent(SETTINGS_SYNC_KEY)}`);
                if (!res.ok) return;
                const js = await res.json();
                if (!js || js.status !== 'success' || !js.data) return;

                const remote = js.data || {};
                const remoteTs = Number(remote.updated_at || 0);

                // 本地 settings_ts（不存在则 0）
                const localTs = Number(localStorage.getItem('settings_updated_at') || '0');

                // 冲突策略：谁的 updated_at 新，就用谁
                if (remoteTs > localTs) {
                    // 应用远端到本地
                    setVisibleSubjects(Array.isArray(remote.home_visible_subjects) ? remote.home_visible_subjects : []);
                    if (remote.quiz_hotkeys_v1 && typeof remote.quiz_hotkeys_v1 === 'object') {
                        setHotkeys(remote.quiz_hotkeys_v1);
                    }
                    if (typeof remote.quiz_fab_enabled_v1 !== 'undefined') {
                        setQuizFabEnabled(!!remote.quiz_fab_enabled_v1);
                    }
                    if (typeof remote.quiz_layout_theme_v1 === 'string') {
                        setQuizLayoutTheme(remote.quiz_layout_theme_v1 === 'card' ? 'card' : 'traditional');
                    }
                    localStorage.setItem('settings_updated_at', String(remoteTs));
                } else if (localTs > remoteTs) {
                    // 本地较新，推送到云端
                    await syncSettingsToServer();
                }
            } catch(e) {
                // 忽略
            }
        }

        async function saveSettings(){
            const ts = Date.now();
            localStorage.setItem('settings_updated_at', String(ts));

            // 同步到云端（登录用户才会成功；未登录会 401，被忽略）
            await syncSettingsToServer();
            showToast('已保存');
        }

        async function resetDefaults(){
            if (!confirm('确定要恢复默认设置吗？')) return;
            setVisibleSubjects([]);
            setHotkeys({ ...DEFAULT_QUIZ_HOTKEYS });
            setQuizFabEnabled(true);
            setQuizLayoutTheme('traditional');

            const ts = Date.now();
            localStorage.setItem('settings_updated_at', String(ts));

            loadSettings();
            await syncSettingsToServer();
            showToast('已恢复默认');
        }

        // 点击遮罩关闭
        (function(){
            const modal = document.getElementById('subjectModal');
            if (modal) {
                modal.addEventListener('click', function(e){
                    if (e.target === modal) closeSubjectModal();
                });
            }
        })();

        // 登录用户：尝试从云端拉取并与本地合并（跨设备）
        loadSettingsFromServerAndMerge().finally(()=>{
            loadSettings();
        });
    </script>
{% endblock %}
