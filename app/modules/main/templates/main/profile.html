<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>è´¦å·ç®¡ç† - å…¨èƒ½åˆ·é¢˜åº“</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Crect width='128' height='128' rx='24' fill='%23007bff'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='88' fill='white'%3EQ%3C/text%3E%3C/svg%3E">
    <style>
        :root {
            --bg-color: #fafafa;
            --card-bg: rgba(255, 255, 255, 0.75);
            --card-bg-solid: rgba(255, 255, 255, 0.95);
            --text-color: #1d1d1f;
            --text-sub: #86868b;
            --border-color: rgba(0, 0, 0, 0.08);
            --primary: #007AFF;
            --primary-light: rgba(0, 122, 255, 0.12);
            --shadow: 0 2px 16px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-hover: 0 4px 24px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.06);
            --success: #34c759;
            --danger: #ff3b30;
            --blur: blur(60px) saturate(200%);
        }

        body.dark-mode {
            --bg-color: #000000;
            --card-bg: rgba(28, 28, 30, 0.6);
            --card-bg-solid: rgba(28, 28, 30, 0.95);
            --text-color: #f5f5f7;
            --text-sub: #a1a1a6;
            --border-color: rgba(255, 255, 255, 0.12);
            --primary: #0a84ff;
            --primary-light: rgba(10, 132, 255, 0.2);
            --shadow: 0 2px 16px rgba(0, 0, 0, 0.5), 0 1px 2px rgba(0, 0, 0, 0.4);
            --shadow-hover: 0 4px 24px rgba(0, 0, 0, 0.6), 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* å…¨å±€æ»šåŠ¨æ¡æ ·å¼ - æç®€é£æ ¼ */
        * { scrollbar-width: thin; scrollbar-color: transparent transparent; }
        *:hover { scrollbar-color: rgba(128, 128, 128, 0.3) transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: transparent; border-radius: 3px; }
        *:hover::-webkit-scrollbar-thumb { background: rgba(128, 128, 128, 0.3); }
        ::-webkit-scrollbar-thumb:hover { background: rgba(128, 128, 128, 0.5); }
        body.dark-mode ::-webkit-scrollbar-thumb { background: transparent; }
        body.dark-mode *:hover::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); }
        body.dark-mode ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.25); }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            transition: background-color .3s ease, color .3s ease;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        body::after, body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
            transition: opacity .3s ease;
        }
        body::after { background: linear-gradient(180deg, #ffffff 0%, #fafafa 30%, #f5f5f7 70%, #f0f0f2 100%); }
        body::before { background: linear-gradient(180deg, #1c1c1e 0%, #000000 40%, #000000 100%); opacity: 0; }
        body.dark-mode::before { opacity: 1; }
        body.dark-mode::after { opacity: 0; }

        .main-container { max-width: 800px; margin: 0 auto; padding: 40px 20px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
        .header-title { font-size: 36px; font-weight: 700; letter-spacing: -0.8px; }

        .card {
            background: var(--card-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            padding: 32px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.8);
            margin-bottom: 24px;
        }
        body.dark-mode .card { background: rgba(28, 28, 30, 0.65); border: 1px solid rgba(255, 255, 255, 0.1); }

        .card h2 { margin-top: 0; font-size: 24px; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 16px; margin-bottom: 24px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 500; color: var(--text-sub); margin-bottom: 8px; font-size: 14px; }
        
        .main-input {
            width: 100%;
            padding: 12px 16px;
            border: 0.5px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            background: var(--card-bg-solid);
            color: var(--text-color);
            box-sizing: border-box;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
        }
        .main-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { opacity: 0.85; }
        .btn-secondary { background: rgba(142, 142, 147, 0.15); color: var(--text-color); }
        .btn-secondary:hover { background: rgba(142, 142, 147, 0.25); }

        .actions { display: flex; justify-content: flex-start; gap: 12px; margin-top: 24px; }
        .message { margin-top: 16px; padding: 12px 16px; border-radius: 12px; font-size: 15px; display: none; }
        .message.success { background: rgba(52, 199, 89, 0.1); color: var(--success); border: 0.5px solid rgba(52, 199, 89, 0.3); }
        .message.error { background: rgba(255, 59, 48, 0.1); color: var(--danger); border: 0.5px solid rgba(255, 59, 48, 0.3); }

        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }

        @media (max-width: 768px) {
            .main-container { padding: 24px 16px; }
            .header-title { font-size: 28px; }
            .card { padding: 24px; }
            .grid-layout { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <main class="container main-container">
        <header class="page-header">
            <h1 class="header-title">è´¦å·ç®¡ç†</h1>
            <a href="/user_hub" class="btn btn-secondary">â† è¿”å›</a>
        </header>

        <div class="grid-layout">
            <div class="card">
                <h2 id="passwordTitle">ğŸ”’ ä¿®æ”¹å¯†ç </h2>
                <form id="passwordForm">
                    <div class="form-group" id="currentPasswordGroup">
                        <label for="current_password">å½“å‰å¯†ç </label>
                        <input type="password" id="current_password" name="current_password" class="main-input">
                    </div>
                    <div class="form-group">
                        <label for="new_password" id="newPasswordLabel">æ–°å¯†ç </label>
                        <input type="password" id="new_password" name="new_password" class="main-input" placeholder="è‡³å°‘8ä½ï¼Œå«æ•°å­—ä¸å­—æ¯" required>
                    </div>
                    <div class="form-group">
                        <label for="confirm_password" id="confirmPasswordLabel">ç¡®è®¤æ–°å¯†ç </label>
                        <input type="password" id="confirm_password" name="confirm_password" class="main-input" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " required>
                    </div>
                    <div class="actions">
                        <button type="submit" class="btn btn-primary" id="passwordSubmitBtn">ğŸ”„ æäº¤ä¿®æ”¹</button>
                    </div>
                    <div id="pwdMsg" class="message"></div>
                </form>
            </div>

            <div class="card">
                <h2>ğŸ”— ç»‘å®šè®¾ç½®</h2>
                <div class="form-group">
                    <p><strong>ğŸ“§ é‚®ç®±:</strong> 
                        <span id="emailDisplay">åŠ è½½ä¸­...</span> 
                        <a href="#" id="bindEmailLink" style="color: var(--primary); text-decoration: none; margin-left: 8px;">å»ç»‘å®š</a>
                    </p>
                    <p><strong>ğŸ“± æ‰‹æœºå·:</strong> <span>æœªç»‘å®š</span> <a href="#" onclick="return false;" style="opacity: 0.5;">å»ç»‘å®š</a></p>
                </div>
                
                <!-- é‚®ç®±ç»‘å®šè¡¨å•ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                <div id="emailBindForm" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <div class="form-group">
                        <label for="bindEmailInput">é‚®ç®±åœ°å€</label>
                        <input type="email" id="bindEmailInput" class="main-input" placeholder="è¯·è¾“å…¥é‚®ç®±åœ°å€" required>
                    </div>
                    <div class="form-group">
                        <label for="bindCodeInput">éªŒè¯ç </label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="bindCodeInput" class="main-input" placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç " maxlength="6" style="flex: 1;">
                            <button type="button" id="sendCodeBtn" class="btn btn-secondary" style="white-space: nowrap;">å‘é€éªŒè¯ç </button>
                        </div>
                    </div>
                    <div class="actions">
                        <button type="button" id="submitBindBtn" class="btn btn-primary">ç¡®è®¤ç»‘å®š</button>
                        <button type="button" id="cancelBindBtn" class="btn btn-secondary">å–æ¶ˆ</button>
                    </div>
                    <div id="emailBindMsg" class="message"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
            }
        });

        // åŠ è½½ç”¨æˆ·é‚®ç®±ä¿¡æ¯
        async function loadEmailInfo() {
            try {
                const res = await fetch('/api/profile');
                if (!res.ok) throw new Error('åŠ è½½å¤±è´¥');
                const d = await res.json();
                if (d.status !== 'success') throw new Error(d.message || 'åŠ è½½å¤±è´¥');
                
                const emailDisplay = document.getElementById('emailDisplay');
                const bindEmailLink = document.getElementById('bindEmailLink');
                
                if (d.data.email) {
                    emailDisplay.textContent = d.data.email + (d.data.email_verified ? ' âœ“' : ' (æœªéªŒè¯)');
                    bindEmailLink.textContent = 'æ›´æ¢';
                } else {
                    emailDisplay.textContent = 'æœªç»‘å®š';
                    bindEmailLink.textContent = 'å»ç»‘å®š';
                }
            } catch (err) {
                document.getElementById('emailDisplay').textContent = 'åŠ è½½å¤±è´¥';
            }
        }
        
        // é‚®ç®±ç»‘å®šç›¸å…³
        let countdownTimer = null;
        let countdownSeconds = 0;
        
        function showEmailMessage(text, type) {
            const msg = document.getElementById('emailBindMsg');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.style.display = 'block';
        }
        
        function updateCountdown() {
            const btn = document.getElementById('sendCodeBtn');
            if (countdownSeconds > 0) {
                btn.textContent = `${countdownSeconds}ç§’åé‡å‘`;
                btn.disabled = true;
                countdownSeconds--;
                countdownTimer = setTimeout(updateCountdown, 1000);
            } else {
                btn.textContent = 'å‘é€éªŒè¯ç ';
                btn.disabled = false;
            }
        }
        
        document.getElementById('bindEmailLink').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('emailBindForm').style.display = 'block';
            document.getElementById('bindEmailInput').focus();
        });
        
        document.getElementById('cancelBindBtn').addEventListener('click', () => {
            document.getElementById('emailBindForm').style.display = 'none';
            document.getElementById('bindEmailInput').value = '';
            document.getElementById('bindCodeInput').value = '';
            document.getElementById('emailBindMsg').style.display = 'none';
            if (countdownTimer) {
                clearTimeout(countdownTimer);
                countdownTimer = null;
            }
            countdownSeconds = 0;
            document.getElementById('sendCodeBtn').textContent = 'å‘é€éªŒè¯ç ';
            document.getElementById('sendCodeBtn').disabled = false;
        });
        
        document.getElementById('sendCodeBtn').addEventListener('click', async () => {
            const email = document.getElementById('bindEmailInput').value.trim();
            if (!email) {
                showEmailMessage('è¯·è¾“å…¥é‚®ç®±åœ°å€', 'error');
                return;
            }
            
            // ç®€å•çš„é‚®ç®±æ ¼å¼éªŒè¯
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showEmailMessage('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/email/send-bind-code', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({ email: email })
                });
                const d = await res.json();
                
                if (!res.ok) {
                    // è¯·æ±‚å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    const errorMsg = d.message || 'å‘é€å¤±è´¥';
                    console.error('å‘é€éªŒè¯ç å¤±è´¥:', d);
                    showEmailMessage('âŒ ' + errorMsg, 'error');
                    return;
                }
                
                if (d.status === 'success') {
                    showEmailMessage('âœ… éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶é‚®ä»¶', 'success');
                    countdownSeconds = 60;
                    updateCountdown();
                } else {
                    showEmailMessage('âŒ ' + (d.message || 'å‘é€å¤±è´¥'), 'error');
                }
            } catch (err) {
                console.error('å‘é€éªŒè¯ç å¼‚å¸¸:', err);
                showEmailMessage('âŒ å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•: ' + err.message, 'error');
            }
        });
        
        document.getElementById('submitBindBtn').addEventListener('click', async () => {
            const email = document.getElementById('bindEmailInput').value.trim();
            const code = document.getElementById('bindCodeInput').value.trim();
            
            if (!email) {
                showEmailMessage('è¯·è¾“å…¥é‚®ç®±åœ°å€', 'error');
                return;
            }
            if (!code || code.length !== 6) {
                showEmailMessage('è¯·è¾“å…¥6ä½éªŒè¯ç ', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/email/bind', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({ email: email, code: code })
                });
                const d = await res.json();
                
                if (d.status === 'success') {
                    showEmailMessage('âœ… é‚®ç®±ç»‘å®šæˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        document.getElementById('emailBindForm').style.display = 'none';
                        document.getElementById('bindEmailInput').value = '';
                        document.getElementById('bindCodeInput').value = '';
                        loadEmailInfo(); // é‡æ–°åŠ è½½é‚®ç®±ä¿¡æ¯
                    }, 1500);
                } else {
                    showEmailMessage('âŒ ' + (d.message || 'ç»‘å®šå¤±è´¥'), 'error');
                }
            } catch (err) {
                showEmailMessage('âŒ ç»‘å®šå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        });

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦è®¾ç½®å¯†ç 
        let needsPasswordSet = false;
        async function loadUserPasswordStatus() {
            try {
                const res = await fetch('/api/profile');
                if (!res.ok) throw new Error('åŠ è½½å¤±è´¥');
                const d = await res.json();
                if (d.status !== 'success') throw new Error(d.message || 'åŠ è½½å¤±è´¥');
                
                needsPasswordSet = !d.data.has_password_set;
                
                // æ ¹æ®æ˜¯å¦éœ€è¦è®¾ç½®å¯†ç æ›´æ–°UI
                if (needsPasswordSet) {
                    // è®¾ç½®å¯†ç æ¨¡å¼
                    document.getElementById('passwordTitle').textContent = 'ğŸ”’ è®¾ç½®å¯†ç ';
                    document.getElementById('currentPasswordGroup').style.display = 'none';
                    document.getElementById('current_password').required = false;
                    document.getElementById('newPasswordLabel').textContent = 'å¯†ç ';
                    document.getElementById('confirmPasswordLabel').textContent = 'ç¡®è®¤å¯†ç ';
                    document.getElementById('passwordSubmitBtn').textContent = 'âœ… è®¾ç½®å¯†ç ';
                } else {
                    // ä¿®æ”¹å¯†ç æ¨¡å¼
                    document.getElementById('passwordTitle').textContent = 'ğŸ”’ ä¿®æ”¹å¯†ç ';
                    document.getElementById('currentPasswordGroup').style.display = 'block';
                    document.getElementById('current_password').required = true;
                    document.getElementById('newPasswordLabel').textContent = 'æ–°å¯†ç ';
                    document.getElementById('confirmPasswordLabel').textContent = 'ç¡®è®¤æ–°å¯†ç ';
                    document.getElementById('passwordSubmitBtn').textContent = 'ğŸ”„ æäº¤ä¿®æ”¹';
                }
            } catch (err) {
                console.error('[è´¦å·ç®¡ç†] åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', err);
                // å‡ºé”™æ—¶é»˜è®¤æ˜¾ç¤ºä¿®æ”¹å¯†ç æ¨¡å¼ï¼ˆå®‰å…¨èµ·è§ï¼‰
                document.getElementById('passwordTitle').textContent = 'ğŸ”’ ä¿®æ”¹å¯†ç ';
                document.getElementById('currentPasswordGroup').style.display = 'block';
                document.getElementById('current_password').required = true;
                document.getElementById('newPasswordLabel').textContent = 'æ–°å¯†ç ';
                document.getElementById('confirmPasswordLabel').textContent = 'ç¡®è®¤æ–°å¯†ç ';
                document.getElementById('passwordSubmitBtn').textContent = 'ğŸ”„ æäº¤ä¿®æ”¹';
                needsPasswordSet = false;
            }
        }
        
        document.getElementById('passwordForm').addEventListener('submit', async e => {
            e.preventDefault();
            const cur = document.getElementById('current_password').value;
            const nw = document.getElementById('new_password').value;
            const c_nw = document.getElementById('confirm_password').value;
            const msg = document.getElementById('pwdMsg');
            msg.style.display = 'none';

            function showMessage(text, type) {
                msg.textContent = text;
                msg.className = `message ${type}`;
                msg.style.display = 'block';
            }

            if (nw !== c_nw) {
                showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }
            if (nw.length < 8 || !(/[a-zA-Z]/.test(nw) && /\d/.test(nw))) {
                showMessage('å¯†ç è‡³å°‘8ä½ä¸”åŒ…å«å­—æ¯å’Œæ•°å­—', 'error');
                return;
            }

            // å¦‚æœæ˜¯è®¾ç½®å¯†ç ï¼Œä¸éœ€è¦å½“å‰å¯†ç 
            if (needsPasswordSet && cur) {
                showMessage('è®¾ç½®å¯†ç ä¸éœ€è¦è¾“å…¥å½“å‰å¯†ç ', 'error');
                return;
            }
            
            // å¦‚æœæ˜¯ä¿®æ”¹å¯†ç ï¼Œéœ€è¦å½“å‰å¯†ç 
            if (!needsPasswordSet && !cur) {
                showMessage('ä¿®æ”¹å¯†ç éœ€è¦è¾“å…¥å½“å‰å¯†ç ', 'error');
                return;
            }

            try {
                const res = await fetch('/api/profile/password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        current_password: cur || '', 
                        new_password: nw,
                        is_set_password: needsPasswordSet
                    })
                });
                const d = await res.json();
                if (!res.ok || d.status !== 'success') throw new Error(d.message || 'æ“ä½œå¤±è´¥');
                
                if (needsPasswordSet) {
                    showMessage('âœ… å¯†ç è®¾ç½®æˆåŠŸ', 'success');
                    // é‡æ–°åŠ è½½çŠ¶æ€
                    setTimeout(() => {
                        loadUserPasswordStatus();
                        document.getElementById('passwordForm').reset();
                    }, 1500);
                } else {
                    showMessage('âœ… ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•', 'success');
                    setTimeout(() => location.href = '/login', 1500);
                }
            } catch (err) {
                showMessage('âŒ ' + err.message, 'error');
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶è·å–ç”¨æˆ·å¯†ç çŠ¶æ€
        loadUserPasswordStatus();
        
        // é¡µé¢åŠ è½½æ—¶è·å–é‚®ç®±ä¿¡æ¯
        loadEmailInfo();
    </script>
</body>
</html>