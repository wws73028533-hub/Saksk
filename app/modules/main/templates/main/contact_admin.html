{% extends "main/app_shell.html" %}
{% block title %}è”ç³»ç®¡ç†å‘˜{% endblock %}
{% block page_title %}è”ç³»ç®¡ç†å‘˜{% endblock %}
{% block head_extra %}
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','Helvetica Neue',Arial,sans-serif;background:#f5f5f7;margin:0;color:#1d1d1f;transition:background .25s ease,color .25s ease}
    .wrap{max-width:860px;margin:0 auto;padding:28px 16px}
    .top a{text-decoration:none;color:#007aff}
    .card{background:#fff;border-radius:18px;padding:18px 16px;box-shadow:0 8px 24px rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.06);transition:background .25s ease,box-shadow .25s ease,border-color .25s ease}
    .title{font-size:22px;font-weight:650;margin:0 0 8px}
    .sub{color:#6e6e73;font-size:14px;line-height:1.6;margin:0 0 16px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;border:none;background:#007aff;color:#fff;font-size:15px;font-weight:600;cursor:pointer;transition:background .25s ease,box-shadow .25s ease}
    .btn[disabled]{opacity:.55;cursor:not-allowed}
    .hint{margin-top:12px;color:#6e6e73;font-size:13px;line-height:1.6}
    .list{margin-top:14px;padding-left:18px;color:#1d1d1f}
    .list li{margin:8px 0;color:#1d1d1f}
    code{background:#f2f2f7;padding:2px 6px;border-radius:8px}

    /* æ·±è‰²æ¨¡å¼é€‚é…ï¼šä¸é¦–é¡µ/é€šçŸ¥é¡µé£æ ¼ä¸€è‡´ */
    body.dark-mode{background:#000;color:#f5f5f7}
    body.dark-mode .top a{color:#0a84ff}
    body.dark-mode .card{background:rgba(28,28,30,.9);border-color:rgba(255,255,255,.16);box-shadow:0 18px 40px rgba(0,0,0,.75)}
    body.dark-mode .sub,
    body.dark-mode .hint,
    body.dark-mode .list,
    body.dark-mode .list li{color:#a1a1a6}
    body.dark-mode .title{color:#f5f5f7}
    body.dark-mode .btn{background:#0a84ff;box-shadow:0 8px 24px rgba(10,132,255,.45)}
    body.dark-mode .btn:hover{background:#007aff;box-shadow:0 10px 28px rgba(10,132,255,.55)}
    body.dark-mode .btn[disabled]{opacity:.4;cursor:not-allowed}
    body.dark-mode code{background:#1c1c1e;color:#f5f5f7}
    body.dark-mode ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15)}
    body.dark-mode *:hover::-webkit-scrollbar-thumb{background:rgba(255,255,255,.25)}
  </style>
{% endblock %}

{% block content %}
  <div class="wrap">
    <div class="top"><a href="/user_hub">â† è¿”å›åŠŸèƒ½ä¸­å¿ƒ</a></div>

    <div class="card" style="margin-top:14px;">
      <h1 class="title">è”ç³»ç®¡ç†å‘˜</h1>
      <p class="sub">é‡åˆ°ä½¿ç”¨é—®é¢˜ã€é¢˜ç›®çº é”™ã€åŠŸèƒ½å»ºè®®ç­‰ï¼Œéƒ½å¯ä»¥åœ¨è¿™é‡Œå‘èµ·ä¸ç®¡ç†å‘˜çš„ä¼šè¯ã€‚</p>

      {% if disabled %}
        <button class="btn" disabled>ğŸ’¬ å‘èµ·èŠå¤©ï¼ˆä¸å¯ç”¨ï¼‰</button>
        <div class="hint">åŸå› ï¼š{{ reason }}</div>
      {% else %}
        <button class="btn" onclick="startChatWithAdmin()">ğŸ’¬ ç›´æ¥èŠå¤©ï¼ˆè·³è½¬åˆ°ä¼šè¯ï¼‰</button>
        <div class="hint">å°†è‡ªåŠ¨åˆ›å»º/å¤ç”¨ä¸ç®¡ç†å‘˜ <b>{{ admin_username }}</b> çš„ç§èŠä¼šè¯ï¼Œå¹¶è·³è½¬åˆ°èŠå¤©é¡µã€‚</div>
      {% endif %}

      
    </div>
  </div>

{% endblock %}

{% block body_end %}
  <script>
    // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–ï¼ˆä»…åœ¨æœªæ‰‹åŠ¨è®¾ç½®ä¸»é¢˜æ—¶ï¼‰
    (function initThemeListener() {
      try {
        if (window.matchMedia) {
          window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem('theme')) {
              if (e.matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.body.classList.add('dark-mode');
              } else {
                document.documentElement.removeAttribute('data-theme');
                document.body.classList.remove('dark-mode');
              }
            }
          });
        }
      } catch (e) {}
    })();

    async function startChatWithAdmin(){
      try{
        const peerUserId = {{ admin_user_id|default(0) }};
        if(!peerUserId){
          alert('æœªæ‰¾åˆ°ç®¡ç†å‘˜è´¦å·ï¼Œè¯·ç¨åå†è¯•');
          return;
        }

        const res = await fetch('/api/chat/conversations/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ peer_user_id: peerUserId })
        });
        const data = await res.json();
        if(!res.ok || data.status !== 'success'){
          alert(data.message || 'åˆ›å»ºä¼šè¯å¤±è´¥');
          return;
        }

        // è·³è½¬åˆ°èŠå¤©é¡µï¼Œå¹¶é€šè¿‡ query æŒ‡å®šæ‰“å¼€è¯¥ä¼šè¯ï¼ˆéœ€ chat.html æ”¯æŒï¼‰
        const cid = data.conversation_id;
        window.location.href = '/chat?conversation_id=' + encodeURIComponent(cid);
      }catch(e){
        console.error(e);
        alert('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•');
      }
    }

    // ä¸»é¢˜åŒæ­¥ï¼ˆä¸é¦–é¡µä¿æŒä¸€è‡´çš„æ–¹å¼ï¼‰
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
      document.body.classList.add('dark-mode');
    } else if (!savedTheme && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.setAttribute('data-theme', 'dark');
      document.body.classList.add('dark-mode');
      localStorage.setItem('theme', 'dark');
    }
  </script>
{% endblock %}

