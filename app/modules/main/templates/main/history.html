{% extends "main/app_shell.html" %}
{% block title %}进度{% endblock %}
{% block page_title %}进度{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="/static/css/ui18_pages.css" />
  <link rel="stylesheet" href="/static/css/ui18_stats.css" />
{% endblock %}

{% block content %}
  <div class="ui18-page">
    <header class="ui18-header" aria-label="学习统计">
      <div class="ui18-header-left">
        <h1 class="ui18-title">学习统计</h1>
        <div class="ui18-sub">
          基于公共题库的最新作答结果汇总，帮助你快速定位薄弱点并直接开始练习。
        </div>
      </div>
      <div class="ui18-meta">
        <nav class="ui18-tabs" aria-label="趋势窗口">
          <a class="ui18-tab {{ 'active' if window_days == 7 else '' }}" href="/history?days=7">7天</a>
          <a class="ui18-tab {{ 'active' if window_days == 30 else '' }}" href="/history?days=30">30天</a>
          <a class="ui18-tab {{ 'active' if window_days == 90 else '' }}" href="/history?days=90">90天</a>
        </nav>
      </div>
    </header>

    <section class="ui18-card" aria-label="总览">
      <h2>总览</h2>
      <div class="sub">统计范围已按你的科目权限与锁定规则过滤。</div>

      <div class="ui18-kpi-grid">
        <div class="ui18-kpi">
          <div class="ui18-kpi-top">
            <div class="ui18-kpi-label">已做题</div>
            <svg class="ui18-kpi-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 6.5c0-1.1.9-2 2-2h12c1.1 0 2 .9 2 2V19c0 .6-.4 1-1 1H7a3 3 0 0 1-3-3V6.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M7 8h10M7 12h10M7 16h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="ui18-kpi-value">{{ answered_count }}</div>
          <div class="ui18-kpi-meta">总题 {{ total_questions }} · 完成 {{ completion }}%</div>
          <div class="ui18-progress" aria-hidden="true"><span style="width: {{ completion }}%"></span></div>
        </div>

        <div class="ui18-kpi">
          <div class="ui18-kpi-top">
            <div class="ui18-kpi-label">正确率</div>
            <svg class="ui18-kpi-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 3v18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M4 10l8-7 8 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="ui18-kpi-value">{{ accuracy }}%</div>
          <div class="ui18-kpi-meta">正确 {{ correct_count }} / {{ answered_count }}</div>
          <div class="ui18-progress" aria-hidden="true"><span style="width: {{ accuracy }}%"></span></div>
        </div>

        <div class="ui18-kpi">
          <div class="ui18-kpi-top">
            <div class="ui18-kpi-label">连续天数</div>
            <svg class="ui18-kpi-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M7 2v3M17 2v3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M4 7h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M6 5h12a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="ui18-kpi-value">{{ streak_days }}</div>
          <div class="ui18-kpi-meta">最近活跃：{{ last_activity[:10] if last_activity else '—' }}</div>
        </div>

        <div class="ui18-kpi">
          <div class="ui18-kpi-top">
            <div class="ui18-kpi-label">近7天</div>
            <svg class="ui18-kpi-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 19V5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M4 19h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M8 15v-5M12 15V7M16 15v-3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="ui18-kpi-value">{{ answered_7d }}</div>
          <div class="ui18-kpi-meta">正确率 {{ (correct_7d * 100 / answered_7d)|round(1) if answered_7d else 0 }}%</div>
        </div>

        <div class="ui18-kpi">
          <div class="ui18-kpi-top">
            <div class="ui18-kpi-label">错题</div>
            <svg class="ui18-kpi-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 8v5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 16h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
              <path d="M10.3 4.3 2.8 17.3A2 2 0 0 0 4.5 20h15a2 2 0 0 0 1.7-2.7L13.7 4.3a2 2 0 0 0-3.4 0Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="ui18-kpi-value">{{ mistakes_count }}</div>
          <div class="ui18-kpi-meta">累计次数 {{ mistakes_times }}</div>
        </div>

        <div class="ui18-kpi">
          <div class="ui18-kpi-top">
            <div class="ui18-kpi-label">收藏</div>
            <svg class="ui18-kpi-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 17.3 6.3 20.6l1.2-6.6L2.6 9.8l6.7-.9L12 3l2.7 5.9 6.7.9-4.9 4.2 1.2 6.6L12 17.3Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="ui18-kpi-value">{{ favorites_count }}</div>
          <div class="ui18-kpi-meta">建议：收藏用于高价值复习题</div>
        </div>
      </div>
    </section>

    <section class="ui18-card" aria-label="趋势">
      <h2>趋势（近{{ window_days }}天）</h2>
      <div class="sub">做题量按题目最近一次作答时间统计（重复作答会更新到当天）。</div>

      <div class="ui18-trend" role="img" aria-label="近{{ window_days }}天做题趋势">
        <div class="ui18-trend-bars">
          {% for d in daily %}
            {% set bar_h = (d.total * 100 / daily_max) if daily_max else 0 %}
            {% set fill_h = (d.correct * 100 / d.total) if d.total else 0 %}
            <div class="ui18-trend-bar" style="height: {{ bar_h|round(1) }}%;" title="{{ d.day }}：{{ d.total }}题，正确率 {{ d.accuracy }}%">
              <span style="height: {{ fill_h|round(1) }}%;"></span>
            </div>
          {% endfor %}
        </div>
        <div class="ui18-trend-legend">
          <span>窗口已做 {{ window_answered }} · 正确率 {{ window_accuracy }}%</span>
          <span>最近活跃 {{ last_activity[:10] if last_activity else '—' }}</span>
        </div>
      </div>
    </section>

    <section class="ui18-card" aria-label="下一步建议">
      <h2>下一步建议</h2>
      <div class="sub">优先补短板：先刷错题，再重练全量。</div>

      {% if next_actions %}
        <div class="ui18-note-list">
          {% for a in next_actions %}
            <div class="ui18-note">
              <div class="ui18-note-title">{{ a.title }}</div>
              <div class="ui18-note-sub">{{ a.meta }}</div>
              <div class="ui18-actions" style="margin-top:10px;">
                <a class="ui18-mini-btn primary" href="/quiz?subject={{ a.subject|urlencode }}&type={{ a.q_type|urlencode }}&mode=quiz&source=mistakes">刷错题</a>
                <a class="ui18-mini-btn" href="/quiz?subject={{ a.subject|urlencode }}&type={{ a.q_type|urlencode }}&mode=quiz&source=all">重练</a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="ui18-empty">先做几道题再来看，会更有指导意义。</div>
      {% endif %}
    </section>

    <section class="ui18-card" aria-label="薄弱点排行">
      <h2>薄弱点（科目 × 题型）</h2>
      <div class="sub">按正确率从低到高排序（至少做过 5 题）。</div>

      {% if weakness_rows %}
        <div class="ui18-weak-list">
          {% for w in weakness_rows %}
            <div class="ui18-weak-row">
              <div style="min-width:0;">
                <div class="ui18-weak-title">{{ w.subject }} · {{ w.q_type }}</div>
                <div class="ui18-weak-meta">正确率 {{ w.accuracy }}% · 已做 {{ w.answered }} · 错题 {{ w.mistakes }}</div>
                <div class="ui18-weak-bar">
                  <div class="ui18-progress" aria-hidden="true">
                    <span style="width: {{ w.accuracy }}%"></span>
                  </div>
                </div>
              </div>
              <div class="ui18-actions">
                <a class="ui18-mini-btn primary" href="/quiz?subject={{ w.subject|urlencode }}&type={{ w.q_type|urlencode }}&mode=quiz&source=mistakes">刷错题</a>
                <a class="ui18-mini-btn" href="/quiz?subject={{ w.subject|urlencode }}&type={{ w.q_type|urlencode }}&mode=quiz&source=all">重练</a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="ui18-empty">暂无可用薄弱点排行（可能是做题不足或数据为空）。</div>
      {% endif %}
    </section>

    <section class="ui18-card" aria-label="科目掌握情况">
      <h2>科目掌握</h2>
      <div class="sub">完成度 = 已做 / 总题；正确率基于最新作答结果。</div>

      {% if subject_rows %}
        <div class="ui18-table-wrap">
          <table class="ui18-table">
            <thead>
              <tr>
                <th>科目</th>
                <th>完成度</th>
                <th>正确率</th>
                <th>错题</th>
                <th>收藏</th>
                <th>快捷</th>
              </tr>
            </thead>
            <tbody>
              {% for s in subject_rows %}
              <tr>
                <td>{{ s.subject }}</td>
                <td style="min-width:160px;">
                  <div class="ui18-progress" aria-hidden="true"><span style="width: {{ s.completion }}%"></span></div>
                  <div style="margin-top:6px;color:var(--app-muted);font-size:12px;">{{ s.answered }} / {{ s.total }}（{{ s.completion }}%）</div>
                </td>
                <td style="min-width:140px;">
                  <div class="ui18-progress" aria-hidden="true"><span style="width: {{ s.accuracy }}%"></span></div>
                  <div style="margin-top:6px;color:var(--app-muted);font-size:12px;">{{ s.correct }} / {{ s.answered }}（{{ s.accuracy }}%）</div>
                </td>
                <td>{{ s.mistakes }}</td>
                <td>{{ s.favorites }}</td>
                <td>
                  <div class="ui18-actions">
                    <a class="ui18-mini-btn" href="/quiz?subject={{ s.subject|urlencode }}&type=all&mode=quiz&source=mistakes">刷错题</a>
                    <a class="ui18-mini-btn" href="/quiz?subject={{ s.subject|urlencode }}&type=all&mode=quiz&source=all">重练</a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="ui18-empty">暂无科目统计数据。</div>
      {% endif %}
    </section>

    <section class="ui18-card" aria-label="题型与难度">
      <h2>题型与难度</h2>
      <div class="sub">用于判断：是“知识点薄弱”还是“题型策略薄弱”。</div>

      <div class="ui18-split">
        <div class="ui18-note">
          <div class="ui18-note-title">题型</div>
          <div class="ui18-note-sub">按已做数量排序。</div>
          {% if type_rows %}
            <div class="ui18-weak-list" style="margin-top:10px;">
              {% for t in type_rows %}
                <div class="ui18-weak-row">
                  <div style="min-width:0;">
                    <div class="ui18-weak-title">{{ t.q_type }}</div>
                    <div class="ui18-weak-meta">正确率 {{ t.accuracy }}% · 已做 {{ t.answered }}</div>
                    <div class="ui18-weak-bar">
                      <div class="ui18-progress" aria-hidden="true"><span style="width: {{ t.accuracy }}%"></span></div>
                    </div>
                  </div>
                  <div class="ui18-actions">
                    <a class="ui18-mini-btn primary" href="/quiz?subject=all&type={{ t.q_type|urlencode }}&mode=quiz&source=mistakes">刷错题</a>
                    <a class="ui18-mini-btn" href="/quiz?subject=all&type={{ t.q_type|urlencode }}&mode=quiz&source=all">重练</a>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="ui18-empty">暂无题型统计。</div>
          {% endif %}
        </div>

        <div class="ui18-note">
          <div class="ui18-note-title">难度</div>
          <div class="ui18-note-sub">用于判断是否被高难度拖累。</div>
          {% if difficulty_rows %}
            <div class="ui18-weak-list" style="margin-top:10px;">
              {% for d in difficulty_rows %}
                <div class="ui18-weak-row">
                  <div style="min-width:0;">
                    <div class="ui18-weak-title">{{ d.label }}</div>
                    <div class="ui18-weak-meta">正确率 {{ d.accuracy }}% · 已做 {{ d.answered }}</div>
                    <div class="ui18-weak-bar">
                      <div class="ui18-progress" aria-hidden="true"><span style="width: {{ d.accuracy }}%"></span></div>
                    </div>
                  </div>
                  <div class="ui18-actions">
                    <a class="ui18-mini-btn" href="/quiz?subject=all&type=all&mode=quiz&source=all">去练习</a>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="ui18-empty">暂无难度统计。</div>
          {% endif %}
        </div>
      </div>
    </section>

    <section class="ui18-card" aria-label="最近错题">
      <h2>最近错题</h2>
      <div class="sub">快速定位需要回炉的题目类型（不展示题目详情）。</div>

      {% if recent_mistakes %}
        <div class="ui18-note-list">
          {% for m in recent_mistakes %}
            <div class="ui18-note">
              <div class="ui18-note-title">{{ m.subject }} · {{ m.q_type }}</div>
              <div class="ui18-note-sub">{% if m.wrong_count %}累计错 {{ m.wrong_count }} 次{% else %}来自错题本{% endif %}</div>
              <div class="ui18-q-snippet">{{ m.snippet|e }}</div>
              <div class="ui18-actions" style="margin-top:10px;">
                <a class="ui18-mini-btn primary" href="/quiz?subject={{ m.subject|urlencode }}&type={{ m.q_type|urlencode }}&mode=quiz&source=mistakes">刷该类错题</a>
                <a class="ui18-mini-btn" href="/quiz?subject={{ m.subject|urlencode }}&type={{ m.q_type|urlencode }}&mode=quiz&source=all">重练该类</a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="ui18-empty">暂无错题记录。</div>
      {% endif %}
    </section>
  </div>
{% endblock %}
