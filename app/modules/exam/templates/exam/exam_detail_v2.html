{% extends "main/app_shell.html" %}
{% block title %}考试成绩 #{{ exam.id }}{% endblock %}
{% block page_title %}考试 #{{ exam.id }}{% endblock %}

{% block head_extra %}
  <style>
    .exam-detail-page { max-width: 980px; margin: 0 auto; min-width: 0; }

    .exam-head {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 14px;
      min-width: 0;
    }
    .exam-meta { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; min-width: 0; }
    .mono { font-variant-numeric: tabular-nums; }
    .muted { color: var(--app-muted); }

    .bento {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 14px;
      margin-bottom: 16px;
    }

    .exam-card {
      border: 1px solid var(--app-border);
      border-radius: var(--app-radius-xl);
      background: var(--app-surface-2);
      box-shadow: var(--app-shadow-soft);
      padding: 18px;
      overflow: hidden;
      min-width: 0;
    }

    .metric { display: flex; flex-direction: column; gap: 6px; min-height: 72px; justify-content: center; }
    .label { color: var(--app-muted); font-size: 12px; letter-spacing: 0.2px; font-weight: 800; }
    .value { font-size: 22px; font-weight: 900; letter-spacing: -0.3px; }
    .value small { font-size: 13px; font-weight: 800; color: var(--app-muted); }

    .ring {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: conic-gradient(var(--app-primary) calc(var(--p) * 1%), color-mix(in srgb, var(--app-border) 60%, transparent) 0);
      display: grid;
      place-items: center;
      flex: 0 0 auto;
    }
    .ring::after {
      content: '';
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--app-surface);
      border: 1px solid var(--app-border);
      box-shadow: inset 0 1px 0 color-mix(in srgb, #ffffff 30%, transparent);
    }
    .pill-text { display: flex; flex-direction: column; gap: 2px; min-width: 0; }
    .pill-text .big { font-weight: 950; letter-spacing: -0.2px; }
    .pill-text .small { font-size: 12px; color: var(--app-muted); }

    .exam-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin: 14px 0 16px;
    }

    .exam-btn {
      height: 36px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid var(--app-border);
      background: var(--app-surface);
      box-shadow: var(--app-shadow-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 900;
      font-size: 13px;
      transition: background 140ms ease, box-shadow 140ms ease, transform 140ms ease;
      white-space: nowrap;
      text-decoration: none;
      color: var(--app-text);
    }
    .exam-btn:hover { box-shadow: var(--app-shadow); transform: translateY(-1px); }
    .exam-btn:active { transform: translateY(0); }
    .exam-btn:focus { outline: none; box-shadow: 0 0 0 3px var(--app-primary-soft), var(--app-shadow-soft); }

    .exam-btn-primary {
      border-color: color-mix(in srgb, var(--app-primary) 50%, var(--app-border));
      background: color-mix(in srgb, var(--app-primary) 12%, var(--app-surface));
    }

    .exam-btn-danger {
      border-color: color-mix(in srgb, #ef4444 55%, var(--app-border));
      background: color-mix(in srgb, #ef4444 10%, var(--app-surface));
      color: #b91c1c;
    }
    html[data-theme="dark"] .exam-btn-danger { color: #fecaca; }

    .exam-table-card { padding: 0; overflow: hidden; }
    .exam-table { width: 100%; border-collapse: collapse; }
    .exam-table thead th {
      background: color-mix(in srgb, var(--app-surface) 92%, var(--app-bg));
      color: var(--app-muted);
      font-size: 12px;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      font-weight: 900;
    }
    .exam-table th, .exam-table td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--app-border);
      vertical-align: top;
      text-align: left;
    }
    .exam-table tbody tr:hover { background: color-mix(in srgb, var(--app-primary) 4%, transparent); }

    .status { display: inline-flex; align-items: center; gap: 8px; font-weight: 900; }
    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      box-shadow: inset 0 1px 0 color-mix(in srgb, #ffffff 30%, transparent);
    }
    .dot.ok { background: #22c55e; }
    .dot.bad { background: #ef4444; }

    @media (max-width: 900px) {
      .value { font-size: 20px; }
    }

    @media (max-width: 720px) {
      .bento { grid-template-columns: repeat(6, 1fr); }
      .hide-sm { display: none; }
      .exam-table th, .exam-table td { padding: 12px 12px; }
    }
  </style>
{% endblock %}

{% block content %}
  <div class="app-container exam-detail-page">
    <div class="exam-head">
      <div class="exam-meta">
        <span class="app-pill">成绩</span>
        <span class="app-pill mono">考试 #{{ exam.id }}</span>
        <span class="app-pill">{{ exam.subject or '全部' }}</span>
        <span class="app-pill mono">{{ exam.duration_minutes }} 分钟</span>
      </div>
      <a class="exam-btn" href="/exams">返回考试</a>
    </div>

    <div class="bento">
      <div class="exam-card" style="grid-column: span 4;">
        <div class="metric">
          <div class="label">总分</div>
          <div class="value mono">{{ exam.total_score or 0 }}</div>
        </div>
      </div>

      <div class="exam-card" style="grid-column: span 4;">
        <div class="metric">
          <div class="label">正确 / 总题数</div>
          <div class="value mono">{{ correct }} <small>/ {{ total }}</small></div>
        </div>
      </div>

      <div class="exam-card" style="grid-column: span 4; display:flex; align-items:center; justify-content:space-between; gap:12px;">
        <div style="display:flex; align-items:center; gap:12px; min-width:0;">
          <div class="ring" style="--p: {{ accuracy }};"></div>
          <div class="pill-text">
            <div class="big mono">{{ accuracy }}%</div>
            <div class="small">正确率</div>
          </div>
        </div>
      </div>

      <div class="exam-card" style="grid-column: span 6;">
        <div class="metric">
          <div class="label">开始时间</div>
          <div class="value mono" style="font-size: 15px; font-weight: 900;">{{ exam.started_at }}</div>
        </div>
      </div>

      <div class="exam-card" style="grid-column: span 6;">
        <div class="metric">
          <div class="label">提交时间</div>
          <div class="value mono" style="font-size: 15px; font-weight: 900;">{{ exam.submitted_at or '-' }}</div>
        </div>
      </div>
    </div>

    <div class="exam-actions">
      <a class="exam-btn exam-btn-primary" href="/quiz?mode=exam&exam_id={{ exam.id }}{% if exam_source == 'user_bank' and exam_bank_id %}&bank_id={{ exam_bank_id }}{% endif %}">回顾题目</a>
      <button class="exam-btn" type="button" onclick="toMistakes({{ exam.id }})">错题加入错题本</button>
      <button class="exam-btn exam-btn-danger" type="button" onclick="delExam({{ exam.id }})">删除考试</button>
    </div>

    <div class="app-card exam-table-card">
      <table class="exam-table">
        <thead>
          <tr>
            <th style="width:64px;">#</th>
            <th style="width:92px;">题型</th>
            <th style="width:80px;">分值</th>
            <th>作答</th>
            <th class="hide-sm">正确答案</th>
            <th style="width:110px;">结果</th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
          <tr>
            <td class="mono">{{ loop.index }}</td>
            <td>{{ it.q_type }}</td>
            <td class="mono">{{ it.score_val }}</td>
            <td class="mono">{{ it.user_answer or '' }}</td>
            <td class="mono hide-sm">{{ it.answer }}</td>
            <td>
              {% if it.is_correct %}
                <span class="status"><span class="dot ok"></span>正确</span>
              {% else %}
                <span class="status"><span class="dot bad"></span>错误</span>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr><td colspan="6" class="muted" style="padding: 18px 16px;">暂无数据</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}

{% block body_end %}
  <script>
    async function toMistakes(id) {
      if (!confirm('将本次考试的错题加入错题本？')) return;
      try {
        var res = await fetch(`/api/exams/${id}/mistakes`, { method: 'POST' });
        var js = await res.json();
        if (res.ok && js.status === 'success') alert(`已加入错题本：${js.count} 题`);
        else alert(js.message || '操作失败');
      } catch (e) {
        alert('操作失败');
      }
    }

    async function delExam(id) {
      if (!confirm('确定要删除该考试吗？此操作不可恢复。')) return;
      try {
        var res = await fetch(`/api/exams/${id}`, { method: 'DELETE' });
        var js = await res.json();
        if (res.ok && js.status === 'success') window.location.href = '/exams';
        else alert(js.message || '删除失败');
      } catch (e) {
        alert('删除失败');
      }
    }
  </script>
{% endblock %}
