# ç¬¬äºŒé˜¶æ®µå¼€å‘æ–‡æ¡£ - ç®¡ç†åå°åŠŸèƒ½

## ğŸ“‹ æ¦‚è¿°

ç¬¬äºŒé˜¶æ®µä¸»è¦å®ç°ç®¡ç†åå°çš„ç”¨æˆ·ç§‘ç›®æƒé™ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç”¨æˆ·è¯¦æƒ…é¡µé›†æˆã€é¢˜åº“ç®¡ç†é¡µé¢ã€APIæ¥å£ã€ç³»ç»Ÿé…ç½®ç®¡ç†å’Œç”¨æˆ·åˆ·é¢˜æ•°ç®¡ç†ã€‚æœ¬é˜¶æ®µéµå¾ªFlask-RESTfulæœ€ä½³å®è·µï¼Œä½¿ç”¨Pydanticè¿›è¡Œæ•°æ®éªŒè¯ï¼Œä¿æŒæ¨¡å—åŒ–è®¾è®¡ã€‚

---

## ğŸ¯ é˜¶æ®µç›®æ ‡

1. âœ… åœ¨ç”¨æˆ·è¯¦æƒ…é¡µé›†æˆç§‘ç›®æƒé™ç®¡ç†å¡ç‰‡
2. âœ… åˆ›å»ºé¢˜åº“ç®¡ç†é¡µé¢ï¼ˆæ‰¹é‡æ“ä½œï¼‰
3. âœ… å®ç°é™åˆ¶/å–æ¶ˆé™åˆ¶ç§‘ç›® APIï¼ˆé»‘åå•æ¨¡å¼ï¼‰
4. âœ… å®ç°æ‰¹é‡æ“ä½œåŠŸèƒ½ï¼ˆå•ä¸ªç”¨æˆ·å’Œæ‰¹é‡ç”¨æˆ·ï¼‰
5. âœ… åœ¨ä¾§è¾¹æ æ·»åŠ "é¢˜åº“ç®¡ç†"èœå•é¡¹
6. âœ… ç”¨æˆ·ç®¡ç†é¡µé¢å¢å¼ºï¼ˆæ˜¾ç¤ºè¢«é™åˆ¶ç§‘ç›®æ•°ï¼‰
7. âœ… ç³»ç»Ÿé…ç½®ç®¡ç†ï¼ˆåˆ·é¢˜é™åˆ¶å¼€å…³ã€é™åˆ¶æ•°é‡ï¼‰
8. âœ… ç”¨æˆ·åˆ·é¢˜æ•°ç®¡ç†ï¼ˆæŸ¥çœ‹ã€é‡ç½®ï¼‰

---

## ğŸ“¦ æ¨¡å—ç»“æ„

### 1. æœåŠ¡å±‚ï¼ˆService Layerï¼‰

**ä½ç½®**ï¼š`app/modules/admin/services/`

åˆ›å»ºæœåŠ¡å±‚ï¼Œå°†ä¸šåŠ¡é€»è¾‘ä»è·¯ç”±ä¸­åˆ†ç¦»å‡ºæ¥ã€‚

```
app/modules/admin/services/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ subject_permission_service.py  # ç§‘ç›®æƒé™ç®¡ç†æœåŠ¡
â”œâ”€â”€ system_config_service.py       # ç³»ç»Ÿé…ç½®ç®¡ç†æœåŠ¡
â””â”€â”€ quiz_stats_service.py          # åˆ·é¢˜ç»Ÿè®¡ç®¡ç†æœåŠ¡
```

### 2. Schema å®šä¹‰ï¼ˆPydanticï¼‰

**ä½ç½®**ï¼š`app/modules/admin/schemas.py`

ä½¿ç”¨Pydanticå®šä¹‰è¯·æ±‚å’Œå“åº”çš„æ•°æ®æ¨¡å‹ã€‚

---

## ğŸ› ï¸ æœåŠ¡å±‚å®ç°

### 1. ç§‘ç›®æƒé™ç®¡ç†æœåŠ¡

**ä½ç½®**ï¼š`app/modules/admin/services/subject_permission_service.py`

```python
# -*- coding: utf-8 -*-
"""
ç§‘ç›®æƒé™ç®¡ç†æœåŠ¡
"""
from typing import List, Dict, Any, Optional
from app.core.utils.database import get_db
from app.core.utils.subject_permissions import is_admin


class SubjectPermissionService:
    """ç§‘ç›®æƒé™ç®¡ç†æœåŠ¡ç±»"""
    
    @staticmethod
    def get_user_subjects(user_id: int) -> Dict[str, Any]:
        """
        è·å–ç”¨æˆ·çš„ç§‘ç›®æƒé™ä¿¡æ¯
        
        Args:
            user_id: ç”¨æˆ·ID
            
        Returns:
            åŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œç§‘ç›®åˆ—è¡¨çš„å­—å…¸
        """
        conn = get_db()
        
        # è·å–ç”¨æˆ·ä¿¡æ¯
        user = conn.execute(
            'SELECT id, username FROM users WHERE id = ?',
            (user_id,)
        ).fetchone()
        
        if not user:
            raise ValueError(f"ç”¨æˆ· {user_id} ä¸å­˜åœ¨")
        
        # è·å–æ‰€æœ‰ç§‘ç›®åŠå…¶é¢˜ç›®æ•°é‡
        all_subjects = conn.execute('''
            SELECT s.id, s.name, COUNT(q.id) as question_count
            FROM subjects s
            LEFT JOIN questions q ON s.id = q.subject_id
            GROUP BY s.id, s.name
            ORDER BY s.id
        ''').fetchall()
        
        # è·å–ç”¨æˆ·è¢«é™åˆ¶çš„ç§‘ç›®
        restricted_subjects = conn.execute(
            'SELECT subject_id, restricted_at FROM user_subjects WHERE user_id = ?',
            (user_id,)
        ).fetchall()
        
        restricted_dict = {
            row['subject_id']: row['restricted_at'] 
            for row in restricted_subjects
        }
        
        # æ„å»ºç§‘ç›®åˆ—è¡¨
        subjects_list = []
        restricted_count = 0
        
        for subject in all_subjects:
            subject_id = subject['id']
            is_restricted = subject_id in restricted_dict
            
            subjects_list.append({
                'id': subject_id,
                'name': subject['name'],
                'question_count': subject['question_count'],
                'is_restricted': is_restricted,
                'restricted_at': restricted_dict.get(subject_id)
            })
            
            if is_restricted:
                restricted_count += 1
        
        return {
            'user': {
                'id': user['id'],
                'username': user['username']
            },
            'all_subjects': subjects_list,
            'restricted_count': restricted_count,
            'total_count': len(subjects_list)
        }
    
    @staticmethod
    def restrict_subjects(user_id: int, subject_ids: List[int], admin_id: int) -> Dict[str, Any]:
        """
        é™åˆ¶ç”¨æˆ·è®¿é—®æŒ‡å®šç§‘ç›®ï¼ˆæ·»åŠ åˆ°é»‘åå•ï¼‰
        
        Args:
            user_id: ç”¨æˆ·ID
            subject_ids: ç§‘ç›®IDåˆ—è¡¨
            admin_id: æ“ä½œçš„ç®¡ç†å‘˜ID
            
        Returns:
            æ“ä½œç»“æœå­—å…¸
        """
        if not subject_ids:
            raise ValueError("ç§‘ç›®IDåˆ—è¡¨ä¸èƒ½ä¸ºç©º")
        
        conn = get_db()
        success_count = 0
        
        try:
            for subject_id in subject_ids:
                # æ£€æŸ¥ç§‘ç›®æ˜¯å¦å­˜åœ¨
                subject = conn.execute(
                    'SELECT id FROM subjects WHERE id = ?',
                    (subject_id,)
                ).fetchone()
                
                if not subject:
                    continue
                
                # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨é™åˆ¶
                existing = conn.execute(
                    'SELECT id FROM user_subjects WHERE user_id = ? AND subject_id = ?',
                    (user_id, subject_id)
                ).fetchone()
                
                if not existing:
                    conn.execute(
                        '''INSERT INTO user_subjects 
                           (user_id, subject_id, restricted_by)
                           VALUES (?, ?, ?)''',
                        (user_id, subject_id, admin_id)
                    )
                    success_count += 1
            
            conn.commit()
            
            return {
                'restricted_count': success_count,
                'message': f'æˆåŠŸé™åˆ¶ {success_count} ä¸ªç§‘ç›®'
            }
        except Exception as e:
            conn.rollback()
            raise Exception(f"é™åˆ¶ç§‘ç›®å¤±è´¥: {str(e)}")
    
    @staticmethod
    def unrestrict_subject(user_id: int, subject_id: int) -> None:
        """
        å–æ¶ˆç”¨æˆ·å¯¹æŒ‡å®šç§‘ç›®çš„é™åˆ¶ï¼ˆä»é»‘åå•ç§»é™¤ï¼‰
        
        Args:
            user_id: ç”¨æˆ·ID
            subject_id: ç§‘ç›®ID
        """
        conn = get_db()
        
        conn.execute(
            'DELETE FROM user_subjects WHERE user_id = ? AND subject_id = ?',
            (user_id, subject_id)
        )
        conn.commit()
    
    @staticmethod
    def batch_restrict_subjects(
        user_id: int, 
        subject_ids: List[int], 
        action: str,
        admin_id: int
    ) -> Dict[str, Any]:
        """
        æ‰¹é‡é™åˆ¶/å–æ¶ˆé™åˆ¶ç§‘ç›®
        
        Args:
            user_id: ç”¨æˆ·ID
            subject_ids: ç§‘ç›®IDåˆ—è¡¨
            action: æ“ä½œç±»å‹ï¼ˆ'restrict' æˆ– 'unrestrict'ï¼‰
            admin_id: æ“ä½œçš„ç®¡ç†å‘˜ID
            
        Returns:
            æ“ä½œç»“æœå­—å…¸
        """
        if action == 'restrict':
            return SubjectPermissionService.restrict_subjects(user_id, subject_ids, admin_id)
        elif action == 'unrestrict':
            conn = get_db()
            success_count = 0
            
            try:
                for subject_id in subject_ids:
                    deleted = conn.execute(
                        'DELETE FROM user_subjects WHERE user_id = ? AND subject_id = ?',
                        (user_id, subject_id)
                    ).rowcount
                    if deleted > 0:
                        success_count += 1
                
                conn.commit()
                
                return {
                    'unrestricted_count': success_count,
                    'message': f'æˆåŠŸå–æ¶ˆé™åˆ¶ {success_count} ä¸ªç§‘ç›®'
                }
            except Exception as e:
                conn.rollback()
                raise Exception(f"å–æ¶ˆé™åˆ¶å¤±è´¥: {str(e)}")
        else:
            raise ValueError(f"ä¸æ”¯æŒçš„æ“ä½œç±»å‹: {action}")
    
    @staticmethod
    def batch_restrict_users_subjects(
        user_ids: List[int],
        subject_ids: List[int],
        action: str,
        admin_id: int
    ) -> Dict[str, Any]:
        """
        æ‰¹é‡ä¸ºå¤šä¸ªç”¨æˆ·é™åˆ¶/å–æ¶ˆé™åˆ¶å¤šä¸ªç§‘ç›®
        
        Args:
            user_ids: ç”¨æˆ·IDåˆ—è¡¨
            subject_ids: ç§‘ç›®IDåˆ—è¡¨
            action: æ“ä½œç±»å‹ï¼ˆ'restrict' æˆ– 'unrestrict'ï¼‰
            admin_id: æ“ä½œçš„ç®¡ç†å‘˜ID
            
        Returns:
            æ“ä½œç»“æœå­—å…¸
        """
        if not user_ids or not subject_ids:
            raise ValueError("ç”¨æˆ·IDåˆ—è¡¨å’Œç§‘ç›®IDåˆ—è¡¨ä¸èƒ½ä¸ºç©º")
        
        conn = get_db()
        affected_users = 0
        affected_subjects = len(subject_ids)
        
        try:
            for user_id in user_ids:
                # è·³è¿‡ç®¡ç†å‘˜ï¼ˆç®¡ç†å‘˜ä¸å—é™åˆ¶ï¼‰
                if is_admin(user_id):
                    continue
                
                if action == 'restrict':
                    for subject_id in subject_ids:
                        existing = conn.execute(
                            'SELECT id FROM user_subjects WHERE user_id = ? AND subject_id = ?',
                            (user_id, subject_id)
                        ).fetchone()
                        
                        if not existing:
                            conn.execute(
                                '''INSERT INTO user_subjects 
                                   (user_id, subject_id, restricted_by)
                                   VALUES (?, ?, ?)''',
                                (user_id, subject_id, admin_id)
                            )
                elif action == 'unrestrict':
                    for subject_id in subject_ids:
                        conn.execute(
                            'DELETE FROM user_subjects WHERE user_id = ? AND subject_id = ?',
                            (user_id, subject_id)
                        )
                
                affected_users += 1
            
            conn.commit()
            
            return {
                'affected_users': affected_users,
                'affected_subjects': affected_subjects,
                'message': f'æˆåŠŸä¸º {affected_users} ä¸ªç”¨æˆ·{action} {affected_subjects} ä¸ªç§‘ç›®'
            }
        except Exception as e:
            conn.rollback()
            raise Exception(f"æ‰¹é‡æ“ä½œå¤±è´¥: {str(e)}")
    
    @staticmethod
    def get_overview_data(
        page: int = 1,
        per_page: int = 20,
        search: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        è·å–æ‰¹é‡ç®¡ç†é¡µé¢æ‰€éœ€çš„æ•°æ®
        
        Args:
            page: é¡µç 
            per_page: æ¯é¡µæ•°é‡
            search: æœç´¢å…³é”®è¯
            
        Returns:
            åŒ…å«ç”¨æˆ·åˆ—è¡¨ã€ç§‘ç›®åˆ—è¡¨å’Œç»Ÿè®¡ä¿¡æ¯çš„å­—å…¸
        """
        conn = get_db()
        offset = (page - 1) * per_page
        
        # æ„å»ºç”¨æˆ·æŸ¥è¯¢
        user_where = 'WHERE 1=1'
        user_params = []
        
        if search:
            user_where += ' AND username LIKE ?'
            user_params.append(f'%{search}%')
        
        # è·å–ç”¨æˆ·æ€»æ•°
        total_users = conn.execute(
            f'SELECT COUNT(1) FROM users {user_where}',
            user_params
        ).fetchone()[0]
        
        # è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆå¸¦é™åˆ¶ç§‘ç›®ç»Ÿè®¡ï¼‰
        users_sql = f'''
            SELECT u.id, u.username,
                   COUNT(DISTINCT us.subject_id) as restricted_subjects_count
            FROM users u
            LEFT JOIN user_subjects us ON u.id = us.user_id
            {user_where}
            GROUP BY u.id, u.username
            ORDER BY u.id
            LIMIT ? OFFSET ?
        '''
        users = conn.execute(users_sql, user_params + [per_page, offset]).fetchall()
        
        # è·å–ç§‘ç›®æ€»æ•°
        total_subjects = conn.execute('SELECT COUNT(1) FROM subjects').fetchone()[0]
        
        # è·å–ç§‘ç›®åˆ—è¡¨ï¼ˆå¸¦é™åˆ¶ç”¨æˆ·ç»Ÿè®¡ï¼‰
        subjects = conn.execute('''
            SELECT s.id, s.name, COUNT(q.id) as question_count,
                   COUNT(DISTINCT us.user_id) as restricted_users_count
            FROM subjects s
            LEFT JOIN questions q ON s.id = q.subject_id
            LEFT JOIN user_subjects us ON s.id = us.subject_id
            GROUP BY s.id, s.name
            ORDER BY s.id
        ''').fetchall()
        
        # è·å–æ€»é™åˆ¶æ•°
        total_restrictions = conn.execute(
            'SELECT COUNT(1) FROM user_subjects'
        ).fetchone()[0]
        
        return {
            'users': [
                {
                    'id': u['id'],
                    'username': u['username'],
                    'restricted_subjects_count': u['restricted_subjects_count'] or 0,
                    'total_subjects_count': total_subjects
                }
                for u in users
            ],
            'subjects': [
                {
                    'id': s['id'],
                    'name': s['name'],
                    'question_count': s['question_count'],
                    'restricted_users_count': s['restricted_users_count'] or 0
                }
                for s in subjects
            ],
            'stats': {
                'total_users': total_users,
                'total_subjects': total_subjects,
                'total_restrictions': total_restrictions
            },
            'pagination': {
                'page': page,
                'per_page': per_page,
                'total': total_users,
                'pages': (total_users + per_page - 1) // per_page
            }
        }
```

### 2. ç³»ç»Ÿé…ç½®ç®¡ç†æœåŠ¡

**ä½ç½®**ï¼š`app/modules/admin/services/system_config_service.py`

```python
# -*- coding: utf-8 -*-
"""
ç³»ç»Ÿé…ç½®ç®¡ç†æœåŠ¡
"""
from typing import Dict, Any, List, Optional
from app.core.utils.database import get_db


class SystemConfigService:
    """ç³»ç»Ÿé…ç½®ç®¡ç†æœåŠ¡ç±»"""
    
    @staticmethod
    def get_all_configs() -> List[Dict[str, Any]]:
        """
        è·å–æ‰€æœ‰ç³»ç»Ÿé…ç½®
        
        Returns:
            é…ç½®åˆ—è¡¨
        """
        conn = get_db()
        rows = conn.execute(
            'SELECT * FROM system_config ORDER BY config_key'
        ).fetchall()
        
        return [dict(row) for row in rows]
    
    @staticmethod
    def get_config(config_key: str) -> Optional[Dict[str, Any]]:
        """
        è·å–æŒ‡å®šé…ç½®
        
        Args:
            config_key: é…ç½®é”®
            
        Returns:
            é…ç½®å­—å…¸ï¼Œå¦‚æœä¸å­˜åœ¨è¿”å›None
        """
        conn = get_db()
        row = conn.execute(
            'SELECT * FROM system_config WHERE config_key = ?',
            (config_key,)
        ).fetchone()
        
        return dict(row) if row else None
    
    @staticmethod
    def update_config(
        config_key: str,
        config_value: str,
        description: Optional[str] = None,
        admin_id: Optional[int] = None
    ) -> Dict[str, Any]:
        """
        æ›´æ–°ç³»ç»Ÿé…ç½®
        
        Args:
            config_key: é…ç½®é”®
            config_value: é…ç½®å€¼
            description: é…ç½®è¯´æ˜ï¼ˆå¯é€‰ï¼‰
            admin_id: æ“ä½œçš„ç®¡ç†å‘˜IDï¼ˆå¯é€‰ï¼‰
            
        Returns:
            æ›´æ–°åçš„é…ç½®å­—å…¸
        """
        conn = get_db()
        
        # æ£€æŸ¥é…ç½®æ˜¯å¦å­˜åœ¨
        existing = conn.execute(
            'SELECT id FROM system_config WHERE config_key = ?',
            (config_key,)
        ).fetchone()
        
        if existing:
            # æ›´æ–°ç°æœ‰é…ç½®
            update_sql = '''
                UPDATE system_config 
                SET config_value = ?, updated_at = CURRENT_TIMESTAMP, updated_by = ?
            '''
            params = [config_value, admin_id]
            
            if description:
                update_sql = update_sql.replace('updated_by = ?', 'description = ?, updated_by = ?')
                params = [config_value, description, admin_id]
            
            conn.execute(update_sql, params)
        else:
            # åˆ›å»ºæ–°é…ç½®
            conn.execute(
                '''INSERT INTO system_config 
                   (config_key, config_value, description, updated_by)
                   VALUES (?, ?, ?, ?)''',
                (config_key, config_value, description or '', admin_id)
            )
        
        conn.commit()
        
        return SystemConfigService.get_config(config_key)
    
    @staticmethod
    def get_quiz_limit_config() -> Dict[str, Any]:
        """
        è·å–åˆ·é¢˜é™åˆ¶ç›¸å…³é…ç½®
        
        Returns:
            åŒ…å«åŠŸèƒ½å¼€å…³å’Œé™åˆ¶æ•°é‡çš„å­—å…¸
        """
        enabled_config = SystemConfigService.get_config('quiz_limit_enabled')
        count_config = SystemConfigService.get_config('quiz_limit_count')
        
        return {
            'quiz_limit_enabled': enabled_config['config_value'] == '1' if enabled_config else False,
            'quiz_limit_count': int(count_config['config_value']) if count_config else 100
        }
```

### 3. åˆ·é¢˜ç»Ÿè®¡ç®¡ç†æœåŠ¡

**ä½ç½®**ï¼š`app/modules/admin/services/quiz_stats_service.py`

```python
# -*- coding: utf-8 -*-
"""
åˆ·é¢˜ç»Ÿè®¡ç®¡ç†æœåŠ¡
"""
from typing import Dict, Any, List, Optional
from app.core.utils.database import get_db
from app.core.utils.subject_permissions import (
    get_user_quiz_count,
    get_quiz_limit_count,
    is_quiz_limit_enabled
)


class QuizStatsService:
    """åˆ·é¢˜ç»Ÿè®¡ç®¡ç†æœåŠ¡ç±»"""
    
    @staticmethod
    def get_user_quiz_stats(user_id: int) -> Dict[str, Any]:
        """
        è·å–ç”¨æˆ·åˆ·é¢˜ç»Ÿè®¡
        
        Args:
            user_id: ç”¨æˆ·ID
            
        Returns:
            ç”¨æˆ·åˆ·é¢˜ç»Ÿè®¡å­—å…¸
        """
        conn = get_db()
        
        # è·å–ç”¨æˆ·ä¿¡æ¯
        user = conn.execute(
            'SELECT id, username, is_admin FROM users WHERE id = ?',
            (user_id,)
        ).fetchone()
        
        if not user:
            raise ValueError(f"ç”¨æˆ· {user_id} ä¸å­˜åœ¨")
        
        # è·å–åˆ·é¢˜ç»Ÿè®¡
        stats = conn.execute(
            'SELECT total_answered, last_reset_at, updated_at FROM user_quiz_stats WHERE user_id = ?',
            (user_id,)
        ).fetchone()
        
        current_count = stats['total_answered'] if stats else 0
        limit_count = get_quiz_limit_count()
        is_enabled = is_quiz_limit_enabled()
        
        return {
            'user': {
                'id': user['id'],
                'username': user['username'],
                'is_admin': bool(user['is_admin'])
            },
            'stats': {
                'total_answered': current_count,
                'limit_count': limit_count,
                'remaining': max(0, limit_count - current_count) if is_enabled else None,
                'is_limit_enabled': is_enabled,
                'last_reset_at': stats['last_reset_at'] if stats else None,
                'updated_at': stats['updated_at'] if stats else None
            }
        }
    
    @staticmethod
    def reset_user_quiz_count(user_id: int) -> None:
        """
        é‡ç½®ç”¨æˆ·åˆ·é¢˜æ•°
        
        Args:
            user_id: ç”¨æˆ·ID
        """
        from app.core.utils.subject_permissions import reset_user_quiz_count
        reset_user_quiz_count(user_id)
    
    @staticmethod
    def batch_reset_quiz_count(user_ids: List[int]) -> Dict[str, Any]:
        """
        æ‰¹é‡é‡ç½®ç”¨æˆ·åˆ·é¢˜æ•°
        
        Args:
            user_ids: ç”¨æˆ·IDåˆ—è¡¨
            
        Returns:
            æ“ä½œç»“æœå­—å…¸
        """
        success_count = 0
        
        for user_id in user_ids:
            try:
                QuizStatsService.reset_user_quiz_count(user_id)
                success_count += 1
            except Exception:
                continue
        
        return {
            'success_count': success_count,
            'total_count': len(user_ids),
            'message': f'æˆåŠŸé‡ç½® {success_count} ä¸ªç”¨æˆ·çš„åˆ·é¢˜æ•°'
        }
```

---

## ğŸ“¡ API è·¯ç”±å®ç°

### 1. Pydantic Schema å®šä¹‰

**ä½ç½®**ï¼š`app/modules/admin/schemas.py`

```python
# -*- coding: utf-8 -*-
"""
ç®¡ç†åå° API Schema å®šä¹‰ï¼ˆPydanticï¼‰
"""
from pydantic import BaseModel, Field
from typing import List, Optional


class SubjectIdsSchema(BaseModel):
    """ç§‘ç›®IDåˆ—è¡¨Schema"""
    subject_ids: List[int] = Field(..., description="ç§‘ç›®IDåˆ—è¡¨", min_items=1)


class BatchSubjectActionSchema(BaseModel):
    """æ‰¹é‡ç§‘ç›®æ“ä½œSchema"""
    action: str = Field(..., description="æ“ä½œç±»å‹", pattern="^(restrict|unrestrict)$")
    subject_ids: List[int] = Field(..., description="ç§‘ç›®IDåˆ—è¡¨", min_items=1)


class BatchUserSubjectActionSchema(BaseModel):
    """æ‰¹é‡ç”¨æˆ·ç§‘ç›®æ“ä½œSchema"""
    action: str = Field(..., description="æ“ä½œç±»å‹", pattern="^(restrict|unrestrict)$")
    user_ids: List[int] = Field(..., description="ç”¨æˆ·IDåˆ—è¡¨", min_items=1)
    subject_ids: List[int] = Field(..., description="ç§‘ç›®IDåˆ—è¡¨", min_items=1)


class SystemConfigUpdateSchema(BaseModel):
    """ç³»ç»Ÿé…ç½®æ›´æ–°Schema"""
    config_value: str = Field(..., description="é…ç½®å€¼")
    description: Optional[str] = Field(None, description="é…ç½®è¯´æ˜")


class BatchResetQuizCountSchema(BaseModel):
    """æ‰¹é‡é‡ç½®åˆ·é¢˜æ•°Schema"""
    user_ids: List[int] = Field(..., description="ç”¨æˆ·IDåˆ—è¡¨", min_items=1)
```

### 2. API è·¯ç”±å®ç°

**ä½ç½®**ï¼š`app/modules/admin/routes/api.py`ï¼ˆè¿½åŠ åˆ°ç°æœ‰æ–‡ä»¶ï¼‰

```python
# å¯¼å…¥æœåŠ¡å±‚å’ŒSchema
from app.modules.admin.services.subject_permission_service import SubjectPermissionService
from app.modules.admin.services.system_config_service import SystemConfigService
from app.modules.admin.services.quiz_stats_service import QuizStatsService
from app.modules.admin.schemas import (
    SubjectIdsSchema,
    BatchSubjectActionSchema,
    BatchUserSubjectActionSchema,
    SystemConfigUpdateSchema,
    BatchResetQuizCountSchema
)
from app.core.utils.decorators import admin_required


# ==================== ç”¨æˆ·ç§‘ç›®æƒé™ç®¡ç† API ====================

@admin_api_bp.route('/users/<int:user_id>/subjects', methods=['GET'])
@admin_required
def get_user_subjects(user_id: int):
    """è·å–ç”¨æˆ·ç§‘ç›®æƒé™ä¿¡æ¯"""
    try:
        data = SubjectPermissionService.get_user_subjects(user_id)
        return jsonify({
            'status': 'success',
            'data': data
        })
    except ValueError as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 404
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'è·å–ç”¨æˆ·ç§‘ç›®æƒé™å¤±è´¥: {str(e)}'
        }), 500


@admin_api_bp.route('/users/<int:user_id>/subjects', methods=['POST'])
@admin_required
def restrict_user_subjects(user_id: int):
    """é™åˆ¶ç”¨æˆ·è®¿é—®æŒ‡å®šç§‘ç›®"""
    try:
        # ä½¿ç”¨PydanticéªŒè¯è¯·æ±‚æ•°æ®
        schema = SubjectIdsSchema.parse_obj(request.json)
        admin_id = session.get('user_id')
        
        result = SubjectPermissionService.restrict_subjects(
            user_id,
            schema.subject_ids,
            admin_id
        )
        
        return jsonify({
            'status': 'success',
            'message': result['message'],
            'data': {
                'restricted_count': result['restricted_count']
            }
        })
    except ValueError as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 400
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'é™åˆ¶ç§‘ç›®å¤±è´¥: {str(e)}'
        }), 500


@admin_api_bp.route('/users/<int:user_id>/subjects/<int:subject_id>', methods=['DELETE'])
@admin_required
def unrestrict_user_subject(user_id: int, subject_id: int):
    """å–æ¶ˆç”¨æˆ·å¯¹æŒ‡å®šç§‘ç›®çš„é™åˆ¶"""
    try:
        SubjectPermissionService.unrestrict_subject(user_id, subject_id)
        return jsonify({
            'status': 'success',
            'message': 'å·²å–æ¶ˆç§‘ç›®é™åˆ¶'
        })
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'å–æ¶ˆé™åˆ¶å¤±è´¥: {str(e)}'
        }), 500


@admin_api_bp.route('/users/<int:user_id>/subjects/batch', methods=['POST'])
@admin_required
def batch_user_subjects(user_id: int):
    """æ‰¹é‡é™åˆ¶/å–æ¶ˆé™åˆ¶ç§‘ç›®"""
    try:
        schema = BatchSubjectActionSchema.parse_obj(request.json)
        admin_id = session.get('user_id')
        
        result = SubjectPermissionService.batch_restrict_subjects(
            user_id,
            schema.subject_ids,
            schema.action,
            admin_id
        )
        
        return jsonify({
            'status': 'success',
            'message': result['message'],
            'data': result
        })
    except ValueError as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 400
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'æ‰¹é‡æ“ä½œå¤±è´¥: {str(e)}'
        }), 500


# ==================== æ‰¹é‡ç®¡ç† API ====================

@admin_api_bp.route('/subject_permissions/overview', methods=['GET'])
@admin_required
def get_subject_permissions_overview():
    """è·å–æ‰¹é‡ç®¡ç†é¡µé¢æ•°æ®"""
    try:
        page = parse_int(request.args.get('page'), 1, 1)
        per_page = parse_int(request.args.get('per_page'), 20, 1, 100)
        search = request.args.get('search', '').strip() or None
        
        data = SubjectPermissionService.get_overview_data(page, per_page, search)
        
        return jsonify({
            'status': 'success',
            'data': data
        })
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'è·å–æ•°æ®å¤±è´¥: {str(e)}'
        }), 500


@admin_api_bp.route('/subject_permissions/batch', methods=['POST'])
@admin_required
def batch_subject_permissions():
    """æ‰¹é‡æ“ä½œç”¨æˆ·ç§‘ç›®æƒé™"""
    try:
        schema = BatchUserSubjectActionSchema.parse_obj(request.json)
        admin_id = session.get('user_id')
        
        result = SubjectPermissionService.batch_restrict_users_subjects(
            schema.user_ids,
            schema.subject_ids,
            schema.action,
            admin_id
        )
        
        return jsonify({
            'status': 'success',
            'message': result['message'],
            'data': {
                'affected_users': result['affected_users'],
                'affected_subjects': result['affected_subjects']
            }
        })
    except ValueError as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 400
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'æ‰¹é‡æ“ä½œå¤±è´¥: {str(e)}'
        }), 500


# ==================== ç³»ç»Ÿé…ç½®ç®¡ç† API ====================

@admin_api_bp.route('/system_config', methods=['GET'])
@admin_required
def get_system_configs():
    """è·å–æ‰€æœ‰ç³»ç»Ÿé…ç½®"""
    try:
        configs = SystemConfigService.get_all_configs()
        return jsonify({
            'status': 'success',
            'data': configs
        })
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'è·å–é…ç½®å¤±è´¥: {str(e)}'
        }), 500


@admin_api_bp.route('/system_config/<config_key>', methods=['PUT'])
@admin_required
def update_system_config(config_key: str):
    """æ›´æ–°ç³»ç»Ÿé…ç½®"""
    try:
        schema = SystemConfigUpdateSchema.parse_obj(request.json)
        admin_id = session.get('user_id')
        
        config = SystemConfigService.update_config(
            config_key,
            schema.config_value,
            schema.description,
            admin_id
        )
        
        return jsonify({
            'status': 'success',
            'message': 'é…ç½®æ›´æ–°æˆåŠŸ',
            'data': config
        })
    except ValueError as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 400
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'æ›´æ–°é…ç½®å¤±è´¥: {str(e)}'
        }), 500


@admin_api_bp.route('/system_config/quiz_limit', methods=['GET'])
@admin_required
def get_quiz_limit_config():
    """è·å–åˆ·é¢˜é™åˆ¶é…ç½®"""
    try:
        config = SystemConfigService.get_quiz_limit_config()
        return jsonify({
            'status': 'success',
            'data': config
        })
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'è·å–é…ç½®å¤±è´¥: {str(e)}'
        }), 500


# ==================== ç”¨æˆ·åˆ·é¢˜æ•°ç®¡ç† API ====================

@admin_api_bp.route('/users/<int:user_id>/quiz_stats', methods=['GET'])
@admin_required
def get_user_quiz_stats(user_id: int):
    """è·å–ç”¨æˆ·åˆ·é¢˜ç»Ÿè®¡"""
    try:
        data = QuizStatsService.get_user_quiz_stats(user_id)
        return jsonify({
            'status': 'success',
            'data': data
        })
    except ValueError as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 404
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'è·å–ç»Ÿè®¡å¤±è´¥: {str(e)}'
        }), 500


@admin_api_bp.route('/users/<int:user_id>/reset_quiz_count', methods=['POST'])
@admin_required
def reset_user_quiz_count(user_id: int):
    """é‡ç½®ç”¨æˆ·åˆ·é¢˜æ•°"""
    try:
        QuizStatsService.reset_user_quiz_count(user_id)
        return jsonify({
            'status': 'success',
            'message': 'åˆ·é¢˜æ•°é‡ç½®æˆåŠŸ'
        })
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'é‡ç½®å¤±è´¥: {str(e)}'
        }), 500


@admin_api_bp.route('/users/batch_reset_quiz_count', methods=['POST'])
@admin_required
def batch_reset_quiz_count():
    """æ‰¹é‡é‡ç½®ç”¨æˆ·åˆ·é¢˜æ•°"""
    try:
        schema = BatchResetQuizCountSchema.parse_obj(request.json)
        result = QuizStatsService.batch_reset_quiz_count(schema.user_ids)
        
        return jsonify({
            'status': 'success',
            'message': result['message'],
            'data': result
        })
    except ValueError as e:
        return jsonify({
            'status': 'error',
            'message': str(e)
        }), 400
    except Exception as e:
        return jsonify({
            'status': 'error',
            'message': f'æ‰¹é‡é‡ç½®å¤±è´¥: {str(e)}'
        }), 500
```

---

## ğŸ¨ é¡µé¢è·¯ç”±å®ç°

### 1. é¢˜åº“ç®¡ç†é¡µé¢è·¯ç”±

**ä½ç½®**ï¼š`app/modules/admin/routes/pages.py`ï¼ˆè¿½åŠ ï¼‰

```python
@admin_pages_bp.route('/subject_permissions')
@admin_required
def admin_subject_permissions_page():
    """é¢˜åº“ç®¡ç†é¡µé¢ï¼ˆæ‰¹é‡æ“ä½œï¼‰"""
    return render_template('admin/admin_subject_permissions.html')
```

### 2. ä¿®æ”¹ä¾§è¾¹æ 

**ä½ç½®**ï¼š`app/modules/admin/templates/admin/admin_base.html`

åœ¨ä¾§è¾¹æ èœå•ä¸­æ·»åŠ "é¢˜åº“ç®¡ç†"é¡¹ï¼š

```html
{% if session.get('is_admin') %}
<li><a href="/admin/users" class="{% if request.path == '/admin/users' %}active{% endif %}">ç”¨æˆ·ç®¡ç†</a></li>
<li><a href="/admin/subject_permissions" class="{% if request.path == '/admin/subject_permissions' %}active{% endif %}">é¢˜åº“ç®¡ç†</a></li>
<li><a href="/admin/coding" class="{% if request.path.startswith('/admin/coding') %}active{% endif %}">ç¼–ç¨‹ç®¡ç†</a></li>
{% endif %}
```

---

## ğŸ“„ å‰ç«¯æ¨¡æ¿å®ç°

### 1. ç”¨æˆ·è¯¦æƒ…é¡µç§‘ç›®æƒé™ç®¡ç†å¡ç‰‡

**ä½ç½®**ï¼š`app/modules/admin/templates/admin/admin_user_detail.html`

åœ¨ç”¨æˆ·èµ„æ–™å¡ç‰‡å’Œç»Ÿè®¡å¡ç‰‡ä¹‹åæ·»åŠ ï¼š

```html
<!-- ç§‘ç›®æƒé™ç®¡ç†å¡ç‰‡ -->
<div class="section-card">
  <h3 class="section-header">ç§‘ç›®æƒé™ç®¡ç†</h3>
  <div id="subject-permission-card">
    <div class="permission-stats">
      <span>è¢«é™åˆ¶ç§‘ç›®: <strong id="restricted-count">0</strong>/<span id="total-count">0</span></span>
    </div>
    <div id="restricted-subjects-list" class="subjects-tags">
      <!-- åŠ¨æ€åŠ è½½ -->
    </div>
    <button class="btn-primary" onclick="openSubjectPermissionModal()">ç®¡ç†ç§‘ç›®æƒé™</button>
  </div>
</div>

<!-- ç§‘ç›®æƒé™ç®¡ç†å¼¹çª— -->
<div id="subject-permission-modal" class="modal-overlay" onclick="if(event.target === this) closeSubjectPermissionModal()">
  <div class="modal-content" style="max-width: 600px;">
    <h3 class="modal-header">ç®¡ç†ç§‘ç›®æƒé™</h3>
    <div class="modal-body">
      <div class="search-box">
        <input type="text" id="subject-search" placeholder="æœç´¢ç§‘ç›®..." oninput="filterSubjects()">
      </div>
      <div class="subjects-checkbox-list" id="subjects-checkbox-list">
        <!-- åŠ¨æ€åŠ è½½ -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-outline" onclick="closeSubjectPermissionModal()">å–æ¶ˆ</button>
      <button class="btn-secondary" onclick="selectAllSubjects()">å…¨é€‰</button>
      <button class="btn-secondary" onclick="unselectAllSubjects()">å…¨ä¸é€‰</button>
      <button class="btn-primary" onclick="saveSubjectPermissions()">ä¿å­˜</button>
    </div>
  </div>
</div>
```

### 2. é¢˜åº“ç®¡ç†é¡µé¢

**ä½ç½®**ï¼š`app/modules/admin/templates/admin/admin_subject_permissions.html`

åˆ›å»ºå®Œæ•´çš„æ‰¹é‡ç®¡ç†é¡µé¢ï¼ˆiOS 18é£æ ¼ï¼‰ï¼ŒåŒ…å«ï¼š
- ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡
- æ‰¹é‡æ“ä½œå·¥å…·æ 
- ç”¨æˆ·åˆ—è¡¨ï¼ˆå·¦ä¾§ï¼‰
- ç§‘ç›®åˆ—è¡¨ï¼ˆå³ä¾§ï¼‰
- ç³»ç»Ÿé…ç½®ç®¡ç†åŒºåŸŸ
- åˆ·é¢˜æ•°ç®¡ç†åŒºåŸŸ

---

## ğŸ”§ ä¿®æ”¹ç°æœ‰é¡µé¢

### 1. ç”¨æˆ·ç®¡ç†é¡µé¢å¢å¼º

**ä½ç½®**ï¼š`app/modules/admin/templates/admin/admin_users.html`

åœ¨ç”¨æˆ·åˆ—è¡¨è¡¨æ ¼ä¸­æ·»åŠ "è¢«é™åˆ¶ç§‘ç›®æ•°"åˆ—ï¼š

```html
<th>è¢«é™åˆ¶ç§‘ç›®æ•°</th>
```

åœ¨è¡¨æ ¼æ•°æ®è¡Œä¸­ï¼š

```html
<td>
  <span id="restricted-count-{{ user.id }}">åŠ è½½ä¸­...</span>
</td>
```

æ·»åŠ JavaScriptä»£ç ï¼Œåœ¨é¡µé¢åŠ è½½æ—¶è·å–æ¯ä¸ªç”¨æˆ·çš„è¢«é™åˆ¶ç§‘ç›®æ•°ã€‚

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### 1. API æµ‹è¯•

**ä½ç½®**ï¼š`tests/test_admin_subject_permissions.py`

```python
# -*- coding: utf-8 -*-
"""
ç®¡ç†åå°ç§‘ç›®æƒé™ç®¡ç†APIæµ‹è¯•
"""
import pytest
from app import create_app
from app.core.utils.database import get_db


@pytest.fixture
def client():
    app = create_app()
    app.config['TESTING'] = True
    with app.test_client() as client:
        with app.app_context():
            yield client


def test_get_user_subjects(client):
    """æµ‹è¯•è·å–ç”¨æˆ·ç§‘ç›®æƒé™"""
    # ç™»å½•ç®¡ç†å‘˜
    # è·å–ç”¨æˆ·ç§‘ç›®æƒé™
    # éªŒè¯å“åº”æ ¼å¼
    pass


def test_restrict_subjects(client):
    """æµ‹è¯•é™åˆ¶ç§‘ç›®"""
    # ç™»å½•ç®¡ç†å‘˜
    # é™åˆ¶ç”¨æˆ·è®¿é—®ç§‘ç›®
    # éªŒè¯é™åˆ¶æˆåŠŸ
    pass


def test_batch_restrict(client):
    """æµ‹è¯•æ‰¹é‡é™åˆ¶"""
    # ç™»å½•ç®¡ç†å‘˜
    # æ‰¹é‡é™åˆ¶å¤šä¸ªç”¨æˆ·å¤šä¸ªç§‘ç›®
    # éªŒè¯æ‰¹é‡æ“ä½œæˆåŠŸ
    pass
```

### 2. æœåŠ¡å±‚æµ‹è¯•

**ä½ç½®**ï¼š`tests/test_subject_permission_service.py`

```python
# -*- coding: utf-8 -*-
"""
ç§‘ç›®æƒé™ç®¡ç†æœåŠ¡æµ‹è¯•
"""
import pytest
from app.modules.admin.services.subject_permission_service import SubjectPermissionService


def test_get_user_subjects():
    """æµ‹è¯•è·å–ç”¨æˆ·ç§‘ç›®æƒé™"""
    pass


def test_restrict_subjects():
    """æµ‹è¯•é™åˆ¶ç§‘ç›®"""
    pass


def test_batch_restrict_users_subjects():
    """æµ‹è¯•æ‰¹é‡é™åˆ¶"""
    pass
```

---

## ğŸ“ å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šåˆ›å»ºæœåŠ¡å±‚

1. åˆ›å»º `app/modules/admin/services/` ç›®å½•
2. å®ç° `subject_permission_service.py`
3. å®ç° `system_config_service.py`
4. å®ç° `quiz_stats_service.py`

### æ­¥éª¤2ï¼šåˆ›å»º Schema å®šä¹‰

1. åˆ›å»º `app/modules/admin/schemas.py`
2. å®šä¹‰æ‰€æœ‰ Pydantic Schema

### æ­¥éª¤3ï¼šå®ç° API è·¯ç”±

1. åœ¨ `app/modules/admin/routes/api.py` ä¸­æ·»åŠ APIè·¯ç”±
2. ä½¿ç”¨ `@admin_required` è£…é¥°å™¨ä¿æŠ¤è·¯ç”±
3. ä½¿ç”¨ Pydantic éªŒè¯è¯·æ±‚æ•°æ®

### æ­¥éª¤4ï¼šå®ç°é¡µé¢è·¯ç”±

1. æ·»åŠ é¢˜åº“ç®¡ç†é¡µé¢è·¯ç”±
2. ä¿®æ”¹ä¾§è¾¹æ ï¼Œæ·»åŠ "é¢˜åº“ç®¡ç†"èœå•é¡¹

### æ­¥éª¤5ï¼šå®ç°å‰ç«¯æ¨¡æ¿

1. ä¿®æ”¹ç”¨æˆ·è¯¦æƒ…é¡µï¼Œæ·»åŠ ç§‘ç›®æƒé™ç®¡ç†å¡ç‰‡
2. åˆ›å»ºé¢˜åº“ç®¡ç†é¡µé¢æ¨¡æ¿
3. ä¿®æ”¹ç”¨æˆ·ç®¡ç†é¡µé¢ï¼Œæ˜¾ç¤ºè¢«é™åˆ¶ç§‘ç›®æ•°

### æ­¥éª¤6ï¼šæµ‹è¯•

1. ç¼–å†™å¹¶è¿è¡Œå•å…ƒæµ‹è¯•
2. æ‰‹åŠ¨æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
3. æµ‹è¯•é”™è¯¯å¤„ç†

---

## âœ… éªŒæ”¶æ ‡å‡†

1. âœ… æ‰€æœ‰APIæ¥å£æ­£å¸¸å·¥ä½œï¼Œè¿”å›æ­£ç¡®çš„JSONæ ¼å¼
2. âœ… ä½¿ç”¨PydanticéªŒè¯è¯·æ±‚æ•°æ®ï¼Œé”™è¯¯å¤„ç†å®Œå–„
3. âœ… æœåŠ¡å±‚é€»è¾‘æ­£ç¡®ï¼Œä¸šåŠ¡é€»è¾‘ä¸è·¯ç”±åˆ†ç¦»
4. âœ… ç”¨æˆ·è¯¦æƒ…é¡µç§‘ç›®æƒé™ç®¡ç†å¡ç‰‡æ­£å¸¸æ˜¾ç¤ºå’Œæ“ä½œ
5. âœ… é¢˜åº“ç®¡ç†é¡µé¢æ‰¹é‡æ“ä½œåŠŸèƒ½æ­£å¸¸
6. âœ… ç³»ç»Ÿé…ç½®ç®¡ç†åŠŸèƒ½æ­£å¸¸
7. âœ… ç”¨æˆ·åˆ·é¢˜æ•°ç®¡ç†åŠŸèƒ½æ­£å¸¸
8. âœ… ä¾§è¾¹æ "é¢˜åº“ç®¡ç†"èœå•é¡¹æ­£å¸¸æ˜¾ç¤º
9. âœ… ç”¨æˆ·ç®¡ç†é¡µé¢æ˜¾ç¤ºè¢«é™åˆ¶ç§‘ç›®æ•°
10. âœ… æ‰€æœ‰åŠŸèƒ½ç¬¦åˆiOS 18é£æ ¼UIè®¾è®¡
11. âœ… é”™è¯¯å¤„ç†å®Œå–„ï¼Œç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
12. âœ… å•å…ƒæµ‹è¯•é€šè¿‡ç‡ 100%

---

## ğŸ“š ç›¸å…³æ–‡ä»¶æ¸…å•

### éœ€è¦åˆ›å»ºçš„æ–‡ä»¶

1. `app/modules/admin/services/__init__.py`
2. `app/modules/admin/services/subject_permission_service.py`
3. `app/modules/admin/services/system_config_service.py`
4. `app/modules/admin/services/quiz_stats_service.py`
5. `app/modules/admin/schemas.py`
6. `app/modules/admin/templates/admin/admin_subject_permissions.html`

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

1. `app/modules/admin/routes/api.py` - æ·»åŠ APIè·¯ç”±
2. `app/modules/admin/routes/pages.py` - æ·»åŠ é¡µé¢è·¯ç”±
3. `app/modules/admin/templates/admin/admin_base.html` - ä¿®æ”¹ä¾§è¾¹æ 
4. `app/modules/admin/templates/admin/admin_user_detail.html` - æ·»åŠ ç§‘ç›®æƒé™ç®¡ç†å¡ç‰‡
5. `app/modules/admin/templates/admin/admin_users.html` - æ˜¾ç¤ºè¢«é™åˆ¶ç§‘ç›®æ•°

### å¯é€‰æ–‡ä»¶

1. `tests/test_admin_subject_permissions.py` - APIæµ‹è¯•
2. `tests/test_subject_permission_service.py` - æœåŠ¡å±‚æµ‹è¯•

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æƒé™éªŒè¯**ï¼šæ‰€æœ‰APIè·¯ç”±å¿…é¡»ä½¿ç”¨ `@admin_required` è£…é¥°å™¨
2. **æ•°æ®éªŒè¯**ï¼šä½¿ç”¨Pydanticè¿›è¡Œè¯·æ±‚æ•°æ®éªŒè¯ï¼Œé¿å…æ‰‹åŠ¨è§£æ
3. **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼ï¼Œå‹å¥½çš„é”™è¯¯æç¤º
4. **äº‹åŠ¡å¤„ç†**ï¼šæ‰¹é‡æ“ä½œä½¿ç”¨äº‹åŠ¡ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¹é‡æŸ¥è¯¢ä½¿ç”¨JOINï¼Œé¿å…N+1æŸ¥è¯¢é—®é¢˜
6. **ä»£ç è§„èŒƒ**ï¼šéµå¾ªPEP 8ï¼Œä½¿ç”¨ç±»å‹æç¤ºï¼Œä¸­æ–‡æ³¨é‡Š
7. **UIä¸€è‡´æ€§**ï¼šæ‰€æœ‰é¡µé¢éµå¾ªiOS 18é£æ ¼è®¾è®¡è§„èŒƒ

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-29  
**é€‚ç”¨é˜¶æ®µ**ï¼šç¬¬äºŒé˜¶æ®µï¼ˆç®¡ç†åå°åŠŸèƒ½ï¼‰
