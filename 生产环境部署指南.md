# Ubuntu 24.04.2 LTS 生产环境部署指南（Flask + Gunicorn + systemd + Nginx + HTTPS）

本文档用于将本项目（题库系统 / Quiz Bank System）部署到 **Ubuntu 24.04.2 LTS** 的生产服务器上，推荐架构：

- `Nginx`：对外提供 `HTTPS`，反向代理到本机 Gunicorn
- `Gunicorn`：运行 Flask WSGI 应用（`run:app`）
- `systemd`：进程守护、开机自启、日志收集（journald）
- `SQLite`：默认数据库文件 `instance/submissions.db`

> 注意：本项目在启动时会自动创建/写入 `logs/`、`uploads/`、`instance/` 等目录与文件；部署时务必保证这些路径对运行用户可写。

---

## 0. 你需要提前准备

- 一台 Ubuntu 24.04.2 服务器（建议 2C/4G 起）
- 一个已解析到服务器 IP 的域名（例如：`ti.example.com`）
- 服务器放通端口：`22`（SSH）、`80/443`（HTTP/HTTPS）
- 微信小程序（如使用小程序登录/接口）：需要在微信公众平台配置 **request 合法域名**（必须 HTTPS）

---

## 1. 系统初始化与基础依赖安装

### 1.1 更新系统与基础工具

```bash
sudo apt update
sudo apt -y upgrade
sudo apt -y install curl git ca-certificates unzip
```

### 1.2 安装 Python / Nginx / 证书工具

```bash
sudo apt -y install \
  python3 python3-venv python3-pip \
  build-essential \
  sqlite3 \
  nginx \
  certbot python3-certbot-nginx
```

> 说明：`pandas/numpy` 通常有 wheel 包，但在少数环境下可能需要 `build-essential` 辅助编译，提前装上更省心。

### 1.3（可选但强烈建议）安装 Redis 作为限流存储

项目默认使用内存限流存储：`RATELIMIT_STORAGE_URL=memory://`。生产环境多 worker 时建议改 Redis：

```bash
sudo apt -y install redis-server
sudo systemctl enable --now redis-server
```

---

## 2. 创建运行用户与目录规划

### 2.1 创建专用用户（推荐）

```bash
sudo adduser --system --group --home /opt/saksk-ti --shell /usr/sbin/nologin saksk
```

### 2.2 放置项目代码

推荐目录：`/opt/saksk-ti/app`（代码）+ `/opt/saksk-ti/var`（可写数据：db/log/uploads）

```bash
sudo mkdir -p /opt/saksk-ti/app
sudo mkdir -p /opt/saksk-ti/var/{instance,uploads,logs,backup}
sudo chown -R saksk:saksk /opt/saksk-ti
```

然后将代码上传到服务器（任选一种方式）：

**方式 A：服务器直接拉取 Git 仓库**

```bash
cd /opt/saksk-ti/app
sudo -u saksk git clone <你的仓库地址> .
```

**方式 B：本地打包上传**

把项目文件上传到 `/opt/saksk-ti/app`（例如使用 `scp`/`rsync`/面板上传），确保包含：

- `app/`、`run.py`、`requirements.txt`、`static/`

> 建议：不要把本地的 `instance/*.db`、`uploads/*` 直接覆盖到线上，除非你明确要迁移数据。

---

## 3. Python 虚拟环境与依赖安装

```bash
cd /opt/saksk-ti/app
sudo -u saksk python3 -m venv .venv
sudo -u saksk ./.venv/bin/pip install -U pip wheel
sudo -u saksk ./.venv/bin/pip install -r requirements.txt
```

---

## 4. 配置环境变量（生产必做）

项目支持从 `.env` 读取环境变量（`python-dotenv` 已在依赖中），也推荐让 systemd 读取同一份环境文件。

在服务器创建 `/opt/saksk-ti/app/.env`：

```bash
sudo -u saksk tee /opt/saksk-ti/app/.env >/dev/null <<'EOF'
# 运行环境
FLASK_ENV=production
ENVIRONMENT=production

# 生产环境必须设置：强随机密钥
SECRET_KEY=CHANGE_ME_TO_A_LONG_RANDOM_STRING

# === 邮件（已支持后台配置）===
# 邮件配置支持在管理后台动态修改（优先读数据库 system_config），环境变量仅作为兜底。
# 为避免“未配置 SMTP 却尝试发信”，建议首次部署先关闭，配置好再在后台开启。
MAIL_ENABLED=false
MAIL_CONSOLE_OUTPUT=false
#
# （可选：环境变量兜底，不想写就保持注释）
# MAIL_SERVER=smtp.example.com
# MAIL_PORT=587
# MAIL_USE_TLS=true
# MAIL_USE_SSL=false
# MAIL_USERNAME=your-email@example.com
# MAIL_PASSWORD=your-smtp-password
# MAIL_DEFAULT_SENDER=noreply@example.com
# MAIL_DEFAULT_SENDER_NAME=系统通知

# 限流存储（强烈建议生产用 Redis）
# RATELIMIT_STORAGE_URL=redis://127.0.0.1:6379/0

# === AI 解析（阿里云百炼 DashScope OpenAI 兼容接口，可选）===
# 未配置 DASHSCOPE_API_KEY 时，接口会返回“占位解析”；配置后自动调用模型。
# DASHSCOPE_API_KEY=your-dashscope-api-key
# DASHSCOPE_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
# DASHSCOPE_MODEL=qwen-plus
# DASHSCOPE_TIMEOUT=25

# HTTPS 上线后再开启（否则纯 HTTP 访问时 Cookie 不会被浏览器携带）
SESSION_COOKIE_SECURE=false

# 微信小程序登录（如使用小程序端）
# WECHAT_APPID=wx_xxx
# WECHAT_SECRET=xxxx
EOF
```

加固权限（避免泄露密钥）：

```bash
sudo chmod 600 /opt/saksk-ti/app/.env
```

生成 `SECRET_KEY` 示例：

```bash
python3 -c 'import secrets; print(secrets.token_urlsafe(48))'
```

> 重要：不要把真实密钥提交回仓库；线上建议通过运维系统/环境变量管理注入。

### 4.1 邮件配置改为后台维护（推荐）

邮件发送/验证码逻辑会 **优先从数据库的 `system_config` 读取 `mail_*` 配置**（管理后台可改），如果数据库没有相关配置才回退到环境变量。

部署后，用管理员账号登录站点，进入：

- `https://<你的域名>/admin/settings/mail`

在此页面中配置（示例键名）：

- `mail_server`、`mail_port`
- `mail_use_tls` / `mail_use_ssl`
- `mail_username`、`mail_password`
- `mail_default_sender`、`mail_default_sender_name`
- `mail_enabled`、`mail_console_output`

> 提醒：邮件密码会写入数据库；请做好权限控制与数据库备份加密/保管。

### 4.2 AI 解析接口（可选）

AI 解析接口路径：

- `POST /api/quiz/ai/explain`

生产环境建议通过 `.env`（或 systemd 环境变量）配置：

- `DASHSCOPE_API_KEY`（必填才会真实调用）
- `DASHSCOPE_BASE_URL`（可选，默认北京）
- `DASHSCOPE_MODEL`（可选，默认 `qwen-plus`）
- `DASHSCOPE_TIMEOUT`（可选，默认 `25` 秒）

如果服务器有出网限制，请确保能访问 DashScope 对应域名（默认 `dashscope.aliyuncs.com`）。

---

## 5. 连接可写目录（数据库/上传/日志）

项目默认写入：

- 数据库：`instance/submissions.db`
- 上传：`uploads/`
- 日志：`logs/app.log`（生产环境启用）

为了把可写数据与代码分离，推荐在 `/opt/saksk-ti/app` 下做软链接指向 `/opt/saksk-ti/var`。

> 如果你是从旧服务器迁移，请先把旧的 `instance/submissions.db` 和 `uploads/` 同步到 `/opt/saksk-ti/var/` 再继续。

**首次部署（目录为空时）**：

```bash
cd /opt/saksk-ti/app
sudo -u saksk test -e instance || ln -s /opt/saksk-ti/var/instance instance
sudo -u saksk test -e uploads  || ln -s /opt/saksk-ti/var/uploads uploads
sudo -u saksk test -e logs     || ln -s /opt/saksk-ti/var/logs logs
```

**已存在目录（需要保留内容时）**：先迁移再建立软链接（下面命令会把旧内容移动到 `var/`，请确认路径无误再执行）

```bash
cd /opt/saksk-ti/app
sudo -u saksk test -d instance && mv instance/* /opt/saksk-ti/var/instance/ 2>/dev/null || true
sudo -u saksk test -d uploads  && mv uploads/*  /opt/saksk-ti/var/uploads/  2>/dev/null || true
sudo -u saksk test -d logs     && mv logs/*     /opt/saksk-ti/var/logs/     2>/dev/null || true

sudo -u saksk rm -rf instance uploads logs
sudo -u saksk ln -s /opt/saksk-ti/var/instance instance
sudo -u saksk ln -s /opt/saksk-ti/var/uploads uploads
sudo -u saksk ln -s /opt/saksk-ti/var/logs logs
```

> 如果你不想分离，也可以直接让 `/opt/saksk-ti/app/{instance,uploads,logs}` 可写即可。

---

## 6. 用 systemd 启动 Gunicorn（推荐）

### 6.1 创建 systemd 服务文件

创建 `/etc/systemd/system/saksk-ti.service`：

```bash
sudo tee /etc/systemd/system/saksk-ti.service >/dev/null <<'EOF'
[Unit]
Description=Saksk TI (Flask/Gunicorn)
After=network.target

[Service]
User=saksk
Group=saksk
WorkingDirectory=/opt/saksk-ti/app

# 读取 .env（与本项目 dotenv 一致：KEY=VALUE）
EnvironmentFile=/opt/saksk-ti/app/.env

# 让 gunicorn 使用虚拟环境
Environment="PATH=/opt/saksk-ti/app/.venv/bin"

# 推荐绑定到本机，由 Nginx 反代
ExecStart=/opt/saksk-ti/app/.venv/bin/gunicorn \
  --bind 127.0.0.1:8000 \
  --workers 3 \
  --worker-class sync \
  --timeout 60 \
  --access-logfile - \
  --error-logfile - \
  run:app

Restart=always
RestartSec=5

# 资源限制（可按需调整）
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF
```

> worker 数建议：`2 * CPU + 1`。例如 2C 可用 5；内存不足可调小。

### 6.2 启动与自启

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now saksk-ti
sudo systemctl status saksk-ti --no-pager
```

查看日志：

```bash
journalctl -u saksk-ti -f
```

应用自身日志文件（生产环境）：`/opt/saksk-ti/var/logs/app.log`

---

## 7. Nginx 反向代理与静态/上传文件

### 7.1 创建 Nginx 站点配置

创建 `/etc/nginx/sites-available/saksk-ti`：

```bash
sudo tee /etc/nginx/sites-available/saksk-ti >/dev/null <<'EOF'
server {
    listen 80;
    server_name ti.example.com;

    client_max_body_size 16m;

    # 上传文件：/uploads/xxx
    location /uploads/ {
        alias /opt/saksk-ti/var/uploads/;
        access_log off;
        expires 7d;
    }

    # 静态资源：/static/xxx（也可交给 Flask 处理，这里建议由 Nginx 托管）
    location /static/ {
        alias /opt/saksk-ti/app/static/;
        access_log off;
        expires 7d;
    }

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 兼容潜在的长连接/升级（即使不用也无害）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
EOF
```

启用站点并检查配置：

```bash
sudo ln -sf /etc/nginx/sites-available/saksk-ti /etc/nginx/sites-enabled/saksk-ti
sudo nginx -t
sudo systemctl reload nginx
```

### 7.2（推荐）配置 UFW 防火墙

```bash
sudo ufw allow OpenSSH
sudo ufw allow 'Nginx Full'
sudo ufw enable
sudo ufw status
```

---

## 8. 申请 HTTPS 证书（Let’s Encrypt）

确保域名已解析到服务器公网 IP，并且 80 端口可访问：

```bash
sudo certbot --nginx -d ti.example.com
```

证书自动续期验证：

```bash
sudo certbot renew --dry-run
```

> 微信小程序请求域名必须为 HTTPS 且证书有效；完成后到微信公众平台配置合法域名。

HTTPS 生效后，建议把 `.env` 中的 `SESSION_COOKIE_SECURE` 改为 `true` 并重启服务：

```bash
sudo -u saksk sed -i 's/^SESSION_COOKIE_SECURE=.*/SESSION_COOKIE_SECURE=true/' /opt/saksk-ti/app/.env
sudo systemctl restart saksk-ti
```

---

## 9. 首次启动检查与管理员账号

### 9.1 本机健康检查（服务器上执行）

```bash
curl -I http://127.0.0.1:8000/
```

### 9.2 外网访问

```bash
curl -I https://ti.example.com/
```

### 9.3 管理员账号

按项目默认逻辑：**首次注册的用户会自动成为管理员**。部署完成后，打开站点注册第一个账号即可进入后台管理功能。

---

## 10. 数据备份（SQLite）

默认数据库文件：`/opt/saksk-ti/var/instance/submissions.db`

### 10.1 手动备份（推荐用 sqlite3 .backup）

```bash
sudo -u saksk sqlite3 /opt/saksk-ti/var/instance/submissions.db \
  ".backup '/opt/saksk-ti/var/backup/submissions_$(date +%F_%H%M%S).db'"
```

### 10.2 定时备份（cron 示例）

```bash
sudo tee /etc/cron.d/saksk-ti-backup >/dev/null <<'EOF'
SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
0 3 * * * saksk sqlite3 /opt/saksk-ti/var/instance/submissions.db ".backup '/opt/saksk-ti/var/backup/submissions_$(date +\\%F_\\%H\\%M\\%S).db'"
EOF
```

---

## 11. 升级发布流程（建议）

```bash
cd /opt/saksk-ti/app
sudo -u saksk git pull
sudo -u saksk ./.venv/bin/pip install -r requirements.txt
sudo systemctl restart saksk-ti
sudo systemctl status saksk-ti --no-pager
```

---

## 12. 常见问题排查

### 12.1 服务启动失败

```bash
sudo systemctl status saksk-ti --no-pager
journalctl -u saksk-ti -n 200 --no-pager
```

重点检查：

- `SECRET_KEY` 是否设置（生产环境必须）
- `instance/`、`uploads/`、`logs/` 是否对运行用户可写
- 端口 `8000` 是否被占用

### 12.2 上传文件 404

- 确认 Nginx `location /uploads/` 的 `alias` 指向 `/opt/saksk-ti/var/uploads/`
- 确认文件实际存在于该目录
- 确认权限：`ls -la /opt/saksk-ti/var/uploads`

### 12.3 限流在多 worker 下不一致

把 `.env` 中的 `RATELIMIT_STORAGE_URL` 改为 Redis：

```bash
RATELIMIT_STORAGE_URL=redis://127.0.0.1:6379/0
```

然后重启：

```bash
sudo systemctl restart saksk-ti
```

### 12.4 邮件发送失败 / 收不到验证码

优先检查管理后台邮件配置：

- `https://<你的域名>/admin/settings/mail`

其次检查（环境变量兜底时）：

- `.env` 中 `MAIL_ENABLED` 是否为 `true`
- SMTP 的 `MAIL_SERVER/MAIL_PORT/MAIL_USERNAME/MAIL_PASSWORD` 是否完整且授权码正确
