# 生产环境部署指南

## 1. 环境变量配置

创建 `.env` 文件（不要提交到版本控制）或设置系统环境变量：

```bash
# Flask环境配置
FLASK_ENV=production

# 安全密钥（必须修改！）
SECRET_KEY=your-very-long-random-secret-key-here

# 服务器配置
HOST=0.0.0.0
PORT=5000

# 邮件服务配置（QQ邮箱示例）
MAIL_SERVER=smtp.qq.com
MAIL_PORT=587
MAIL_USE_TLS=true
MAIL_USE_SSL=false
MAIL_USERNAME=your_qq_number@qq.com
MAIL_PASSWORD=your_authorization_code
MAIL_DEFAULT_SENDER=your_qq_number@qq.com
MAIL_DEFAULT_SENDER_NAME=系统通知
MAIL_ENABLED=true
MAIL_CONSOLE_OUTPUT=false
```

## 2. 使用 Gunicorn 部署（推荐）

### 安装 Gunicorn

```bash
pip install gunicorn
```

### 启动命令

```bash
# 基本启动
gunicorn -w 4 -b 0.0.0.0:5000 run:app

# 生产环境推荐配置
gunicorn -w 4 -b 0.0.0.0:5000 \
  --access-logfile logs/access.log \
  --error-logfile logs/error.log \
  --log-level info \
  --timeout 120 \
  --worker-class sync \
  run:app
```

### 使用 systemd 服务（Linux）

创建 `/etc/systemd/system/quiz-app.service`：

```ini
[Unit]
Description=Quiz Application
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/path/to/your/project
Environment="PATH=/path/to/venv/bin"
Environment="FLASK_ENV=production"
ExecStart=/path/to/venv/bin/gunicorn -w 4 -b 127.0.0.1:5000 --access-logfile logs/access.log --error-logfile logs/error.log run:app
Restart=always

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable quiz-app
sudo systemctl start quiz-app
sudo systemctl status quiz-app
```

## 3. 使用 Nginx 反向代理

创建 `/etc/nginx/sites-available/quiz-app`：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    client_max_body_size 16M;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /static {
        alias /path/to/your/project/static;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location /uploads {
        alias /path/to/your/project/uploads;
        expires 7d;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/quiz-app /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## 4. 使用 SSL/HTTPS（Let's Encrypt）

```bash
sudo apt-get install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

## 5. 数据库备份

定期备份数据库：

```bash
# 备份脚本
#!/bin/bash
BACKUP_DIR="/path/to/backups"
DB_PATH="/path/to/instance/submissions.db"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR
cp $DB_PATH "$BACKUP_DIR/submissions_$DATE.db"
```

## 6. 日志管理

日志文件位置：
- 应用日志：`logs/app.log`
- Gunicorn访问日志：`logs/access.log`
- Gunicorn错误日志：`logs/error.log`

使用 logrotate 管理日志：

```bash
# /etc/logrotate.d/quiz-app
/path/to/project/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0640 www-data www-data
}
```

## 7. 安全检查清单

- [ ] 修改 `SECRET_KEY` 为强随机字符串
- [ ] 确保 `DEBUG=False`
- [ ] 配置防火墙规则
- [ ] 使用 HTTPS
- [ ] 定期更新依赖包
- [ ] 配置数据库备份
- [ ] 设置日志轮转
- [ ] 配置邮件服务
- [ ] 检查文件权限
- [ ] 禁用不必要的服务

## 8. 性能优化

- 使用 Redis 作为限流存储（修改 `RATELIMIT_STORAGE_URL`）
- 配置数据库连接池
- 启用静态文件缓存
- 使用 CDN 加速静态资源

## 9. 监控和维护

- 监控服务器资源使用情况
- 定期检查日志文件
- 监控数据库大小
- 定期备份数据
- 更新依赖包和安全补丁

