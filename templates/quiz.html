<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ 'â° æ¨¡æ‹Ÿè€ƒè¯•' if mode == 'exam' else ('ğŸ“• é”™é¢˜æœ¬' if mode == 'mistakes' else 'åˆ·é¢˜/èƒŒé¢˜') }}</title>
    <style>
        /* åŸºç¡€æ ·å¼å˜é‡ */
        :root {
            --bg-color: #f0f2f5; --card-bg: #ffffff; --text-color: #333; --text-sub: #666;
            --sidebar-bg: #ffffff; --border-color: #ddd; --input-bg: #fff;
            --hover-bg: #f8f9fa; --active-bg: #e7f1ff; --active-text: #007bff;
            --opt-border: #e9ecef; --opt-hover: #fafafa; --analysis-bg: #f8f9fa;
        }
        body.dark-mode {
            --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0; --text-sub: #a0a0a0;
            --sidebar-bg: #181818; --border-color: #333; --input-bg: #2d2d2d;
            --hover-bg: #2d2d2d; --active-bg: #1a3a5e; --active-text: #66b0ff;
            --opt-border: #333; --opt-hover: #2a2a2a; --analysis-bg: #252525;
        }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); height: 100vh; overflow: hidden; transition: 0.3s; }
        .app-container { display: flex; height: 100%; position: relative; }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar { width: 280px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; position: absolute; left: -280px; top: 0; bottom: 0; transition: left 0.3s ease; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar.open { left: 0; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; backdrop-filter: blur(2px); }
        .overlay.show { display: block; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border-color); background: var(--hover-bg); display: flex; flex-direction: column; gap: 10px;}
        .sidebar-title-row { display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }
        
        .q-item { padding: 10px; margin-bottom: 5px; border-radius: 6px; cursor: pointer; font-size: 14px; color: var(--text-sub); display: flex; align-items: center; justify-content: space-between; }
        .q-item:hover { background-color: var(--hover-bg); }
        .q-item.active { background-color: var(--active-bg); color: var(--active-text); font-weight: bold; border-left: 4px solid var(--active-text); }
        .q-item.done-correct { color: #28a745; background-color: rgba(40, 167, 69, 0.1); }
        .q-item.done-wrong { color: #dc3545; background-color: rgba(220, 53, 69, 0.1); }
        .q-item.answered { border-left: 4px solid #6610f2; background-color: rgba(102, 16, 242, 0.05); color: #6610f2; font-weight: bold; }

        /* ä¸»åŒºåŸŸ - ç¡®ä¿è¿™é‡Œå¯ä»¥æ»šåŠ¨ */
        .main-area { flex: 1; display: flex; justify-content: center; align-items: flex-start; padding: 20px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        
        /* å¡ç‰‡å®¹å™¨ */
        .card-container { width: 100%; max-width: 700px; background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 30px; min-height: 450px; display: flex; flex-direction: column; position: relative; transition: all 0.3s; margin-top: 20px; margin-bottom: 20px;}
        
        /* ã€ä¿®å¤ã€‘æ•´å·é¢„è§ˆæ¨¡å¼ - å…³é”®ä¿®å¤æ»šåŠ¨é—®é¢˜ */
        .card-container.whole-view { 
            display: block; 
            height: auto !important; 
            max-height: none !important;
            overflow: visible !important;
            min-height: 80vh; 
        }
        .card-container.whole-view .question-box { display: flex !important; border-bottom: 1px solid var(--border-color); padding-bottom: 30px; margin-bottom: 30px; animation: none; }
        .card-container.whole-view .question-box:last-child { border-bottom: none; }
        /* éšè—æ‰ä¸éœ€è¦çš„åº•éƒ¨æ  */
        .card-container.whole-view .footer { display: none !important; }
        .card-container.whole-view .progress-bar { display: none !important; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
        .btn-menu { border: 1px solid var(--border-color); background: var(--card-bg); padding: 6px 12px; border-radius: 4px; cursor: pointer; color: var(--text-sub); font-size: 14px; }
        
        .mode-badge { padding: 5px 12px; border-radius: 20px; color: white; font-size: 12px; font-weight: bold; }
        .bg-quiz { background: linear-gradient(135deg, #007bff, #0056b3); }
        .bg-memo { background: linear-gradient(135deg, #17a2b8, #117a8b); }
        .bg-mistakes { background: linear-gradient(135deg, #dc3545, #a71d2a); }
        .bg-fav { background: linear-gradient(135deg, #ffc107, #e0a800); color:#333; }
        .bg-exam { background: linear-gradient(135deg, #6610f2, #520dc2); }
        
        .progress-bar { width: 100%; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden; margin-bottom: 0px; }
        .progress-fill { height: 100%; background: #007bff; width: 0%; transition: width 0.3s ease-out; }
        .exam-mode .progress-fill { background: #6610f2; }

        .question-box { display: none; flex: 1; flex-direction: column; position: relative; margin-top: 20px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
        .question-box.active { display: flex; }
        
        .fav-btn { position: absolute; top: 0; right: 0; font-size: 24px; color: var(--border-color); cursor: pointer; transition: 0.2s; z-index: 10; }
        .fav-btn.active { color: #ffc107; transform: scale(1.1); }
        
        .q-type-label { display: inline-block; background: var(--active-bg); color: var(--active-text); padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-bottom: 15px; }
        .q-content { font-size: 18px; font-weight: 600; line-height: 1.6; margin-bottom: 25px; color: var(--text-color); padding-right: 40px; }

        .options label { display: block; padding: 12px 15px; margin-bottom: 12px; border: 2px solid var(--opt-border); border-radius: 8px; cursor: pointer; transition: all 0.2s; position: relative; background: var(--card-bg); }
        .options label:hover { background-color: var(--opt-hover); border-color: #bbb; }
        .options input { margin-right: 10px; cursor: pointer; }
        .options input:checked + span { font-weight: bold; color: #007bff; }
        
        .exam-mode .options input:checked + span { color: #6610f2; }
        .exam-mode .options input:checked { accent-color: #6610f2; }
        
        .options label.correct-opt { border-color: #28a745; background-color: rgba(40, 167, 69, 0.1); color: #28a745; font-weight: bold; }
        .options label.wrong-opt { border-color: #dc3545; background-color: rgba(220, 53, 69, 0.1); color: #dc3545; }
        
        /* ç¦ç”¨æ¨¡å¼ï¼šé˜²æ­¢æŸ¥çœ‹ç­”æ¡ˆåè¯¯è§¦ */
        .checked-mode .options label { cursor: not-allowed; opacity: 0.8; }
        .checked-mode .options label:hover { border-color: var(--opt-border); background: var(--card-bg); }
        .checked-mode .options label.correct-opt { border-color: #28a745 !important; background-color: rgba(40, 167, 69, 0.1) !important; opacity: 1;}
        .checked-mode .options label.wrong-opt { border-color: #dc3545 !important; background-color: rgba(220, 53, 69, 0.1) !important; opacity: 1;}

        .main-input { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; background: var(--input-bg); color: var(--text-color); box-sizing: border-box; }
        .input-correct { border-color: #28a745 !important; background-color: rgba(40, 167, 69, 0.05); color: #28a745; }
        .input-wrong { border-color: #dc3545 !important; background-color: rgba(220, 53, 69, 0.05); color: #dc3545; }

        .analysis-box { margin-top: 20px; padding: 15px; background: var(--analysis-bg); border-radius: 8px; border-left: 4px solid #007bff; display: none; opacity: 0; transition: opacity 0.5s; color: var(--text-sub); }
        .analysis-box.show { opacity: 1; }

        .footer { margin-top: auto; display: flex; justify-content: space-between; padding-top: 25px; border-top: 1px solid var(--border-color); }
        .btn { padding: 10px 24px; border-radius: 6px; border: none; cursor: pointer; font-size: 15px; font-weight: 500; }
        .btn-nav { background: var(--hover-bg); color: var(--text-sub); border: 1px solid var(--border-color); }
        .btn-check { background: #007bff; color: white; }
        .btn-next-green { background: #28a745; color: white; display: none; }
        .btn-submit { background: #6610f2; color: white; display: none; }
        
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; display: none; z-index: 2000; font-size: 14px;}
        
        .score-modal { text-align: center; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; border: 8px solid #6610f2; display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 0 auto 20px; color: #6610f2; }
        .score-val { font-size: 40px; font-weight: bold; }
        .score-label { font-size: 12px; }
        .score-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; max-height: 200px; overflow-y: auto; margin-top: 20px; }
        .score-item { padding: 5px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .score-item.s-correct { background: #d4edda; color: #155724; }
        .score-item.s-wrong { background: #f8d7da; color: #721c24; }

        /* é€‰é¡¹é«˜äº®æ ·å¼ */
        .correct-opt { color: #28a745 !important; font-weight: bold; background: rgba(40,167,69,0.08) !important; border-radius: 6px; }
        .wrong-opt { color: #dc3545 !important; font-weight: bold; background: rgba(220,53,69,0.08) !important; border-radius: 6px; }
    </style>
</head>
<body class="{{ 'memo-mode' if mode == 'memo' else ('exam-mode' if mode == 'exam' else '') }}">

    <div id="toast">è¯·å…ˆå®Œæˆä½œç­”ï¼</div>
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title-row">
                <span>é¢˜ç›®åˆ—è¡¨</span>
                <span style="cursor:pointer; font-size:20px;" onclick="toggleSidebar()">Ã—</span>
            </div>
            {% if mode != 'exam' %}
                <button class="btn-menu" style="width:100%; margin-top:5px; color:#dc3545; border-color:#dc3545;" onclick="clearProgress()">ğŸ—‘ï¸ æ¸…é™¤è¿›åº¦</button>
            {% endif %}
        </div>
        <div class="sidebar-content" id="question-list">
            {% for q in questions %}
            <div class="q-item" id="list-item-{{ loop.index0 }}" onclick="jumpTo({{ loop.index0 }})">
                <span style="width:25px; font-size:12px; color:#999;">{{ loop.index + 1 }}</span>
                <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex:1;">{{ q.content }}</span>
                {% if mode == 'exam' %}
                    <span style="font-size:12px; color:#6610f2; margin-left:5px;">{{ q.score_val }}åˆ†</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="main-area">
        <div class="card-container" id="mainCard">
            <div class="header">
                <button class="btn-menu" onclick="toggleSidebar()">â˜° åˆ—è¡¨</button>
                
                {% if mode == 'exam' %}
                    <button class="btn-menu" onclick="toggleWholeView()" id="btn-whole-view">ğŸ“‘ æ•´å·é¢„è§ˆ</button>
                    <div style="font-size: 18px; font-weight: bold; color: #6610f2;" id="timer">00:00:00</div>
                {% else %}
                    <div class="mode-badge {{ 'bg-memo' if mode == 'memo' else ('bg-mistakes' if mode == 'mistakes' else ('bg-fav' if mode == 'favorites' else 'bg-quiz')) }}">
                        {% if mode == 'memo' %}ğŸ“– èƒŒé¢˜{% elif mode == 'mistakes' %}ğŸ“• é”™é¢˜æœ¬{% elif mode == 'favorites' %}â­ æ”¶è—æœ¬{% else %}âœï¸ åˆ·é¢˜{% endif %}
                    </div>
                {% endif %}

                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="color:var(--text-sub); font-size:14px; font-weight:bold;" id="progress-text">1 / {{ questions|length }}</span>
                    <button class="btn-menu" onclick="toggleTheme()">ğŸŒ“</button>
                    <a href="/" style="text-decoration:none; color:var(--text-sub); font-size:14px; padding: 5px 10px; border: 1px solid var(--border-color); border-radius: 4px;">é€€å‡º</a>
                </div>
            </div>
            
            <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>

            {% for q in questions %}
            <div class="question-box" id="q-{{ loop.index0 }}" 
                 data-type="{{ q.q_type }}" 
                 data-answer="{{ q.answer }}"
                 data-id="{{ q.id }}"
                 data-score="{{ q.score_val if q.score_val else 0 }}"
                 data-index="{{ loop.index0 }}">
                
                {% if mode != 'exam' %}
                <div class="fav-btn {{ 'active' if q.is_fav else '' }}" onclick="toggleStar(this, {{ q.id }})">â˜…</div>
                {% endif %}

                <div>
                    <span class="q-type-label">{{ q.q_type }}</span>
                    {% if mode == 'exam' %}<span style="font-size:12px; color:#666;">({{ q.score_val }}åˆ†)</span>{% endif %}
                    <div class="q-content">{{ q.content }}</div>
                </div>

                <div class="input-area">
                    {% if q.q_type == 'é€‰æ‹©é¢˜' %}
                        <div class="options">
                            {% for opt in q.options %}
                                <label>
                                    {% if q.answer|length > 1 %}
                                        <input type="checkbox" value="{{ opt[0] }}"> 
                                    {% else %}
                                        <input type="checkbox" value="{{ opt[0] }}" onchange="{{ 'markAnswered(' ~ loop.index0 ~ ')' if mode == 'exam' else 'autoCheck()' }}"> 
                                    {% endif %}
                                    <span>{{ opt }}</span>
                                </label>
                            {% endfor %}
                        </div>
                    {% elif q.q_type == 'åˆ¤æ–­é¢˜' %}
                        <div class="options">
                            <label><input type="radio" name="rad-{{ loop.index0 }}" value="æ­£ç¡®" onchange="{{ 'markAnswered(' ~ loop.index0 ~ ')' if mode == 'exam' else 'autoCheck()' }}"> <span>æ­£ç¡®</span></label>
                            <label><input type="radio" name="rad-{{ loop.index0 }}" value="é”™è¯¯" onchange="{{ 'markAnswered(' ~ loop.index0 ~ ')' if mode == 'exam' else 'autoCheck()' }}"> <span>é”™è¯¯</span></label>
                        </div>
                    {% elif q.q_type == 'å¡«ç©ºé¢˜' %}
                        <input type="text" class="main-input" placeholder="è¾“å…¥ç­”æ¡ˆ" oninput="{{ 'markAnswered(' ~ loop.index0 ~ ')' if mode == 'exam' else '' }}">
                    {% elif q.q_type == 'é—®ç­”é¢˜' %}
                        <textarea class="main-input" rows="4" placeholder="è¯·ä½œç­”..." oninput="{{ 'markAnswered(' ~ loop.index0 ~ ')' if mode == 'exam' else '' }}"></textarea>
                    {% endif %}
                </div>

                <div class="analysis-box">
                    <strong style="color: var(--text-color)">âœ… æ­£ç¡®ç­”æ¡ˆï¼š</strong> <span style="color:#28a745; font-weight:bold;">{{ q.answer }}</span><br>
                    <div style="margin-top:8px; font-size:14px;">{{ q.explanation }}</div>
                </div>
            </div>
            {% endfor %}

            <div class="footer">
                <button class="btn btn-nav" onclick="prevQuestion()" id="btn-prev">â† ä¸Šä¸€é¢˜</button>
                
                {% if mode == 'exam' %}
                    <button class="btn btn-submit" id="btn-submit-exam" onclick="submitExam()">ğŸ“¤ äº¤å·</button>
                    <button class="btn btn-nav" id="btn-next-exam" onclick="nextQuestion()">ä¸‹ä¸€é¢˜ â†’</button>
                {% else %}
                    <button class="btn btn-check" onclick="checkAnswer(true)" id="btn-check" style="display: {{ 'none' if mode == 'memo' else 'block' }}">ğŸ‘€ æŸ¥çœ‹ç»“æœ (Enter)</button>
                    <button class="btn btn-next-green" onclick="nextQuestion()" id="btn-next" style="display: {{ 'block' if mode == 'memo' else 'none' }}">ä¸‹ä¸€é¢˜ (Enter) â†’</button>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="overlay" id="scoreOverlay" style="z-index: 2000;">
        <div class="card-container score-modal" style="width: 350px; min-height: auto;">
            <h2 style="margin-top:0;" id="scoreTitle">ğŸ“„ è€ƒè¯•æˆç»©å•</h2>
            <div class="score-circle" id="scoreCircle">
                <div class="score-val" id="finalScore">0</div>
                <div class="score-label" id="finalLabel">æ€»åˆ†</div>
            </div>
            <p id="scoreDetail">ç­”å¯¹ 0 / 0 é¢˜</p>
            {% if mode != 'exam' %}
                <p style="font-size:12px; color:#666; margin-top:-10px;">(é”™é¢˜å·²è‡ªåŠ¨åŠ å…¥é”™é¢˜æœ¬)</p>
            {% endif %}
            <div class="score-grid" id="scoreGrid"></div>
            <div style="margin-top:20px;">
                <button class="btn btn-check" onclick="reviewExam()">ğŸ” å›é¡¾é¢˜ç›®</button>
                <a href="/" class="btn btn-nav" style="text-decoration:none;">é€€å‡º</a>
            </div>
        </div>
    </div>

    <script>
        const mode = '{{ mode }}';
        const questions = document.querySelectorAll('.question-box');
        const listItems = document.querySelectorAll('.q-item');
        const totalQuestions = {{ questions|length }};
        let currentIndex = 0;
        let isWholeView = false;
        let isSubmitted = false; // æ ‡è®°æ˜¯å¦å·²äº¤å·
        
        let timerSeconds = {{ duration * 60 if duration else 0 }};
        let timerInterval;

        function init() {
            if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
            if (mode !== 'exam') loadState();
            
            showQuestion(currentIndex);

            if (mode === 'exam') {
                startTimer();
                document.getElementById('btn-next-exam').style.display = 'block';
            }
        }

        function startTimer() {
            const timerEl = document.getElementById('timer');
            timerInterval = setInterval(() => {
                timerSeconds--;
                if (timerSeconds <= 0) {
                    clearInterval(timerInterval);
                    alert('è€ƒè¯•æ—¶é—´åˆ°ï¼ç³»ç»Ÿå°†è‡ªåŠ¨äº¤å·ã€‚');
                    submitExam(true); 
                    return;
                }
                const h = Math.floor(timerSeconds / 3600).toString().padStart(2,'0');
                const m = Math.floor((timerSeconds % 3600) / 60).toString().padStart(2,'0');
                const s = (timerSeconds % 60).toString().padStart(2,'0');
                timerEl.innerText = `${h}:${m}:${s}`;
            }, 1000);
        }

        function markAnswered(index) {
            const item = document.getElementById(`list-item-${index}`);
            item.classList.add('answered');
        }

        function toggleWholeView() {
            isWholeView = !isWholeView;
            const container = document.getElementById('mainCard');
            const btn = document.getElementById('btn-whole-view');
            
            if (isWholeView) {
                container.classList.add('whole-view');
                btn.innerText = "â†© è¿”å›å•é¢˜";
                window.scrollTo(0, 0); // æ»šå›é¡¶éƒ¨
                
                if(mode === 'exam' && !isSubmitted) { // åªæœ‰æ²¡äº¤å·æ—¶æ‰æ˜¾ç¤ºäº¤å·æŒ‰é’®
                    let tempSubmit = document.getElementById('temp-submit');
                    if(!tempSubmit) {
                        tempSubmit = document.createElement('button');
                        tempSubmit.id = 'temp-submit';
                        tempSubmit.className = 'btn btn-submit';
                        tempSubmit.style.display = 'block';
                        tempSubmit.style.margin = '20px auto';
                        tempSubmit.innerText = 'ğŸ“¤ äº¤å·';
                        tempSubmit.onclick = () => submitExam();
                        container.appendChild(tempSubmit);
                    } else {
                        tempSubmit.style.display = 'block';
                    }
                }
            } else {
                container.classList.remove('whole-view');
                btn.innerText = "ğŸ“‘ æ•´å·é¢„è§ˆ";
                const tempSubmit = document.getElementById('temp-submit');
                if(tempSubmit) tempSubmit.style.display = 'none';
                showQuestion(currentIndex);
            }
        }

        function jumpTo(index) {
            if (isWholeView) {
                const el = document.getElementById('q-' + index);
                if(el) {
                    el.scrollIntoView({behavior: 'smooth', block: 'center'});
                    el.style.transition = 'background 0.3s';
                    el.style.background = 'rgba(0,123,255,0.1)';
                    setTimeout(() => el.style.background = 'transparent', 500);
                }
            } else {
                showQuestion(index);
            }
            toggleSidebar(); 
        }

        function showQuestion(index) {
            if (isWholeView) return; 

            questions.forEach(q => q.classList.remove('active'));
            questions[index].classList.add('active');
            
            listItems.forEach(item => item.classList.remove('active'));
            if(listItems[index]) {
                listItems[index].classList.add('active');
                listItems[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            const currentQ = questions[index];
            const type = currentQ.getAttribute('data-type');
            const answer = currentQ.getAttribute('data-answer');
            const analysisBox = currentQ.querySelector('.analysis-box');

            const btnPrev = document.getElementById('btn-prev');
            btnPrev.disabled = (index === 0);

            if (mode === 'exam') {
                const btnNextExam = document.getElementById('btn-next-exam');
                const btnSubmitExam = document.getElementById('btn-submit-exam');
                
                // å¦‚æœå·²äº¤å·ï¼Œéšè—æ‰€æœ‰æäº¤/ä¸‹ä¸€é¢˜æŒ‰é’®ï¼Œåªç”¨äºæŸ¥çœ‹
                if (isSubmitted) {
                    btnNextExam.style.display = 'block';
                    btnSubmitExam.style.display = 'none';
                    if(index === totalQuestions - 1) btnNextExam.style.display = 'none';
                    return;
                }

                if (index === totalQuestions - 1) {
                    btnNextExam.style.display = 'none';
                    btnSubmitExam.style.display = 'block';
                } else {
                    btnNextExam.style.display = 'block';
                    btnSubmitExam.style.display = 'none';
                }
            } else {
                const btnCheck = document.getElementById('btn-check');
                const btnNext = document.getElementById('btn-next');
                
                if (mode === 'memo') {
                    analysisBox.style.display = 'block';
                    analysisBox.classList.add('show');
                    btnCheck.style.display = 'none';
                    btnNext.style.display = 'block';
                    fillAnswer(currentQ, type, answer);
                    disableInputs(currentQ); 
                } else {
                    if (analysisBox.style.display === 'block') {
                        btnCheck.style.display = 'none';
                        btnNext.style.display = 'block';
                    } else {
                        btnCheck.style.display = 'block';
                        btnNext.style.display = 'none';
                    }
                    
                    if (index === totalQuestions - 1) {
                        btnNext.innerText = "ğŸ å®Œæˆåˆ·é¢˜";
                        btnNext.classList.remove('btn-next-green');
                        btnNext.style.backgroundColor = '#6610f2'; 
                        btnNext.onclick = finishQuiz;
                    } else {
                        btnNext.innerText = "ä¸‹ä¸€é¢˜ (Enter) â†’";
                        btnNext.classList.add('btn-next-green');
                        btnNext.style.backgroundColor = ''; 
                        btnNext.onclick = nextQuestion;
                    }
                }
            }

            currentIndex = index;
            document.getElementById('progress-text').innerText = `${currentIndex + 1} / ${totalQuestions}`;
            document.getElementById('progress-fill').style.width = ((currentIndex + 1) / totalQuestions * 100) + '%';
            
            if (mode !== 'exam') saveState();
        }

        function fillAnswer(q, type, answer) {
            if (type === 'é€‰æ‹©é¢˜' || type === 'åˆ¤æ–­é¢˜') {
                q.querySelectorAll('input').forEach(input => {
                    input.parentElement.classList.remove('correct-opt');
                    if (answer.includes(input.value)) {
                        input.parentElement.classList.add('correct-opt');
                        input.checked = true;
                    }
                });
            } else if (type === 'å¡«ç©ºé¢˜') {
                const input = q.querySelector('input');
                input.value = answer; 
                input.classList.add('input-correct');
            }
        }

        function disableInputs(q) {
            q.classList.add('checked-mode');
            q.querySelectorAll('input, textarea').forEach(el => el.disabled = true);
        }

        function autoCheck() {
            checkAnswer(false);
        }

        function checkAnswer(isManualClick) {
            if (mode === 'exam') return;

            const currentQ = questions[currentIndex];
            const type = currentQ.getAttribute('data-type');
            const answer = currentQ.getAttribute('data-answer');
            const qId = currentQ.getAttribute('data-id');
            const analysisBox = currentQ.querySelector('.analysis-box');
            
            if (!hasAnswered(currentQ, type)) {
                if (isManualClick) showToast("è¯·å…ˆä½œç­”ï¼");
                return;
            }

            analysisBox.style.display = 'block';
            setTimeout(() => analysisBox.classList.add('show'), 10);
            
            document.getElementById('btn-check').style.display = 'none';
            document.getElementById('btn-next').style.display = 'block';
            
            let isCorrect = judgeQuestion(currentQ, type, answer);
            styleFeedback(currentQ, type, answer, isCorrect);
            
            disableInputs(currentQ);

            const listItem = document.getElementById(`list-item-${currentIndex}`);
            if (isCorrect) {
                listItem.classList.add('done-correct');
                listItem.classList.remove('done-wrong');
            } else {
                listItem.classList.add('done-wrong');
                listItem.classList.remove('done-correct');
            }

            fetch('/api/record_result', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ question_id: qId, is_correct: isCorrect })
            });

            saveState();
        }

        function finishQuiz() {
            let correctCount = 0;
            let gridHtml = '';
            
            listItems.forEach((item, index) => {
                const isRight = item.classList.contains('done-correct');
                const isWrong = item.classList.contains('done-wrong');
                
                if (isRight) correctCount++;
                
                if (isRight) {
                    gridHtml += `<div class="score-item s-correct" onclick="reviewJump(${index})">${index+1}</div>`;
                } else if (isWrong) {
                    gridHtml += `<div class="score-item s-wrong" onclick="reviewJump(${index})">${index+1}</div>`;
                } else {
                    gridHtml += `<div class="score-item" onclick="reviewJump(${index})">${index+1}</div>`;
                }
            });

            document.getElementById('scoreTitle').innerText = "ğŸ åˆ·é¢˜æŠ¥å‘Š";
            document.getElementById('finalLabel').innerText = "å‡†ç¡®ç‡";
            document.getElementById('finalScore').innerText = Math.round((correctCount / totalQuestions) * 100) + "%";
            document.getElementById('scoreDetail').innerText = `ç­”å¯¹ ${correctCount} / ${totalQuestions} é¢˜`;
            document.getElementById('scoreGrid').innerHTML = gridHtml;
            document.getElementById('scoreOverlay').style.display = 'flex';
            
            document.getElementById('scoreCircle').style.borderColor = '#007bff';
            document.getElementById('scoreCircle').style.color = '#007bff';
        }

        function submitExam(force = false) {
            if (isSubmitted) return; // ã€ä¿®å¤ã€‘å¦‚æœå·²äº¤å·ï¼Œç›´æ¥é˜»æ–­

            if (!force) {
                let unAnsweredIndices = [];
                questions.forEach((q, i) => {
                    const type = q.getAttribute('data-type');
                    if (!hasAnswered(q, type)) {
                        unAnsweredIndices.push(i + 1);
                    }
                });

                if (unAnsweredIndices.length > 0) {
                    alert(`è¿˜æœ‰ ${unAnsweredIndices.length} é“é¢˜æœªä½œç­”ï¼\né¢˜å·ï¼š${unAnsweredIndices.join(', ')}`);
                    if (!isWholeView) showQuestion(unAnsweredIndices[0] - 1);
                    return;
                }
                
                if (!confirm("ç¡®å®šè¦äº¤å·å—ï¼Ÿäº¤å·åå°†æ˜¾ç¤ºæˆç»©ã€‚")) return;
            }

            // ã€ä¿®å¤ã€‘ç«‹å³æ›´æ–°çŠ¶æ€å¹¶éšè—æ‰€æœ‰äº¤å·æŒ‰é’®
            isSubmitted = true;
            const mainSubmitBtn = document.getElementById('btn-submit-exam');
            const tempSubmitBtn = document.getElementById('temp-submit');
            if(mainSubmitBtn) mainSubmitBtn.style.display = 'none';
            if(tempSubmitBtn) tempSubmitBtn.remove();
            
            clearInterval(timerInterval);
            let totalScore = 0;
            let correctCount = 0;
            let gridHtml = '';

            questions.forEach((q, index) => {
                const type = q.getAttribute('data-type');
                const answer = q.getAttribute('data-answer');
                const scoreVal = parseFloat(q.getAttribute('data-score'));
                
                const isCorrect = judgeQuestion(q, type, answer);
                styleFeedback(q, type, answer, isCorrect);
                q.querySelector('.analysis-box').style.display = 'block';
                q.querySelector('.analysis-box').classList.add('show');
                disableInputs(q);

                if (isCorrect) {
                    totalScore += scoreVal;
                    correctCount++;
                    gridHtml += `<div class="score-item s-correct" onclick="reviewJump(${index})">${index+1}</div>`;
                } else {
                    gridHtml += `<div class="score-item s-wrong" onclick="reviewJump(${index})">${index+1}</div>`;
                }
            });

            document.getElementById('finalScore').innerText = totalScore;
            document.getElementById('scoreDetail').innerText = `ç­”å¯¹ ${correctCount} / ${totalQuestions} é¢˜`;
            document.getElementById('scoreGrid').innerHTML = gridHtml;
            document.getElementById('scoreOverlay').style.display = 'flex';
        }

        function reviewExam() {
            document.getElementById('scoreOverlay').style.display = 'none';
            
            // è€ƒè¯•æ¨¡å¼ä¸‹ï¼Œå›é¡¾æ—¶ä¸å†æ˜¾ç¤ºäº¤å·æŒ‰é’®ï¼Œç¡®ä¿åªèƒ½ä¸‹ä¸€é¢˜æŸ¥çœ‹
            if (mode === 'exam') {
                const btnSubmit = document.getElementById('btn-submit-exam');
                if(btnSubmit) btnSubmit.style.display = 'none';
                
                const btnNext = document.getElementById('btn-next-exam');
                if(btnNext) btnNext.style.display = 'block';
            }
            
            if (!isWholeView) {
                currentIndex = 0;
                showQuestion(0);
            }
            
            const tempSubmit = document.getElementById('temp-submit');
            if(tempSubmit) tempSubmit.remove();
        }
        
        function reviewJump(index) {
            reviewExam();
            if (isWholeView) {
                jumpTo(index); 
            } else {
                showQuestion(index);
            }
        }

        function judgeQuestion(q, type, answer) {
            if (type === 'é€‰æ‹©é¢˜' || type === 'åˆ¤æ–­é¢˜') {
                const inputs = q.querySelectorAll('input');
                let userVals = [];
                inputs.forEach(i => { if(i.checked) userVals.push(i.value) });
                return userVals.sort().join("") === answer;
            } else if (type === 'å¡«ç©ºé¢˜') {
                return q.querySelector('input').value.trim() === answer;
            } else if (type === 'é—®ç­”é¢˜') {
                return !!q.querySelector('textarea').value.trim();
            }
            return false;
        }

        function hasAnswered(q, type) {
            if (type === 'é€‰æ‹©é¢˜' || type === 'åˆ¤æ–­é¢˜') return q.querySelector('input:checked');
            if (type === 'å¡«ç©ºé¢˜') return q.querySelector('input').value.trim();
            if (type === 'é—®ç­”é¢˜') return q.querySelector('textarea').value.trim();
            return false;
        }

        function styleFeedback(q, type, answer, isCorrect) {
            if (type === 'é€‰æ‹©é¢˜' || type === 'åˆ¤æ–­é¢˜') {
                q.querySelectorAll('input').forEach(input => {
                    const label = input.parentElement;
                    label.classList.remove('correct-opt', 'wrong-opt');
                    // ç”¨æˆ·é€‰ä¸­çš„æ­£ç¡®ä¸ºç»¿è‰²ï¼Œé”™è¯¯ä¸ºçº¢è‰²
                    if (input.checked && answer.includes(input.value)) {
                        label.classList.add('correct-opt');
                    } else if (input.checked && !answer.includes(input.value)) {
                        label.classList.add('wrong-opt');
                    }
                    // å…¶ä½™é€‰é¡¹ä¸é«˜äº®
                });
            } else if (type === 'å¡«ç©ºé¢˜') {
                const input = q.querySelector('input');
                input.classList.remove('input-correct', 'input-wrong');
                input.classList.add(isCorrect ? 'input-correct' : 'input-wrong');
            }
        }

        // ä¿ç•™åšé¢˜ç—•è¿¹æ ·å¼
        function loadState() {
            try {
                const data = JSON.parse(localStorage.getItem(`quiz_record_${mode}`));
                if (data) {
                    if (data.status) {
                        for (const [idx, status] of Object.entries(data.status)) {
                            const item = document.getElementById(`list-item-${idx}`);
                            if (item) {
                                if (status === 'correct') item.classList.add('done-correct');
                                if (status === 'wrong') item.classList.add('done-wrong');
                            }
                            const q = document.getElementById(`q-${idx}`);
                            if (q && (status === 'correct' || status === 'wrong')) {
                                // æ¢å¤é€‰é¡¹é«˜äº®
                                const type = q.getAttribute('data-type');
                                const answer = q.getAttribute('data-answer');
                                const isCorrect = status === 'correct';
                                styleFeedback(q, type, answer, isCorrect);
                                disableInputs(q);
                            }
                        }
                    }
                    if (data.answers) {
                        for (const [idx, val] of Object.entries(data.answers)) {
                            const q = document.getElementById(`q-${idx}`);
                            if (q) {
                                const type = q.getAttribute('data-type');
                                if ((type === 'é€‰æ‹©é¢˜' || type === 'åˆ¤æ–­é¢˜') && Array.isArray(val)) {
                                    q.querySelectorAll('input').forEach(i => { i.checked = val.includes(i.value); });
                                } else if (type === 'å¡«ç©ºé¢˜') {
                                    q.querySelector('input').value = val;
                                } else if (type === 'é—®ç­”é¢˜') {
                                    q.querySelector('textarea').value = val;
                                }
                            }
                        }
                    }
                    if (data.index) currentIndex = data.index;
                }
            } catch(e) {}
        }
        
        function clearProgress() {
            if(confirm("ç¡®å®šè¦æ¸…é™¤å½“å‰æ¨¡å¼çš„åšé¢˜è¿›åº¦å—ï¼Ÿ")) {
                localStorage.removeItem(`quiz_record_${mode}`);
                window.location.reload(); 
            }
        }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('show');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        }

        function toggleStar(btn, id) {
             fetch('/api/favorite', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ question_id: id })
            }).then(res => res.json()).then(data => {
                if(data.status === 'success') {
                    btn.classList.toggle('active');
                }
            });
        }

        init();

        document.addEventListener('keydown', function(e) {
            // åªåœ¨å¡«ç©ºé¢˜æ—¶å“åº”å›è½¦
            if (e.key === 'Enter') {
                const input = document.querySelector('.main-input[type="text"]:not([disabled])');
                if (input && input === document.activeElement) {
                    // è§¦å‘â€œæŸ¥çœ‹ç»“æœâ€æŒ‰é’®ç‚¹å‡»
                    const btn = document.getElementById('btn-check');
                    if (btn && btn.style.display !== 'none') {
                        btn.click();
                    }
                }
            }
        });
    </script>
</body>
</html>