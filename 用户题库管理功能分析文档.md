# 用户题库管理功能分析文档

## 📋 功能概述

为后台管理员提供**用户题库权限管理**功能，允许管理员控制每个用户可以访问哪些科目（题库）。该功能为后续VIP会员、付费题库等扩展功能奠定基础。

---

## 🎯 核心需求

### 1. 功能目标
- **管理员可以限制用户访问某些科目（黑名单模式）**
- **用户默认可以访问所有科目，除非被限制**
- **支持批量操作（批量限制/取消限制科目）**
- **用户刷题数限制功能（可开启/关闭）**
- **达到刷题限制后提示用户付费或联系管理员**
- **为后续VIP、付费题库等功能预留扩展接口**

### 2. 业务场景
- **场景1**：学校内部使用，限制某些专业学生访问其他专业的题库
- **场景2**：付费题库，普通用户有刷题数限制，VIP用户无限制
- **场景3**：阶段性开放，新科目先限制部分用户访问，再逐步开放
- **场景4**：免费用户刷题数达到限制后，引导付费或联系管理员

---

## 🗄️ 数据库设计

### 1. 新增数据表

#### `user_subjects` 表（用户-科目限制表，黑名单模式）

```sql
CREATE TABLE IF NOT EXISTS user_subjects (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    subject_id INTEGER NOT NULL,
    restricted_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    restricted_by INTEGER,  -- 限制者ID（管理员）
    UNIQUE(user_id, subject_id),
    FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY(subject_id) REFERENCES subjects(id) ON DELETE CASCADE,
    FOREIGN KEY(restricted_by) REFERENCES users(id) ON DELETE SET NULL
);

CREATE INDEX idx_user_subjects_user_id ON user_subjects(user_id);
CREATE INDEX idx_user_subjects_subject_id ON user_subjects(subject_id);
```

**字段说明**：
- `id`: 主键
- `user_id`: 用户ID
- `subject_id`: 科目ID（被限制的科目）
- `restricted_at`: 限制时间
- `restricted_by`: 限制者ID（记录是哪个管理员限制的）

**设计考虑**：
- **黑名单模式**：表中记录的是被限制的科目，未记录的科目默认可访问
- 使用 `UNIQUE(user_id, subject_id)` 防止重复限制
- `ON DELETE CASCADE` 确保用户/科目删除时自动清理关联
- 添加索引提升查询性能

#### `system_config` 表（系统配置表）

```sql
CREATE TABLE IF NOT EXISTS system_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_key TEXT UNIQUE NOT NULL,
    config_value TEXT NOT NULL,
    description TEXT,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_by INTEGER,
    FOREIGN KEY(updated_by) REFERENCES users(id) ON DELETE SET NULL
);

CREATE INDEX idx_system_config_key ON system_config(config_key);
```

**字段说明**：
- `id`: 主键
- `config_key`: 配置键（如 `quiz_limit_enabled`, `quiz_limit_count`）
- `config_value`: 配置值（JSON字符串或普通字符串）
- `description`: 配置说明
- `updated_at`: 更新时间
- `updated_by`: 更新者ID

**默认配置**：
```sql
-- 刷题限制功能开关（默认关闭）
INSERT INTO system_config (config_key, config_value, description) 
VALUES ('quiz_limit_enabled', '0', '刷题数限制功能开关（0=关闭，1=开启）');

-- 刷题数限制（默认100题）
INSERT INTO system_config (config_key, config_value, description) 
VALUES ('quiz_limit_count', '100', '用户刷题数限制（达到此数量后提示付费）');
```

#### `user_quiz_stats` 表（用户刷题统计表）

```sql
CREATE TABLE IF NOT EXISTS user_quiz_stats (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL UNIQUE,
    total_answered INTEGER DEFAULT 0,  -- 总答题数
    last_reset_at DATETIME,  -- 上次重置时间（用于周期重置）
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE INDEX idx_user_quiz_stats_user_id ON user_quiz_stats(user_id);
```

**字段说明**：
- `id`: 主键
- `user_id`: 用户ID（唯一）
- `total_answered`: 总答题数（刷题数）
- `last_reset_at`: 上次重置时间（用于周期重置，如每月重置）
- `updated_at`: 更新时间

**设计考虑**：
- 每次用户答题时更新此表
- 支持周期重置（如每月重置刷题数）
- 管理员可以手动重置用户刷题数

### 2. 扩展字段（为VIP等功能预留）

#### `users` 表扩展（可选，后续实现）

```sql
-- 为VIP功能预留字段（暂不实现，仅作规划）
ALTER TABLE users ADD COLUMN is_vip INTEGER DEFAULT 0;
ALTER TABLE users ADD COLUMN vip_expires_at DATETIME;
ALTER TABLE users ADD COLUMN user_level TEXT DEFAULT 'normal';  -- normal/vip/premium
ALTER TABLE users ADD COLUMN quiz_limit_exempt INTEGER DEFAULT 0;  -- 是否豁免刷题限制（VIP用户）
```

**说明**：这些字段暂不实现，但数据库设计时预留扩展空间。

---

## 🏗️ 功能模块设计

### 模块1：用户科目权限管理（管理后台）

#### 1.1 用户详情页集成

**位置**：`app/modules/admin/routes/pages.py` 和 `app/modules/admin/templates/admin/admin_user_detail.html`

**实现方式**：
- 在现有用户详情页（`/admin/users/<user_id>`）中添加"科目权限管理"卡片
- 作为用户详情页的一个功能模块，而非独立页面
- 显示用户已分配的科目列表，支持快速分配/取消操作

**页面路径**：`/admin/users/<user_id>`（在用户详情页中）

**UI位置**：
- 在用户资料卡片和统计卡片之后
- 在"最近考试记录"之前
- 使用独立的卡片样式展示

**实现细节**：
- 卡片标题："科目权限管理"
- 显示被限制科目数量：`被限制: 2/10`（黑名单模式）
- 被限制科目以标签形式展示（可点击移除限制）
- "管理科目权限"按钮：点击后展开详细管理界面（或打开弹窗）
- 详细管理界面包含：
  - 所有科目列表（复选框）
  - 被限制科目高亮显示
  - 快速操作按钮（全部限制/全部取消限制）
  - 搜索/筛选功能

**刷题数统计卡片**：
- 显示用户当前刷题数：`已刷题: 85/100`
- 显示刷题限制状态（如果功能开启）
- 管理员可以重置用户刷题数

#### 1.2 题库管理页面（批量操作）

**位置**：`app/modules/admin/routes/pages.py`

```python
@admin_pages_bp.route('/subject_permissions')
@admin_required
def admin_subject_permissions_page():
    """题库管理页面 - 批量操作用户科目权限"""
    # 获取所有用户列表（分页）
    # 获取所有科目列表
    # 渲染批量管理页面
```

**页面路径**：`/admin/subject_permissions`

**功能**：
- 显示所有用户列表（支持搜索、筛选）
- 显示所有科目列表
- 支持批量选择用户和科目
- 批量分配/取消科目权限
- 显示用户已分配的科目统计

**侧边栏集成**：
- 在 `app/modules/admin/templates/admin/admin_base.html` 的侧边栏中添加"题库管理"菜单项
- 位置：在"用户管理"之后，"编程管理"之前
- 仅管理员可见（使用 `{% if session.get('is_admin') %}` 包裹）
- 菜单项文本："题库管理"
- 路由：`/admin/subject_permissions`
- 激活状态：`{% if request.path == '/admin/subject_permissions' %}active{% endif %}`

#### 1.3 API 路由

**位置**：`app/modules/admin/routes/api.py`

**API端点**：

1. **获取用户科目权限列表**
   ```
   GET /admin/api/users/<user_id>/subjects
   ```
   - 返回：用户已分配的科目列表 + 所有科目列表（带标记）

2. **分配科目给用户**
   ```
   POST /admin/api/users/<user_id>/subjects
   ```
   - 请求体：`{"subject_ids": [1, 2, 3]}`
   - 功能：批量分配科目

3. **取消用户科目权限**
   ```
   DELETE /admin/api/users/<user_id>/subjects/<subject_id>
   ```
   - 功能：取消单个科目权限

4. **批量操作**
   ```
   POST /admin/api/users/<user_id>/subjects/batch
   ```
   - 请求体：`{"action": "grant|revoke", "subject_ids": [1, 2, 3]}`
   - 功能：批量分配或取消

#### 1.4 前端页面

**页面1：用户详情页中的科目权限管理卡片**

**位置**：`app/modules/admin/templates/admin/admin_user_detail.html`

**功能**：
- 显示用户已分配的科目列表
- 快速添加/移除科目权限
- 显示科目统计（已分配/总数）
- iOS 18 风格卡片设计

**UI设计**：
- 集成在用户详情页中
- 使用独立的卡片样式
- 科目列表以标签形式展示
- 支持快速操作按钮

**页面2：题库管理页面（批量操作）**

**位置**：`app/modules/admin/templates/admin/admin_subject_permissions.html`

**功能**：
- 用户列表（支持搜索、分页）
- 科目列表（复选框形式）
- 批量选择用户和科目
- 批量限制/取消限制操作（黑名单模式）
- 统计信息展示
- 系统配置管理（刷题限制开关、限制数量）
- 用户刷题数管理（查看、重置）

**UI设计要点**：
- iOS 18 风格：毛玻璃效果、圆角、阴影
- 双列表布局（左侧用户列表，右侧科目列表）
- 批量操作工具栏
- 响应式设计

### 模块2：前台科目过滤

#### 2.1 修改现有查询逻辑

**需要修改的文件**：

1. **`app/core/models/question.py`**
   - `get_list()` 方法：添加用户科目权限过滤
   - `get_count()` 方法：添加用户科目权限过滤
   - `get_subjects()` 方法：只返回用户有权限的科目

2. **`app/modules/quiz/routes/api.py`**
   - `api_subjects()` 接口：过滤用户无权限的科目

3. **`app/modules/main/routes/pages.py`**
   - 搜索页面：科目筛选器只显示有权限的科目

4. **`app/modules/exam/routes/api.py`**
   - 创建考试时：科目选择只显示有权限的科目

#### 2.2 权限检查工具函数

**位置**：`app/core/utils/decorators.py` 或新建 `app/core/utils/subject_permissions.py`

```python
def get_user_restricted_subjects(user_id: int) -> List[int]:
    """获取用户被限制的科目ID列表（黑名单）"""
    # 1. 检查是否是管理员（管理员无限制）
    # 2. 查询 user_subjects 表（黑名单）
    # 3. 返回被限制的科目ID列表

def can_user_access_subject(user_id: int, subject_id: int) -> bool:
    """检查用户是否可以访问指定科目（黑名单模式）"""
    # 管理员直接返回 True
    # 普通用户：如果科目在 user_subjects 表中（黑名单），返回 False
    # 否则返回 True（默认有权限）

def get_user_accessible_subjects(user_id: int) -> List[int]:
    """获取用户可访问的科目ID列表（黑名单模式）"""
    # 1. 获取所有科目ID
    # 2. 获取用户被限制的科目ID（黑名单）
    # 3. 返回所有科目 - 被限制的科目
```

#### 2.3 刷题数限制检查工具函数

**位置**：`app/core/utils/subject_permissions.py`

```python
def is_quiz_limit_enabled() -> bool:
    """检查刷题数限制功能是否开启"""
    # 查询 system_config 表的 quiz_limit_enabled

def get_quiz_limit_count() -> int:
    """获取刷题数限制数量"""
    # 查询 system_config 表的 quiz_limit_count

def get_user_quiz_count(user_id: int) -> int:
    """获取用户当前刷题数"""
    # 查询 user_quiz_stats 表的 total_answered

def check_quiz_limit(user_id: int) -> tuple[bool, str]:
    """检查用户是否达到刷题限制"""
    # 返回 (是否达到限制, 提示信息)
    # 如果功能关闭或用户是管理员/VIP，返回 (False, "")
    # 如果达到限制，返回 (True, "已达到刷题限制，请付费或联系管理员")

def increment_user_quiz_count(user_id: int) -> None:
    """增加用户刷题数"""
    # 更新 user_quiz_stats 表的 total_answered
```

### 模块3：用户中心展示

#### 3.1 用户中心页面

**位置**：`app/modules/user/templates/user/user_hub.html`

**功能**：
- 显示用户可访问的科目数量
- 显示用户已完成的科目
- 显示刷题数统计（如果功能开启）
- 显示VIP状态（如果后续实现）

### 模块4：刷题限制提示

#### 4.1 刷题页面限制提示

**位置**：`app/modules/quiz/templates/quiz/quiz.html`

**功能**：
- 当用户达到刷题限制时，显示提示弹窗
- 提示内容：引导用户付费或联系管理员
- 阻止用户继续答题

**UI设计**：
- iOS 18 风格弹窗（毛玻璃效果、圆角、阴影）
- 清晰的提示信息：
  - 标题："已达到刷题限制"
  - 内容："您已刷题 100/100 题，请付费或联系管理员继续使用"
  - 显示当前刷题数和限制数
- "联系管理员"按钮（跳转到 `/contact_admin` 页面）
- "了解VIP"按钮（如果后续实现VIP功能，跳转到VIP介绍页面）
- "关闭"按钮（关闭弹窗，但用户仍无法继续答题）

**触发时机**：
- 用户提交答题时，如果达到限制，返回错误响应
- 前端检测到错误响应后，显示提示弹窗
- 弹窗显示后，阻止用户继续答题（禁用答题按钮）

---

## 🔐 权限控制逻辑

### 1. 默认权限策略

**已确认采用：策略B（黑名单模式）**

- **默认行为**：用户**有权限**访问所有科目
- **限制方式**：管理员可以限制用户访问某些科目（添加到黑名单）
- **优点**：
  - 新用户开箱即用，无需手动分配
  - 适合大多数场景（默认开放，需要时再限制）
  - 减少管理员工作量
- **缺点**：
  - 需要手动限制，安全性相对较低
  - 新科目默认对所有用户开放

**实现逻辑**：
- `user_subjects` 表中记录的是**被限制的科目**（黑名单）
- 查询时：如果用户在 `user_subjects` 表中有记录，则不能访问该科目
- 如果用户不在 `user_subjects` 表中，则默认可以访问所有科目

### 2. 管理员权限

- **超级管理员**：可以访问所有科目，不受限制
- **科目管理员**：可以访问自己管理的科目（保持现有逻辑）

### 3. 权限检查流程

```
用户请求科目/题目
    ↓
检查用户身份
    ↓
是管理员？ → 是 → 允许访问所有科目
    ↓ 否
查询 user_subjects 表（黑名单）
    ↓
在黑名单中？ → 是 → 拒绝访问（返回403或空列表）
    ↓ 否
允许访问（默认有权限）
```

### 4. 刷题数限制逻辑

**功能开关**：
- 通过 `system_config` 表的 `quiz_limit_enabled` 控制
- 默认关闭（`quiz_limit_enabled = 0`）
- 管理员可以在后台开启/关闭

**限制检查流程**：

```
用户提交答题
    ↓
检查功能开关
    ↓
功能关闭？ → 是 → 允许答题
    ↓ 否
检查用户身份
    ↓
是管理员或VIP？ → 是 → 允许答题（豁免限制）
    ↓ 否
查询 user_quiz_stats 表
    ↓
刷题数 >= 限制数？ → 是 → 拒绝答题，提示付费或联系管理员
    ↓ 否
允许答题，更新统计
```

**限制规则**：
- 每次用户答题（调用 `/api/quiz/record_result`）时检查
- 达到限制后，用户无法继续答题
- 提示信息：引导用户付费或联系管理员
- 管理员可以手动重置用户刷题数
- 支持周期重置（如每月重置，通过 `last_reset_at` 字段）

---

## 📡 API 设计

### 1. 管理后台 API

#### 1.1 获取用户科目限制（用户详情页）

```
GET /admin/api/users/<user_id>/subjects
```

**响应示例**：
```json
{
  "status": "success",
  "data": {
    "user": {
      "id": 1,
      "username": "student1"
    },
    "all_subjects": [
      {
        "id": 1,
        "name": "数学",
        "question_count": 100,
        "is_restricted": false,
        "restricted_at": null
      },
      {
        "id": 2,
        "name": "英语",
        "question_count": 50,
        "is_restricted": true,
        "restricted_at": "2025-01-29 10:00:00"
      }
    ],
    "restricted_count": 1,
    "total_count": 2
  }
}
```

#### 1.2 限制科目访问（添加到黑名单）

```
POST /admin/api/users/<user_id>/subjects
Content-Type: application/json

{
  "subject_ids": [1, 2, 3]
}
```

**响应示例**：
```json
{
  "status": "success",
  "message": "成功限制 3 个科目",
  "data": {
    "restricted_count": 3
  }
}
```

#### 1.3 取消科目限制（从黑名单移除）

```
DELETE /admin/api/users/<user_id>/subjects/<subject_id>
```

**响应示例**：
```json
{
  "status": "success",
  "message": "已取消科目限制"
}
```

#### 1.4 批量操作（单个用户）

```
POST /admin/api/users/<user_id>/subjects/batch
Content-Type: application/json

{
  "action": "restrict",  // restrict 或 unrestrict
  "subject_ids": [1, 2, 3]
}
```

#### 1.5 批量操作用户（题库管理页面）

```
POST /admin/api/subject_permissions/batch
Content-Type: application/json

{
  "action": "restrict",  // restrict 或 unrestrict
  "user_ids": [1, 2, 3],
  "subject_ids": [1, 2, 3]
}
```

**功能**：批量为多个用户限制/取消限制多个科目（黑名单操作）

**响应示例**：
```json
{
  "status": "success",
  "message": "成功为 3 个用户限制 2 个科目",
  "data": {
    "affected_users": 3,
    "affected_subjects": 2
  }
}
```

#### 1.6 获取批量管理数据（题库管理页面）

```
GET /admin/api/subject_permissions/overview
```

**功能**：获取批量管理页面所需的数据
- 用户列表（分页、搜索）
- 科目列表
- 用户科目限制统计

**响应示例**：
```json
{
  "status": "success",
  "data": {
    "users": [
      {
        "id": 1,
        "username": "user1",
        "restricted_subjects_count": 2,
        "total_subjects_count": 10
      }
    ],
    "subjects": [
      {
        "id": 1,
        "name": "数学",
        "question_count": 100,
        "restricted_users_count": 5
      }
    ],
    "stats": {
      "total_users": 50,
      "total_subjects": 10,
      "total_restrictions": 20
    }
  }
}
```

#### 1.7 系统配置管理 API

```
GET /admin/api/system_config
```

**功能**：获取系统配置列表

```
PUT /admin/api/system_config/<config_key>
Content-Type: application/json

{
  "config_value": "1",
  "description": "开启刷题数限制"
}
```

**功能**：更新系统配置

#### 1.8 用户刷题数管理 API

```
GET /admin/api/users/<user_id>/quiz_stats
```

**功能**：获取用户刷题统计

```
POST /admin/api/users/<user_id>/reset_quiz_count
```

**功能**：重置用户刷题数

```
POST /admin/api/users/batch_reset_quiz_count
Content-Type: application/json

{
  "user_ids": [1, 2, 3]
}
```

**功能**：批量重置用户刷题数

### 2. 前台 API（修改现有接口）

#### 2.1 获取科目列表（已修改）

```
GET /api/subjects
```

**修改逻辑**：只返回用户有权限的科目

#### 2.2 获取题目列表（已修改）

```
GET /api/questions?subject=数学
```

**修改逻辑**：如果用户在黑名单中（被限制访问该科目），返回空列表或 403

#### 2.3 记录答题结果（已修改）

```
POST /api/quiz/record_result
Content-Type: application/json

{
  "question_id": 1,
  "user_answer": "A",
  "is_correct": true
}
```

**修改逻辑**：
- 检查刷题数限制功能是否开启
- 如果开启，检查用户是否达到限制
- 如果达到限制，返回错误信息，提示付费或联系管理员
- 如果未达到限制，正常记录答题并更新刷题数

**响应示例（达到限制）**：
```json
{
  "status": "error",
  "message": "已达到刷题限制（100题），请付费或联系管理员",
  "code": "QUIZ_LIMIT_REACHED",
  "data": {
    "current_count": 100,
    "limit_count": 100,
    "contact_admin_url": "/contact_admin"
  }
}
```

#### 2.4 获取用户刷题统计

```
GET /api/user/quiz_stats
```

**响应示例**：
```json
{
  "status": "success",
  "data": {
    "total_answered": 85,
    "limit_count": 100,
    "remaining": 15,
    "is_limit_enabled": true,
    "is_vip": false
  }
}
```

---

## 🎨 UI/UX 设计

### 1. 用户详情页中的科目权限管理卡片

**页面路径**：`/admin/users/<user_id>`

**布局设计**（集成在用户详情页中）：
```
┌─────────────────────────────────────────┐
│  用户详情 - student1                    │
├─────────────────────────────────────────┤
│  [用户资料卡片]                         │
│  [统计卡片网格]                         │
├─────────────────────────────────────────┤
│  科目权限管理                            │
│  ┌─────────────────────────────────┐   │
│  │ 已分配科目: 3/10                 │   │
│  │                                  │   │
│  │ [数学] [英语] [物理]             │   │
│  │                                  │   │
│  │ [管理科目权限] →                  │   │
│  └─────────────────────────────────┘   │
├─────────────────────────────────────────┤
│  [最近考试记录]                         │
└─────────────────────────────────────────┘
```

**设计要点**：
- iOS 18 风格卡片
- 已分配科目以标签形式展示
- 点击"管理科目权限"可展开详细管理界面（或跳转到弹窗）
- 简洁、不占用过多空间

### 2. 题库管理页面（批量操作）

**页面路径**：`/admin/subject_permissions`

**布局设计**：
```
┌─────────────────────────────────────────┐
│  题库管理 - 批量权限管理                │
├─────────────────────────────────────────┤
│  统计信息                                │
│  [总用户数] [总科目数] [总分配数]        │
├─────────────────────────────────────────┤
│  批量操作工具栏                          │
│  [全选用户] [全选科目] [批量分配] [批量取消] │
├─────────────────────────────────────────┤
│  用户列表          │  科目列表           │
│  ┌──────────────┐ │ ┌──────────────┐  │
│  │ ☑ user1 (3)  │ │ │ ☑ 数学 (100) │  │
│  │ ☐ user2 (5)  │ │ │ ☐ 英语 (50)  │  │
│  │ ☑ user3 (2)  │ │ │ ☑ 物理 (80)  │  │
│  │ ...          │ │ │ ...          │  │
│  └──────────────┘ │ └──────────────┘  │
├─────────────────────────────────────────┤
│  [执行批量操作]                         │
└─────────────────────────────────────────┘
```

**设计要点**：
- iOS 18 风格：毛玻璃效果、圆角、阴影
- 双列表布局（左右分栏）
- 支持搜索和筛选
- 批量操作工具栏
- 响应式设计（移动端堆叠布局）

### 2. 用户管理页面增强

**位置**：`/admin/users`

**增强功能**：
- 用户列表中显示"已分配科目数"列
- 点击用户可进入详情页查看/管理科目权限
- 快速跳转到题库管理页面进行批量操作

---

## 🔄 数据迁移

### 1. 迁移策略

**场景**：现有系统已有用户和科目，需要迁移到黑名单模式

**迁移方案**：
- **黑名单模式**：无需迁移，默认所有用户可访问所有科目
- 如果之前有白名单数据，需要转换为黑名单（可选）
- 新用户默认无限制，可访问所有科目

**刷题统计初始化**：
- 为现有用户初始化 `user_quiz_stats` 表
- 统计用户历史答题数（从 `user_answers` 表）
- 可选：重置所有用户刷题数为0

### 2. 迁移脚本

**位置**：`scripts/migrate_user_subjects.py`

**功能**：
- 初始化系统配置（刷题限制功能默认关闭）
- 为现有用户初始化刷题统计（从 `user_answers` 表统计历史答题数）
- 可选：重置所有用户刷题数为0

**位置**：`scripts/init_system_config.py`

**功能**：
- 初始化系统配置表
- 设置默认配置值（刷题限制功能关闭，限制数量100）

---

## 🚀 实施计划

### 阶段1：数据库和核心功能（优先级：高）

1. ✅ 创建 `user_subjects` 表
2. ✅ 实现权限检查工具函数
3. ✅ 修改前台科目/题目查询逻辑
4. ✅ 测试权限过滤功能

### 阶段2：管理后台功能（优先级：高）

1. ✅ 在用户详情页集成科目权限管理卡片
2. ✅ 创建题库管理页面（批量操作）
3. ✅ 实现限制/取消限制科目 API（黑名单模式）
4. ✅ 实现批量操作功能（单个用户和批量用户）
5. ✅ 在侧边栏添加"题库管理"菜单项
6. ✅ 用户管理页面增强（显示被限制科目数）
7. ✅ 系统配置管理（刷题限制开关、限制数量）
8. ✅ 用户刷题数管理（查看、重置）

### 阶段2.5：刷题限制功能（优先级：高）

1. ✅ 创建系统配置表和用户刷题统计表
2. ✅ 实现刷题限制检查逻辑
3. ✅ 修改答题记录API，添加限制检查
4. ✅ 实现刷题限制提示UI（前台）
5. ✅ 管理员刷题数管理功能

### 阶段3：UI优化和体验提升（优先级：中）

1. ✅ iOS 18 风格UI设计
2. ✅ 搜索/筛选功能
3. ✅ 批量操作优化
4. ✅ 响应式布局

### 阶段4：扩展功能预留（优先级：低）

1. ⏳ VIP功能接口预留
2. ⏳ 付费题库接口预留
3. ⏳ 权限到期时间管理
4. ⏳ 权限变更日志

---

## 🔮 后续扩展规划

### 1. VIP会员功能

**功能点**：
- 用户表添加 `is_vip`、`vip_expires_at` 字段
- VIP用户自动拥有所有科目权限
- VIP权限到期自动回收

**实现方式**：
- 在 `get_user_accessible_subjects()` 中检查VIP状态
- VIP用户返回所有科目ID

### 2. 付费题库

**功能点**：
- 科目表添加 `is_paid`、`price` 字段
- 用户购买科目后自动分配权限
- 支付系统集成

### 3. 权限分组

**功能点**：
- 创建权限组（如"数学组"、"英语组"）
- 用户分配到权限组，自动获得组内所有科目权限
- 简化批量管理

### 4. 权限到期管理

**功能点**：
- `user_subjects` 表添加 `expires_at` 字段
- 定时任务检查并回收过期权限
- 权限到期提醒

---

## ⚠️ 注意事项

### 1. 性能考虑

- **索引优化**：`user_subjects` 表添加索引
- **查询优化**：使用 JOIN 而非子查询
- **缓存策略**：用户权限列表可缓存（Redis，可选）

### 2. 数据一致性

- **级联删除**：用户/科目删除时自动清理关联
- **事务处理**：批量操作使用事务保证一致性

### 3. 向后兼容

- **现有功能不受影响**：管理员和科目管理员保持原有权限
- **渐进式迁移**：新功能不影响现有用户（如果采用白名单，需要迁移脚本）

### 4. 安全性

- **权限验证**：所有API接口验证管理员权限
- **SQL注入防护**：使用参数化查询
- **XSS防护**：前端输入验证和转义

---

## 📝 测试计划

### 1. 单元测试

- 权限检查函数测试
- 数据库操作测试
- API接口测试

### 2. 集成测试

- 用户科目权限分配流程
- 前台科目过滤功能
- 批量操作功能

### 3. 边界测试

- 用户无任何科目权限时的行为
- 管理员权限验证
- 科目删除后的权限清理

---

## 📚 相关文件清单

### 需要创建的文件

1. `app/core/utils/subject_permissions.py` - 权限检查工具函数和刷题限制检查函数
2. `app/modules/admin/templates/admin/admin_subject_permissions.html` - 题库管理页面（批量操作）
3. `app/modules/admin/templates/admin/admin_system_config.html` - 系统配置管理页面（可选）
4. `scripts/migrate_user_subjects.py` - 数据迁移脚本
5. `scripts/init_system_config.py` - 初始化系统配置脚本

### 需要修改的文件

1. `app/core/utils/database.py` - 添加 `user_subjects`、`system_config`、`user_quiz_stats` 表创建逻辑
2. `app/core/models/question.py` - 添加权限过滤（黑名单模式）
3. `app/modules/admin/routes/pages.py` - 添加题库管理页面路由，修改用户详情页路由
4. `app/modules/admin/routes/api.py` - 添加用户科目权限管理API、批量操作API、系统配置API、刷题数管理API
5. `app/modules/admin/templates/admin/admin_user_detail.html` - 添加科目权限管理卡片和刷题数统计卡片
6. `app/modules/admin/templates/admin/admin_base.html` - 在侧边栏添加"题库管理"菜单项
7. `app/modules/admin/templates/admin/admin_users.html` - 增强用户管理页面（显示被限制科目数、刷题数）
8. `app/modules/quiz/routes/api.py` - 修改科目列表API、修改 `record_result` API添加刷题限制检查
9. `app/modules/main/routes/pages.py` - 修改搜索页面科目筛选
10. `app/modules/exam/routes/api.py` - 修改考试创建API
11. `app/modules/user/routes/api.py` - 添加用户刷题统计API
12. `app/modules/quiz/templates/quiz/quiz.html` - 添加刷题限制提示弹窗

---

## ✅ 验收标准

1. ✅ 管理员可以限制/取消限制用户访问科目（黑名单模式）
2. ✅ 用户默认可以访问所有科目，除非被限制
3. ✅ 管理员可以访问所有科目（不受限制）
4. ✅ 批量操作功能正常
5. ✅ 刷题数限制功能默认关闭
6. ✅ 开启刷题限制后，用户达到限制时提示付费或联系管理员
7. ✅ 管理员可以查看和重置用户刷题数
8. ✅ UI符合iOS 18风格设计
9. ✅ 权限变更后立即生效
10. ✅ 数据迁移脚本可正常执行
11. ✅ 所有API接口有权限验证
12. ✅ 性能满足要求（查询响应时间 < 200ms）

---

**文档版本**：v2.0  
**创建日期**：2025-01-29  
**最后更新**：2025-01-29

**更新日志**：
- v2.0 (2025-01-29): 改为黑名单模式，添加刷题数限制功能
- v1.0 (2025-01-29): 初始版本，白名单模式

