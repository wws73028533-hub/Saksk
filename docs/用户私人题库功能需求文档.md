# 用户私人题库功能需求文档

> 版本：v1.2
> 日期：2026-01-11
> 状态：需求分析阶段（已确认关键决策）

---

## 一、功能概述

### 1.1 背景

当前系统只支持**管理员创建公共题库**，所有用户共享访问。现需增加**用户私人题库**功能，让普通用户也能创建和管理自己的题库。

### 1.2 核心需求

| 需求项 | 描述 |
|--------|------|
| 私人题库 | 用户可创建仅自己可见的题库 |
| **授权访问** | **其他用户使用题库必须获得创建者授权** |
| 分享机制 | 通过分享链接/码，让特定用户获得访问权限 |
| 公开题库 | 支持将私人题库公开给所有人访问（公开=授权所有人） |
| 权限隔离 | 私人题库与公共题库完全隔离，互不影响 |
| 双端支持 | 小程序 + Web 端同时支持 |

### 1.3 核心原则：授权访问机制

> **重要原则：其他用户使用个人题库必须获得创建者授权**

```
┌─────────────────────────────────────────────────────────────┐
│                    题库访问授权机制                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  创建者 ──────────────────────────────────────► 自己的题库   │
│     │                                          (完全控制)   │
│     │                                                       │
│     ├── 方式1: 分享码授权 ──► 输入分享码的用户可访问          │
│     │         (如 ABC123)                                   │
│     │                                                       │
│     ├── 方式2: 分享链接授权 ──► 点击链接的用户可访问          │
│     │         (含加密token)                                 │
│     │                                                       │
│     └── 方式3: 公开授权 ──► 所有登录用户可访问               │
│               (is_public=true)                              │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  ❌ 未授权用户：无法看到、无法搜索、无法访问任何私人题库       │
└─────────────────────────────────────────────────────────────┘
```

**授权方式对比：**

| 授权方式 | 授权范围 | 授权流程 | 可撤销 |
|----------|----------|----------|--------|
| 分享码 | 知道分享码的特定用户 | 用户输入分享码 → 验证 → 授权 | ✅ 可撤销 |
| 分享链接 | 拥有链接的特定用户 | 用户点击链接 → 验证 → 授权 | ✅ 可撤销 |
| 公开 | 所有登录用户 | 用户浏览题库广场 → 自动授权 | ✅ 可取消公开 |

**关键约束：**
- 未经授权的用户**无法看到**他人的私人题库
- 未经授权的用户**无法通过任何方式**访问他人的私人题库
- 题库广场**仅展示**已公开的题库
- 搜索功能**仅能搜索**自己的题库和已公开的题库

### 1.4 用户故事

```
作为一名学生用户，
我希望能够创建自己的错题整理题库，
以便复习时只刷自己整理的题目。

作为一名教师用户，
我希望能够创建题库并分享给我的学生，
以便他们可以使用我整理的专属题目。

作为一名教师用户，
我希望能够将题库公开给所有人，
以便更多学生可以使用我的优质题库。

作为被分享者，
我希望能够使用他人分享给我的题库，
以便获得更多学习资源。
```

### 1.5 已确认的设计决策

| 决策项 | 决定 | 说明 |
|--------|------|------|
| **授权访问** | ✅ 必须授权 | 其他用户使用题库必须获得创建者授权（分享码/链接/公开） |
| 管理界面 | 复用现有后台科目管理 | 套用 `app/modules/admin/` 的科目/题目管理逻辑 |
| Web 端支持 | ✅ 需要 | 小程序和 Web 端同时支持 |
| 分享码格式 | 6位大写字母+数字 | 如 `ABC123`、`XY7890` |
| 题库分类 | 复用科目管理模式 | 用户可为自己的题库创建分类（类似科目） |
| 答题记录归属 | 记录在答题者名下 | 创建者不可见被分享者的答题记录，保护隐私 |
| 题库公开 | ✅ 支持 | 用户可将私人题库公开给所有人 |

---

## 二、功能详细设计

### 2.1 题库类型定义

| 类型 | 标识 | 创建者 | 可见范围 | 管理权限 |
|------|------|--------|----------|----------|
| 系统公共题库 | `system` | 管理员 | 所有用户 | 仅管理员 |
| 私人题库 | `private` | 普通用户 | 仅创建者 | 创建者 |
| 分享题库 | `shared` | 普通用户 | 创建者 + 被分享者 | 创建者 |
| 用户公开题库 | `public` | 普通用户 | 所有用户 | 创建者 |

### 2.2 管理界面复用策略

> **核心原则：复用现有后台科目管理的交互模式和代码结构**

#### 2.2.1 复用对照表

| 现有功能 | 复用到私人题库 | 说明 |
|----------|----------------|------|
| 科目列表页 | 题库列表页 | 复用列表布局、筛选、排序 |
| 科目添加/编辑 | 题库添加/编辑 | 复用表单样式、验证逻辑 |
| 题目列表页 | 题库题目列表 | 复用题目表格、分页、筛选 |
| 题目添加/编辑 | 题库题目添加/编辑 | 完全复用，仅改数据源 |
| 批量操作 | 批量操作 | 复用批量删除、修改、导入导出 |
| Excel 导入导出 | Excel 导入导出 | 复用导入导出逻辑 |

#### 2.2.2 代码复用方案

```
现有文件                              新增/复用
─────────────────────────────────────────────────────
app/modules/admin/routes/api.py   →  app/modules/user_bank/routes/api.py
                                      （复用接口结构，改数据表）

app/modules/admin/templates/       →  app/modules/user_bank/templates/
  subjects.html                        banks.html（复用布局）
  questions.html                       bank_questions.html（复用布局）

app/core/models/question.py       →  app/core/models/user_bank_question.py
                                      （继承/复用核心逻辑）
```

### 2.3 私人题库管理

#### 2.3.1 创建题库

```yaml
输入:
  - 题库名称 (必填, 2-50字符)
  - 题库描述 (选填, 最多200字符)
  - 题库分类 (选填, 用户自建分类)
  - 题库封面 (选填)

输出:
  - 题库ID
  - 创建时间

限制:
  - 每用户最多创建 20 个私人题库
  - 每题库最多 500 道题目
```

#### 2.3.2 题目管理

用户可在私人题库中：
- ✅ 手动添加题目（支持所有题型）
- ✅ 从公共题库复制题目到私人题库
- ✅ 从错题本导入题目
- ✅ 从收藏夹导入题目
- ✅ 编辑自己创建的题目（source_type = 'custom'）
- ✅ 删除题目
- ✅ Excel 批量导入题目（复用现有导入逻辑）
- ✅ Excel 批量导出题目（复用现有导出逻辑）
- ❌ 编辑从其他来源复制的题目（source_type ≠ 'custom'）

> **编辑权限说明**：复制题目时会完整复制内容到私人题库（独立副本），但会标记 `source_type` 来源。为保持题目溯源的准确性，非自建题目（source_type ≠ 'custom'）禁止编辑。如需修改，用户可删除后重新手动添加。

#### 2.3.3 题库操作

| 操作 | 描述 |
|------|------|
| 编辑 | 修改题库名称、描述、封面、分类 |
| 删除 | 删除整个题库及其题目 |
| 排序 | 调整题目顺序 |
| 统计 | 查看题库统计信息 |
| 公开 | 将私人题库公开给所有人 |
| 取消公开 | 将公开题库改回私人 |

### 2.4 题库分类管理（复用科目管理模式）

用户可创建自己的题库分类，类似于管理员的科目管理：

```yaml
分类属性:
  - 分类名称 (必填)
  - 分类描述 (选填)
  - 排序顺序

操作:
  - 创建分类
  - 编辑分类
  - 删除分类（需先移除该分类下的题库）
  - 调整分类顺序
```

### 2.5 分享机制

#### 2.5.1 分享方式

```
方式一：分享链接
  - 生成唯一分享链接
  - 链接包含加密的题库ID和分享令牌
  - 支持设置有效期（永久/7天/30天）
  - 链接格式：{BASE_URL}/bank/join?token={share_token}

方式二：分享码
  - 生成6位大写字母+数字分享码（如 ABC123）
  - 用户输入分享码获取访问权限
  - 支持设置使用次数限制

方式三：直接分享（未来扩展）
  - 搜索用户并直接授权
  - 需要好友/关注关系支持
```

> **域名配置**：分享链接的 `BASE_URL` 需在配置文件中设置。
> - Web 端：配置 `SHARE_BASE_URL`（如 `https://example.com`）
> - 小程序：使用小程序码或跳转页面路径（如 `pages/joinBank/joinBank?token=xxx`）

#### 2.5.2 分享权限级别

| 权限级别 | 标识 | 能力 |
|----------|------|------|
| 只读 | `read` | 仅可刷题，不可复制题目 |
| 可复制 | `copy` | 可刷题，可复制题目到自己的题库 |
| 协作编辑 | `edit` | 可刷题、复制、添加题目（未来扩展） |

#### 2.5.3 分享管理

题库创建者可以：
- 查看所有分享记录
- 查看被分享者列表
- 撤销特定用户的访问权限
- 撤销分享链接/码
- 查看分享统计（访问次数、活跃用户等）

### 2.6 公开题库功能

#### 2.6.1 公开设置

用户可将私人题库设置为公开：

```yaml
公开选项:
  - is_public: true/false
  - public_description: 公开展示的描述（可与私人描述不同）
  - allow_copy: 是否允许他人复制题目（默认 true）

公开后效果:
  - 出现在"题库广场"供所有用户浏览
  - 任何登录用户可直接刷题
  - 根据 allow_copy 设置决定是否可复制题目
```

#### 2.6.2 题库广场

公开题库的展示入口：

```
题库广场页面:
  - 展示所有公开题库
  - 支持搜索、筛选（按分类、热度、最新）
  - 显示题库信息：名称、描述、题目数、使用人数
  - 一键加入刷题
```

### 2.7 被分享者视角

#### 2.7.1 获取分享

```
流程：
1. 用户收到分享链接/码
2. 打开链接或输入分享码
3. 系统验证有效性
4. 题库自动添加到"我收到的分享"列表
5. 用户可随时访问该题库刷题
```

#### 2.7.2 管理收到的分享

- 查看所有收到的分享题库
- 移除不需要的分享（不影响他人）
- 查看分享来源（谁分享的）

#### 2.7.3 答题记录归属

**采用方案B：答题记录归属答题者本人**

- 被分享者的答题记录存储在自己名下
- 题库创建者**不可见**被分享者的答题记录
- 保护用户隐私
- 每个用户只能查看自己的答题统计

---

## 三、数据库设计

### 3.1 新增表结构

#### 3.1.1 `user_bank_categories` 用户题库分类表

```sql
CREATE TABLE user_bank_categories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,              -- 所属用户ID
    name TEXT NOT NULL,                    -- 分类名称
    description TEXT,                      -- 分类描述
    sort_order INTEGER DEFAULT 0,          -- 排序顺序
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(user_id, name),
    FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_ubc_user_id ON user_bank_categories(user_id);
```

#### 3.1.2 `user_question_banks` 用户题库表

```sql
CREATE TABLE user_question_banks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,              -- 创建者ID
    category_id INTEGER,                   -- 分类ID（可选）
    name TEXT NOT NULL,                    -- 题库名称
    description TEXT,                      -- 题库描述（私人）
    cover_image TEXT,                      -- 封面图片路径

    -- 公开设置
    is_public INTEGER DEFAULT 0,           -- 是否公开
    public_description TEXT,               -- 公开描述
    allow_copy INTEGER DEFAULT 1,          -- 是否允许复制题目
    public_at DATETIME,                    -- 公开时间

    -- 统计（冗余字段，提升查询性能）
    question_count INTEGER DEFAULT 0,      -- 题目数量
    share_count INTEGER DEFAULT 0,         -- 分享数量
    public_use_count INTEGER DEFAULT 0,    -- 公开使用人数

    -- 状态
    status INTEGER DEFAULT 1,              -- 状态：1=正常, 0=已删除

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY(category_id) REFERENCES user_bank_categories(id) ON DELETE SET NULL
);

-- 索引
CREATE INDEX idx_uqb_user_id ON user_question_banks(user_id);
CREATE INDEX idx_uqb_category_id ON user_question_banks(category_id);
CREATE INDEX idx_uqb_status ON user_question_banks(status);
CREATE INDEX idx_uqb_is_public ON user_question_banks(is_public, status);
```

#### 3.1.3 `user_bank_questions` 用户题库题目表

```sql
CREATE TABLE user_bank_questions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    bank_id INTEGER NOT NULL,              -- 所属题库ID
    user_id INTEGER NOT NULL,              -- 创建者ID（冗余，便于权限检查）

    -- 题目内容（自建题目填写，复制题目也复制内容）
    content TEXT NOT NULL,                 -- 题干
    q_type TEXT NOT NULL,                  -- 题型
    options TEXT,                          -- 选项（JSON）
    answer TEXT,                           -- 答案
    explanation TEXT,                      -- 解析
    difficulty INTEGER DEFAULT 1,          -- 难度
    image_path TEXT,                       -- 图片

    -- 来源信息
    source_type TEXT DEFAULT 'custom',     -- 来源类型：custom=自建, public=公共题库, mistake=错题, favorite=收藏
    source_question_id INTEGER,            -- 来源题目ID（复制时记录）

    -- 排序
    sort_order INTEGER DEFAULT 0,          -- 排序顺序

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY(bank_id) REFERENCES user_question_banks(id) ON DELETE CASCADE,
    FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_ubq_bank_id ON user_bank_questions(bank_id);
CREATE INDEX idx_ubq_user_id ON user_bank_questions(user_id);
CREATE INDEX idx_ubq_source ON user_bank_questions(source_type, source_question_id);
CREATE INDEX idx_ubq_q_type ON user_bank_questions(q_type);
```

#### 3.1.4 `bank_shares` 题库分享表

```sql
CREATE TABLE bank_shares (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    bank_id INTEGER NOT NULL,              -- 题库ID
    owner_id INTEGER NOT NULL,             -- 题库拥有者ID

    -- 分享配置
    share_code TEXT UNIQUE,                -- 分享码（6位大写字母+数字）
    share_token TEXT UNIQUE,               -- 分享令牌（用于链接，32位UUID）
    permission TEXT DEFAULT 'read',        -- 权限级别：read, copy, edit

    -- 限制条件
    expires_at DATETIME,                   -- 过期时间（NULL=永久）
    max_uses INTEGER,                      -- 最大使用次数（NULL=不限）
    current_uses INTEGER DEFAULT 0,        -- 当前使用次数

    -- 状态
    is_active INTEGER DEFAULT 1,           -- 是否有效

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY(bank_id) REFERENCES user_question_banks(id) ON DELETE CASCADE,
    FOREIGN KEY(owner_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 索引
CREATE UNIQUE INDEX idx_bs_share_code ON bank_shares(share_code) WHERE share_code IS NOT NULL;
CREATE UNIQUE INDEX idx_bs_share_token ON bank_shares(share_token) WHERE share_token IS NOT NULL;
CREATE INDEX idx_bs_bank_id ON bank_shares(bank_id);
CREATE INDEX idx_bs_owner_id ON bank_shares(owner_id);
```

#### 3.1.5 `bank_share_records` 分享记录表

```sql
CREATE TABLE bank_share_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    share_id INTEGER NOT NULL,             -- 分享ID
    bank_id INTEGER NOT NULL,              -- 题库ID（冗余）
    user_id INTEGER NOT NULL,              -- 被分享用户ID

    -- 状态
    status INTEGER DEFAULT 1,              -- 1=有效, 0=已移除

    -- 统计
    last_access_at DATETIME,               -- 最后访问时间
    access_count INTEGER DEFAULT 0,        -- 访问次数

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(share_id, user_id),
    FOREIGN KEY(share_id) REFERENCES bank_shares(id) ON DELETE CASCADE,
    FOREIGN KEY(bank_id) REFERENCES user_question_banks(id) ON DELETE CASCADE,
    FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_bsr_user_id ON bank_share_records(user_id, status);
CREATE INDEX idx_bsr_bank_id ON bank_share_records(bank_id);
```

#### 3.1.6 `user_bank_answers` 用户题库答题记录表

```sql
CREATE TABLE user_bank_answers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,              -- 答题用户ID（记录归属答题者）
    bank_id INTEGER NOT NULL,
    question_id INTEGER NOT NULL,          -- user_bank_questions.id

    user_answer TEXT,
    is_correct INTEGER,

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    -- 每个用户对每道题只保留最新记录
    UNIQUE(user_id, question_id),
    FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY(bank_id) REFERENCES user_question_banks(id) ON DELETE CASCADE,
    FOREIGN KEY(question_id) REFERENCES user_bank_questions(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_uba_user_bank ON user_bank_answers(user_id, bank_id);
CREATE INDEX idx_uba_user_question ON user_bank_answers(user_id, question_id);
```

#### 3.1.7 `user_bank_mistakes` 用户题库错题表

```sql
CREATE TABLE user_bank_mistakes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,              -- 用户ID
    bank_id INTEGER NOT NULL,              -- 题库ID
    question_id INTEGER NOT NULL,          -- 题目ID
    wrong_count INTEGER DEFAULT 1,         -- 错误次数

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(user_id, question_id),
    FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY(bank_id) REFERENCES user_question_banks(id) ON DELETE CASCADE,
    FOREIGN KEY(question_id) REFERENCES user_bank_questions(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_ubm_user_bank ON user_bank_mistakes(user_id, bank_id);
```

#### 3.1.8 `public_bank_users` 公开题库使用记录表

```sql
CREATE TABLE public_bank_users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    bank_id INTEGER NOT NULL,              -- 公开题库ID
    user_id INTEGER NOT NULL,              -- 使用者ID

    last_access_at DATETIME,               -- 最后访问时间
    access_count INTEGER DEFAULT 0,        -- 访问次数

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(bank_id, user_id),
    FOREIGN KEY(bank_id) REFERENCES user_question_banks(id) ON DELETE CASCADE,
    FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_pbu_bank_id ON public_bank_users(bank_id);
CREATE INDEX idx_pbu_user_id ON public_bank_users(user_id);
```

### 3.2 表关系图

```
users
  │
  ├──< user_bank_categories (1:N) ─── 用户的题库分类
  │
  ├──< user_question_banks (1:N) ─── 用户创建的题库
  │         │
  │         ├──< user_bank_questions (1:N) ─── 题库中的题目
  │         │
  │         ├──< bank_shares (1:N) ─── 题库的分享配置
  │         │         │
  │         │         └──< bank_share_records (1:N) ─── 分享使用记录
  │         │
  │         └──< public_bank_users (1:N) ─── 公开题库使用记录
  │
  ├──< bank_share_records (1:N) ─── 用户收到的分享
  │
  ├──< user_bank_answers (1:N) ─── 用户的答题记录（归属答题者）
  │
  └──< user_bank_mistakes (1:N) ─── 用户的错题记录
```

---

## 四、API 接口设计

### 4.1 题库分类管理

#### 4.1.1 获取分类列表

```http
GET /api/user/bank-categories
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "data": {
        "categories": [
            {
                "id": 1,
                "name": "期末复习",
                "description": "期末考试题库",
                "bank_count": 3,
                "sort_order": 0
            }
        ]
    }
}
```

#### 4.1.2 创建分类

```http
POST /api/user/bank-categories
Authorization: Bearer <token>

{
    "name": "期末复习",
    "description": "期末考试题库"
}
```

#### 4.1.3 编辑分类

```http
PUT /api/user/bank-categories/<category_id>
Authorization: Bearer <token>

{
    "name": "期中复习",
    "description": "更新描述"
}
```

#### 4.1.4 删除分类

```http
DELETE /api/user/bank-categories/<category_id>
Authorization: Bearer <token>
```

### 4.2 用户题库管理

#### 4.2.1 获取我的题库列表

```http
GET /api/user/banks
Authorization: Bearer <token>

Query Params:
  - category_id: 分类筛选
  - is_public: 公开状态筛选

Response:
{
    "code": 0,
    "data": {
        "banks": [
            {
                "id": 1,
                "name": "高数错题集",
                "description": "期末复习用",
                "category_id": 1,
                "category_name": "期末复习",
                "cover_image": null,
                "question_count": 45,
                "share_count": 3,
                "is_public": false,
                "created_at": "2026-01-10T10:00:00Z"
            }
        ],
        "total": 5,
        "limit": 20
    }
}
```

#### 4.2.2 获取题库详情

```http
GET /api/user/banks/<bank_id>
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "data": {
        "id": 1,
        "name": "高数错题集",
        "description": "期末复习用",
        "category_id": 1,
        "category_name": "期末复习",
        "cover_image": null,
        "question_count": 45,
        "share_count": 3,
        "is_public": false,
        "public_description": null,
        "allow_copy": true,
        "created_at": "2026-01-10T10:00:00Z",
        "updated_at": "2026-01-11T08:00:00Z"
    }
}

权限说明:
  - 创建者：返回完整信息
  - 被分享者：返回基础信息 + permission 字段
  - 公开题库访问者：返回公开信息
  - 未授权用户：返回 403 Forbidden
```

#### 4.2.3 创建题库

```http
POST /api/user/banks
Authorization: Bearer <token>

{
    "name": "高数错题集",
    "description": "期末复习用",
    "category_id": 1
}

Response:
{
    "code": 0,
    "data": {
        "id": 1,
        "name": "高数错题集"
    }
}
```

#### 4.2.4 编辑题库

```http
PUT /api/user/banks/<bank_id>
Authorization: Bearer <token>

{
    "name": "高数错题集（更新）",
    "description": "新描述",
    "category_id": 2
}
```

#### 4.2.5 删除题库

```http
DELETE /api/user/banks/<bank_id>
Authorization: Bearer <token>
```

#### 4.2.6 设置题库公开状态

```http
POST /api/user/banks/<bank_id>/public
Authorization: Bearer <token>

{
    "is_public": true,
    "public_description": "优质高数题库，欢迎使用",
    "allow_copy": true
}

Response:
{
    "code": 0,
    "message": "题库已公开"
}
```

### 4.3 题目管理

#### 4.3.1 获取题库题目列表

```http
GET /api/user/banks/<bank_id>/questions
Authorization: Bearer <token>

Query Params:
  - page: 页码
  - per_page: 每页数量
  - q_type: 题型筛选
  - keyword: 搜索关键词

Response:
{
    "code": 0,
    "data": {
        "questions": [...],
        "total": 45,
        "page": 1
    }
}
```

#### 4.3.2 添加题目（自建）

```http
POST /api/user/banks/<bank_id>/questions
Authorization: Bearer <token>

{
    "content": "题干内容",
    "q_type": "选择题",
    "options": ["A. 选项1", "B. 选项2", "C. 选项3", "D. 选项4"],
    "answer": "A",
    "explanation": "解析",
    "difficulty": 2
}
```

#### 4.3.3 从公共题库复制题目

```http
POST /api/user/banks/<bank_id>/questions/copy
Authorization: Bearer <token>

{
    "question_ids": [101, 102, 103],
    "source_type": "public"
}
```

#### 4.3.4 从错题本/收藏夹导入

```http
POST /api/user/banks/<bank_id>/questions/import
Authorization: Bearer <token>

{
    "source": "mistakes",  // 或 "favorites"
    "subject_id": 1,       // 可选，筛选科目
    "question_ids": []     // 可选，指定题目；为空则导入全部
}
```

#### 4.3.5 编辑题目

```http
PUT /api/user/banks/<bank_id>/questions/<question_id>
Authorization: Bearer <token>

{
    "content": "更新后的题干",
    "answer": "B"
}
```

#### 4.3.6 删除题目

```http
DELETE /api/user/banks/<bank_id>/questions/<question_id>
Authorization: Bearer <token>
```

#### 4.3.7 批量删除题目

```http
POST /api/user/banks/<bank_id>/questions/batch_delete
Authorization: Bearer <token>

{
    "question_ids": [1, 2, 3]
}
```

#### 4.3.8 Excel 导入题目

```http
POST /api/user/banks/<bank_id>/questions/import/excel
Authorization: Bearer <token>
Content-Type: multipart/form-data

file: <Excel文件>
```

#### 4.3.9 Excel 导出题目

```http
GET /api/user/banks/<bank_id>/questions/export/excel
Authorization: Bearer <token>
```

### 4.4 分享管理

#### 4.4.1 创建分享

```http
POST /api/user/banks/<bank_id>/shares
Authorization: Bearer <token>

{
    "type": "code",           // "code" 或 "link"
    "permission": "read",     // "read" 或 "copy"
    "expires_in": 7,          // 有效天数，null=永久
    "max_uses": 10            // 最大使用次数，null=不限
}

Response:
{
    "code": 0,
    "data": {
        "share_id": 1,
        "share_code": "ABC123",        // 如果 type=code
        "share_link": "https://...",   // 如果 type=link
        "expires_at": "2026-01-18T10:00:00Z"
    }
}
```

#### 4.4.2 获取分享列表

```http
GET /api/user/banks/<bank_id>/shares
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "data": {
        "shares": [
            {
                "id": 1,
                "share_code": "ABC123",
                "permission": "read",
                "current_uses": 5,
                "max_uses": 10,
                "expires_at": null,
                "is_active": true,
                "created_at": "2026-01-10T10:00:00Z"
            }
        ]
    }
}
```

#### 4.4.3 撤销分享

```http
DELETE /api/user/banks/<bank_id>/shares/<share_id>
Authorization: Bearer <token>
```

#### 4.4.4 查看分享使用记录

```http
GET /api/user/banks/<bank_id>/shares/<share_id>/records
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "data": {
        "records": [
            {
                "user_id": 123,
                "nickname": "张三",
                "avatar": "...",
                "access_count": 10,
                "last_access_at": "2026-01-11T08:00:00Z"
            }
        ]
    }
}
```

#### 4.4.5 移除特定用户的访问权限

```http
DELETE /api/user/banks/<bank_id>/shares/<share_id>/records/<user_id>
Authorization: Bearer <token>
```

### 4.5 被分享者接口

#### 4.5.1 通过分享码加入

```http
POST /api/user/banks/join
Authorization: Bearer <token>

{
    "share_code": "ABC123"
}

Response:
{
    "code": 0,
    "data": {
        "bank_id": 1,
        "bank_name": "高数错题集",
        "owner_nickname": "李老师",
        "question_count": 45,
        "permission": "read"
    }
}
```

#### 4.5.2 获取收到的分享列表

```http
GET /api/user/banks/shared
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "data": {
        "banks": [
            {
                "bank_id": 1,
                "bank_name": "高数错题集",
                "owner_id": 100,
                "owner_nickname": "李老师",
                "question_count": 45,
                "permission": "read",
                "last_access_at": "2026-01-11T08:00:00Z"
            }
        ]
    }
}
```

#### 4.5.3 移除收到的分享

```http
DELETE /api/user/banks/shared/<bank_id>
Authorization: Bearer <token>
```

### 4.6 公开题库接口

#### 4.6.1 获取公开题库列表（题库广场）

```http
GET /api/public/banks
Authorization: Bearer <token> (可选)

Query Params:
  - page: 页码
  - per_page: 每页数量
  - sort: 排序方式 (newest/popular/questions)
  - keyword: 搜索关键词

Response:
{
    "code": 0,
    "data": {
        "banks": [
            {
                "id": 1,
                "name": "高数精选题库",
                "public_description": "优质高数题库",
                "owner_id": 100,
                "owner_nickname": "李老师",
                "owner_avatar": "...",
                "question_count": 200,
                "use_count": 1500,
                "allow_copy": true,
                "public_at": "2026-01-05T10:00:00Z"
            }
        ],
        "total": 50,
        "page": 1
    }
}
```

#### 4.6.2 获取公开题库详情

```http
GET /api/public/banks/<bank_id>
Authorization: Bearer <token> (可选)

Response:
{
    "code": 0,
    "data": {
        "id": 1,
        "name": "高数精选题库",
        "public_description": "优质高数题库",
        "owner_nickname": "李老师",
        "question_count": 200,
        "use_count": 1500,
        "allow_copy": true
    }
}
```

#### 4.6.3 加入公开题库刷题

```http
POST /api/public/banks/<bank_id>/join
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "message": "已加入"
}
```

### 4.7 刷题接口

#### 4.7.1 获取私人/分享/公开题库刷题题目

```http
GET /api/user/banks/<bank_id>/quiz
Authorization: Bearer <token>

Query Params:
  - mode: 刷题模式 (all/random/wrong)
  - limit: 数量

Response:
{
    "code": 0,
    "data": {
        "questions": [...],
        "total": 45
    }
}
```

#### 4.7.2 记录答题结果

```http
POST /api/user/banks/<bank_id>/quiz/record
Authorization: Bearer <token>

{
    "question_id": 1,
    "user_answer": "A",
    "is_correct": true
}
```

#### 4.7.3 获取我的答题统计

```http
GET /api/user/banks/<bank_id>/my-stats
Authorization: Bearer <token>

Response:
{
    "code": 0,
    "data": {
        "total_answered": 30,
        "correct_count": 25,
        "wrong_count": 5,
        "accuracy": 83.3
    }
}
```

---

## 五、前端页面设计

### 5.1 小程序页面

| 页面路径 | 功能 | 入口 |
|----------|------|------|
| `/pages/myBanks/myBanks` | 我的题库列表 | 个人中心 |
| `/pages/bankDetail/bankDetail` | 题库详情/管理 | 题库列表 |
| `/pages/bankQuiz/bankQuiz` | 私人题库刷题 | 题库详情 |
| `/pages/bankEdit/bankEdit` | 创建/编辑题库 | 题库列表 |
| `/pages/questionEdit/questionEdit` | 添加/编辑题目 | 题库详情 |
| `/pages/bankShare/bankShare` | 分享管理 | 题库详情 |
| `/pages/sharedBanks/sharedBanks` | 收到的分享 | 个人中心 |
| `/pages/joinBank/joinBank` | 输入分享码加入 | 扫码/手动 |
| `/pages/bankPlaza/bankPlaza` | 题库广场（公开题库） | 首页/发现 |
| `/pages/bankCategories/bankCategories` | 我的分类管理 | 我的题库 |

### 5.2 Web 端页面

> **复用现有后台科目管理的页面结构和样式**

| 页面路径 | 功能 | 复用来源 |
|----------|------|----------|
| `/user/banks` | 我的题库列表 | 复用 `/admin/subjects` 布局 |
| `/user/banks/<id>` | 题库题目管理 | 复用 `/admin/questions` 布局 |
| `/user/banks/<id>/edit` | 编辑题库 | 复用科目编辑表单 |
| `/user/banks/<id>/questions/add` | 添加题目 | 复用题目添加表单 |
| `/user/banks/<id>/questions/<qid>/edit` | 编辑题目 | 复用题目编辑表单 |
| `/user/banks/<id>/shares` | 分享管理 | 新建 |
| `/user/banks/shared` | 收到的分享 | 新建 |
| `/user/banks/categories` | 分类管理 | 复用 `/admin/subjects` 布局 |
| `/public/banks` | 题库广场 | 新建 |

### 5.3 页面交互流程

```
┌─────────────────────────────────────────────────────────────┐
│                        个人中心                              │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐   │
│  │  我的题库 (5)  │  │ 收到的分享 (3) │  │  题库广场      │   │
│  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘   │
└──────────┼──────────────────┼──────────────────┼───────────┘
           │                  │                  │
           ▼                  ▼                  ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   我的题库列表    │  │  收到的分享列表   │  │    题库广场      │
│                 │  │                 │  │                 │
│ [+ 创建题库]     │  │ [输入分享码]     │  │  搜索/筛选       │
│ [管理分类]       │  │                 │  │                 │
│                 │  │ ┌─────────────┐ │  │ ┌─────────────┐ │
│ ┌─────────────┐ │  │ │ 李老师的题库 │ │  │ │ 热门题库     │ │
│ │ 高数错题集   │ │  │ │ 45题 只读   │ │  │ │ 200题 公开  │ │
│ │ 45题 3分享  │ │  │ └──────┬──────┘ │  │ └──────┬──────┘ │
│ │ [公开]      │ │  └────────┼────────┘  └────────┼────────┘
│ └──────┬──────┘ │           │                    │
└────────┼────────┘           │                    │
         │                    ▼                    ▼
         ▼          ┌─────────────────────────────────────┐
┌─────────────────────────────────────┐                   │
│            题库详情页                 │◄──────────────────┘
│                                     │
│  ┌─────────┐ ┌─────────┐ ┌────────┐ │
│  │ 开始刷题 │ │ 管理题目 │ │ 分享   │ │
│  └─────────┘ └─────────┘ └────────┘ │
│                                     │
│  ┌──────────────────────┐           │
│  │ 公开设置              │           │
│  │ [✓] 公开此题库        │           │
│  │ [ ] 允许复制题目      │           │
│  └──────────────────────┘           │
│                                     │
│  题目列表：                          │
│  ┌─────────────────────────────────┐│
│  │ 1. 以下哪个是... [选择题]        ││
│  │ 2. 判断对错...   [判断题]        ││
│  └─────────────────────────────────┘│
└─────────────────────────────────────┘
```

### 5.4 UI 设计要点

遵循项目 UI 规范：
- iOS 18 极简风格
- 单色系（白/浅灰）
- 圆角卡片 + 微阴影
- 玻璃拟态效果
- 充足留白
- 复用现有后台管理的组件样式

---

## 六、安全与限制

### 6.1 权限控制

| 操作 | 权限要求 |
|------|----------|
| 创建题库 | 登录用户 |
| 编辑题库 | 题库创建者 |
| 删除题库 | 题库创建者 |
| 公开题库 | 题库创建者 |
| 创建分享 | 题库创建者 |
| 撤销分享 | 题库创建者 |
| 刷题（私人题库） | 题库创建者 |
| 刷题（分享题库） | 被分享者 |
| 刷题（公开题库） | 所有登录用户 |
| 复制题目 | 被分享者（需 copy 权限）/ 公开题库（需 allow_copy） |

### 6.2 权限验证流程

访问题库时的权限检查逻辑：

```python
def check_bank_access(user_id, bank_id):
    """
    检查用户是否有权访问题库
    返回: (has_access: bool, permission: str, access_type: str)
    """
    bank = get_bank(bank_id)
    if not bank or bank.status == 0:
        return (False, None, None)

    # 1. 创建者：完全权限
    if bank.user_id == user_id:
        return (True, 'owner', 'owner')

    # 2. 公开题库：所有登录用户可访问
    if bank.is_public:
        permission = 'copy' if bank.allow_copy else 'read'
        return (True, permission, 'public')

    # 3. 分享授权：检查分享记录
    share_record = get_share_record(user_id, bank_id)
    if share_record and share_record.status == 1:
        share = get_share(share_record.share_id)
        if share.is_active and not is_expired(share):
            return (True, share.permission, 'shared')

    # 4. 未授权
    return (False, None, None)
```

**API 层权限检查示例**：

```python
@jwt_required
def get_bank_questions(bank_id):
    user_id = current_user_id()
    has_access, permission, access_type = check_bank_access(user_id, bank_id)

    if not has_access:
        return jsonify({'code': 403, 'message': '无权访问此题库'}), 403

    # 根据 access_type 和 permission 返回相应数据
    questions = get_questions(bank_id)
    return jsonify({
        'code': 0,
        'data': {
            'questions': questions,
            'permission': permission,
            'access_type': access_type
        }
    })
```

### 6.3 数量限制

| 限制项 | 限制值 | 说明 |
|--------|--------|------|
| 每用户最大题库数 | 20 | 可配置 |
| 每题库最大题目数 | 500 | 可配置 |
| 每用户最大分类数 | 10 | 可配置 |
| 每题库最大分享数 | 10 | 可配置 |
| 分享码有效期 | 永久/7天/30天 | 用户选择 |
| 分享码最大使用次数 | 不限/10/50/100 | 用户选择 |

### 6.4 数据安全

- 分享码：6位大写字母+数字（如 ABC123），随机生成
- 分享令牌：32位 UUID，用于链接
- 删除题库时级联删除所有题目和分享
- 撤销分享时保留历史记录但标记无效
- 答题记录归属答题者，题库创建者不可见

---

## 七、与现有系统的关系

### 7.1 数据隔离

```
系统公共题库 (questions 表)
    │
    │  复制时复制完整内容
    │  不建立外键关联
    ▼
私人题库 (user_bank_questions 表)
    │
    │  记录 source_question_id
    │  便于溯源但不强依赖
    ▼
独立管理（用户完全控制）
```

### 7.2 功能复用

| 功能模块 | 复用情况 |
|----------|----------|
| 题型支持 | 完全复用现有5种题型 |
| 选项解析 | 复用 `options_parser.py` |
| 答题判定 | 复用现有判定逻辑 |
| 图片上传 | 复用现有图片上传接口 |
| 用户认证 | 复用 `@jwt_required` 和 `@auth_required` |
| 管理界面 | 复用后台科目/题目管理的模板和逻辑 |
| Excel 导入导出 | 复用现有导入导出逻辑 |

### 7.3 刷题统计

- 私人题库刷题 **不计入** 公共刷题统计
- 私人题库有独立的答题记录表
- 避免影响用户的公共刷题限制

---

## 八、实现优先级建议

### Phase 1 - 核心功能（MVP）

> 由于复用现有后台科目管理，以下功能可一次性实现

1. ✅ 数据库表创建
2. ✅ 创建/编辑/删除题库
3. ✅ 题库分类管理（复用科目管理）
4. ✅ 手动添加/编辑/删除题目（复用题目管理）
5. ✅ 从公共题库复制题目
6. ✅ 从错题本/收藏夹导入
7. ✅ Excel 批量导入导出（复用现有逻辑）
8. ✅ 私人题库刷题
9. ✅ 小程序页面基础框架
10. ✅ Web 端页面（复用后台模板）

### Phase 2 - 分享功能

1. 分享码生成与验证（6位大写字母+数字）
2. 分享链接生成
3. 被分享者加入与刷题
4. 分享管理（撤销、查看记录）

### Phase 3 - 公开题库

1. 题库公开设置
2. 题库广场页面
3. 公开题库搜索与筛选
4. 公开题库统计

### Phase 4 - 增强功能

1. 题目排序
2. 题库封面
3. 分享统计分析
4. 答题进度同步

---

## 九、附录

### A. 术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 私人题库 | User Question Bank | 用户创建的个人题库 |
| 分享码 | Share Code | 6位大写字母+数字分享码，如 ABC123 |
| 分享令牌 | Share Token | 用于分享链接的加密令牌 |
| 被分享者 | Sharee | 收到分享的用户 |
| 题库广场 | Bank Plaza | 展示所有公开题库的页面 |
| 公开题库 | Public Bank | 对所有用户可见的题库 |

### B. 相关文件

- 数据库工具：`app/core/utils/database.py`
- 权限装饰器：`app/core/utils/decorators.py`
- 题目模型：`app/core/models/question.py`
- 选项解析：`app/core/utils/options_parser.py`
- 后台科目管理：`app/modules/admin/routes/api.py`
- 后台模板：`app/modules/admin/templates/`

### C. 分享码生成算法

```python
import random
import string

def generate_share_code(length=6):
    """生成6位大写字母+数字分享码"""
    characters = string.ascii_uppercase + string.digits
    while True:
        code = ''.join(random.choices(characters, k=length))
        # 确保至少包含1个字母和1个数字
        if any(c.isalpha() for c in code) and any(c.isdigit() for c in code):
            return code

# 示例输出: ABC123, XY7890, K3M9P2
```

---

*文档结束 - v1.2*
