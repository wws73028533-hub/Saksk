<!--quiz.wxml - 刷题/背题页面-->
<view class="page-root {{themeClass}}">
  <navigation-bar
    title="{{progress.current}}/{{progress.total}}"
    back="{{true}}"
    color="var(--app-nav-fg)"
    background="var(--app-nav-bg)"
    extClass="quiz-navbar"
  >
    <view slot="left" class="nav-left-actions">
      <view class="nav-action-btn" bindtap="onOpenQuestionList" hover-class="nav-action-btn-hover">
        <image class="nav-action-icon" src="/images/icons/list.svg" mode="aspectFit"></image>
      </view>
    </view>
    <view slot="right" class="nav-right-actions">
      <view class="nav-action-btn" bindtap="onOpenSettings" hover-class="nav-action-btn-hover">
        <image class="nav-action-icon" src="/images/icons/settings.svg" mode="aspectFit"></image>
      </view>
    </view>
  </navigation-bar>

  <view class="page-container">
    <scroll-view class="content-area" scroll-y type="list" bounces="{{false}}">
    <view class="container">
      <!-- 加载状态 -->
      <view class="loading" wx:if="{{loading}}">
        <text>加载中...</text>
      </view>

      <!-- 题目内容 -->
      <view class="question-wrapper" wx:if="{{!loading && currentQuestion}}">
        <!-- 题目卡片 -->
        <view class="question-card">
          <view class="question-header">
            <view class="question-type-tag">{{currentQuestion.q_type}}</view>
            <!-- 卡片右上角操作按钮：编辑、收藏、标签 -->
            <view class="card-actions">
              <view class="card-action-btn" bindtap="onEditQuestion" hover-class="card-action-btn-hover" wx:if="{{canEdit}}">
                <image class="card-action-icon" src="/images/icons/edit.svg" mode="aspectFit"></image>
              </view>
              <view class="card-action-btn" bindtap="onToggleFavorite" hover-class="card-action-btn-hover">
                <image class="card-action-icon" src="{{isFavorite ? '/images/icons/heart-filled.svg' : '/images/icons/heart.svg'}}" mode="aspectFit"></image>
              </view>
              <view class="card-action-btn" bindtap="onOpenTagModal" hover-class="card-action-btn-hover">
                <image class="card-action-icon" src="/images/icons/tag.svg" mode="aspectFit"></image>
              </view>
            </view>
          </view>
        <view class="question-content">
            <text class="question-text {{currentQuestion.isCode ? 'mono' : ''}}">{{currentQuestion.displayContent || currentQuestion.content}}</text>
            <view class="question-images" wx:if="{{currentQuestion.image_urls && currentQuestion.image_urls.length}}">
              <image
                class="question-image"
                wx:for="{{currentQuestion.image_urls}}"
                wx:key="*this"
                src="{{item}}"
                mode="widthFix"
                bindtap="previewImage"
                data-index="{{index}}"
              ></image>
            </view>
          </view>
        </view>

        <!-- 选择题/多选题/判断题：选项（统一渲染，提交后高亮对错） -->
        <view wx:if="{{currentQuestion.q_type === '选择题' || currentQuestion.q_type === '多选题' || currentQuestion.q_type === '判断题'}}">
          <view 
            class="option-item {{item.className}}"
            wx:for="{{displayOptions}}" 
            wx:key="key"
            bindtap="onSelectAnswer"
            data-answer="{{item.answerValue}}"
          >
            <text class="option-key">{{item.key}}.</text>
            <text class="option-text">{{item.value}}</text>
            <text class="correct-mark" wx:if="{{(mode === 'memo' || showAnswer) && item.isCorrect}}">✓</text>
            <text class="wrong-mark" wx:if="{{showAnswer && item.isWrong}}">✕</text>
          </view>
        </view>

        <!-- 填空题：输入框（刷题模式且未提交时显示） -->
        <view wx:if="{{mode === 'quiz' && !showAnswer && currentQuestion.q_type === '填空题'}}" class="fill-blank-wrapper">
          <view class="blank-item" wx:for="{{blankIndexes}}" wx:key="*this" wx:for-item="idx">
            <text class="blank-label">第{{idx + 1}}空</text>
            <input
              class="blank-input"
              placeholder="请输入第{{idx + 1}}空"
              value="{{blankAnswers[idx]}}"
              bindinput="onBlankInput"
              data-index="{{idx}}"
              maxlength="200"
            />
          </view>
        </view>

        <!-- 主观题：问答/简答/计算 -->
        <view
          wx:if="{{mode === 'quiz' && !showAnswer && (currentQuestion.q_type === '问答题' || currentQuestion.q_type === '简答题' || currentQuestion.q_type === '计算题')}}"
          class="text-answer-wrapper"
        >
          <textarea
            class="text-answer-input"
            placeholder="请输入你的答案"
            value="{{selectedAnswer}}"
            bindinput="onInputAnswer"
            auto-height
            maxlength="1000"
          ></textarea>
        </view>

        <!-- 背题模式：答案展示 -->
        <view wx:if="{{mode === 'memo'}}" class="answer-display-card">
          <view class="answer-display-header">
            <view class="answer-title">正确答案：{{currentQuestion.displayAnswer || currentQuestion.answer}}</view>
            <view class="answer-card-actions">
              <view class="answer-ai-btn" bindtap="onToggleAIExplain" hover-class="answer-ai-btn-hover">AI</view>
            </view>
          </view>
          <view class="answer-divider"></view>
          <text
            class="answer-tip"
            wx:if="{{currentQuestion.q_type === '选择题' || currentQuestion.q_type === '多选题' || currentQuestion.q_type === '判断题'}}"
          >已在选项中高亮正确答案</text>
          <text
            class="answer-tip"
            wx:if="{{!(currentQuestion.q_type === '选择题' || currentQuestion.q_type === '多选题' || currentQuestion.q_type === '判断题')}}"
          >请对照答案巩固记忆</text>
        </view>

        <!-- 刷题模式：答案结果展示 -->
        <view wx:if="{{mode === 'quiz' && showAnswer}}" class="answer-result-card">
          <view class="result-header {{isJudgable ? (isCorrect ? 'correct' : 'wrong') : 'submitted'}}">
            <text class="result-icon">{{isJudgable ? (isCorrect ? '✓' : '✕') : '✓'}}</text>
            <text class="result-text">{{isJudgable ? (isCorrect ? '回答正确' : '回答错误') : '已提交'}}</text>
            <view class="answer-card-actions">
              <view class="answer-ai-btn" bindtap="onToggleAIExplain" hover-class="answer-ai-btn-hover">AI</view>
            </view>
          </view>
          <view class="correct-answer">
            <text class="answer-label">正确答案：</text>
            <text class="answer-value">{{currentQuestion.displayAnswer || currentQuestion.answer}}</text>
          </view>
          <view class="user-answer" wx:if="{{!isJudgable || !isCorrect}}">
            <text class="answer-label">你的答案：</text>
            <text class="answer-value wrong">{{userAnswerText}}</text>
          </view>
        </view>

        <!-- 解析 -->
        <view class="explanation-card" wx:if="{{(mode === 'memo' || showAnswer) && currentQuestion.explanation}}">
          <view class="explanation-title">解析：</view>
          <text class="explanation-text {{currentQuestion.explanationIsCode ? 'mono' : ''}}">{{currentQuestion.displayExplanation || currentQuestion.explanation}}</text>
        </view>
      </view>

      <!-- 空状态 -->
      <view class="empty-state" wx:if="{{!loading && !currentQuestion && questions.length === 0}}">
        <text>暂无题目</text>
      </view>
    </view>
  </scroll-view>

  <!-- 提交按钮（刷题模式，未提交时显示） -->
  <view class="submit-btn-wrapper" wx:if="{{mode === 'quiz' && !showAnswer && currentQuestion && showSubmitButton}}">
    <button 
      class="submit-btn {{submitDisabled ? 'disabled' : ''}}"
      bindtap="onSubmitAnswer"
      disabled="{{submitDisabled}}"
    >
      提交答案
    </button>
  </view>

  <!-- 底部导航栏 -->
  <view class="bottom-actions" wx:if="{{!loading && currentQuestion}}">
    <view class="bottom-col left">
      <button
        class="nav-btn prev-btn {{currentIndex === 0 ? 'disabled' : ''}}"
        bindtap="onPrevQuestion"
        disabled="{{currentIndex === 0}}"
      >
        上一题
      </button>
    </view>
    <view class="bottom-col right">
      <button class="nav-btn next-btn" bindtap="onNextQuestion">
        {{currentIndex === questions.length - 1 ? '完成' : '下一题'}}
      </button>
    </view>
  </view>
</view>
</view>

<!-- 题目列表抽屉 -->
<view class="drawer-mask {{showQuestionList ? 'show' : ''}}" bindtap="onCloseQuestionList">
  <view class="drawer-container {{showQuestionList ? 'show' : ''}}" catchtap="stopPropagation">
    <view class="drawer-header">
      <text class="drawer-title">题目列表</text>
      <view class="drawer-close" bindtap="onCloseQuestionList">
        <text>×</text>
      </view>
    </view>
    <scroll-view class="drawer-content" scroll-y>
      <view 
        class="drawer-item {{currentIndex === index ? 'active' : ''}} {{answerRecords[item.id] ? (answerRecords[item.id].isCorrect ? 'correct' : 'wrong') : ''}}"
        wx:for="{{questions}}" 
        wx:key="id"
        wx:for-index="index"
        bindtap="onQuestionListItemTap"
        data-index="{{index}}"
      >
        <view class="drawer-item-content">
          <text class="drawer-item-number">{{index + 1}}.</text>
          <text class="drawer-item-text">{{item.contentPreview || item.content}}</text>
          <text class="drawer-item-status" wx:if="{{answerRecords[item.id]}}">
            {{answerRecords[item.id].isCorrect ? '✓' : '✕'}}
          </text>
        </view>
      </view>
    </scroll-view>
  </view>
</view>

<!-- 刷题设置弹窗 -->
<view wx:if="{{showSettings}}" class="modal-mask" bindtap="onCloseSettings">
  <view class="modal-card" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">刷题设置</text>
      <view class="modal-close" bindtap="onCloseSettings"><text>×</text></view>
    </view>
    <view class="modal-body">
      <view class="setting-item">
        <view class="setting-text">
          <text class="setting-title">答对自动切题</text>
          <text class="setting-desc">答错不切题</text>
        </view>
        <switch checked="{{practiceSettings.autoNextOnCorrect}}" bindchange="onSettingSwitchChange" data-key="autoNextOnCorrect" />
      </view>
      <view class="setting-item">
        <view class="setting-text">
          <text class="setting-title">做错自动收藏</text>
          <text class="setting-desc">自动加入收藏夹</text>
        </view>
        <switch checked="{{practiceSettings.autoFavoriteOnWrong}}" bindchange="onSettingSwitchChange" data-key="autoFavoriteOnWrong" />
      </view>
      <view class="setting-item">
        <view class="setting-text">
          <text class="setting-title">答题震动反馈</text>
          <text class="setting-desc">提交后轻微震动</text>
        </view>
        <switch checked="{{practiceSettings.vibrationFeedback}}" bindchange="onSettingSwitchChange" data-key="vibrationFeedback" />
      </view>
    </view>
  </view>
</view>

<!-- AI 解析卡片 -->
<view wx:if="{{showAIExplain}}" class="ai-mask" bindtap="onToggleAIExplain">
  <view class="ai-card" catchtap="stopPropagation">
    <view class="ai-header">
      <text class="ai-title">AI 解析</text>
      <view class="ai-actions">
        <button class="ai-btn" bindtap="onRegenerateAIExplain" loading="{{aiLoading}}" disabled="{{aiLoading}}">重新生成</button>
      </view>
    </view>
    <scroll-view class="ai-body" scroll-y>
      <view class="ai-loading" wx:if="{{aiLoading}}"><text>生成中...</text></view>
      <view class="ai-error" wx:if="{{!aiLoading && aiExplainError}}"><text>{{aiExplainError}}</text></view>
      <view wx:if="{{!aiLoading && !aiExplainError}}">
        <text class="ai-text">{{aiExplainText}}</text>
      </view>
    </scroll-view>
  </view>
</view>

<!-- 标签选择弹窗 -->
<view wx:if="{{showTagModal}}" class="modal-mask" bindtap="onCloseTagModal">
  <view class="modal-card tag-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">管理标签</text>
      <view class="modal-close" bindtap="onCloseTagModal"><text>×</text></view>
    </view>
    <view class="modal-body">
      <!-- 新增标签输入 -->
      <view class="tag-input-row">
        <input
          class="tag-input"
          placeholder="输入新标签名称"
          value="{{newTagName}}"
          bindinput="onTagNameInput"
          confirm-type="done"
          bindconfirm="onCreateTag"
        />
        <button class="tag-add-btn" bindtap="onCreateTag" disabled="{{!newTagName}}">添加</button>
      </view>
      <!-- 标签列表 -->
      <view class="tag-list">
        <view
          wx:for="{{allTags}}"
          wx:key="name"
          class="tag-item {{item.selected ? 'tag-selected' : ''}}"
          bindtap="onToggleTagSelection"
          data-tag="{{item.name}}"
        >
          <text class="tag-name">{{item.name}}</text>
          <text class="tag-count">{{item.count}}</text>
        </view>
        <view wx:if="{{allTags.length === 0}}" class="tag-empty">
          <text>暂无标签，请先创建</text>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- 编辑题目弹窗 -->
<view wx:if="{{showEditModal}}" class="modal-mask" bindtap="onCloseEditModal">
  <view class="modal-card edit-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">编辑题目</text>
      <view class="modal-close" bindtap="onCloseEditModal"><text>×</text></view>
    </view>
    <scroll-view class="modal-body edit-modal-body" scroll-y>
      <!-- 题干 -->
      <view class="edit-field">
        <text class="edit-label">题干</text>
        <textarea
          class="edit-textarea"
          value="{{editForm.content}}"
          bindinput="onEditContentInput"
          placeholder="请输入题干内容"
          auto-height
          maxlength="2000"
        ></textarea>
      </view>
      <!-- 选项（仅选择题/多选题/判断题） -->
      <view class="edit-field" wx:if="{{editForm.showOptions}}">
        <text class="edit-label">选项（每行一个，格式：A. 选项内容）</text>
        <textarea
          class="edit-textarea"
          value="{{editForm.options}}"
          bindinput="onEditOptionsInput"
          placeholder="A. 选项一&#10;B. 选项二&#10;C. 选项三&#10;D. 选项四"
          auto-height
          maxlength="2000"
        ></textarea>
      </view>
      <!-- 答案 -->
      <view class="edit-field">
        <text class="edit-label">答案</text>
        <textarea
          class="edit-textarea edit-textarea-small"
          value="{{editForm.answer}}"
          bindinput="onEditAnswerInput"
          placeholder="请输入正确答案"
          auto-height
          maxlength="500"
        ></textarea>
      </view>
      <!-- 解析 -->
      <view class="edit-field">
        <text class="edit-label">解析（可选）</text>
        <textarea
          class="edit-textarea"
          value="{{editForm.explanation}}"
          bindinput="onEditExplanationInput"
          placeholder="请输入答案解析"
          auto-height
          maxlength="2000"
        ></textarea>
      </view>
    </scroll-view>
    <view class="edit-modal-footer">
      <button class="edit-cancel-btn" bindtap="onCloseEditModal">取消</button>
      <button class="edit-save-btn" bindtap="onSaveQuestion" loading="{{editSaving}}" disabled="{{editSaving}}">保存</button>
    </view>
  </view>
</view>
