# ç¬¬ä¸€é˜¶æ®µå¼€å‘æ–‡æ¡£ - æ•°æ®åº“å’Œæ ¸å¿ƒåŠŸèƒ½

## ğŸ“‹ æ¦‚è¿°

ç¬¬ä¸€é˜¶æ®µä¸»è¦å®ç°æ•°æ®åº“è¡¨åˆ›å»ºå’Œæ ¸å¿ƒå·¥å…·å‡½æ•°ï¼Œä¸ºåç»­åŠŸèƒ½å¼€å‘å¥ å®šåŸºç¡€ã€‚æœ¬é˜¶æ®µä¸æ¶‰åŠç®¡ç†åå°UIå’ŒAPIï¼Œä¸“æ³¨äºåº•å±‚æ•°æ®ç»“æ„å’Œæƒé™æ£€æŸ¥é€»è¾‘ã€‚

---

## ğŸ¯ é˜¶æ®µç›®æ ‡

1. âœ… åˆ›å»ºä¸‰ä¸ªæ ¸å¿ƒæ•°æ®è¡¨ï¼ˆ`user_subjects`ã€`system_config`ã€`user_quiz_stats`ï¼‰
2. âœ… å®ç°ç§‘ç›®æƒé™æ£€æŸ¥å·¥å…·å‡½æ•°ï¼ˆé»‘åå•æ¨¡å¼ï¼‰
3. âœ… å®ç°åˆ·é¢˜æ•°é™åˆ¶æ£€æŸ¥å·¥å…·å‡½æ•°
4. âœ… ä¿®æ”¹å‰å°ç§‘ç›®/é¢˜ç›®æŸ¥è¯¢é€»è¾‘ï¼Œé›†æˆæƒé™è¿‡æ»¤
5. âœ… ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œç¡®ä¿æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### 1. æ•°æ®è¡¨åˆ›å»º

#### 1.1 `user_subjects` è¡¨ï¼ˆç”¨æˆ·-ç§‘ç›®é™åˆ¶è¡¨ï¼Œé»‘åå•æ¨¡å¼ï¼‰

**ä½ç½®**ï¼š`app/core/utils/database.py` çš„ `_create_tables()` å‡½æ•°

```python
conn.execute('''
    CREATE TABLE IF NOT EXISTS user_subjects (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        subject_id INTEGER NOT NULL,
        restricted_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        restricted_by INTEGER,
        UNIQUE(user_id, subject_id),
        FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE,
        FOREIGN KEY(subject_id) REFERENCES subjects(id) ON DELETE CASCADE,
        FOREIGN KEY(restricted_by) REFERENCES users(id) ON DELETE SET NULL
    )
''')

conn.execute('''
    CREATE INDEX IF NOT EXISTS idx_user_subjects_user_id 
    ON user_subjects(user_id)
''')

conn.execute('''
    CREATE INDEX IF NOT EXISTS idx_user_subjects_subject_id 
    ON user_subjects(subject_id)
''')
```

#### 1.2 `system_config` è¡¨ï¼ˆç³»ç»Ÿé…ç½®è¡¨ï¼‰

```python
conn.execute('''
    CREATE TABLE IF NOT EXISTS system_config (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        config_key TEXT UNIQUE NOT NULL,
        config_value TEXT NOT NULL,
        description TEXT,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_by INTEGER,
        FOREIGN KEY(updated_by) REFERENCES users(id) ON DELETE SET NULL
    )
''')

conn.execute('''
    CREATE INDEX IF NOT EXISTS idx_system_config_key 
    ON system_config(config_key)
''')
```

#### 1.3 `user_quiz_stats` è¡¨ï¼ˆç”¨æˆ·åˆ·é¢˜ç»Ÿè®¡è¡¨ï¼‰

```python
conn.execute('''
    CREATE TABLE IF NOT EXISTS user_quiz_stats (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL UNIQUE,
        total_answered INTEGER DEFAULT 0,
        last_reset_at DATETIME,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
    )
''')

conn.execute('''
    CREATE INDEX IF NOT EXISTS idx_user_quiz_stats_user_id 
    ON user_quiz_stats(user_id)
''')
```

### 2. åˆå§‹åŒ–ç³»ç»Ÿé…ç½®

**ä½ç½®**ï¼š`app/core/utils/database.py` çš„ `_create_tables()` å‡½æ•°æœ«å°¾

```python
# åˆå§‹åŒ–ç³»ç»Ÿé…ç½®ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
default_configs = [
    ('quiz_limit_enabled', '0', 'åˆ·é¢˜æ•°é™åˆ¶åŠŸèƒ½å¼€å…³ï¼ˆ0=å…³é—­ï¼Œ1=å¼€å¯ï¼‰'),
    ('quiz_limit_count', '100', 'ç”¨æˆ·åˆ·é¢˜æ•°é™åˆ¶ï¼ˆè¾¾åˆ°æ­¤æ•°é‡åæç¤ºä»˜è´¹ï¼‰')
]

for config_key, config_value, description in default_configs:
    existing = conn.execute(
        'SELECT id FROM system_config WHERE config_key = ?',
        (config_key,)
    ).fetchone()
    
    if not existing:
        conn.execute(
            '''INSERT INTO system_config (config_key, config_value, description)
               VALUES (?, ?, ?)''',
            (config_key, config_value, description)
        )
```

---

## ğŸ› ï¸ æ ¸å¿ƒå·¥å…·å‡½æ•°å®ç°

### 1. åˆ›å»ºæƒé™æ£€æŸ¥å·¥å…·æ¨¡å—

**ä½ç½®**ï¼š`app/core/utils/subject_permissions.py`

**æ–‡ä»¶ç»“æ„**ï¼š

```python
# -*- coding: utf-8 -*-
"""
ç§‘ç›®æƒé™æ£€æŸ¥å·¥å…·å‡½æ•°ï¼ˆé»‘åå•æ¨¡å¼ï¼‰
"""
from typing import List, Tuple, Optional
from app.core.utils.database import get_db


def is_admin(user_id: int) -> bool:
    """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜"""
    conn = get_db()
    user = conn.execute(
        'SELECT is_admin FROM users WHERE id = ?',
        (user_id,)
    ).fetchone()
    return bool(user and user['is_admin']) if user else False


def get_user_restricted_subjects(user_id: int) -> List[int]:
    """
    è·å–ç”¨æˆ·è¢«é™åˆ¶çš„ç§‘ç›®IDåˆ—è¡¨ï¼ˆé»‘åå•ï¼‰
    
    Args:
        user_id: ç”¨æˆ·ID
        
    Returns:
        è¢«é™åˆ¶çš„ç§‘ç›®IDåˆ—è¡¨
    """
    # ç®¡ç†å‘˜æ— é™åˆ¶
    if is_admin(user_id):
        return []
    
    conn = get_db()
    rows = conn.execute(
        'SELECT subject_id FROM user_subjects WHERE user_id = ?',
        (user_id,)
    ).fetchall()
    
    return [row['subject_id'] for row in rows]


def can_user_access_subject(user_id: int, subject_id: int) -> bool:
    """
    æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥è®¿é—®æŒ‡å®šç§‘ç›®ï¼ˆé»‘åå•æ¨¡å¼ï¼‰
    
    Args:
        user_id: ç”¨æˆ·ID
        subject_id: ç§‘ç›®ID
        
    Returns:
        True å¦‚æœç”¨æˆ·å¯ä»¥è®¿é—®ï¼ŒFalse å¦‚æœè¢«é™åˆ¶
    """
    # ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰ç§‘ç›®
    if is_admin(user_id):
        return True
    
    # æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•ä¸­
    conn = get_db()
    restricted = conn.execute(
        'SELECT id FROM user_subjects WHERE user_id = ? AND subject_id = ?',
        (user_id, subject_id)
    ).fetchone()
    
    # å¦‚æœåœ¨é»‘åå•ä¸­ï¼Œè¿”å› Falseï¼›å¦åˆ™è¿”å› Trueï¼ˆé»˜è®¤æœ‰æƒé™ï¼‰
    return restricted is None


def get_user_accessible_subjects(user_id: int) -> List[int]:
    """
    è·å–ç”¨æˆ·å¯è®¿é—®çš„ç§‘ç›®IDåˆ—è¡¨ï¼ˆé»‘åå•æ¨¡å¼ï¼‰
    
    Args:
        user_id: ç”¨æˆ·ID
        
    Returns:
        å¯è®¿é—®çš„ç§‘ç›®IDåˆ—è¡¨
    """
    # ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰ç§‘ç›®
    if is_admin(user_id):
        conn = get_db()
        rows = conn.execute('SELECT id FROM subjects').fetchall()
        return [row['id'] for row in rows]
    
    # æ™®é€šç”¨æˆ·ï¼šæ‰€æœ‰ç§‘ç›® - è¢«é™åˆ¶çš„ç§‘ç›®
    conn = get_db()
    all_subjects = conn.execute('SELECT id FROM subjects').fetchall()
    all_subject_ids = [row['id'] for row in all_subjects]
    
    restricted_ids = get_user_restricted_subjects(user_id)
    accessible_ids = [sid for sid in all_subject_ids if sid not in restricted_ids]
    
    return accessible_ids


def filter_subjects_by_permission(user_id: Optional[int], subject_ids: List[int]) -> List[int]:
    """
    æ ¹æ®ç”¨æˆ·æƒé™è¿‡æ»¤ç§‘ç›®IDåˆ—è¡¨
    
    Args:
        user_id: ç”¨æˆ·IDï¼ˆNone è¡¨ç¤ºæœªç™»å½•ç”¨æˆ·ï¼‰
        subject_ids: ç§‘ç›®IDåˆ—è¡¨
        
    Returns:
        è¿‡æ»¤åçš„ç§‘ç›®IDåˆ—è¡¨
    """
    if user_id is None:
        # æœªç™»å½•ç”¨æˆ·ï¼šè¿”å›ç©ºåˆ—è¡¨ï¼ˆéœ€è¦ç™»å½•æ‰èƒ½è®¿é—®ï¼‰
        return []
    
    # ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰ç§‘ç›®
    if is_admin(user_id):
        return subject_ids
    
    # æ™®é€šç”¨æˆ·ï¼šè¿‡æ»¤æ‰è¢«é™åˆ¶çš„ç§‘ç›®
    restricted_ids = get_user_restricted_subjects(user_id)
    return [sid for sid in subject_ids if sid not in restricted_ids]
```

### 2. åˆ·é¢˜æ•°é™åˆ¶æ£€æŸ¥å·¥å…·å‡½æ•°

**ä½ç½®**ï¼š`app/core/utils/subject_permissions.py`ï¼ˆè¿½åŠ åˆ°åŒä¸€æ–‡ä»¶ï¼‰

```python
def is_quiz_limit_enabled() -> bool:
    """
    æ£€æŸ¥åˆ·é¢˜æ•°é™åˆ¶åŠŸèƒ½æ˜¯å¦å¼€å¯
    
    Returns:
        True å¦‚æœåŠŸèƒ½å¼€å¯ï¼ŒFalse å¦‚æœå…³é—­
    """
    conn = get_db()
    config = conn.execute(
        'SELECT config_value FROM system_config WHERE config_key = ?',
        ('quiz_limit_enabled',)
    ).fetchone()
    
    if not config:
        return False
    
    return config['config_value'] == '1'


def get_quiz_limit_count() -> int:
    """
    è·å–åˆ·é¢˜æ•°é™åˆ¶æ•°é‡
    
    Returns:
        é™åˆ¶æ•°é‡ï¼ˆé»˜è®¤100ï¼‰
    """
    conn = get_db()
    config = conn.execute(
        'SELECT config_value FROM system_config WHERE config_key = ?',
        ('quiz_limit_count',)
    ).fetchone()
    
    if not config:
        return 100
    
    try:
        return int(config['config_value'])
    except (ValueError, TypeError):
        return 100


def get_user_quiz_count(user_id: int) -> int:
    """
    è·å–ç”¨æˆ·å½“å‰åˆ·é¢˜æ•°
    
    Args:
        user_id: ç”¨æˆ·ID
        
    Returns:
        å½“å‰åˆ·é¢˜æ•°
    """
    conn = get_db()
    stats = conn.execute(
        'SELECT total_answered FROM user_quiz_stats WHERE user_id = ?',
        (user_id,)
    ).fetchone()
    
    return stats['total_answered'] if stats else 0


def check_quiz_limit(user_id: int) -> Tuple[bool, str]:
    """
    æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¾¾åˆ°åˆ·é¢˜é™åˆ¶
    
    Args:
        user_id: ç”¨æˆ·ID
        
    Returns:
        (æ˜¯å¦è¾¾åˆ°é™åˆ¶, æç¤ºä¿¡æ¯)
        å¦‚æœåŠŸèƒ½å…³é—­æˆ–ç”¨æˆ·æ˜¯ç®¡ç†å‘˜/VIPï¼Œè¿”å› (False, "")
        å¦‚æœè¾¾åˆ°é™åˆ¶ï¼Œè¿”å› (True, "æç¤ºä¿¡æ¯")
    """
    # åŠŸèƒ½æœªå¼€å¯ï¼Œä¸é™åˆ¶
    if not is_quiz_limit_enabled():
        return False, ""
    
    # ç®¡ç†å‘˜ä¸å—é™åˆ¶ï¼ˆåç»­å¯æ‰©å±•VIPï¼‰
    if is_admin(user_id):
        return False, ""
    
    # æ£€æŸ¥åˆ·é¢˜æ•°
    current_count = get_user_quiz_count(user_id)
    limit_count = get_quiz_limit_count()
    
    if current_count >= limit_count:
        message = f"å·²è¾¾åˆ°åˆ·é¢˜é™åˆ¶ï¼ˆ{limit_count}é¢˜ï¼‰ï¼Œè¯·ä»˜è´¹æˆ–è”ç³»ç®¡ç†å‘˜"
        return True, message
    
    return False, ""


def increment_user_quiz_count(user_id: int) -> None:
    """
    å¢åŠ ç”¨æˆ·åˆ·é¢˜æ•°
    
    Args:
        user_id: ç”¨æˆ·ID
    """
    conn = get_db()
    
    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç»Ÿè®¡è®°å½•
    existing = conn.execute(
        'SELECT id FROM user_quiz_stats WHERE user_id = ?',
        (user_id,)
    ).fetchone()
    
    if existing:
        # æ›´æ–°ç°æœ‰è®°å½•
        conn.execute(
            '''UPDATE user_quiz_stats 
               SET total_answered = total_answered + 1,
                   updated_at = CURRENT_TIMESTAMP
               WHERE user_id = ?''',
            (user_id,)
        )
    else:
        # åˆ›å»ºæ–°è®°å½•
        conn.execute(
            '''INSERT INTO user_quiz_stats (user_id, total_answered)
               VALUES (?, 1)''',
            (user_id,)
        )
    
    conn.commit()


def reset_user_quiz_count(user_id: int) -> None:
    """
    é‡ç½®ç”¨æˆ·åˆ·é¢˜æ•°
    
    Args:
        user_id: ç”¨æˆ·ID
    """
    conn = get_db()
    
    existing = conn.execute(
        'SELECT id FROM user_quiz_stats WHERE user_id = ?',
        (user_id,)
    ).fetchone()
    
    if existing:
        conn.execute(
            '''UPDATE user_quiz_stats 
               SET total_answered = 0,
                   last_reset_at = CURRENT_TIMESTAMP,
                   updated_at = CURRENT_TIMESTAMP
               WHERE user_id = ?''',
            (user_id,)
        )
    else:
        conn.execute(
            '''INSERT INTO user_quiz_stats (user_id, total_answered, last_reset_at)
               VALUES (?, 0, CURRENT_TIMESTAMP)''',
            (user_id,)
        )
    
    conn.commit()
```

---

## ğŸ”§ ä¿®æ”¹ç°æœ‰ä»£ç 

### 1. ä¿®æ”¹ `app/core/models/question.py`

**ä¿®æ”¹ `get_list()` æ–¹æ³•**ï¼š

```python
@staticmethod
def get_list(subject='all', q_type='all', mode='quiz', user_id=None):
    """è·å–é¢˜ç›®åˆ—è¡¨ï¼ˆæ·»åŠ æƒé™è¿‡æ»¤ï¼‰"""
    from app.core.utils.subject_permissions import filter_subjects_by_permission
    
    conn = get_db()
    uid = user_id or -1
    
    sql = """
        SELECT q.*, s.name as subject,
               CASE WHEN f.id IS NOT NULL THEN 1 ELSE 0 END as is_fav,
               CASE WHEN m.id IS NOT NULL THEN 1 ELSE 0 END as is_mistake
        FROM questions q
        LEFT JOIN subjects s ON q.subject_id = s.id
        LEFT JOIN favorites f ON q.id = f.question_id AND f.user_id = ?
        LEFT JOIN mistakes m ON q.id = m.question_id AND m.user_id = ?
        WHERE 1=1
    """
    params = [uid, uid]
    
    # ç§‘ç›®ç­›é€‰
    if subject != 'all':
        sql += " AND s.name = ?"
        params.append(subject)
    
    # é¢˜å‹ç­›é€‰
    if q_type != 'all':
        sql += " AND q.q_type = ?"
        params.append(q_type)
    
    # æ¨¡å¼ç­›é€‰
    if mode == 'favorites':
        sql += " AND f.id IS NOT NULL"
    elif mode == 'mistakes':
        sql += " AND m.id IS NOT NULL"
    
    sql += " ORDER BY q.id"
    
    rows = conn.execute(sql, params).fetchall()
    
    questions = []
    for row in rows:
        q = dict(row)
        
        # æƒé™æ£€æŸ¥ï¼šå¦‚æœç”¨æˆ·è¢«é™åˆ¶è®¿é—®è¯¥ç§‘ç›®ï¼Œè·³è¿‡
        if user_id and q.get('subject_id'):
            from app.core.utils.subject_permissions import can_user_access_subject
            if not can_user_access_subject(user_id, q['subject_id']):
                continue
        
        if q.get('options'):
            try:
                q['options'] = json.loads(q['options'])
            except:
                q['options'] = []
        questions.append(q)
    
    return questions
```

**ä¿®æ”¹ `get_count()` æ–¹æ³•**ï¼š

```python
@staticmethod
def get_count(subject='all', q_type='all', mode='quiz', user_id=None):
    """è·å–é¢˜ç›®æ•°é‡ï¼ˆæ·»åŠ æƒé™è¿‡æ»¤ï¼‰"""
    from app.core.utils.subject_permissions import filter_subjects_by_permission
    
    conn = get_db()
    uid = user_id or -1
    
    # è·å–ç”¨æˆ·å¯è®¿é—®çš„ç§‘ç›®ID
    if user_id:
        accessible_subject_ids = get_user_accessible_subjects(user_id)
        if not accessible_subject_ids:
            return 0
    else:
        accessible_subject_ids = None
    
    if mode == 'favorites':
        base_sql = """FROM questions q 
                      LEFT JOIN subjects s ON q.subject_id = s.id 
                      JOIN favorites f ON f.question_id = q.id AND f.user_id = ? 
                      WHERE 1=1"""
        params = [uid]
    elif mode == 'mistakes':
        base_sql = """FROM questions q 
                      LEFT JOIN subjects s ON q.subject_id = s.id 
                      JOIN mistakes m ON m.question_id = q.id AND m.user_id = ? 
                      WHERE 1=1"""
        params = [uid]
    else:
        base_sql = "FROM questions q LEFT JOIN subjects s ON q.subject_id = s.id WHERE 1=1"
        params = []
    
    if subject != 'all':
        base_sql += " AND s.name = ?"
        params.append(subject)
    
    if q_type != 'all':
        base_sql += " AND q.q_type = ?"
        params.append(q_type)
    
    # æƒé™è¿‡æ»¤ï¼šåªç»Ÿè®¡å¯è®¿é—®ç§‘ç›®çš„é¢˜ç›®
    if accessible_subject_ids is not None:
        placeholders = ','.join(['?'] * len(accessible_subject_ids))
        base_sql += f" AND q.subject_id IN ({placeholders})"
        params.extend(accessible_subject_ids)
    
    sql = "SELECT COUNT(1) " + base_sql
    return conn.execute(sql, params).fetchone()[0]
```

**ä¿®æ”¹ `get_subjects()` æ–¹æ³•**ï¼š

```python
@staticmethod
def get_subjects(user_id=None):
    """è·å–æ‰€æœ‰ç§‘ç›®ï¼ˆæ·»åŠ æƒé™è¿‡æ»¤ï¼‰"""
    from app.core.utils.subject_permissions import get_user_accessible_subjects
    
    conn = get_db()
    
    if user_id:
        # è¿”å›ç”¨æˆ·å¯è®¿é—®çš„ç§‘ç›®
        accessible_subject_ids = get_user_accessible_subjects(user_id)
        if not accessible_subject_ids:
            return []
        
        placeholders = ','.join(['?'] * len(accessible_subject_ids))
        rows = conn.execute(
            f'SELECT name FROM subjects WHERE id IN ({placeholders})',
            accessible_subject_ids
        ).fetchall()
    else:
        # æœªç™»å½•ç”¨æˆ·ï¼šè¿”å›ç©ºåˆ—è¡¨
        rows = []
    
    return [row[0] for row in rows]
```

### 2. ä¿®æ”¹ `app/modules/quiz/routes/api.py`

**ä¿®æ”¹ `api_subjects()` æ¥å£**ï¼š

```python
@quiz_api_bp.route('/subjects', methods=['GET'])
@limiter.exempt
def api_subjects():
    """è·å–ç§‘ç›®åˆ—è¡¨ï¼ˆæ·»åŠ æƒé™è¿‡æ»¤ï¼‰"""
    from app.core.utils.subject_permissions import get_user_accessible_subjects
    
    try:
        user_id = session.get('user_id')
        conn = get_db()
        
        if user_id:
            # è·å–ç”¨æˆ·å¯è®¿é—®çš„ç§‘ç›®
            accessible_subject_ids = get_user_accessible_subjects(user_id)
            if not accessible_subject_ids:
                return jsonify({'status': 'success', 'subjects': []})
            
            placeholders = ','.join(['?'] * len(accessible_subject_ids))
            rows = conn.execute(
                f'''SELECT DISTINCT s.id, s.name 
                    FROM subjects s 
                    WHERE s.id IN ({placeholders})
                    ORDER BY s.id''',
                accessible_subject_ids
            ).fetchall()
        else:
            # æœªç™»å½•ç”¨æˆ·ï¼šè¿”å›ç©ºåˆ—è¡¨
            rows = []
        
        subjects = [{'id': row['id'], 'name': row['name']} for row in rows]
        
        return jsonify({'status': 'success', 'subjects': subjects})
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e), 'subjects': []}), 500
```

**ä¿®æ”¹ `record_result()` æ¥å£**ï¼ˆæ·»åŠ åˆ·é¢˜é™åˆ¶æ£€æŸ¥ï¼‰ï¼š

```python
@quiz_api_bp.route('/record_result', methods=['POST'])
@limiter.exempt
def record_result():
    """è®°å½•åšé¢˜ç»“æœï¼ˆæ·»åŠ åˆ·é¢˜é™åˆ¶æ£€æŸ¥ï¼‰"""
    from app.core.utils.subject_permissions import (
        check_quiz_limit, 
        increment_user_quiz_count
    )
    
    if not session.get('user_id'):
        return jsonify({'status': 'unauthorized', 'message': 'è¯·å…ˆç™»å½•'}), 401
    
    data = request.json
    q_id = data.get('question_id')
    is_correct = data.get('is_correct')
    uid = session.get('user_id')
    
    if not q_id or is_correct is None:
        return jsonify({'status': 'error', 'message': 'å‚æ•°ä¸å®Œæ•´'}), 400
    
    # æ£€æŸ¥åˆ·é¢˜é™åˆ¶
    is_limited, limit_message = check_quiz_limit(uid)
    if is_limited:
        return jsonify({
            'status': 'error',
            'message': limit_message,
            'code': 'QUIZ_LIMIT_REACHED',
            'data': {
                'current_count': get_user_quiz_count(uid),
                'limit_count': get_quiz_limit_count(),
                'contact_admin_url': '/contact_admin'
            }
        }), 403
    
    conn = get_db()
    try:
        # æ›´æ–°é”™é¢˜æœ¬
        if not is_correct:
            conn.execute(
                "INSERT INTO mistakes (user_id, question_id, wrong_count) VALUES (?, ?, 1) ON CONFLICT(user_id, question_id) DO UPDATE SET wrong_count = wrong_count + 1",
                (uid, q_id)
            )
            action = "added_mistake"
        else:
            conn.execute("DELETE FROM mistakes WHERE user_id = ? AND question_id = ?", (uid, q_id))
            action = "removed_mistake"
        
        # è®°å½•ç­”é¢˜å†å²
        conn.execute(
            'DELETE FROM user_answers WHERE user_id = ? AND question_id = ?',
            (uid, q_id)
        )
        conn.execute(
            """INSERT INTO user_answers 
               (user_id, question_id, is_correct, created_at) 
               VALUES (?, ?, ?, CURRENT_TIMESTAMP)""",
            (uid, q_id, 1 if is_correct else 0)
        )
        
        # å¢åŠ åˆ·é¢˜æ•°ï¼ˆå¦‚æœåŠŸèƒ½å¼€å¯ï¼‰
        increment_user_quiz_count(uid)
        
        conn.commit()
        return jsonify({"status": "success", "action": action})
    except Exception as e:
        conn.rollback()
        return jsonify({"status": "error", "msg": str(e)}), 500
```

### 3. ä¿®æ”¹ `app/modules/main/routes/pages.py`

**ä¿®æ”¹æœç´¢é¡µé¢**ï¼ˆç¡®ä¿ç§‘ç›®ç­›é€‰å™¨åªæ˜¾ç¤ºæœ‰æƒé™çš„ç§‘ç›®ï¼‰ï¼š

```python
# åœ¨æœç´¢é¡µé¢è·¯ç”±ä¸­
from app.core.utils.subject_permissions import get_user_accessible_subjects

user_id = session.get('user_id')
if user_id:
    accessible_subject_ids = get_user_accessible_subjects(user_id)
    # åªæ˜¾ç¤ºå¯è®¿é—®çš„ç§‘ç›®
```

### 4. ä¿®æ”¹ `app/modules/exam/routes/api.py`

**ä¿®æ”¹åˆ›å»ºè€ƒè¯•æ¥å£**ï¼ˆç¡®ä¿ç§‘ç›®é€‰æ‹©åªæ˜¾ç¤ºæœ‰æƒé™çš„ç§‘ç›®ï¼‰ï¼š

```python
# åœ¨åˆ›å»ºè€ƒè¯•APIä¸­
from app.core.utils.subject_permissions import can_user_access_subject

# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®é€‰æ‹©çš„ç§‘ç›®
if not can_user_access_subject(user_id, subject_id):
    return jsonify({
        'status': 'error',
        'message': 'æ‚¨æ²¡æœ‰æƒé™è®¿é—®è¯¥ç§‘ç›®'
    }), 403
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### 1. å•å…ƒæµ‹è¯•

**ä½ç½®**ï¼š`tests/test_subject_permissions.py`ï¼ˆæ–°å»ºæµ‹è¯•æ–‡ä»¶ï¼‰

```python
# -*- coding: utf-8 -*-
"""
ç§‘ç›®æƒé™æ£€æŸ¥å·¥å…·å‡½æ•°æµ‹è¯•
"""
import pytest
from app.core.utils.subject_permissions import (
    get_user_restricted_subjects,
    can_user_access_subject,
    get_user_accessible_subjects,
    is_quiz_limit_enabled,
    get_quiz_limit_count,
    check_quiz_limit,
    increment_user_quiz_count
)


def test_get_user_restricted_subjects():
    """æµ‹è¯•è·å–ç”¨æˆ·è¢«é™åˆ¶çš„ç§‘ç›®"""
    # æµ‹è¯•ç®¡ç†å‘˜ï¼ˆåº”è¿”å›ç©ºåˆ—è¡¨ï¼‰
    # æµ‹è¯•æ™®é€šç”¨æˆ·ï¼ˆåº”è¿”å›è¢«é™åˆ¶çš„ç§‘ç›®IDåˆ—è¡¨ï¼‰
    pass


def test_can_user_access_subject():
    """æµ‹è¯•ç”¨æˆ·æ˜¯å¦å¯ä»¥è®¿é—®æŒ‡å®šç§‘ç›®"""
    # æµ‹è¯•ç®¡ç†å‘˜ï¼ˆåº”è¿”å›Trueï¼‰
    # æµ‹è¯•æ™®é€šç”¨æˆ·è®¿é—®æœªé™åˆ¶ç§‘ç›®ï¼ˆåº”è¿”å›Trueï¼‰
    # æµ‹è¯•æ™®é€šç”¨æˆ·è®¿é—®è¢«é™åˆ¶ç§‘ç›®ï¼ˆåº”è¿”å›Falseï¼‰
    pass


def test_get_user_accessible_subjects():
    """æµ‹è¯•è·å–ç”¨æˆ·å¯è®¿é—®çš„ç§‘ç›®åˆ—è¡¨"""
    # æµ‹è¯•ç®¡ç†å‘˜ï¼ˆåº”è¿”å›æ‰€æœ‰ç§‘ç›®ï¼‰
    # æµ‹è¯•æ™®é€šç”¨æˆ·ï¼ˆåº”è¿”å›æ‰€æœ‰ç§‘ç›®å‡å»è¢«é™åˆ¶çš„ç§‘ç›®ï¼‰
    pass


def test_quiz_limit_functions():
    """æµ‹è¯•åˆ·é¢˜é™åˆ¶ç›¸å…³å‡½æ•°"""
    # æµ‹è¯•åŠŸèƒ½å¼€å…³
    # æµ‹è¯•é™åˆ¶æ•°é‡è·å–
    # æµ‹è¯•åˆ·é¢˜æ•°æ£€æŸ¥
    # æµ‹è¯•åˆ·é¢˜æ•°å¢åŠ 
    pass
```

### 2. é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š

1. **æƒé™è¿‡æ»¤æµ‹è¯•**ï¼š
   - ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰ç§‘ç›®
   - æ™®é€šç”¨æˆ·é»˜è®¤å¯ä»¥è®¿é—®æ‰€æœ‰ç§‘ç›®
   - é™åˆ¶ç”¨æˆ·è®¿é—®æŸç§‘ç›®åï¼Œè¯¥ç”¨æˆ·æ— æ³•è®¿é—®è¯¥ç§‘ç›®

2. **åˆ·é¢˜é™åˆ¶æµ‹è¯•**ï¼š
   - åŠŸèƒ½å…³é—­æ—¶ï¼Œä¸é™åˆ¶ç”¨æˆ·ç­”é¢˜
   - åŠŸèƒ½å¼€å¯æ—¶ï¼Œè¾¾åˆ°é™åˆ¶åæ— æ³•ç»§ç»­ç­”é¢˜
   - ç®¡ç†å‘˜ä¸å—é™åˆ¶

3. **æ•°æ®ä¸€è‡´æ€§æµ‹è¯•**ï¼š
   - åˆ é™¤ç”¨æˆ·æ—¶ï¼Œè‡ªåŠ¨æ¸…ç† `user_subjects` å’Œ `user_quiz_stats` è®°å½•
   - åˆ é™¤ç§‘ç›®æ—¶ï¼Œè‡ªåŠ¨æ¸…ç† `user_subjects` è®°å½•

---

## ğŸ“ å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šæ•°æ®åº“è¡¨åˆ›å»º

1. ä¿®æ”¹ `app/core/utils/database.py`
2. åœ¨ `_create_tables()` å‡½æ•°ä¸­æ·»åŠ ä¸‰ä¸ªæ–°è¡¨çš„åˆ›å»ºè¯­å¥
3. æ·»åŠ ç´¢å¼•åˆ›å»ºè¯­å¥
4. æ·»åŠ ç³»ç»Ÿé…ç½®åˆå§‹åŒ–é€»è¾‘

### æ­¥éª¤2ï¼šåˆ›å»ºå·¥å…·å‡½æ•°æ¨¡å—

1. åˆ›å»º `app/core/utils/subject_permissions.py`
2. å®ç°æƒé™æ£€æŸ¥å‡½æ•°
3. å®ç°åˆ·é¢˜é™åˆ¶æ£€æŸ¥å‡½æ•°
4. æ·»åŠ ç±»å‹æç¤ºå’Œæ–‡æ¡£å­—ç¬¦ä¸²

### æ­¥éª¤3ï¼šä¿®æ”¹ç°æœ‰ä»£ç 

1. ä¿®æ”¹ `app/core/models/question.py`
2. ä¿®æ”¹ `app/modules/quiz/routes/api.py`
3. ä¿®æ”¹ `app/modules/main/routes/pages.py`
4. ä¿®æ”¹ `app/modules/exam/routes/api.py`

### æ­¥éª¤4ï¼šæµ‹è¯•

1. è¿è¡Œæ•°æ®åº“è¿ç§»ï¼Œç¡®ä¿è¡¨åˆ›å»ºæˆåŠŸ
2. ç¼–å†™å¹¶è¿è¡Œå•å…ƒæµ‹è¯•
3. æ‰‹åŠ¨æµ‹è¯•æƒé™è¿‡æ»¤åŠŸèƒ½
4. æ‰‹åŠ¨æµ‹è¯•åˆ·é¢˜é™åˆ¶åŠŸèƒ½

---

## âœ… éªŒæ”¶æ ‡å‡†

1. âœ… ä¸‰ä¸ªæ•°æ®è¡¨æˆåŠŸåˆ›å»ºï¼ŒåŒ…å«æ‰€æœ‰å­—æ®µå’Œç´¢å¼•
2. âœ… ç³»ç»Ÿé…ç½®è¡¨åˆå§‹åŒ–æˆåŠŸï¼ŒåŒ…å«é»˜è®¤é…ç½®
3. âœ… æƒé™æ£€æŸ¥å‡½æ•°æ­£å¸¸å·¥ä½œï¼ˆé»‘åå•æ¨¡å¼ï¼‰
4. âœ… åˆ·é¢˜é™åˆ¶æ£€æŸ¥å‡½æ•°æ­£å¸¸å·¥ä½œ
5. âœ… å‰å°ç§‘ç›®/é¢˜ç›®æŸ¥è¯¢æ­£ç¡®è¿‡æ»¤æ— æƒé™ç§‘ç›®
6. âœ… ç­”é¢˜è®°å½•APIæ­£ç¡®æ£€æŸ¥åˆ·é¢˜é™åˆ¶
7. âœ… æ‰€æœ‰å‡½æ•°æœ‰å®Œæ•´çš„ç±»å‹æç¤ºå’Œæ–‡æ¡£å­—ç¬¦ä¸²
8. âœ… å•å…ƒæµ‹è¯•é€šè¿‡ç‡ 100%

---

## ğŸ“š ç›¸å…³æ–‡ä»¶æ¸…å•

### éœ€è¦åˆ›å»ºçš„æ–‡ä»¶

1. `app/core/utils/subject_permissions.py` - æƒé™æ£€æŸ¥å·¥å…·å‡½æ•°

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

1. `app/core/utils/database.py` - æ·»åŠ æ•°æ®è¡¨åˆ›å»ºé€»è¾‘
2. `app/core/models/question.py` - æ·»åŠ æƒé™è¿‡æ»¤
3. `app/modules/quiz/routes/api.py` - ä¿®æ”¹ç§‘ç›®åˆ—è¡¨APIå’Œç­”é¢˜è®°å½•API
4. `app/modules/main/routes/pages.py` - ä¿®æ”¹æœç´¢é¡µé¢
5. `app/modules/exam/routes/api.py` - ä¿®æ”¹è€ƒè¯•åˆ›å»ºAPI

### å¯é€‰æ–‡ä»¶

1. `tests/test_subject_permissions.py` - å•å…ƒæµ‹è¯•æ–‡ä»¶

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**ï¼šç¡®ä¿ç°æœ‰åŠŸèƒ½ä¸å—å½±å“ï¼Œæ–°åŠŸèƒ½é»˜è®¤å…³é—­ï¼ˆåˆ·é¢˜é™åˆ¶ï¼‰
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šæƒé™æ£€æŸ¥ä½¿ç”¨ç´¢å¼•ï¼Œé¿å…å…¨è¡¨æ‰«æ
3. **é”™è¯¯å¤„ç†**ï¼šæ‰€æœ‰å‡½æ•°éƒ½è¦æœ‰é€‚å½“çš„å¼‚å¸¸å¤„ç†
4. **ç±»å‹å®‰å…¨**ï¼šæ‰€æœ‰å‡½æ•°ä½¿ç”¨ç±»å‹æç¤º
5. **ä»£ç è§„èŒƒ**ï¼šéµå¾ª PEP 8ï¼Œä½¿ç”¨ä¸­æ–‡æ³¨é‡Š

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-29  
**é€‚ç”¨é˜¶æ®µ**ï¼šç¬¬ä¸€é˜¶æ®µï¼ˆæ•°æ®åº“å’Œæ ¸å¿ƒåŠŸèƒ½ï¼‰
