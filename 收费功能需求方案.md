# æ”¶è´¹åŠŸèƒ½éœ€æ±‚æ–‡æ¡£ï¼ˆæ··åˆæ¨¡å¼ï¼‰

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†åŸºäº**æ··åˆæ¨¡å¼**çš„æ”¶è´¹åŠŸèƒ½å®ç°æ–¹æ¡ˆã€‚è¯¥æ–¹æ¡ˆç»“åˆä¼šå‘˜è®¢é˜…åˆ¶å’ŒæŒ‰é‡ä»˜è´¹ï¼Œæä¾›å¤šç§ä»˜è´¹é€‰æ‹©ï¼Œæœ€å¤§åŒ–æ»¡è¶³ä¸åŒç”¨æˆ·éœ€æ±‚ã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- âœ… æ”¯æŒä¼šå‘˜è®¢é˜…ï¼ˆç®¡ç†å‘˜å¯è‡ªå®šä¹‰å¥—é¤ï¼‰
- âœ… **ç®¡ç†å‘˜å¯å®šåˆ¶ä¼šå‘˜æƒç›Šå’Œä»·æ ¼**ï¼ˆæ–°å¢ï¼‰
- âœ… æ”¯æŒæŒ‰é‡ä»˜è´¹ï¼ˆé¢å¤–è€ƒè¯•æ¬¡æ•°ã€ç¼–ç¨‹é¢˜ç­‰ï¼‰
- âœ… æ”¯æŒé¢˜é›†è´­ä¹°ï¼ˆå•ç§‘ç›®é¢˜é›†/ä¸“é¢˜é¢˜é›†ï¼‰
- âœ… **åå°å¯æ§åˆ¶æ”¶è´¹åŠŸèƒ½å¼€å¯/å…³é—­**
- âœ… å…³é—­æ”¶è´¹æ—¶ï¼Œç³»ç»Ÿä¿æŒåŸæœ‰å…è´¹ä½¿ç”¨è¡Œä¸º
- âœ… æ”¯ä»˜æ–¹å¼ï¼šå¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®

---

## ğŸ¯ åŠŸèƒ½æ¦‚è§ˆ

### æ”¶è´¹æ¨¡å¼ç»„åˆ

#### 1. å…è´¹ç”¨æˆ·ï¼ˆFreeï¼‰
- âœ… æ¯æ—¥ 10 é¢˜ï¼ˆæ— è§£æï¼‰
- âœ… æ¯æœˆ 1 æ¬¡è€ƒè¯•ï¼ˆé™æ—¶ 30 åˆ†é’Ÿï¼‰
- âœ… åŸºç¡€åŠŸèƒ½ä½“éªŒ
- âŒ æŸ¥çœ‹é¢˜ç›®è§£æ
- âŒ ç¼–ç¨‹é¢˜ç»ƒä¹ 
- âŒ ç«™å†…èŠå¤©
- âŒ æ•°æ®å¯¼å‡º

#### 2. åŸºç¡€ä¼šå‘˜ï¼ˆBasicï¼‰- Â¥29/æœˆ æˆ– Â¥299/å¹´ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
- âœ… æ— é™åˆ·é¢˜ + è§£æ
- âœ… æ¯æœˆ 10 æ¬¡è€ƒè¯•ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
- âœ… é”™é¢˜æœ¬ + æ”¶è—ï¼ˆæ— é™ï¼‰
- âœ… å†å²è®°å½•ï¼ˆä¿å­˜ 30 å¤©ï¼‰
- âŒ ç¼–ç¨‹é¢˜ç»ƒä¹ 
- âŒ ç«™å†…èŠå¤©
- âŒ é«˜çº§è€ƒè¯•åŠŸèƒ½

#### 3. é«˜çº§ä¼šå‘˜ï¼ˆPremiumï¼‰- Â¥59/æœˆ æˆ– Â¥599/å¹´ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
- âœ… åŸºç¡€ä¼šå‘˜æ‰€æœ‰åŠŸèƒ½
- âœ… æ— é™è€ƒè¯•ï¼ˆæ— æ¬¡æ•°é™åˆ¶ï¼‰
- âœ… ç¼–ç¨‹é¢˜ç»ƒä¹ ï¼ˆæ¯æœˆ 20 æ¬¡ï¼Œå¯è‡ªå®šä¹‰ï¼‰
- âœ… ç«™å†…èŠå¤©
- âœ… æ•°æ®ç»Ÿè®¡å’Œåˆ†ææŠ¥å‘Š
- âœ… æ•°æ®å¯¼å‡ºåŠŸèƒ½

> **æ³¨æ„**ï¼šä»¥ä¸Šä¸ºé»˜è®¤å¥—é¤ç¤ºä¾‹ï¼Œç®¡ç†å‘˜å¯ä»¥åœ¨åå°è‡ªå®šä¹‰åˆ›å»ºã€ç¼–è¾‘ä¼šå‘˜å¥—é¤ï¼ŒåŒ…æ‹¬å¥—é¤åç§°ã€ä»·æ ¼ã€æƒç›Šåˆ—è¡¨å’Œä½¿ç”¨é™åˆ¶ã€‚

#### 4. æŒ‰é‡è¡¥å……
- **é¢å¤–è€ƒè¯•æ¬¡æ•°**ï¼šÂ¥2.9/æ¬¡ï¼ˆåŸºç¡€ä¼šå‘˜å¯è´­ä¹°ï¼‰
- **é¢å¤–ç¼–ç¨‹é¢˜**ï¼šÂ¥1.9/é¢˜ï¼ˆé«˜çº§ä¼šå‘˜å¯è´­ä¹°ï¼‰
- **æ•°æ®å¯¼å‡º**ï¼šÂ¥9.9/æ¬¡ï¼ˆæ‰€æœ‰ç”¨æˆ·å¯è´­ä¹°ï¼‰

#### 5. é¢˜é›†è´­ä¹°
- **å•ç§‘ç›®é¢˜é›†**ï¼šÂ¥29.9/ç§‘ç›®ï¼ˆåŒ…å«è¯¥ç§‘ç›®æ‰€æœ‰é¢˜ç›®ï¼‰
- **ä¸“é¢˜é¢˜é›†**ï¼šÂ¥19.9/ä¸“é¢˜ï¼ˆå¦‚ï¼šç®—æ³•ä¸“é¢˜ã€æ•°æ®ç»“æ„ä¸“é¢˜ï¼‰
- **è€ƒè¯•çœŸé¢˜é›†**ï¼šÂ¥39.9/å¥—ï¼ˆå†å¹´è€ƒè¯•çœŸé¢˜ï¼‰
- **ç¼–ç¨‹é¢˜é›†**ï¼šÂ¥49.9/å¥—ï¼ˆ50 é“ç¼–ç¨‹é¢˜ï¼‰
- **ä¼šå‘˜ç”¨æˆ·äº«å— 8 æŠ˜ä¼˜æƒ **ï¼ˆåŸºç¡€ä¼šå‘˜å’Œé«˜çº§ä¼šå‘˜ï¼‰

---

## âš™ï¸ ç³»ç»Ÿé…ç½®ç®¡ç†

### æ ¸å¿ƒåŠŸèƒ½

ç³»ç»Ÿæ”¯æŒåœ¨åå°ç®¡ç†ä¸­**å¼€å¯æˆ–å…³é—­æ”¶è´¹åŠŸèƒ½**ï¼š

- **å¼€å¯æ”¶è´¹**ï¼šå¯ç”¨æ‰€æœ‰æ”¶è´¹é€»è¾‘ï¼Œç”¨æˆ·éœ€è¦ä»˜è´¹æ‰èƒ½ä½¿ç”¨é«˜çº§åŠŸèƒ½
- **å…³é—­æ”¶è´¹**ï¼šç³»ç»Ÿä¿æŒåŸæœ‰è¡Œä¸ºï¼Œæ‰€æœ‰åŠŸèƒ½å…è´¹ä½¿ç”¨ï¼Œä¸è¿›è¡Œä»»ä½•æ”¶è´¹æ£€æŸ¥

### é…ç½®é¡¹è®¾è®¡

```sql
-- ç³»ç»Ÿé…ç½®è¡¨
CREATE TABLE system_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_key TEXT UNIQUE NOT NULL,
    config_value TEXT NOT NULL,
    config_type TEXT DEFAULT 'string',  -- 'string', 'boolean', 'number', 'json'
    description TEXT,
    updated_by INTEGER,  -- æœ€åæ›´æ–°äººï¼ˆç®¡ç†å‘˜IDï¼‰
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (updated_by) REFERENCES users(id)
);

-- åˆå§‹åŒ–é…ç½®æ•°æ®
INSERT INTO system_config (config_key, config_value, config_type, description) VALUES
('payment_enabled', 'false', 'boolean', 'æ˜¯å¦å¯ç”¨æ”¶è´¹åŠŸèƒ½'),
('free_daily_quiz_limit', '10', 'number', 'å…è´¹ç”¨æˆ·æ¯æ—¥åˆ·é¢˜é™åˆ¶'),
('free_monthly_exam_limit', '1', 'number', 'å…è´¹ç”¨æˆ·æ¯æœˆè€ƒè¯•é™åˆ¶'),
('basic_monthly_exam_limit', '10', 'number', 'åŸºç¡€ä¼šå‘˜æ¯æœˆè€ƒè¯•é™åˆ¶'),
('premium_monthly_coding_limit', '20', 'number', 'é«˜çº§ä¼šå‘˜æ¯æœˆç¼–ç¨‹é¢˜é™åˆ¶');
```

### é…ç½®ç®¡ç†æ¥å£

#### åå°ç®¡ç†é¡µé¢
- **è·¯å¾„**ï¼š`/admin/settings` æˆ– `/admin/payment`
- **åŠŸèƒ½**ï¼š
  - æ˜¾ç¤ºå½“å‰æ”¶è´¹åŠŸèƒ½çŠ¶æ€ï¼ˆå¼€å¯/å…³é—­ï¼‰
  - æä¾›å¼€å…³åˆ‡æ¢æŒ‰é’®
  - æ˜¾ç¤ºç›¸å…³é…ç½®é¡¹ï¼ˆå¦‚å…è´¹ç”¨æˆ·é™åˆ¶ç­‰ï¼‰
  - è®°å½•æ“ä½œæ—¥å¿—

#### API æ¥å£

```python
# GET /admin/api/settings/payment
# è·å–æ”¶è´¹åŠŸèƒ½é…ç½®
{
    "status": "success",
    "data": {
        "payment_enabled": false,
        "free_daily_quiz_limit": 10,
        "free_monthly_exam_limit": 1,
        "basic_monthly_exam_limit": 10,
        "premium_monthly_coding_limit": 20
    }
}

# POST /admin/api/settings/payment
# æ›´æ–°æ”¶è´¹åŠŸèƒ½é…ç½®
{
    "payment_enabled": true,
    "free_daily_quiz_limit": 10,
    "free_monthly_exam_limit": 1,
    "basic_monthly_exam_limit": 10,
    "premium_monthly_coding_limit": 20
}
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

#### 1. ç³»ç»Ÿé…ç½®è¡¨ï¼ˆsystem_configï¼‰
```sql
CREATE TABLE system_config (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_key TEXT UNIQUE NOT NULL,
    config_value TEXT NOT NULL,
    config_type TEXT DEFAULT 'string',
    description TEXT,
    updated_by INTEGER,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (updated_by) REFERENCES users(id)
);
```

#### 2. ä¼šå‘˜å¥—é¤è¡¨ï¼ˆmembership_plansï¼‰
```sql
CREATE TABLE membership_plans (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,  -- å¥—é¤åç§°ï¼Œå¦‚"åŸºç¡€ä¼šå‘˜"ã€"é«˜çº§ä¼šå‘˜"
    plan_code TEXT UNIQUE NOT NULL,  -- å¥—é¤ä»£ç ï¼Œå¦‚'basic', 'premium'
    description TEXT,  -- å¥—é¤æè¿°
    monthly_price DECIMAL(10, 2) NOT NULL,  -- æœˆä»˜ä»·æ ¼
    yearly_price DECIMAL(10, 2) NOT NULL,  -- å¹´ä»˜ä»·æ ¼
    features_json TEXT NOT NULL,  -- JSONæ ¼å¼ï¼Œå­˜å‚¨æƒç›Šé…ç½®
    limits_json TEXT NOT NULL,  -- JSONæ ¼å¼ï¼Œå­˜å‚¨ä½¿ç”¨é™åˆ¶é…ç½®
    sort_order INTEGER DEFAULT 0,  -- æ’åº
    is_active BOOLEAN DEFAULT 1,  -- æ˜¯å¦å¯ç”¨
    is_default BOOLEAN DEFAULT 0,  -- æ˜¯å¦ä¸ºé»˜è®¤å¥—é¤ï¼ˆç”¨äºæ–°ç”¨æˆ·ï¼‰
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- features_json ç¤ºä¾‹ç»“æ„ï¼š
-- {
--   "unlimited_quiz": true,
--   "view_explanation": true,
--   "favorites": true,
--   "mistakes": true,
--   "history": true,
--   "coding": false,
--   "chat": false,
--   "export": false,
--   "statistics": false
-- }

-- limits_json ç¤ºä¾‹ç»“æ„ï¼š
-- {
--   "daily_quiz_limit": -1,  -- -1è¡¨ç¤ºæ— é™åˆ¶
--   "monthly_exam_limit": 10,
--   "monthly_coding_limit": 0,
--   "history_days": 30
-- }

CREATE INDEX idx_membership_plans_code ON membership_plans(plan_code);
CREATE INDEX idx_membership_plans_active ON membership_plans(is_active);
```

#### 3. ä¼šå‘˜è®¢é˜…è¡¨ï¼ˆsubscriptionsï¼‰
```sql
CREATE TABLE subscriptions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    plan_id INTEGER NOT NULL,  -- å…³è”ä¼šå‘˜å¥—é¤ID
    plan_code TEXT NOT NULL,  -- å¥—é¤ä»£ç ï¼ˆå†—ä½™å­—æ®µï¼Œä¾¿äºæŸ¥è¯¢ï¼‰
    status TEXT NOT NULL,     -- 'active', 'expired', 'cancelled'
    start_date DATETIME NOT NULL,
    end_date DATETIME,
    auto_renew BOOLEAN DEFAULT 1,
    payment_method TEXT,      -- 'alipay', 'wechat'
    payment_id TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (plan_id) REFERENCES membership_plans(id)
);

CREATE INDEX idx_subscriptions_user_status ON subscriptions(user_id, status);
CREATE INDEX idx_subscriptions_status ON subscriptions(status);
CREATE INDEX idx_subscriptions_plan ON subscriptions(plan_id);
```

#### 4. ç”¨æˆ·ä½¿ç”¨è®°å½•è¡¨ï¼ˆusage_recordsï¼‰
```sql
CREATE TABLE usage_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    feature_type TEXT NOT NULL,  -- 'quiz', 'exam', 'coding', 'chat', 'export'
    count INTEGER DEFAULT 1,
    date DATE NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    UNIQUE(user_id, feature_type, date)
);

CREATE INDEX idx_usage_records_user_date ON usage_records(user_id, date);
CREATE INDEX idx_usage_records_feature ON usage_records(feature_type, date);
```

#### 5. æ”¯ä»˜è®¢å•è¡¨ï¼ˆpayment_ordersï¼‰
```sql
CREATE TABLE payment_orders (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    order_no TEXT UNIQUE NOT NULL,
    order_type TEXT NOT NULL,  -- 'subscription', 'addon', 'question_set'
    plan_type TEXT,  -- ä¼šå‘˜ç±»å‹æˆ–è´­ä¹°ç±»å‹
    amount DECIMAL(10, 2) NOT NULL,
    currency TEXT DEFAULT 'CNY',
    payment_method TEXT NOT NULL,
    payment_id TEXT,
    status TEXT NOT NULL,  -- 'pending', 'paid', 'failed', 'refunded'
    paid_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE INDEX idx_payment_orders_user ON payment_orders(user_id);
CREATE INDEX idx_payment_orders_status ON payment_orders(status);
CREATE INDEX idx_payment_orders_order_no ON payment_orders(order_no);
```

#### 6. ä¼šå‘˜é¢å¤–è´­ä¹°è®°å½•è¡¨ï¼ˆmember_addon_purchasesï¼‰
```sql
CREATE TABLE member_addon_purchases (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    subscription_id INTEGER,
    addon_type TEXT NOT NULL,  -- 'exam', 'coding', 'export'
    quantity INTEGER NOT NULL,
    used_quantity INTEGER DEFAULT 0,
    expires_at DATETIME,  -- ä¸è®¢é˜…åŒæ—¶è¿‡æœŸ
    order_id INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (subscription_id) REFERENCES subscriptions(id),
    FOREIGN KEY (order_id) REFERENCES payment_orders(id)
);

CREATE INDEX idx_addon_purchases_user ON member_addon_purchases(user_id);
```

#### 7. é¢˜é›†è¡¨ï¼ˆquestion_setsï¼‰
```sql
CREATE TABLE question_sets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    set_type TEXT NOT NULL,  -- 'subject', 'topic', 'exam_paper', 'coding'
    subject_id INTEGER,  -- ç§‘ç›®IDï¼ˆå•ç§‘ç›®é¢˜é›†ä½¿ç”¨ï¼‰
    price DECIMAL(10, 2) NOT NULL,
    original_price DECIMAL(10, 2),  -- åŸä»·ï¼ˆç”¨äºæ˜¾ç¤ºæŠ˜æ‰£ï¼‰
    is_free BOOLEAN DEFAULT 0,
    question_count INTEGER DEFAULT 0,
    cover_image TEXT,
    sort_order INTEGER DEFAULT 0,
    status TEXT DEFAULT 'active',  -- 'active', 'inactive'
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (subject_id) REFERENCES subjects(id)
);

CREATE INDEX idx_question_sets_type ON question_sets(set_type);
CREATE INDEX idx_question_sets_status ON question_sets(status);
```

#### 8. é¢˜é›†-é¢˜ç›®å…³è”è¡¨ï¼ˆquestion_set_itemsï¼‰
```sql
CREATE TABLE question_set_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    set_id INTEGER NOT NULL,
    question_id INTEGER NOT NULL,
    sort_order INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (set_id) REFERENCES question_sets(id),
    FOREIGN KEY (question_id) REFERENCES questions(id),
    UNIQUE(set_id, question_id)
);

CREATE INDEX idx_set_items_set ON question_set_items(set_id);
CREATE INDEX idx_set_items_question ON question_set_items(question_id);
```

#### 9. ç”¨æˆ·é¢˜é›†è´­ä¹°è®°å½•è¡¨ï¼ˆuser_question_setsï¼‰
```sql
CREATE TABLE user_question_sets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    set_id INTEGER NOT NULL,
    purchase_price DECIMAL(10, 2) NOT NULL,
    discount_amount DECIMAL(10, 2) DEFAULT 0,  -- æŠ˜æ‰£é‡‘é¢
    order_id INTEGER,
    purchased_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (set_id) REFERENCES question_sets(id),
    FOREIGN KEY (order_id) REFERENCES payment_orders(id),
    UNIQUE(user_id, set_id)
);

CREATE INDEX idx_user_sets_user ON user_question_sets(user_id);
CREATE INDEX idx_user_sets_set ON user_question_sets(set_id);
```

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. ç³»ç»Ÿé…ç½®æœåŠ¡

```python
# app/core/services/config_service.py
from typing import Any, Optional
from app.core.utils.database import get_db

class ConfigService:
    """ç³»ç»Ÿé…ç½®æœåŠ¡"""
    
    @staticmethod
    def get_config(key: str, default: Any = None) -> Any:
        """è·å–é…ç½®å€¼"""
        conn = get_db()
        row = conn.execute(
            'SELECT config_value, config_type FROM system_config WHERE config_key = ?',
            (key,)
        ).fetchone()
        
        if not row:
            return default
        
        value = row['config_value']
        config_type = row['config_type']
        
        # æ ¹æ®ç±»å‹è½¬æ¢
        if config_type == 'boolean':
            return value.lower() in ('true', '1', 'yes')
        elif config_type == 'number':
            try:
                return int(value) if '.' not in value else float(value)
        elif config_type == 'json':
            import json
            return json.loads(value)
        else:
            return value
    
    @staticmethod
    def set_config(key: str, value: Any, config_type: str = 'string', 
                   updated_by: Optional[int] = None, description: Optional[str] = None):
        """è®¾ç½®é…ç½®å€¼"""
        conn = get_db()
        
        # è½¬æ¢å€¼ä¸ºå­—ç¬¦ä¸²
        if isinstance(value, bool):
            value_str = 'true' if value else 'false'
            config_type = 'boolean'
        elif isinstance(value, (int, float)):
            value_str = str(value)
            config_type = 'number'
        elif isinstance(value, (dict, list)):
            import json
            value_str = json.dumps(value, ensure_ascii=False)
            config_type = 'json'
        else:
            value_str = str(value)
        
        # æ›´æ–°æˆ–æ’å…¥
        conn.execute('''
            INSERT INTO system_config (config_key, config_value, config_type, description, updated_by)
            VALUES (?, ?, ?, ?, ?)
            ON CONFLICT(config_key) DO UPDATE SET
                config_value = excluded.config_value,
                config_type = excluded.config_type,
                description = excluded.description,
                updated_by = excluded.updated_by,
                updated_at = CURRENT_TIMESTAMP
        ''', (key, value_str, config_type, description, updated_by))
        
        conn.commit()
    
    @staticmethod
    def is_payment_enabled() -> bool:
        """æ£€æŸ¥æ”¶è´¹åŠŸèƒ½æ˜¯å¦å¯ç”¨"""
        return ConfigService.get_config('payment_enabled', False)
    
    @staticmethod
    def get_all_configs() -> dict:
        """è·å–æ‰€æœ‰é…ç½®"""
        conn = get_db()
        rows = conn.execute(
            'SELECT config_key, config_value, config_type, description FROM system_config'
        ).fetchall()
        
        configs = {}
        for row in rows:
            key = row['config_key']
            value = row['config_value']
            config_type = row['config_type']
            
            # ç±»å‹è½¬æ¢
            if config_type == 'boolean':
                value = value.lower() in ('true', '1', 'yes')
            elif config_type == 'number':
                value = int(value) if '.' not in value else float(value)
            elif config_type == 'json':
                import json
                value = json.loads(value)
            
            configs[key] = {
                'value': value,
                'type': config_type,
                'description': row['description']
            }
        
        return configs
```

### 2. æƒé™æ£€æŸ¥è£…é¥°å™¨ï¼ˆæ”¯æŒæ”¶è´¹å¼€å…³ï¼‰

```python
# app/core/utils/decorators.py æ–°å¢
from functools import wraps
from flask import session, jsonify
from app.core.services.config_service import ConfigService

def subscription_required(plan_type='basic'):
    """æ£€æŸ¥ç”¨æˆ·è®¢é˜…çŠ¶æ€ï¼ˆå¦‚æœæ”¶è´¹åŠŸèƒ½å…³é—­ï¼Œåˆ™è·³è¿‡æ£€æŸ¥ï¼‰"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            # å¦‚æœæ”¶è´¹åŠŸèƒ½æœªå¯ç”¨ï¼Œç›´æ¥é€šè¿‡
            if not ConfigService.is_payment_enabled():
                return f(*args, **kwargs)
            
            user_id = session.get('user_id')
            if not user_id:
                return jsonify({'status': 'error', 'message': 'è¯·å…ˆç™»å½•'}), 401
            
            # æ£€æŸ¥è®¢é˜…çŠ¶æ€
            from app.core.models.subscription import Subscription
            from app.core.models.membership_plan import MembershipPlan
            
            user_plan = Subscription.get_user_plan(user_id)
            
            if not user_plan:
                return jsonify({
                    'status': 'error',
                    'message': 'éœ€è¦ä¼šå‘˜æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½',
                    'upgrade_required': True
                }), 403
            
            # æ£€æŸ¥å¥—é¤ç­‰çº§ï¼ˆå¦‚æœplan_typeæ˜¯ç­‰çº§è¦æ±‚ï¼‰
            plan_hierarchy = {'free': 0, 'basic': 1, 'premium': 2}
            user_level = plan_hierarchy.get(user_plan.get('plan_code', 'free'), 0)
            required_level = plan_hierarchy.get(plan_type, 0)
            
            if user_level < required_level:
                return jsonify({
                    'status': 'error',
                    'message': f'éœ€è¦{plan_type}ä¼šå‘˜æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½',
                    'upgrade_required': True
                }), 403
            
            return f(*args, **kwargs)
        return decorated_function
    return decorator

def usage_limit_check(feature_type, daily_limit=None, monthly_limit=None):
    """æ£€æŸ¥ä½¿ç”¨é™åˆ¶ï¼ˆå¦‚æœæ”¶è´¹åŠŸèƒ½å…³é—­ï¼Œåˆ™è·³è¿‡æ£€æŸ¥ï¼‰"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            # å¦‚æœæ”¶è´¹åŠŸèƒ½æœªå¯ç”¨ï¼Œç›´æ¥é€šè¿‡
            if not ConfigService.is_payment_enabled():
                return f(*args, **kwargs)
            
            user_id = session.get('user_id')
            if not user_id:
                return f(*args, **kwargs)
            
            from app.core.models.subscription import Subscription
            from datetime import date, datetime
            
            # è·å–ç”¨æˆ·ä¼šå‘˜å¥—é¤
            plan = Subscription.get_user_plan(user_id)
            
            # å¦‚æœæ²¡æœ‰å¥—é¤ï¼Œè§†ä¸ºå…è´¹ç”¨æˆ·
            if not plan or plan.get('plan_code') == 'free':
                # å…è´¹ç”¨æˆ·é™åˆ¶
                if daily_limit:
                    today_usage = Subscription.get_today_usage(user_id, feature_type)
                    if today_usage >= daily_limit:
                        return jsonify({
                            'status': 'error',
                            'message': f'ä»Šæ—¥{feature_type}ä½¿ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼ˆ{daily_limit}æ¬¡ï¼‰ï¼Œå‡çº§ä¼šå‘˜å¯è§£é”æ— é™ä½¿ç”¨',
                            'upgrade_required': True
                        }), 403
                
                if monthly_limit:
                    month_usage = Subscription.get_month_usage(user_id, feature_type)
                    if month_usage >= monthly_limit:
                        return jsonify({
                            'status': 'error',
                            'message': f'æœ¬æœˆ{feature_type}ä½¿ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼ˆ{monthly_limit}æ¬¡ï¼‰ï¼Œå‡çº§ä¼šå‘˜å¯è§£é”æ›´å¤š',
                            'upgrade_required': True
                        }), 403
            else:
                # æœ‰å¥—é¤çš„ç”¨æˆ·ï¼Œä»å¥—é¤é…ç½®ä¸­è·å–é™åˆ¶
                from app.core.models.membership_plan import MembershipPlan
                
                # æ£€æŸ¥åŠŸèƒ½æƒé™
                if feature_type == 'coding' and not plan['features'].get('coding', False):
                    return jsonify({
                        'status': 'error',
                        'message': 'å½“å‰å¥—é¤ä¸æ”¯æŒç¼–ç¨‹é¢˜åŠŸèƒ½ï¼Œè¯·å‡çº§å¥—é¤',
                        'upgrade_required': True
                    }), 403
                
                if feature_type == 'chat' and not plan['features'].get('chat', False):
                    return jsonify({
                        'status': 'error',
                        'message': 'å½“å‰å¥—é¤ä¸æ”¯æŒç«™å†…èŠå¤©åŠŸèƒ½ï¼Œè¯·å‡çº§å¥—é¤',
                        'upgrade_required': True
                    }), 403
                
                # æ£€æŸ¥ä½¿ç”¨é™åˆ¶
                if feature_type == 'exam' and monthly_limit:
                    month_usage = Subscription.get_month_usage(user_id, feature_type)
                    exam_limit = plan['limits'].get('monthly_exam_limit', 0)
                    if exam_limit != -1 and month_usage >= exam_limit:
                        return jsonify({
                            'status': 'error',
                            'message': f'æœ¬æœˆè€ƒè¯•æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼ˆ{exam_limit}æ¬¡ï¼‰ï¼Œå¯è´­ä¹°é¢å¤–æ¬¡æ•°æˆ–å‡çº§å¥—é¤',
                            'upgrade_required': True
                        }), 403
                
                if feature_type == 'coding' and monthly_limit:
                    month_usage = Subscription.get_month_usage(user_id, feature_type)
                    coding_limit = plan['limits'].get('monthly_coding_limit', 0)
                    if coding_limit != -1 and month_usage >= coding_limit:
                        return jsonify({
                            'status': 'error',
                            'message': f'æœ¬æœˆç¼–ç¨‹é¢˜æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼ˆ{coding_limit}æ¬¡ï¼‰ï¼Œå¯è´­ä¹°é¢å¤–æ¬¡æ•°',
                            'upgrade_required': False
                        }), 403
            
            # è®°å½•ä½¿ç”¨
            Subscription.record_usage(user_id, feature_type)
            
            return f(*args, **kwargs)
        return decorated_function
    return decorator
```

### 3. è®¢é˜…æ¨¡å‹

```python
# app/core/models/subscription.py
from typing import Optional, Dict
from datetime import datetime, date, timedelta
from app.core.utils.database import get_db
from app.core.services.config_service import ConfigService

class Subscription:
    """ä¼šå‘˜è®¢é˜…æ¨¡å‹"""
    
    @staticmethod
    def get_active_subscription(user_id: int) -> Optional[Dict]:
        """è·å–ç”¨æˆ·çš„æœ‰æ•ˆè®¢é˜…"""
        conn = get_db()
        row = conn.execute('''
            SELECT * FROM subscriptions
            WHERE user_id = ? AND status = 'active'
            AND (end_date IS NULL OR end_date > datetime('now'))
            ORDER BY created_at DESC
            LIMIT 1
        ''', (user_id,)).fetchone()
        
        return dict(row) if row else None
    
    @staticmethod
    def get_user_plan(user_id: int) -> Optional[Dict]:
        """è·å–ç”¨æˆ·ä¼šå‘˜å¥—é¤ä¿¡æ¯"""
        # å¦‚æœæ”¶è´¹åŠŸèƒ½æœªå¯ç”¨ï¼Œè¿”å› Noneï¼ˆä½†å®é™…ä¸é™åˆ¶ï¼‰
        if not ConfigService.is_payment_enabled():
            return None
        
        subscription = Subscription.get_active_subscription(user_id)
        if subscription:
            from app.core.models.membership_plan import MembershipPlan
            plan = MembershipPlan.get_by_id(subscription['plan_id'])
            return plan
        return None
    
    @staticmethod
    def get_user_plan_code(user_id: int) -> str:
        """è·å–ç”¨æˆ·ä¼šå‘˜ç±»å‹ä»£ç ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰"""
        plan = Subscription.get_user_plan(user_id)
        if plan:
            return plan.get('plan_code', 'free')
        return 'free'
    
    @staticmethod
    def has_access(subscription: Dict, required_plan: str) -> bool:
        """æ£€æŸ¥è®¢é˜…æ˜¯å¦æœ‰æƒé™è®¿é—®æŸä¸ªåŠŸèƒ½"""
        plan_hierarchy = {'free': 0, 'basic': 1, 'premium': 2}
        user_plan = subscription.get('plan_type', 'free')
        user_level = plan_hierarchy.get(user_plan, 0)
        required_level = plan_hierarchy.get(required_plan, 0)
        return user_level >= required_level
    
    @staticmethod
    def get_today_usage(user_id: int, feature_type: str) -> int:
        """è·å–ä»Šæ—¥ä½¿ç”¨æ¬¡æ•°"""
        conn = get_db()
        row = conn.execute('''
            SELECT COALESCE(SUM(count), 0) as total
            FROM usage_records
            WHERE user_id = ? AND feature_type = ? AND date = date('now')
        ''', (user_id, feature_type)).fetchone()
        return row['total'] if row else 0
    
    @staticmethod
    def get_month_usage(user_id: int, feature_type: str) -> int:
        """è·å–æœ¬æœˆä½¿ç”¨æ¬¡æ•°"""
        conn = get_db()
        row = conn.execute('''
            SELECT COALESCE(SUM(count), 0) as total
            FROM usage_records
            WHERE user_id = ? AND feature_type = ?
            AND strftime('%Y-%m', date) = strftime('%Y-%m', 'now')
        ''', (user_id, feature_type)).fetchone()
        return row['total'] if row else 0
    
    @staticmethod
    def record_usage(user_id: int, feature_type: str, count: int = 1):
        """è®°å½•ä½¿ç”¨"""
        conn = get_db()
        today = date.today().isoformat()
        
        conn.execute('''
            INSERT INTO usage_records (user_id, feature_type, count, date)
            VALUES (?, ?, ?, ?)
            ON CONFLICT(user_id, feature_type, date) DO UPDATE SET
                count = count + ?
        ''', (user_id, feature_type, count, today, count))
        
        conn.commit()
```

---

## ğŸ¨ åå°ç®¡ç†ç•Œé¢

### æ”¶è´¹åŠŸèƒ½é…ç½®é¡µé¢

#### é¡µé¢è·¯å¾„
- `/admin/settings/payment` æˆ– `/admin/payment`

#### é¡µé¢åŠŸèƒ½
1. **æ”¶è´¹åŠŸèƒ½å¼€å…³**
   - å¤§å·å¼€å…³æŒ‰é’®ï¼Œæ˜¾ç¤ºå½“å‰çŠ¶æ€
   - åˆ‡æ¢æ—¶æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
   - è®°å½•æ“ä½œæ—¥å¿—

2. **é…ç½®é¡¹ç®¡ç†**
   - å…è´¹ç”¨æˆ·æ¯æ—¥åˆ·é¢˜é™åˆ¶
   - å…è´¹ç”¨æˆ·æ¯æœˆè€ƒè¯•é™åˆ¶

3. **ä¼šå‘˜å¥—é¤ç®¡ç†**ï¼ˆæ–°å¢ï¼‰
   - å¥—é¤åˆ—è¡¨å±•ç¤º
   - åˆ›å»º/ç¼–è¾‘/åˆ é™¤å¥—é¤
   - è‡ªå®šä¹‰å¥—é¤åç§°ã€ä»·æ ¼ã€æƒç›Šã€é™åˆ¶
   - å¥—é¤å¯ç”¨/ç¦ç”¨
   - è®¾ç½®é»˜è®¤å¥—é¤

4. **ç»Ÿè®¡ä¿¡æ¯**
   - å½“å‰æœ‰æ•ˆè®¢é˜…æ•°
   - æœ¬æœˆæ–°å¢è®¢é˜…æ•°
   - æœ¬æœˆæ”¶å…¥ç»Ÿè®¡
   - å„å¥—é¤è®¢é˜…ç»Ÿè®¡

#### å‰ç«¯ç•Œé¢ç¤ºä¾‹

```html
<!-- admin/templates/admin/payment_settings.html -->
<div class="payment-settings">
    <div class="settings-card">
        <h3>æ”¶è´¹åŠŸèƒ½æ§åˆ¶</h3>
        <div class="switch-container">
            <label class="switch">
                <input type="checkbox" id="paymentEnabled" 
                       {{ 'checked' if payment_enabled else '' }}>
                <span class="slider"></span>
            </label>
            <span class="switch-label">
                {{ 'æ”¶è´¹åŠŸèƒ½å·²å¼€å¯' if payment_enabled else 'æ”¶è´¹åŠŸèƒ½å·²å…³é—­' }}
            </span>
        </div>
        <p class="help-text">
            å…³é—­æ”¶è´¹åŠŸèƒ½åï¼Œæ‰€æœ‰ç”¨æˆ·å°†å…è´¹ä½¿ç”¨å…¨éƒ¨åŠŸèƒ½ï¼Œç³»ç»Ÿä¿æŒåŸæœ‰è¡Œä¸ºã€‚
        </p>
    </div>
    
    <div class="settings-card" id="configSettings" 
         style="{{ 'display: block' if payment_enabled else 'display: none' }}">
        <h3>åŠŸèƒ½é™åˆ¶é…ç½®</h3>
        <form id="configForm">
            <div class="form-group">
                <label>å…è´¹ç”¨æˆ·æ¯æ—¥åˆ·é¢˜é™åˆ¶</label>
                <input type="number" name="free_daily_quiz_limit" 
                       value="{{ free_daily_quiz_limit }}" min="0">
            </div>
            <div class="form-group">
                <label>å…è´¹ç”¨æˆ·æ¯æœˆè€ƒè¯•é™åˆ¶</label>
                <input type="number" name="free_monthly_exam_limit" 
                       value="{{ free_monthly_exam_limit }}" min="0">
            </div>
            <!-- æ›´å¤šé…ç½®é¡¹... -->
            <button type="submit" class="btn-primary">ä¿å­˜é…ç½®</button>
        </form>
    </div>
</div>
```

---

## ğŸ›ï¸ ä¼šå‘˜å¥—é¤ç®¡ç†ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰

### åŠŸèƒ½æ¦‚è¿°

ç®¡ç†å‘˜å¯ä»¥åœ¨åå°åˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤ä¼šå‘˜å¥—é¤ï¼Œè‡ªå®šä¹‰æ¯ä¸ªå¥—é¤çš„ï¼š
- å¥—é¤åç§°å’Œæè¿°
- æœˆä»˜/å¹´ä»˜ä»·æ ¼
- åŠŸèƒ½æƒç›Šï¼ˆå“ªäº›åŠŸèƒ½å¯ç”¨ï¼‰
- ä½¿ç”¨é™åˆ¶ï¼ˆæ¯æ—¥/æ¯æœˆä½¿ç”¨æ¬¡æ•°ç­‰ï¼‰

### å¥—é¤æƒç›Šé…ç½®

#### å¯é…ç½®çš„åŠŸèƒ½æƒç›Š

| æƒç›Šé¡¹ | è¯´æ˜ | ç±»å‹ |
|--------|------|------|
| `unlimited_quiz` | æ— é™åˆ·é¢˜ | Boolean |
| `view_explanation` | æŸ¥çœ‹è§£æ | Boolean |
| `favorites` | æ”¶è—åŠŸèƒ½ | Boolean |
| `mistakes` | é”™é¢˜æœ¬ | Boolean |
| `history` | å†å²è®°å½• | Boolean |
| `coding` | ç¼–ç¨‹é¢˜ç»ƒä¹  | Boolean |
| `chat` | ç«™å†…èŠå¤© | Boolean |
| `export` | æ•°æ®å¯¼å‡º | Boolean |
| `statistics` | æ•°æ®ç»Ÿè®¡ | Boolean |

#### å¯é…ç½®çš„ä½¿ç”¨é™åˆ¶

| é™åˆ¶é¡¹ | è¯´æ˜ | ç±»å‹ | è¯´æ˜ |
|--------|------|------|------|
| `daily_quiz_limit` | æ¯æ—¥åˆ·é¢˜é™åˆ¶ | Integer | -1è¡¨ç¤ºæ— é™åˆ¶ |
| `monthly_exam_limit` | æ¯æœˆè€ƒè¯•é™åˆ¶ | Integer | -1è¡¨ç¤ºæ— é™åˆ¶ |
| `monthly_coding_limit` | æ¯æœˆç¼–ç¨‹é¢˜é™åˆ¶ | Integer | -1è¡¨ç¤ºæ— é™åˆ¶ |
| `history_days` | å†å²è®°å½•ä¿å­˜å¤©æ•° | Integer | 0è¡¨ç¤ºä¸ä¿å­˜ |

### å¥—é¤ç®¡ç† API

#### è·å–å¥—é¤åˆ—è¡¨

```python
# GET /admin/api/membership-plans
# å“åº”
{
    "status": "success",
    "data": {
        "plans": [
            {
                "id": 1,
                "name": "åŸºç¡€ä¼šå‘˜",
                "plan_code": "basic",
                "description": "é€‚åˆæ—¥å¸¸åˆ·é¢˜å­¦ä¹ ",
                "monthly_price": 29.00,
                "yearly_price": 299.00,
                "features": {
                    "unlimited_quiz": true,
                    "view_explanation": true,
                    "favorites": true,
                    "mistakes": true,
                    "history": true,
                    "coding": false,
                    "chat": false,
                    "export": false,
                    "statistics": false
                },
                "limits": {
                    "daily_quiz_limit": -1,
                    "monthly_exam_limit": 10,
                    "monthly_coding_limit": 0,
                    "history_days": 30
                },
                "sort_order": 1,
                "is_active": true,
                "is_default": false,
                "subscriber_count": 150  # å½“å‰è®¢é˜…ç”¨æˆ·æ•°
            }
        ],
        "total": 3
    }
}
```

#### è·å–å¥—é¤è¯¦æƒ…

```python
# GET /admin/api/membership-plans/<plan_id>
# å“åº”
{
    "status": "success",
    "data": {
        "id": 1,
        "name": "åŸºç¡€ä¼šå‘˜",
        "plan_code": "basic",
        "description": "é€‚åˆæ—¥å¸¸åˆ·é¢˜å­¦ä¹ ",
        "monthly_price": 29.00,
        "yearly_price": 299.00,
        "features": {...},
        "limits": {...},
        "sort_order": 1,
        "is_active": true,
        "is_default": false,
        "created_at": "2025-01-29 10:00:00",
        "updated_at": "2025-01-29 10:00:00"
    }
}
```

#### åˆ›å»ºå¥—é¤

```python
# POST /admin/api/membership-plans
# è¯·æ±‚å‚æ•°
{
    "name": "ä¸“ä¸šä¼šå‘˜",
    "plan_code": "professional",
    "description": "é€‚åˆä¸“ä¸šå­¦ä¹ ",
    "monthly_price": 99.00,
    "yearly_price": 999.00,
    "features": {
        "unlimited_quiz": true,
        "view_explanation": true,
        "favorites": true,
        "mistakes": true,
        "history": true,
        "coding": true,
        "chat": true,
        "export": true,
        "statistics": true
    },
    "limits": {
        "daily_quiz_limit": -1,
        "monthly_exam_limit": -1,
        "monthly_coding_limit": 50,
        "history_days": 90
    },
    "sort_order": 3,
    "is_active": true,
    "is_default": false
}

# å“åº”
{
    "status": "success",
    "message": "å¥—é¤åˆ›å»ºæˆåŠŸ",
    "data": {
        "plan_id": 4
    }
}
```

#### æ›´æ–°å¥—é¤

```python
# PUT /admin/api/membership-plans/<plan_id>
# è¯·æ±‚å‚æ•°ï¼ˆåŒåˆ›å»ºï¼Œæ‰€æœ‰å­—æ®µå¯é€‰ï¼‰
{
    "monthly_price": 39.00,  # ä»…æ›´æ–°ä»·æ ¼
    "features": {
        "coding": true  # ä»…æ›´æ–°éƒ¨åˆ†æƒç›Š
    }
}

# å“åº”
{
    "status": "success",
    "message": "å¥—é¤æ›´æ–°æˆåŠŸ"
}
```

#### åˆ é™¤å¥—é¤

```python
# DELETE /admin/api/membership-plans/<plan_id>
# å“åº”
{
    "status": "success",
    "message": "å¥—é¤å·²åˆ é™¤"
}

# æ³¨æ„ï¼šå¦‚æœå¥—é¤æœ‰æ´»è·ƒè®¢é˜…ç”¨æˆ·ï¼Œä¸å…è®¸åˆ é™¤ï¼Œéœ€è¦å…ˆè¿ç§»ç”¨æˆ·æˆ–ç¦ç”¨å¥—é¤
```

#### å¯ç”¨/ç¦ç”¨å¥—é¤

```python
# POST /admin/api/membership-plans/<plan_id>/toggle
# å“åº”
{
    "status": "success",
    "message": "å¥—é¤å·²å¯ç”¨/ç¦ç”¨",
    "data": {
        "is_active": true
    }
}
```

#### è®¾ç½®é»˜è®¤å¥—é¤

```python
# POST /admin/api/membership-plans/<plan_id>/set-default
# å“åº”
{
    "status": "success",
    "message": "å·²è®¾ç½®ä¸ºé»˜è®¤å¥—é¤"
}
```

### å¥—é¤æ¨¡å‹

```python
# app/core/models/membership_plan.py
from typing import Optional, Dict, List
import json
from app.core.utils.database import get_db

class MembershipPlan:
    """ä¼šå‘˜å¥—é¤æ¨¡å‹"""
    
    @staticmethod
    def get_by_id(plan_id: int) -> Optional[Dict]:
        """è·å–å¥—é¤ä¿¡æ¯"""
        conn = get_db()
        row = conn.execute(
            'SELECT * FROM membership_plans WHERE id = ?', (plan_id,)
        ).fetchone()
        
        if not row:
            return None
        
        plan = dict(row)
        # è§£æJSONå­—æ®µ
        plan['features'] = json.loads(plan.get('features_json', '{}'))
        plan['limits'] = json.loads(plan.get('limits_json', '{}'))
        return plan
    
    @staticmethod
    def get_by_code(plan_code: str) -> Optional[Dict]:
        """é€šè¿‡ä»£ç è·å–å¥—é¤"""
        conn = get_db()
        row = conn.execute(
            'SELECT * FROM membership_plans WHERE plan_code = ? AND is_active = 1',
            (plan_code,)
        ).fetchone()
        
        if not row:
            return None
        
        plan = dict(row)
        plan['features'] = json.loads(plan.get('features_json', '{}'))
        plan['limits'] = json.loads(plan.get('limits_json', '{}'))
        return plan
    
    @staticmethod
    def get_all(include_inactive: bool = False) -> List[Dict]:
        """è·å–æ‰€æœ‰å¥—é¤"""
        conn = get_db()
        
        if include_inactive:
            rows = conn.execute(
                'SELECT * FROM membership_plans ORDER BY sort_order, id'
            ).fetchall()
        else:
            rows = conn.execute(
                'SELECT * FROM membership_plans WHERE is_active = 1 ORDER BY sort_order, id'
            ).fetchall()
        
        plans = []
        for row in rows:
            plan = dict(row)
            plan['features'] = json.loads(plan.get('features_json', '{}'))
            plan['limits'] = json.loads(plan.get('limits_json', '{}'))
            plans.append(plan)
        
        return plans
    
    @staticmethod
    def get_default() -> Optional[Dict]:
        """è·å–é»˜è®¤å¥—é¤"""
        conn = get_db()
        row = conn.execute(
            'SELECT * FROM membership_plans WHERE is_default = 1 AND is_active = 1 LIMIT 1'
        ).fetchone()
        
        if not row:
            return None
        
        plan = dict(row)
        plan['features'] = json.loads(plan.get('features_json', '{}'))
        plan['limits'] = json.loads(plan.get('limits_json', '{}'))
        return plan
    
    @staticmethod
    def create(name: str, plan_code: str, monthly_price: float, yearly_price: float,
               features: Dict, limits: Dict, description: str = '', 
               sort_order: int = 0, is_active: bool = True, is_default: bool = False) -> int:
        """åˆ›å»ºå¥—é¤"""
        conn = get_db()
        
        # å¦‚æœè®¾ç½®ä¸ºé»˜è®¤ï¼Œå…ˆå–æ¶ˆå…¶ä»–é»˜è®¤å¥—é¤
        if is_default:
            conn.execute('UPDATE membership_plans SET is_default = 0')
        
        cur = conn.execute('''
            INSERT INTO membership_plans 
            (name, plan_code, description, monthly_price, yearly_price, 
             features_json, limits_json, sort_order, is_active, is_default)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            name, plan_code, description, monthly_price, yearly_price,
            json.dumps(features, ensure_ascii=False),
            json.dumps(limits, ensure_ascii=False),
            sort_order, 1 if is_active else 0, 1 if is_default else 0
        ))
        
        conn.commit()
        return cur.lastrowid
    
    @staticmethod
    def update(plan_id: int, **kwargs) -> bool:
        """æ›´æ–°å¥—é¤"""
        conn = get_db()
        
        # æ„å»ºæ›´æ–°å­—æ®µ
        updates = []
        params = []
        
        if 'name' in kwargs:
            updates.append('name = ?')
            params.append(kwargs['name'])
        
        if 'description' in kwargs:
            updates.append('description = ?')
            params.append(kwargs['description'])
        
        if 'monthly_price' in kwargs:
            updates.append('monthly_price = ?')
            params.append(kwargs['monthly_price'])
        
        if 'yearly_price' in kwargs:
            updates.append('yearly_price = ?')
            params.append(kwargs['yearly_price'])
        
        if 'features' in kwargs:
            updates.append('features_json = ?')
            params.append(json.dumps(kwargs['features'], ensure_ascii=False))
        
        if 'limits' in kwargs:
            updates.append('limits_json = ?')
            params.append(json.dumps(kwargs['limits'], ensure_ascii=False))
        
        if 'sort_order' in kwargs:
            updates.append('sort_order = ?')
            params.append(kwargs['sort_order'])
        
        if 'is_active' in kwargs:
            updates.append('is_active = ?')
            params.append(1 if kwargs['is_active'] else 0)
        
        if 'is_default' in kwargs:
            if kwargs['is_default']:
                # å…ˆå–æ¶ˆå…¶ä»–é»˜è®¤å¥—é¤
                conn.execute('UPDATE membership_plans SET is_default = 0')
            updates.append('is_default = ?')
            params.append(1 if kwargs['is_default'] else 0)
        
        if not updates:
            return False
        
        updates.append('updated_at = CURRENT_TIMESTAMP')
        params.append(plan_id)
        
        conn.execute(
            f'UPDATE membership_plans SET {", ".join(updates)} WHERE id = ?',
            params
        )
        
        conn.commit()
        return True
    
    @staticmethod
    def delete(plan_id: int) -> bool:
        """åˆ é™¤å¥—é¤ï¼ˆéœ€è¦æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒè®¢é˜…ï¼‰"""
        conn = get_db()
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒè®¢é˜…
        active_count = conn.execute(
            'SELECT COUNT(*) FROM subscriptions WHERE plan_id = ? AND status = "active"',
            (plan_id,)
        ).fetchone()[0]
        
        if active_count > 0:
            return False  # æœ‰æ´»è·ƒè®¢é˜…ï¼Œä¸å…è®¸åˆ é™¤
        
        conn.execute('DELETE FROM membership_plans WHERE id = ?', (plan_id,))
        conn.commit()
        return True
    
    @staticmethod
    def has_feature(plan_id: int, feature: str) -> bool:
        """æ£€æŸ¥å¥—é¤æ˜¯å¦æœ‰æŸä¸ªåŠŸèƒ½æƒç›Š"""
        plan = MembershipPlan.get_by_id(plan_id)
        if not plan:
            return False
        return plan['features'].get(feature, False)
    
    @staticmethod
    def get_limit(plan_id: int, limit_type: str) -> int:
        """è·å–å¥—é¤çš„ä½¿ç”¨é™åˆ¶"""
        plan = MembershipPlan.get_by_id(plan_id)
        if not plan:
            return 0
        return plan['limits'].get(limit_type, 0)
```

### å‰ç«¯ç•Œé¢è®¾è®¡

#### ä¼šå‘˜å¥—é¤ç®¡ç†é¡µé¢

- **è·¯å¾„**ï¼š`/admin/membership-plans`
- **åŠŸèƒ½**ï¼š
  - å¥—é¤åˆ—è¡¨å±•ç¤ºï¼ˆè¡¨æ ¼å½¢å¼ï¼‰
  - åˆ›å»ºæ–°å¥—é¤æŒ‰é’®
  - ç¼–è¾‘/åˆ é™¤/å¯ç”¨/ç¦ç”¨æ“ä½œ
  - è®¾ç½®é»˜è®¤å¥—é¤
  - æ˜¾ç¤ºè®¢é˜…ç”¨æˆ·æ•°

#### å¥—é¤ç¼–è¾‘è¡¨å•

- **å¥—é¤åŸºæœ¬ä¿¡æ¯**
  - å¥—é¤åç§°
  - å¥—é¤ä»£ç ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
  - å¥—é¤æè¿°
  - æœˆä»˜ä»·æ ¼
  - å¹´ä»˜ä»·æ ¼
  - æ’åºé¡ºåº

- **åŠŸèƒ½æƒç›Šé…ç½®**
  - å¤é€‰æ¡†åˆ—è¡¨ï¼Œé€‰æ‹©å¯ç”¨åŠŸèƒ½
  - å®æ—¶é¢„è§ˆæƒç›Šåˆ—è¡¨

- **ä½¿ç”¨é™åˆ¶é…ç½®**
  - æ¯æ—¥åˆ·é¢˜é™åˆ¶ï¼ˆ-1è¡¨ç¤ºæ— é™åˆ¶ï¼‰
  - æ¯æœˆè€ƒè¯•é™åˆ¶ï¼ˆ-1è¡¨ç¤ºæ— é™åˆ¶ï¼‰
  - æ¯æœˆç¼–ç¨‹é¢˜é™åˆ¶ï¼ˆ-1è¡¨ç¤ºæ— é™åˆ¶ï¼‰
  - å†å²è®°å½•ä¿å­˜å¤©æ•°

- **å…¶ä»–è®¾ç½®**
  - æ˜¯å¦å¯ç”¨
  - æ˜¯å¦è®¾ä¸ºé»˜è®¤å¥—é¤

---

## ğŸ’³ æ”¯ä»˜é›†æˆ

### æ”¯æŒçš„æ”¯ä»˜æ–¹å¼

- **æ”¯ä»˜å®ï¼ˆAlipayï¼‰**ï¼šæ”¯æŒ PC ç«¯å’Œç§»åŠ¨ç«¯
- **å¾®ä¿¡æ”¯ä»˜ï¼ˆWeChat Payï¼‰**ï¼šæ”¯æŒ PC ç«¯æ‰«ç å’Œç§»åŠ¨ç«¯

### æ”¯ä»˜æµç¨‹

1. ç”¨æˆ·é€‰æ‹©ä¼šå‘˜å¥—é¤ã€æŒ‰é‡è¡¥å……æˆ–é¢˜é›†
2. åˆ›å»ºæ”¯ä»˜è®¢å•ï¼ˆ`payment_orders` è¡¨ï¼‰ï¼Œç”Ÿæˆå”¯ä¸€è®¢å•å·
3. è°ƒç”¨æ”¯ä»˜æ¥å£ï¼Œç”Ÿæˆæ”¯ä»˜é“¾æ¥æˆ–äºŒç»´ç 
4. ç”¨æˆ·å®Œæˆæ”¯ä»˜ï¼ˆè·³è½¬æ”¯ä»˜é¡µé¢æˆ–æ‰«ç æ”¯ä»˜ï¼‰
5. æ”¯ä»˜æˆåŠŸåï¼Œç¬¬ä¸‰æ–¹å›è°ƒç³»ç»Ÿ
6. éªŒè¯å›è°ƒç­¾åå’Œè®¢å•ä¿¡æ¯
7. æ›´æ–°è®¢å•çŠ¶æ€ä¸º `paid`
8. æ ¹æ®è®¢å•ç±»å‹æ›´æ–°ï¼š
   - ä¼šå‘˜è®¢é˜…ï¼šåˆ›å»ºæˆ–æ›´æ–° `subscriptions` è®°å½•
   - æŒ‰é‡è¡¥å……ï¼šåˆ›å»º `member_addon_purchases` è®°å½•
   - é¢˜é›†è´­ä¹°ï¼šåˆ›å»º `user_question_sets` è®°å½•
9. å‘é€ç¡®è®¤é‚®ä»¶/ç«™å†…é€šçŸ¥

### æ”¯ä»˜æ¥å£è®¾è®¡

#### åˆ›å»ºæ”¯ä»˜è®¢å•

```python
# POST /api/payment/create
# è¯·æ±‚å‚æ•°
{
    "order_type": "subscription",  # 'subscription', 'addon', 'question_set'
    "plan_type": "basic",  # ä¼šå‘˜ç±»å‹æˆ–è´­ä¹°ç±»å‹
    "amount": 29.00,
    "payment_method": "alipay",  # 'alipay' æˆ– 'wechat'
    "item_id": 123  # é¢˜é›†IDæˆ–å…¶ä»–å…³è”ID
}

# å“åº”
{
    "status": "success",
    "data": {
        "order_no": "202501291234567890",
        "payment_url": "https://...",  # æ”¯ä»˜é“¾æ¥ï¼ˆæ”¯ä»˜å®ï¼‰
        "qr_code": "data:image/png;base64,...",  # äºŒç»´ç ï¼ˆå¾®ä¿¡ï¼‰
        "expires_at": "2025-01-29 12:00:00"
    }
}
```

#### æ”¯ä»˜å›è°ƒå¤„ç†

```python
# app/modules/payment/routes/api.py
@payment_api_bp.route('/api/payment/callback/alipay', methods=['POST'])
def alipay_callback():
    """æ”¯ä»˜å®å›è°ƒå¤„ç†"""
    from app.core.services.payment_service import PaymentService
    
    # éªŒè¯å›è°ƒç­¾å
    if not PaymentService.verify_alipay_signature(request.form):
        return 'FAIL', 400
    
    # è·å–è®¢å•å·
    order_no = request.form.get('out_trade_no')
    
    # æ›´æ–°è®¢å•çŠ¶æ€
    PaymentService.handle_payment_success(order_no, 'alipay')
    
    return 'SUCCESS', 200

@payment_api_bp.route('/api/payment/callback/wechat', methods=['POST'])
def wechat_callback():
    """å¾®ä¿¡æ”¯ä»˜å›è°ƒå¤„ç†"""
    from app.core.services.payment_service import PaymentService
    import xml.etree.ElementTree as ET
    
    # è§£æXMLæ•°æ®
    xml_data = request.data
    root = ET.fromstring(xml_data)
    
    # éªŒè¯å›è°ƒç­¾å
    if not PaymentService.verify_wechat_signature(root):
        return PaymentService.generate_wechat_response('FAIL', 'ç­¾åéªŒè¯å¤±è´¥'), 400
    
    # è·å–è®¢å•å·
    order_no = root.find('out_trade_no').text
    
    # æ›´æ–°è®¢å•çŠ¶æ€
    PaymentService.handle_payment_success(order_no, 'wechat')
    
    return PaymentService.generate_wechat_response('SUCCESS', 'OK'), 200
```

#### æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€

```python
# GET /api/payment/status?order_no=xxx
# å“åº”
{
    "status": "success",
    "data": {
        "order_no": "202501291234567890",
        "status": "paid",  # 'pending', 'paid', 'failed'
        "paid_at": "2025-01-29 10:30:00",
        "payment_method": "alipay"
    }
}
```

---

## ğŸ“Š æ•°æ®ç»Ÿè®¡

### ç»Ÿè®¡æŒ‡æ ‡

1. **æ”¶å…¥ç»Ÿè®¡**
   - æ€»æ”¶å…¥
   - æœ¬æœˆæ”¶å…¥
   - æŒ‰ä¼šå‘˜ç±»å‹ç»Ÿè®¡
   - æŒ‰æ”¯ä»˜æ–¹å¼ç»Ÿè®¡

2. **ç”¨æˆ·ç»Ÿè®¡**
   - æ€»è®¢é˜…ç”¨æˆ·æ•°
   - å„ä¼šå‘˜ç±»å‹ç”¨æˆ·æ•°
   - ç»­è´¹ç‡
   - è½¬åŒ–ç‡

3. **åŠŸèƒ½ä½¿ç”¨ç»Ÿè®¡**
   - å„åŠŸèƒ½ä½¿ç”¨é¢‘ç‡
   - æŒ‰ä¼šå‘˜ç±»å‹ç»Ÿè®¡ä½¿ç”¨æƒ…å†µ
   - ä½¿ç”¨è¶‹åŠ¿åˆ†æ

---

## ğŸ”„ åŠŸèƒ½ä½¿ç”¨æµç¨‹

### åˆ·é¢˜åŠŸèƒ½

```python
@quiz_api_bp.route('/api/quiz/start', methods=['POST'])
@login_required
@usage_limit_check('quiz', daily_limit=10)  # å¦‚æœæ”¶è´¹å…³é—­ï¼Œä¸é™åˆ¶
def start_quiz():
    # ä¸šåŠ¡é€»è¾‘
    pass
```

### è€ƒè¯•åŠŸèƒ½

```python
@exam_api_bp.route('/api/exams/create', methods=['POST'])
@login_required
@usage_limit_check('exam', monthly_limit=1)  # å¦‚æœæ”¶è´¹å…³é—­ï¼Œä¸é™åˆ¶
def create_exam():
    # ä¸šåŠ¡é€»è¾‘
    pass
```

### ç¼–ç¨‹é¢˜åŠŸèƒ½

```python
@coding_api_bp.route('/api/coding/submit', methods=['POST'])
@login_required
@subscription_required('premium')  # å¦‚æœæ”¶è´¹å…³é—­ï¼Œç›´æ¥é€šè¿‡
@usage_limit_check('coding', monthly_limit=20)  # å¦‚æœæ”¶è´¹å…³é—­ï¼Œä¸é™åˆ¶
def submit_coding():
    # ä¸šåŠ¡é€»è¾‘
    pass
```

### é¢˜é›†è®¿é—®æƒé™æ£€æŸ¥

```python
# app/core/utils/decorators.py æ–°å¢
def question_set_required(question_id):
    """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®é¢˜ç›®ï¼ˆé¢˜é›†è´­ä¹°æ£€æŸ¥ï¼‰"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            # å¦‚æœæ”¶è´¹åŠŸèƒ½æœªå¯ç”¨ï¼Œç›´æ¥é€šè¿‡
            if not ConfigService.is_payment_enabled():
                return f(*args, **kwargs)
            
            user_id = session.get('user_id')
            if not user_id:
                return jsonify({'status': 'error', 'message': 'è¯·å…ˆç™»å½•'}), 401
            
            from app.core.models.question_set import QuestionSet
            
            # æ£€æŸ¥é¢˜ç›®æ˜¯å¦å±äºä»˜è´¹é¢˜é›†
            sets = QuestionSet.get_sets_by_question(question_id)
            
            if not sets:
                # é¢˜ç›®ä¸å±äºä»»ä½•é¢˜é›†ï¼Œå…è´¹è®¿é—®
                return f(*args, **kwargs)
            
            # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è´­ä¹°äº†ä»»ä¸€é¢˜é›†
            has_access = False
            for set_id in sets:
                if QuestionSet.user_has_access(user_id, set_id):
                    has_access = True
                    break
            
            if not has_access:
                # è·å–é¢˜é›†ä¿¡æ¯ç”¨äºæç¤º
                set_info = QuestionSet.get_by_id(sets[0])
                return jsonify({
                    'status': 'error',
                    'message': f'æ­¤é¢˜ç›®å±äºé¢˜é›†ã€Š{set_info["name"]}ã€‹ï¼Œè¯·å…ˆè´­ä¹°',
                    'question_set_id': sets[0],
                    'purchase_required': True
                }), 403
            
            return f(*args, **kwargs)
        return decorated_function
    return decorator
```

### é¢˜é›†æ¨¡å‹

```python
# app/core/models/question_set.py
from typing import Optional, Dict, List
from app.core.utils.database import get_db
from app.core.services.config_service import ConfigService
from app.core.models.subscription import Subscription

class QuestionSet:
    """é¢˜é›†æ¨¡å‹"""
    
    @staticmethod
    def get_by_id(set_id: int) -> Optional[Dict]:
        """è·å–é¢˜é›†ä¿¡æ¯"""
        conn = get_db()
        row = conn.execute(
            'SELECT * FROM question_sets WHERE id = ?', (set_id,)
        ).fetchone()
        return dict(row) if row else None
    
    @staticmethod
    def get_sets_by_question(question_id: int) -> List[int]:
        """è·å–é¢˜ç›®æ‰€å±çš„é¢˜é›†IDåˆ—è¡¨"""
        conn = get_db()
        rows = conn.execute(
            'SELECT set_id FROM question_set_items WHERE question_id = ?',
            (question_id,)
        ).fetchall()
        return [row['set_id'] for row in rows]
    
    @staticmethod
    def user_has_access(user_id: int, set_id: int) -> bool:
        """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®é¢˜é›†"""
        # å¦‚æœæ”¶è´¹åŠŸèƒ½æœªå¯ç”¨ï¼Œç›´æ¥è¿”å› True
        if not ConfigService.is_payment_enabled():
            return True
        
        # æ£€æŸ¥é¢˜é›†æ˜¯å¦ä¸ºå…è´¹
        conn = get_db()
        set_info = conn.execute(
            'SELECT is_free FROM question_sets WHERE id = ?', (set_id,)
        ).fetchone()
        
        if set_info and set_info['is_free']:
            return True
        
        # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è´­ä¹°
        row = conn.execute(
            'SELECT id FROM user_question_sets WHERE user_id = ? AND set_id = ?',
            (user_id, set_id)
        ).fetchone()
        
        return row is not None
    
    @staticmethod
    def calculate_price(set_id: int, user_id: int) -> Dict:
        """è®¡ç®—é¢˜é›†ä»·æ ¼ï¼ˆè€ƒè™‘ä¼šå‘˜æŠ˜æ‰£ï¼‰"""
        conn = get_db()
        set_info = conn.execute(
            'SELECT price, original_price FROM question_sets WHERE id = ?',
            (set_id,)
        ).fetchone()
        
        if not set_info:
            return {'price': 0, 'original_price': 0, 'discount': 0}
        
        original_price = float(set_info['original_price'] or set_info['price'])
        price = float(set_info['price'])
        
        # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºä¼šå‘˜ï¼ˆäº«å—8æŠ˜ä¼˜æƒ ï¼‰
        if ConfigService.is_payment_enabled():
            plan = Subscription.get_user_plan(user_id)
            if plan in ('basic', 'premium'):
                # ä¼šå‘˜8æŠ˜
                price = original_price * 0.8
                discount = original_price - price
            else:
                discount = original_price - price
        else:
            discount = 0
        
        return {
            'price': round(price, 2),
            'original_price': round(original_price, 2),
            'discount': round(discount, 2),
            'is_member': plan in ('basic', 'premium') if ConfigService.is_payment_enabled() else False
        }
    
    @staticmethod
    def get_user_purchased_sets(user_id: int) -> List[Dict]:
        """è·å–ç”¨æˆ·å·²è´­ä¹°çš„é¢˜é›†åˆ—è¡¨"""
        conn = get_db()
        rows = conn.execute('''
            SELECT qs.*, uqs.purchased_at, uqs.purchase_price
            FROM user_question_sets uqs
            JOIN question_sets qs ON uqs.set_id = qs.id
            WHERE uqs.user_id = ?
            ORDER BY uqs.purchased_at DESC
        ''', (user_id,)).fetchall()
        return [dict(row) for row in rows]
    
    @staticmethod
    def get_available_sets(user_id: Optional[int] = None) -> List[Dict]:
        """è·å–å¯è´­ä¹°çš„é¢˜é›†åˆ—è¡¨"""
        conn = get_db()
        
        # å¦‚æœæœªç™»å½•æˆ–æ”¶è´¹æœªå¯ç”¨ï¼Œè¿”å›æ‰€æœ‰é¢˜é›†
        if not user_id or not ConfigService.is_payment_enabled():
            rows = conn.execute('''
                SELECT * FROM question_sets
                WHERE status = 'active'
                ORDER BY sort_order, created_at DESC
            ''').fetchall()
            return [dict(row) for row in rows]
        
        # å·²ç™»å½•ç”¨æˆ·ï¼Œæ ‡è®°å·²è´­ä¹°çŠ¶æ€
        rows = conn.execute('''
            SELECT qs.*, 
                   CASE WHEN uqs.id IS NOT NULL THEN 1 ELSE 0 END as is_purchased
            FROM question_sets qs
            LEFT JOIN user_question_sets uqs ON qs.id = uqs.set_id AND uqs.user_id = ?
            WHERE qs.status = 'active'
            ORDER BY qs.sort_order, qs.created_at DESC
        ''', (user_id,)).fetchall()
        
        return [dict(row) for row in rows]
```

---

## ğŸ“± é¢˜é›†è´­ä¹°åŠŸèƒ½è®¾è®¡

### é¢˜é›†ç±»å‹

1. **å•ç§‘ç›®é¢˜é›†**ï¼ˆ`subject`ï¼‰
   - åŒ…å«æŸä¸ªç§‘ç›®çš„æ‰€æœ‰é¢˜ç›®
   - ä»·æ ¼ï¼šÂ¥29.9/ç§‘ç›®
   - ä¼šå‘˜8æŠ˜ï¼šÂ¥23.9/ç§‘ç›®

2. **ä¸“é¢˜é¢˜é›†**ï¼ˆ`topic`ï¼‰
   - æŒ‰ä¸“é¢˜åˆ†ç±»çš„é¢˜ç›®é›†åˆ
   - ä»·æ ¼ï¼šÂ¥19.9/ä¸“é¢˜
   - ä¼šå‘˜8æŠ˜ï¼šÂ¥15.9/ä¸“é¢˜

3. **è€ƒè¯•çœŸé¢˜é›†**ï¼ˆ`exam_paper`ï¼‰
   - å†å¹´è€ƒè¯•çœŸé¢˜
   - ä»·æ ¼ï¼šÂ¥39.9/å¥—
   - ä¼šå‘˜8æŠ˜ï¼šÂ¥31.9/å¥—

4. **ç¼–ç¨‹é¢˜é›†**ï¼ˆ`coding`ï¼‰
   - ç¼–ç¨‹é¢˜é›†åˆ
   - ä»·æ ¼ï¼šÂ¥49.9/å¥—ï¼ˆ50é“é¢˜ï¼‰
   - ä¼šå‘˜8æŠ˜ï¼šÂ¥39.9/å¥—

### é¢˜é›†ç®¡ç† API

#### è·å–é¢˜é›†åˆ—è¡¨

```python
# GET /api/question-sets?type=subject&subject_id=1
# å“åº”
{
    "status": "success",
    "data": {
        "sets": [
            {
                "id": 1,
                "name": "æ•°å­¦åŸºç¡€é¢˜é›†",
                "description": "åŒ…å«æ•°å­¦ç§‘ç›®çš„æ‰€æœ‰åŸºç¡€é¢˜ç›®",
                "set_type": "subject",
                "subject_id": 1,
                "subject_name": "æ•°å­¦",
                "price": 29.90,
                "original_price": 29.90,
                "member_price": 23.90,  # ä¼šå‘˜ä»·æ ¼
                "question_count": 150,
                "cover_image": "/uploads/covers/math.jpg",
                "is_free": false,
                "is_purchased": false,  # ç”¨æˆ·æ˜¯å¦å·²è´­ä¹°
                "status": "active"
            }
        ],
        "total": 10
    }
}
```

#### è·å–é¢˜é›†è¯¦æƒ…

```python
# GET /api/question-sets/<set_id>
# å“åº”
{
    "status": "success",
    "data": {
        "id": 1,
        "name": "æ•°å­¦åŸºç¡€é¢˜é›†",
        "description": "åŒ…å«æ•°å­¦ç§‘ç›®çš„æ‰€æœ‰åŸºç¡€é¢˜ç›®",
        "set_type": "subject",
        "subject_id": 1,
        "subject_name": "æ•°å­¦",
        "price": 29.90,
        "original_price": 29.90,
        "member_price": 23.90,
        "discount": 6.00,  # ä¼šå‘˜æŠ˜æ‰£é‡‘é¢
        "question_count": 150,
        "cover_image": "/uploads/covers/math.jpg",
        "is_free": false,
        "is_purchased": false,
        "purchased_at": null,
        "questions": [  # é¢˜é›†åŒ…å«çš„é¢˜ç›®åˆ—è¡¨ï¼ˆé¢„è§ˆï¼‰
            {
                "id": 1,
                "title": "é¢˜ç›®1",
                "q_type": "é€‰æ‹©é¢˜",
                "difficulty": "easy"
            }
        ],
        "status": "active"
    }
}
```

#### è´­ä¹°é¢˜é›†

```python
# POST /api/question-sets/<set_id>/purchase
# è¯·æ±‚å‚æ•°
{
    "payment_method": "alipay"  # 'alipay' æˆ– 'wechat'
}

# å“åº”
{
    "status": "success",
    "data": {
        "order_no": "202501291234567890",
        "payment_url": "https://...",  # æ”¯ä»˜å®æ”¯ä»˜é“¾æ¥
        "qr_code": "data:image/png;base64,...",  # å¾®ä¿¡æ”¯ä»˜äºŒç»´ç 
        "amount": 23.90,  # å®é™…æ”¯ä»˜é‡‘é¢ï¼ˆå·²è®¡ç®—ä¼šå‘˜æŠ˜æ‰£ï¼‰
        "expires_at": "2025-01-29 12:00:00"
    }
}
```

#### è·å–ç”¨æˆ·å·²è´­ä¹°çš„é¢˜é›†

```python
# GET /api/user/question-sets
# å“åº”
{
    "status": "success",
    "data": {
        "sets": [
            {
                "id": 1,
                "name": "æ•°å­¦åŸºç¡€é¢˜é›†",
                "set_type": "subject",
                "question_count": 150,
                "purchased_at": "2025-01-29 10:00:00",
                "purchase_price": 23.90
            }
        ],
        "total": 5
    }
}
```

### é¢˜é›†æƒé™æ£€æŸ¥

åœ¨ç”¨æˆ·è®¿é—®é¢˜ç›®æ—¶ï¼Œéœ€è¦æ£€æŸ¥é¢˜ç›®æ˜¯å¦å±äºä»˜è´¹é¢˜é›†ï¼š

```python
# åœ¨è·å–é¢˜ç›®è¯¦æƒ…æ—¶æ£€æŸ¥
@quiz_api_bp.route('/api/questions/<int:question_id>')
@login_required
@question_set_required(question_id)  # æ£€æŸ¥é¢˜é›†æƒé™
def get_question(question_id):
    # ä¸šåŠ¡é€»è¾‘
    pass
```

### å‰ç«¯ç•Œé¢è®¾è®¡

#### é¢˜é›†å•†åŸé¡µé¢

- **è·¯å¾„**ï¼š`/question-sets` æˆ– `/store`
- **åŠŸèƒ½**ï¼š
  - é¢˜é›†åˆ†ç±»å±•ç¤ºï¼ˆæŒ‰ç±»å‹ç­›é€‰ï¼‰
  - é¢˜é›†å¡ç‰‡å±•ç¤ºï¼ˆå°é¢ã€åç§°ã€ä»·æ ¼ã€é¢˜ç›®æ•°é‡ï¼‰
  - å·²è´­ä¹°æ ‡è®°
  - ä¼šå‘˜ä»·æ ¼æ˜¾ç¤º
  - è´­ä¹°æŒ‰é’®

#### é¢˜é›†è¯¦æƒ…é¡µé¢

- **è·¯å¾„**ï¼š`/question-sets/<set_id>`
- **åŠŸèƒ½**ï¼š
  - é¢˜é›†è¯¦ç»†ä¿¡æ¯
  - é¢˜ç›®åˆ—è¡¨é¢„è§ˆ
  - ä»·æ ¼å±•ç¤ºï¼ˆåŸä»·ã€ä¼šå‘˜ä»·ã€æŠ˜æ‰£ï¼‰
  - è´­ä¹°æŒ‰é’®ï¼ˆå·²è´­ä¹°æ˜¾ç¤º"å·²æ‹¥æœ‰"ï¼‰
  - æ”¯ä»˜æ–¹å¼é€‰æ‹©ï¼ˆæ”¯ä»˜å®/å¾®ä¿¡ï¼‰

#### æˆ‘çš„é¢˜é›†é¡µé¢

- **è·¯å¾„**ï¼š`/user/question-sets`
- **åŠŸèƒ½**ï¼š
  - å·²è´­ä¹°é¢˜é›†åˆ—è¡¨
  - é¢˜é›†ä½¿ç”¨ç»Ÿè®¡
  - å¿«é€Ÿè®¿é—®å…¥å£

---

## âœ… å®ç°æ£€æŸ¥æ¸…å•

### æ•°æ®åº“
- [ ] åˆ›å»º `system_config` è¡¨
- [ ] åˆ›å»º `membership_plans` è¡¨ï¼ˆä¼šå‘˜å¥—é¤è¡¨ï¼‰
- [ ] åˆ›å»º `subscriptions` è¡¨ï¼ˆæ›´æ–°ä¸ºä½¿ç”¨plan_idï¼‰
- [ ] åˆ›å»º `usage_records` è¡¨
- [ ] åˆ›å»º `payment_orders` è¡¨
- [ ] åˆ›å»º `member_addon_purchases` è¡¨
- [ ] åˆ›å»º `question_sets` è¡¨
- [ ] åˆ›å»º `question_set_items` è¡¨
- [ ] åˆ›å»º `user_question_sets` è¡¨

### æ ¸å¿ƒæœåŠ¡
- [ ] å®ç° `ConfigService`ï¼ˆé…ç½®ç®¡ç†ï¼‰
- [ ] å®ç° `MembershipPlan` æ¨¡å‹ï¼ˆä¼šå‘˜å¥—é¤ç®¡ç†ï¼‰
- [ ] å®ç° `Subscription` æ¨¡å‹
- [ ] å®ç° `QuestionSet` æ¨¡å‹
- [ ] å®ç°æƒé™æ£€æŸ¥è£…é¥°å™¨ï¼ˆæ”¯æŒæ”¶è´¹å¼€å…³å’ŒåŠ¨æ€å¥—é¤ï¼‰
- [ ] å®ç°ä½¿ç”¨è®°å½•æœåŠ¡
- [ ] å®ç°æ”¯ä»˜æœåŠ¡ï¼ˆ`PaymentService`ï¼‰

### åå°ç®¡ç†
- [ ] åˆ›å»ºæ”¶è´¹é…ç½®é¡µé¢
- [ ] åˆ›å»ºä¼šå‘˜å¥—é¤ç®¡ç†é¡µé¢
- [ ] å®ç°å¥—é¤ CRUD API
- [ ] å®ç°é…ç½®æ›´æ–° API
- [ ] å®ç°é…ç½®æŸ¥è¯¢ API
- [ ] æ·»åŠ æ“ä½œæ—¥å¿—è®°å½•

### æ”¯ä»˜é›†æˆ
- [ ] æ¥å…¥æ”¯ä»˜å® SDK
- [ ] æ¥å…¥å¾®ä¿¡æ”¯ä»˜ SDK
- [ ] å®ç°æ”¯ä»˜è®¢å•åˆ›å»º
- [ ] å®ç°æ”¯ä»˜å›è°ƒå¤„ç†ï¼ˆæ”¯ä»˜å®/å¾®ä¿¡ï¼‰
- [ ] å®ç°è®¢å•æŸ¥è¯¢
- [ ] å®ç°æ”¯ä»˜çŠ¶æ€åŒæ­¥

### å‰ç«¯ç•Œé¢
- [ ] ä¼šå‘˜è´­ä¹°é¡µé¢
- [ ] é¢˜é›†å•†åŸé¡µé¢
- [ ] é¢˜é›†è¯¦æƒ…é¡µé¢
- [ ] æˆ‘çš„é¢˜é›†é¡µé¢
- [ ] å‡çº§æç¤ºå¼¹çª—
- [ ] ä½¿ç”¨é™åˆ¶æç¤º
- [ ] æ”¯ä»˜é¡µé¢ï¼ˆæ”¯ä»˜å®/å¾®ä¿¡ï¼‰
- [ ] æ”¯ä»˜ç»“æœé¡µé¢

### æµ‹è¯•
- [ ] æ”¶è´¹åŠŸèƒ½å¼€å¯æ—¶çš„æƒé™æ£€æŸ¥
- [ ] æ”¶è´¹åŠŸèƒ½å…³é—­æ—¶çš„è¡Œä¸ºéªŒè¯
- [ ] æ”¯ä»˜æµç¨‹æµ‹è¯•ï¼ˆæ”¯ä»˜å®/å¾®ä¿¡ï¼‰
- [ ] ä½¿ç”¨é™åˆ¶æµ‹è¯•
- [ ] é¢˜é›†è´­ä¹°æµç¨‹æµ‹è¯•
- [ ] ä¼šå‘˜æŠ˜æ‰£è®¡ç®—æµ‹è¯•

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ”¶è´¹å¼€å…³åˆ‡æ¢**
   - å…³é—­æ”¶è´¹æ—¶ï¼Œæ‰€æœ‰ç”¨æˆ·è‡ªåŠ¨è·å¾—å…è´¹è®¿é—®æƒé™
   - å¼€å¯æ”¶è´¹æ—¶ï¼Œéœ€è¦ç¡®ä¿å·²æœ‰è®¢é˜…ç”¨æˆ·ä¸å—å½±å“
   - å»ºè®®åœ¨ä½å³°æœŸåˆ‡æ¢ï¼Œå¹¶æå‰é€šçŸ¥ç”¨æˆ·

2. **æ•°æ®ä¸€è‡´æ€§**
   - ç¡®ä¿é…ç½®å˜æ›´åï¼Œæ‰€æœ‰ç›¸å…³æ£€æŸ¥é€»è¾‘ç«‹å³ç”Ÿæ•ˆ
   - è€ƒè™‘ä½¿ç”¨ç¼“å­˜æé«˜æ€§èƒ½ï¼ˆä½†è¦æ³¨æ„ç¼“å­˜å¤±æ•ˆï¼‰

3. **ç”¨æˆ·ä½“éªŒ**
   - æ”¶è´¹åŠŸèƒ½å…³é—­æ—¶ï¼Œä¸åº”æ˜¾ç¤ºä»»ä½•ä»˜è´¹ç›¸å…³æç¤º
   - æ”¶è´¹åŠŸèƒ½å¼€å¯æ—¶ï¼Œæä¾›æ¸…æ™°çš„å‡çº§å¼•å¯¼

4. **å®‰å…¨æ€§**
   - æ”¯ä»˜å›è°ƒéœ€è¦éªŒè¯ç­¾å
   - é…ç½®ä¿®æ”¹éœ€è¦ç®¡ç†å‘˜æƒé™
   - è®°å½•æ‰€æœ‰é…ç½®å˜æ›´æ—¥å¿—

---

## ğŸš€ å®æ–½æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€åŠŸèƒ½
1. åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„ï¼ˆåŒ…æ‹¬ä¼šå‘˜å¥—é¤è¡¨ï¼‰
2. å®ç°é…ç½®æœåŠ¡
3. å®ç°ä¼šå‘˜å¥—é¤æ¨¡å‹å’Œç®¡ç†åŠŸèƒ½
4. å®ç°æƒé™æ£€æŸ¥è£…é¥°å™¨ï¼ˆæ”¯æŒåŠ¨æ€å¥—é¤ï¼‰
5. åˆ›å»ºåå°é…ç½®é¡µé¢å’Œå¥—é¤ç®¡ç†é¡µé¢

### ç¬¬äºŒé˜¶æ®µï¼šæ”¯ä»˜é›†æˆ
1. é€‰æ‹©å¹¶æ¥å…¥æ”¯ä»˜æœåŠ¡
2. å®ç°æ”¯ä»˜æµç¨‹
3. å®ç°å›è°ƒå¤„ç†

### ç¬¬ä¸‰é˜¶æ®µï¼šé¢˜é›†åŠŸèƒ½
1. å®ç°é¢˜é›†ç®¡ç†ï¼ˆåå°ï¼‰
2. å®ç°é¢˜é›†è´­ä¹°åŠŸèƒ½
3. å®ç°é¢˜é›†æƒé™æ£€æŸ¥
4. å®ç°ä¼šå‘˜æŠ˜æ‰£è®¡ç®—

### ç¬¬å››é˜¶æ®µï¼šåŠŸèƒ½å®Œå–„
1. å®ç°ä½¿ç”¨é™åˆ¶æ£€æŸ¥
2. å®ç°ç»Ÿè®¡åŠŸèƒ½
3. å®Œå–„å‰ç«¯ç•Œé¢

### ç¬¬äº”é˜¶æ®µï¼šæµ‹è¯•ä¸Šçº¿
1. å…¨é¢æµ‹è¯•
2. ç°åº¦å‘å¸ƒ
3. æ­£å¼ä¸Šçº¿

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.2  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-29  
**æœ€åæ›´æ–°**: 2025-01-29  
**æ›´æ–°å†…å®¹**:
- âœ… å°†é¢˜é›†è´­ä¹°åŠŸèƒ½ä»å¯é€‰æ”¹ä¸ºæ­£å¼åŠŸèƒ½
- âœ… å®Œå–„é¢˜é›†è´­ä¹°åŠŸèƒ½è®¾è®¡ï¼ˆå•ç§‘ç›®/ä¸“é¢˜/è€ƒè¯•çœŸé¢˜/ç¼–ç¨‹é¢˜é›†ï¼‰
- âœ… æ·»åŠ é¢˜é›†æƒé™æ£€æŸ¥é€»è¾‘
- âœ… æ·»åŠ é¢˜é›†è´­ä¹° API è®¾è®¡
- âœ… æ·»åŠ é¢˜é›†å‰ç«¯ç•Œé¢è®¾è®¡
- âœ… æ”¯ä»˜æ–¹å¼ä»…ä¿ç•™å¾®ä¿¡æ”¯ä»˜å’Œæ”¯ä»˜å®
- âœ… å®Œå–„æ”¯ä»˜å›è°ƒå¤„ç†é€»è¾‘
- âœ… **æ–°å¢ï¼šç®¡ç†å‘˜å¯å®šåˆ¶ä¼šå‘˜æƒç›Šå’Œä»·æ ¼åŠŸèƒ½**
- âœ… æ–°å¢ä¼šå‘˜å¥—é¤è¡¨ï¼ˆ`membership_plans`ï¼‰
- âœ… å®ç°å¥—é¤ç®¡ç† APIï¼ˆCRUDï¼‰
- âœ… æ”¯æŒåŠ¨æ€å¥—é¤é…ç½®ï¼ˆæƒç›Šå’Œé™åˆ¶ï¼‰
- âœ… æ›´æ–°è®¢é˜…è¡¨ä½¿ç”¨å¥—é¤IDå…³è”
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ
