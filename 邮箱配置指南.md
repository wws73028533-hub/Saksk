# 邮箱配置指南

## 1. 配置方式

邮箱配置可以通过两种方式设置：

### 方式一：环境变量（推荐）

在系统环境变量中设置，或在 `.env` 文件中配置（如果使用 python-dotenv）。

### 方式二：直接修改配置文件

在 `app/core/config.py` 中直接修改配置值（不推荐，安全性较低）。

## 2. 配置参数说明

| 参数 | 说明 | 默认值 | 必需 |
|------|------|--------|------|
| `MAIL_SERVER` | SMTP服务器地址 | smtp.example.com | 是（生产环境） |
| `MAIL_PORT` | SMTP端口 | 587 | 是（生产环境） |
| `MAIL_USE_TLS` | 是否使用TLS加密 | true | 是（生产环境） |
| `MAIL_USE_SSL` | 是否使用SSL加密 | false | 否 |
| `MAIL_USERNAME` | SMTP用户名（邮箱地址） | - | 是（生产环境） |
| `MAIL_PASSWORD` | SMTP密码或授权码 | - | 是（生产环境） |
| `MAIL_DEFAULT_SENDER` | 默认发件人邮箱 | noreply@example.com | 是（生产环境） |
| `MAIL_DEFAULT_SENDER_NAME` | 默认发件人名称 | 系统通知 | 否 |
| `MAIL_ENABLED` | 是否启用邮件服务 | true | 否 |
| `MAIL_CONSOLE_OUTPUT` | 开发环境控制台输出 | false（生产）/true（开发） | 否 |

## 3. 常见邮件服务商配置

### 3.1 Gmail（Google邮箱）

#### 配置步骤：

1. **启用两步验证**
   - 登录 Google 账户
   - 进入"安全性"设置
   - 启用"两步验证"

2. **生成应用专用密码**
   - 在"安全性"设置中找到"应用专用密码"
   - 选择"邮件"和"其他（自定义名称）"
   - 输入应用名称（如：Flask App）
   - 复制生成的16位密码

3. **配置参数**

```env
MAIL_SERVER=smtp.gmail.com
MAIL_PORT=587
MAIL_USE_TLS=true
MAIL_USE_SSL=false
MAIL_USERNAME=your_email@gmail.com
MAIL_PASSWORD=your_16_digit_app_password  # 使用应用专用密码，不是登录密码
MAIL_DEFAULT_SENDER=your_email@gmail.com
MAIL_DEFAULT_SENDER_NAME=系统通知
MAIL_ENABLED=true
MAIL_CONSOLE_OUTPUT=false
```

**注意：** Gmail必须使用应用专用密码，不能使用普通登录密码。

### 3.2 QQ邮箱

#### 配置步骤：

1. **开启SMTP服务**
   - 登录QQ邮箱
   - 进入"设置" -> "账户"
   - 找到"POP3/IMAP/SMTP/Exchange/CardDAV/CalDAV服务"
   - 开启"POP3/SMTP服务"或"IMAP/SMTP服务"

2. **获取授权码**
   - 点击"生成授权码"
   - 按照提示发送短信验证
   - 复制生成的授权码（16位字符）

3. **配置参数**

```env
MAIL_SERVER=smtp.qq.com
MAIL_PORT=587
MAIL_USE_TLS=true
MAIL_USE_SSL=false
MAIL_USERNAME=your_email@qq.com
MAIL_PASSWORD=your_authorization_code  # 使用授权码，不是QQ密码
MAIL_DEFAULT_SENDER=your_email@qq.com
MAIL_DEFAULT_SENDER_NAME=系统通知
MAIL_ENABLED=true
MAIL_CONSOLE_OUTPUT=false
```

**注意：** QQ邮箱必须使用授权码，不能使用QQ密码。

### 3.3 163邮箱（网易邮箱）

#### 配置步骤：

1. **开启SMTP服务**
   - 登录163邮箱
   - 进入"设置" -> "POP3/SMTP/IMAP"
   - 开启"POP3/SMTP服务"和"IMAP/SMTP服务"

2. **获取授权码**
   - 点击"客户端授权密码"
   - 按照提示设置授权码
   - 复制生成的授权码

3. **配置参数**

```env
# 使用587端口（TLS）
MAIL_SERVER=smtp.163.com
MAIL_PORT=587
MAIL_USE_TLS=true
MAIL_USE_SSL=false
MAIL_USERNAME=your_email@163.com
MAIL_PASSWORD=your_authorization_code
MAIL_DEFAULT_SENDER=your_email@163.com
MAIL_DEFAULT_SENDER_NAME=系统通知
MAIL_ENABLED=true
MAIL_CONSOLE_OUTPUT=false

# 或使用465端口（SSL）
MAIL_SERVER=smtp.163.com
MAIL_PORT=465
MAIL_USE_TLS=false
MAIL_USE_SSL=true
MAIL_USERNAME=your_email@163.com
MAIL_PASSWORD=your_authorization_code
MAIL_DEFAULT_SENDER=your_email@163.com
MAIL_DEFAULT_SENDER_NAME=系统通知
MAIL_ENABLED=true
MAIL_CONSOLE_OUTPUT=false
```

### 3.4 126邮箱（网易邮箱）

配置与163邮箱类似：

```env
MAIL_SERVER=smtp.126.com
MAIL_PORT=587
MAIL_USE_TLS=true
MAIL_USE_SSL=false
MAIL_USERNAME=your_email@126.com
MAIL_PASSWORD=your_authorization_code
MAIL_DEFAULT_SENDER=your_email@126.com
MAIL_DEFAULT_SENDER_NAME=系统通知
MAIL_ENABLED=true
MAIL_CONSOLE_OUTPUT=false
```

### 3.5 企业邮箱（腾讯企业邮箱）

```env
MAIL_SERVER=smtp.exmail.qq.com
MAIL_PORT=587
MAIL_USE_TLS=true
MAIL_USE_SSL=false
MAIL_USERNAME=your_email@yourdomain.com
MAIL_PASSWORD=your_password  # 企业邮箱通常使用登录密码
MAIL_DEFAULT_SENDER=your_email@yourdomain.com
MAIL_DEFAULT_SENDER_NAME=系统通知
MAIL_ENABLED=true
MAIL_CONSOLE_OUTPUT=false
```

### 3.6 Outlook/Hotmail

```env
MAIL_SERVER=smtp-mail.outlook.com
MAIL_PORT=587
MAIL_USE_TLS=true
MAIL_USE_SSL=false
MAIL_USERNAME=your_email@outlook.com
MAIL_PASSWORD=your_password
MAIL_DEFAULT_SENDER=your_email@outlook.com
MAIL_DEFAULT_SENDER_NAME=系统通知
MAIL_ENABLED=true
MAIL_CONSOLE_OUTPUT=false
```

### 3.7 阿里云企业邮箱

```env
MAIL_SERVER=smtp.mxhichina.com
MAIL_PORT=465
MAIL_USE_TLS=false
MAIL_USE_SSL=true
MAIL_USERNAME=your_email@yourdomain.com
MAIL_PASSWORD=your_password
MAIL_DEFAULT_SENDER=your_email@yourdomain.com
MAIL_DEFAULT_SENDER_NAME=系统通知
MAIL_ENABLED=true
MAIL_CONSOLE_OUTPUT=false
```

## 4. 配置示例

### 4.1 开发环境配置（.env文件）

创建 `.env` 文件在项目根目录：

```env
# 开发环境 - 使用控制台输出（不发送真实邮件）
MAIL_ENABLED=true
MAIL_CONSOLE_OUTPUT=true

# 如果需要测试真实邮件，取消注释以下配置
# MAIL_SERVER=smtp.qq.com
# MAIL_PORT=587
# MAIL_USE_TLS=true
# MAIL_USERNAME=your_email@qq.com
# MAIL_PASSWORD=your_authorization_code
# MAIL_DEFAULT_SENDER=your_email@qq.com
# MAIL_DEFAULT_SENDER_NAME=系统通知
```

### 4.2 生产环境配置（.env文件）

```env
# 生产环境 - 发送真实邮件
MAIL_ENABLED=true
MAIL_CONSOLE_OUTPUT=false

# QQ邮箱配置示例
MAIL_SERVER=smtp.qq.com
MAIL_PORT=587
MAIL_USE_TLS=true
MAIL_USE_SSL=false
MAIL_USERNAME=your_email@qq.com
MAIL_PASSWORD=your_authorization_code
MAIL_DEFAULT_SENDER=your_email@qq.com
MAIL_DEFAULT_SENDER_NAME=系统通知
```

### 4.3 使用环境变量（Linux/Mac）

```bash
export MAIL_SERVER=smtp.qq.com
export MAIL_PORT=587
export MAIL_USE_TLS=true
export MAIL_USERNAME=your_email@qq.com
export MAIL_PASSWORD=your_authorization_code
export MAIL_DEFAULT_SENDER=your_email@qq.com
export MAIL_ENABLED=true
export MAIL_CONSOLE_OUTPUT=false
```

### 4.4 使用环境变量（Windows PowerShell）

```powershell
$env:MAIL_SERVER="smtp.qq.com"
$env:MAIL_PORT="587"
$env:MAIL_USE_TLS="true"
$env:MAIL_USERNAME="your_email@qq.com"
$env:MAIL_PASSWORD="your_authorization_code"
$env:MAIL_DEFAULT_SENDER="your_email@qq.com"
$env:MAIL_ENABLED="true"
$env:MAIL_CONSOLE_OUTPUT="false"
```

### 4.5 使用环境变量（Windows CMD）

```cmd
set MAIL_SERVER=smtp.qq.com
set MAIL_PORT=587
set MAIL_USE_TLS=true
set MAIL_USERNAME=your_email@qq.com
set MAIL_PASSWORD=your_authorization_code
set MAIL_DEFAULT_SENDER=your_email@qq.com
set MAIL_ENABLED=true
set MAIL_CONSOLE_OUTPUT=false
```

## 5. 配置验证

### 5.1 测试邮件发送

创建测试脚本 `test_mail_config.py`：

```python
# -*- coding: utf-8 -*-
"""测试邮件配置"""
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from flask import Flask
from app.core.config import DevelopmentConfig
from app.core.utils.email_service import EmailService

app = Flask(__name__)
app.config.from_object(DevelopmentConfig)

# 如果使用.env文件，加载环境变量
try:
    from dotenv import load_dotenv
    load_dotenv()
    # 重新加载配置
    app.config['MAIL_SERVER'] = os.environ.get('MAIL_SERVER')
    app.config['MAIL_PORT'] = int(os.environ.get('MAIL_PORT', 587))
    app.config['MAIL_USE_TLS'] = os.environ.get('MAIL_USE_TLS', 'true').lower() in ['true', 'on', '1']
    app.config['MAIL_USE_SSL'] = os.environ.get('MAIL_USE_SSL', 'false').lower() in ['true', 'on', '1']
    app.config['MAIL_USERNAME'] = os.environ.get('MAIL_USERNAME')
    app.config['MAIL_PASSWORD'] = os.environ.get('MAIL_PASSWORD')
    app.config['MAIL_DEFAULT_SENDER'] = os.environ.get('MAIL_DEFAULT_SENDER')
    app.config['MAIL_CONSOLE_OUTPUT'] = os.environ.get('MAIL_CONSOLE_OUTPUT', 'false').lower() in ['true', 'on', '1']
except ImportError:
    print("提示: 安装python-dotenv可以自动加载.env文件")
    print("pip install python-dotenv")

with app.app_context():
    print("=" * 60)
    print("邮件配置测试")
    print("=" * 60)
    
    print("\n当前配置：")
    print(f"  MAIL_SERVER: {app.config.get('MAIL_SERVER')}")
    print(f"  MAIL_PORT: {app.config.get('MAIL_PORT')}")
    print(f"  MAIL_USE_TLS: {app.config.get('MAIL_USE_TLS')}")
    print(f"  MAIL_USE_SSL: {app.config.get('MAIL_USE_SSL')}")
    print(f"  MAIL_USERNAME: {app.config.get('MAIL_USERNAME')}")
    print(f"  MAIL_PASSWORD: {'*' * len(app.config.get('MAIL_PASSWORD', '')) if app.config.get('MAIL_PASSWORD') else '未设置'}")
    print(f"  MAIL_DEFAULT_SENDER: {app.config.get('MAIL_DEFAULT_SENDER')}")
    print(f"  MAIL_ENABLED: {app.config.get('MAIL_ENABLED')}")
    print(f"  MAIL_CONSOLE_OUTPUT: {app.config.get('MAIL_CONSOLE_OUTPUT')}")
    
    # 检查配置完整性
    print("\n配置检查：")
    required_configs = ['MAIL_SERVER', 'MAIL_USERNAME', 'MAIL_PASSWORD']
    all_ok = True
    
    if app.config.get('MAIL_CONSOLE_OUTPUT'):
        print("  模式: 开发环境（控制台输出）")
        print("  状态: OK - 无需SMTP配置")
    else:
        print("  模式: 生产环境（真实邮件发送）")
        for config_key in required_configs:
            if app.config.get(config_key):
                print(f"  {config_key}: OK")
            else:
                print(f"  {config_key}: 缺失")
                all_ok = False
        
        if all_ok:
            print("\n测试发送邮件...")
            test_email = input("请输入测试邮箱地址: ").strip()
            if test_email:
                success, code = EmailService.send_verification_code(
                    test_email, "bind"
                )
                if success:
                    print(f"\n发送成功！验证码: {code}")
                    print("请检查邮箱收件箱（包括垃圾邮件文件夹）")
                else:
                    print("\n发送失败，请检查配置和网络连接")
        else:
            print("\n配置不完整，无法发送真实邮件")
    
    print("\n" + "=" * 60)
```

运行测试：

```bash
python test_mail_config.py
```

## 6. 常见问题

### 6.1 认证失败

**错误信息：** `SMTPAuthenticationError` 或 `535 Authentication failed`

**可能原因：**
- 密码错误（使用了登录密码而非授权码）
- 未启用SMTP服务
- 未生成应用专用密码（Gmail）

**解决方法：**
1. Gmail：使用应用专用密码，不是登录密码
2. QQ邮箱：使用授权码，不是QQ密码
3. 163邮箱：使用授权码，不是登录密码
4. 确认已开启SMTP服务

### 6.2 连接超时

**错误信息：** `SMTPConnectError` 或连接超时

**可能原因：**
- 服务器地址错误
- 端口错误
- 防火墙阻止
- 网络问题

**解决方法：**
1. 检查服务器地址是否正确
2. 检查端口是否正确（587或465）
3. 检查防火墙设置
4. 尝试使用其他网络

### 6.3 TLS/SSL错误

**错误信息：** `SSLError` 或 TLS相关错误

**可能原因：**
- TLS/SSL配置不匹配
- 端口和加密方式不匹配

**解决方法：**
- 使用587端口时，设置 `MAIL_USE_TLS=true`, `MAIL_USE_SSL=false`
- 使用465端口时，设置 `MAIL_USE_TLS=false`, `MAIL_USE_SSL=true`

### 6.4 邮件被标记为垃圾邮件

**解决方法：**
1. 配置SPF记录
2. 配置DKIM签名
3. 使用企业邮箱
4. 避免发送频率过高
5. 邮件内容避免敏感词汇

## 7. 安全建议

1. **不要将密码硬编码在代码中**
   - 使用环境变量或配置文件
   - 将 `.env` 文件添加到 `.gitignore`

2. **使用授权码而非登录密码**
   - Gmail使用应用专用密码
   - QQ/163邮箱使用授权码

3. **生产环境使用HTTPS**
   - 确保邮件配置通过HTTPS传输

4. **定期更换密码**
   - 定期更换SMTP密码或授权码

5. **限制发送频率**
   - 避免发送频率过高导致被标记为垃圾邮件

## 8. 快速配置检查清单

- [ ] 已开启SMTP服务（QQ/163邮箱）
- [ ] 已生成授权码或应用专用密码
- [ ] 配置了正确的SMTP服务器地址
- [ ] 配置了正确的端口号
- [ ] TLS/SSL配置与端口匹配
- [ ] 用户名和密码正确
- [ ] 发件人邮箱已设置
- [ ] 测试发送成功

## 9. 推荐配置方案

### 开发环境
```env
MAIL_ENABLED=true
MAIL_CONSOLE_OUTPUT=true
```
无需配置SMTP，验证码会在控制台输出。

### 生产环境（小型项目）
推荐使用QQ邮箱或163邮箱，配置简单，免费。

### 生产环境（企业项目）
推荐使用企业邮箱，更稳定，更安全。


